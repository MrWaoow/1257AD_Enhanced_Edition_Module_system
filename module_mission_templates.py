# -*- coding: UTF-8 -*-
####################################################################################################################
# Generated by Warband Module Decompiler
# All rights of the module belong to their respective owners
####################################################################################################################

from header_common import *
from header_operations import *
from header_mission_templates import *
from header_animations import *
from header_sounds import *
from header_music import *
from header_items import *
from module_constants import *

####################################################################################################################
#   Each mission-template is a tuple that contains the following fields:
#  1) Mission-template id (string): used for referencing mission-templates in other files.
#     The prefix mt_ is automatically added before each mission-template id
#
#  2) Mission-template flags (int): See header_mission-templates.py for a list of available flags
#  3) Mission-type(int): Which mission types this mission template matches.
#     For mission-types to be used with the default party-meeting system,
#     this should be 'charge' or 'charge_with_ally' otherwise must be -1.
#     
#  4) Mission description text (string).
#  5) List of spawn records (list): Each spawn record is a tuple that contains the following fields:
#    5.1) entry-no: Troops spawned from this spawn record will use this entry
#    5.2) spawn flags.
#    5.3) alter flags. which equipment will be overriden
#    5.4) ai flags.
#    5.5) Number of troops to spawn.
#    5.6) list of equipment to add to troops spawned from here (maximum 8).
#  6) List of triggers (list).
#     See module_triggers.py for infomation about triggers.
#
#  Please note that mission templates is work in progress and can be changed in the future versions.
# 
####################################################################################################################

pilgrim_disguise = [itm_pilgrim_hood,itm_pilgrim_disguise,itm_practice_staff, itm_throwing_daggers]
af_castle_lord = af_override_horse | af_override_weapons| af_require_civilian

mission_templates = [
  ("town_default", 0, -1,
  "Default town visit",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_priest_robe_1,itm_priest_cap_1,itm_shoes,itm_sword_type_xii,itm_talak_buckler,itm_throwing_daggers]),
    (1, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (8, mtef_scene_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_scene_source, af_override_horse, 0, 1, []),
    (11, mtef_scene_source, af_override_horse, 0, 1, []),
    (12, mtef_scene_source, af_override_horse, 0, 1, []),
    (13, mtef_scene_source, 0, 0, 1, []),
    (14, mtef_scene_source, 0, 0, 1, []),
    (15, mtef_scene_source, 0, 0, 1, []),
    (16, mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_init_town_agent", ":var0"),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (call_script, "script_init_town_walker_agents"),
      (store_current_scene, ":var0"),
      (scene_set_slot, ":var0", 0, 1),
      (try_begin),
        (eq, "$sneaked_into_town", 1),
        (call_script, "script_music_set_situation_with_culture", 16384),
      (else_try),
        (eq, "$talk_context", 14),
        (call_script, "script_music_set_situation_with_culture", 512),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", 8192),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_initialize_tavern_variables"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (1, 0, 0, 
    [
      (gt, "$g_belligerent_drunk_leaving", 0),
      (entry_point_get_position, pos0, 0),
      (agent_get_position, pos1, "$g_belligerent_drunk_leaving"),
      (get_distance_between_positions, ":var0", pos0, pos1),
      (le, ":var0", 150),
    ],
    [
      (agent_fade_out, "$g_belligerent_drunk_leaving"),
      (assign, "$g_belligerent_drunk_leaving", 0),
    ]),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (eq, "$g_main_attacker_agent", 0),
        (set_trigger_result, 1),
      (try_end),
    ],
    []),

    (2, 0, 0, 
    [
      (neg|conversation_screen_is_active),
      (eq, "$talk_context", 14),
      (neg|troop_slot_eq, "trp_hired_assassin", 12, "$g_encountered_party"),
      (party_slot_ge, "$g_encountered_party", 253, 1),
      (eq, "$drunks_dont_pick_fights", 0),
    ],
    [
      (try_begin),
        (eq, "$g_start_belligerent_drunk_fight", 0),
        (assign, "$g_start_belligerent_drunk_fight", 1),
        (party_get_slot, "$g_cur_belligerent_drunk", "$g_encountered_party", 253),
        (try_for_agents, ":var0"),
          (agent_get_troop_id, ":var1", ":var0"),
          (eq, ":var1", "$g_cur_belligerent_drunk"),
          (assign, "$g_belligerent_drunk", ":var0"),
        (try_end),
      (else_try),
        (eq, "$g_start_belligerent_drunk_fight", 1),
        (agent_is_active, "$g_belligerent_drunk"),
        (agent_is_alive, "$g_belligerent_drunk"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos0, ":var2"),
        (agent_get_position, pos1, "$g_belligerent_drunk"),
        (get_distance_between_positions, ":var3", pos0, pos1),
        (position_get_z, ":var4", pos0),
        (position_get_z, ":var5", pos1),
        (store_sub, ":var6", ":var5", ":var4"),
        (try_begin),
          (le, ":var6", 0),
          (val_mul, ":var6", -1),
        (try_end),
        (store_mul, ":var7", ":var6", 3),
        (val_add, ":var3", ":var7"),
        (store_random_in_range, ":var8", 0, 200),
        (store_add, ":var9", 400, ":var8"),
        (le, ":var3", ":var9"),
        (call_script, "script_activate_tavern_attackers", "$g_cur_belligerent_drunk"),
        (start_mission_conversation, "$g_cur_belligerent_drunk"),
        (assign, "$g_start_belligerent_drunk_fight", 2),
      (try_end),
    ]),

    (2, 0, 0, 
    [
      (neg|conversation_screen_is_active),
      (eq, "$talk_context", 14),
      (troop_slot_eq, "trp_hired_assassin", 12, "$g_encountered_party"),
    ],
    [
      (try_begin),
        (eq, "$g_start_hired_assassin_fight", 0),
        (assign, "$g_start_hired_assassin_fight", 1),
        (try_for_agents, ":var0"),
          (agent_get_troop_id, ":var1", ":var0"),
          (eq, ":var1", "trp_hired_assassin"),
          (assign, "$g_hired_assassin", ":var0"),
        (try_end),
      (else_try),
        (eq, "$g_start_hired_assassin_fight", 1),
        (agent_is_active, "$g_hired_assassin"),
        (agent_is_alive, "$g_hired_assassin"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos0, ":var2"),
        (agent_get_position, pos1, "$g_hired_assassin"),
        (get_distance_between_positions, ":var3", pos0, pos1),
        (position_get_z, ":var4", pos0),
        (position_get_z, ":var5", pos1),
        (store_sub, ":var6", ":var5", ":var4"),
        (try_begin),
          (le, ":var6", 0),
          (val_mul, ":var6", -1),
        (try_end),
        (store_mul, ":var7", ":var6", 3),
        (val_add, ":var3", ":var7"),
        (store_random_in_range, ":var8", 0, 200),
        (store_add, ":var9", 400, ":var8"),
        (le, ":var3", ":var9"),
        (call_script, "script_activate_tavern_attackers", "trp_hired_assassin"),
        (assign, "$g_start_hired_assassin_fight", 2),
      (try_end),
    ]),

    (3, 0, ti_once, 
    [
      (neg|conversation_screen_is_active),
      (eq, "$talk_context", 14),
      (gt, "$g_main_attacker_agent", 0),
      (neg|this_or_next|agent_is_alive, "$g_main_attacker_agent"),
      (agent_is_wounded, "$g_main_attacker_agent"),
    ],
    [
      (mission_enable_talk),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_position, pos4, ":var0"),
        (agent_set_scripted_destination, ":var0", pos4),
      (try_end),
      (party_get_slot, ":var1", "$g_encountered_party", 20),
      (start_mission_conversation, ":var1"),
    ]),

    (3, 0, ti_once, 
    [
      (neg|conversation_screen_is_active),
      (eq, "$talk_context", 14),
      (gt, "$g_main_attacker_agent", 0),
      (main_hero_fallen),
    ],
    [
      (jump_to_menu, "mnu_lost_tavern_duel"),
      (finish_mission, 0),
    ]),

    (1, 0, 0, 
    [
      (gt, "$g_main_attacker_agent", 0),
    ],
    [
      (agent_get_wielded_item, ":var0", "$g_main_attacker_agent", 0),
      (val_max, "$g_attacker_drawn_weapon", ":var0"),
      (call_script, "script_neutral_behavior_in_fight"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

    (ti_after_mission_start, 0, ti_once, 
    [
      (neq, "$g_mt_mode", 1),
    ],
    [
      (store_skill_level, ":var0", 1, "trp_player"),
      (troop_get_slot, ":var1", "trp_player", 7),
      (val_div, ":var0", 3),
      (val_div, ":var1", 400),
      (store_add, ":var2", ":var1", ":var0"),
      (val_min, ":var2", 4),
      (ge, ":var2", 1),
      (get_player_agent_no, ":var3"),
      (agent_get_team, ":var4", ":var3"),
      (agent_get_horse, ":var5", ":var3"),
      (assign, ":var6", 0),
      (assign, ":var7", 0),
      (try_begin),
        (party_slot_eq, "$current_town", 0, 4),
        (assign, ":var6", 11),
        (assign, ":var7", "mt_village_center"),
      (else_try),
        (this_or_next|eq, "$talk_context", 18),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 0),
        (assign, ":var6", 24),
        (try_begin),
          (party_slot_eq, "$current_town", 0, 2),
          (assign, ":var7", "mt_castle_visit"),
        (else_try),
          (assign, ":var7", "mt_town_center"),
        (try_end),
      (else_try),
        (eq, "$talk_context", 14),
        (assign, ":var6", 17),
      (try_end),
      (try_begin),
        (neq, "$talk_context", 14),
        (gt, ":var5", 0),
        (mission_tpl_entry_set_override_flags, ":var7", ":var6", 0),
      (try_end),
      (store_current_scene, ":var8"),
      (modify_visitors_at_site, ":var8"),
      (assign, ":var9", 0),
      (party_get_num_companion_stacks, ":var10", "p_main_party"),
      (try_for_range, ":var11", 0, ":var10"),
        (party_stack_get_troop_id, ":var12", "p_main_party", ":var11"),
        (neq, ":var12", "trp_player"),
        (troop_is_hero, ":var12"),
        (neg|troop_is_wounded, ":var12"),
        (val_add, ":var9", 1),
        (try_begin),
          (this_or_next|eq, "$talk_context", 19),
          (eq, "$talk_context", 18),
          (troop_set_slot, ":var12", 155, 1),
        (try_end),
        (add_visitors_to_current_scene, ":var6", ":var12", 1),
        (eq, ":var9", ":var2"),
        (assign, ":var10", 0),
      (try_end),
      (gt, ":var9", 0),
      (set_show_messages, 0),
      (team_give_order, ":var4", 8, 1),
      (set_show_messages, 1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (troop_is_hero, ":var1"),
      (main_party_has_troop, ":var1"),
      (get_player_agent_no, ":var2"),
      (agent_get_team, ":var3", ":var2"),
      (agent_get_position, pos1, ":var2"),
      (agent_set_team, ":var0", ":var3"),
      (agent_set_division, ":var0", 8),
      (agent_add_relation_with_agent, ":var0", ":var2", 1),
      (agent_set_is_alarmed, ":var0", 1),
      (store_random_in_range, ":var4", 1, 3),
      (val_mul, ":var4", 100),
      (position_move_y, pos1, ":var4"),
      (store_random_in_range, ":var4", 1, 3),
      (store_random_in_range, ":var5", 0, 2),
      (val_mul, ":var5", -1),
      (try_begin),
        (neq, ":var5", 0),
        (val_mul, ":var4", ":var5"),
      (try_end),
      (position_move_x, 1, ":var4"),
      (agent_set_position, ":var0", pos1),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (troop_is_hero, ":var1"),
      (main_party_has_troop, ":var1"),
      (party_wound_members, "p_main_party", ":var1", 1),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$g_decap_enabled", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (agent_is_non_player, ":var0"),
      (agent_get_troop_id, ":var3", ":var0"),
      (neg|troop_is_hero, ":var3"),
      (assign, ":var4", reg0),
      (copy_position, 5, 0),
      (neq, ":var0", -1),
      (try_begin),
        (agent_is_human, ":var0"),
        (ge, ":var4", 0),
        (assign, ":var5", 0),
        (try_begin),
          (this_or_next|eq, ":var4", "itm_supercrossbow"),
          (eq, ":var4", "itm_supersledge"),
          (assign, ":var5", 1),
        (else_try),
          (neq, ":var4", "itm_mace_1"),
          (neq, ":var4", "itm_mace_2"),
          (neq, ":var4", "itm_mace_3"),
          (neq, ":var4", "itm_staff"),
          (agent_get_action_dir, ":var6", ":var1"),
          (this_or_next|eq, ":var6", 1),
          (eq, ":var6", 2),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var5", 0),
        (try_begin),
          (ge, ":var2", "$g_decap_minimum_damage"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap minimum DMG req bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (store_agent_hit_points, ":var7", ":var0", 1),
        (val_add, ":var7", "$g_decap_negative_health"),
        (ge, ":var2", ":var7"),
        (agent_get_position, pos4, ":var0"),
        (get_distance_between_positions, ":var8", pos4, pos5),
        (agent_get_horse, ":var9", ":var0"),
        (try_begin),
          (ge, ":var9", 0),
          (assign, ":var10", 240),
          (assign, ":var11", 260),
        (else_try),
          (assign, ":var10", 160),
          (assign, ":var11", 176),
        (try_end),
        (is_between, ":var8", ":var10", ":var11"),
        (assign, ":var5", 0),
        (try_begin),
          (store_random_in_range, ":var12", 0, 100),
          (le, ":var12", "$g_decap_chance"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap chance calc bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var13", "itm_cut_off_head_male"),
        (agent_get_troop_id, ":var14", ":var0"),
        (try_begin),
          (ge, ":var14", 0),
          (troop_get_type, ":var15", ":var14"),
          (eq, ":var15", 1),
          (assign, ":var13", "itm_cut_off_head_female"),
        (try_end),
        (store_random_in_range, ":var16", 0, 360),
        (store_random_in_range, ":var17", -60, 60),
        (store_random_in_range, ":var18", -90, 90),
        (store_random_in_range, ":var19", -90, 90),
        (position_rotate_z, pos4, ":var16"),
        (position_rotate_y, pos4, ":var17"),
        (position_move_x, 4, ":var18"),
        (position_move_y, pos4, ":var19"),
        (position_set_z_to_ground_level, pos4),
        (position_move_z, pos4, 5),
        (set_spawn_position, pos4),
        (assign, ":var20", 360),
        (agent_get_item_slot, ":var21", ":var0", 4),
        (try_begin),
          (ge, ":var21", 1),
          (agent_unequip_item, ":var0", ":var21"),
          (try_begin),
            (spawn_item, ":var21", 0, ":var20"),
          (try_end),
        (try_end),
        (agent_equip_item, ":var0", "itm_invisible_head"),
        (agent_get_position, pos4, ":var0"),
        (position_move_z, pos4, ":var10"),
        (particle_system_burst, "psys_blood_decapitation", pos4, "$g_decap_psys_blood_decapitation"),
        (particle_system_burst, "psys_game_blood", pos4, "$g_decap_psys_game_blood"),
        (particle_system_burst, "psys_game_blood_2", pos4, "$g_decap_psys_game_blood_2"),
        (play_sound_at_position, "snd_decapitation", pos4),
        (position_move_z, pos4, 20),
        (set_spawn_position, pos4),
        (assign, ":var13", "spr_head_dynamic_male"),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var13", "spr_head_dynamic_female"),
        (try_end),
        (spawn_scene_prop, ":var13"),
        (agent_get_troop_id, ":var22", ":var1"),
        (str_store_troop_name, s0, ":var22"),
        (agent_get_troop_id, ":var14", ":var0"),
        (str_store_troop_name, s1, ":var14"),
        (get_player_agent_no, ":var23"),
        (agent_get_team, ":var24", ":var23"),
        (agent_get_team, ":var25", ":var0"),
        (try_begin),
          (neq, ":var24", ":var25"),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFF33DD11),
        (else_try),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFFFF4422),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_bully_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_fat_peasant_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_thug_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_fatseveredarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_thin_looter_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (0, 0, 1, 
    [
      (key_clicked, key_right_control),
    ],
    [
      (try_begin),
        (key_is_down, key_m),
        (try_begin),
          (eq, "$g_decapitations_debugging", 0),
          (assign, "$g_decapitations_debugging", 1),
          (display_message, "@Decapitation debug mode Enabled"),
        (else_try),
          (assign, "$g_decapitations_debugging", 0),
          (display_message, "@Decapitation debug mode Disabled"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, key_k),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos17, ":var0"),
        (position_move_y, pos17, 2000),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_bully_handless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_thug_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_thin_looter_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_fat_peasant_handless"),
        (agent_set_team, reg0, 2),
      (try_end),
      (try_begin),
        (key_is_down, key_j),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos18, ":var0"),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supersledge"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supercrossbow"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_super_bolts"),
      (try_end),
    ]),

  ]),

  ("conversation_encounter", 0, -1,
  "Conversation encounter",
  [
    (0, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (1, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (2, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (3, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (4, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (5, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (6, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (7, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (8, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (9, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (10, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (11, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (12, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (13, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (14, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (15, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (16, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (17, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (18, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (19, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (20, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (21, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (22, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (23, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (24, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (25, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (26, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (27, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (28, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (29, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (30, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
    (31, mtef_visitor_source, af_override_fullhelm, 0, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("town_center", 0, -1,
  "Default town visit",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_priest_robe_1,itm_priest_cap_1,itm_shoes,itm_sword_type_xii,itm_talak_buckler,itm_throwing_daggers]),
    (1, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_priest_robe_1,itm_priest_cap_1,itm_shoes,itm_sword_type_xii,itm_talak_buckler,itm_throwing_daggers]),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_priest_robe_1,itm_priest_cap_1,itm_shoes,itm_sword_type_xii,itm_talak_buckler,itm_throwing_daggers]),
    (4, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_priest_robe_1,itm_priest_cap_1,itm_shoes,itm_sword_type_xii,itm_talak_buckler,itm_throwing_daggers]),
    (5, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_priest_robe_1,itm_priest_cap_1,itm_shoes,itm_sword_type_xii,itm_talak_buckler,itm_throwing_daggers]),
    (6, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_priest_robe_1,itm_priest_cap_1,itm_shoes,itm_sword_type_xii,itm_talak_buckler,itm_throwing_daggers]),
    (7, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_priest_robe_1,itm_priest_cap_1,itm_shoes,itm_sword_type_xii,itm_talak_buckler,itm_throwing_daggers]),
    (8, mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_visitor_source, 0, 0, 1, []),
    (14, mtef_scene_source, 0, 0, 1, []),
    (15, mtef_scene_source, 0, 0, 1, []),
    (16, mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_visitor_source, af_override_horse, 0, 1, []),
    (34, mtef_visitor_source, af_override_horse, 0, 1, []),
    (35, mtef_visitor_source, af_override_horse, 0, 1, []),
    (36, mtef_visitor_source, af_override_horse, 0, 1, []),
    (37, mtef_visitor_source, af_override_horse, 0, 1, []),
    (38, mtef_visitor_source, af_override_horse, 0, 1, []),
    (39, mtef_visitor_source, af_override_horse, 0, 1, []),
    (40, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$tom_sand_storm", 0),
      (call_script, "script_change_rain_or_snow"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_init_town_agent", ":var0"),
      (try_begin),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 18),
        (agent_get_troop_id, ":var1", ":var0"),
        (troop_slot_eq, ":var1", 155, 1),
        (get_player_agent_no, ":var2"),
        (agent_get_team, ":var3", ":var2"),
        (agent_set_team, ":var0", ":var3"),
        (agent_ai_set_aggressiveness, ":var0", 5),
        (troop_set_slot, ":var1", 155, 0),
        (try_begin),
          (troop_slot_eq, ":var1", 149, 3),
          (agent_get_position, pos1, ":var0"),
          (agent_set_scripted_destination, ":var0", pos1),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_main_attacker_agent", 0),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (try_begin),
        (eq, "$g_mt_mode", 0),
        (store_current_scene, ":var0"),
        (scene_set_slot, ":var0", 0, 1),
      (try_end),
      (call_script, "script_init_town_walker_agents"),
      (try_begin),
        (eq, "$sneaked_into_town", 1),
        (call_script, "script_music_set_situation_with_culture", 16384),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", 8192),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (try_begin),
        (eq, "$g_mt_mode", 0),
        (set_trigger_result, 1),
      (else_try),
        (eq, "$g_mt_mode", 1),
        (display_message, "str_cant_use_inventory_disguised"),
      (else_try),
        (display_message, "str_cant_use_inventory_now"),
      (try_end),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 18),
        (display_message, "str_cannot_leave_now"),
      (else_try),
        (this_or_next|eq, "$g_mt_mode", 0),
        (eq, "$g_mt_mode", 1),
        (mission_enable_talk),
        (set_trigger_result, 1),
      (else_try),
        (display_message, "str_cannot_leave_now"),
      (try_end),
    ],
    []),

    (ti_on_leave_area, 0, 0, 
    [
      (try_begin),
        (eq, "$g_defending_against_siege", 0),
        (assign, "$g_leave_town", 1),
      (try_end),
    ],
    [
      (try_begin),
        (eq, "$talk_context", 19),
        (call_script, "script_deduct_casualties_from_garrison"),
        (jump_to_menu, "mnu_sneak_into_town_caught_dispersed_guards"),
      (try_end),
      (mission_enable_talk),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (party_slot_eq, "$current_town", 0, 3),
      (call_script, "script_town_init_doors", 0),
      (try_begin),
        (eq, "$town_nighttime", 0),
        (play_sound, "snd_town_ambiance", 2),
      (try_end),
      (store_current_scene, ":var0"),
      (try_begin),
        (this_or_next|eq, ":var0", "scn_acre_center"),
        (this_or_next|eq, ":var0", "scn_venice_center"),
        (this_or_next|eq, ":var0", "scn_walls_scot"),
        (eq, ":var0", "scn_walls_mann"),
        (play_sound, "snd_sea_ambiance", 2),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (call_script, "script_tick_town_walkers"),
    ],
    []),

    (2, 0, 0, 
    [
      (call_script, "script_center_ambiance_sounds"),
    ],
    []),

    (1, 0, 0, 
    [
      (this_or_next|eq, "$talk_context", 18),
      (eq, "$talk_context", 19),
    ],
    [
      (call_script, "script_neutral_behavior_in_fight"),
      (mission_disable_talk),
    ]),

    (1, 0, ti_once, 
    [
      (eq, "$talk_context", 19),
    ],
    [
      (get_player_agent_no, ":var0"),
      (assign, reg6, ":var0"),
      (call_script, "script_activate_town_guard"),
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos4, ":var0"),
      (try_for_range, ":var1", "trp_npc1", "trp_heroes_end"),
        (troop_slot_eq, ":var1", 166, 1),
        (troop_slot_ge, ":var1", 149, 2),
        (str_store_troop_name, s4, ":var1"),
        (display_message, "str_s4_joins_prison_break"),
        (store_current_scene, ":var2"),
        (modify_visitors_at_site, ":var2"),
        (store_current_scene, ":var2"),
        (modify_visitors_at_site, ":var2"),
        (add_visitors_to_current_scene, 24, ":var1", 1, 0, 0),
        (troop_set_slot, ":var1", 155, 1),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (main_hero_fallen, 0),
    ],
    [
      (try_begin),
        (this_or_next|eq, "$talk_context", 18),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$town_residents_enraged", 1),
        (call_script, "script_deduct_casualties_from_garrison"),
        (jump_to_menu, "mnu_captivity_start_castle_defeat"),
        (assign, ":var0", "trp_heroes_end"),
        (try_for_range, ":var1", "trp_npc1", ":var0"),
          (troop_slot_eq, ":var1", 166, 1),
          (troop_set_slot, ":var1", 149, 0),
        (try_end),
        (mission_enable_talk),
        (finish_mission, 0),
      (else_try),
        (set_trigger_result, 1),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (eq, "$talk_context", 19),
      (neg|main_hero_fallen, 0),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (all_enemies_defeated),
    ],
    [
      (call_script, "script_deduct_casualties_from_garrison"),
      (try_for_agents, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (troop_slot_ge, ":var1", 149, 2),
        (try_begin),
          (agent_is_alive, ":var0"),
          (troop_set_slot, ":var1", 149, 4),
        (else_try),
          (troop_set_slot, ":var1", 149, 5),
        (try_end),
      (try_end),
      (jump_to_menu, "mnu_sneak_into_town_caught_ran_away"),
      (mission_enable_talk),
      (finish_mission, 0),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (try_begin),
        (agent_get_entry_no, ":var4", ":var0"),
        (eq, ":var4", 24),
        (eq, ":var3", "trp_player"),
        (display_message, "@You got keys to the dungeon."),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

    (ti_after_mission_start, 0, ti_once, 
    [
      (neq, "$g_mt_mode", 1),
    ],
    [
      (store_skill_level, ":var0", 1, "trp_player"),
      (troop_get_slot, ":var1", "trp_player", 7),
      (val_div, ":var0", 3),
      (val_div, ":var1", 400),
      (store_add, ":var2", ":var1", ":var0"),
      (val_min, ":var2", 4),
      (ge, ":var2", 1),
      (get_player_agent_no, ":var3"),
      (agent_get_team, ":var4", ":var3"),
      (agent_get_horse, ":var5", ":var3"),
      (assign, ":var6", 0),
      (assign, ":var7", 0),
      (try_begin),
        (party_slot_eq, "$current_town", 0, 4),
        (assign, ":var6", 11),
        (assign, ":var7", "mt_village_center"),
      (else_try),
        (this_or_next|eq, "$talk_context", 18),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 0),
        (assign, ":var6", 24),
        (try_begin),
          (party_slot_eq, "$current_town", 0, 2),
          (assign, ":var7", "mt_castle_visit"),
        (else_try),
          (assign, ":var7", "mt_town_center"),
        (try_end),
      (else_try),
        (eq, "$talk_context", 14),
        (assign, ":var6", 17),
      (try_end),
      (try_begin),
        (neq, "$talk_context", 14),
        (gt, ":var5", 0),
        (mission_tpl_entry_set_override_flags, ":var7", ":var6", 0),
      (try_end),
      (store_current_scene, ":var8"),
      (modify_visitors_at_site, ":var8"),
      (assign, ":var9", 0),
      (party_get_num_companion_stacks, ":var10", "p_main_party"),
      (try_for_range, ":var11", 0, ":var10"),
        (party_stack_get_troop_id, ":var12", "p_main_party", ":var11"),
        (neq, ":var12", "trp_player"),
        (troop_is_hero, ":var12"),
        (neg|troop_is_wounded, ":var12"),
        (val_add, ":var9", 1),
        (try_begin),
          (this_or_next|eq, "$talk_context", 19),
          (eq, "$talk_context", 18),
          (troop_set_slot, ":var12", 155, 1),
        (try_end),
        (add_visitors_to_current_scene, ":var6", ":var12", 1),
        (eq, ":var9", ":var2"),
        (assign, ":var10", 0),
      (try_end),
      (gt, ":var9", 0),
      (set_show_messages, 0),
      (team_give_order, ":var4", 8, 1),
      (set_show_messages, 1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (troop_is_hero, ":var1"),
      (main_party_has_troop, ":var1"),
      (get_player_agent_no, ":var2"),
      (agent_get_team, ":var3", ":var2"),
      (agent_get_position, pos1, ":var2"),
      (agent_set_team, ":var0", ":var3"),
      (agent_set_division, ":var0", 8),
      (agent_add_relation_with_agent, ":var0", ":var2", 1),
      (agent_set_is_alarmed, ":var0", 1),
      (store_random_in_range, ":var4", 1, 3),
      (val_mul, ":var4", 100),
      (position_move_y, pos1, ":var4"),
      (store_random_in_range, ":var4", 1, 3),
      (store_random_in_range, ":var5", 0, 2),
      (val_mul, ":var5", -1),
      (try_begin),
        (neq, ":var5", 0),
        (val_mul, ":var4", ":var5"),
      (try_end),
      (position_move_x, 1, ":var4"),
      (agent_set_position, ":var0", pos1),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (troop_is_hero, ":var1"),
      (main_party_has_troop, ":var1"),
      (party_wound_members, "p_main_party", ":var1", 1),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, ":var0", 1),
      (try_begin),
        (party_slot_eq, "$current_town", 7, "trp_player"),
        (assign, ":var0", 0),
      (try_end),
      (try_begin),
        (check_quest_active, "qst_bounty_1"),
        (quest_slot_eq, "qst_bounty_1", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_2"),
        (quest_slot_eq, "qst_bounty_2", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_3"),
        (quest_slot_eq, "qst_bounty_3", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_4"),
        (quest_slot_eq, "qst_bounty_4", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_5"),
        (quest_slot_eq, "qst_bounty_5", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_6"),
        (quest_slot_eq, "qst_bounty_6", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_hunt_down_fugitive"),
        (quest_slot_eq, "qst_hunt_down_fugitive", 1, "$current_town"),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (get_player_agent_no, ":var1"),
      (agent_set_team, ":var1", 0),
      (team_set_relation, 0, 1, 1),
      (team_set_relation, 0, 2, -1),
      (team_set_relation, 1, 2, 0),
      (try_for_agents, ":var2"),
        (neq, ":var2", ":var1"),
        (agent_set_team, ":var2", 1),
      (try_end),
      (assign, "$town_residents_enraged", 0),
      (assign, "$town_residents_condone_chance", 0),
      (assign, "$town_residents_condoned", 0),
      (assign, "$troop_restore_offset", 1),
    ]),

    (0, 0, 0, 
    [],
    [
      (assign, ":var0", 1),
      (try_begin),
        (party_slot_eq, "$current_town", 7, "trp_player"),
        (assign, ":var0", 0),
      (try_end),
      (try_begin),
        (check_quest_active, "qst_bounty_1"),
        (quest_slot_eq, "qst_bounty_1", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_2"),
        (quest_slot_eq, "qst_bounty_2", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_3"),
        (quest_slot_eq, "qst_bounty_3", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_4"),
        (quest_slot_eq, "qst_bounty_4", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_5"),
        (quest_slot_eq, "qst_bounty_5", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_6"),
        (quest_slot_eq, "qst_bounty_6", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_hunt_down_fugitive"),
        (quest_slot_eq, "qst_hunt_down_fugitive", 1, "$current_town"),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (get_player_agent_no, ":var1"),
      (agent_is_alive, ":var1"),
      (agent_get_position, pos1, ":var1"),
      (agent_get_attack_action, ":var2", ":var1"),
      (agent_get_defend_action, ":var3", ":var1"),
      (try_begin),
        (eq, ":var2", 2),
        (try_for_agents, ":var4"),
          (agent_is_human, ":var4"),
          (agent_is_alive, ":var4"),
          (neq, ":var4", ":var1"),
          (agent_get_position, pos2, ":var4"),
          (agent_get_team, ":var5", ":var4"),
          (eq, ":var5", 1),
          (try_begin),
            (position_is_behind_position, pos2, pos1),
          (else_try),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 100),
            (agent_force_rethink, ":var4"),
            (agent_ai_set_aggressiveness, ":var4", 199),
            (agent_set_team, ":var4", 2),
          (try_end),
        (try_end),
      (else_try),
        (eq, "$town_residents_enraged", 0),
        (this_or_next|eq, ":var3", 2),
        (eq, ":var3", 1),
        (try_begin),
          (ge, "$town_residents_condone_chance", 500),
          (val_sub, "$town_residents_condone_chance", 1),
          (val_add, "$town_residents_condoned", 1),
        (try_end),
        (lt, "$town_residents_condone_chance", 500),
        (try_for_agents, ":var4"),
          (agent_is_human, ":var4"),
          (agent_is_alive, ":var4"),
          (neq, ":var4", ":var1"),
          (agent_get_team, ":var5", ":var4"),
          (eq, ":var5", 2),
          (agent_add_relation_with_agent, ":var1", ":var4", 1),
          (agent_force_rethink, ":var4"),
          (agent_ai_set_aggressiveness, ":var4", 0),
          (agent_set_team, ":var4", 1),
        (try_end),
      (else_try),
        (eq, "$town_residents_enraged", 0),
        (this_or_next|gt, "$town_residents_condoned", 1500),
        (ge, "$town_residents_condone_chance", 2000),
        (try_for_agents, ":var4"),
          (agent_is_human, ":var4"),
          (agent_is_alive, ":var4"),
          (neq, ":var4", ":var1"),
          (agent_force_rethink, ":var4"),
          (agent_ai_set_aggressiveness, ":var4", 199),
          (agent_set_team, ":var4", 2),
        (try_end),
        (assign, "$town_residents_enraged", 1),
        (assign, "$town_residents_condoned", 0),
        (display_message, "str_saldiri_2"),
      (else_try),
        (eq, "$town_residents_enraged", 1),
        (agent_get_wielded_item, ":var7", ":var1", 0),
        (neq, ":var7", -1),
        (try_for_agents, ":var4"),
          (agent_is_human, ":var4"),
          (agent_is_alive, ":var4"),
          (neq, ":var4", ":var1"),
          (agent_get_troop_id, ":var8", ":var4"),
          (agent_get_wielded_item, ":var7", ":var4", 0),
          (try_begin),
            (neq, ":var7", -1),
            (agent_clear_scripted_mode, ":var4"),
          (try_end),
          (neg|is_between, ":var8", "trp_farmer", "trp_town_walker_1"),
          (agent_ai_set_aggressiveness, ":var4", 0),
          (agent_set_speed_limit, ":var4", 10),
          (party_get_slot, ":var9", "$current_town", 10),
          (party_get_slot, ":var10", "$current_town", 13),
          (store_current_scene, ":var11"),
          (try_begin),
            (eq, ":var11", ":var9"),
            (entry_point_get_position, pos3, 2),
          (else_try),
            (eq, ":var11", ":var10"),
            (entry_point_get_position, pos3, 0),
          (try_end),
          (agent_set_scripted_destination_no_attack, ":var4", pos3, 1),
          (agent_force_rethink, ":var4"),
          (agent_get_position, pos2, ":var4"),
          (get_distance_between_positions, ":var6", pos2, pos3),
          (try_begin),
            (gt, "$town_residents_condoned", 0),
            (agent_set_team, ":var4", 1),
          (try_end),
          (try_begin),
            (le, ":var6", 300),
            (agent_fade_out, ":var4"),
            (val_add, "$town_residents_condoned", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (assign, ":var0", 1),
      (try_begin),
        (party_slot_eq, "$current_town", 7, "trp_player"),
        (assign, ":var0", 0),
      (try_end),
      (try_begin),
        (check_quest_active, "qst_bounty_1"),
        (quest_slot_eq, "qst_bounty_1", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_2"),
        (quest_slot_eq, "qst_bounty_2", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_3"),
        (quest_slot_eq, "qst_bounty_3", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_4"),
        (quest_slot_eq, "qst_bounty_4", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_5"),
        (quest_slot_eq, "qst_bounty_5", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_6"),
        (quest_slot_eq, "qst_bounty_6", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_hunt_down_fugitive"),
        (quest_slot_eq, "qst_hunt_down_fugitive", 1, "$current_town"),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (store_trigger_param_2, ":var1"),
      (get_player_agent_no, ":var2"),
      (agent_is_alive, ":var2"),
      (eq, ":var1", ":var2"),
      (try_for_agents, ":var3"),
        (agent_is_human, ":var3"),
        (agent_is_alive, ":var3"),
        (neq, ":var3", ":var2"),
        (agent_force_rethink, ":var3"),
        (agent_ai_set_aggressiveness, ":var3", 199),
        (agent_set_team, ":var3", 2),
      (try_end),
      (assign, "$town_residents_enraged", 1),
      (party_get_slot, ":var4", "$current_town", 26),
      (val_sub, ":var4", 1),
      (party_set_slot, "$current_town", 26, ":var4"),
      (display_message, "str_saldiri_2"),
      (val_add, "$town_residents_condoned", 1),
      (party_get_slot, ":var5", "$current_town", 7),
      (call_script, "script_change_player_relation_with_troop", ":var5", -1),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [],
    [
      (assign, ":var0", 1),
      (try_begin),
        (party_slot_eq, "$current_town", 7, "trp_player"),
        (assign, ":var0", 0),
      (try_end),
      (try_begin),
        (check_quest_active, "qst_bounty_1"),
        (quest_slot_eq, "qst_bounty_1", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_2"),
        (quest_slot_eq, "qst_bounty_2", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_3"),
        (quest_slot_eq, "qst_bounty_3", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_4"),
        (quest_slot_eq, "qst_bounty_4", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_5"),
        (quest_slot_eq, "qst_bounty_5", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_6"),
        (quest_slot_eq, "qst_bounty_6", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_hunt_down_fugitive"),
        (quest_slot_eq, "qst_hunt_down_fugitive", 1, "$current_town"),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (store_trigger_param_1, ":var1"),
      (store_trigger_param_2, ":var2"),
      (get_player_agent_no, ":var3"),
      (agent_is_alive, ":var3"),
      (eq, ":var2", ":var3"),
      (agent_force_rethink, ":var1"),
      (agent_ai_set_aggressiveness, ":var1", 199),
      (agent_set_team, ":var1", 2),
      (val_add, "$town_residents_condone_chance", 1000),
      (eq, "$town_residents_enraged", 0),
    ]),

    (2, 0, 3, 
    [],
    [
      (assign, ":var0", 1),
      (try_begin),
        (party_slot_eq, "$current_town", 7, "trp_player"),
        (assign, ":var0", 0),
      (try_end),
      (try_begin),
        (check_quest_active, "qst_bounty_1"),
        (quest_slot_eq, "qst_bounty_1", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_2"),
        (quest_slot_eq, "qst_bounty_2", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_3"),
        (quest_slot_eq, "qst_bounty_3", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_4"),
        (quest_slot_eq, "qst_bounty_4", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_5"),
        (quest_slot_eq, "qst_bounty_5", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_6"),
        (quest_slot_eq, "qst_bounty_6", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_hunt_down_fugitive"),
        (quest_slot_eq, "qst_hunt_down_fugitive", 1, "$current_town"),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (get_player_agent_no, ":var1"),
      (agent_is_alive, ":var1"),
      (party_get_slot, ":var2", "$current_town", 10),
      (party_get_slot, ":var3", "$current_town", 13),
      (store_current_scene, ":var4"),
      (try_begin),
        (eq, ":var4", ":var2"),
        (entry_point_get_position, pos3, 2),
      (else_try),
        (eq, ":var4", ":var3"),
        (entry_point_get_position, pos3, 0),
      (try_end),
      (try_begin),
        (gt, "$town_residents_condoned", 2),
        (call_script, "script_return_random_troop_from_garrison", 1),
        (assign, ":var5", reg0),
        (gt, ":var5", 0),
        (call_script, "script_remove_troops_from_garrison", ":var5", 1),
        (set_spawn_position, pos3),
        (spawn_agent, ":var5"),
        (agent_set_team, reg0, 2),
        (agent_add_relation_with_agent, ":var1", reg0, -1),
        (agent_ai_set_aggressiveness, reg0, 199),
        (agent_get_position, pos3, ":var1"),
        (agent_set_scripted_destination, reg0, pos3, 1),
        (agent_force_rethink, reg0),
        (val_sub, "$town_residents_condoned", 1),
        (display_message, "str_saldiri_3"),
      (try_end),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$g_decap_enabled", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (agent_is_non_player, ":var0"),
      (agent_get_troop_id, ":var3", ":var0"),
      (neg|troop_is_hero, ":var3"),
      (assign, ":var4", reg0),
      (copy_position, 5, 0),
      (neq, ":var0", -1),
      (try_begin),
        (agent_is_human, ":var0"),
        (ge, ":var4", 0),
        (assign, ":var5", 0),
        (try_begin),
          (this_or_next|eq, ":var4", "itm_supercrossbow"),
          (eq, ":var4", "itm_supersledge"),
          (assign, ":var5", 1),
        (else_try),
          (neq, ":var4", "itm_mace_1"),
          (neq, ":var4", "itm_mace_2"),
          (neq, ":var4", "itm_mace_3"),
          (neq, ":var4", "itm_staff"),
          (agent_get_action_dir, ":var6", ":var1"),
          (this_or_next|eq, ":var6", 1),
          (eq, ":var6", 2),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var5", 0),
        (try_begin),
          (ge, ":var2", "$g_decap_minimum_damage"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap minimum DMG req bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (store_agent_hit_points, ":var7", ":var0", 1),
        (val_add, ":var7", "$g_decap_negative_health"),
        (ge, ":var2", ":var7"),
        (agent_get_position, pos4, ":var0"),
        (get_distance_between_positions, ":var8", pos4, pos5),
        (agent_get_horse, ":var9", ":var0"),
        (try_begin),
          (ge, ":var9", 0),
          (assign, ":var10", 240),
          (assign, ":var11", 260),
        (else_try),
          (assign, ":var10", 160),
          (assign, ":var11", 176),
        (try_end),
        (is_between, ":var8", ":var10", ":var11"),
        (assign, ":var5", 0),
        (try_begin),
          (store_random_in_range, ":var12", 0, 100),
          (le, ":var12", "$g_decap_chance"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap chance calc bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var13", "itm_cut_off_head_male"),
        (agent_get_troop_id, ":var14", ":var0"),
        (try_begin),
          (ge, ":var14", 0),
          (troop_get_type, ":var15", ":var14"),
          (eq, ":var15", 1),
          (assign, ":var13", "itm_cut_off_head_female"),
        (try_end),
        (store_random_in_range, ":var16", 0, 360),
        (store_random_in_range, ":var17", -60, 60),
        (store_random_in_range, ":var18", -90, 90),
        (store_random_in_range, ":var19", -90, 90),
        (position_rotate_z, pos4, ":var16"),
        (position_rotate_y, pos4, ":var17"),
        (position_move_x, 4, ":var18"),
        (position_move_y, pos4, ":var19"),
        (position_set_z_to_ground_level, pos4),
        (position_move_z, pos4, 5),
        (set_spawn_position, pos4),
        (assign, ":var20", 360),
        (agent_get_item_slot, ":var21", ":var0", 4),
        (try_begin),
          (ge, ":var21", 1),
          (agent_unequip_item, ":var0", ":var21"),
          (try_begin),
            (spawn_item, ":var21", 0, ":var20"),
          (try_end),
        (try_end),
        (agent_equip_item, ":var0", "itm_invisible_head"),
        (agent_get_position, pos4, ":var0"),
        (position_move_z, pos4, ":var10"),
        (particle_system_burst, "psys_blood_decapitation", pos4, "$g_decap_psys_blood_decapitation"),
        (particle_system_burst, "psys_game_blood", pos4, "$g_decap_psys_game_blood"),
        (particle_system_burst, "psys_game_blood_2", pos4, "$g_decap_psys_game_blood_2"),
        (play_sound_at_position, "snd_decapitation", pos4),
        (position_move_z, pos4, 20),
        (set_spawn_position, pos4),
        (assign, ":var13", "spr_head_dynamic_male"),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var13", "spr_head_dynamic_female"),
        (try_end),
        (spawn_scene_prop, ":var13"),
        (agent_get_troop_id, ":var22", ":var1"),
        (str_store_troop_name, s0, ":var22"),
        (agent_get_troop_id, ":var14", ":var0"),
        (str_store_troop_name, s1, ":var14"),
        (get_player_agent_no, ":var23"),
        (agent_get_team, ":var24", ":var23"),
        (agent_get_team, ":var25", ":var0"),
        (try_begin),
          (neq, ":var24", ":var25"),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFF33DD11),
        (else_try),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFFFF4422),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_bully_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_fat_peasant_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_thug_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_fatseveredarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_thin_looter_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (0, 0, 1, 
    [
      (key_clicked, key_right_control),
    ],
    [
      (try_begin),
        (key_is_down, key_m),
        (try_begin),
          (eq, "$g_decapitations_debugging", 0),
          (assign, "$g_decapitations_debugging", 1),
          (display_message, "@Decapitation debug mode Enabled"),
        (else_try),
          (assign, "$g_decapitations_debugging", 0),
          (display_message, "@Decapitation debug mode Disabled"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, key_k),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos17, ":var0"),
        (position_move_y, pos17, 2000),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_bully_handless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_thug_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_thin_looter_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_fat_peasant_handless"),
        (agent_set_team, reg0, 2),
      (try_end),
      (try_begin),
        (key_is_down, key_j),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos18, ":var0"),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supersledge"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supercrossbow"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_super_bolts"),
      (try_end),
    ]),

  ]),

  ("village_center", 0, -1,
  "village center",
  [
    (0, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
    (1, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (8, mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_visitor_source, 0, 0, 1, []),
    (14, mtef_visitor_source, 0, 0, 1, []),
    (15, mtef_visitor_source, 0, 0, 1, []),
    (16, mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_visitor_source, af_override_horse, 0, 1, []),
    (34, mtef_visitor_source, af_override_horse, 0, 1, []),
    (35, mtef_visitor_source, af_override_horse, 0, 1, []),
    (36, mtef_visitor_source, af_override_horse, 0, 1, []),
    (37, mtef_visitor_source, af_override_horse, 0, 1, []),
    (38, mtef_visitor_source, af_override_horse, 0, 1, []),
    (39, mtef_visitor_source, af_override_horse, 0, 1, []),
    (40, mtef_visitor_source, af_override_horse, 0, 1, []),
    (41, mtef_visitor_source, af_override_horse, 0, 1, []),
    (42, mtef_visitor_source, af_override_horse, 0, 1, []),
    (43, mtef_visitor_source, af_override_horse, 0, 1, []),
    (44, mtef_visitor_source, af_override_horse, 0, 1, []),
    (45, mtef_visitor_source, af_override_horse, 0, 1, []),
    (46, mtef_visitor_source, af_override_horse, 0, 1, []),
    (47, mtef_visitor_source, af_override_horse, 0, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$tom_sand_storm", 0),
      (call_script, "script_change_rain_or_snow"),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (store_current_scene, ":var0"),
      (scene_set_slot, ":var0", 0, 1),
      (call_script, "script_init_town_walker_agents"),
      (call_script, "script_music_set_situation_with_culture", 65536),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (check_quest_active, "qst_hunt_down_fugitive"),
        (neg|check_quest_succeeded, "qst_hunt_down_fugitive"),
        (neg|check_quest_failed, "qst_hunt_down_fugitive"),
        (quest_slot_eq, "qst_hunt_down_fugitive", 11, 1),
        (try_begin),
          (call_script, "script_cf_troop_agent_is_alive", "trp_fugitive"),
          (call_script, "script_fail_quest", "qst_hunt_down_fugitive"),
        (else_try),
          (call_script, "script_succeed_quest", "qst_hunt_down_fugitive"),
        (try_end),
      (try_end),
      (set_trigger_result, 1),
    ],
    []),

    (ti_on_leave_area, 0, 0, 
    [
      (try_begin),
        (assign, "$g_leave_town", 1),
      (try_end),
    ],
    []),

    (3, 0, 0, 
    [
      (call_script, "script_tick_town_walkers"),
    ],
    []),

    (2, 0, 0, 
    [
      (call_script, "script_center_ambiance_sounds"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (check_quest_active, "qst_bounty_1"),
        (neg|check_quest_succeeded, "qst_bounty_1"),
        (neg|check_quest_failed, "qst_bounty_1"),
        (quest_slot_eq, "qst_bounty_1", 11, 1),
        (try_begin),
          (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_1"),
          (call_script, "script_fail_quest_bounty", "qst_bounty_1"),
        (else_try),
          (call_script, "script_succeed_quest_bounty", "qst_bounty_1"),
        (try_end),
        (troop_set_name, "$bounty_target_1", s51),
      (try_end),
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (check_quest_active, "qst_bounty_2"),
        (neg|check_quest_succeeded, "qst_bounty_2"),
        (neg|check_quest_failed, "qst_bounty_2"),
        (quest_slot_eq, "qst_bounty_2", 11, 1),
        (try_begin),
          (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_2"),
          (call_script, "script_fail_quest_bounty", "qst_bounty_2"),
        (else_try),
          (call_script, "script_succeed_quest_bounty", "qst_bounty_2"),
        (try_end),
        (troop_set_name, "$bounty_target_2", s51),
      (try_end),
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (check_quest_active, "qst_bounty_3"),
        (neg|check_quest_succeeded, "qst_bounty_3"),
        (neg|check_quest_failed, "qst_bounty_3"),
        (quest_slot_eq, "qst_bounty_3", 11, 1),
        (try_begin),
          (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_3"),
          (call_script, "script_fail_quest_bounty", "qst_bounty_3"),
        (else_try),
          (call_script, "script_succeed_quest_bounty", "qst_bounty_3"),
        (try_end),
        (troop_set_name, "$bounty_target_3", s51),
      (try_end),
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (check_quest_active, "qst_bounty_4"),
        (neg|check_quest_succeeded, "qst_bounty_4"),
        (neg|check_quest_failed, "qst_bounty_4"),
        (quest_slot_eq, "qst_bounty_4", 11, 1),
        (try_begin),
          (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_4"),
          (call_script, "script_fail_quest_bounty", "qst_bounty_4"),
        (else_try),
          (call_script, "script_succeed_quest_bounty", "qst_bounty_4"),
        (try_end),
        (troop_set_name, "$bounty_target_4", s51),
      (try_end),
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (check_quest_active, "qst_bounty_5"),
        (neg|check_quest_succeeded, "qst_bounty_5"),
        (neg|check_quest_failed, "qst_bounty_5"),
        (quest_slot_eq, "qst_bounty_5", 11, 1),
        (try_begin),
          (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_5"),
          (call_script, "script_fail_quest_bounty", "qst_bounty_5"),
        (else_try),
          (call_script, "script_succeed_quest_bounty", "qst_bounty_5"),
        (try_end),
        (troop_set_name, "$bounty_target_5", s51),
      (try_end),
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (check_quest_active, "qst_bounty_6"),
        (neg|check_quest_succeeded, "qst_bounty_6"),
        (neg|check_quest_failed, "qst_bounty_6"),
        (quest_slot_eq, "qst_bounty_6", 11, 1),
        (try_begin),
          (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_6"),
          (call_script, "script_fail_quest_bounty", "qst_bounty_6"),
        (else_try),
          (call_script, "script_succeed_quest_bounty", "qst_bounty_6"),
        (try_end),
        (troop_set_name, "$bounty_target_6", s51),
      (try_end),
      (set_trigger_result, 1),
    ],
    []),

    (1, 0, ti_once, 
    [
      (check_quest_active, "qst_bounty_1"),
      (neg|check_quest_succeeded, "qst_bounty_1"),
      (neg|check_quest_failed, "qst_bounty_1"),
      (quest_slot_eq, "qst_bounty_1", 11, 1),
      (assign, ":var0", 0),
      (try_begin),
        (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_1"),
      (else_try),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|main_hero_fallen),
      (eq, ":var0", 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_village_hunt_down_fugitive_defeated"),
        (call_script, "script_fail_quest_bounty", "qst_bounty_1"),
        (finish_mission, 4),
      (else_try),
        (call_script, "script_change_player_relation_with_center", "$current_town", -2),
        (call_script, "script_succeed_quest_bounty", "qst_bounty_1"),
      (try_end),
      (troop_set_name, "$bounty_target_1", s51),
    ]),

    (1, 0, ti_once, 
    [
      (check_quest_active, "qst_bounty_2"),
      (neg|check_quest_succeeded, "qst_bounty_2"),
      (neg|check_quest_failed, "qst_bounty_2"),
      (quest_slot_eq, "qst_bounty_2", 11, 1),
      (assign, ":var0", 0),
      (try_begin),
        (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_2"),
      (else_try),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|main_hero_fallen),
      (eq, ":var0", 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_village_hunt_down_fugitive_defeated"),
        (call_script, "script_fail_quest_bounty", "qst_bounty_2"),
        (finish_mission, 4),
      (else_try),
        (call_script, "script_change_player_relation_with_center", "$current_town", -2),
        (call_script, "script_succeed_quest_bounty", "qst_bounty_2"),
      (try_end),
      (troop_set_name, "$bounty_target_2", s51),
    ]),

    (1, 0, ti_once, 
    [
      (check_quest_active, "qst_bounty_3"),
      (neg|check_quest_succeeded, "qst_bounty_3"),
      (neg|check_quest_failed, "qst_bounty_3"),
      (quest_slot_eq, "qst_bounty_3", 11, 1),
      (assign, ":var0", 0),
      (try_begin),
        (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_3"),
      (else_try),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|main_hero_fallen),
      (eq, ":var0", 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_village_hunt_down_fugitive_defeated"),
        (call_script, "script_fail_quest_bounty", "qst_bounty_3"),
        (finish_mission, 4),
      (else_try),
        (call_script, "script_change_player_relation_with_center", "$current_town", -2),
        (call_script, "script_succeed_quest_bounty", "qst_bounty_3"),
      (try_end),
      (troop_set_name, "$bounty_target_3", s51),
    ]),

    (1, 0, ti_once, 
    [
      (check_quest_active, "qst_bounty_4"),
      (neg|check_quest_succeeded, "qst_bounty_4"),
      (neg|check_quest_failed, "qst_bounty_4"),
      (quest_slot_eq, "qst_bounty_4", 11, 1),
      (assign, ":var0", 0),
      (try_begin),
        (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_4"),
      (else_try),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|main_hero_fallen),
      (eq, ":var0", 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_village_hunt_down_fugitive_defeated"),
        (call_script, "script_fail_quest_bounty", "qst_bounty_4"),
        (finish_mission, 4),
      (else_try),
        (call_script, "script_change_player_relation_with_center", "$current_town", -2),
        (call_script, "script_succeed_quest_bounty", "qst_bounty_4"),
      (try_end),
      (troop_set_name, "$bounty_target_4", s51),
    ]),

    (1, 0, ti_once, 
    [
      (check_quest_active, "qst_bounty_5"),
      (neg|check_quest_succeeded, "qst_bounty_5"),
      (neg|check_quest_failed, "qst_bounty_5"),
      (quest_slot_eq, "qst_bounty_5", 11, 1),
      (assign, ":var0", 0),
      (try_begin),
        (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_5"),
      (else_try),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|main_hero_fallen),
      (eq, ":var0", 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_village_hunt_down_fugitive_defeated"),
        (call_script, "script_fail_quest_bounty", "qst_bounty_5"),
        (finish_mission, 4),
      (else_try),
        (call_script, "script_change_player_relation_with_center", "$current_town", -2),
        (call_script, "script_succeed_quest_bounty", "qst_bounty_5"),
      (try_end),
      (troop_set_name, "$bounty_target_5", s51),
    ]),

    (1, 0, ti_once, 
    [
      (check_quest_active, "qst_bounty_6"),
      (neg|check_quest_succeeded, "qst_bounty_6"),
      (neg|check_quest_failed, "qst_bounty_6"),
      (quest_slot_eq, "qst_bounty_6", 11, 1),
      (assign, ":var0", 0),
      (try_begin),
        (call_script, "script_cf_troop_agent_is_alive", "$bounty_target_6"),
      (else_try),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|main_hero_fallen),
      (eq, ":var0", 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_village_hunt_down_fugitive_defeated"),
        (call_script, "script_fail_quest_bounty", "qst_bounty_6"),
        (finish_mission, 4),
      (else_try),
        (call_script, "script_change_player_relation_with_center", "$current_town", -2),
        (call_script, "script_succeed_quest_bounty", "qst_bounty_6"),
      (try_end),
      (troop_set_name, "$bounty_target_6", s51),
    ]),

    (1, 0, ti_once, 
    [
      (check_quest_active, "qst_hunt_down_fugitive"),
      (neg|check_quest_succeeded, "qst_hunt_down_fugitive"),
      (neg|check_quest_failed, "qst_hunt_down_fugitive"),
      (quest_slot_eq, "qst_hunt_down_fugitive", 11, 1),
      (assign, ":var0", 0),
      (try_begin),
        (call_script, "script_cf_troop_agent_is_alive", "trp_fugitive"),
      (else_try),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|main_hero_fallen),
      (eq, ":var0", 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_village_hunt_down_fugitive_defeated"),
        (call_script, "script_fail_quest", "qst_hunt_down_fugitive"),
        (finish_mission, 4),
      (else_try),
        (call_script, "script_change_player_relation_with_center", "$current_town", -2),
        (call_script, "script_succeed_quest", "qst_hunt_down_fugitive"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

    (ti_after_mission_start, 0, ti_once, 
    [
      (neq, "$g_mt_mode", 1),
    ],
    [
      (store_skill_level, ":var0", 1, "trp_player"),
      (troop_get_slot, ":var1", "trp_player", 7),
      (val_div, ":var0", 3),
      (val_div, ":var1", 400),
      (store_add, ":var2", ":var1", ":var0"),
      (val_min, ":var2", 4),
      (ge, ":var2", 1),
      (get_player_agent_no, ":var3"),
      (agent_get_team, ":var4", ":var3"),
      (agent_get_horse, ":var5", ":var3"),
      (assign, ":var6", 0),
      (assign, ":var7", 0),
      (try_begin),
        (party_slot_eq, "$current_town", 0, 4),
        (assign, ":var6", 11),
        (assign, ":var7", "mt_village_center"),
      (else_try),
        (this_or_next|eq, "$talk_context", 18),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 0),
        (assign, ":var6", 24),
        (try_begin),
          (party_slot_eq, "$current_town", 0, 2),
          (assign, ":var7", "mt_castle_visit"),
        (else_try),
          (assign, ":var7", "mt_town_center"),
        (try_end),
      (else_try),
        (eq, "$talk_context", 14),
        (assign, ":var6", 17),
      (try_end),
      (try_begin),
        (neq, "$talk_context", 14),
        (gt, ":var5", 0),
        (mission_tpl_entry_set_override_flags, ":var7", ":var6", 0),
      (try_end),
      (store_current_scene, ":var8"),
      (modify_visitors_at_site, ":var8"),
      (assign, ":var9", 0),
      (party_get_num_companion_stacks, ":var10", "p_main_party"),
      (try_for_range, ":var11", 0, ":var10"),
        (party_stack_get_troop_id, ":var12", "p_main_party", ":var11"),
        (neq, ":var12", "trp_player"),
        (troop_is_hero, ":var12"),
        (neg|troop_is_wounded, ":var12"),
        (val_add, ":var9", 1),
        (try_begin),
          (this_or_next|eq, "$talk_context", 19),
          (eq, "$talk_context", 18),
          (troop_set_slot, ":var12", 155, 1),
        (try_end),
        (add_visitors_to_current_scene, ":var6", ":var12", 1),
        (eq, ":var9", ":var2"),
        (assign, ":var10", 0),
      (try_end),
      (gt, ":var9", 0),
      (set_show_messages, 0),
      (team_give_order, ":var4", 8, 1),
      (set_show_messages, 1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (troop_is_hero, ":var1"),
      (main_party_has_troop, ":var1"),
      (get_player_agent_no, ":var2"),
      (agent_get_team, ":var3", ":var2"),
      (agent_get_position, pos1, ":var2"),
      (agent_set_team, ":var0", ":var3"),
      (agent_set_division, ":var0", 8),
      (agent_add_relation_with_agent, ":var0", ":var2", 1),
      (agent_set_is_alarmed, ":var0", 1),
      (store_random_in_range, ":var4", 1, 3),
      (val_mul, ":var4", 100),
      (position_move_y, pos1, ":var4"),
      (store_random_in_range, ":var4", 1, 3),
      (store_random_in_range, ":var5", 0, 2),
      (val_mul, ":var5", -1),
      (try_begin),
        (neq, ":var5", 0),
        (val_mul, ":var4", ":var5"),
      (try_end),
      (position_move_x, 1, ":var4"),
      (agent_set_position, ":var0", pos1),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (troop_is_hero, ":var1"),
      (main_party_has_troop, ":var1"),
      (party_wound_members, "p_main_party", ":var1", 1),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, ":var0", 1),
      (try_begin),
        (party_slot_eq, "$current_town", 7, "trp_player"),
        (assign, ":var0", 0),
      (try_end),
      (try_begin),
        (check_quest_active, "qst_bounty_1"),
        (quest_slot_eq, "qst_bounty_1", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_2"),
        (quest_slot_eq, "qst_bounty_2", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_3"),
        (quest_slot_eq, "qst_bounty_3", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_4"),
        (quest_slot_eq, "qst_bounty_4", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_5"),
        (quest_slot_eq, "qst_bounty_5", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_6"),
        (quest_slot_eq, "qst_bounty_6", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_hunt_down_fugitive"),
        (quest_slot_eq, "qst_hunt_down_fugitive", 1, "$current_town"),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (get_player_agent_no, ":var1"),
      (agent_set_team, ":var1", 0),
      (team_set_relation, 0, 1, 1),
      (team_set_relation, 0, 2, -1),
      (team_set_relation, 1, 2, 0),
      (try_for_agents, ":var2"),
        (neq, ":var2", ":var1"),
        (agent_set_team, ":var2", 1),
      (try_end),
      (assign, "$town_residents_enraged", 0),
      (assign, "$town_residents_condone_chance", 0),
      (assign, "$town_residents_condoned", 0),
      (assign, "$troop_restore_offset", 1),
    ]),

    (0, 0, 0, 
    [],
    [
      (assign, ":var0", 1),
      (try_begin),
        (party_slot_eq, "$current_town", 7, "trp_player"),
        (assign, ":var0", 0),
      (try_end),
      (try_begin),
        (check_quest_active, "qst_bounty_1"),
        (quest_slot_eq, "qst_bounty_1", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_2"),
        (quest_slot_eq, "qst_bounty_2", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_3"),
        (quest_slot_eq, "qst_bounty_3", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_4"),
        (quest_slot_eq, "qst_bounty_4", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_5"),
        (quest_slot_eq, "qst_bounty_5", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_6"),
        (quest_slot_eq, "qst_bounty_6", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_hunt_down_fugitive"),
        (quest_slot_eq, "qst_hunt_down_fugitive", 1, "$current_town"),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (get_player_agent_no, ":var1"),
      (agent_is_alive, ":var1"),
      (agent_get_position, pos1, ":var1"),
      (agent_get_attack_action, ":var2", ":var1"),
      (agent_get_defend_action, ":var3", ":var1"),
      (try_begin),
        (eq, ":var2", 2),
        (try_for_agents, ":var4"),
          (agent_is_human, ":var4"),
          (agent_is_alive, ":var4"),
          (neq, ":var4", ":var1"),
          (agent_get_position, pos2, ":var4"),
          (agent_get_team, ":var5", ":var4"),
          (eq, ":var5", 1),
          (try_begin),
            (position_is_behind_position, pos2, pos1),
          (else_try),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 100),
            (agent_force_rethink, ":var4"),
            (agent_ai_set_aggressiveness, ":var4", 199),
            (agent_set_team, ":var4", 2),
          (try_end),
        (try_end),
      (else_try),
        (eq, "$town_residents_enraged", 0),
        (this_or_next|eq, ":var3", 2),
        (eq, ":var3", 1),
        (try_begin),
          (ge, "$town_residents_condone_chance", 500),
          (val_sub, "$town_residents_condone_chance", 1),
          (val_add, "$town_residents_condoned", 1),
        (try_end),
        (lt, "$town_residents_condone_chance", 500),
        (try_for_agents, ":var4"),
          (agent_is_human, ":var4"),
          (agent_is_alive, ":var4"),
          (neq, ":var4", ":var1"),
          (agent_get_team, ":var5", ":var4"),
          (eq, ":var5", 2),
          (agent_add_relation_with_agent, ":var1", ":var4", 1),
          (agent_force_rethink, ":var4"),
          (agent_ai_set_aggressiveness, ":var4", 0),
          (agent_set_team, ":var4", 1),
        (try_end),
      (else_try),
        (eq, "$town_residents_enraged", 0),
        (this_or_next|gt, "$town_residents_condoned", 1500),
        (ge, "$town_residents_condone_chance", 2000),
        (try_for_agents, ":var4"),
          (agent_is_human, ":var4"),
          (agent_is_alive, ":var4"),
          (neq, ":var4", ":var1"),
          (agent_force_rethink, ":var4"),
          (agent_ai_set_aggressiveness, ":var4", 199),
          (agent_set_team, ":var4", 2),
        (try_end),
        (assign, "$town_residents_enraged", 1),
        (assign, "$town_residents_condoned", 0),
        (display_message, "str_saldiri_2"),
      (else_try),
        (eq, "$town_residents_enraged", 1),
        (agent_get_wielded_item, ":var7", ":var1", 0),
        (neq, ":var7", -1),
        (try_for_agents, ":var4"),
          (agent_is_human, ":var4"),
          (agent_is_alive, ":var4"),
          (neq, ":var4", ":var1"),
          (agent_get_troop_id, ":var8", ":var4"),
          (agent_get_wielded_item, ":var7", ":var4", 0),
          (try_begin),
            (neq, ":var7", -1),
            (agent_clear_scripted_mode, ":var4"),
          (try_end),
          (neg|is_between, ":var8", "trp_farmer", "trp_town_walker_1"),
          (agent_ai_set_aggressiveness, ":var4", 0),
          (agent_set_speed_limit, ":var4", 10),
          (party_get_slot, ":var9", "$current_town", 10),
          (party_get_slot, ":var10", "$current_town", 13),
          (store_current_scene, ":var11"),
          (try_begin),
            (eq, ":var11", ":var9"),
            (entry_point_get_position, pos3, 2),
          (else_try),
            (eq, ":var11", ":var10"),
            (entry_point_get_position, pos3, 0),
          (try_end),
          (agent_set_scripted_destination_no_attack, ":var4", pos3, 1),
          (agent_force_rethink, ":var4"),
          (agent_get_position, pos2, ":var4"),
          (get_distance_between_positions, ":var6", pos2, pos3),
          (try_begin),
            (gt, "$town_residents_condoned", 0),
            (agent_set_team, ":var4", 1),
          (try_end),
          (try_begin),
            (le, ":var6", 300),
            (agent_fade_out, ":var4"),
            (val_add, "$town_residents_condoned", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (assign, ":var0", 1),
      (try_begin),
        (party_slot_eq, "$current_town", 7, "trp_player"),
        (assign, ":var0", 0),
      (try_end),
      (try_begin),
        (check_quest_active, "qst_bounty_1"),
        (quest_slot_eq, "qst_bounty_1", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_2"),
        (quest_slot_eq, "qst_bounty_2", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_3"),
        (quest_slot_eq, "qst_bounty_3", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_4"),
        (quest_slot_eq, "qst_bounty_4", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_5"),
        (quest_slot_eq, "qst_bounty_5", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_6"),
        (quest_slot_eq, "qst_bounty_6", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_hunt_down_fugitive"),
        (quest_slot_eq, "qst_hunt_down_fugitive", 1, "$current_town"),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (store_trigger_param_2, ":var1"),
      (get_player_agent_no, ":var2"),
      (agent_is_alive, ":var2"),
      (eq, ":var1", ":var2"),
      (try_for_agents, ":var3"),
        (agent_is_human, ":var3"),
        (agent_is_alive, ":var3"),
        (neq, ":var3", ":var2"),
        (agent_force_rethink, ":var3"),
        (agent_ai_set_aggressiveness, ":var3", 199),
        (agent_set_team, ":var3", 2),
      (try_end),
      (assign, "$town_residents_enraged", 1),
      (party_get_slot, ":var4", "$current_town", 26),
      (val_sub, ":var4", 1),
      (party_set_slot, "$current_town", 26, ":var4"),
      (display_message, "str_saldiri_2"),
      (val_add, "$town_residents_condoned", 1),
      (party_get_slot, ":var5", "$current_town", 7),
      (call_script, "script_change_player_relation_with_troop", ":var5", -1),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [],
    [
      (assign, ":var0", 1),
      (try_begin),
        (party_slot_eq, "$current_town", 7, "trp_player"),
        (assign, ":var0", 0),
      (try_end),
      (try_begin),
        (check_quest_active, "qst_bounty_1"),
        (quest_slot_eq, "qst_bounty_1", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_2"),
        (quest_slot_eq, "qst_bounty_2", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_3"),
        (quest_slot_eq, "qst_bounty_3", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_4"),
        (quest_slot_eq, "qst_bounty_4", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_5"),
        (quest_slot_eq, "qst_bounty_5", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_6"),
        (quest_slot_eq, "qst_bounty_6", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_hunt_down_fugitive"),
        (quest_slot_eq, "qst_hunt_down_fugitive", 1, "$current_town"),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (store_trigger_param_1, ":var1"),
      (store_trigger_param_2, ":var2"),
      (get_player_agent_no, ":var3"),
      (agent_is_alive, ":var3"),
      (eq, ":var2", ":var3"),
      (agent_force_rethink, ":var1"),
      (agent_ai_set_aggressiveness, ":var1", 199),
      (agent_set_team, ":var1", 2),
      (val_add, "$town_residents_condone_chance", 1000),
      (eq, "$town_residents_enraged", 0),
    ]),

    (2, 0, 3, 
    [],
    [
      (assign, ":var0", 1),
      (try_begin),
        (party_slot_eq, "$current_town", 7, "trp_player"),
        (assign, ":var0", 0),
      (try_end),
      (try_begin),
        (check_quest_active, "qst_bounty_1"),
        (quest_slot_eq, "qst_bounty_1", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_2"),
        (quest_slot_eq, "qst_bounty_2", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_3"),
        (quest_slot_eq, "qst_bounty_3", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_4"),
        (quest_slot_eq, "qst_bounty_4", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_5"),
        (quest_slot_eq, "qst_bounty_5", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_6"),
        (quest_slot_eq, "qst_bounty_6", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_hunt_down_fugitive"),
        (quest_slot_eq, "qst_hunt_down_fugitive", 1, "$current_town"),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (get_player_agent_no, ":var1"),
      (agent_is_alive, ":var1"),
      (party_get_slot, ":var2", "$current_town", 10),
      (party_get_slot, ":var3", "$current_town", 13),
      (store_current_scene, ":var4"),
      (try_begin),
        (eq, ":var4", ":var2"),
        (entry_point_get_position, pos3, 2),
      (else_try),
        (eq, ":var4", ":var3"),
        (entry_point_get_position, pos3, 0),
      (try_end),
      (try_begin),
        (gt, "$town_residents_condoned", 2),
        (call_script, "script_return_random_troop_from_garrison", 1),
        (assign, ":var5", reg0),
        (gt, ":var5", 0),
        (call_script, "script_remove_troops_from_garrison", ":var5", 1),
        (set_spawn_position, pos3),
        (spawn_agent, ":var5"),
        (agent_set_team, reg0, 2),
        (agent_add_relation_with_agent, ":var1", reg0, -1),
        (agent_ai_set_aggressiveness, reg0, 199),
        (agent_get_position, pos3, ":var1"),
        (agent_set_scripted_destination, reg0, pos3, 1),
        (agent_force_rethink, reg0),
        (val_sub, "$town_residents_condoned", 1),
        (display_message, "str_saldiri_3"),
      (try_end),
    ]),

  ]),

  ("home_visit", mtf_arena_fight, -1,
  "Nice house, mate!",
  [
    (0, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
    (1, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (2, 0, 0, 
    [
      (call_script, "script_center_ambiance_sounds"),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("manor_center", 0, -1,
  "manor center",
  [
    (0, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
    (1, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (8, mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_visitor_source, 0, 0, 1, []),
    (14, mtef_visitor_source, 0, 0, 1, []),
    (15, mtef_visitor_source, 0, 0, 1, []),
    (16, mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_visitor_source, af_override_horse, 0, 1, []),
    (34, mtef_visitor_source, af_override_horse, 0, 1, []),
    (35, mtef_visitor_source, af_override_horse, 0, 1, []),
    (36, mtef_visitor_source, af_override_horse, 0, 1, []),
    (37, mtef_visitor_source, af_override_horse, 0, 1, []),
    (38, mtef_visitor_source, af_override_horse, 0, 1, []),
    (39, mtef_visitor_source, af_override_horse, 0, 1, []),
    (40, mtef_visitor_source, af_override_horse, 0, 1, []),
    (41, mtef_visitor_source, af_override_horse, 0, 1, []),
    (42, mtef_visitor_source, af_override_horse, 0, 1, []),
    (43, mtef_visitor_source, af_override_horse, 0, 1, []),
    (44, mtef_visitor_source, af_override_horse, 0, 1, []),
    (45, mtef_visitor_source, af_override_horse, 0, 1, []),
    (46, mtef_visitor_source, af_override_horse, 0, 1, []),
    (47, mtef_visitor_source, af_override_horse, 0, 1, []),
    (48, mtef_visitor_source, af_override_horse, 0, 1, []),
    (49, mtef_visitor_source, af_override_horse, 0, 1, []),
    (50, mtef_visitor_source, af_override_horse, 0, 1, []),
    (51, mtef_visitor_source, af_override_horse, 0, 1, []),
    (52, mtef_visitor_source, af_override_horse, 0, 1, []),
    (53, mtef_visitor_source, af_override_horse, 0, 1, []),
    (54, mtef_visitor_source, af_override_horse, 0, 1, []),
    (55, mtef_visitor_source, af_override_horse, 0, 1, []),
    (56, mtef_visitor_source, af_override_horse, 0, 1, []),
    (57, mtef_visitor_source, af_override_horse, 0, 1, []),
    (58, mtef_visitor_source, af_override_horse, 0, 1, []),
    (59, mtef_visitor_source, af_override_horse, 0, 1, []),
    (60, mtef_visitor_source, af_override_horse, 0, 1, []),
    (61, mtef_visitor_source, af_override_horse, 0, 1, []),
    (62, mtef_visitor_source, af_override_horse, 0, 1, []),
    (63, mtef_visitor_source, af_override_horse, 0, 1, []),
    (64, mtef_visitor_source, af_override_horse, 0, 1, []),
    (65, mtef_visitor_source, af_override_horse, 0, 1, []),
    (66, mtef_visitor_source, af_override_horse, 0, 1, []),
    (67, mtef_visitor_source, af_override_horse, 0, 1, []),
    (68, mtef_visitor_source, af_override_horse, 0, 1, []),
    (69, mtef_visitor_source, af_override_horse, 0, 1, []),
    (70, mtef_visitor_source, af_override_horse, 0, 1, []),
    (71, mtef_visitor_source, af_override_horse, 0, 1, []),
    (72, mtef_visitor_source, af_override_horse, 0, 1, []),
    (73, mtef_visitor_source, af_override_horse, 0, 1, []),
    (74, mtef_visitor_source, af_override_horse, 0, 1, []),
    (75, mtef_visitor_source, af_override_horse, 0, 1, []),
    (76, mtef_visitor_source, af_override_horse, 0, 1, []),
    (77, mtef_visitor_source, af_override_horse, 0, 1, []),
    (78, mtef_visitor_source, af_override_horse, 0, 1, []),
    (79, mtef_visitor_source, af_override_horse, 0, 1, []),
    (80, mtef_visitor_source, af_override_horse, 0, 1, []),
    (81, mtef_visitor_source, af_override_horse, 0, 1, []),
    (82, mtef_visitor_source, af_override_horse, 0, 1, []),
    (83, mtef_visitor_source, af_override_horse, 0, 1, []),
    (84, mtef_visitor_source, af_override_horse, 0, 1, []),
    (85, mtef_visitor_source, af_override_horse, 0, 1, []),
    (86, mtef_visitor_source, af_override_horse, 0, 1, []),
    (87, mtef_visitor_source, af_override_horse, 0, 1, []),
    (88, mtef_visitor_source, af_override_horse, 0, 1, []),
    (89, mtef_visitor_source, af_override_horse, 0, 1, []),
    (90, mtef_visitor_source, af_override_horse, 0, 1, []),
    (91, mtef_visitor_source, af_override_horse, 0, 1, []),
    (92, mtef_visitor_source, af_override_horse, 0, 1, []),
    (93, mtef_visitor_source, af_override_horse, 0, 1, []),
    (94, mtef_visitor_source, af_override_horse, 0, 1, []),
    (95, mtef_visitor_source, af_override_horse, 0, 1, []),
    (96, mtef_visitor_source, af_override_horse, 0, 1, []),
    (97, mtef_visitor_source, af_override_horse, 0, 1, []),
    (98, mtef_visitor_source, af_override_horse, 0, 1, []),
    (99, mtef_visitor_source, af_override_horse, 0, 1, []),
  ],
  [
    (ti_before_mission_start, 0, ti_once, 
    [],
    [
      (call_script, "script_remove_manor_objects"),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (store_current_scene, ":var0"),
      (scene_set_slot, ":var0", 0, 1),
      (call_script, "script_init_manor_walker_agents"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (3, 0, 0, 
    [
      (call_script, "script_tick_manor_walkers"),
    ],
    []),

    (2, 0, 0, 
    [
      (call_script, "script_center_ambiance_sounds"),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("manor_attack_bandits", mtf_battle_mode, charge,
  "You lead your men to battle.",
  [
    (3, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 4, []),
    (1, mtef_team_0|mtef_use_exact_number, 0, aif_start_alarmed, 28, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 4, []),
  ],
  [
    (ti_before_mission_start, 0, ti_once, 
    [],
    [
      (call_script, "script_remove_manor_objects"),
    ]),

    (ti_on_agent_hit, 0.3, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (assign, ":var3", reg0),
      (agent_is_human, ":var0"),
      (get_player_agent_no, ":var4"),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var0", ":var4"),
        (store_random_in_range, ":var5", 0, 1000),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 4, 8),
        (troop_get_inventory_slot, ":var7", "trp_player", ":var6"),
        (gt, ":var7", 0),
        (str_store_item_name, s20, ":var7"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var6"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} is too crapy to fall apart!", 0xFF0000),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var7", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var6", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var1", ":var4"),
        (is_between, ":var3", 1, "itm_items_end"),
        (neg|is_between, ":var3", "itm_light_lance", "itm_wooden_shield"),
        (item_get_type, ":var9", ":var3"),
        (ge, ":var2", 10),
        (neq, ":var9", 10),
        (neq, ":var9", 8),
        (neq, ":var9", 9),
        (neq, ":var9", 5),
        (neq, ":var9", 6),
        (store_random_in_range, ":var5", 0, 600),
        (eq, ":var5", 1),
        (assign, ":var10", -1),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var11", "trp_player", ":var6"),
          (eq, ":var11", ":var3"),
          (assign, ":var10", ":var6"),
        (try_end),
        (gt, ":var10", 0),
        (str_store_item_name, s20, ":var3"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var10"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} falls apart!", 0xFF0000),
          (agent_unequip_item, ":var4", ":var3"),
          (troop_remove_item, "trp_player", ":var3"),
          (troop_remove_item, "trp_broken_items", ":var3"),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var3", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var10", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (agent_get_horse, ":var12", ":var1"),
      (try_begin),
        (eq, "$tom_lance_breaking", 1),
        (gt, ":var12", 0),
        (this_or_next|is_between, ":var3", "itm_light_lance", "itm_bamboo_spear"),
        (is_between, ":var3", "itm_crusader_knight_spear_a", "itm_crusader_spear_a"),
        (ge, ":var2", 50),
        (store_random_in_range, ":var13", 0, 100),
        (gt, ":var13", 20),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your lance!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (this_or_next|is_between, ":var3", "itm_bamboo_spear", "itm_staff"),
        (is_between, ":var3", "itm_crusader_spear_a", "itm_mace_6"),
        (le, ":var12", 0),
        (ge, ":var2", 8),
        (store_random_in_range, ":var13", 0, 100),
        (ge, ":var13", 90),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your spear!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 10, 20, 1),
      (assign, "$g_battle_result", -1),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (try_begin),
        (eq, "$g_mt_mode", 2),
        (add_reinforcements_to_entry, 1, 6),
      (else_try),
        (add_reinforcements_to_entry, 1, 40),
      (try_end),
      (call_script, "script_combat_music_set_situation_with_culture", 1024),
      (assign, "$dmod_current_agent", -1),
      (assign, "$dmod_move_camera", -1),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture", 1024),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (5, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (try_begin),
        (eq, "$auxilary_player_active", 0),
        (call_script, "script_freelancer_keep_field_loot"),
      (try_end),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (assign, "$do_once_3", 0),
      (finish_mission, 1),
    ]),

    (5, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (val_add, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
      (set_mission_result, -1),
      (display_message, "@Battle lost..."),
      (assign, "$g_battle_won", -1),
      (assign, "$g_battle_result", -1),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (assign, "$do_once_3", 0),
      (finish_mission, 0),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", -1),
      (display_message, "@Battle lost! Press tab key to leave..."),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (gt, "$dmod_current_agent", 0),
      (eq, "$setting_use_dmod", 1),
      (eq, "$dmod_move_camera", 1),
      (agent_get_position, pos1, "$dmod_current_agent"),
      (position_move_z, pos1, 300),
      (position_move_y, pos1, -300),
      (agent_get_horse, ":var0", "$dmod_current_agent"),
      (try_begin),
        (ge, ":var0", 0),
      (try_end),
      (mission_cam_set_position, pos1),
      (mission_cam_set_mode, 1),
      (set_fixed_point_multiplier, 100),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_up),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_forwards"),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_down),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_backwards"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 4, ti_once, 
    [
      (eq, "$enable_deahtcam", 1),
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
      (assign, "$tom_sand_storm", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (this_or_next|eq, "$dmod_move_camera", 1),
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, gk_move_forward),
      (this_or_next|game_key_is_down, gk_move_backward),
      (this_or_next|game_key_is_down, gk_move_left),
      (this_or_next|game_key_is_down, gk_move_right),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_backward),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_left),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (position_rotate_x_floating, pos47, ":var7"),
        (position_rotate_y, pos47, 90),
        (position_rotate_x_floating, pos47, ":var3"),
        (position_rotate_y, pos47, -90),
        (position_rotate_x_floating, pos47, "$deathcam_total_rotx"),
        (position_rotate_x_floating, pos47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|eq, ":var0", 0),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "str_enhanced_battle_knocked_out_message_1"),
      (display_message, "str_enhanced_battle_knocked_out_message_2"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (is_presentation_active, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (team_give_order, ":var1", 9, 0),
      (set_show_messages, 1),
    ]),

    (0, 0, ti_once, 
    [
      (eq, 0, 1),
      (eq, "$enable_deahtcam", 1),
      (main_hero_fallen),
    ],
    [
      (assign, "$fclock", 1),
      (call_script, "script_player_order_formations", 2),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (team_give_order, ":var1", 9, 2),
    ]),

    (2, 0, 0, 
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_non_player, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (store_skill_level, ":var2", "skl_horse_archery", ":var1"),
        (ge, ":var2", 4),
      (try_end),
    ],
    [
      (set_fixed_point_multiplier, 1000),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_non_player, ":var0"),
        (neg|agent_slot_eq, ":var0", 1003, 1),
        (agent_get_horse, ":var1", ":var0"),
        (assign, ":var2", -1),
        (try_begin),
          (agent_slot_eq, ":var0", 15, 0),
          (gt, ":var1", -1),
          (agent_get_team, ":var3", ":var0"),
          (agent_get_division, ":var4", ":var0"),
          (team_get_weapon_usage_order, ":var5", ":var3", ":var4"),
          (team_get_movement_order, ":var6", ":var3", ":var4"),
          (team_get_hold_fire_order, ":var7", ":var3", ":var4"),
          (assign, ":var8", 0),
          (assign, ":var9", -1),
          (try_for_range, ":var10", 0, 4),
            (agent_get_item_slot, ":var11", ":var0", ":var10"),
            (gt, ":var11", 0),
            (item_get_type, ":var12", ":var11"),
            (try_begin),
              (eq, ":var12", 10),
              (agent_get_ammo_for_slot, ":var13", ":var0", ":var10"),
              (val_add, ":var8", ":var13"),
            (else_try),
              (this_or_next|eq, ":var12", 8),
              (this_or_next|eq, ":var12", 16),
              (eq, ":var12", 17),
              (assign, ":var9", ":var11"),
            (else_try),
              (this_or_next|eq, ":var12", 2),
              (this_or_next|eq, ":var12", 3),
              (eq, ":var12", 4),
              (assign, ":var2", ":var11"),
            (try_end),
          (try_end),
          (gt, ":var9", -1),
          (neg|item_has_property, ":var9", itp_cant_reload_on_horseback),
          (neg|item_has_property, ":var9", itp_cant_use_on_horseback),
          (agent_get_ammo, ":var14", ":var0", 0),
          (val_sub, ":var14", ":var8"),
          (gt, ":var14", 0),
          (agent_set_slot, ":var0", 1003, 2),
          (neq, ":var7", 1),
          (neq, ":var5", 2),
          (eq, ":var6", 2),
          (agent_get_position, pos50, ":var0"),
          (agent_get_speed, pos31, ":var0"),
          (position_get_y, ":var15", pos31),
          (assign, ":var16", 100000),
          (assign, ":var17", -1),
          (try_for_agents, ":var18"),
            (agent_is_alive, ":var18"),
            (agent_is_human, ":var18"),
            (agent_get_position, pos36, ":var18"),
            (agent_get_team, ":var19", ":var18"),
            (teams_are_enemies, ":var3", ":var19"),
            (get_distance_between_positions, ":var20", pos50, pos36),
            (try_begin),
              (agent_slot_eq, ":var18", 15, 1),
              (val_add, ":var20", 10000),
            (try_end),
            (try_begin),
              (agent_get_horse, ":var21", ":var18"),
              (gt, ":var21", -1),
              (agent_get_speed, pos32, ":var18"),
              (position_get_y, ":var22", pos32),
              (val_sub, ":var22", ":var15"),
              (store_div, ":var23", ":var22", 5),
              (val_max, ":var23", 0),
              (val_add, ":var23", 500),
              (val_sub, ":var20", ":var23"),
            (else_try),
              (agent_get_wielded_item, ":var24", ":var18", 1),
              (le, ":var24", 1),
              (val_sub, ":var20", 500),
            (try_end),
            (lt, ":var20", ":var16"),
            (assign, ":var16", ":var20"),
            (assign, ":var17", ":var18"),
          (try_end),
          (neq, ":var17", -1),
          (agent_get_position, pos51, ":var17"),
          (get_distance_between_positions, ":var25", pos50, pos51),
          (try_begin),
            (agent_slot_eq, ":var17", 15, 0),
            (gt, ":var25", 200),
            (agent_set_wielded_item, ":var0", ":var9"),
          (else_try),
            (le, ":var25", 200),
            (gt, ":var2", -1),
            (agent_set_wielded_item, ":var0", ":var2"),
          (try_end),
          (assign, ":var26", 1000),
          (try_begin),
            (agent_get_wielded_item, ":var24", ":var0", 0),
            (gt, ":var24", 0),
            (item_get_type, ":var27", ":var24"),
            (this_or_next|eq, ":var27", 8),
            (this_or_next|eq, ":var27", 16),
            (eq, ":var27", 17),
            (agent_get_bone_position, pos53, ":var0", 8, 1),
            (agent_get_bone_position, pos54, ":var17", 9, 1),
            (position_has_line_of_sight_to_position, pos53, pos54),
            (agent_set_look_target_agent, ":var0", ":var17"),
            (try_begin),
              (assign, ":var28", 4000),
              (agent_get_attack_action, ":var29", ":var0"),
              (eq, ":var29", 1),
              (try_begin),
                (gt, ":var16", 700),
                (le, ":var16", ":var28"),
                (store_div, ":var26", ":var15", 2000),
                (val_max, ":var26", 0),
              (try_end),
              (eq, ":var27", 8),
              (try_begin),
                (le, ":var25", ":var28"),
                (agent_set_defend_action, ":var0", -2, 1),
                (agent_set_attack_action, ":var0", 3, 0),
              (else_try),
                (gt, ":var25", ":var28"),
                (agent_set_attack_action, ":var0", -2, 1),
                (agent_set_defend_action, ":var0", 3, 1),
              (try_end),
            (else_try),
              (eq, ":var27", 8),
              (le, ":var25", ":var28"),
              (agent_get_combat_state, ":var30", ":var0"),
              (neq, ":var30", 8),
              (agent_set_attack_action, ":var0", 3, 1),
            (try_end),
          (try_end),
          (agent_set_speed_limit, ":var0", ":var26"),
          (try_begin),
            (agent_slot_eq, ":var17", 15, 0),
            (lt, ":var16", 10000),
            (try_begin),
              (get_scene_boundaries, pos2, pos3),
              (position_transform_position_to_local, pos4, pos2, pos50),
              (position_get_x, ":var31", pos4),
              (position_get_y, ":var32", pos4),
              (position_transform_position_to_local, pos4, pos2, pos3),
              (position_get_x, ":var33", pos4),
              (position_get_y, ":var34", pos4),
              (store_sub, ":var35", ":var33", ":var31"),
              (store_sub, ":var36", ":var34", ":var32"),
              (position_transform_position_to_local, pos4, pos50, pos51),
              (position_get_x, ":var37", pos4),
              (position_get_y, ":var38", pos4),
              (assign, ":var39", 0),
              (try_begin),
                (le, ":var16", 1000),
                (assign, ":var39", -78000),
              (else_try),
                (gt, ":var16", 2000),
                (store_sub, ":var39", ":var16", 0),
                (val_mul, ":var39", 5),
                (val_clamp, ":var39", 35000, 90000),
              (try_end),
              (assign, ":var40", 30000),
              (val_min, ":var40", ":var31"),
              (val_min, ":var40", ":var36"),
              (val_min, ":var40", ":var35"),
              (val_min, ":var40", ":var32"),
              (try_begin),
                (lt, ":var40", 30000),
                (agent_slot_eq, ":var17", 15, 0),
                (store_div, ":var41", ":var33", 20),
                (store_div, ":var42", ":var34", 20),
                (position_copy_origin, pos4, pos2),
                (position_move_x, 4, ":var41", 1),
                (position_move_y, pos4, ":var42", 1),
                (get_distance_between_positions, ":var43", pos4, pos50),
                (position_transform_position_to_local, pos4, pos50, pos4),
                (position_get_x, ":var41", pos4),
                (position_get_y, ":var42", pos4),
                (val_mul, ":var41", 100),
                (val_mul, ":var42", 100),
                (val_mul, ":var37", 100),
                (val_mul, ":var38", 100),
                (store_div, ":var44", ":var41", ":var43"),
                (store_div, ":var45", ":var42", ":var43"),
                (store_div, ":var46", ":var37", ":var25"),
                (store_div, ":var47", ":var38", ":var25"),
                (store_acos, ":var48", ":var44"),
                (store_asin, ":var49", ":var45"),
                (store_acos, ":var50", ":var46"),
                (store_asin, ":var51", ":var47"),
                (try_begin),
                  (lt, ":var49", 0),
                  (val_mul, ":var48", -1),
                  (val_add, ":var48", 360000),
                (try_end),
                (try_begin),
                  (lt, ":var51", 0),
                  (val_mul, ":var50", -1),
                  (val_add, ":var50", 360000),
                (try_end),
                (store_sub, ":var52", ":var48", ":var50"),
                (val_sub, ":var52", 270000),
                (val_sub, ":var52", ":var39"),
                (store_add, ":var39", ":var52", ":var39"),
                (try_begin),
                  (lt, ":var48", ":var50"),
                  (val_add, ":var39", 360000),
                (try_end),
                (val_clamp, ":var39", -210000, 15000),
                (agent_set_attack_action, ":var0", -2, 1),
                (agent_set_defend_action, ":var0", 3, 1),
              (try_end),
              (store_cos, ":var53", ":var39"),
              (store_sin, ":var54", ":var39"),
              (store_mul, ":var55", ":var53", ":var38"),
              (store_mul, ":var56", ":var54", ":var37"),
              (store_mul, ":var57", ":var54", ":var38"),
              (store_mul, ":var58", ":var53", ":var37"),
              (store_add, ":var59", ":var55", ":var56"),
              (store_sub, ":var60", ":var57", ":var58"),
              (position_move_x, 50, ":var59", 0),
              (position_move_y, pos50, ":var60", 0),
            (try_end),
            (agent_set_scripted_destination, ":var0", pos50, 1),
          (else_try),
            (agent_clear_scripted_mode, ":var0"),
            (agent_force_rethink, ":var0"),
          (try_end),
        (else_try),
          (try_begin),
            (agent_slot_eq, ":var0", 1003, 0),
            (agent_set_slot, ":var0", 1003, 1),
          (else_try),
            (agent_slot_eq, ":var0", 1003, 2),
            (this_or_next|agent_slot_eq, ":var0", 15, 1),
            (this_or_next|lt, ":var1", 0),
            (this_or_next|eq, ":var14", 0),
            (this_or_next|eq, ":var7", 1),
            (this_or_next|eq, ":var5", 2),
            (neq, ":var6", 2),
            (agent_clear_scripted_mode, ":var0"),
            (agent_set_speed_limit, ":var0", 100),
            (agent_force_rethink, ":var0"),
            (agent_set_slot, ":var0", 1003, 3),
            (this_or_next|eq, ":var7", 1),
            (eq, ":var14", 0),
            (gt, ":var2", -1),
            (agent_set_wielded_item, ":var0", ":var2"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [
      (neg|is_presentation_active, "prsnt_killcount"),
      (neg|is_presentation_active, "prsnt_troop_ratio_bar"),
      (neg|is_presentation_active, "prsnt_killcount_and_troop_ratio_bar"),
    ],
    [
      (try_begin),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 1),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 2),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 3),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
      (call_script, "script_party_count_fit_for_battle", "p_main_party"),
      (assign, "$player_count_alive", reg0),
      (call_script, "script_party_count_fit_for_battle", "p_collective_friends"),
      (store_sub, "$ally_count_alive", reg0, "$player_count_alive"),
      (call_script, "script_party_count_fit_for_battle", "p_collective_enemy"),
      (assign, "$enemy_count_alive", reg0),
    ]),

    (3, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 1),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 2),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 3),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
    ]),

    (0.2, 0, ti_once, 
    [],
    [
      (assign, "$spear_in_position", 0),
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 26, 0),
        (agent_set_slot, ":var0", 27, 0),
        (agent_set_slot, ":var0", 28, 0),
        (agent_set_slot, ":var0", 29, 0),
        (agent_set_slot, ":var0", 30, 0),
      (try_end),
    ]),

    (0.5, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 27),
        (agent_get_slot, ":var2", ":var0", 28),
        (agent_get_slot, ":var3", ":var0", 29),
        (agent_get_position, pos1, ":var0"),
        (position_get_x, ":var4", pos1),
        (position_get_y, ":var5", pos1),
        (position_get_z, ":var6", pos1),
        (position_set_x, pos2, ":var1"),
        (position_set_y, pos2, ":var2"),
        (position_set_z, pos2, ":var3"),
        (position_set_x, pos1, ":var4"),
        (position_set_y, pos1, ":var5"),
        (position_set_z, pos1, ":var6"),
        (agent_get_speed, pos5, ":var0"),
        (call_script, "script_vector_length", 5),
        (assign, ":var7", reg0),
        (agent_set_slot, ":var0", 27, ":var4"),
        (agent_set_slot, ":var0", 28, ":var5"),
        (agent_set_slot, ":var0", 29, ":var6"),
        (agent_set_slot, ":var0", 30, ":var7"),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
      (this_or_next|game_key_clicked, gk_attack),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_move_forward),
      (this_or_next|game_key_clicked, gk_move_backward),
      (this_or_next|game_key_clicked, gk_move_left),
      (this_or_next|game_key_clicked, gk_move_right),
      (this_or_next|game_key_clicked, gk_equip_primary_weapon),
      (this_or_next|game_key_clicked, gk_equip_secondary_weapon),
      (this_or_next|game_key_clicked, gk_action),
      (game_key_clicked, gk_sheath_weapon),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (display_message, "@Releasing spear.", 0x6495ED),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
    ]),

    (0.2, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_get_horse, ":var1", ":var0"),
        (le, ":var1", 0),
        (agent_get_slot, ":var2", ":var0", 26),
        (lt, ":var2", 10),
        (val_add, ":var2", 2),
        (agent_set_slot, ":var0", 26, ":var2"),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_set_animation, ":var0", "anim_spearwall_hold"),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (try_for_agents, ":var2"),
        (agent_is_alive, ":var2"),
        (neq, ":var2", ":var0"),
        (agent_is_human, ":var2"),
        (agent_get_horse, ":var3", ":var2"),
        (le, ":var3", 0),
        (agent_get_slot, ":var4", ":var2", 26),
        (ge, ":var4", 10),
        (agent_get_simple_behavior, ":var5", ":var2"),
        (agent_get_team, ":var6", ":var2"),
        (agent_get_class, ":var7", ":var2"),
        (team_get_movement_order, ":var8", ":var6", ":var7"),
        (assign, ":var9", 0),
        (try_begin),
          (neq, ":var6", ":var1"),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (else_try),
          (this_or_next|eq, ":var8", 0),
          (eq, ":var8", 11),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (this_or_next|eq, ":var5", 4),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (try_end),
        (eq, ":var9", 1),
        (agent_get_troop_id, ":var10", ":var2"),
        (store_proficiency_level, ":var11", ":var10", ca_intelligence),
        (store_character_level, ":var12", ":var10"),
        (ge, ":var12", 12),
        (ge, ":var11", 120),
        (neg|troop_is_mounted, ":var10"),
        (agent_slot_eq, ":var2", 15, 0),
        (assign, ":var9", 0),
        (agent_get_wielded_item, ":var13", ":var2", 0),
        (agent_get_wielded_item, ":var14", ":var2", 1),
        (assign, ":var15", 145),
        (try_begin),
          (this_or_next|is_between, ":var13", "itm_modded_billhook_fork_1", "itm_maul"),
          (is_between, ":var14", "itm_modded_billhook_fork_1", "itm_maul"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_1"),
            (eq, ":var14", "itm_modded_billhook_fork_1"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_2"),
            (eq, ":var14", "itm_modded_billhook_fork_2"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_1"),
            (eq, ":var14", "itm_modded_fauchard_1"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_2"),
            (eq, ":var14", "itm_modded_fauchard_2"),
            (assign, "$spear_dist", 171),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_3"),
            (eq, ":var14", "itm_modded_fauchard_3"),
            (assign, "$spear_dist", 197),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_4"),
            (eq, ":var14", "itm_modded_fauchard_4"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_1"),
            (eq, ":var14", "itm_modded_glaive_1"),
            (assign, "$spear_dist", 169),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_1"),
            (eq, ":var14", "itm_modded_glaive_fork_1"),
            (assign, "$spear_dist", 230),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_2"),
            (eq, ":var14", "itm_modded_glaive_fork_2"),
            (assign, "$spear_dist", 188),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_roundel"),
            (eq, ":var14", "itm_modded_glaive_roundel"),
            (assign, "$spear_dist", 149),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_1"),
            (eq, ":var14", "itm_modded_bill_1"),
            (assign, "$spear_dist", 215),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_2"),
            (eq, ":var14", "itm_modded_bill_2"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_1"),
            (eq, ":var14", "itm_modded_billhook_1"),
            (assign, "$spear_dist", 207),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_2"),
            (eq, ":var14", "itm_modded_billhook_2"),
            (assign, "$spear_dist", 172),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_3"),
            (eq, ":var14", "itm_modded_billhook_3"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_voulge"),
            (eq, ":var14", "itm_modded_voulge"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_spiked_voulge"),
            (eq, ":var14", "itm_modded_spiked_voulge"),
            (assign, "$spear_dist", 182),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_cleaving_voulge"),
            (eq, ":var14", "itm_modded_cleaving_voulge"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_1"),
            (eq, ":var14", "itm_modded_hooked_voulge_1"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_2"),
            (eq, ":var14", "itm_modded_hooked_voulge_2"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_3"),
            (eq, ":var14", "itm_modded_hooked_voulge_3"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_1"),
            (eq, ":var14", "itm_modded_couteau_1"),
            (assign, "$spear_dist", 177),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_2"),
            (eq, ":var14", "itm_modded_couteau_2"),
            (assign, "$spear_dist", 196),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_guisarme"),
            (eq, ":var14", "itm_modded_guisarme"),
            (assign, "$spear_dist", 232),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_assegai"),
            (eq, ":var14", "itm_modded_assegai"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_pike"),
            (eq, ":var14", "itm_modded_pike"),
            (assign, "$spear_dist", 300),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_war_spear"),
            (eq, ":var14", "itm_modded_war_spear"),
            (assign, "$spear_dist", 211),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_glaive"),
          (is_between, ":var14", "itm_glaive"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_glaive"),
            (eq, ":var14", "itm_glaive"),
            (assign, "$spear_dist", 160),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_bill"),
          (is_between, ":var14", "itm_bill"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_bill"),
            (eq, ":var14", "itm_bill"),
            (assign, "$spear_dist", 128),
          (try_end),
        (try_end),
        (eq, ":var9", 1),
        (assign, ":var16", -1),
        (agent_get_position, pos1, ":var2"),
        (try_for_agents, ":var17"),
          (agent_is_alive, ":var17"),
          (neg|agent_is_human, ":var17"),
          (agent_get_rider, ":var18", ":var17"),
          (ge, ":var18", 0),
          (agent_get_team, ":var19", ":var18"),
          (teams_are_enemies, ":var6", ":var19"),
          (agent_get_position, pos2, ":var17"),
          (get_distance_between_positions, ":var20", pos1, pos2),
          (lt, ":var20", ":var15"),
          (neg|position_is_behind_position, pos2, pos1),
          (agent_get_slot, ":var21", ":var17", 30),
          (gt, ":var21", 0),
          (assign, ":var16", ":var17"),
        (try_end),
        (gt, ":var16", -1),
        (agent_play_sound, ":var16", "snd_metal_hit_high_armor_high_damage"),
        (store_agent_hit_points, ":var22", ":var16", 0),
        (store_agent_hit_points, ":var23", ":var16", 1),
        (assign, reg22, ":var21"),
        (val_mul, ":var21", 10),
        (val_sub, ":var22", ":var21"),
        (val_max, ":var22", 0),
        (agent_set_slot, ":var2", 26, 0),
        (agent_get_horse, ":var24", ":var0"),
        (agent_get_position, pos2, ":var16"),
        (agent_set_look_target_position, ":var2", pos2),
        (agent_set_attack_action, ":var2", 0, 0),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_get_troop_id, ":var10", ":var2"),
        (str_store_troop_name, s21, ":var10"),
        (agent_get_troop_id, ":var25", ":var16"),
        (str_store_troop_name, s20, ":var25"),
        (store_agent_hit_points, ":var22", ":var16", 1),
        (val_sub, ":var23", ":var22"),
        (assign, reg1, ":var23"),
        (try_begin),
          (eq, ":var16", ":var24"),
          (display_message, "@Your horse received {reg1} damage from a braced polearm!", 0xFF4040),
        (try_end),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (store_agent_hit_points, ":var1", ":var0", 1),
      (lt, ":var1", "$spear_hp"),
      (display_message, "@The injury causes your grip on the polearm to slip!", 0xFF4040),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 26),
      (ge, ":var1", 10),
      (assign, ":var2", -1),
      (agent_get_position, pos1, ":var0"),
      (try_for_agents, ":var3"),
        (agent_is_alive, ":var3"),
        (neg|agent_is_human, ":var3"),
        (agent_get_rider, ":var4", ":var3"),
        (ge, ":var4", 0),
        (neg|agent_is_ally, ":var4"),
        (agent_get_position, pos2, ":var3"),
        (get_distance_between_positions, ":var5", pos1, pos2),
        (lt, ":var5", "$spear_dist"),
        (neg|position_is_behind_position, pos2, pos1),
        (agent_get_slot, ":var6", ":var3", 30),
        (ge, ":var6", 120),
        (assign, ":var2", ":var3"),
      (try_end),
      (gt, ":var2", -1),
      (agent_play_sound, ":var2", "snd_metal_hit_high_armor_high_damage"),
      (store_agent_hit_points, ":var7", ":var2", 0),
      (store_agent_hit_points, ":var8", ":var2", 1),
      (val_div, ":var6", 2),
      (val_sub, ":var6", 15),
      (val_sub, ":var7", ":var6"),
      (val_max, ":var7", 0),
      (agent_set_hit_points, ":var2", ":var7", 0),
      (agent_deliver_damage_to_agent, ":var2", ":var2"),
      (agent_set_slot, ":var0", 26, 0),
      (store_agent_hit_points, ":var7", ":var2", 1),
      (val_sub, ":var8", ":var7"),
      (assign, reg1, ":var8"),
      (display_message, "@Polearm-wall dealt {reg1} damage!"),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 2, 
    [
      (key_clicked, key_b),
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_is_alive, ":var1"),
      (agent_get_wielded_item, ":var2", ":var1", 0),
      (agent_get_wielded_item, ":var3", ":var1", 1),
      (assign, "$spear_dist", 145),
      (try_begin),
        (this_or_next|is_between, ":var2", "itm_modded_billhook_fork_1", "itm_maul"),
        (is_between, ":var3", "itm_modded_billhook_fork_1", "itm_maul"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_1"),
          (eq, ":var3", "itm_modded_billhook_fork_1"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_2"),
          (eq, ":var3", "itm_modded_billhook_fork_2"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_1"),
          (eq, ":var3", "itm_modded_fauchard_1"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_2"),
          (eq, ":var3", "itm_modded_fauchard_2"),
          (assign, "$spear_dist", 171),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_3"),
          (eq, ":var3", "itm_modded_fauchard_3"),
          (assign, "$spear_dist", 197),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_4"),
          (eq, ":var3", "itm_modded_fauchard_4"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_1"),
          (eq, ":var3", "itm_modded_glaive_1"),
          (assign, "$spear_dist", 169),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_1"),
          (eq, ":var3", "itm_modded_glaive_fork_1"),
          (assign, "$spear_dist", 230),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_2"),
          (eq, ":var3", "itm_modded_glaive_fork_2"),
          (assign, "$spear_dist", 188),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_roundel"),
          (eq, ":var3", "itm_modded_glaive_roundel"),
          (assign, "$spear_dist", 149),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_1"),
          (eq, ":var3", "itm_modded_bill_1"),
          (assign, "$spear_dist", 215),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_2"),
          (eq, ":var3", "itm_modded_bill_2"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_1"),
          (eq, ":var3", "itm_modded_billhook_1"),
          (assign, "$spear_dist", 207),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_2"),
          (eq, ":var3", "itm_modded_billhook_2"),
          (assign, "$spear_dist", 172),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_3"),
          (eq, ":var3", "itm_modded_billhook_3"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_voulge"),
          (eq, ":var3", "itm_modded_voulge"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_spiked_voulge"),
          (eq, ":var3", "itm_modded_spiked_voulge"),
          (assign, "$spear_dist", 182),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_cleaving_voulge"),
          (eq, ":var3", "itm_modded_cleaving_voulge"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_1"),
          (eq, ":var3", "itm_modded_hooked_voulge_1"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_2"),
          (eq, ":var3", "itm_modded_hooked_voulge_2"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_3"),
          (eq, ":var3", "itm_modded_hooked_voulge_3"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_1"),
          (eq, ":var3", "itm_modded_couteau_1"),
          (assign, "$spear_dist", 177),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_2"),
          (eq, ":var3", "itm_modded_couteau_2"),
          (assign, "$spear_dist", 196),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_guisarme"),
          (eq, ":var3", "itm_modded_guisarme"),
          (assign, "$spear_dist", 232),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_assegai"),
          (eq, ":var3", "itm_modded_assegai"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_pike"),
          (eq, ":var3", "itm_modded_pike"),
          (assign, "$spear_dist", 300),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_war_spear"),
          (eq, ":var3", "itm_modded_war_spear"),
          (assign, "$spear_dist", 211),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_glaive"),
        (is_between, ":var3", "itm_glaive"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_glaive"),
          (eq, ":var3", "itm_glaive"),
          (assign, "$spear_dist", 160),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_bill"),
        (is_between, ":var3", "itm_bill"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_bill"),
          (eq, ":var3", "itm_bill"),
          (assign, "$spear_dist", 128),
        (try_end),
      (try_end),
      (eq, ":var0", 1),
      (agent_get_horse, ":var4", ":var1"),
      (le, ":var4", 0),
      (neq, "$spear_in_position", 1),
      (display_message, "@Bracing polearm for charge.", 0x6495ED),
      (agent_set_animation, ":var1", "anim_spearwall_hold"),
      (assign, "$spear_in_position", 1),
      (store_agent_hit_points, "$spear_hp", ":var1", 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 41, ":var0"),
    ]),

    (0, 0, 3, 
    [
      (key_clicked, key_h),
    ],
    [
      (agent_get_slot, ":var0", "$fplayer_agent_no", 41),
      (gt, ":var0", 0),
      (agent_is_active, ":var0"),
      (agent_get_horse, reg0, "$fplayer_agent_no"),
      (eq, reg0, -1),
      (agent_play_sound, "$fplayer_agent_no", "snd_man_breath_hard"),
      (display_message, "@You whistle for your horse."),
      (agent_is_alive, ":var0"),
      (agent_get_position, pos1, "$fplayer_agent_no"),
      (agent_set_scripted_destination, ":var0", pos1, 0),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_2, ":var0"),
      (ge, ":var0", 0),
      (item_get_type, ":var1", ":var0"),
      (this_or_next|eq, ":var1", 8),
      (eq, ":var1", 9),
      (store_trigger_param_1, ":var2"),
      (agent_is_active, ":var2"),
      (agent_is_alive, ":var2"),
      (agent_is_non_player, ":var2"),
      (agent_get_ammo, ":var3", ":var2", 0),
      (le, ":var3", 0),
      (agent_get_horse, ":var4", ":var2"),
      (eq, ":var4", -1),
      (assign, ":var5", 1),
      (try_begin),
        (this_or_next|party_slot_eq, "$g_encountered_party", 0, 3),
        (party_slot_eq, "$g_encountered_party", 0, 2),
        (agent_get_team, ":var6", ":var2"),
        (this_or_next|eq, ":var6", "$defender_team"),
        (eq, ":var6", "$defender_team_2"),
        (assign, ":var5", 0),
      (try_end),
      (eq, ":var5", 1),
      (agent_set_division, ":var2", 4),
      (agent_set_slot, ":var2", 42, 4),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_slot, ":var0", 42, -1),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_active, ":var0"),
        (agent_slot_ge, ":var0", 42, 0),
        (agent_is_alive, ":var0"),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 42, ":var1"),
        (agent_get_slot, ":var2", ":var0", 42),
        (agent_set_division, ":var0", ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_slot, ":var0", 42, -1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (neg|agent_is_human, ":var0"),
        (agent_get_rider, ":var1", ":var0"),
        (ge, ":var1", 0),
        (agent_is_active, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_is_non_player, ":var1"),
      (else_try),
        (assign, ":var1", -1),
      (try_end),
      (agent_set_slot, ":var0", 41, ":var1"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (neg|agent_is_human, ":var0"),
      (agent_get_slot, ":var1", ":var0", 41),
      (ge, ":var1", 0),
      (agent_is_active, ":var1"),
      (agent_is_alive, ":var1"),
      (try_begin),
        (assign, ":var2", 70),
        (agent_get_troop_id, ":var3", ":var1"),
        (store_skill_level, ":var4", "skl_riding", ":var3"),
        (store_mul, ":var5", ":var4", 5),
        (val_sub, ":var2", ":var5"),
        (call_script, "script_rand", 0, 100),
        (le, reg0, ":var2"),
        (call_script, "script_rand", 60, 80),
        (assign, ":var6", reg0),
        (store_mul, ":var7", ":var4", 7),
        (val_sub, ":var6", ":var7"),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var6"),
        (try_begin),
          (neg|agent_is_non_player, ":var1"),
          (display_message, "@You fall down from your horse and sustain some damage!"),
        (try_end),
      (try_end),
      (try_begin),
        (agent_is_active, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_set_division, ":var1", 0),
        (agent_set_slot, ":var1", 42, 0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_active, ":var0"),
        (agent_slot_ge, ":var0", 42, 0),
        (agent_is_alive, ":var0"),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 42, ":var1"),
        (agent_get_slot, ":var2", ":var0", 42),
        (agent_set_division, ":var0", ":var2"),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (call_script, "script_lance_use_classify_agent"),
    ]),

    (2, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 43),
        (gt, ":var1", 0),
        (agent_get_wielded_item, ":var2", ":var0", 0),
        (agent_get_horse, ":var3", ":var0"),
        (try_begin),
          (le, ":var3", 0),
          (agent_set_slot, ":var0", 43, 0),
          (eq, ":var2", ":var1"),
          (call_script, "script_lance_use_backup_weapon", ":var0"),
        (else_try),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var4", ":var0"),
          (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":var4", 1),
          (assign, ":var5", reg0),
          (try_begin),
            (lt, ":var5", 500),
            (agent_get_combat_state, ":var6", ":var0"),
            (gt, ":var6", 3),
            (eq, ":var2", ":var1"),
            (call_script, "script_lance_use_backup_weapon", ":var0"),
          (else_try),
            (neq, ":var2", ":var1"),
            (agent_set_wielded_item, ":var0", ":var1"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$tom_sand_storm", 0),
      (call_script, "script_change_rain_or_snow"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$tom_sand_storm", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (position_set_z_to_ground_level, pos0),
      (position_get_z, ":var1", pos0),
      (val_add, ":var1", 400),
      (position_set_z, pos0, ":var1"),
      (particle_system_burst, "psys_desert_storm", pos0, 2),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 2, ti_once, 
    [
      (eq, "$tom_use_banners", 1),
    ],
    [
      (call_script, "script_set_flag_carriers"),
    ]),

    (10, 0, 0, 
    [
      (eq, "$tom_use_banners", 1),
      (eq, "$tom_bonus_banners", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_range, ":var1"),
        (agent_slot_eq, ":var1", 40, 1),
        (agent_is_alive, ":var1"),
        (agent_is_active, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (agent_get_position, pos1, ":var1"),
        (try_for_range, ":var3"),
          (neq, ":var3", ":var1"),
          (agent_get_team, ":var4", ":var3"),
          (eq, ":var2", ":var4"),
          (agent_is_alive, ":var3"),
          (agent_is_active, ":var3"),
          (agent_is_human, ":var3"),
          (agent_get_position, pos2, ":var3"),
          (get_distance_between_positions_in_meters, ":var5", pos1, pos2),
          (le, ":var5", 10),
          (store_agent_hit_points, ":var6", ":var3"),
          (val_add, ":var6", 2),
          (val_min, ":var6", 101),
          (agent_set_hit_points, ":var3", ":var6"),
          (try_begin),
            (eq, ":var3", ":var0"),
            (display_message, "@You feel secured standing near the banner, healing some of your HP.", 0x6495ED),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var1", ":var0"),
      (agent_is_alive, ":var1"),
      (agent_get_wielded_item, ":var7", ":var1", 0),
      (is_between, ":var7", 1291, 1295),
      (agent_get_team, ":var2", ":var1"),
      (agent_get_position, pos1, ":var1"),
      (try_for_range, ":var3"),
        (neq, ":var3", ":var1"),
        (agent_get_team, ":var4", ":var3"),
        (eq, ":var2", ":var4"),
        (agent_is_alive, ":var3"),
        (agent_is_active, ":var3"),
        (agent_is_human, ":var3"),
        (agent_get_position, pos2, ":var3"),
        (get_distance_between_positions_in_meters, ":var5", pos1, pos2),
        (le, ":var5", 10),
        (store_agent_hit_points, ":var6", ":var3"),
        (try_begin),
          (eq, ":var7", 1294),
          (val_add, ":var6", 1),
        (try_end),
        (val_add, ":var6", 5),
        (val_max, ":var6", 101),
        (agent_set_hit_points, ":var3", ":var6"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$tom_sand_storm", 3),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (position_set_z_to_ground_level, pos0),
      (position_get_z, ":var1", pos0),
      (val_add, ":var1", 2100),
      (position_set_z, pos0, ":var1"),
      (particle_system_burst, "psys_rain", pos0, 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 0, 
    [
      (eq, "$tom_sand_storm", 2),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (position_set_z_to_ground_level, pos0),
      (position_get_z, ":var1", pos0),
      (val_add, ":var1", 2000),
      (position_set_z, pos0, ":var1"),
      (particle_system_burst, "psys_blizzard", pos0, 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (8, 0, 0, 
    [
      (eq, "$tom_sand_storm", 3),
    ],
    [
      (store_random_in_range, ":var0", 0, 100),
      (try_begin),
        (ge, ":var0", 90),
        (play_sound, "snd_thunder"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (eq, "$tom_sand_storm", 2),
    ],
    [
      (play_sound, "snd_wind"),
    ]),

    (0, 0, ti_once, 
    [
      (eq, "$tom_sand_storm", 1),
    ],
    [
      (play_sound, "snd_wind"),
    ]),

    (0, 1.5, 0, 
    [
      (key_clicked, key_t),
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_set_animation, ":var0", "anim_cheer", 1),
      (agent_play_sound, ":var0", "snd_man_victory"),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_position, pos1, ":var0"),
      (try_for_agents, ":var2"),
        (agent_is_alive, ":var2"),
        (agent_is_human, ":var2"),
        (agent_get_team, ":var3", ":var2"),
        (eq, ":var3", ":var1"),
        (agent_get_position, pos0, ":var2"),
        (get_distance_between_positions_in_meters, ":var4", pos0, pos1),
        (lt, ":var4", 20),
        (agent_set_animation, ":var2", "anim_cheer", 1),
        (agent_play_sound, ":var2", "snd_man_victory"),
        (agent_get_slot, ":var5", ":var2", 16),
        (val_add, ":var5", 5),
        (val_min, ":var5", 9600),
        (agent_set_slot, ":var2", 16, ":var5"),
      (try_end),
      (display_message, "@Huzzah! You encourage your nearby troops."),
    ]),

    (0, 1.7, 0, 
    [
      (eq, "$tom_yell_smelly_peasents", 1),
    ],
    [
      (call_script, "script_tom_command_cheer"),
      (assign, "$tom_yell_smelly_peasents", 0),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (neg|agent_is_ally, ":var0"),
      (agent_is_human, ":var0"),
      (eq, ":var1", "$fplayer_agent_no"),
      (val_add, "$killcount", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_clear_troop_array", "trp_lances_troop_in_combat", 0, "$lance_troop_serving"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_is_human, ":var0"),
      (get_player_agent_no, ":var1"),
      (neq, ":var0", ":var1"),
      (agent_get_party_id, ":var2", ":var0"),
      (eq, ":var2", "p_main_party"),
      (agent_get_troop_id, ":var3", ":var0"),
      (call_script, "script_search_for_troop", ":var3"),
      (agent_set_slot, ":var0", 102, reg0),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$enable_deahtcam", 1),
      (assign, "$auxilary_player_active", 0),
      (eq, "$use_player_auxiliary", 1),
      (assign, "$g_move_heroes", 1),
      (party_clear, "p_temp_casualties_3"),
      (call_script, "script_party_add_party", "p_temp_casualties_3", "p_main_party"),
      (set_player_troop, "trp_player"),
      (assign, "$enable_deahtcam", 0),
    ]),

    (5, 0, 0, 
    [
      (eq, "$use_player_auxiliary", 1),
      (eq, "$enable_deahtcam", 0),
      (get_player_agent_no, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (neq, "$freelancer_state", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_division, ":var2", ":var0"),
      (assign, ":var3", 0),
      (try_for_agents, ":var4"),
        (eq, ":var3", 0),
        (agent_is_human, ":var4"),
        (agent_is_alive, ":var4"),
        (agent_get_team, ":var5", ":var4"),
        (agent_get_party_id, ":var6", ":var4"),
        (eq, ":var6", "p_main_party"),
        (agent_get_division, ":var7", ":var0"),
        (agent_get_group, ":var8", ":var0"),
        (eq, ":var1", ":var5"),
        (eq, ":var2", ":var7"),
        (agent_get_troop_id, ":var9", ":var4"),
        (neg|is_between, ":var9", "trp_npc1", "trp_enhanced_rnd_lord_end"),
        (set_player_troop, ":var9"),
        (store_agent_hit_points, ":var10", ":var4", 1),
        (agent_get_position, pos1, ":var4"),
        (position_set_z, pos1, -2000),
        (position_set_x, pos1, 0),
        (position_set_y, pos1, 0),
        (agent_get_position, pos0, ":var4"),
        (set_spawn_position, pos0),
        (agent_get_horse, ":var11", ":var4"),
        (try_begin),
          (gt, ":var11", 0),
          (agent_set_position, ":var11", pos1),
          (remove_agent, ":var11"),
        (try_end),
        (agent_set_position, ":var4", pos1),
        (agent_set_slot, ":var4", 35, 1),
        (agent_get_slot, ":var12", ":var4", 102),
        (remove_agent, ":var4"),
        (spawn_agent, ":var9"),
        (assign, ":var0", reg0),
        (agent_set_slot, ":var0", 102, ":var12"),
        (agent_set_team, ":var0", ":var1"),
        (agent_set_hit_points, ":var0", ":var10", 1),
        (agent_set_group, ":var0", ":var8"),
        (agent_set_slot, ":var0", 35, 2),
        (agent_set_slot, ":var0", 36, ":var9"),
        (try_begin),
          (agent_get_horse, ":var13", ":var0"),
          (gt, ":var13", 0),
          (lt, ":var11", 0),
          (agent_set_position, ":var13", pos1),
          (remove_agent, ":var13"),
        (try_end),
        (set_player_troop, "trp_player"),
        (assign, ":var3", 1),
        (assign, "$auxilary_player_active", 1),
      (try_end),
      (eq, ":var3", 0),
      (assign, "$enable_deahtcam", 1),
    ]),

    (5, 0, 0, 
    [
      (eq, "$use_player_auxiliary", 1),
      (eq, "$enable_deahtcam", 0),
      (get_player_agent_no, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$enable_deahtcam", 1),
    ]),

  ]),

  ("bandits_at_night", 0, -1,
  "Default town visit",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_horse, aif_start_alarmed, 1, [itm_priest_robe_1,itm_priest_cap_1,itm_shoes,itm_sword_type_xii,itm_talak_buckler,itm_throwing_daggers]),
    (1, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (8, mtef_scene_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (12, mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_scene_source, 0, 0, 1, []),
    (14, mtef_scene_source, 0, 0, 1, []),
    (15, mtef_scene_source, 0, 0, 1, []),
    (16, mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (28, mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_visitor_source, af_override_horse, 0, 1, []),
    (34, mtef_visitor_source, af_override_horse, 0, 1, []),
    (35, mtef_visitor_source, af_override_horse, 0, 1, []),
    (36, mtef_visitor_source, af_override_horse, 0, 1, []),
    (37, mtef_visitor_source, af_override_horse, 0, 1, []),
    (38, mtef_visitor_source, af_override_horse, 0, 1, []),
    (39, mtef_visitor_source, af_override_horse, 0, 1, []),
    (40, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$tom_sand_storm", 0),
      (call_script, "script_change_rain_or_snow"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (agent_set_team, ":var0", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "str_cannot_leave_now"),
    ],
    []),

    (ti_on_leave_area, 0, 0, 
    [
      (try_begin),
        (eq, "$g_defending_against_siege", 0),
        (assign, "$g_leave_town", 1),
      (try_end),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 4096),
      (set_party_battle_mode),
      (party_slot_eq, "$current_town", 0, 3),
      (call_script, "script_town_init_doors", 0),
    ]),

    (1, 4, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_town_bandits_failed"),
      (else_try),
        (jump_to_menu, "mnu_town_bandits_succeeded"),
      (try_end),
      (finish_mission),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

    (ti_after_mission_start, 0, ti_once, 
    [
      (neq, "$g_mt_mode", 1),
    ],
    [
      (store_skill_level, ":var0", 1, "trp_player"),
      (troop_get_slot, ":var1", "trp_player", 7),
      (val_div, ":var0", 3),
      (val_div, ":var1", 400),
      (store_add, ":var2", ":var1", ":var0"),
      (val_min, ":var2", 4),
      (ge, ":var2", 1),
      (get_player_agent_no, ":var3"),
      (agent_get_team, ":var4", ":var3"),
      (agent_get_horse, ":var5", ":var3"),
      (assign, ":var6", 0),
      (assign, ":var7", 0),
      (try_begin),
        (party_slot_eq, "$current_town", 0, 4),
        (assign, ":var6", 11),
        (assign, ":var7", "mt_village_center"),
      (else_try),
        (this_or_next|eq, "$talk_context", 18),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 0),
        (assign, ":var6", 24),
        (try_begin),
          (party_slot_eq, "$current_town", 0, 2),
          (assign, ":var7", "mt_castle_visit"),
        (else_try),
          (assign, ":var7", "mt_town_center"),
        (try_end),
      (else_try),
        (eq, "$talk_context", 14),
        (assign, ":var6", 17),
      (try_end),
      (try_begin),
        (neq, "$talk_context", 14),
        (gt, ":var5", 0),
        (mission_tpl_entry_set_override_flags, ":var7", ":var6", 0),
      (try_end),
      (store_current_scene, ":var8"),
      (modify_visitors_at_site, ":var8"),
      (assign, ":var9", 0),
      (party_get_num_companion_stacks, ":var10", "p_main_party"),
      (try_for_range, ":var11", 0, ":var10"),
        (party_stack_get_troop_id, ":var12", "p_main_party", ":var11"),
        (neq, ":var12", "trp_player"),
        (troop_is_hero, ":var12"),
        (neg|troop_is_wounded, ":var12"),
        (val_add, ":var9", 1),
        (try_begin),
          (this_or_next|eq, "$talk_context", 19),
          (eq, "$talk_context", 18),
          (troop_set_slot, ":var12", 155, 1),
        (try_end),
        (add_visitors_to_current_scene, ":var6", ":var12", 1),
        (eq, ":var9", ":var2"),
        (assign, ":var10", 0),
      (try_end),
      (gt, ":var9", 0),
      (set_show_messages, 0),
      (team_give_order, ":var4", 8, 1),
      (set_show_messages, 1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (troop_is_hero, ":var1"),
      (main_party_has_troop, ":var1"),
      (get_player_agent_no, ":var2"),
      (agent_get_team, ":var3", ":var2"),
      (agent_get_position, pos1, ":var2"),
      (agent_set_team, ":var0", ":var3"),
      (agent_set_division, ":var0", 8),
      (agent_add_relation_with_agent, ":var0", ":var2", 1),
      (agent_set_is_alarmed, ":var0", 1),
      (store_random_in_range, ":var4", 1, 3),
      (val_mul, ":var4", 100),
      (position_move_y, pos1, ":var4"),
      (store_random_in_range, ":var4", 1, 3),
      (store_random_in_range, ":var5", 0, 2),
      (val_mul, ":var5", -1),
      (try_begin),
        (neq, ":var5", 0),
        (val_mul, ":var4", ":var5"),
      (try_end),
      (position_move_x, 1, ":var4"),
      (agent_set_position, ":var0", pos1),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (troop_is_hero, ":var1"),
      (main_party_has_troop, ":var1"),
      (party_wound_members, "p_main_party", ":var1", 1),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$g_decap_enabled", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (agent_is_non_player, ":var0"),
      (agent_get_troop_id, ":var3", ":var0"),
      (neg|troop_is_hero, ":var3"),
      (assign, ":var4", reg0),
      (copy_position, 5, 0),
      (neq, ":var0", -1),
      (try_begin),
        (agent_is_human, ":var0"),
        (ge, ":var4", 0),
        (assign, ":var5", 0),
        (try_begin),
          (this_or_next|eq, ":var4", "itm_supercrossbow"),
          (eq, ":var4", "itm_supersledge"),
          (assign, ":var5", 1),
        (else_try),
          (neq, ":var4", "itm_mace_1"),
          (neq, ":var4", "itm_mace_2"),
          (neq, ":var4", "itm_mace_3"),
          (neq, ":var4", "itm_staff"),
          (agent_get_action_dir, ":var6", ":var1"),
          (this_or_next|eq, ":var6", 1),
          (eq, ":var6", 2),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var5", 0),
        (try_begin),
          (ge, ":var2", "$g_decap_minimum_damage"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap minimum DMG req bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (store_agent_hit_points, ":var7", ":var0", 1),
        (val_add, ":var7", "$g_decap_negative_health"),
        (ge, ":var2", ":var7"),
        (agent_get_position, pos4, ":var0"),
        (get_distance_between_positions, ":var8", pos4, pos5),
        (agent_get_horse, ":var9", ":var0"),
        (try_begin),
          (ge, ":var9", 0),
          (assign, ":var10", 240),
          (assign, ":var11", 260),
        (else_try),
          (assign, ":var10", 160),
          (assign, ":var11", 176),
        (try_end),
        (is_between, ":var8", ":var10", ":var11"),
        (assign, ":var5", 0),
        (try_begin),
          (store_random_in_range, ":var12", 0, 100),
          (le, ":var12", "$g_decap_chance"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap chance calc bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var13", "itm_cut_off_head_male"),
        (agent_get_troop_id, ":var14", ":var0"),
        (try_begin),
          (ge, ":var14", 0),
          (troop_get_type, ":var15", ":var14"),
          (eq, ":var15", 1),
          (assign, ":var13", "itm_cut_off_head_female"),
        (try_end),
        (store_random_in_range, ":var16", 0, 360),
        (store_random_in_range, ":var17", -60, 60),
        (store_random_in_range, ":var18", -90, 90),
        (store_random_in_range, ":var19", -90, 90),
        (position_rotate_z, pos4, ":var16"),
        (position_rotate_y, pos4, ":var17"),
        (position_move_x, 4, ":var18"),
        (position_move_y, pos4, ":var19"),
        (position_set_z_to_ground_level, pos4),
        (position_move_z, pos4, 5),
        (set_spawn_position, pos4),
        (assign, ":var20", 360),
        (agent_get_item_slot, ":var21", ":var0", 4),
        (try_begin),
          (ge, ":var21", 1),
          (agent_unequip_item, ":var0", ":var21"),
          (try_begin),
            (spawn_item, ":var21", 0, ":var20"),
          (try_end),
        (try_end),
        (agent_equip_item, ":var0", "itm_invisible_head"),
        (agent_get_position, pos4, ":var0"),
        (position_move_z, pos4, ":var10"),
        (particle_system_burst, "psys_blood_decapitation", pos4, "$g_decap_psys_blood_decapitation"),
        (particle_system_burst, "psys_game_blood", pos4, "$g_decap_psys_game_blood"),
        (particle_system_burst, "psys_game_blood_2", pos4, "$g_decap_psys_game_blood_2"),
        (play_sound_at_position, "snd_decapitation", pos4),
        (position_move_z, pos4, 20),
        (set_spawn_position, pos4),
        (assign, ":var13", "spr_head_dynamic_male"),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var13", "spr_head_dynamic_female"),
        (try_end),
        (spawn_scene_prop, ":var13"),
        (agent_get_troop_id, ":var22", ":var1"),
        (str_store_troop_name, s0, ":var22"),
        (agent_get_troop_id, ":var14", ":var0"),
        (str_store_troop_name, s1, ":var14"),
        (get_player_agent_no, ":var23"),
        (agent_get_team, ":var24", ":var23"),
        (agent_get_team, ":var25", ":var0"),
        (try_begin),
          (neq, ":var24", ":var25"),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFF33DD11),
        (else_try),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFFFF4422),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_bully_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_fat_peasant_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_thug_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_fatseveredarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_thin_looter_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (0, 0, 1, 
    [
      (key_clicked, key_right_control),
    ],
    [
      (try_begin),
        (key_is_down, key_m),
        (try_begin),
          (eq, "$g_decapitations_debugging", 0),
          (assign, "$g_decapitations_debugging", 1),
          (display_message, "@Decapitation debug mode Enabled"),
        (else_try),
          (assign, "$g_decapitations_debugging", 0),
          (display_message, "@Decapitation debug mode Disabled"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, key_k),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos17, ":var0"),
        (position_move_y, pos17, 2000),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_bully_handless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_thug_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_thin_looter_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_fat_peasant_handless"),
        (agent_set_team, reg0, 2),
      (try_end),
      (try_begin),
        (key_is_down, key_j),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos18, ":var0"),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supersledge"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supercrossbow"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_super_bolts"),
      (try_end),
    ]),

  ]),

  ("village_training", mtf_arena_fight, -1,
  "village training",
  [
    (2, mtef_team_0|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff,itm_practice_boots]),
    (4, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff,itm_practice_boots]),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$tom_sand_storm", 0),
      (call_script, "script_change_rain_or_snow"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_train_peasants_against_bandits_training_succeeded", 0),
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_give_up_fight"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (neg|main_hero_fallen),
        (assign, "$g_train_peasants_against_bandits_training_succeeded", 1),
      (try_end),
      (finish_mission),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("visit_town_castle", 0, -1,
  "You enter the halls of the lord.",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (1, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_scene_source, af_override_horse, 0, 1, []),
    (11, mtef_scene_source, af_override_horse, 0, 1, []),
    (12, mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_visitor_source, 0, 0, 1, []),
    (14, mtef_visitor_source, 0, 0, 1, []),
    (15, mtef_visitor_source, 0, 0, 1, []),
    (16, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (17, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (18, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (19, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (20, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (21, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (22, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (23, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (24, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (25, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (26, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (27, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (28, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (29, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (30, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (31, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_init_town_agent", ":var0"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (try_begin),
        (eq, ":var1", "trp_dplmc_constable"),
        (agent_equip_item, ":var0", "itm_kau_mail_a"),
        (agent_equip_item, ":var0", "itm_leather_boots"),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (neq, "$talk_context", 18),
      (set_trigger_result, 1),
    ],
    []),

    (ti_on_leave_area, 0, 0, 
    [
      (eq, "$talk_context", 18),
    ],
    [
      (display_message, "str_leaving_area_during_prison_break"),
      (set_jump_mission, "mt_sneak_caught_fight"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (try_begin),
        (eq, "$talk_context", 1),
        (try_begin),
          (store_faction_of_party, ":var0", "$current_town"),
          (faction_slot_eq, ":var0", 4, 6),
          (faction_slot_eq, ":var0", 5, "$current_town"),
          (call_script, "script_music_set_situation_with_culture", 16777216),
        (try_end),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", 0),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("back_alley_kill_local_merchant", mtf_battle_mode, -1,
  "You enter the back alley",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 4, []),
    (3, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 4, []),
  ],
  [
    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "str_cannot_leave_now"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 4096),
    ]),

    (0, 0, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 1),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (assign, ":var1", 0),
      (assign, ":var3", -1),
      (assign, ":var4", -1),
      (try_for_agents, ":var5"),
        (agent_get_troop_id, ":var6", ":var5"),
        (try_begin),
          (eq, ":var6", "trp_local_merchant"),
          (store_agent_hit_points, ":var1", ":var5"),
          (assign, ":var3", ":var5"),
        (else_try),
          (eq, ":var6", "trp_player"),
          (store_agent_hit_points, ":var2", ":var5"),
          (assign, ":var4", ":var5"),
        (try_end),
      (try_end),
      (ge, ":var4", 0),
      (ge, ":var3", 0),
      (agent_is_alive, ":var4"),
      (agent_is_alive, ":var3"),
      (is_between, ":var1", 1, 30),
      (gt, ":var2", 50),
      (start_mission_conversation, "trp_local_merchant"),
    ],
    []),

    (1, 4, ti_once, 
    [
      (assign, ":var0", 0),
      (try_begin),
        (call_script, "script_cf_troop_agent_is_alive", "trp_local_merchant"),
      (else_try),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|main_hero_fallen),
      (eq, ":var0", 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (call_script, "script_fail_quest", "qst_kill_local_merchant"),
      (else_try),
        (call_script, "script_change_player_relation_with_center", "$current_town", -4),
        (call_script, "script_succeed_quest", "qst_kill_local_merchant"),
      (try_end),
      (finish_mission),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("back_alley_revolt", mtf_battle_mode, charge,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_use_exact_number, af_override_weapons|af_override_horse|af_override_head, aif_start_alarmed, 16, [itm_quarter_staff]),
    (3, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 4, []),
  ],
  [
    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_do_you_want_to_retreat"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (jump_to_menu, "mnu_collect_taxes_failed"),
      (finish_mission),
    ]),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "str_cannot_leave_now"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 1024),
    ]),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (jump_to_menu, "mnu_collect_taxes_failed"),
      (else_try),
        (jump_to_menu, "mnu_collect_taxes_rebels_killed"),
      (try_end),
      (finish_mission),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$g_decap_enabled", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (agent_is_non_player, ":var0"),
      (agent_get_troop_id, ":var3", ":var0"),
      (neg|troop_is_hero, ":var3"),
      (assign, ":var4", reg0),
      (copy_position, 5, 0),
      (neq, ":var0", -1),
      (try_begin),
        (agent_is_human, ":var0"),
        (ge, ":var4", 0),
        (assign, ":var5", 0),
        (try_begin),
          (this_or_next|eq, ":var4", "itm_supercrossbow"),
          (eq, ":var4", "itm_supersledge"),
          (assign, ":var5", 1),
        (else_try),
          (neq, ":var4", "itm_mace_1"),
          (neq, ":var4", "itm_mace_2"),
          (neq, ":var4", "itm_mace_3"),
          (neq, ":var4", "itm_staff"),
          (agent_get_action_dir, ":var6", ":var1"),
          (this_or_next|eq, ":var6", 1),
          (eq, ":var6", 2),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var5", 0),
        (try_begin),
          (ge, ":var2", "$g_decap_minimum_damage"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap minimum DMG req bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (store_agent_hit_points, ":var7", ":var0", 1),
        (val_add, ":var7", "$g_decap_negative_health"),
        (ge, ":var2", ":var7"),
        (agent_get_position, pos4, ":var0"),
        (get_distance_between_positions, ":var8", pos4, pos5),
        (agent_get_horse, ":var9", ":var0"),
        (try_begin),
          (ge, ":var9", 0),
          (assign, ":var10", 240),
          (assign, ":var11", 260),
        (else_try),
          (assign, ":var10", 160),
          (assign, ":var11", 176),
        (try_end),
        (is_between, ":var8", ":var10", ":var11"),
        (assign, ":var5", 0),
        (try_begin),
          (store_random_in_range, ":var12", 0, 100),
          (le, ":var12", "$g_decap_chance"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap chance calc bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var13", "itm_cut_off_head_male"),
        (agent_get_troop_id, ":var14", ":var0"),
        (try_begin),
          (ge, ":var14", 0),
          (troop_get_type, ":var15", ":var14"),
          (eq, ":var15", 1),
          (assign, ":var13", "itm_cut_off_head_female"),
        (try_end),
        (store_random_in_range, ":var16", 0, 360),
        (store_random_in_range, ":var17", -60, 60),
        (store_random_in_range, ":var18", -90, 90),
        (store_random_in_range, ":var19", -90, 90),
        (position_rotate_z, pos4, ":var16"),
        (position_rotate_y, pos4, ":var17"),
        (position_move_x, 4, ":var18"),
        (position_move_y, pos4, ":var19"),
        (position_set_z_to_ground_level, pos4),
        (position_move_z, pos4, 5),
        (set_spawn_position, pos4),
        (assign, ":var20", 360),
        (agent_get_item_slot, ":var21", ":var0", 4),
        (try_begin),
          (ge, ":var21", 1),
          (agent_unequip_item, ":var0", ":var21"),
          (try_begin),
            (spawn_item, ":var21", 0, ":var20"),
          (try_end),
        (try_end),
        (agent_equip_item, ":var0", "itm_invisible_head"),
        (agent_get_position, pos4, ":var0"),
        (position_move_z, pos4, ":var10"),
        (particle_system_burst, "psys_blood_decapitation", pos4, "$g_decap_psys_blood_decapitation"),
        (particle_system_burst, "psys_game_blood", pos4, "$g_decap_psys_game_blood"),
        (particle_system_burst, "psys_game_blood_2", pos4, "$g_decap_psys_game_blood_2"),
        (play_sound_at_position, "snd_decapitation", pos4),
        (position_move_z, pos4, 20),
        (set_spawn_position, pos4),
        (assign, ":var13", "spr_head_dynamic_male"),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var13", "spr_head_dynamic_female"),
        (try_end),
        (spawn_scene_prop, ":var13"),
        (agent_get_troop_id, ":var22", ":var1"),
        (str_store_troop_name, s0, ":var22"),
        (agent_get_troop_id, ":var14", ":var0"),
        (str_store_troop_name, s1, ":var14"),
        (get_player_agent_no, ":var23"),
        (agent_get_team, ":var24", ":var23"),
        (agent_get_team, ":var25", ":var0"),
        (try_begin),
          (neq, ":var24", ":var25"),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFF33DD11),
        (else_try),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFFFF4422),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_bully_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_fat_peasant_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_thug_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_fatseveredarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_thin_looter_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (0, 0, 1, 
    [
      (key_clicked, key_right_control),
    ],
    [
      (try_begin),
        (key_is_down, key_m),
        (try_begin),
          (eq, "$g_decapitations_debugging", 0),
          (assign, "$g_decapitations_debugging", 1),
          (display_message, "@Decapitation debug mode Enabled"),
        (else_try),
          (assign, "$g_decapitations_debugging", 0),
          (display_message, "@Decapitation debug mode Disabled"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, key_k),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos17, ":var0"),
        (position_move_y, pos17, 2000),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_bully_handless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_thug_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_thin_looter_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_fat_peasant_handless"),
        (agent_set_team, reg0, 2),
      (try_end),
      (try_begin),
        (key_is_down, key_j),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos18, ":var0"),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supersledge"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supercrossbow"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_super_bolts"),
      (try_end),
    ]),

  ]),

  ("lead_charge", mtf_battle_mode, charge,
  "You lead your men to battle.",
  [
    (1, mtef_team_0|mtef_defenders, 0, aif_start_alarmed, 48, []),
    (0, mtef_team_0|mtef_defenders, 0, aif_start_alarmed, 0, []),
    (4, mtef_team_1|mtef_attackers, 0, aif_start_alarmed, 48, []),
    (4, mtef_team_1|mtef_attackers, 0, aif_start_alarmed, 0, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_agent_reassign_team", ":var0"),
      (assign, ":var1", 5000),
      (agent_get_troop_id, ":var2", ":var0"),
      (store_character_level, ":var3", ":var2"),
      (val_mul, ":var3", 35),
      (val_add, ":var1", ":var3"),
      (store_random_in_range, ":var4", 0, 3000),
      (val_add, ":var1", ":var4"),
      (agent_get_party_id, ":var5", ":var0"),
      (ge, ":var5", 0),
      (party_get_morale, ":var6", ":var5"),
      (store_sub, ":var7", ":var6", 70),
      (val_mul, ":var7", 30),
      (val_add, ":var1", ":var7"),
      (agent_set_slot, ":var0", 16, ":var1"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var3", ":var0"),
        (party_add_members, "p_total_enemy_casualties", ":var3", 1),
        (eq, ":var2", 1),
        (party_wound_members, "p_total_enemy_casualties", ":var3", 1),
      (try_end),
      (call_script, "script_apply_death_effect_on_courage_scores", ":var0", ":var1"),
    ]),

    (0, 0.4, ti_once, 
    [],
    [
      (try_begin),
        (get_player_agent_no, "$fplayer_agent_no"),
        (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
        (assign, ":var0", 0),
        (assign, ":var1", 0),
        (assign, ":var2", 0),
        (assign, ":var3", 0),
        (assign, "$team0_size", 0),
        (assign, "$team1_size", 0),
        (assign, "$team2_size", 0),
        (assign, "$team3_size", 0),
        (try_for_agents, ":var4"),
          (agent_is_human, ":var4"),
          (agent_get_team, ":var5", ":var4"),
          (agent_get_troop_id, ":var6", ":var4"),
          (store_faction_of_troop, ":var7", ":var6"),
          (try_begin),
            (eq, ":var5", 0),
            (val_add, ":var0", ":var7"),
            (val_add, "$team0_size", 1),
          (else_try),
            (eq, ":var5", 1),
            (val_add, ":var1", ":var7"),
            (val_add, "$team1_size", 1),
          (else_try),
            (eq, ":var5", 2),
            (val_add, ":var2", ":var7"),
            (val_add, "$team2_size", 1),
          (else_try),
            (eq, ":var5", 3),
            (val_add, ":var3", ":var7"),
            (val_add, "$team3_size", 1),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team0_size", 0),
          (team_get_leader, ":var8", 0),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_faction_of_troop, "$team0_faction", ":var9"),
          (else_try),
            (store_mul, "$team0_faction", ":var0", 10),
            (val_div, "$team0_faction", "$team0_size"),
            (val_add, "$team0_faction", 5),
            (val_div, "$team0_faction", 10),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team1_size", 0),
          (team_get_leader, ":var8", 1),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_faction_of_troop, "$team1_faction", ":var9"),
          (else_try),
            (store_mul, "$team1_faction", ":var1", 10),
            (val_div, "$team1_faction", "$team1_size"),
            (val_add, "$team1_faction", 5),
            (val_div, "$team1_faction", 10),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team2_size", 0),
          (team_get_leader, ":var8", 2),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_faction_of_troop, "$team2_faction", ":var9"),
          (else_try),
            (store_mul, "$team2_faction", ":var2", 10),
            (val_div, "$team2_faction", "$team2_size"),
            (val_add, "$team2_faction", 5),
            (val_div, "$team2_faction", 10),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team3_size", 0),
          (team_get_leader, ":var8", 3),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_faction_of_troop, "$team3_faction", ":var9"),
          (else_try),
            (store_mul, "$team3_faction", ":var3", 10),
            (val_div, "$team3_faction", "$team3_size"),
            (val_add, "$team3_faction", 5),
            (val_div, "$team3_faction", 10),
          (try_end),
        (try_end),
      (try_end),
      (call_script, "script_battle_pos_init"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_on_agent_hit, 0.3, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (assign, ":var3", reg0),
      (agent_is_human, ":var0"),
      (get_player_agent_no, ":var4"),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var0", ":var4"),
        (store_random_in_range, ":var5", 0, 1000),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 4, 8),
        (troop_get_inventory_slot, ":var7", "trp_player", ":var6"),
        (gt, ":var7", 0),
        (str_store_item_name, s20, ":var7"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var6"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} is too crapy to fall apart!", 0xFF0000),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var7", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var6", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var1", ":var4"),
        (is_between, ":var3", 1, "itm_items_end"),
        (neg|is_between, ":var3", "itm_light_lance", "itm_wooden_shield"),
        (item_get_type, ":var9", ":var3"),
        (ge, ":var2", 10),
        (neq, ":var9", 10),
        (neq, ":var9", 8),
        (neq, ":var9", 9),
        (neq, ":var9", 5),
        (neq, ":var9", 6),
        (store_random_in_range, ":var5", 0, 600),
        (eq, ":var5", 1),
        (assign, ":var10", -1),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var11", "trp_player", ":var6"),
          (eq, ":var11", ":var3"),
          (assign, ":var10", ":var6"),
        (try_end),
        (gt, ":var10", 0),
        (str_store_item_name, s20, ":var3"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var10"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} falls apart!", 0xFF0000),
          (agent_unequip_item, ":var4", ":var3"),
          (troop_remove_item, "trp_player", ":var3"),
          (troop_remove_item, "trp_broken_items", ":var3"),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var3", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var10", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (agent_get_horse, ":var12", ":var1"),
      (try_begin),
        (eq, "$tom_lance_breaking", 1),
        (gt, ":var12", 0),
        (this_or_next|is_between, ":var3", "itm_light_lance", "itm_bamboo_spear"),
        (is_between, ":var3", "itm_crusader_knight_spear_a", "itm_crusader_spear_a"),
        (ge, ":var2", 50),
        (store_random_in_range, ":var13", 0, 100),
        (gt, ":var13", 20),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your lance!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (this_or_next|is_between, ":var3", "itm_bamboo_spear", "itm_staff"),
        (is_between, ":var3", "itm_crusader_spear_a", "itm_mace_6"),
        (le, ":var12", 0),
        (ge, ":var2", 8),
        (store_random_in_range, ":var13", 0, 100),
        (ge, ":var13", 90),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your spear!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (try_begin),
        (store_mission_timer_a, ":var1"),
        (gt, ":var1", 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_place_player_banner_near_inventory_bms"),
      (party_clear, "p_routed_enemies"),
      (assign, "$g_latest_order_1", 1),
      (assign, "$g_latest_order_2", 1),
      (assign, "$g_latest_order_3", 1),
      (assign, "$g_latest_order_4", 1),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (call_script, "script_place_player_banner_near_inventory"),
      (assign, "$g_defender_reinforcement_limit", "$g_reinforcement_waves"),
      (call_script, "script_combat_music_set_situation_with_culture", 1024),
      (assign, "$dmod_current_agent", -1),
      (assign, "$dmod_move_camera", -1),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture", 1024),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 0, 5, 
    [
      (call_script, "script_party_count_members_with_full_health", "p_collective_enemy"),
      (assign, ":var0", reg0),
      (assign, ":var1", 0),
      (try_for_agents, ":var2"),
        (agent_is_human, ":var2"),
        (agent_get_party_id, ":var3", ":var2"),
        (try_begin),
          (neq, ":var3", "p_main_party"),
          (neg|agent_is_ally, ":var2"),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (store_sub, ":var4", ":var0", ":var1"),
      (try_begin),
        (lt, ":var4", 15),
        (ge, "$defender_reinforcement_stage", 2),
        (eq, "$defender_reinforcement_limit_increased", 0),
        (val_add, "$g_defender_reinforcement_limit", 1),
        (assign, "$defender_reinforcement_limit_increased", 1),
      (try_end),
      (lt, "$defender_reinforcement_stage", "$g_defender_reinforcement_limit"),
      (store_mission_timer_a, ":var5"),
      (ge, ":var5", 5),
      (store_normalized_team_count, ":var6", 0),
      (lt, ":var6", 24),
    ],
    [
      (add_reinforcements_to_entry, 0, 28),
      (assign, "$defender_reinforcement_limit_increased", 0),
      (val_add, "$defender_reinforcement_stage", 1),
    ]),

    (1, 0, 5, 
    [
      (lt, "$attacker_reinforcement_stage", "$g_reinforcement_waves"),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
      (store_normalized_team_count, ":var1", 1),
      (lt, ":var1", 24),
    ],
    [
      (add_reinforcements_to_entry, 3, 28),
      (val_add, "$attacker_reinforcement_stage", 1),
    ]),

    (5, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (try_begin),
        (eq, "$auxilary_player_active", 0),
        (call_script, "script_freelancer_keep_field_loot"),
      (try_end),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (assign, "$do_once_3", 0),
      (finish_mission, 1),
    ]),

    (5, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (val_add, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
      (set_mission_result, -1),
      (display_message, "@Battle lost..."),
      (assign, "$g_battle_won", -1),
      (assign, "$g_battle_result", -1),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (assign, "$do_once_3", 0),
      (finish_mission, 0),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", -1),
      (display_message, "@Battle lost! Press tab key to leave..."),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (gt, "$dmod_current_agent", 0),
      (eq, "$setting_use_dmod", 1),
      (eq, "$dmod_move_camera", 1),
      (agent_get_position, pos1, "$dmod_current_agent"),
      (position_move_z, pos1, 300),
      (position_move_y, pos1, -300),
      (agent_get_horse, ":var0", "$dmod_current_agent"),
      (try_begin),
        (ge, ":var0", 0),
      (try_end),
      (mission_cam_set_position, pos1),
      (mission_cam_set_mode, 1),
      (set_fixed_point_multiplier, 100),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_up),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_forwards"),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_down),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_backwards"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 4, ti_once, 
    [
      (eq, "$enable_deahtcam", 1),
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
      (assign, "$tom_sand_storm", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (this_or_next|eq, "$dmod_move_camera", 1),
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, gk_move_forward),
      (this_or_next|game_key_is_down, gk_move_backward),
      (this_or_next|game_key_is_down, gk_move_left),
      (this_or_next|game_key_is_down, gk_move_right),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_backward),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_left),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (position_rotate_x_floating, pos47, ":var7"),
        (position_rotate_y, pos47, 90),
        (position_rotate_x_floating, pos47, ":var3"),
        (position_rotate_y, pos47, -90),
        (position_rotate_x_floating, pos47, "$deathcam_total_rotx"),
        (position_rotate_x_floating, pos47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|eq, ":var0", 0),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "str_enhanced_battle_knocked_out_message_1"),
      (display_message, "str_enhanced_battle_knocked_out_message_2"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (is_presentation_active, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (eq, 0, 1),
      (eq, "$enable_deahtcam", 1),
      (main_hero_fallen),
    ],
    [
      (assign, "$fclock", 1),
      (call_script, "script_player_order_formations", 2),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (team_give_order, ":var1", 9, 2),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (get_player_agent_no, ":var1"),
      (agent_is_human, ":var0"),
      (neq, ":var1", ":var0"),
      (agent_slot_eq, ":var0", 35, 0),
      (agent_is_alive, ":var0"),
      (agent_get_horse, ":var2", ":var0"),
      (agent_slot_eq, ":var0", 15, 0),
      (agent_get_troop_id, ":var3", ":var0"),
      (agent_get_ammo, ":var4", ":var0"),
      (le, ":var4", 0),
      (try_begin),
        (gt, ":var2", 0),
        (neg|troop_is_guarantee_ranged, ":var3"),
        (agent_get_wielded_item, ":var5", ":var0", 0),
        (neg|this_or_next|is_between, ":var5", "itm_light_lance", "itm_bamboo_spear"),
        (neg|is_between, ":var5", "itm_crusader_knight_spear_a", "itm_crusader_spear_a"),
        (try_for_range, ":var6", "itm_light_lance", "itm_bamboo_spear"),
          (agent_set_wielded_item, ":var0", ":var6"),
        (try_end),
        (try_for_range, ":var6", "itm_crusader_knight_spear_a", "itm_crusader_spear_a"),
          (agent_set_wielded_item, ":var0", ":var6"),
        (try_end),
      (else_try),
        (eq, "$tom_use_banners", 1),
        (try_for_range, ":var6", 1291, 1295),
          (agent_set_wielded_item, ":var0", ":var6"),
        (try_end),
        (agent_get_wielded_item, ":var6", ":var0", 0),
        (is_between, ":var6", 1291, 1295),
      (else_try),
        (neg|troop_is_guarantee_ranged, ":var3"),
        (le, ":var2", 0),
        (agent_get_wielded_item, ":var5", ":var0", 0),
        (this_or_next|is_between, ":var5", "itm_light_lance", "itm_bamboo_spear"),
        (is_between, ":var5", "itm_crusader_knight_spear_a", "itm_crusader_spear_a"),
        (try_for_range, reg0, 0, 4),
          (agent_get_item_slot, ":var6", ":var0", reg0),
          (is_between, ":var6", 1, "itm_items_end"),
          (neg|this_or_next|is_between, ":var6", "itm_light_lance", "itm_bamboo_spear"),
          (neg|is_between, ":var6", "itm_crusader_knight_spear_a", "itm_crusader_spear_a"),
          (item_get_type, ":var7", ":var6"),
          (this_or_next|eq, ":var7", 3),
          (this_or_next|eq, ":var7", 4),
          (eq, ":var7", 2),
          (agent_set_wielded_item, ":var0", ":var6"),
        (try_end),
      (else_try),
        (neg|troop_is_guarantee_ranged, ":var3"),
        (le, ":var2", 0),
        (agent_get_wielded_item, ":var5", ":var0", 0),
        (neg|this_or_next|is_between, ":var5", "itm_bamboo_spear", "itm_wooden_shield"),
        (neg|this_or_next|0, ":var5", "itm_modded_war_spear"),
        (neg|is_between, ":var5", "itm_crusader_spear_a", "itm_mace_6"),
        (try_for_range, ":var6", "itm_bamboo_spear", "itm_wooden_shield"),
          (agent_set_wielded_item, ":var0", ":var6"),
        (try_end),
        (agent_set_wielded_item, ":var0", "itm_modded_war_spear"),
        (try_for_range, ":var6", "itm_crusader_spear_a", "itm_mace_6"),
          (agent_set_wielded_item, ":var0", ":var6"),
        (try_end),
      (else_try),
        (troop_is_guarantee_ranged, ":var3"),
        (agent_get_team, ":var8", ":var0"),
        (agent_get_division, ":var9", ":var0"),
        (team_get_hold_fire_order, ":var10", ":var8", ":var9"),
        (neq, ":var10", 1),
        (is_between, ":var5", 1, "itm_items_end"),
        (item_get_type, ":var11", ":var5"),
        (this_or_next|le, ":var5", -1),
        (this_or_next|neq, ":var11", 10),
        (this_or_next|neq, ":var11", 9),
        (neq, ":var11", 8),
        (call_script, "script_get_closest_enemy_distance_new", ":var0", ":var8", 300),
        (assign, ":var12", reg1),
        (gt, ":var12", 300),
        (assign, ":var13", 4),
        (try_for_range, reg0, 0, ":var13"),
          (agent_get_item_slot, ":var14", ":var0", reg0),
          (is_between, ":var14", 1, "itm_items_end"),
          (item_get_type, ":var11", ":var14"),
          (this_or_next|eq, ":var11", 10),
          (this_or_next|eq, ":var11", 8),
          (eq, ":var11", 9),
          (agent_set_wielded_item, ":var0", ":var14"),
          (assign, ":var13", -1),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$gk_order", 0),
      (assign, "$gk_order_hold_over_there", 0),
      (assign, "$autorotate_at_player", 1),
      (assign, "$fclock", 1),
      (try_for_range, ":var0", 0, 4),
        (try_for_range, ":var1", 84, 93),
          (team_set_slot, ":var0", ":var1", -1),
        (try_end),
      (try_end),
      (neq, "$new_session", 1),
      (call_script, "script_init_item_score"),
      (assign, "$new_session", 1),
    ]),

    (0, 0.4, ti_once, 
    [],
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (call_script, "script_store_battlegroup_data"),
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (agent_get_troop_id, ":var2", ":var0"),
        (store_faction_of_troop, ":var3", ":var2"),
        (team_get_slot, ":var4", ":var1", 1),
        (val_add, ":var4", ":var3"),
        (team_set_slot, ":var1", 1, ":var4"),
      (try_end),
      (try_for_range, ":var5", 0, 4),
        (team_slot_ge, ":var5", 4, 1),
        (team_get_leader, ":var6", ":var5"),
        (try_begin),
          (ge, ":var6", 0),
          (agent_get_troop_id, ":var7", ":var6"),
          (store_faction_of_troop, ":var8", ":var7"),
        (else_try),
          (team_get_slot, ":var9", ":var5", 4),
          (team_get_slot, ":var4", ":var5", 1),
          (store_mul, ":var8", ":var4", 10),
          (val_div, ":var8", ":var9"),
          (val_add, ":var8", 5),
          (val_div, ":var8", 10),
        (try_end),
        (team_set_slot, ":var5", 1, ":var8"),
      (try_end),
      (display_message, "@Forming ranks."),
      (assign, ":var10", 0),
      (try_for_range, ":var11", 0, 9),
        (store_add, ":var12", 84, ":var11"),
        (this_or_next|team_slot_eq, "$fplayer_team_no", ":var12", 2),
        (team_slot_eq, "$fplayer_team_no", ":var12", 5),
        (store_add, ":var12", 12, ":var11"),
        (team_get_slot, reg0, "$fplayer_team_no", ":var12"),
        (lt, ":var10", reg0),
        (assign, ":var10", reg0),
      (try_end),
      (assign, ":var13", 0),
      (try_begin),
        (gt, ":var10", 0),
        (val_mul, ":var10", 2),
        (convert_to_fixed_point, ":var10"),
        (store_sqrt, ":var13", ":var10"),
        (convert_from_fixed_point, ":var13"),
        (val_sub, ":var13", 1),
        (store_mul, reg0, 2, 50),
        (val_add, reg0, 300),
        (val_mul, ":var13", reg0),
        (store_mul, ":var14", 2, 50),
        (val_add, ":var14", 67),
        (val_mul, ":var14", 2),
        (val_sub, ":var13", ":var14"),
        (try_begin),
          (gt, ":var13", 0),
          (agent_get_position, pos49, "$fplayer_agent_no"),
          (copy_position, 2, 49),
          (call_script, "script_team_get_position_of_enemies", 60, "$fplayer_team_no", 9),
          (call_script, "script_point_y_toward_position", 2, 60),
          (position_move_y, pos2, ":var13"),
          (agent_set_position, "$fplayer_agent_no", pos2),
        (try_end),
      (try_end),
    ]),

    (0, 0.3, 0, 
    [
      (game_key_clicked, gk_order_1),
    ],
    [
      (eq, "$gk_order", 23),
      (try_begin),
        (game_key_is_down, gk_order_1),
        (assign, "$gk_order_hold_over_there", 1),
        (assign, "$gk_order", 0),
        (assign, "$holdit", 0),
      (else_try),
        (eq, "$holdit", 1),
        (assign, "$fclock", 1),
        (call_script, "script_player_order_formations", 0),
        (assign, "$gk_order", 0),
        (assign, "$holdit", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_1),
    ],
    [
      (try_begin),
        (neq, "$gk_order", 23),
        (neq, "$gk_order", 24),
        (neq, "$gk_order", 25),
        (assign, "$gk_order", 23),
        (assign, "$holdit", 0),
      (else_try),
        (eq, "$gk_order", 23),
        (assign, "$holdit", 1),
        (call_script, "script_first_formation_member_sound_horn"),
      (else_try),
        (eq, "$gk_order", 24),
        (assign, "$fclock", 1),
        (call_script, "script_player_order_formations", 5),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 25),
        (assign, "$gk_order", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_2),
    ],
    [
      (try_begin),
        (neq, "$gk_order", 23),
        (neq, "$gk_order", 24),
        (neq, "$gk_order", 25),
        (assign, "$gk_order", 24),
      (else_try),
        (eq, "$gk_order", 23),
        (assign, "$fclock", 1),
        (call_script, "script_first_formation_member_sound_horn"),
        (call_script, "script_player_order_formations", 1),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 24),
        (assign, "$fclock", 1),
        (call_script, "script_player_order_formations", 6),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 25),
        (assign, "$gk_order", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_3),
    ],
    [
      (try_begin),
        (neq, "$gk_order", 23),
        (neq, "$gk_order", 24),
        (neq, "$gk_order", 25),
        (assign, "$gk_order", 25),
      (else_try),
        (eq, "$gk_order", 23),
        (assign, "$fclock", 1),
        (call_script, "script_first_formation_member_sound_horn"),
        (call_script, "script_player_order_formations", 2),
        (assign, "$tom_yell_smelly_peasents", 1),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 24),
        (assign, "$fclock", 1),
        (call_script, "script_player_order_formations", 8),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 25),
        (assign, "$gk_order", 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_4),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 0),
        (assign, "$gk_order", 26),
        (start_presentation, "prsnt_order_display"),
      (else_try),
        (eq, "$gk_order", 23),
        (assign, "$fclock", 1),
        (call_script, "script_first_formation_member_sound_horn"),
        (call_script, "script_player_order_formations", 11),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 24),
        (assign, "$fclock", 1),
        (call_script, "script_player_order_formations", 7),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 25),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 26),
        (call_script, "script_division_reset_places"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 12, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (assign, "$fclock", 1),
          (call_script, "script_player_attempt_formation", ":var0", 2),
          (call_script, "script_first_formation_member_sound_horn"),
        (try_end),
        (assign, "$gk_order", 0),
        (start_presentation, "prsnt_order_display"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_5),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 23),
        (assign, "$fclock", 1),
        (call_script, "script_first_formation_member_sound_horn"),
        (call_script, "script_player_order_formations", 14),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 24),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 26),
        (call_script, "script_division_reset_places"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 12, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (assign, "$fclock", 1),
          (call_script, "script_player_attempt_formation", ":var0", 3),
          (call_script, "script_first_formation_member_sound_horn"),
        (try_end),
        (assign, "$gk_order", 0),
        (start_presentation, "prsnt_order_display"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (game_key_clicked, gk_order_6),
    ],
    [
      (try_begin),
        (eq, "$gk_order", 24),
        (assign, "$fclock", 1),
        (call_script, "script_player_order_formations", 4),
        (assign, "$gk_order", 0),
      (else_try),
        (eq, "$gk_order", 26),
        (call_script, "script_division_reset_places"),
        (try_for_range, ":var0", 0, 9),
          (class_is_listening_order, "$fplayer_team_no", ":var0"),
          (store_add, ":var1", 12, ":var0"),
          (team_slot_ge, "$fplayer_team_no", ":var1", 1),
          (assign, "$fclock", 1),
          (call_script, "script_player_attempt_formation", ":var0", 4),
          (call_script, "script_first_formation_member_sound_horn"),
        (try_end),
        (assign, "$gk_order", 0),
        (start_presentation, "prsnt_order_display"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_f7),
    ],
    [
      (eq, "$gk_order", 26),
      (call_script, "script_division_reset_places"),
      (try_for_range, ":var0", 0, 9),
        (class_is_listening_order, "$fplayer_team_no", ":var0"),
        (store_add, ":var1", 12, ":var0"),
        (team_slot_ge, "$fplayer_team_no", ":var1", 1),
        (assign, "$fclock", 1),
        (call_script, "script_player_attempt_formation", ":var0", 5),
        (call_script, "script_first_formation_member_sound_horn"),
      (try_end),
      (assign, "$gk_order", 0),
      (start_presentation, "prsnt_order_display"),
    ]),

    (0, 0, 0, 
    [
      (key_clicked, key_f8),
    ],
    [
      (eq, "$gk_order", 26),
      (assign, "$fclock", 1),
      (call_script, "script_player_order_formations", 2),
      (call_script, "script_first_formation_member_sound_horn"),
      (assign, "$gk_order", 0),
      (start_presentation, "prsnt_order_display"),
    ]),

    (0, 0, 0, 
    [
      (this_or_next|game_key_clicked, gk_infantry_hear),
      (this_or_next|game_key_clicked, gk_archers_hear),
      (this_or_next|game_key_clicked, gk_cavalry_hear),
      (this_or_next|game_key_clicked, gk_group3_hear),
      (this_or_next|game_key_clicked, gk_group4_hear),
      (this_or_next|game_key_clicked, gk_group5_hear),
      (this_or_next|game_key_clicked, gk_group6_hear),
      (this_or_next|game_key_clicked, gk_group7_hear),
      (this_or_next|game_key_clicked, gk_group8_hear),
      (this_or_next|game_key_clicked, gk_reverse_order_group),
      (this_or_next|game_key_clicked, gk_everyone_around_hear),
      (game_key_clicked, gk_everyone_hear),
    ],
    [
      (assign, "$gk_order", 0),
      (start_presentation, "prsnt_order_display"),
    ]),

    (0, 0, 0, 
    [
      (key_is_down, key_escape),
      (is_presentation_active, "prsnt_order_display"),
    ],
    [
      (assign, "$gk_order", 0),
      (presentation_set_duration, 0),
    ]),

    (0.5, 0, 0, 
    [
      (eq, "$gk_order_hold_over_there", 1),
      (neg|game_key_is_down, gk_order_1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (assign, "$fclock", 1),
      (call_script, "script_team_get_position_of_enemies", 60, "$fplayer_team_no", 9),
      (assign, ":var0", 0),
      (try_for_range, ":var1", 0, 9),
        (class_is_listening_order, "$fplayer_team_no", ":var1"),
        (store_add, ":var2", 12, ":var1"),
        (team_slot_ge, "$fplayer_team_no", ":var2", 1),
        (val_add, ":var0", 1),
      (try_end),
      (gt, ":var0", 0),
      (agent_get_position, pos49, "$fplayer_agent_no"),
      (call_script, "script_division_reset_places"),
      (try_for_range, ":var1", 0, 9),
        (class_is_listening_order, "$fplayer_team_no", ":var1"),
        (store_add, ":var2", 12, ":var1"),
        (team_get_slot, ":var3", "$fplayer_team_no", ":var2"),
        (gt, ":var3", 0),
        (store_add, ":var2", 93, ":var1"),
        (team_get_slot, ":var4", "$fplayer_team_no", ":var2"),
        (team_get_order_position, pos2, "$fplayer_team_no", ":var1"),
        (call_script, "script_point_y_toward_position", 2, 60),
        (try_begin),
          (gt, ":var0", 1),
          (agent_set_position, "$fplayer_agent_no", pos2),
          (call_script, "script_player_attempt_formation", ":var1", ":var4"),
        (else_try),
          (neq, ":var4", 0),
          (call_script, "script_set_formation_position", "$fplayer_team_no", ":var1", 2),
          (store_add, ":var2", 102, ":var1"),
          (team_get_slot, ":var5", "$fplayer_team_no", ":var2"),
          (try_begin),
            (store_add, ":var2", 84, ":var1"),
            (team_get_slot, ":var6", "$fplayer_team_no", ":var2"),
            (neq, ":var6", 2),
            (neq, ":var6", 5),
            (call_script, "script_get_centering_amount", ":var4", ":var3", ":var5"),
            (try_begin),
              (eq, ":var6", 1),
              (val_mul, reg0, -1),
              (assign, ":var7", "script_form_archers"),
            (else_try),
              (assign, ":var7", "script_form_infantry"),
            (try_end),
            (position_move_x, 2, reg0),
          (else_try),
            (assign, ":var7", "script_form_cavalry"),
          (try_end),
          (copy_position, 1, 2),
          (call_script, ":var7", "$fplayer_team_no", ":var1", "$fplayer_agent_no", ":var5", ":var4"),
        (try_end),
        (store_add, ":var2", 111, ":var1"),
        (team_set_slot, "$fplayer_team_no", ":var2", 0),
      (try_end),
      (agent_set_position, "$fplayer_agent_no", pos49),
      (assign, "$gk_order_hold_over_there", 0),
    ]),

    (1, 0, 0, 
    [
      (neg|key_is_down, key_f7),
      (neg|key_is_down, key_f8),
      (neg|game_key_is_down, gk_order_1),
      (neg|game_key_is_down, gk_order_2),
      (neg|game_key_is_down, gk_order_3),
      (neg|game_key_is_down, gk_order_4),
      (neg|game_key_is_down, gk_order_5),
      (neg|game_key_is_down, gk_order_6),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (store_mod, ":var0", "$fclock", 5),
      (store_mod, ":var1", "$fclock", 10),
      (try_begin),
        (eq, ":var1", 0),
        (try_for_range, ":var2", 0, 4),
          (try_for_range, ":var3", 0, 9),
            (store_add, ":var4", 84, ":var3"),
            (this_or_next|team_slot_eq, ":var2", ":var4", 4),
            (team_slot_eq, ":var2", ":var4", 5),
            (team_set_slot, ":var2", ":var4", -1),
          (try_end),
        (try_end),
      (try_end),
      (call_script, "script_store_battlegroup_data"),
      (call_script, "script_team_get_position_of_enemies", 60, "$fplayer_team_no", 9),
      (try_begin),
        (eq, reg0, 0),
        (try_for_range, ":var3", 0, 9),
          (call_script, "script_formation_end", "$fplayer_team_no", ":var3"),
        (try_end),
      (else_try),
        (assign, "$autorotate_at_player", 0),
        (call_script, "script_division_reset_places"),
        (try_for_range, ":var3", 0, 9),
          (store_add, ":var4", 12, ":var3"),
          (team_get_slot, ":var5", "$fplayer_team_no", ":var4"),
          (gt, ":var5", 0),
          (try_begin),
            (store_add, ":var4", 111, ":var3"),
            (team_slot_eq, "$fplayer_team_no", ":var4", 1),
            (call_script, "script_battlegroup_place_around_leader", "$fplayer_team_no", ":var3"),
            (team_set_slot, "$fplayer_team_no", ":var4", 1),
          (else_try),
            (eq, ":var0", 0),
            (store_add, ":var4", 93, ":var3"),
            (team_get_slot, ":var6", "$fplayer_team_no", ":var4"),
            (neq, ":var6", 0),
            (team_get_movement_order, reg0, "$fplayer_team_no", ":var3"),
            (neq, reg0, 11),
            (call_script, "script_get_formation_position", 1, "$fplayer_team_no", ":var3"),
            (store_add, ":var4", 102, ":var3"),
            (team_get_slot, ":var7", "$fplayer_team_no", ":var4"),
            (store_add, ":var4", 84, ":var3"),
            (team_get_slot, ":var8", "$fplayer_team_no", ":var4"),
            (try_begin),
              (neq, ":var8", 2),
              (neq, ":var8", 5),
              (position_move_y, pos1, -2000),
            (try_end),
            (call_script, "script_point_y_toward_position", 1, 60),
            (try_begin),
              (neq, ":var8", 2),
              (neq, ":var8", 5),
              (position_move_y, pos1, 2000),
            (try_end),
            (call_script, "script_set_formation_position", "$fplayer_team_no", ":var3", 1),
            (try_begin),
              (neq, ":var8", 2),
              (neq, ":var8", 5),
              (call_script, "script_get_centering_amount", ":var6", ":var5", ":var7"),
              (try_begin),
                (eq, ":var8", 1),
                (val_mul, reg0, -1),
              (try_end),
              (position_move_x, 1, reg0),
            (try_end),
            (try_begin),
              (eq, ":var8", 1),
              (call_script, "script_form_archers", "$fplayer_team_no", ":var3", "$fplayer_agent_no", ":var7", ":var6"),
            (else_try),
              (this_or_next|eq, ":var8", 2),
              (eq, ":var8", 5),
              (call_script, "script_form_cavalry", "$fplayer_team_no", ":var3", "$fplayer_agent_no", ":var7"),
            (else_try),
              (call_script, "script_form_infantry", "$fplayer_team_no", ":var3", "$fplayer_agent_no", ":var7", ":var6"),
            (try_end),
          (try_end),
        (try_end),
        (assign, "$autorotate_at_player", 1),
      (try_end),
      (val_add, "$fclock", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$cur_casualties", 0),
      (assign, "$prev_casualties", 0),
      (assign, "$ranged_clock", 1),
      (assign, "$battle_phase", 1),
      (assign, "$clock_reset", 0),
      (try_for_range, ":var0", 0, 4),
        (team_set_slot, ":var0", 2, 1),
      (try_end),
      (init_position, pos41),
      (init_position, pos42),
      (init_position, pos43),
      (init_position, pos44),
    ]),

    (0, 0.5, ti_once, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 15, 0),
      (try_end),
      (set_fixed_point_multiplier, 100),
      (call_script, "script_battlegroup_get_position", 45, 0, 9),
      (call_script, "script_battlegroup_get_position", 46, 1, 9),
      (call_script, "script_battlegroup_get_position", 47, 2, 9),
      (call_script, "script_battlegroup_get_position", 48, 3, 9),
      (call_script, "script_field_tactics", 1),
    ]),

    (1, 0.5, 0, 
    [],
    [
      (try_begin),
        (call_script, "script_cf_count_casualties"),
        (assign, "$cur_casualties", reg0),
        (assign, "$battle_phase", 3),
      (try_end),
      (set_fixed_point_multiplier, 100),
      (call_script, "script_store_battlegroup_data"),
      (try_begin),
        (ge, "$battle_phase", 3),
        (eq, "$clock_reset", 0),
        (call_script, "script_field_tactics", 1),
        (assign, "$ranged_clock", 0),
        (assign, "$clock_reset", 1),
      (else_try),
        (ge, "$battle_phase", 2),
        (store_mod, reg0, "$ranged_clock", 5),
        (eq, reg0, 0),
        (call_script, "script_field_tactics", 1),
        (team_set_slot, 0, 3, "$defender_reinforcement_stage"),
        (team_set_slot, 1, 3, "$attacker_reinforcement_stage"),
      (else_try),
        (call_script, "script_field_tactics", 0),
      (try_end),
      (try_begin),
        (eq, "$battle_phase", 1),
        (assign, ":var0", 0),
        (try_for_range, ":var1", 0, 4),
          (neq, ":var1", "$fplayer_team_no"),
          (team_slot_ge, ":var1", 4, 1),
          (call_script, "script_battlegroup_get_position", 1, ":var1", 1),
          (team_get_order_position, pos0, ":var1", 1),
          (get_distance_between_positions, reg0, pos0, pos1),
          (gt, reg0, 500),
          (assign, ":var0", 1),
          (try_begin),
            (store_random_in_range, ":var2", 0, 100),
            (lt, ":var2", 15),
            (play_sound_at_position, "snd_horn", pos1),
          (try_end),
        (try_end),
        (eq, ":var0", 0),
        (assign, "$battle_phase", 2),
      (try_end),
      (val_add, "$ranged_clock", 1),
    ]),

    (2, 0, 0, 
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_non_player, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (store_skill_level, ":var2", "skl_horse_archery", ":var1"),
        (ge, ":var2", 4),
      (try_end),
    ],
    [
      (set_fixed_point_multiplier, 1000),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_non_player, ":var0"),
        (neg|agent_slot_eq, ":var0", 1003, 1),
        (agent_get_horse, ":var1", ":var0"),
        (assign, ":var2", -1),
        (try_begin),
          (agent_slot_eq, ":var0", 15, 0),
          (gt, ":var1", -1),
          (agent_get_team, ":var3", ":var0"),
          (agent_get_division, ":var4", ":var0"),
          (team_get_weapon_usage_order, ":var5", ":var3", ":var4"),
          (team_get_movement_order, ":var6", ":var3", ":var4"),
          (team_get_hold_fire_order, ":var7", ":var3", ":var4"),
          (assign, ":var8", 0),
          (assign, ":var9", -1),
          (try_for_range, ":var10", 0, 4),
            (agent_get_item_slot, ":var11", ":var0", ":var10"),
            (gt, ":var11", 0),
            (item_get_type, ":var12", ":var11"),
            (try_begin),
              (eq, ":var12", 10),
              (agent_get_ammo_for_slot, ":var13", ":var0", ":var10"),
              (val_add, ":var8", ":var13"),
            (else_try),
              (this_or_next|eq, ":var12", 8),
              (this_or_next|eq, ":var12", 16),
              (eq, ":var12", 17),
              (assign, ":var9", ":var11"),
            (else_try),
              (this_or_next|eq, ":var12", 2),
              (this_or_next|eq, ":var12", 3),
              (eq, ":var12", 4),
              (assign, ":var2", ":var11"),
            (try_end),
          (try_end),
          (gt, ":var9", -1),
          (neg|item_has_property, ":var9", itp_cant_reload_on_horseback),
          (neg|item_has_property, ":var9", itp_cant_use_on_horseback),
          (agent_get_ammo, ":var14", ":var0", 0),
          (val_sub, ":var14", ":var8"),
          (gt, ":var14", 0),
          (agent_set_slot, ":var0", 1003, 2),
          (neq, ":var7", 1),
          (neq, ":var5", 2),
          (eq, ":var6", 2),
          (agent_get_position, pos50, ":var0"),
          (agent_get_speed, pos31, ":var0"),
          (position_get_y, ":var15", pos31),
          (assign, ":var16", 100000),
          (assign, ":var17", -1),
          (try_for_agents, ":var18"),
            (agent_is_alive, ":var18"),
            (agent_is_human, ":var18"),
            (agent_get_position, pos36, ":var18"),
            (agent_get_team, ":var19", ":var18"),
            (teams_are_enemies, ":var3", ":var19"),
            (get_distance_between_positions, ":var20", pos50, pos36),
            (try_begin),
              (agent_slot_eq, ":var18", 15, 1),
              (val_add, ":var20", 10000),
            (try_end),
            (try_begin),
              (agent_get_horse, ":var21", ":var18"),
              (gt, ":var21", -1),
              (agent_get_speed, pos32, ":var18"),
              (position_get_y, ":var22", pos32),
              (val_sub, ":var22", ":var15"),
              (store_div, ":var23", ":var22", 5),
              (val_max, ":var23", 0),
              (val_add, ":var23", 500),
              (val_sub, ":var20", ":var23"),
            (else_try),
              (agent_get_wielded_item, ":var24", ":var18", 1),
              (le, ":var24", 1),
              (val_sub, ":var20", 500),
            (try_end),
            (lt, ":var20", ":var16"),
            (assign, ":var16", ":var20"),
            (assign, ":var17", ":var18"),
          (try_end),
          (neq, ":var17", -1),
          (agent_get_position, pos51, ":var17"),
          (get_distance_between_positions, ":var25", pos50, pos51),
          (try_begin),
            (agent_slot_eq, ":var17", 15, 0),
            (gt, ":var25", 200),
            (agent_set_wielded_item, ":var0", ":var9"),
          (else_try),
            (le, ":var25", 200),
            (gt, ":var2", -1),
            (agent_set_wielded_item, ":var0", ":var2"),
          (try_end),
          (assign, ":var26", 1000),
          (try_begin),
            (agent_get_wielded_item, ":var24", ":var0", 0),
            (gt, ":var24", 0),
            (item_get_type, ":var27", ":var24"),
            (this_or_next|eq, ":var27", 8),
            (this_or_next|eq, ":var27", 16),
            (eq, ":var27", 17),
            (agent_get_bone_position, pos53, ":var0", 8, 1),
            (agent_get_bone_position, pos54, ":var17", 9, 1),
            (position_has_line_of_sight_to_position, pos53, pos54),
            (agent_set_look_target_agent, ":var0", ":var17"),
            (try_begin),
              (assign, ":var28", 4000),
              (agent_get_attack_action, ":var29", ":var0"),
              (eq, ":var29", 1),
              (try_begin),
                (gt, ":var16", 700),
                (le, ":var16", ":var28"),
                (store_div, ":var26", ":var15", 2000),
                (val_max, ":var26", 0),
              (try_end),
              (eq, ":var27", 8),
              (try_begin),
                (le, ":var25", ":var28"),
                (agent_set_defend_action, ":var0", -2, 1),
                (agent_set_attack_action, ":var0", 3, 0),
              (else_try),
                (gt, ":var25", ":var28"),
                (agent_set_attack_action, ":var0", -2, 1),
                (agent_set_defend_action, ":var0", 3, 1),
              (try_end),
            (else_try),
              (eq, ":var27", 8),
              (le, ":var25", ":var28"),
              (agent_get_combat_state, ":var30", ":var0"),
              (neq, ":var30", 8),
              (agent_set_attack_action, ":var0", 3, 1),
            (try_end),
          (try_end),
          (agent_set_speed_limit, ":var0", ":var26"),
          (try_begin),
            (agent_slot_eq, ":var17", 15, 0),
            (lt, ":var16", 10000),
            (try_begin),
              (get_scene_boundaries, pos2, pos3),
              (position_transform_position_to_local, pos4, pos2, pos50),
              (position_get_x, ":var31", pos4),
              (position_get_y, ":var32", pos4),
              (position_transform_position_to_local, pos4, pos2, pos3),
              (position_get_x, ":var33", pos4),
              (position_get_y, ":var34", pos4),
              (store_sub, ":var35", ":var33", ":var31"),
              (store_sub, ":var36", ":var34", ":var32"),
              (position_transform_position_to_local, pos4, pos50, pos51),
              (position_get_x, ":var37", pos4),
              (position_get_y, ":var38", pos4),
              (assign, ":var39", 0),
              (try_begin),
                (le, ":var16", 1000),
                (assign, ":var39", -78000),
              (else_try),
                (gt, ":var16", 2000),
                (store_sub, ":var39", ":var16", 0),
                (val_mul, ":var39", 5),
                (val_clamp, ":var39", 35000, 90000),
              (try_end),
              (assign, ":var40", 30000),
              (val_min, ":var40", ":var31"),
              (val_min, ":var40", ":var36"),
              (val_min, ":var40", ":var35"),
              (val_min, ":var40", ":var32"),
              (try_begin),
                (lt, ":var40", 30000),
                (agent_slot_eq, ":var17", 15, 0),
                (store_div, ":var41", ":var33", 20),
                (store_div, ":var42", ":var34", 20),
                (position_copy_origin, pos4, pos2),
                (position_move_x, 4, ":var41", 1),
                (position_move_y, pos4, ":var42", 1),
                (get_distance_between_positions, ":var43", pos4, pos50),
                (position_transform_position_to_local, pos4, pos50, pos4),
                (position_get_x, ":var41", pos4),
                (position_get_y, ":var42", pos4),
                (val_mul, ":var41", 100),
                (val_mul, ":var42", 100),
                (val_mul, ":var37", 100),
                (val_mul, ":var38", 100),
                (store_div, ":var44", ":var41", ":var43"),
                (store_div, ":var45", ":var42", ":var43"),
                (store_div, ":var46", ":var37", ":var25"),
                (store_div, ":var47", ":var38", ":var25"),
                (store_acos, ":var48", ":var44"),
                (store_asin, ":var49", ":var45"),
                (store_acos, ":var50", ":var46"),
                (store_asin, ":var51", ":var47"),
                (try_begin),
                  (lt, ":var49", 0),
                  (val_mul, ":var48", -1),
                  (val_add, ":var48", 360000),
                (try_end),
                (try_begin),
                  (lt, ":var51", 0),
                  (val_mul, ":var50", -1),
                  (val_add, ":var50", 360000),
                (try_end),
                (store_sub, ":var52", ":var48", ":var50"),
                (val_sub, ":var52", 270000),
                (val_sub, ":var52", ":var39"),
                (store_add, ":var39", ":var52", ":var39"),
                (try_begin),
                  (lt, ":var48", ":var50"),
                  (val_add, ":var39", 360000),
                (try_end),
                (val_clamp, ":var39", -210000, 15000),
                (agent_set_attack_action, ":var0", -2, 1),
                (agent_set_defend_action, ":var0", 3, 1),
              (try_end),
              (store_cos, ":var53", ":var39"),
              (store_sin, ":var54", ":var39"),
              (store_mul, ":var55", ":var53", ":var38"),
              (store_mul, ":var56", ":var54", ":var37"),
              (store_mul, ":var57", ":var54", ":var38"),
              (store_mul, ":var58", ":var53", ":var37"),
              (store_add, ":var59", ":var55", ":var56"),
              (store_sub, ":var60", ":var57", ":var58"),
              (position_move_x, 50, ":var59", 0),
              (position_move_y, pos50, ":var60", 0),
            (try_end),
            (agent_set_scripted_destination, ":var0", pos50, 1),
          (else_try),
            (agent_clear_scripted_mode, ":var0"),
            (agent_force_rethink, ":var0"),
          (try_end),
        (else_try),
          (try_begin),
            (agent_slot_eq, ":var0", 1003, 0),
            (agent_set_slot, ":var0", 1003, 1),
          (else_try),
            (agent_slot_eq, ":var0", 1003, 2),
            (this_or_next|agent_slot_eq, ":var0", 15, 1),
            (this_or_next|lt, ":var1", 0),
            (this_or_next|eq, ":var14", 0),
            (this_or_next|eq, ":var7", 1),
            (this_or_next|eq, ":var5", 2),
            (neq, ":var6", 2),
            (agent_clear_scripted_mode, ":var0"),
            (agent_set_speed_limit, ":var0", 100),
            (agent_force_rethink, ":var0"),
            (agent_set_slot, ":var0", 1003, 3),
            (this_or_next|eq, ":var7", 1),
            (eq, ":var14", 0),
            (gt, ":var2", -1),
            (agent_set_wielded_item, ":var0", ":var2"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [
      (neg|is_presentation_active, "prsnt_killcount"),
      (neg|is_presentation_active, "prsnt_troop_ratio_bar"),
      (neg|is_presentation_active, "prsnt_killcount_and_troop_ratio_bar"),
    ],
    [
      (try_begin),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 1),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 2),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 3),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
      (call_script, "script_party_count_fit_for_battle", "p_main_party"),
      (assign, "$player_count_alive", reg0),
      (call_script, "script_party_count_fit_for_battle", "p_collective_friends"),
      (store_sub, "$ally_count_alive", reg0, "$player_count_alive"),
      (call_script, "script_party_count_fit_for_battle", "p_collective_enemy"),
      (assign, "$enemy_count_alive", reg0),
    ]),

    (3, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 1),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 2),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 3),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
    ]),

    (0.2, 0, ti_once, 
    [],
    [
      (assign, "$spear_in_position", 0),
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 26, 0),
        (agent_set_slot, ":var0", 27, 0),
        (agent_set_slot, ":var0", 28, 0),
        (agent_set_slot, ":var0", 29, 0),
        (agent_set_slot, ":var0", 30, 0),
      (try_end),
    ]),

    (0.5, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 27),
        (agent_get_slot, ":var2", ":var0", 28),
        (agent_get_slot, ":var3", ":var0", 29),
        (agent_get_position, pos1, ":var0"),
        (position_get_x, ":var4", pos1),
        (position_get_y, ":var5", pos1),
        (position_get_z, ":var6", pos1),
        (position_set_x, pos2, ":var1"),
        (position_set_y, pos2, ":var2"),
        (position_set_z, pos2, ":var3"),
        (position_set_x, pos1, ":var4"),
        (position_set_y, pos1, ":var5"),
        (position_set_z, pos1, ":var6"),
        (agent_get_speed, pos5, ":var0"),
        (call_script, "script_vector_length", 5),
        (assign, ":var7", reg0),
        (agent_set_slot, ":var0", 27, ":var4"),
        (agent_set_slot, ":var0", 28, ":var5"),
        (agent_set_slot, ":var0", 29, ":var6"),
        (agent_set_slot, ":var0", 30, ":var7"),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
      (this_or_next|game_key_clicked, gk_attack),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_move_forward),
      (this_or_next|game_key_clicked, gk_move_backward),
      (this_or_next|game_key_clicked, gk_move_left),
      (this_or_next|game_key_clicked, gk_move_right),
      (this_or_next|game_key_clicked, gk_equip_primary_weapon),
      (this_or_next|game_key_clicked, gk_equip_secondary_weapon),
      (this_or_next|game_key_clicked, gk_action),
      (game_key_clicked, gk_sheath_weapon),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (display_message, "@Releasing spear.", 0x6495ED),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
    ]),

    (0.2, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_get_horse, ":var1", ":var0"),
        (le, ":var1", 0),
        (agent_get_slot, ":var2", ":var0", 26),
        (lt, ":var2", 10),
        (val_add, ":var2", 2),
        (agent_set_slot, ":var0", 26, ":var2"),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_set_animation, ":var0", "anim_spearwall_hold"),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (try_for_agents, ":var2"),
        (agent_is_alive, ":var2"),
        (neq, ":var2", ":var0"),
        (agent_is_human, ":var2"),
        (agent_get_horse, ":var3", ":var2"),
        (le, ":var3", 0),
        (agent_get_slot, ":var4", ":var2", 26),
        (ge, ":var4", 10),
        (agent_get_simple_behavior, ":var5", ":var2"),
        (agent_get_team, ":var6", ":var2"),
        (agent_get_class, ":var7", ":var2"),
        (team_get_movement_order, ":var8", ":var6", ":var7"),
        (assign, ":var9", 0),
        (try_begin),
          (neq, ":var6", ":var1"),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (else_try),
          (this_or_next|eq, ":var8", 0),
          (eq, ":var8", 11),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (this_or_next|eq, ":var5", 4),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (try_end),
        (eq, ":var9", 1),
        (agent_get_troop_id, ":var10", ":var2"),
        (store_proficiency_level, ":var11", ":var10", ca_intelligence),
        (store_character_level, ":var12", ":var10"),
        (ge, ":var12", 12),
        (ge, ":var11", 120),
        (neg|troop_is_mounted, ":var10"),
        (agent_slot_eq, ":var2", 15, 0),
        (assign, ":var9", 0),
        (agent_get_wielded_item, ":var13", ":var2", 0),
        (agent_get_wielded_item, ":var14", ":var2", 1),
        (assign, ":var15", 145),
        (try_begin),
          (this_or_next|is_between, ":var13", "itm_modded_billhook_fork_1", "itm_maul"),
          (is_between, ":var14", "itm_modded_billhook_fork_1", "itm_maul"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_1"),
            (eq, ":var14", "itm_modded_billhook_fork_1"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_2"),
            (eq, ":var14", "itm_modded_billhook_fork_2"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_1"),
            (eq, ":var14", "itm_modded_fauchard_1"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_2"),
            (eq, ":var14", "itm_modded_fauchard_2"),
            (assign, "$spear_dist", 171),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_3"),
            (eq, ":var14", "itm_modded_fauchard_3"),
            (assign, "$spear_dist", 197),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_4"),
            (eq, ":var14", "itm_modded_fauchard_4"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_1"),
            (eq, ":var14", "itm_modded_glaive_1"),
            (assign, "$spear_dist", 169),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_1"),
            (eq, ":var14", "itm_modded_glaive_fork_1"),
            (assign, "$spear_dist", 230),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_2"),
            (eq, ":var14", "itm_modded_glaive_fork_2"),
            (assign, "$spear_dist", 188),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_roundel"),
            (eq, ":var14", "itm_modded_glaive_roundel"),
            (assign, "$spear_dist", 149),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_1"),
            (eq, ":var14", "itm_modded_bill_1"),
            (assign, "$spear_dist", 215),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_2"),
            (eq, ":var14", "itm_modded_bill_2"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_1"),
            (eq, ":var14", "itm_modded_billhook_1"),
            (assign, "$spear_dist", 207),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_2"),
            (eq, ":var14", "itm_modded_billhook_2"),
            (assign, "$spear_dist", 172),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_3"),
            (eq, ":var14", "itm_modded_billhook_3"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_voulge"),
            (eq, ":var14", "itm_modded_voulge"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_spiked_voulge"),
            (eq, ":var14", "itm_modded_spiked_voulge"),
            (assign, "$spear_dist", 182),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_cleaving_voulge"),
            (eq, ":var14", "itm_modded_cleaving_voulge"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_1"),
            (eq, ":var14", "itm_modded_hooked_voulge_1"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_2"),
            (eq, ":var14", "itm_modded_hooked_voulge_2"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_3"),
            (eq, ":var14", "itm_modded_hooked_voulge_3"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_1"),
            (eq, ":var14", "itm_modded_couteau_1"),
            (assign, "$spear_dist", 177),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_2"),
            (eq, ":var14", "itm_modded_couteau_2"),
            (assign, "$spear_dist", 196),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_guisarme"),
            (eq, ":var14", "itm_modded_guisarme"),
            (assign, "$spear_dist", 232),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_assegai"),
            (eq, ":var14", "itm_modded_assegai"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_pike"),
            (eq, ":var14", "itm_modded_pike"),
            (assign, "$spear_dist", 300),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_war_spear"),
            (eq, ":var14", "itm_modded_war_spear"),
            (assign, "$spear_dist", 211),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_glaive"),
          (is_between, ":var14", "itm_glaive"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_glaive"),
            (eq, ":var14", "itm_glaive"),
            (assign, "$spear_dist", 160),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_bill"),
          (is_between, ":var14", "itm_bill"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_bill"),
            (eq, ":var14", "itm_bill"),
            (assign, "$spear_dist", 128),
          (try_end),
        (try_end),
        (eq, ":var9", 1),
        (assign, ":var16", -1),
        (agent_get_position, pos1, ":var2"),
        (try_for_agents, ":var17"),
          (agent_is_alive, ":var17"),
          (neg|agent_is_human, ":var17"),
          (agent_get_rider, ":var18", ":var17"),
          (ge, ":var18", 0),
          (agent_get_team, ":var19", ":var18"),
          (teams_are_enemies, ":var6", ":var19"),
          (agent_get_position, pos2, ":var17"),
          (get_distance_between_positions, ":var20", pos1, pos2),
          (lt, ":var20", ":var15"),
          (neg|position_is_behind_position, pos2, pos1),
          (agent_get_slot, ":var21", ":var17", 30),
          (gt, ":var21", 0),
          (assign, ":var16", ":var17"),
        (try_end),
        (gt, ":var16", -1),
        (agent_play_sound, ":var16", "snd_metal_hit_high_armor_high_damage"),
        (store_agent_hit_points, ":var22", ":var16", 0),
        (store_agent_hit_points, ":var23", ":var16", 1),
        (assign, reg22, ":var21"),
        (val_mul, ":var21", 10),
        (val_sub, ":var22", ":var21"),
        (val_max, ":var22", 0),
        (agent_set_slot, ":var2", 26, 0),
        (agent_get_horse, ":var24", ":var0"),
        (agent_get_position, pos2, ":var16"),
        (agent_set_look_target_position, ":var2", pos2),
        (agent_set_attack_action, ":var2", 0, 0),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_get_troop_id, ":var10", ":var2"),
        (str_store_troop_name, s21, ":var10"),
        (agent_get_troop_id, ":var25", ":var16"),
        (str_store_troop_name, s20, ":var25"),
        (store_agent_hit_points, ":var22", ":var16", 1),
        (val_sub, ":var23", ":var22"),
        (assign, reg1, ":var23"),
        (try_begin),
          (eq, ":var16", ":var24"),
          (display_message, "@Your horse received {reg1} damage from a braced polearm!", 0xFF4040),
        (try_end),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (store_agent_hit_points, ":var1", ":var0", 1),
      (lt, ":var1", "$spear_hp"),
      (display_message, "@The injury causes your grip on the polearm to slip!", 0xFF4040),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 26),
      (ge, ":var1", 10),
      (assign, ":var2", -1),
      (agent_get_position, pos1, ":var0"),
      (try_for_agents, ":var3"),
        (agent_is_alive, ":var3"),
        (neg|agent_is_human, ":var3"),
        (agent_get_rider, ":var4", ":var3"),
        (ge, ":var4", 0),
        (neg|agent_is_ally, ":var4"),
        (agent_get_position, pos2, ":var3"),
        (get_distance_between_positions, ":var5", pos1, pos2),
        (lt, ":var5", "$spear_dist"),
        (neg|position_is_behind_position, pos2, pos1),
        (agent_get_slot, ":var6", ":var3", 30),
        (ge, ":var6", 120),
        (assign, ":var2", ":var3"),
      (try_end),
      (gt, ":var2", -1),
      (agent_play_sound, ":var2", "snd_metal_hit_high_armor_high_damage"),
      (store_agent_hit_points, ":var7", ":var2", 0),
      (store_agent_hit_points, ":var8", ":var2", 1),
      (val_div, ":var6", 2),
      (val_sub, ":var6", 15),
      (val_sub, ":var7", ":var6"),
      (val_max, ":var7", 0),
      (agent_set_hit_points, ":var2", ":var7", 0),
      (agent_deliver_damage_to_agent, ":var2", ":var2"),
      (agent_set_slot, ":var0", 26, 0),
      (store_agent_hit_points, ":var7", ":var2", 1),
      (val_sub, ":var8", ":var7"),
      (assign, reg1, ":var8"),
      (display_message, "@Polearm-wall dealt {reg1} damage!"),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 2, 
    [
      (key_clicked, key_b),
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_is_alive, ":var1"),
      (agent_get_wielded_item, ":var2", ":var1", 0),
      (agent_get_wielded_item, ":var3", ":var1", 1),
      (assign, "$spear_dist", 145),
      (try_begin),
        (this_or_next|is_between, ":var2", "itm_modded_billhook_fork_1", "itm_maul"),
        (is_between, ":var3", "itm_modded_billhook_fork_1", "itm_maul"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_1"),
          (eq, ":var3", "itm_modded_billhook_fork_1"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_2"),
          (eq, ":var3", "itm_modded_billhook_fork_2"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_1"),
          (eq, ":var3", "itm_modded_fauchard_1"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_2"),
          (eq, ":var3", "itm_modded_fauchard_2"),
          (assign, "$spear_dist", 171),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_3"),
          (eq, ":var3", "itm_modded_fauchard_3"),
          (assign, "$spear_dist", 197),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_4"),
          (eq, ":var3", "itm_modded_fauchard_4"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_1"),
          (eq, ":var3", "itm_modded_glaive_1"),
          (assign, "$spear_dist", 169),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_1"),
          (eq, ":var3", "itm_modded_glaive_fork_1"),
          (assign, "$spear_dist", 230),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_2"),
          (eq, ":var3", "itm_modded_glaive_fork_2"),
          (assign, "$spear_dist", 188),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_roundel"),
          (eq, ":var3", "itm_modded_glaive_roundel"),
          (assign, "$spear_dist", 149),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_1"),
          (eq, ":var3", "itm_modded_bill_1"),
          (assign, "$spear_dist", 215),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_2"),
          (eq, ":var3", "itm_modded_bill_2"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_1"),
          (eq, ":var3", "itm_modded_billhook_1"),
          (assign, "$spear_dist", 207),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_2"),
          (eq, ":var3", "itm_modded_billhook_2"),
          (assign, "$spear_dist", 172),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_3"),
          (eq, ":var3", "itm_modded_billhook_3"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_voulge"),
          (eq, ":var3", "itm_modded_voulge"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_spiked_voulge"),
          (eq, ":var3", "itm_modded_spiked_voulge"),
          (assign, "$spear_dist", 182),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_cleaving_voulge"),
          (eq, ":var3", "itm_modded_cleaving_voulge"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_1"),
          (eq, ":var3", "itm_modded_hooked_voulge_1"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_2"),
          (eq, ":var3", "itm_modded_hooked_voulge_2"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_3"),
          (eq, ":var3", "itm_modded_hooked_voulge_3"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_1"),
          (eq, ":var3", "itm_modded_couteau_1"),
          (assign, "$spear_dist", 177),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_2"),
          (eq, ":var3", "itm_modded_couteau_2"),
          (assign, "$spear_dist", 196),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_guisarme"),
          (eq, ":var3", "itm_modded_guisarme"),
          (assign, "$spear_dist", 232),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_assegai"),
          (eq, ":var3", "itm_modded_assegai"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_pike"),
          (eq, ":var3", "itm_modded_pike"),
          (assign, "$spear_dist", 300),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_war_spear"),
          (eq, ":var3", "itm_modded_war_spear"),
          (assign, "$spear_dist", 211),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_glaive"),
        (is_between, ":var3", "itm_glaive"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_glaive"),
          (eq, ":var3", "itm_glaive"),
          (assign, "$spear_dist", 160),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_bill"),
        (is_between, ":var3", "itm_bill"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_bill"),
          (eq, ":var3", "itm_bill"),
          (assign, "$spear_dist", 128),
        (try_end),
      (try_end),
      (eq, ":var0", 1),
      (agent_get_horse, ":var4", ":var1"),
      (le, ":var4", 0),
      (neq, "$spear_in_position", 1),
      (display_message, "@Bracing polearm for charge.", 0x6495ED),
      (agent_set_animation, ":var1", "anim_spearwall_hold"),
      (assign, "$spear_in_position", 1),
      (store_agent_hit_points, "$spear_hp", ":var1", 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 41, ":var0"),
    ]),

    (0, 0, 3, 
    [
      (key_clicked, key_h),
    ],
    [
      (agent_get_slot, ":var0", "$fplayer_agent_no", 41),
      (gt, ":var0", 0),
      (agent_is_active, ":var0"),
      (agent_get_horse, reg0, "$fplayer_agent_no"),
      (eq, reg0, -1),
      (agent_play_sound, "$fplayer_agent_no", "snd_man_breath_hard"),
      (display_message, "@You whistle for your horse."),
      (agent_is_alive, ":var0"),
      (agent_get_position, pos1, "$fplayer_agent_no"),
      (agent_set_scripted_destination, ":var0", pos1, 0),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_2, ":var0"),
      (ge, ":var0", 0),
      (item_get_type, ":var1", ":var0"),
      (this_or_next|eq, ":var1", 8),
      (eq, ":var1", 9),
      (store_trigger_param_1, ":var2"),
      (agent_is_active, ":var2"),
      (agent_is_alive, ":var2"),
      (agent_is_non_player, ":var2"),
      (agent_get_ammo, ":var3", ":var2", 0),
      (le, ":var3", 0),
      (agent_get_horse, ":var4", ":var2"),
      (eq, ":var4", -1),
      (assign, ":var5", 1),
      (try_begin),
        (this_or_next|party_slot_eq, "$g_encountered_party", 0, 3),
        (party_slot_eq, "$g_encountered_party", 0, 2),
        (agent_get_team, ":var6", ":var2"),
        (this_or_next|eq, ":var6", "$defender_team"),
        (eq, ":var6", "$defender_team_2"),
        (assign, ":var5", 0),
      (try_end),
      (eq, ":var5", 1),
      (agent_set_division, ":var2", 4),
      (agent_set_slot, ":var2", 42, 4),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_slot, ":var0", 42, -1),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_active, ":var0"),
        (agent_slot_ge, ":var0", 42, 0),
        (agent_is_alive, ":var0"),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 42, ":var1"),
        (agent_get_slot, ":var2", ":var0", 42),
        (agent_set_division, ":var0", ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_slot, ":var0", 42, -1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (neg|agent_is_human, ":var0"),
        (agent_get_rider, ":var1", ":var0"),
        (ge, ":var1", 0),
        (agent_is_active, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_is_non_player, ":var1"),
      (else_try),
        (assign, ":var1", -1),
      (try_end),
      (agent_set_slot, ":var0", 41, ":var1"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (neg|agent_is_human, ":var0"),
      (agent_get_slot, ":var1", ":var0", 41),
      (ge, ":var1", 0),
      (agent_is_active, ":var1"),
      (agent_is_alive, ":var1"),
      (try_begin),
        (assign, ":var2", 70),
        (agent_get_troop_id, ":var3", ":var1"),
        (store_skill_level, ":var4", "skl_riding", ":var3"),
        (store_mul, ":var5", ":var4", 5),
        (val_sub, ":var2", ":var5"),
        (call_script, "script_rand", 0, 100),
        (le, reg0, ":var2"),
        (call_script, "script_rand", 60, 80),
        (assign, ":var6", reg0),
        (store_mul, ":var7", ":var4", 7),
        (val_sub, ":var6", ":var7"),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var6"),
        (try_begin),
          (neg|agent_is_non_player, ":var1"),
          (display_message, "@You fall down from your horse and sustain some damage!"),
        (try_end),
      (try_end),
      (try_begin),
        (agent_is_active, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_set_division, ":var1", 0),
        (agent_set_slot, ":var1", 42, 0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_active, ":var0"),
        (agent_slot_ge, ":var0", 42, 0),
        (agent_is_alive, ":var0"),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 42, ":var1"),
        (agent_get_slot, ":var2", ":var0", 42),
        (agent_set_division, ":var0", ":var2"),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (call_script, "script_lance_use_classify_agent"),
    ]),

    (2, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 43),
        (gt, ":var1", 0),
        (agent_get_wielded_item, ":var2", ":var0", 0),
        (agent_get_horse, ":var3", ":var0"),
        (try_begin),
          (le, ":var3", 0),
          (agent_set_slot, ":var0", 43, 0),
          (eq, ":var2", ":var1"),
          (call_script, "script_lance_use_backup_weapon", ":var0"),
        (else_try),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var4", ":var0"),
          (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":var4", 1),
          (assign, ":var5", reg0),
          (try_begin),
            (lt, ":var5", 500),
            (agent_get_combat_state, ":var6", ":var0"),
            (gt, ":var6", 3),
            (eq, ":var2", ":var1"),
            (call_script, "script_lance_use_backup_weapon", ":var0"),
          (else_try),
            (neq, ":var2", ":var1"),
            (agent_set_wielded_item, ":var0", ":var1"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$tom_sand_storm", 0),
      (call_script, "script_change_rain_or_snow"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$tom_sand_storm", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (position_set_z_to_ground_level, pos0),
      (position_get_z, ":var1", pos0),
      (val_add, ":var1", 400),
      (position_set_z, pos0, ":var1"),
      (particle_system_burst, "psys_desert_storm", pos0, 2),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 2, ti_once, 
    [
      (eq, "$tom_use_banners", 1),
    ],
    [
      (call_script, "script_set_flag_carriers"),
    ]),

    (10, 0, 0, 
    [
      (eq, "$tom_use_banners", 1),
      (eq, "$tom_bonus_banners", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_range, ":var1"),
        (agent_slot_eq, ":var1", 40, 1),
        (agent_is_alive, ":var1"),
        (agent_is_active, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (agent_get_position, pos1, ":var1"),
        (try_for_range, ":var3"),
          (neq, ":var3", ":var1"),
          (agent_get_team, ":var4", ":var3"),
          (eq, ":var2", ":var4"),
          (agent_is_alive, ":var3"),
          (agent_is_active, ":var3"),
          (agent_is_human, ":var3"),
          (agent_get_position, pos2, ":var3"),
          (get_distance_between_positions_in_meters, ":var5", pos1, pos2),
          (le, ":var5", 10),
          (store_agent_hit_points, ":var6", ":var3"),
          (val_add, ":var6", 2),
          (val_min, ":var6", 101),
          (agent_set_hit_points, ":var3", ":var6"),
          (try_begin),
            (eq, ":var3", ":var0"),
            (display_message, "@You feel secured standing near the banner, healing some of your HP.", 0x6495ED),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var1", ":var0"),
      (agent_is_alive, ":var1"),
      (agent_get_wielded_item, ":var7", ":var1", 0),
      (is_between, ":var7", 1291, 1295),
      (agent_get_team, ":var2", ":var1"),
      (agent_get_position, pos1, ":var1"),
      (try_for_range, ":var3"),
        (neq, ":var3", ":var1"),
        (agent_get_team, ":var4", ":var3"),
        (eq, ":var2", ":var4"),
        (agent_is_alive, ":var3"),
        (agent_is_active, ":var3"),
        (agent_is_human, ":var3"),
        (agent_get_position, pos2, ":var3"),
        (get_distance_between_positions_in_meters, ":var5", pos1, pos2),
        (le, ":var5", 10),
        (store_agent_hit_points, ":var6", ":var3"),
        (try_begin),
          (eq, ":var7", 1294),
          (val_add, ":var6", 1),
        (try_end),
        (val_add, ":var6", 5),
        (val_max, ":var6", 101),
        (agent_set_hit_points, ":var3", ":var6"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$tom_sand_storm", 3),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (position_set_z_to_ground_level, pos0),
      (position_get_z, ":var1", pos0),
      (val_add, ":var1", 2100),
      (position_set_z, pos0, ":var1"),
      (particle_system_burst, "psys_rain", pos0, 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 0, 
    [
      (eq, "$tom_sand_storm", 2),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (position_set_z_to_ground_level, pos0),
      (position_get_z, ":var1", pos0),
      (val_add, ":var1", 2000),
      (position_set_z, pos0, ":var1"),
      (particle_system_burst, "psys_blizzard", pos0, 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (8, 0, 0, 
    [
      (eq, "$tom_sand_storm", 3),
    ],
    [
      (store_random_in_range, ":var0", 0, 100),
      (try_begin),
        (ge, ":var0", 90),
        (play_sound, "snd_thunder"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (eq, "$tom_sand_storm", 2),
    ],
    [
      (play_sound, "snd_wind"),
    ]),

    (0, 0, ti_once, 
    [
      (eq, "$tom_sand_storm", 1),
    ],
    [
      (play_sound, "snd_wind"),
    ]),

    (0, 1.5, 0, 
    [
      (key_clicked, key_t),
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_set_animation, ":var0", "anim_cheer", 1),
      (agent_play_sound, ":var0", "snd_man_victory"),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_position, pos1, ":var0"),
      (try_for_agents, ":var2"),
        (agent_is_alive, ":var2"),
        (agent_is_human, ":var2"),
        (agent_get_team, ":var3", ":var2"),
        (eq, ":var3", ":var1"),
        (agent_get_position, pos0, ":var2"),
        (get_distance_between_positions_in_meters, ":var4", pos0, pos1),
        (lt, ":var4", 20),
        (agent_set_animation, ":var2", "anim_cheer", 1),
        (agent_play_sound, ":var2", "snd_man_victory"),
        (agent_get_slot, ":var5", ":var2", 16),
        (val_add, ":var5", 5),
        (val_min, ":var5", 9600),
        (agent_set_slot, ":var2", 16, ":var5"),
      (try_end),
      (display_message, "@Huzzah! You encourage your nearby troops."),
    ]),

    (0, 1.7, 0, 
    [
      (eq, "$tom_yell_smelly_peasents", 1),
    ],
    [
      (call_script, "script_tom_command_cheer"),
      (assign, "$tom_yell_smelly_peasents", 0),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (neg|agent_is_ally, ":var0"),
      (agent_is_human, ":var0"),
      (eq, ":var1", "$fplayer_agent_no"),
      (val_add, "$killcount", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_clear_troop_array", "trp_lances_troop_in_combat", 0, "$lance_troop_serving"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_is_human, ":var0"),
      (get_player_agent_no, ":var1"),
      (neq, ":var0", ":var1"),
      (agent_get_party_id, ":var2", ":var0"),
      (eq, ":var2", "p_main_party"),
      (agent_get_troop_id, ":var3", ":var0"),
      (call_script, "script_search_for_troop", ":var3"),
      (agent_set_slot, ":var0", 102, reg0),
    ]),

    (0, 0, ti_once, 
    [
      (eq, "$tom_generate_desertv2", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (assign, "$tom_generate_desertv2", 0),
      (get_scene_boundaries, pos1, pos0),
      (position_get_x, ":var0", pos0),
      (position_get_y, ":var1", pos0),
      (position_get_x, ":var2", pos1),
      (position_get_y, ":var3", pos1),
      (val_div, ":var0", 2),
      (val_div, ":var1", 2),
      (val_max, "$tom_generate_reduction", 1),
      (assign, ":var4", 500),
      (val_div, ":var4", "$tom_generate_reduction"),
      (try_for_range, reg10, 0, ":var4"),
        (store_random_in_range, ":var5", ":var2", ":var0"),
        (store_random_in_range, ":var6", ":var3", ":var1"),
        (val_mul, ":var5", 2),
        (val_mul, ":var6", 2),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z_to_ground_level, pos1),
        (position_get_z, ":var7", pos1),
        (position_set_z, pos1, ":var7"),
        (store_random_in_range, ":var8", 0, 360),
        (position_rotate_z, pos1, ":var8"),
        (set_spawn_position, pos1),
        (store_random_in_range, ":var9", 15, 66),
        (store_random_in_range, ":var10", 15, 66),
        (store_random_in_range, ":var11", 30, 66),
        (store_random_in_range, ":var12", "spr_valleyRock_flatRounded_small_1", "spr_tree_14_a"),
        (spawn_scene_prop, ":var12"),
        (prop_instance_set_scale, reg0, ":var9", ":var10", ":var11"),
      (try_end),
      (val_max, "$tom_generate_reduction", 1),
      (assign, ":var4", 900),
      (val_div, ":var4", "$tom_generate_reduction"),
      (try_for_range, reg10, 0, ":var4"),
        (store_random_in_range, ":var5", ":var2", ":var0"),
        (store_random_in_range, ":var6", ":var3", ":var1"),
        (val_mul, ":var5", 2),
        (val_mul, ":var6", 2),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z_to_ground_level, pos1),
        (position_get_z, ":var7", pos1),
        (ge, ":var7", 1),
        (store_random_in_range, ":var8", 0, 360),
        (position_rotate_z, pos1, ":var8"),
        (set_spawn_position, pos1),
        (store_random_in_range, ":var12", "spr_seedy_plant_a", "spr_palm_aa"),
        (spawn_scene_prop, ":var12"),
      (try_end),
      (val_max, "$tom_generate_reduction", 1),
      (assign, ":var4", 250),
      (val_div, ":var4", "$tom_generate_reduction"),
      (try_for_range, reg10, 0, ":var4"),
        (store_random_in_range, ":var5", ":var2", ":var0"),
        (store_random_in_range, ":var6", ":var3", ":var1"),
        (val_mul, ":var5", 2),
        (val_mul, ":var6", 2),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z_to_ground_level, pos1),
        (position_get_z, ":var7", pos1),
        (ge, ":var7", 1),
        (store_random_in_range, ":var8", 0, 360),
        (position_rotate_z, pos1, ":var8"),
        (set_spawn_position, pos1),
        (store_random_in_range, ":var12", "spr_palm_aa", "spr_valleyRock_flatRounded_small_1"),
        (spawn_scene_prop, ":var12"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (eq, "$tom_generate_iberian", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (assign, "$tom_generate_iberian", 0),
      (get_scene_boundaries, pos1, pos0),
      (position_get_x, ":var0", pos0),
      (position_get_y, ":var1", pos0),
      (position_get_x, ":var2", pos1),
      (position_get_y, ":var3", pos1),
      (val_div, ":var0", 2),
      (val_div, ":var1", 2),
      (val_max, "$tom_generate_reduction", 1),
      (assign, ":var4", 130),
      (val_div, ":var4", "$tom_generate_reduction"),
      (try_for_range, reg10, 0, ":var4"),
        (store_random_in_range, ":var5", ":var2", ":var0"),
        (store_random_in_range, ":var6", ":var3", ":var1"),
        (val_mul, ":var5", 2),
        (val_mul, ":var6", 2),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z_to_ground_level, pos1),
        (position_get_z, ":var7", pos1),
        (ge, ":var7", 1),
        (store_random_in_range, ":var8", 0, 360),
        (position_rotate_z, pos1, ":var8"),
        (set_spawn_position, pos1),
        (store_random_in_range, ":var9", 40, 100),
        (store_random_in_range, ":var10", "spr_desert_tree_aa", "spr_tree_16_a"),
        (spawn_scene_prop, ":var10"),
        (prop_instance_set_scale, reg0, ":var9", ":var9", ":var9"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (eq, "$tom_generate_iberian2", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (assign, "$tom_generate_iberian2", 0),
      (get_scene_boundaries, pos1, pos0),
      (position_get_x, ":var0", pos0),
      (position_get_y, ":var1", pos0),
      (position_get_x, ":var2", pos1),
      (position_get_y, ":var3", pos1),
      (val_div, ":var0", 2),
      (val_div, ":var1", 2),
      (val_max, "$tom_generate_reduction", 1),
      (assign, ":var4", 300),
      (val_div, ":var4", "$tom_generate_reduction"),
      (try_for_range, reg10, 0, ":var4"),
        (store_random_in_range, ":var5", ":var2", ":var0"),
        (store_random_in_range, ":var6", ":var3", ":var1"),
        (val_mul, ":var5", 2),
        (val_mul, ":var6", 2),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z_to_ground_level, pos1),
        (position_get_z, ":var7", pos1),
        (ge, ":var7", 1),
        (store_random_in_range, ":var8", 0, 360),
        (position_rotate_z, pos1, ":var8"),
        (set_spawn_position, pos1),
        (store_random_in_range, ":var9", "spr_tree_16_a", "spr_pine_1_b"),
        (spawn_scene_prop, ":var9"),
      (try_end),
      (val_max, "$tom_generate_reduction", 1),
      (assign, ":var4", 20),
      (val_div, ":var4", "$tom_generate_reduction"),
      (try_for_range, reg10, 0, ":var4"),
        (store_random_in_range, ":var5", ":var2", ":var0"),
        (store_random_in_range, ":var6", ":var3", ":var1"),
        (val_mul, ":var5", 2),
        (val_mul, ":var6", 2),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z_to_ground_level, pos1),
        (position_get_z, ":var7", pos1),
        (ge, ":var7", 1),
        (store_random_in_range, ":var8", 0, 360),
        (position_rotate_z, pos1, ":var8"),
        (set_spawn_position, pos1),
        (store_random_in_range, ":var9", "spr_pine_1_b", "spr_seedy_plant_a"),
        (spawn_scene_prop, ":var9"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (eq, "$tom_generate_desert", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (assign, "$tom_generate_desert", 0),
      (get_scene_boundaries, pos1, pos0),
      (position_get_x, ":var0", pos0),
      (position_get_y, ":var1", pos0),
      (position_get_x, ":var2", pos1),
      (position_get_y, ":var3", pos1),
      (val_div, ":var0", 2),
      (val_div, ":var1", 2),
      (val_max, "$tom_generate_reduction", 1),
      (assign, ":var4", 1300),
      (val_div, ":var4", "$tom_generate_reduction"),
      (try_for_range, reg10, 0, ":var4"),
        (store_random_in_range, ":var5", ":var2", ":var0"),
        (store_random_in_range, ":var6", ":var3", ":var1"),
        (val_mul, ":var5", 2),
        (val_mul, ":var6", 2),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z_to_ground_level, pos1),
        (position_get_z, ":var7", pos1),
        (position_set_z, pos1, ":var7"),
        (store_random_in_range, ":var8", 0, 360),
        (position_rotate_z, pos1, ":var8"),
        (set_spawn_position, pos1),
        (store_random_in_range, ":var9", 15, 56),
        (store_random_in_range, ":var10", 15, 56),
        (store_random_in_range, ":var11", 20, 56),
        (store_random_in_range, ":var12", "spr_valleyRock_flatRounded_small_1", "spr_tree_14_a"),
        (spawn_scene_prop, ":var12"),
        (prop_instance_set_scale, reg0, ":var9", ":var10", ":var11"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (eq, "$tom_generate_swamp", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (assign, "$tom_generate_swamp", 0),
      (get_scene_boundaries, pos1, pos0),
      (position_get_x, ":var0", pos0),
      (position_get_y, ":var1", pos0),
      (position_get_x, ":var2", pos1),
      (position_get_y, ":var3", pos1),
      (val_div, ":var0", 2),
      (val_div, ":var1", 2),
      (val_max, "$tom_generate_reduction", 1),
      (assign, ":var4", 480),
      (val_div, ":var4", "$tom_generate_reduction"),
      (try_for_range, reg10, 0, ":var4"),
        (store_random_in_range, ":var5", ":var2", ":var0"),
        (store_random_in_range, ":var6", ":var3", ":var1"),
        (val_mul, ":var5", 2),
        (val_mul, ":var6", 2),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z_to_ground_level, pos1),
        (store_random_in_range, ":var7", 0, 360),
        (position_rotate_z, pos1, ":var7"),
        (set_spawn_position, pos1),
        (store_random_in_range, ":var8", "spr_tree_14_a", "spr_tree_8_a"),
        (spawn_scene_prop, ":var8"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (eq, "$tom_generate_euro_hillside", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (assign, "$tom_generate_euro_hillside", 0),
      (get_scene_boundaries, pos1, pos0),
      (position_get_x, ":var0", pos0),
      (position_get_y, ":var1", pos0),
      (position_get_x, ":var2", pos1),
      (position_get_y, ":var3", pos1),
      (val_div, ":var0", 2),
      (val_div, ":var1", 2),
      (val_max, "$tom_generate_reduction", 1),
      (assign, ":var4", 300),
      (val_div, ":var4", "$tom_generate_reduction"),
      (try_for_range, reg10, 0, ":var4"),
        (store_random_in_range, ":var5", ":var2", ":var0"),
        (store_random_in_range, ":var6", ":var3", ":var1"),
        (val_mul, ":var5", 2),
        (val_mul, ":var6", 2),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z_to_ground_level, pos1),
        (position_get_z, ":var7", pos1),
        (lt, ":var7", 1500),
        (position_set_z, pos1, ":var7"),
        (store_random_in_range, ":var8", 0, 360),
        (position_rotate_z, pos1, ":var8"),
        (set_spawn_position, pos1),
        (store_random_in_range, ":var9", 55, 100),
        (store_random_in_range, ":var10", 55, 100),
        (store_random_in_range, ":var11", 55, 100),
        (store_random_in_range, ":var12", "spr_rock1", "spr_desert_tree_aa"),
        (spawn_scene_prop, ":var12"),
        (prop_instance_set_scale, reg0, ":var9", ":var10", ":var11"),
      (try_end),
      (val_max, "$tom_generate_reduction", 1),
      (assign, ":var4", 500),
      (val_div, ":var4", "$tom_generate_reduction"),
      (try_for_range, reg10, 0, ":var4"),
        (store_random_in_range, ":var5", ":var2", ":var0"),
        (store_random_in_range, ":var6", ":var3", ":var1"),
        (val_mul, ":var5", 2),
        (val_mul, ":var6", 2),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z_to_ground_level, pos1),
        (position_get_z, ":var7", pos1),
        (ge, ":var7", 1),
        (store_random_in_range, ":var8", 0, 360),
        (position_rotate_z, pos1, ":var8"),
        (set_spawn_position, pos1),
        (spawn_scene_prop, "spr_seedy_plant_a"),
      (try_end),
      (val_max, "$tom_generate_reduction", 1),
      (assign, ":var4", 300),
      (val_div, ":var4", "$tom_generate_reduction"),
      (try_for_range, reg10, 0, ":var4"),
        (store_random_in_range, ":var5", ":var2", ":var0"),
        (store_random_in_range, ":var6", ":var3", ":var1"),
        (val_mul, ":var5", 2),
        (val_mul, ":var6", 2),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z_to_ground_level, pos1),
        (position_get_z, ":var7", pos1),
        (ge, ":var7", 1),
        (lt, ":var7", 1500),
        (store_random_in_range, ":var8", 0, 360),
        (position_rotate_z, pos1, ":var8"),
        (set_spawn_position, pos1),
        (store_random_in_range, ":var12", "spr_bushes10_a", "spr_bushes10_c"),
        (spawn_scene_prop, ":var12"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (eq, "$tom_generate_desertv3", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (assign, "$tom_generate_desertv3", 0),
      (get_scene_boundaries, pos1, pos0),
      (position_get_x, ":var0", pos0),
      (position_get_y, ":var1", pos0),
      (position_get_x, ":var2", pos1),
      (position_get_y, ":var3", pos1),
      (val_div, ":var0", 2),
      (val_div, ":var1", 2),
      (val_max, "$tom_generate_reduction", 1),
      (assign, ":var4", 900),
      (val_div, ":var4", "$tom_generate_reduction"),
      (try_for_range, reg10, 0, ":var4"),
        (store_random_in_range, ":var5", ":var2", ":var0"),
        (store_random_in_range, ":var6", ":var3", ":var1"),
        (val_mul, ":var5", 2),
        (val_mul, ":var6", 2),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z_to_ground_level, pos1),
        (position_get_z, ":var7", pos1),
        (ge, ":var7", 1),
        (store_random_in_range, ":var8", 0, 360),
        (position_rotate_z, pos1, ":var8"),
        (set_spawn_position, pos1),
        (store_random_in_range, ":var9", "spr_seedy_plant_a", "spr_palm_aa"),
        (spawn_scene_prop, ":var9"),
      (try_end),
      (val_max, "$tom_generate_reduction", 1),
      (assign, ":var4", 400),
      (val_div, ":var4", "$tom_generate_reduction"),
      (try_for_range, reg10, 0, ":var4"),
        (store_random_in_range, ":var5", ":var2", ":var0"),
        (store_random_in_range, ":var6", ":var3", ":var1"),
        (val_mul, ":var5", 2),
        (val_mul, ":var6", 2),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z_to_ground_level, pos1),
        (position_get_z, ":var7", pos1),
        (ge, ":var7", 1),
        (store_random_in_range, ":var8", 0, 360),
        (position_rotate_z, pos1, ":var8"),
        (set_spawn_position, pos1),
        (store_random_in_range, ":var9", "spr_palm_aa", "spr_valleyRock_flatRounded_small_1"),
        (spawn_scene_prop, ":var9"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (ge, "$tom_generate_snow", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (get_scene_boundaries, pos1, pos0),
      (position_get_x, ":var0", pos0),
      (position_get_y, ":var1", pos0),
      (position_get_x, ":var2", pos1),
      (position_get_y, ":var3", pos1),
      (val_div, ":var0", 2),
      (val_div, ":var1", 2),
      (val_max, "$tom_generate_reduction", 1),
      (assign, ":var4", 300),
      (try_begin),
        (eq, "$tom_generate_snow", 2),
        (assign, ":var4", 500),
      (try_end),
      (assign, "$tom_generate_snow", 0),
      (val_div, ":var4", "$tom_generate_reduction"),
      (try_for_range, reg10, 0, ":var4"),
        (store_random_in_range, ":var5", ":var2", ":var0"),
        (store_random_in_range, ":var6", ":var3", ":var1"),
        (val_mul, ":var5", 2),
        (val_mul, ":var6", 2),
        (position_set_x, pos1, ":var5"),
        (position_set_y, pos1, ":var6"),
        (position_set_z_to_ground_level, pos1),
        (store_random_in_range, ":var7", 0, 360),
        (position_rotate_z, pos1, ":var7"),
        (set_spawn_position, pos1),
        (store_random_in_range, ":var8", "spr_tree_snowy_a", "spr_test_helmet"),
        (spawn_scene_prop, ":var8"),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$enable_deahtcam", 1),
      (assign, "$auxilary_player_active", 0),
      (eq, "$use_player_auxiliary", 1),
      (assign, "$g_move_heroes", 1),
      (party_clear, "p_temp_casualties_3"),
      (call_script, "script_party_add_party", "p_temp_casualties_3", "p_main_party"),
      (set_player_troop, "trp_player"),
      (assign, "$enable_deahtcam", 0),
    ]),

    (5, 0, 0, 
    [
      (eq, "$use_player_auxiliary", 1),
      (eq, "$enable_deahtcam", 0),
      (get_player_agent_no, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (neq, "$freelancer_state", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_division, ":var2", ":var0"),
      (assign, ":var3", 0),
      (try_for_agents, ":var4"),
        (eq, ":var3", 0),
        (agent_is_human, ":var4"),
        (agent_is_alive, ":var4"),
        (agent_get_team, ":var5", ":var4"),
        (agent_get_party_id, ":var6", ":var4"),
        (eq, ":var6", "p_main_party"),
        (agent_get_division, ":var7", ":var0"),
        (agent_get_group, ":var8", ":var0"),
        (eq, ":var1", ":var5"),
        (eq, ":var2", ":var7"),
        (agent_get_troop_id, ":var9", ":var4"),
        (neg|is_between, ":var9", "trp_npc1", "trp_enhanced_rnd_lord_end"),
        (set_player_troop, ":var9"),
        (store_agent_hit_points, ":var10", ":var4", 1),
        (agent_get_position, pos1, ":var4"),
        (position_set_z, pos1, -2000),
        (position_set_x, pos1, 0),
        (position_set_y, pos1, 0),
        (agent_get_position, pos0, ":var4"),
        (set_spawn_position, pos0),
        (agent_get_horse, ":var11", ":var4"),
        (try_begin),
          (gt, ":var11", 0),
          (agent_set_position, ":var11", pos1),
          (remove_agent, ":var11"),
        (try_end),
        (agent_set_position, ":var4", pos1),
        (agent_set_slot, ":var4", 35, 1),
        (agent_get_slot, ":var12", ":var4", 102),
        (remove_agent, ":var4"),
        (spawn_agent, ":var9"),
        (assign, ":var0", reg0),
        (agent_set_slot, ":var0", 102, ":var12"),
        (agent_set_team, ":var0", ":var1"),
        (agent_set_hit_points, ":var0", ":var10", 1),
        (agent_set_group, ":var0", ":var8"),
        (agent_set_slot, ":var0", 35, 2),
        (agent_set_slot, ":var0", 36, ":var9"),
        (try_begin),
          (agent_get_horse, ":var13", ":var0"),
          (gt, ":var13", 0),
          (lt, ":var11", 0),
          (agent_set_position, ":var13", pos1),
          (remove_agent, ":var13"),
        (try_end),
        (set_player_troop, "trp_player"),
        (assign, ":var3", 1),
        (assign, "$auxilary_player_active", 1),
      (try_end),
      (eq, ":var3", 0),
      (assign, "$enable_deahtcam", 1),
    ]),

    (5, 0, 0, 
    [
      (eq, "$use_player_auxiliary", 1),
      (eq, "$enable_deahtcam", 0),
      (get_player_agent_no, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$enable_deahtcam", 1),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$g_decap_enabled", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (agent_is_non_player, ":var0"),
      (agent_get_troop_id, ":var3", ":var0"),
      (neg|troop_is_hero, ":var3"),
      (assign, ":var4", reg0),
      (copy_position, 5, 0),
      (neq, ":var0", -1),
      (try_begin),
        (agent_is_human, ":var0"),
        (ge, ":var4", 0),
        (assign, ":var5", 0),
        (try_begin),
          (this_or_next|eq, ":var4", "itm_supercrossbow"),
          (eq, ":var4", "itm_supersledge"),
          (assign, ":var5", 1),
        (else_try),
          (neq, ":var4", "itm_mace_1"),
          (neq, ":var4", "itm_mace_2"),
          (neq, ":var4", "itm_mace_3"),
          (neq, ":var4", "itm_staff"),
          (agent_get_action_dir, ":var6", ":var1"),
          (this_or_next|eq, ":var6", 1),
          (eq, ":var6", 2),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var5", 0),
        (try_begin),
          (ge, ":var2", "$g_decap_minimum_damage"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap minimum DMG req bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (store_agent_hit_points, ":var7", ":var0", 1),
        (val_add, ":var7", "$g_decap_negative_health"),
        (ge, ":var2", ":var7"),
        (agent_get_position, pos4, ":var0"),
        (get_distance_between_positions, ":var8", pos4, pos5),
        (agent_get_horse, ":var9", ":var0"),
        (try_begin),
          (ge, ":var9", 0),
          (assign, ":var10", 240),
          (assign, ":var11", 260),
        (else_try),
          (assign, ":var10", 160),
          (assign, ":var11", 176),
        (try_end),
        (is_between, ":var8", ":var10", ":var11"),
        (assign, ":var5", 0),
        (try_begin),
          (store_random_in_range, ":var12", 0, 100),
          (le, ":var12", "$g_decap_chance"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap chance calc bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var13", "itm_cut_off_head_male"),
        (agent_get_troop_id, ":var14", ":var0"),
        (try_begin),
          (ge, ":var14", 0),
          (troop_get_type, ":var15", ":var14"),
          (eq, ":var15", 1),
          (assign, ":var13", "itm_cut_off_head_female"),
        (try_end),
        (store_random_in_range, ":var16", 0, 360),
        (store_random_in_range, ":var17", -60, 60),
        (store_random_in_range, ":var18", -90, 90),
        (store_random_in_range, ":var19", -90, 90),
        (position_rotate_z, pos4, ":var16"),
        (position_rotate_y, pos4, ":var17"),
        (position_move_x, 4, ":var18"),
        (position_move_y, pos4, ":var19"),
        (position_set_z_to_ground_level, pos4),
        (position_move_z, pos4, 5),
        (set_spawn_position, pos4),
        (assign, ":var20", 360),
        (agent_get_item_slot, ":var21", ":var0", 4),
        (try_begin),
          (ge, ":var21", 1),
          (agent_unequip_item, ":var0", ":var21"),
          (try_begin),
            (spawn_item, ":var21", 0, ":var20"),
          (try_end),
        (try_end),
        (agent_equip_item, ":var0", "itm_invisible_head"),
        (agent_get_position, pos4, ":var0"),
        (position_move_z, pos4, ":var10"),
        (particle_system_burst, "psys_blood_decapitation", pos4, "$g_decap_psys_blood_decapitation"),
        (particle_system_burst, "psys_game_blood", pos4, "$g_decap_psys_game_blood"),
        (particle_system_burst, "psys_game_blood_2", pos4, "$g_decap_psys_game_blood_2"),
        (play_sound_at_position, "snd_decapitation", pos4),
        (position_move_z, pos4, 20),
        (set_spawn_position, pos4),
        (assign, ":var13", "spr_head_dynamic_male"),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var13", "spr_head_dynamic_female"),
        (try_end),
        (spawn_scene_prop, ":var13"),
        (agent_get_troop_id, ":var22", ":var1"),
        (str_store_troop_name, s0, ":var22"),
        (agent_get_troop_id, ":var14", ":var0"),
        (str_store_troop_name, s1, ":var14"),
        (get_player_agent_no, ":var23"),
        (agent_get_team, ":var24", ":var23"),
        (agent_get_team, ":var25", ":var0"),
        (try_begin),
          (neq, ":var24", ":var25"),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFF33DD11),
        (else_try),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFFFF4422),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_bully_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_fat_peasant_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_thug_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_fatseveredarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_thin_looter_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (0, 0, 1, 
    [
      (key_clicked, key_right_control),
    ],
    [
      (try_begin),
        (key_is_down, key_m),
        (try_begin),
          (eq, "$g_decapitations_debugging", 0),
          (assign, "$g_decapitations_debugging", 1),
          (display_message, "@Decapitation debug mode Enabled"),
        (else_try),
          (assign, "$g_decapitations_debugging", 0),
          (display_message, "@Decapitation debug mode Disabled"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, key_k),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos17, ":var0"),
        (position_move_y, pos17, 2000),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_bully_handless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_thug_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_thin_looter_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_fat_peasant_handless"),
        (agent_set_team, reg0, 2),
      (try_end),
      (try_begin),
        (key_is_down, key_j),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos18, ":var0"),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supersledge"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supercrossbow"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_super_bolts"),
      (try_end),
    ]),

  ]),

  ("village_attack_bandits", mtf_battle_mode, charge,
  "You lead your men to battle.",
  [
    (3, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 4, []),
    (1, mtef_team_0|mtef_use_exact_number, 0, aif_start_alarmed, 28, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 4, []),
  ],
  [
    (ti_on_agent_hit, 0.3, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (assign, ":var3", reg0),
      (agent_is_human, ":var0"),
      (get_player_agent_no, ":var4"),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var0", ":var4"),
        (store_random_in_range, ":var5", 0, 1000),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 4, 8),
        (troop_get_inventory_slot, ":var7", "trp_player", ":var6"),
        (gt, ":var7", 0),
        (str_store_item_name, s20, ":var7"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var6"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} is too crapy to fall apart!", 0xFF0000),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var7", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var6", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var1", ":var4"),
        (is_between, ":var3", 1, "itm_items_end"),
        (neg|is_between, ":var3", "itm_light_lance", "itm_wooden_shield"),
        (item_get_type, ":var9", ":var3"),
        (ge, ":var2", 10),
        (neq, ":var9", 10),
        (neq, ":var9", 8),
        (neq, ":var9", 9),
        (neq, ":var9", 5),
        (neq, ":var9", 6),
        (store_random_in_range, ":var5", 0, 600),
        (eq, ":var5", 1),
        (assign, ":var10", -1),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var11", "trp_player", ":var6"),
          (eq, ":var11", ":var3"),
          (assign, ":var10", ":var6"),
        (try_end),
        (gt, ":var10", 0),
        (str_store_item_name, s20, ":var3"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var10"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} falls apart!", 0xFF0000),
          (agent_unequip_item, ":var4", ":var3"),
          (troop_remove_item, "trp_player", ":var3"),
          (troop_remove_item, "trp_broken_items", ":var3"),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var3", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var10", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (agent_get_horse, ":var12", ":var1"),
      (try_begin),
        (eq, "$tom_lance_breaking", 1),
        (gt, ":var12", 0),
        (this_or_next|is_between, ":var3", "itm_light_lance", "itm_bamboo_spear"),
        (is_between, ":var3", "itm_crusader_knight_spear_a", "itm_crusader_spear_a"),
        (ge, ":var2", 50),
        (store_random_in_range, ":var13", 0, 100),
        (gt, ":var13", 20),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your lance!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (this_or_next|is_between, ":var3", "itm_bamboo_spear", "itm_staff"),
        (is_between, ":var3", "itm_crusader_spear_a", "itm_mace_6"),
        (le, ":var12", 0),
        (ge, ":var2", 8),
        (store_random_in_range, ":var13", 0, 100),
        (ge, ":var13", 90),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your spear!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_agent_reassign_team", ":var0"),
      (assign, ":var1", 5000),
      (agent_get_troop_id, ":var2", ":var0"),
      (store_character_level, ":var3", ":var2"),
      (val_mul, ":var3", 35),
      (val_add, ":var1", ":var3"),
      (store_random_in_range, ":var4", 0, 3000),
      (val_add, ":var1", ":var4"),
      (assign, ":var5", 100),
      (store_sub, ":var6", ":var5", 70),
      (val_mul, ":var6", 30),
      (val_add, ":var1", ":var6"),
      (agent_set_slot, ":var0", 16, ":var1"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var3", ":var0"),
        (party_add_members, "p_total_enemy_casualties", ":var3", 1),
        (eq, ":var2", 1),
        (party_wound_members, "p_total_enemy_casualties", ":var3", 1),
      (try_end),
      (call_script, "script_apply_death_effect_on_courage_scores", ":var0", ":var1"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 10, 20, 1),
      (assign, "$g_battle_result", -1),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (try_begin),
        (eq, "$g_mt_mode", 2),
        (add_reinforcements_to_entry, 1, 6),
      (else_try),
        (add_reinforcements_to_entry, 1, 40),
      (try_end),
      (call_script, "script_combat_music_set_situation_with_culture", 1024),
      (assign, "$dmod_current_agent", -1),
      (assign, "$dmod_move_camera", -1),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture", 1024),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (5, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (try_begin),
        (eq, "$auxilary_player_active", 0),
        (call_script, "script_freelancer_keep_field_loot"),
      (try_end),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (assign, "$do_once_3", 0),
      (finish_mission, 1),
    ]),

    (5, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (val_add, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
      (set_mission_result, -1),
      (display_message, "@Battle lost..."),
      (assign, "$g_battle_won", -1),
      (assign, "$g_battle_result", -1),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (assign, "$do_once_3", 0),
      (finish_mission, 0),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", -1),
      (display_message, "@Battle lost! Press tab key to leave..."),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (gt, "$dmod_current_agent", 0),
      (eq, "$setting_use_dmod", 1),
      (eq, "$dmod_move_camera", 1),
      (agent_get_position, pos1, "$dmod_current_agent"),
      (position_move_z, pos1, 300),
      (position_move_y, pos1, -300),
      (agent_get_horse, ":var0", "$dmod_current_agent"),
      (try_begin),
        (ge, ":var0", 0),
      (try_end),
      (mission_cam_set_position, pos1),
      (mission_cam_set_mode, 1),
      (set_fixed_point_multiplier, 100),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_up),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_forwards"),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_down),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_backwards"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 4, ti_once, 
    [
      (eq, "$enable_deahtcam", 1),
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
      (assign, "$tom_sand_storm", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (this_or_next|eq, "$dmod_move_camera", 1),
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, gk_move_forward),
      (this_or_next|game_key_is_down, gk_move_backward),
      (this_or_next|game_key_is_down, gk_move_left),
      (this_or_next|game_key_is_down, gk_move_right),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_backward),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_left),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (position_rotate_x_floating, pos47, ":var7"),
        (position_rotate_y, pos47, 90),
        (position_rotate_x_floating, pos47, ":var3"),
        (position_rotate_y, pos47, -90),
        (position_rotate_x_floating, pos47, "$deathcam_total_rotx"),
        (position_rotate_x_floating, pos47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|eq, ":var0", 0),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "str_enhanced_battle_knocked_out_message_1"),
      (display_message, "str_enhanced_battle_knocked_out_message_2"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (is_presentation_active, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (team_give_order, ":var1", 9, 0),
      (set_show_messages, 1),
    ]),

    (0, 0, ti_once, 
    [
      (eq, 0, 1),
      (eq, "$enable_deahtcam", 1),
      (main_hero_fallen),
    ],
    [
      (assign, "$fclock", 1),
      (call_script, "script_player_order_formations", 2),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (team_give_order, ":var1", 9, 2),
    ]),

    (2, 0, 0, 
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_non_player, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (store_skill_level, ":var2", "skl_horse_archery", ":var1"),
        (ge, ":var2", 4),
      (try_end),
    ],
    [
      (set_fixed_point_multiplier, 1000),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_non_player, ":var0"),
        (neg|agent_slot_eq, ":var0", 1003, 1),
        (agent_get_horse, ":var1", ":var0"),
        (assign, ":var2", -1),
        (try_begin),
          (agent_slot_eq, ":var0", 15, 0),
          (gt, ":var1", -1),
          (agent_get_team, ":var3", ":var0"),
          (agent_get_division, ":var4", ":var0"),
          (team_get_weapon_usage_order, ":var5", ":var3", ":var4"),
          (team_get_movement_order, ":var6", ":var3", ":var4"),
          (team_get_hold_fire_order, ":var7", ":var3", ":var4"),
          (assign, ":var8", 0),
          (assign, ":var9", -1),
          (try_for_range, ":var10", 0, 4),
            (agent_get_item_slot, ":var11", ":var0", ":var10"),
            (gt, ":var11", 0),
            (item_get_type, ":var12", ":var11"),
            (try_begin),
              (eq, ":var12", 10),
              (agent_get_ammo_for_slot, ":var13", ":var0", ":var10"),
              (val_add, ":var8", ":var13"),
            (else_try),
              (this_or_next|eq, ":var12", 8),
              (this_or_next|eq, ":var12", 16),
              (eq, ":var12", 17),
              (assign, ":var9", ":var11"),
            (else_try),
              (this_or_next|eq, ":var12", 2),
              (this_or_next|eq, ":var12", 3),
              (eq, ":var12", 4),
              (assign, ":var2", ":var11"),
            (try_end),
          (try_end),
          (gt, ":var9", -1),
          (neg|item_has_property, ":var9", itp_cant_reload_on_horseback),
          (neg|item_has_property, ":var9", itp_cant_use_on_horseback),
          (agent_get_ammo, ":var14", ":var0", 0),
          (val_sub, ":var14", ":var8"),
          (gt, ":var14", 0),
          (agent_set_slot, ":var0", 1003, 2),
          (neq, ":var7", 1),
          (neq, ":var5", 2),
          (eq, ":var6", 2),
          (agent_get_position, pos50, ":var0"),
          (agent_get_speed, pos31, ":var0"),
          (position_get_y, ":var15", pos31),
          (assign, ":var16", 100000),
          (assign, ":var17", -1),
          (try_for_agents, ":var18"),
            (agent_is_alive, ":var18"),
            (agent_is_human, ":var18"),
            (agent_get_position, pos36, ":var18"),
            (agent_get_team, ":var19", ":var18"),
            (teams_are_enemies, ":var3", ":var19"),
            (get_distance_between_positions, ":var20", pos50, pos36),
            (try_begin),
              (agent_slot_eq, ":var18", 15, 1),
              (val_add, ":var20", 10000),
            (try_end),
            (try_begin),
              (agent_get_horse, ":var21", ":var18"),
              (gt, ":var21", -1),
              (agent_get_speed, pos32, ":var18"),
              (position_get_y, ":var22", pos32),
              (val_sub, ":var22", ":var15"),
              (store_div, ":var23", ":var22", 5),
              (val_max, ":var23", 0),
              (val_add, ":var23", 500),
              (val_sub, ":var20", ":var23"),
            (else_try),
              (agent_get_wielded_item, ":var24", ":var18", 1),
              (le, ":var24", 1),
              (val_sub, ":var20", 500),
            (try_end),
            (lt, ":var20", ":var16"),
            (assign, ":var16", ":var20"),
            (assign, ":var17", ":var18"),
          (try_end),
          (neq, ":var17", -1),
          (agent_get_position, pos51, ":var17"),
          (get_distance_between_positions, ":var25", pos50, pos51),
          (try_begin),
            (agent_slot_eq, ":var17", 15, 0),
            (gt, ":var25", 200),
            (agent_set_wielded_item, ":var0", ":var9"),
          (else_try),
            (le, ":var25", 200),
            (gt, ":var2", -1),
            (agent_set_wielded_item, ":var0", ":var2"),
          (try_end),
          (assign, ":var26", 1000),
          (try_begin),
            (agent_get_wielded_item, ":var24", ":var0", 0),
            (gt, ":var24", 0),
            (item_get_type, ":var27", ":var24"),
            (this_or_next|eq, ":var27", 8),
            (this_or_next|eq, ":var27", 16),
            (eq, ":var27", 17),
            (agent_get_bone_position, pos53, ":var0", 8, 1),
            (agent_get_bone_position, pos54, ":var17", 9, 1),
            (position_has_line_of_sight_to_position, pos53, pos54),
            (agent_set_look_target_agent, ":var0", ":var17"),
            (try_begin),
              (assign, ":var28", 4000),
              (agent_get_attack_action, ":var29", ":var0"),
              (eq, ":var29", 1),
              (try_begin),
                (gt, ":var16", 700),
                (le, ":var16", ":var28"),
                (store_div, ":var26", ":var15", 2000),
                (val_max, ":var26", 0),
              (try_end),
              (eq, ":var27", 8),
              (try_begin),
                (le, ":var25", ":var28"),
                (agent_set_defend_action, ":var0", -2, 1),
                (agent_set_attack_action, ":var0", 3, 0),
              (else_try),
                (gt, ":var25", ":var28"),
                (agent_set_attack_action, ":var0", -2, 1),
                (agent_set_defend_action, ":var0", 3, 1),
              (try_end),
            (else_try),
              (eq, ":var27", 8),
              (le, ":var25", ":var28"),
              (agent_get_combat_state, ":var30", ":var0"),
              (neq, ":var30", 8),
              (agent_set_attack_action, ":var0", 3, 1),
            (try_end),
          (try_end),
          (agent_set_speed_limit, ":var0", ":var26"),
          (try_begin),
            (agent_slot_eq, ":var17", 15, 0),
            (lt, ":var16", 10000),
            (try_begin),
              (get_scene_boundaries, pos2, pos3),
              (position_transform_position_to_local, pos4, pos2, pos50),
              (position_get_x, ":var31", pos4),
              (position_get_y, ":var32", pos4),
              (position_transform_position_to_local, pos4, pos2, pos3),
              (position_get_x, ":var33", pos4),
              (position_get_y, ":var34", pos4),
              (store_sub, ":var35", ":var33", ":var31"),
              (store_sub, ":var36", ":var34", ":var32"),
              (position_transform_position_to_local, pos4, pos50, pos51),
              (position_get_x, ":var37", pos4),
              (position_get_y, ":var38", pos4),
              (assign, ":var39", 0),
              (try_begin),
                (le, ":var16", 1000),
                (assign, ":var39", -78000),
              (else_try),
                (gt, ":var16", 2000),
                (store_sub, ":var39", ":var16", 0),
                (val_mul, ":var39", 5),
                (val_clamp, ":var39", 35000, 90000),
              (try_end),
              (assign, ":var40", 30000),
              (val_min, ":var40", ":var31"),
              (val_min, ":var40", ":var36"),
              (val_min, ":var40", ":var35"),
              (val_min, ":var40", ":var32"),
              (try_begin),
                (lt, ":var40", 30000),
                (agent_slot_eq, ":var17", 15, 0),
                (store_div, ":var41", ":var33", 20),
                (store_div, ":var42", ":var34", 20),
                (position_copy_origin, pos4, pos2),
                (position_move_x, 4, ":var41", 1),
                (position_move_y, pos4, ":var42", 1),
                (get_distance_between_positions, ":var43", pos4, pos50),
                (position_transform_position_to_local, pos4, pos50, pos4),
                (position_get_x, ":var41", pos4),
                (position_get_y, ":var42", pos4),
                (val_mul, ":var41", 100),
                (val_mul, ":var42", 100),
                (val_mul, ":var37", 100),
                (val_mul, ":var38", 100),
                (store_div, ":var44", ":var41", ":var43"),
                (store_div, ":var45", ":var42", ":var43"),
                (store_div, ":var46", ":var37", ":var25"),
                (store_div, ":var47", ":var38", ":var25"),
                (store_acos, ":var48", ":var44"),
                (store_asin, ":var49", ":var45"),
                (store_acos, ":var50", ":var46"),
                (store_asin, ":var51", ":var47"),
                (try_begin),
                  (lt, ":var49", 0),
                  (val_mul, ":var48", -1),
                  (val_add, ":var48", 360000),
                (try_end),
                (try_begin),
                  (lt, ":var51", 0),
                  (val_mul, ":var50", -1),
                  (val_add, ":var50", 360000),
                (try_end),
                (store_sub, ":var52", ":var48", ":var50"),
                (val_sub, ":var52", 270000),
                (val_sub, ":var52", ":var39"),
                (store_add, ":var39", ":var52", ":var39"),
                (try_begin),
                  (lt, ":var48", ":var50"),
                  (val_add, ":var39", 360000),
                (try_end),
                (val_clamp, ":var39", -210000, 15000),
                (agent_set_attack_action, ":var0", -2, 1),
                (agent_set_defend_action, ":var0", 3, 1),
              (try_end),
              (store_cos, ":var53", ":var39"),
              (store_sin, ":var54", ":var39"),
              (store_mul, ":var55", ":var53", ":var38"),
              (store_mul, ":var56", ":var54", ":var37"),
              (store_mul, ":var57", ":var54", ":var38"),
              (store_mul, ":var58", ":var53", ":var37"),
              (store_add, ":var59", ":var55", ":var56"),
              (store_sub, ":var60", ":var57", ":var58"),
              (position_move_x, 50, ":var59", 0),
              (position_move_y, pos50, ":var60", 0),
            (try_end),
            (agent_set_scripted_destination, ":var0", pos50, 1),
          (else_try),
            (agent_clear_scripted_mode, ":var0"),
            (agent_force_rethink, ":var0"),
          (try_end),
        (else_try),
          (try_begin),
            (agent_slot_eq, ":var0", 1003, 0),
            (agent_set_slot, ":var0", 1003, 1),
          (else_try),
            (agent_slot_eq, ":var0", 1003, 2),
            (this_or_next|agent_slot_eq, ":var0", 15, 1),
            (this_or_next|lt, ":var1", 0),
            (this_or_next|eq, ":var14", 0),
            (this_or_next|eq, ":var7", 1),
            (this_or_next|eq, ":var5", 2),
            (neq, ":var6", 2),
            (agent_clear_scripted_mode, ":var0"),
            (agent_set_speed_limit, ":var0", 100),
            (agent_force_rethink, ":var0"),
            (agent_set_slot, ":var0", 1003, 3),
            (this_or_next|eq, ":var7", 1),
            (eq, ":var14", 0),
            (gt, ":var2", -1),
            (agent_set_wielded_item, ":var0", ":var2"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [
      (neg|is_presentation_active, "prsnt_killcount"),
      (neg|is_presentation_active, "prsnt_troop_ratio_bar"),
      (neg|is_presentation_active, "prsnt_killcount_and_troop_ratio_bar"),
    ],
    [
      (try_begin),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 1),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 2),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 3),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
      (call_script, "script_party_count_fit_for_battle", "p_main_party"),
      (assign, "$player_count_alive", reg0),
      (call_script, "script_party_count_fit_for_battle", "p_collective_friends"),
      (store_sub, "$ally_count_alive", reg0, "$player_count_alive"),
      (call_script, "script_party_count_fit_for_battle", "p_collective_enemy"),
      (assign, "$enemy_count_alive", reg0),
    ]),

    (3, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 1),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 2),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 3),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
    ]),

    (0.2, 0, ti_once, 
    [],
    [
      (assign, "$spear_in_position", 0),
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 26, 0),
        (agent_set_slot, ":var0", 27, 0),
        (agent_set_slot, ":var0", 28, 0),
        (agent_set_slot, ":var0", 29, 0),
        (agent_set_slot, ":var0", 30, 0),
      (try_end),
    ]),

    (0.5, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 27),
        (agent_get_slot, ":var2", ":var0", 28),
        (agent_get_slot, ":var3", ":var0", 29),
        (agent_get_position, pos1, ":var0"),
        (position_get_x, ":var4", pos1),
        (position_get_y, ":var5", pos1),
        (position_get_z, ":var6", pos1),
        (position_set_x, pos2, ":var1"),
        (position_set_y, pos2, ":var2"),
        (position_set_z, pos2, ":var3"),
        (position_set_x, pos1, ":var4"),
        (position_set_y, pos1, ":var5"),
        (position_set_z, pos1, ":var6"),
        (agent_get_speed, pos5, ":var0"),
        (call_script, "script_vector_length", 5),
        (assign, ":var7", reg0),
        (agent_set_slot, ":var0", 27, ":var4"),
        (agent_set_slot, ":var0", 28, ":var5"),
        (agent_set_slot, ":var0", 29, ":var6"),
        (agent_set_slot, ":var0", 30, ":var7"),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
      (this_or_next|game_key_clicked, gk_attack),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_move_forward),
      (this_or_next|game_key_clicked, gk_move_backward),
      (this_or_next|game_key_clicked, gk_move_left),
      (this_or_next|game_key_clicked, gk_move_right),
      (this_or_next|game_key_clicked, gk_equip_primary_weapon),
      (this_or_next|game_key_clicked, gk_equip_secondary_weapon),
      (this_or_next|game_key_clicked, gk_action),
      (game_key_clicked, gk_sheath_weapon),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (display_message, "@Releasing spear.", 0x6495ED),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
    ]),

    (0.2, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_get_horse, ":var1", ":var0"),
        (le, ":var1", 0),
        (agent_get_slot, ":var2", ":var0", 26),
        (lt, ":var2", 10),
        (val_add, ":var2", 2),
        (agent_set_slot, ":var0", 26, ":var2"),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_set_animation, ":var0", "anim_spearwall_hold"),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (try_for_agents, ":var2"),
        (agent_is_alive, ":var2"),
        (neq, ":var2", ":var0"),
        (agent_is_human, ":var2"),
        (agent_get_horse, ":var3", ":var2"),
        (le, ":var3", 0),
        (agent_get_slot, ":var4", ":var2", 26),
        (ge, ":var4", 10),
        (agent_get_simple_behavior, ":var5", ":var2"),
        (agent_get_team, ":var6", ":var2"),
        (agent_get_class, ":var7", ":var2"),
        (team_get_movement_order, ":var8", ":var6", ":var7"),
        (assign, ":var9", 0),
        (try_begin),
          (neq, ":var6", ":var1"),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (else_try),
          (this_or_next|eq, ":var8", 0),
          (eq, ":var8", 11),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (this_or_next|eq, ":var5", 4),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (try_end),
        (eq, ":var9", 1),
        (agent_get_troop_id, ":var10", ":var2"),
        (store_proficiency_level, ":var11", ":var10", ca_intelligence),
        (store_character_level, ":var12", ":var10"),
        (ge, ":var12", 12),
        (ge, ":var11", 120),
        (neg|troop_is_mounted, ":var10"),
        (agent_slot_eq, ":var2", 15, 0),
        (assign, ":var9", 0),
        (agent_get_wielded_item, ":var13", ":var2", 0),
        (agent_get_wielded_item, ":var14", ":var2", 1),
        (assign, ":var15", 145),
        (try_begin),
          (this_or_next|is_between, ":var13", "itm_modded_billhook_fork_1", "itm_maul"),
          (is_between, ":var14", "itm_modded_billhook_fork_1", "itm_maul"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_1"),
            (eq, ":var14", "itm_modded_billhook_fork_1"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_2"),
            (eq, ":var14", "itm_modded_billhook_fork_2"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_1"),
            (eq, ":var14", "itm_modded_fauchard_1"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_2"),
            (eq, ":var14", "itm_modded_fauchard_2"),
            (assign, "$spear_dist", 171),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_3"),
            (eq, ":var14", "itm_modded_fauchard_3"),
            (assign, "$spear_dist", 197),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_4"),
            (eq, ":var14", "itm_modded_fauchard_4"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_1"),
            (eq, ":var14", "itm_modded_glaive_1"),
            (assign, "$spear_dist", 169),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_1"),
            (eq, ":var14", "itm_modded_glaive_fork_1"),
            (assign, "$spear_dist", 230),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_2"),
            (eq, ":var14", "itm_modded_glaive_fork_2"),
            (assign, "$spear_dist", 188),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_roundel"),
            (eq, ":var14", "itm_modded_glaive_roundel"),
            (assign, "$spear_dist", 149),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_1"),
            (eq, ":var14", "itm_modded_bill_1"),
            (assign, "$spear_dist", 215),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_2"),
            (eq, ":var14", "itm_modded_bill_2"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_1"),
            (eq, ":var14", "itm_modded_billhook_1"),
            (assign, "$spear_dist", 207),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_2"),
            (eq, ":var14", "itm_modded_billhook_2"),
            (assign, "$spear_dist", 172),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_3"),
            (eq, ":var14", "itm_modded_billhook_3"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_voulge"),
            (eq, ":var14", "itm_modded_voulge"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_spiked_voulge"),
            (eq, ":var14", "itm_modded_spiked_voulge"),
            (assign, "$spear_dist", 182),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_cleaving_voulge"),
            (eq, ":var14", "itm_modded_cleaving_voulge"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_1"),
            (eq, ":var14", "itm_modded_hooked_voulge_1"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_2"),
            (eq, ":var14", "itm_modded_hooked_voulge_2"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_3"),
            (eq, ":var14", "itm_modded_hooked_voulge_3"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_1"),
            (eq, ":var14", "itm_modded_couteau_1"),
            (assign, "$spear_dist", 177),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_2"),
            (eq, ":var14", "itm_modded_couteau_2"),
            (assign, "$spear_dist", 196),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_guisarme"),
            (eq, ":var14", "itm_modded_guisarme"),
            (assign, "$spear_dist", 232),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_assegai"),
            (eq, ":var14", "itm_modded_assegai"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_pike"),
            (eq, ":var14", "itm_modded_pike"),
            (assign, "$spear_dist", 300),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_war_spear"),
            (eq, ":var14", "itm_modded_war_spear"),
            (assign, "$spear_dist", 211),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_glaive"),
          (is_between, ":var14", "itm_glaive"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_glaive"),
            (eq, ":var14", "itm_glaive"),
            (assign, "$spear_dist", 160),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_bill"),
          (is_between, ":var14", "itm_bill"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_bill"),
            (eq, ":var14", "itm_bill"),
            (assign, "$spear_dist", 128),
          (try_end),
        (try_end),
        (eq, ":var9", 1),
        (assign, ":var16", -1),
        (agent_get_position, pos1, ":var2"),
        (try_for_agents, ":var17"),
          (agent_is_alive, ":var17"),
          (neg|agent_is_human, ":var17"),
          (agent_get_rider, ":var18", ":var17"),
          (ge, ":var18", 0),
          (agent_get_team, ":var19", ":var18"),
          (teams_are_enemies, ":var6", ":var19"),
          (agent_get_position, pos2, ":var17"),
          (get_distance_between_positions, ":var20", pos1, pos2),
          (lt, ":var20", ":var15"),
          (neg|position_is_behind_position, pos2, pos1),
          (agent_get_slot, ":var21", ":var17", 30),
          (gt, ":var21", 0),
          (assign, ":var16", ":var17"),
        (try_end),
        (gt, ":var16", -1),
        (agent_play_sound, ":var16", "snd_metal_hit_high_armor_high_damage"),
        (store_agent_hit_points, ":var22", ":var16", 0),
        (store_agent_hit_points, ":var23", ":var16", 1),
        (assign, reg22, ":var21"),
        (val_mul, ":var21", 10),
        (val_sub, ":var22", ":var21"),
        (val_max, ":var22", 0),
        (agent_set_slot, ":var2", 26, 0),
        (agent_get_horse, ":var24", ":var0"),
        (agent_get_position, pos2, ":var16"),
        (agent_set_look_target_position, ":var2", pos2),
        (agent_set_attack_action, ":var2", 0, 0),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_get_troop_id, ":var10", ":var2"),
        (str_store_troop_name, s21, ":var10"),
        (agent_get_troop_id, ":var25", ":var16"),
        (str_store_troop_name, s20, ":var25"),
        (store_agent_hit_points, ":var22", ":var16", 1),
        (val_sub, ":var23", ":var22"),
        (assign, reg1, ":var23"),
        (try_begin),
          (eq, ":var16", ":var24"),
          (display_message, "@Your horse received {reg1} damage from a braced polearm!", 0xFF4040),
        (try_end),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (store_agent_hit_points, ":var1", ":var0", 1),
      (lt, ":var1", "$spear_hp"),
      (display_message, "@The injury causes your grip on the polearm to slip!", 0xFF4040),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 26),
      (ge, ":var1", 10),
      (assign, ":var2", -1),
      (agent_get_position, pos1, ":var0"),
      (try_for_agents, ":var3"),
        (agent_is_alive, ":var3"),
        (neg|agent_is_human, ":var3"),
        (agent_get_rider, ":var4", ":var3"),
        (ge, ":var4", 0),
        (neg|agent_is_ally, ":var4"),
        (agent_get_position, pos2, ":var3"),
        (get_distance_between_positions, ":var5", pos1, pos2),
        (lt, ":var5", "$spear_dist"),
        (neg|position_is_behind_position, pos2, pos1),
        (agent_get_slot, ":var6", ":var3", 30),
        (ge, ":var6", 120),
        (assign, ":var2", ":var3"),
      (try_end),
      (gt, ":var2", -1),
      (agent_play_sound, ":var2", "snd_metal_hit_high_armor_high_damage"),
      (store_agent_hit_points, ":var7", ":var2", 0),
      (store_agent_hit_points, ":var8", ":var2", 1),
      (val_div, ":var6", 2),
      (val_sub, ":var6", 15),
      (val_sub, ":var7", ":var6"),
      (val_max, ":var7", 0),
      (agent_set_hit_points, ":var2", ":var7", 0),
      (agent_deliver_damage_to_agent, ":var2", ":var2"),
      (agent_set_slot, ":var0", 26, 0),
      (store_agent_hit_points, ":var7", ":var2", 1),
      (val_sub, ":var8", ":var7"),
      (assign, reg1, ":var8"),
      (display_message, "@Polearm-wall dealt {reg1} damage!"),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 2, 
    [
      (key_clicked, key_b),
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_is_alive, ":var1"),
      (agent_get_wielded_item, ":var2", ":var1", 0),
      (agent_get_wielded_item, ":var3", ":var1", 1),
      (assign, "$spear_dist", 145),
      (try_begin),
        (this_or_next|is_between, ":var2", "itm_modded_billhook_fork_1", "itm_maul"),
        (is_between, ":var3", "itm_modded_billhook_fork_1", "itm_maul"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_1"),
          (eq, ":var3", "itm_modded_billhook_fork_1"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_2"),
          (eq, ":var3", "itm_modded_billhook_fork_2"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_1"),
          (eq, ":var3", "itm_modded_fauchard_1"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_2"),
          (eq, ":var3", "itm_modded_fauchard_2"),
          (assign, "$spear_dist", 171),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_3"),
          (eq, ":var3", "itm_modded_fauchard_3"),
          (assign, "$spear_dist", 197),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_4"),
          (eq, ":var3", "itm_modded_fauchard_4"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_1"),
          (eq, ":var3", "itm_modded_glaive_1"),
          (assign, "$spear_dist", 169),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_1"),
          (eq, ":var3", "itm_modded_glaive_fork_1"),
          (assign, "$spear_dist", 230),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_2"),
          (eq, ":var3", "itm_modded_glaive_fork_2"),
          (assign, "$spear_dist", 188),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_roundel"),
          (eq, ":var3", "itm_modded_glaive_roundel"),
          (assign, "$spear_dist", 149),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_1"),
          (eq, ":var3", "itm_modded_bill_1"),
          (assign, "$spear_dist", 215),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_2"),
          (eq, ":var3", "itm_modded_bill_2"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_1"),
          (eq, ":var3", "itm_modded_billhook_1"),
          (assign, "$spear_dist", 207),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_2"),
          (eq, ":var3", "itm_modded_billhook_2"),
          (assign, "$spear_dist", 172),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_3"),
          (eq, ":var3", "itm_modded_billhook_3"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_voulge"),
          (eq, ":var3", "itm_modded_voulge"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_spiked_voulge"),
          (eq, ":var3", "itm_modded_spiked_voulge"),
          (assign, "$spear_dist", 182),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_cleaving_voulge"),
          (eq, ":var3", "itm_modded_cleaving_voulge"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_1"),
          (eq, ":var3", "itm_modded_hooked_voulge_1"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_2"),
          (eq, ":var3", "itm_modded_hooked_voulge_2"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_3"),
          (eq, ":var3", "itm_modded_hooked_voulge_3"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_1"),
          (eq, ":var3", "itm_modded_couteau_1"),
          (assign, "$spear_dist", 177),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_2"),
          (eq, ":var3", "itm_modded_couteau_2"),
          (assign, "$spear_dist", 196),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_guisarme"),
          (eq, ":var3", "itm_modded_guisarme"),
          (assign, "$spear_dist", 232),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_assegai"),
          (eq, ":var3", "itm_modded_assegai"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_pike"),
          (eq, ":var3", "itm_modded_pike"),
          (assign, "$spear_dist", 300),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_war_spear"),
          (eq, ":var3", "itm_modded_war_spear"),
          (assign, "$spear_dist", 211),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_glaive"),
        (is_between, ":var3", "itm_glaive"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_glaive"),
          (eq, ":var3", "itm_glaive"),
          (assign, "$spear_dist", 160),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_bill"),
        (is_between, ":var3", "itm_bill"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_bill"),
          (eq, ":var3", "itm_bill"),
          (assign, "$spear_dist", 128),
        (try_end),
      (try_end),
      (eq, ":var0", 1),
      (agent_get_horse, ":var4", ":var1"),
      (le, ":var4", 0),
      (neq, "$spear_in_position", 1),
      (display_message, "@Bracing polearm for charge.", 0x6495ED),
      (agent_set_animation, ":var1", "anim_spearwall_hold"),
      (assign, "$spear_in_position", 1),
      (store_agent_hit_points, "$spear_hp", ":var1", 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 41, ":var0"),
    ]),

    (0, 0, 3, 
    [
      (key_clicked, key_h),
    ],
    [
      (agent_get_slot, ":var0", "$fplayer_agent_no", 41),
      (gt, ":var0", 0),
      (agent_is_active, ":var0"),
      (agent_get_horse, reg0, "$fplayer_agent_no"),
      (eq, reg0, -1),
      (agent_play_sound, "$fplayer_agent_no", "snd_man_breath_hard"),
      (display_message, "@You whistle for your horse."),
      (agent_is_alive, ":var0"),
      (agent_get_position, pos1, "$fplayer_agent_no"),
      (agent_set_scripted_destination, ":var0", pos1, 0),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_2, ":var0"),
      (ge, ":var0", 0),
      (item_get_type, ":var1", ":var0"),
      (this_or_next|eq, ":var1", 8),
      (eq, ":var1", 9),
      (store_trigger_param_1, ":var2"),
      (agent_is_active, ":var2"),
      (agent_is_alive, ":var2"),
      (agent_is_non_player, ":var2"),
      (agent_get_ammo, ":var3", ":var2", 0),
      (le, ":var3", 0),
      (agent_get_horse, ":var4", ":var2"),
      (eq, ":var4", -1),
      (assign, ":var5", 1),
      (try_begin),
        (this_or_next|party_slot_eq, "$g_encountered_party", 0, 3),
        (party_slot_eq, "$g_encountered_party", 0, 2),
        (agent_get_team, ":var6", ":var2"),
        (this_or_next|eq, ":var6", "$defender_team"),
        (eq, ":var6", "$defender_team_2"),
        (assign, ":var5", 0),
      (try_end),
      (eq, ":var5", 1),
      (agent_set_division, ":var2", 4),
      (agent_set_slot, ":var2", 42, 4),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_slot, ":var0", 42, -1),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_active, ":var0"),
        (agent_slot_ge, ":var0", 42, 0),
        (agent_is_alive, ":var0"),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 42, ":var1"),
        (agent_get_slot, ":var2", ":var0", 42),
        (agent_set_division, ":var0", ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_slot, ":var0", 42, -1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (neg|agent_is_human, ":var0"),
        (agent_get_rider, ":var1", ":var0"),
        (ge, ":var1", 0),
        (agent_is_active, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_is_non_player, ":var1"),
      (else_try),
        (assign, ":var1", -1),
      (try_end),
      (agent_set_slot, ":var0", 41, ":var1"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (neg|agent_is_human, ":var0"),
      (agent_get_slot, ":var1", ":var0", 41),
      (ge, ":var1", 0),
      (agent_is_active, ":var1"),
      (agent_is_alive, ":var1"),
      (try_begin),
        (assign, ":var2", 70),
        (agent_get_troop_id, ":var3", ":var1"),
        (store_skill_level, ":var4", "skl_riding", ":var3"),
        (store_mul, ":var5", ":var4", 5),
        (val_sub, ":var2", ":var5"),
        (call_script, "script_rand", 0, 100),
        (le, reg0, ":var2"),
        (call_script, "script_rand", 60, 80),
        (assign, ":var6", reg0),
        (store_mul, ":var7", ":var4", 7),
        (val_sub, ":var6", ":var7"),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var6"),
        (try_begin),
          (neg|agent_is_non_player, ":var1"),
          (display_message, "@You fall down from your horse and sustain some damage!"),
        (try_end),
      (try_end),
      (try_begin),
        (agent_is_active, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_set_division, ":var1", 0),
        (agent_set_slot, ":var1", 42, 0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_active, ":var0"),
        (agent_slot_ge, ":var0", 42, 0),
        (agent_is_alive, ":var0"),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 42, ":var1"),
        (agent_get_slot, ":var2", ":var0", 42),
        (agent_set_division, ":var0", ":var2"),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (call_script, "script_lance_use_classify_agent"),
    ]),

    (2, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 43),
        (gt, ":var1", 0),
        (agent_get_wielded_item, ":var2", ":var0", 0),
        (agent_get_horse, ":var3", ":var0"),
        (try_begin),
          (le, ":var3", 0),
          (agent_set_slot, ":var0", 43, 0),
          (eq, ":var2", ":var1"),
          (call_script, "script_lance_use_backup_weapon", ":var0"),
        (else_try),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var4", ":var0"),
          (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":var4", 1),
          (assign, ":var5", reg0),
          (try_begin),
            (lt, ":var5", 500),
            (agent_get_combat_state, ":var6", ":var0"),
            (gt, ":var6", 3),
            (eq, ":var2", ":var1"),
            (call_script, "script_lance_use_backup_weapon", ":var0"),
          (else_try),
            (neq, ":var2", ":var1"),
            (agent_set_wielded_item, ":var0", ":var1"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$tom_sand_storm", 0),
      (call_script, "script_change_rain_or_snow"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$tom_sand_storm", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (position_set_z_to_ground_level, pos0),
      (position_get_z, ":var1", pos0),
      (val_add, ":var1", 400),
      (position_set_z, pos0, ":var1"),
      (particle_system_burst, "psys_desert_storm", pos0, 2),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 2, ti_once, 
    [
      (eq, "$tom_use_banners", 1),
    ],
    [
      (call_script, "script_set_flag_carriers"),
    ]),

    (10, 0, 0, 
    [
      (eq, "$tom_use_banners", 1),
      (eq, "$tom_bonus_banners", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_range, ":var1"),
        (agent_slot_eq, ":var1", 40, 1),
        (agent_is_alive, ":var1"),
        (agent_is_active, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (agent_get_position, pos1, ":var1"),
        (try_for_range, ":var3"),
          (neq, ":var3", ":var1"),
          (agent_get_team, ":var4", ":var3"),
          (eq, ":var2", ":var4"),
          (agent_is_alive, ":var3"),
          (agent_is_active, ":var3"),
          (agent_is_human, ":var3"),
          (agent_get_position, pos2, ":var3"),
          (get_distance_between_positions_in_meters, ":var5", pos1, pos2),
          (le, ":var5", 10),
          (store_agent_hit_points, ":var6", ":var3"),
          (val_add, ":var6", 2),
          (val_min, ":var6", 101),
          (agent_set_hit_points, ":var3", ":var6"),
          (try_begin),
            (eq, ":var3", ":var0"),
            (display_message, "@You feel secured standing near the banner, healing some of your HP.", 0x6495ED),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var1", ":var0"),
      (agent_is_alive, ":var1"),
      (agent_get_wielded_item, ":var7", ":var1", 0),
      (is_between, ":var7", 1291, 1295),
      (agent_get_team, ":var2", ":var1"),
      (agent_get_position, pos1, ":var1"),
      (try_for_range, ":var3"),
        (neq, ":var3", ":var1"),
        (agent_get_team, ":var4", ":var3"),
        (eq, ":var2", ":var4"),
        (agent_is_alive, ":var3"),
        (agent_is_active, ":var3"),
        (agent_is_human, ":var3"),
        (agent_get_position, pos2, ":var3"),
        (get_distance_between_positions_in_meters, ":var5", pos1, pos2),
        (le, ":var5", 10),
        (store_agent_hit_points, ":var6", ":var3"),
        (try_begin),
          (eq, ":var7", 1294),
          (val_add, ":var6", 1),
        (try_end),
        (val_add, ":var6", 5),
        (val_max, ":var6", 101),
        (agent_set_hit_points, ":var3", ":var6"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$tom_sand_storm", 3),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (position_set_z_to_ground_level, pos0),
      (position_get_z, ":var1", pos0),
      (val_add, ":var1", 2100),
      (position_set_z, pos0, ":var1"),
      (particle_system_burst, "psys_rain", pos0, 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 0, 
    [
      (eq, "$tom_sand_storm", 2),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (position_set_z_to_ground_level, pos0),
      (position_get_z, ":var1", pos0),
      (val_add, ":var1", 2000),
      (position_set_z, pos0, ":var1"),
      (particle_system_burst, "psys_blizzard", pos0, 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (8, 0, 0, 
    [
      (eq, "$tom_sand_storm", 3),
    ],
    [
      (store_random_in_range, ":var0", 0, 100),
      (try_begin),
        (ge, ":var0", 90),
        (play_sound, "snd_thunder"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (eq, "$tom_sand_storm", 2),
    ],
    [
      (play_sound, "snd_wind"),
    ]),

    (0, 0, ti_once, 
    [
      (eq, "$tom_sand_storm", 1),
    ],
    [
      (play_sound, "snd_wind"),
    ]),

    (0, 1.5, 0, 
    [
      (key_clicked, key_t),
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_set_animation, ":var0", "anim_cheer", 1),
      (agent_play_sound, ":var0", "snd_man_victory"),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_position, pos1, ":var0"),
      (try_for_agents, ":var2"),
        (agent_is_alive, ":var2"),
        (agent_is_human, ":var2"),
        (agent_get_team, ":var3", ":var2"),
        (eq, ":var3", ":var1"),
        (agent_get_position, pos0, ":var2"),
        (get_distance_between_positions_in_meters, ":var4", pos0, pos1),
        (lt, ":var4", 20),
        (agent_set_animation, ":var2", "anim_cheer", 1),
        (agent_play_sound, ":var2", "snd_man_victory"),
        (agent_get_slot, ":var5", ":var2", 16),
        (val_add, ":var5", 5),
        (val_min, ":var5", 9600),
        (agent_set_slot, ":var2", 16, ":var5"),
      (try_end),
      (display_message, "@Huzzah! You encourage your nearby troops."),
    ]),

    (0, 1.7, 0, 
    [
      (eq, "$tom_yell_smelly_peasents", 1),
    ],
    [
      (call_script, "script_tom_command_cheer"),
      (assign, "$tom_yell_smelly_peasents", 0),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (neg|agent_is_ally, ":var0"),
      (agent_is_human, ":var0"),
      (eq, ":var1", "$fplayer_agent_no"),
      (val_add, "$killcount", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_clear_troop_array", "trp_lances_troop_in_combat", 0, "$lance_troop_serving"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_is_human, ":var0"),
      (get_player_agent_no, ":var1"),
      (neq, ":var0", ":var1"),
      (agent_get_party_id, ":var2", ":var0"),
      (eq, ":var2", "p_main_party"),
      (agent_get_troop_id, ":var3", ":var0"),
      (call_script, "script_search_for_troop", ":var3"),
      (agent_set_slot, ":var0", 102, reg0),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$enable_deahtcam", 1),
      (assign, "$auxilary_player_active", 0),
      (eq, "$use_player_auxiliary", 1),
      (assign, "$g_move_heroes", 1),
      (party_clear, "p_temp_casualties_3"),
      (call_script, "script_party_add_party", "p_temp_casualties_3", "p_main_party"),
      (set_player_troop, "trp_player"),
      (assign, "$enable_deahtcam", 0),
    ]),

    (5, 0, 0, 
    [
      (eq, "$use_player_auxiliary", 1),
      (eq, "$enable_deahtcam", 0),
      (get_player_agent_no, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (neq, "$freelancer_state", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_division, ":var2", ":var0"),
      (assign, ":var3", 0),
      (try_for_agents, ":var4"),
        (eq, ":var3", 0),
        (agent_is_human, ":var4"),
        (agent_is_alive, ":var4"),
        (agent_get_team, ":var5", ":var4"),
        (agent_get_party_id, ":var6", ":var4"),
        (eq, ":var6", "p_main_party"),
        (agent_get_division, ":var7", ":var0"),
        (agent_get_group, ":var8", ":var0"),
        (eq, ":var1", ":var5"),
        (eq, ":var2", ":var7"),
        (agent_get_troop_id, ":var9", ":var4"),
        (neg|is_between, ":var9", "trp_npc1", "trp_enhanced_rnd_lord_end"),
        (set_player_troop, ":var9"),
        (store_agent_hit_points, ":var10", ":var4", 1),
        (agent_get_position, pos1, ":var4"),
        (position_set_z, pos1, -2000),
        (position_set_x, pos1, 0),
        (position_set_y, pos1, 0),
        (agent_get_position, pos0, ":var4"),
        (set_spawn_position, pos0),
        (agent_get_horse, ":var11", ":var4"),
        (try_begin),
          (gt, ":var11", 0),
          (agent_set_position, ":var11", pos1),
          (remove_agent, ":var11"),
        (try_end),
        (agent_set_position, ":var4", pos1),
        (agent_set_slot, ":var4", 35, 1),
        (agent_get_slot, ":var12", ":var4", 102),
        (remove_agent, ":var4"),
        (spawn_agent, ":var9"),
        (assign, ":var0", reg0),
        (agent_set_slot, ":var0", 102, ":var12"),
        (agent_set_team, ":var0", ":var1"),
        (agent_set_hit_points, ":var0", ":var10", 1),
        (agent_set_group, ":var0", ":var8"),
        (agent_set_slot, ":var0", 35, 2),
        (agent_set_slot, ":var0", 36, ":var9"),
        (try_begin),
          (agent_get_horse, ":var13", ":var0"),
          (gt, ":var13", 0),
          (lt, ":var11", 0),
          (agent_set_position, ":var13", pos1),
          (remove_agent, ":var13"),
        (try_end),
        (set_player_troop, "trp_player"),
        (assign, ":var3", 1),
        (assign, "$auxilary_player_active", 1),
      (try_end),
      (eq, ":var3", 0),
      (assign, "$enable_deahtcam", 1),
    ]),

    (5, 0, 0, 
    [
      (eq, "$use_player_auxiliary", 1),
      (eq, "$enable_deahtcam", 0),
      (get_player_agent_no, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$enable_deahtcam", 1),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$g_decap_enabled", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (agent_is_non_player, ":var0"),
      (agent_get_troop_id, ":var3", ":var0"),
      (neg|troop_is_hero, ":var3"),
      (assign, ":var4", reg0),
      (copy_position, 5, 0),
      (neq, ":var0", -1),
      (try_begin),
        (agent_is_human, ":var0"),
        (ge, ":var4", 0),
        (assign, ":var5", 0),
        (try_begin),
          (this_or_next|eq, ":var4", "itm_supercrossbow"),
          (eq, ":var4", "itm_supersledge"),
          (assign, ":var5", 1),
        (else_try),
          (neq, ":var4", "itm_mace_1"),
          (neq, ":var4", "itm_mace_2"),
          (neq, ":var4", "itm_mace_3"),
          (neq, ":var4", "itm_staff"),
          (agent_get_action_dir, ":var6", ":var1"),
          (this_or_next|eq, ":var6", 1),
          (eq, ":var6", 2),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var5", 0),
        (try_begin),
          (ge, ":var2", "$g_decap_minimum_damage"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap minimum DMG req bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (store_agent_hit_points, ":var7", ":var0", 1),
        (val_add, ":var7", "$g_decap_negative_health"),
        (ge, ":var2", ":var7"),
        (agent_get_position, pos4, ":var0"),
        (get_distance_between_positions, ":var8", pos4, pos5),
        (agent_get_horse, ":var9", ":var0"),
        (try_begin),
          (ge, ":var9", 0),
          (assign, ":var10", 240),
          (assign, ":var11", 260),
        (else_try),
          (assign, ":var10", 160),
          (assign, ":var11", 176),
        (try_end),
        (is_between, ":var8", ":var10", ":var11"),
        (assign, ":var5", 0),
        (try_begin),
          (store_random_in_range, ":var12", 0, 100),
          (le, ":var12", "$g_decap_chance"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap chance calc bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var13", "itm_cut_off_head_male"),
        (agent_get_troop_id, ":var14", ":var0"),
        (try_begin),
          (ge, ":var14", 0),
          (troop_get_type, ":var15", ":var14"),
          (eq, ":var15", 1),
          (assign, ":var13", "itm_cut_off_head_female"),
        (try_end),
        (store_random_in_range, ":var16", 0, 360),
        (store_random_in_range, ":var17", -60, 60),
        (store_random_in_range, ":var18", -90, 90),
        (store_random_in_range, ":var19", -90, 90),
        (position_rotate_z, pos4, ":var16"),
        (position_rotate_y, pos4, ":var17"),
        (position_move_x, 4, ":var18"),
        (position_move_y, pos4, ":var19"),
        (position_set_z_to_ground_level, pos4),
        (position_move_z, pos4, 5),
        (set_spawn_position, pos4),
        (assign, ":var20", 360),
        (agent_get_item_slot, ":var21", ":var0", 4),
        (try_begin),
          (ge, ":var21", 1),
          (agent_unequip_item, ":var0", ":var21"),
          (try_begin),
            (spawn_item, ":var21", 0, ":var20"),
          (try_end),
        (try_end),
        (agent_equip_item, ":var0", "itm_invisible_head"),
        (agent_get_position, pos4, ":var0"),
        (position_move_z, pos4, ":var10"),
        (particle_system_burst, "psys_blood_decapitation", pos4, "$g_decap_psys_blood_decapitation"),
        (particle_system_burst, "psys_game_blood", pos4, "$g_decap_psys_game_blood"),
        (particle_system_burst, "psys_game_blood_2", pos4, "$g_decap_psys_game_blood_2"),
        (play_sound_at_position, "snd_decapitation", pos4),
        (position_move_z, pos4, 20),
        (set_spawn_position, pos4),
        (assign, ":var13", "spr_head_dynamic_male"),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var13", "spr_head_dynamic_female"),
        (try_end),
        (spawn_scene_prop, ":var13"),
        (agent_get_troop_id, ":var22", ":var1"),
        (str_store_troop_name, s0, ":var22"),
        (agent_get_troop_id, ":var14", ":var0"),
        (str_store_troop_name, s1, ":var14"),
        (get_player_agent_no, ":var23"),
        (agent_get_team, ":var24", ":var23"),
        (agent_get_team, ":var25", ":var0"),
        (try_begin),
          (neq, ":var24", ":var25"),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFF33DD11),
        (else_try),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFFFF4422),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_bully_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_fat_peasant_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_thug_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_fatseveredarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_thin_looter_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (0, 0, 1, 
    [
      (key_clicked, key_right_control),
    ],
    [
      (try_begin),
        (key_is_down, key_m),
        (try_begin),
          (eq, "$g_decapitations_debugging", 0),
          (assign, "$g_decapitations_debugging", 1),
          (display_message, "@Decapitation debug mode Enabled"),
        (else_try),
          (assign, "$g_decapitations_debugging", 0),
          (display_message, "@Decapitation debug mode Disabled"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, key_k),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos17, ":var0"),
        (position_move_y, pos17, 2000),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_bully_handless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_thug_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_thin_looter_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_fat_peasant_handless"),
        (agent_set_team, reg0, 2),
      (try_end),
      (try_begin),
        (key_is_down, key_j),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos18, ":var0"),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supersledge"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supercrossbow"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_super_bolts"),
      (try_end),
    ]),

  ]),

  ("village_raid", mtf_battle_mode, charge,
  "You lead your men to battle.",
  [
    (3, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 48, []),
    (3, mtef_team_0|mtef_defenders, 0, aif_start_alarmed, 0, []),
    (1, mtef_team_1|mtef_attackers, 0, aif_start_alarmed, 48, []),
    (1, mtef_team_1|mtef_attackers, 0, aif_start_alarmed, 0, []),
  ],
  [
    (ti_on_agent_hit, 0.3, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (assign, ":var3", reg0),
      (agent_is_human, ":var0"),
      (get_player_agent_no, ":var4"),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var0", ":var4"),
        (store_random_in_range, ":var5", 0, 1000),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 4, 8),
        (troop_get_inventory_slot, ":var7", "trp_player", ":var6"),
        (gt, ":var7", 0),
        (str_store_item_name, s20, ":var7"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var6"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} is too crapy to fall apart!", 0xFF0000),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var7", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var6", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var1", ":var4"),
        (is_between, ":var3", 1, "itm_items_end"),
        (neg|is_between, ":var3", "itm_light_lance", "itm_wooden_shield"),
        (item_get_type, ":var9", ":var3"),
        (ge, ":var2", 10),
        (neq, ":var9", 10),
        (neq, ":var9", 8),
        (neq, ":var9", 9),
        (neq, ":var9", 5),
        (neq, ":var9", 6),
        (store_random_in_range, ":var5", 0, 600),
        (eq, ":var5", 1),
        (assign, ":var10", -1),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var11", "trp_player", ":var6"),
          (eq, ":var11", ":var3"),
          (assign, ":var10", ":var6"),
        (try_end),
        (gt, ":var10", 0),
        (str_store_item_name, s20, ":var3"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var10"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} falls apart!", 0xFF0000),
          (agent_unequip_item, ":var4", ":var3"),
          (troop_remove_item, "trp_player", ":var3"),
          (troop_remove_item, "trp_broken_items", ":var3"),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var3", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var10", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (agent_get_horse, ":var12", ":var1"),
      (try_begin),
        (eq, "$tom_lance_breaking", 1),
        (gt, ":var12", 0),
        (this_or_next|is_between, ":var3", "itm_light_lance", "itm_bamboo_spear"),
        (is_between, ":var3", "itm_crusader_knight_spear_a", "itm_crusader_spear_a"),
        (ge, ":var2", 50),
        (store_random_in_range, ":var13", 0, 100),
        (gt, ":var13", 20),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your lance!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (this_or_next|is_between, ":var3", "itm_bamboo_spear", "itm_staff"),
        (is_between, ":var3", "itm_crusader_spear_a", "itm_mace_6"),
        (le, ":var12", 0),
        (ge, ":var2", 8),
        (store_random_in_range, ":var13", 0, 100),
        (ge, ":var13", 90),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your spear!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_agent_reassign_team", ":var0"),
      (gt, ":var0", 0),
      (assign, ":var1", 5000),
      (agent_get_troop_id, ":var2", ":var0"),
      (store_character_level, ":var3", ":var2"),
      (val_mul, ":var3", 35),
      (val_add, ":var1", ":var3"),
      (store_random_in_range, ":var4", 0, 3000),
      (val_add, ":var1", ":var4"),
      (agent_get_party_id, ":var5", ":var0"),
      (party_get_morale, ":var6", ":var5"),
      (store_sub, ":var7", ":var6", 70),
      (val_mul, ":var7", 30),
      (val_add, ":var1", ":var7"),
      (agent_set_slot, ":var0", 16, ":var1"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 10, 20, 1),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (call_script, "script_combat_music_set_situation_with_culture", 1024),
      (assign, "$dmod_current_agent", -1),
      (assign, "$dmod_move_camera", -1),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture", 1024),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 0, 5, 
    [
      (lt, "$defender_reinforcement_stage", "$g_reinforcement_waves"),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
      (store_normalized_team_count, ":var1", 0),
      (lt, ":var1", 24),
    ],
    [
      (add_reinforcements_to_entry, 0, 24),
      (val_add, "$defender_reinforcement_stage", 1),
    ]),

    (1, 0, 5, 
    [
      (lt, "$attacker_reinforcement_stage", "$g_reinforcement_waves"),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
      (store_normalized_team_count, ":var1", 1),
      (lt, ":var1", 24),
    ],
    [
      (add_reinforcements_to_entry, 3, 24),
      (val_add, "$attacker_reinforcement_stage", 1),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (try_begin),
        (eq, "$g_village_raid_evil", 0),
        (call_script, "script_play_victorious_sound"),
      (else_try),
        (play_track, "track_victorious_evil", 1),
      (try_end),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (5, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (val_add, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
      (set_mission_result, -1),
      (display_message, "@Battle lost..."),
      (assign, "$g_battle_won", -1),
      (assign, "$g_battle_result", -1),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (assign, "$do_once_3", 0),
      (finish_mission, 0),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", -1),
      (display_message, "@Battle lost! Press tab key to leave..."),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (gt, "$dmod_current_agent", 0),
      (eq, "$setting_use_dmod", 1),
      (eq, "$dmod_move_camera", 1),
      (agent_get_position, pos1, "$dmod_current_agent"),
      (position_move_z, pos1, 300),
      (position_move_y, pos1, -300),
      (agent_get_horse, ":var0", "$dmod_current_agent"),
      (try_begin),
        (ge, ":var0", 0),
      (try_end),
      (mission_cam_set_position, pos1),
      (mission_cam_set_mode, 1),
      (set_fixed_point_multiplier, 100),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_up),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_forwards"),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_down),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_backwards"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 4, ti_once, 
    [
      (eq, "$enable_deahtcam", 1),
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
      (assign, "$tom_sand_storm", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (this_or_next|eq, "$dmod_move_camera", 1),
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, gk_move_forward),
      (this_or_next|game_key_is_down, gk_move_backward),
      (this_or_next|game_key_is_down, gk_move_left),
      (this_or_next|game_key_is_down, gk_move_right),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_backward),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_left),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (position_rotate_x_floating, pos47, ":var7"),
        (position_rotate_y, pos47, 90),
        (position_rotate_x_floating, pos47, ":var3"),
        (position_rotate_y, pos47, -90),
        (position_rotate_x_floating, pos47, "$deathcam_total_rotx"),
        (position_rotate_x_floating, pos47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|eq, ":var0", 0),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "str_enhanced_battle_knocked_out_message_1"),
      (display_message, "str_enhanced_battle_knocked_out_message_2"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (is_presentation_active, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (team_give_order, ":var1", 9, 0),
      (set_show_messages, 1),
    ]),

    (0, 0, ti_once, 
    [
      (eq, 0, 1),
      (eq, "$enable_deahtcam", 1),
      (main_hero_fallen),
    ],
    [
      (assign, "$fclock", 1),
      (call_script, "script_player_order_formations", 2),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (team_give_order, ":var1", 9, 2),
    ]),

    (2, 0, 0, 
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_non_player, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (store_skill_level, ":var2", "skl_horse_archery", ":var1"),
        (ge, ":var2", 4),
      (try_end),
    ],
    [
      (set_fixed_point_multiplier, 1000),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_non_player, ":var0"),
        (neg|agent_slot_eq, ":var0", 1003, 1),
        (agent_get_horse, ":var1", ":var0"),
        (assign, ":var2", -1),
        (try_begin),
          (agent_slot_eq, ":var0", 15, 0),
          (gt, ":var1", -1),
          (agent_get_team, ":var3", ":var0"),
          (agent_get_division, ":var4", ":var0"),
          (team_get_weapon_usage_order, ":var5", ":var3", ":var4"),
          (team_get_movement_order, ":var6", ":var3", ":var4"),
          (team_get_hold_fire_order, ":var7", ":var3", ":var4"),
          (assign, ":var8", 0),
          (assign, ":var9", -1),
          (try_for_range, ":var10", 0, 4),
            (agent_get_item_slot, ":var11", ":var0", ":var10"),
            (gt, ":var11", 0),
            (item_get_type, ":var12", ":var11"),
            (try_begin),
              (eq, ":var12", 10),
              (agent_get_ammo_for_slot, ":var13", ":var0", ":var10"),
              (val_add, ":var8", ":var13"),
            (else_try),
              (this_or_next|eq, ":var12", 8),
              (this_or_next|eq, ":var12", 16),
              (eq, ":var12", 17),
              (assign, ":var9", ":var11"),
            (else_try),
              (this_or_next|eq, ":var12", 2),
              (this_or_next|eq, ":var12", 3),
              (eq, ":var12", 4),
              (assign, ":var2", ":var11"),
            (try_end),
          (try_end),
          (gt, ":var9", -1),
          (neg|item_has_property, ":var9", itp_cant_reload_on_horseback),
          (neg|item_has_property, ":var9", itp_cant_use_on_horseback),
          (agent_get_ammo, ":var14", ":var0", 0),
          (val_sub, ":var14", ":var8"),
          (gt, ":var14", 0),
          (agent_set_slot, ":var0", 1003, 2),
          (neq, ":var7", 1),
          (neq, ":var5", 2),
          (eq, ":var6", 2),
          (agent_get_position, pos50, ":var0"),
          (agent_get_speed, pos31, ":var0"),
          (position_get_y, ":var15", pos31),
          (assign, ":var16", 100000),
          (assign, ":var17", -1),
          (try_for_agents, ":var18"),
            (agent_is_alive, ":var18"),
            (agent_is_human, ":var18"),
            (agent_get_position, pos36, ":var18"),
            (agent_get_team, ":var19", ":var18"),
            (teams_are_enemies, ":var3", ":var19"),
            (get_distance_between_positions, ":var20", pos50, pos36),
            (try_begin),
              (agent_slot_eq, ":var18", 15, 1),
              (val_add, ":var20", 10000),
            (try_end),
            (try_begin),
              (agent_get_horse, ":var21", ":var18"),
              (gt, ":var21", -1),
              (agent_get_speed, pos32, ":var18"),
              (position_get_y, ":var22", pos32),
              (val_sub, ":var22", ":var15"),
              (store_div, ":var23", ":var22", 5),
              (val_max, ":var23", 0),
              (val_add, ":var23", 500),
              (val_sub, ":var20", ":var23"),
            (else_try),
              (agent_get_wielded_item, ":var24", ":var18", 1),
              (le, ":var24", 1),
              (val_sub, ":var20", 500),
            (try_end),
            (lt, ":var20", ":var16"),
            (assign, ":var16", ":var20"),
            (assign, ":var17", ":var18"),
          (try_end),
          (neq, ":var17", -1),
          (agent_get_position, pos51, ":var17"),
          (get_distance_between_positions, ":var25", pos50, pos51),
          (try_begin),
            (agent_slot_eq, ":var17", 15, 0),
            (gt, ":var25", 200),
            (agent_set_wielded_item, ":var0", ":var9"),
          (else_try),
            (le, ":var25", 200),
            (gt, ":var2", -1),
            (agent_set_wielded_item, ":var0", ":var2"),
          (try_end),
          (assign, ":var26", 1000),
          (try_begin),
            (agent_get_wielded_item, ":var24", ":var0", 0),
            (gt, ":var24", 0),
            (item_get_type, ":var27", ":var24"),
            (this_or_next|eq, ":var27", 8),
            (this_or_next|eq, ":var27", 16),
            (eq, ":var27", 17),
            (agent_get_bone_position, pos53, ":var0", 8, 1),
            (agent_get_bone_position, pos54, ":var17", 9, 1),
            (position_has_line_of_sight_to_position, pos53, pos54),
            (agent_set_look_target_agent, ":var0", ":var17"),
            (try_begin),
              (assign, ":var28", 4000),
              (agent_get_attack_action, ":var29", ":var0"),
              (eq, ":var29", 1),
              (try_begin),
                (gt, ":var16", 700),
                (le, ":var16", ":var28"),
                (store_div, ":var26", ":var15", 2000),
                (val_max, ":var26", 0),
              (try_end),
              (eq, ":var27", 8),
              (try_begin),
                (le, ":var25", ":var28"),
                (agent_set_defend_action, ":var0", -2, 1),
                (agent_set_attack_action, ":var0", 3, 0),
              (else_try),
                (gt, ":var25", ":var28"),
                (agent_set_attack_action, ":var0", -2, 1),
                (agent_set_defend_action, ":var0", 3, 1),
              (try_end),
            (else_try),
              (eq, ":var27", 8),
              (le, ":var25", ":var28"),
              (agent_get_combat_state, ":var30", ":var0"),
              (neq, ":var30", 8),
              (agent_set_attack_action, ":var0", 3, 1),
            (try_end),
          (try_end),
          (agent_set_speed_limit, ":var0", ":var26"),
          (try_begin),
            (agent_slot_eq, ":var17", 15, 0),
            (lt, ":var16", 10000),
            (try_begin),
              (get_scene_boundaries, pos2, pos3),
              (position_transform_position_to_local, pos4, pos2, pos50),
              (position_get_x, ":var31", pos4),
              (position_get_y, ":var32", pos4),
              (position_transform_position_to_local, pos4, pos2, pos3),
              (position_get_x, ":var33", pos4),
              (position_get_y, ":var34", pos4),
              (store_sub, ":var35", ":var33", ":var31"),
              (store_sub, ":var36", ":var34", ":var32"),
              (position_transform_position_to_local, pos4, pos50, pos51),
              (position_get_x, ":var37", pos4),
              (position_get_y, ":var38", pos4),
              (assign, ":var39", 0),
              (try_begin),
                (le, ":var16", 1000),
                (assign, ":var39", -78000),
              (else_try),
                (gt, ":var16", 2000),
                (store_sub, ":var39", ":var16", 0),
                (val_mul, ":var39", 5),
                (val_clamp, ":var39", 35000, 90000),
              (try_end),
              (assign, ":var40", 30000),
              (val_min, ":var40", ":var31"),
              (val_min, ":var40", ":var36"),
              (val_min, ":var40", ":var35"),
              (val_min, ":var40", ":var32"),
              (try_begin),
                (lt, ":var40", 30000),
                (agent_slot_eq, ":var17", 15, 0),
                (store_div, ":var41", ":var33", 20),
                (store_div, ":var42", ":var34", 20),
                (position_copy_origin, pos4, pos2),
                (position_move_x, 4, ":var41", 1),
                (position_move_y, pos4, ":var42", 1),
                (get_distance_between_positions, ":var43", pos4, pos50),
                (position_transform_position_to_local, pos4, pos50, pos4),
                (position_get_x, ":var41", pos4),
                (position_get_y, ":var42", pos4),
                (val_mul, ":var41", 100),
                (val_mul, ":var42", 100),
                (val_mul, ":var37", 100),
                (val_mul, ":var38", 100),
                (store_div, ":var44", ":var41", ":var43"),
                (store_div, ":var45", ":var42", ":var43"),
                (store_div, ":var46", ":var37", ":var25"),
                (store_div, ":var47", ":var38", ":var25"),
                (store_acos, ":var48", ":var44"),
                (store_asin, ":var49", ":var45"),
                (store_acos, ":var50", ":var46"),
                (store_asin, ":var51", ":var47"),
                (try_begin),
                  (lt, ":var49", 0),
                  (val_mul, ":var48", -1),
                  (val_add, ":var48", 360000),
                (try_end),
                (try_begin),
                  (lt, ":var51", 0),
                  (val_mul, ":var50", -1),
                  (val_add, ":var50", 360000),
                (try_end),
                (store_sub, ":var52", ":var48", ":var50"),
                (val_sub, ":var52", 270000),
                (val_sub, ":var52", ":var39"),
                (store_add, ":var39", ":var52", ":var39"),
                (try_begin),
                  (lt, ":var48", ":var50"),
                  (val_add, ":var39", 360000),
                (try_end),
                (val_clamp, ":var39", -210000, 15000),
                (agent_set_attack_action, ":var0", -2, 1),
                (agent_set_defend_action, ":var0", 3, 1),
              (try_end),
              (store_cos, ":var53", ":var39"),
              (store_sin, ":var54", ":var39"),
              (store_mul, ":var55", ":var53", ":var38"),
              (store_mul, ":var56", ":var54", ":var37"),
              (store_mul, ":var57", ":var54", ":var38"),
              (store_mul, ":var58", ":var53", ":var37"),
              (store_add, ":var59", ":var55", ":var56"),
              (store_sub, ":var60", ":var57", ":var58"),
              (position_move_x, 50, ":var59", 0),
              (position_move_y, pos50, ":var60", 0),
            (try_end),
            (agent_set_scripted_destination, ":var0", pos50, 1),
          (else_try),
            (agent_clear_scripted_mode, ":var0"),
            (agent_force_rethink, ":var0"),
          (try_end),
        (else_try),
          (try_begin),
            (agent_slot_eq, ":var0", 1003, 0),
            (agent_set_slot, ":var0", 1003, 1),
          (else_try),
            (agent_slot_eq, ":var0", 1003, 2),
            (this_or_next|agent_slot_eq, ":var0", 15, 1),
            (this_or_next|lt, ":var1", 0),
            (this_or_next|eq, ":var14", 0),
            (this_or_next|eq, ":var7", 1),
            (this_or_next|eq, ":var5", 2),
            (neq, ":var6", 2),
            (agent_clear_scripted_mode, ":var0"),
            (agent_set_speed_limit, ":var0", 100),
            (agent_force_rethink, ":var0"),
            (agent_set_slot, ":var0", 1003, 3),
            (this_or_next|eq, ":var7", 1),
            (eq, ":var14", 0),
            (gt, ":var2", -1),
            (agent_set_wielded_item, ":var0", ":var2"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [
      (neg|is_presentation_active, "prsnt_killcount"),
      (neg|is_presentation_active, "prsnt_troop_ratio_bar"),
      (neg|is_presentation_active, "prsnt_killcount_and_troop_ratio_bar"),
    ],
    [
      (try_begin),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 1),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 2),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 3),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
      (call_script, "script_party_count_fit_for_battle", "p_main_party"),
      (assign, "$player_count_alive", reg0),
      (call_script, "script_party_count_fit_for_battle", "p_collective_friends"),
      (store_sub, "$ally_count_alive", reg0, "$player_count_alive"),
      (call_script, "script_party_count_fit_for_battle", "p_collective_enemy"),
      (assign, "$enemy_count_alive", reg0),
    ]),

    (3, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 1),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 2),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 3),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
    ]),

    (0.2, 0, ti_once, 
    [],
    [
      (assign, "$spear_in_position", 0),
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 26, 0),
        (agent_set_slot, ":var0", 27, 0),
        (agent_set_slot, ":var0", 28, 0),
        (agent_set_slot, ":var0", 29, 0),
        (agent_set_slot, ":var0", 30, 0),
      (try_end),
    ]),

    (0.5, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 27),
        (agent_get_slot, ":var2", ":var0", 28),
        (agent_get_slot, ":var3", ":var0", 29),
        (agent_get_position, pos1, ":var0"),
        (position_get_x, ":var4", pos1),
        (position_get_y, ":var5", pos1),
        (position_get_z, ":var6", pos1),
        (position_set_x, pos2, ":var1"),
        (position_set_y, pos2, ":var2"),
        (position_set_z, pos2, ":var3"),
        (position_set_x, pos1, ":var4"),
        (position_set_y, pos1, ":var5"),
        (position_set_z, pos1, ":var6"),
        (agent_get_speed, pos5, ":var0"),
        (call_script, "script_vector_length", 5),
        (assign, ":var7", reg0),
        (agent_set_slot, ":var0", 27, ":var4"),
        (agent_set_slot, ":var0", 28, ":var5"),
        (agent_set_slot, ":var0", 29, ":var6"),
        (agent_set_slot, ":var0", 30, ":var7"),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
      (this_or_next|game_key_clicked, gk_attack),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_move_forward),
      (this_or_next|game_key_clicked, gk_move_backward),
      (this_or_next|game_key_clicked, gk_move_left),
      (this_or_next|game_key_clicked, gk_move_right),
      (this_or_next|game_key_clicked, gk_equip_primary_weapon),
      (this_or_next|game_key_clicked, gk_equip_secondary_weapon),
      (this_or_next|game_key_clicked, gk_action),
      (game_key_clicked, gk_sheath_weapon),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (display_message, "@Releasing spear.", 0x6495ED),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
    ]),

    (0.2, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_get_horse, ":var1", ":var0"),
        (le, ":var1", 0),
        (agent_get_slot, ":var2", ":var0", 26),
        (lt, ":var2", 10),
        (val_add, ":var2", 2),
        (agent_set_slot, ":var0", 26, ":var2"),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_set_animation, ":var0", "anim_spearwall_hold"),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (try_for_agents, ":var2"),
        (agent_is_alive, ":var2"),
        (neq, ":var2", ":var0"),
        (agent_is_human, ":var2"),
        (agent_get_horse, ":var3", ":var2"),
        (le, ":var3", 0),
        (agent_get_slot, ":var4", ":var2", 26),
        (ge, ":var4", 10),
        (agent_get_simple_behavior, ":var5", ":var2"),
        (agent_get_team, ":var6", ":var2"),
        (agent_get_class, ":var7", ":var2"),
        (team_get_movement_order, ":var8", ":var6", ":var7"),
        (assign, ":var9", 0),
        (try_begin),
          (neq, ":var6", ":var1"),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (else_try),
          (this_or_next|eq, ":var8", 0),
          (eq, ":var8", 11),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (this_or_next|eq, ":var5", 4),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (try_end),
        (eq, ":var9", 1),
        (agent_get_troop_id, ":var10", ":var2"),
        (store_proficiency_level, ":var11", ":var10", ca_intelligence),
        (store_character_level, ":var12", ":var10"),
        (ge, ":var12", 12),
        (ge, ":var11", 120),
        (neg|troop_is_mounted, ":var10"),
        (agent_slot_eq, ":var2", 15, 0),
        (assign, ":var9", 0),
        (agent_get_wielded_item, ":var13", ":var2", 0),
        (agent_get_wielded_item, ":var14", ":var2", 1),
        (assign, ":var15", 145),
        (try_begin),
          (this_or_next|is_between, ":var13", "itm_modded_billhook_fork_1", "itm_maul"),
          (is_between, ":var14", "itm_modded_billhook_fork_1", "itm_maul"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_1"),
            (eq, ":var14", "itm_modded_billhook_fork_1"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_2"),
            (eq, ":var14", "itm_modded_billhook_fork_2"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_1"),
            (eq, ":var14", "itm_modded_fauchard_1"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_2"),
            (eq, ":var14", "itm_modded_fauchard_2"),
            (assign, "$spear_dist", 171),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_3"),
            (eq, ":var14", "itm_modded_fauchard_3"),
            (assign, "$spear_dist", 197),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_4"),
            (eq, ":var14", "itm_modded_fauchard_4"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_1"),
            (eq, ":var14", "itm_modded_glaive_1"),
            (assign, "$spear_dist", 169),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_1"),
            (eq, ":var14", "itm_modded_glaive_fork_1"),
            (assign, "$spear_dist", 230),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_2"),
            (eq, ":var14", "itm_modded_glaive_fork_2"),
            (assign, "$spear_dist", 188),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_roundel"),
            (eq, ":var14", "itm_modded_glaive_roundel"),
            (assign, "$spear_dist", 149),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_1"),
            (eq, ":var14", "itm_modded_bill_1"),
            (assign, "$spear_dist", 215),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_2"),
            (eq, ":var14", "itm_modded_bill_2"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_1"),
            (eq, ":var14", "itm_modded_billhook_1"),
            (assign, "$spear_dist", 207),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_2"),
            (eq, ":var14", "itm_modded_billhook_2"),
            (assign, "$spear_dist", 172),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_3"),
            (eq, ":var14", "itm_modded_billhook_3"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_voulge"),
            (eq, ":var14", "itm_modded_voulge"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_spiked_voulge"),
            (eq, ":var14", "itm_modded_spiked_voulge"),
            (assign, "$spear_dist", 182),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_cleaving_voulge"),
            (eq, ":var14", "itm_modded_cleaving_voulge"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_1"),
            (eq, ":var14", "itm_modded_hooked_voulge_1"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_2"),
            (eq, ":var14", "itm_modded_hooked_voulge_2"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_3"),
            (eq, ":var14", "itm_modded_hooked_voulge_3"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_1"),
            (eq, ":var14", "itm_modded_couteau_1"),
            (assign, "$spear_dist", 177),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_2"),
            (eq, ":var14", "itm_modded_couteau_2"),
            (assign, "$spear_dist", 196),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_guisarme"),
            (eq, ":var14", "itm_modded_guisarme"),
            (assign, "$spear_dist", 232),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_assegai"),
            (eq, ":var14", "itm_modded_assegai"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_pike"),
            (eq, ":var14", "itm_modded_pike"),
            (assign, "$spear_dist", 300),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_war_spear"),
            (eq, ":var14", "itm_modded_war_spear"),
            (assign, "$spear_dist", 211),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_glaive"),
          (is_between, ":var14", "itm_glaive"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_glaive"),
            (eq, ":var14", "itm_glaive"),
            (assign, "$spear_dist", 160),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_bill"),
          (is_between, ":var14", "itm_bill"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_bill"),
            (eq, ":var14", "itm_bill"),
            (assign, "$spear_dist", 128),
          (try_end),
        (try_end),
        (eq, ":var9", 1),
        (assign, ":var16", -1),
        (agent_get_position, pos1, ":var2"),
        (try_for_agents, ":var17"),
          (agent_is_alive, ":var17"),
          (neg|agent_is_human, ":var17"),
          (agent_get_rider, ":var18", ":var17"),
          (ge, ":var18", 0),
          (agent_get_team, ":var19", ":var18"),
          (teams_are_enemies, ":var6", ":var19"),
          (agent_get_position, pos2, ":var17"),
          (get_distance_between_positions, ":var20", pos1, pos2),
          (lt, ":var20", ":var15"),
          (neg|position_is_behind_position, pos2, pos1),
          (agent_get_slot, ":var21", ":var17", 30),
          (gt, ":var21", 0),
          (assign, ":var16", ":var17"),
        (try_end),
        (gt, ":var16", -1),
        (agent_play_sound, ":var16", "snd_metal_hit_high_armor_high_damage"),
        (store_agent_hit_points, ":var22", ":var16", 0),
        (store_agent_hit_points, ":var23", ":var16", 1),
        (assign, reg22, ":var21"),
        (val_mul, ":var21", 10),
        (val_sub, ":var22", ":var21"),
        (val_max, ":var22", 0),
        (agent_set_slot, ":var2", 26, 0),
        (agent_get_horse, ":var24", ":var0"),
        (agent_get_position, pos2, ":var16"),
        (agent_set_look_target_position, ":var2", pos2),
        (agent_set_attack_action, ":var2", 0, 0),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_get_troop_id, ":var10", ":var2"),
        (str_store_troop_name, s21, ":var10"),
        (agent_get_troop_id, ":var25", ":var16"),
        (str_store_troop_name, s20, ":var25"),
        (store_agent_hit_points, ":var22", ":var16", 1),
        (val_sub, ":var23", ":var22"),
        (assign, reg1, ":var23"),
        (try_begin),
          (eq, ":var16", ":var24"),
          (display_message, "@Your horse received {reg1} damage from a braced polearm!", 0xFF4040),
        (try_end),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (store_agent_hit_points, ":var1", ":var0", 1),
      (lt, ":var1", "$spear_hp"),
      (display_message, "@The injury causes your grip on the polearm to slip!", 0xFF4040),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 26),
      (ge, ":var1", 10),
      (assign, ":var2", -1),
      (agent_get_position, pos1, ":var0"),
      (try_for_agents, ":var3"),
        (agent_is_alive, ":var3"),
        (neg|agent_is_human, ":var3"),
        (agent_get_rider, ":var4", ":var3"),
        (ge, ":var4", 0),
        (neg|agent_is_ally, ":var4"),
        (agent_get_position, pos2, ":var3"),
        (get_distance_between_positions, ":var5", pos1, pos2),
        (lt, ":var5", "$spear_dist"),
        (neg|position_is_behind_position, pos2, pos1),
        (agent_get_slot, ":var6", ":var3", 30),
        (ge, ":var6", 120),
        (assign, ":var2", ":var3"),
      (try_end),
      (gt, ":var2", -1),
      (agent_play_sound, ":var2", "snd_metal_hit_high_armor_high_damage"),
      (store_agent_hit_points, ":var7", ":var2", 0),
      (store_agent_hit_points, ":var8", ":var2", 1),
      (val_div, ":var6", 2),
      (val_sub, ":var6", 15),
      (val_sub, ":var7", ":var6"),
      (val_max, ":var7", 0),
      (agent_set_hit_points, ":var2", ":var7", 0),
      (agent_deliver_damage_to_agent, ":var2", ":var2"),
      (agent_set_slot, ":var0", 26, 0),
      (store_agent_hit_points, ":var7", ":var2", 1),
      (val_sub, ":var8", ":var7"),
      (assign, reg1, ":var8"),
      (display_message, "@Polearm-wall dealt {reg1} damage!"),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 2, 
    [
      (key_clicked, key_b),
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_is_alive, ":var1"),
      (agent_get_wielded_item, ":var2", ":var1", 0),
      (agent_get_wielded_item, ":var3", ":var1", 1),
      (assign, "$spear_dist", 145),
      (try_begin),
        (this_or_next|is_between, ":var2", "itm_modded_billhook_fork_1", "itm_maul"),
        (is_between, ":var3", "itm_modded_billhook_fork_1", "itm_maul"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_1"),
          (eq, ":var3", "itm_modded_billhook_fork_1"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_2"),
          (eq, ":var3", "itm_modded_billhook_fork_2"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_1"),
          (eq, ":var3", "itm_modded_fauchard_1"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_2"),
          (eq, ":var3", "itm_modded_fauchard_2"),
          (assign, "$spear_dist", 171),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_3"),
          (eq, ":var3", "itm_modded_fauchard_3"),
          (assign, "$spear_dist", 197),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_4"),
          (eq, ":var3", "itm_modded_fauchard_4"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_1"),
          (eq, ":var3", "itm_modded_glaive_1"),
          (assign, "$spear_dist", 169),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_1"),
          (eq, ":var3", "itm_modded_glaive_fork_1"),
          (assign, "$spear_dist", 230),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_2"),
          (eq, ":var3", "itm_modded_glaive_fork_2"),
          (assign, "$spear_dist", 188),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_roundel"),
          (eq, ":var3", "itm_modded_glaive_roundel"),
          (assign, "$spear_dist", 149),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_1"),
          (eq, ":var3", "itm_modded_bill_1"),
          (assign, "$spear_dist", 215),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_2"),
          (eq, ":var3", "itm_modded_bill_2"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_1"),
          (eq, ":var3", "itm_modded_billhook_1"),
          (assign, "$spear_dist", 207),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_2"),
          (eq, ":var3", "itm_modded_billhook_2"),
          (assign, "$spear_dist", 172),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_3"),
          (eq, ":var3", "itm_modded_billhook_3"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_voulge"),
          (eq, ":var3", "itm_modded_voulge"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_spiked_voulge"),
          (eq, ":var3", "itm_modded_spiked_voulge"),
          (assign, "$spear_dist", 182),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_cleaving_voulge"),
          (eq, ":var3", "itm_modded_cleaving_voulge"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_1"),
          (eq, ":var3", "itm_modded_hooked_voulge_1"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_2"),
          (eq, ":var3", "itm_modded_hooked_voulge_2"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_3"),
          (eq, ":var3", "itm_modded_hooked_voulge_3"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_1"),
          (eq, ":var3", "itm_modded_couteau_1"),
          (assign, "$spear_dist", 177),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_2"),
          (eq, ":var3", "itm_modded_couteau_2"),
          (assign, "$spear_dist", 196),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_guisarme"),
          (eq, ":var3", "itm_modded_guisarme"),
          (assign, "$spear_dist", 232),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_assegai"),
          (eq, ":var3", "itm_modded_assegai"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_pike"),
          (eq, ":var3", "itm_modded_pike"),
          (assign, "$spear_dist", 300),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_war_spear"),
          (eq, ":var3", "itm_modded_war_spear"),
          (assign, "$spear_dist", 211),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_glaive"),
        (is_between, ":var3", "itm_glaive"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_glaive"),
          (eq, ":var3", "itm_glaive"),
          (assign, "$spear_dist", 160),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_bill"),
        (is_between, ":var3", "itm_bill"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_bill"),
          (eq, ":var3", "itm_bill"),
          (assign, "$spear_dist", 128),
        (try_end),
      (try_end),
      (eq, ":var0", 1),
      (agent_get_horse, ":var4", ":var1"),
      (le, ":var4", 0),
      (neq, "$spear_in_position", 1),
      (display_message, "@Bracing polearm for charge.", 0x6495ED),
      (agent_set_animation, ":var1", "anim_spearwall_hold"),
      (assign, "$spear_in_position", 1),
      (store_agent_hit_points, "$spear_hp", ":var1", 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 41, ":var0"),
    ]),

    (0, 0, 3, 
    [
      (key_clicked, key_h),
    ],
    [
      (agent_get_slot, ":var0", "$fplayer_agent_no", 41),
      (gt, ":var0", 0),
      (agent_is_active, ":var0"),
      (agent_get_horse, reg0, "$fplayer_agent_no"),
      (eq, reg0, -1),
      (agent_play_sound, "$fplayer_agent_no", "snd_man_breath_hard"),
      (display_message, "@You whistle for your horse."),
      (agent_is_alive, ":var0"),
      (agent_get_position, pos1, "$fplayer_agent_no"),
      (agent_set_scripted_destination, ":var0", pos1, 0),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_2, ":var0"),
      (ge, ":var0", 0),
      (item_get_type, ":var1", ":var0"),
      (this_or_next|eq, ":var1", 8),
      (eq, ":var1", 9),
      (store_trigger_param_1, ":var2"),
      (agent_is_active, ":var2"),
      (agent_is_alive, ":var2"),
      (agent_is_non_player, ":var2"),
      (agent_get_ammo, ":var3", ":var2", 0),
      (le, ":var3", 0),
      (agent_get_horse, ":var4", ":var2"),
      (eq, ":var4", -1),
      (assign, ":var5", 1),
      (try_begin),
        (this_or_next|party_slot_eq, "$g_encountered_party", 0, 3),
        (party_slot_eq, "$g_encountered_party", 0, 2),
        (agent_get_team, ":var6", ":var2"),
        (this_or_next|eq, ":var6", "$defender_team"),
        (eq, ":var6", "$defender_team_2"),
        (assign, ":var5", 0),
      (try_end),
      (eq, ":var5", 1),
      (agent_set_division, ":var2", 4),
      (agent_set_slot, ":var2", 42, 4),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_slot, ":var0", 42, -1),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_active, ":var0"),
        (agent_slot_ge, ":var0", 42, 0),
        (agent_is_alive, ":var0"),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 42, ":var1"),
        (agent_get_slot, ":var2", ":var0", 42),
        (agent_set_division, ":var0", ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_slot, ":var0", 42, -1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (neg|agent_is_human, ":var0"),
        (agent_get_rider, ":var1", ":var0"),
        (ge, ":var1", 0),
        (agent_is_active, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_is_non_player, ":var1"),
      (else_try),
        (assign, ":var1", -1),
      (try_end),
      (agent_set_slot, ":var0", 41, ":var1"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (neg|agent_is_human, ":var0"),
      (agent_get_slot, ":var1", ":var0", 41),
      (ge, ":var1", 0),
      (agent_is_active, ":var1"),
      (agent_is_alive, ":var1"),
      (try_begin),
        (assign, ":var2", 70),
        (agent_get_troop_id, ":var3", ":var1"),
        (store_skill_level, ":var4", "skl_riding", ":var3"),
        (store_mul, ":var5", ":var4", 5),
        (val_sub, ":var2", ":var5"),
        (call_script, "script_rand", 0, 100),
        (le, reg0, ":var2"),
        (call_script, "script_rand", 60, 80),
        (assign, ":var6", reg0),
        (store_mul, ":var7", ":var4", 7),
        (val_sub, ":var6", ":var7"),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var6"),
        (try_begin),
          (neg|agent_is_non_player, ":var1"),
          (display_message, "@You fall down from your horse and sustain some damage!"),
        (try_end),
      (try_end),
      (try_begin),
        (agent_is_active, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_set_division, ":var1", 0),
        (agent_set_slot, ":var1", 42, 0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_active, ":var0"),
        (agent_slot_ge, ":var0", 42, 0),
        (agent_is_alive, ":var0"),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 42, ":var1"),
        (agent_get_slot, ":var2", ":var0", 42),
        (agent_set_division, ":var0", ":var2"),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (call_script, "script_lance_use_classify_agent"),
    ]),

    (2, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 43),
        (gt, ":var1", 0),
        (agent_get_wielded_item, ":var2", ":var0", 0),
        (agent_get_horse, ":var3", ":var0"),
        (try_begin),
          (le, ":var3", 0),
          (agent_set_slot, ":var0", 43, 0),
          (eq, ":var2", ":var1"),
          (call_script, "script_lance_use_backup_weapon", ":var0"),
        (else_try),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var4", ":var0"),
          (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":var4", 1),
          (assign, ":var5", reg0),
          (try_begin),
            (lt, ":var5", 500),
            (agent_get_combat_state, ":var6", ":var0"),
            (gt, ":var6", 3),
            (eq, ":var2", ":var1"),
            (call_script, "script_lance_use_backup_weapon", ":var0"),
          (else_try),
            (neq, ":var2", ":var1"),
            (agent_set_wielded_item, ":var0", ":var1"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$tom_sand_storm", 0),
      (call_script, "script_change_rain_or_snow"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$tom_sand_storm", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (position_set_z_to_ground_level, pos0),
      (position_get_z, ":var1", pos0),
      (val_add, ":var1", 400),
      (position_set_z, pos0, ":var1"),
      (particle_system_burst, "psys_desert_storm", pos0, 2),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 2, ti_once, 
    [
      (eq, "$tom_use_banners", 1),
    ],
    [
      (call_script, "script_set_flag_carriers"),
    ]),

    (10, 0, 0, 
    [
      (eq, "$tom_use_banners", 1),
      (eq, "$tom_bonus_banners", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_range, ":var1"),
        (agent_slot_eq, ":var1", 40, 1),
        (agent_is_alive, ":var1"),
        (agent_is_active, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (agent_get_position, pos1, ":var1"),
        (try_for_range, ":var3"),
          (neq, ":var3", ":var1"),
          (agent_get_team, ":var4", ":var3"),
          (eq, ":var2", ":var4"),
          (agent_is_alive, ":var3"),
          (agent_is_active, ":var3"),
          (agent_is_human, ":var3"),
          (agent_get_position, pos2, ":var3"),
          (get_distance_between_positions_in_meters, ":var5", pos1, pos2),
          (le, ":var5", 10),
          (store_agent_hit_points, ":var6", ":var3"),
          (val_add, ":var6", 2),
          (val_min, ":var6", 101),
          (agent_set_hit_points, ":var3", ":var6"),
          (try_begin),
            (eq, ":var3", ":var0"),
            (display_message, "@You feel secured standing near the banner, healing some of your HP.", 0x6495ED),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var1", ":var0"),
      (agent_is_alive, ":var1"),
      (agent_get_wielded_item, ":var7", ":var1", 0),
      (is_between, ":var7", 1291, 1295),
      (agent_get_team, ":var2", ":var1"),
      (agent_get_position, pos1, ":var1"),
      (try_for_range, ":var3"),
        (neq, ":var3", ":var1"),
        (agent_get_team, ":var4", ":var3"),
        (eq, ":var2", ":var4"),
        (agent_is_alive, ":var3"),
        (agent_is_active, ":var3"),
        (agent_is_human, ":var3"),
        (agent_get_position, pos2, ":var3"),
        (get_distance_between_positions_in_meters, ":var5", pos1, pos2),
        (le, ":var5", 10),
        (store_agent_hit_points, ":var6", ":var3"),
        (try_begin),
          (eq, ":var7", 1294),
          (val_add, ":var6", 1),
        (try_end),
        (val_add, ":var6", 5),
        (val_max, ":var6", 101),
        (agent_set_hit_points, ":var3", ":var6"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$tom_sand_storm", 3),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (position_set_z_to_ground_level, pos0),
      (position_get_z, ":var1", pos0),
      (val_add, ":var1", 2100),
      (position_set_z, pos0, ":var1"),
      (particle_system_burst, "psys_rain", pos0, 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 0, 
    [
      (eq, "$tom_sand_storm", 2),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (position_set_z_to_ground_level, pos0),
      (position_get_z, ":var1", pos0),
      (val_add, ":var1", 2000),
      (position_set_z, pos0, ":var1"),
      (particle_system_burst, "psys_blizzard", pos0, 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (8, 0, 0, 
    [
      (eq, "$tom_sand_storm", 3),
    ],
    [
      (store_random_in_range, ":var0", 0, 100),
      (try_begin),
        (ge, ":var0", 90),
        (play_sound, "snd_thunder"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (eq, "$tom_sand_storm", 2),
    ],
    [
      (play_sound, "snd_wind"),
    ]),

    (0, 0, ti_once, 
    [
      (eq, "$tom_sand_storm", 1),
    ],
    [
      (play_sound, "snd_wind"),
    ]),

    (0, 1.5, 0, 
    [
      (key_clicked, key_t),
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_set_animation, ":var0", "anim_cheer", 1),
      (agent_play_sound, ":var0", "snd_man_victory"),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_position, pos1, ":var0"),
      (try_for_agents, ":var2"),
        (agent_is_alive, ":var2"),
        (agent_is_human, ":var2"),
        (agent_get_team, ":var3", ":var2"),
        (eq, ":var3", ":var1"),
        (agent_get_position, pos0, ":var2"),
        (get_distance_between_positions_in_meters, ":var4", pos0, pos1),
        (lt, ":var4", 20),
        (agent_set_animation, ":var2", "anim_cheer", 1),
        (agent_play_sound, ":var2", "snd_man_victory"),
        (agent_get_slot, ":var5", ":var2", 16),
        (val_add, ":var5", 5),
        (val_min, ":var5", 9600),
        (agent_set_slot, ":var2", 16, ":var5"),
      (try_end),
      (display_message, "@Huzzah! You encourage your nearby troops."),
    ]),

    (0, 1.7, 0, 
    [
      (eq, "$tom_yell_smelly_peasents", 1),
    ],
    [
      (call_script, "script_tom_command_cheer"),
      (assign, "$tom_yell_smelly_peasents", 0),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (neg|agent_is_ally, ":var0"),
      (agent_is_human, ":var0"),
      (eq, ":var1", "$fplayer_agent_no"),
      (val_add, "$killcount", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_clear_troop_array", "trp_lances_troop_in_combat", 0, "$lance_troop_serving"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_is_human, ":var0"),
      (get_player_agent_no, ":var1"),
      (neq, ":var0", ":var1"),
      (agent_get_party_id, ":var2", ":var0"),
      (eq, ":var2", "p_main_party"),
      (agent_get_troop_id, ":var3", ":var0"),
      (call_script, "script_search_for_troop", ":var3"),
      (agent_set_slot, ":var0", 102, reg0),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$enable_deahtcam", 1),
      (assign, "$auxilary_player_active", 0),
      (eq, "$use_player_auxiliary", 1),
      (assign, "$g_move_heroes", 1),
      (party_clear, "p_temp_casualties_3"),
      (call_script, "script_party_add_party", "p_temp_casualties_3", "p_main_party"),
      (set_player_troop, "trp_player"),
      (assign, "$enable_deahtcam", 0),
    ]),

    (5, 0, 0, 
    [
      (eq, "$use_player_auxiliary", 1),
      (eq, "$enable_deahtcam", 0),
      (get_player_agent_no, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (neq, "$freelancer_state", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_division, ":var2", ":var0"),
      (assign, ":var3", 0),
      (try_for_agents, ":var4"),
        (eq, ":var3", 0),
        (agent_is_human, ":var4"),
        (agent_is_alive, ":var4"),
        (agent_get_team, ":var5", ":var4"),
        (agent_get_party_id, ":var6", ":var4"),
        (eq, ":var6", "p_main_party"),
        (agent_get_division, ":var7", ":var0"),
        (agent_get_group, ":var8", ":var0"),
        (eq, ":var1", ":var5"),
        (eq, ":var2", ":var7"),
        (agent_get_troop_id, ":var9", ":var4"),
        (neg|is_between, ":var9", "trp_npc1", "trp_enhanced_rnd_lord_end"),
        (set_player_troop, ":var9"),
        (store_agent_hit_points, ":var10", ":var4", 1),
        (agent_get_position, pos1, ":var4"),
        (position_set_z, pos1, -2000),
        (position_set_x, pos1, 0),
        (position_set_y, pos1, 0),
        (agent_get_position, pos0, ":var4"),
        (set_spawn_position, pos0),
        (agent_get_horse, ":var11", ":var4"),
        (try_begin),
          (gt, ":var11", 0),
          (agent_set_position, ":var11", pos1),
          (remove_agent, ":var11"),
        (try_end),
        (agent_set_position, ":var4", pos1),
        (agent_set_slot, ":var4", 35, 1),
        (agent_get_slot, ":var12", ":var4", 102),
        (remove_agent, ":var4"),
        (spawn_agent, ":var9"),
        (assign, ":var0", reg0),
        (agent_set_slot, ":var0", 102, ":var12"),
        (agent_set_team, ":var0", ":var1"),
        (agent_set_hit_points, ":var0", ":var10", 1),
        (agent_set_group, ":var0", ":var8"),
        (agent_set_slot, ":var0", 35, 2),
        (agent_set_slot, ":var0", 36, ":var9"),
        (try_begin),
          (agent_get_horse, ":var13", ":var0"),
          (gt, ":var13", 0),
          (lt, ":var11", 0),
          (agent_set_position, ":var13", pos1),
          (remove_agent, ":var13"),
        (try_end),
        (set_player_troop, "trp_player"),
        (assign, ":var3", 1),
        (assign, "$auxilary_player_active", 1),
      (try_end),
      (eq, ":var3", 0),
      (assign, "$enable_deahtcam", 1),
    ]),

    (5, 0, 0, 
    [
      (eq, "$use_player_auxiliary", 1),
      (eq, "$enable_deahtcam", 0),
      (get_player_agent_no, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$enable_deahtcam", 1),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$g_decap_enabled", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (agent_is_non_player, ":var0"),
      (agent_get_troop_id, ":var3", ":var0"),
      (neg|troop_is_hero, ":var3"),
      (assign, ":var4", reg0),
      (copy_position, 5, 0),
      (neq, ":var0", -1),
      (try_begin),
        (agent_is_human, ":var0"),
        (ge, ":var4", 0),
        (assign, ":var5", 0),
        (try_begin),
          (this_or_next|eq, ":var4", "itm_supercrossbow"),
          (eq, ":var4", "itm_supersledge"),
          (assign, ":var5", 1),
        (else_try),
          (neq, ":var4", "itm_mace_1"),
          (neq, ":var4", "itm_mace_2"),
          (neq, ":var4", "itm_mace_3"),
          (neq, ":var4", "itm_staff"),
          (agent_get_action_dir, ":var6", ":var1"),
          (this_or_next|eq, ":var6", 1),
          (eq, ":var6", 2),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var5", 0),
        (try_begin),
          (ge, ":var2", "$g_decap_minimum_damage"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap minimum DMG req bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (store_agent_hit_points, ":var7", ":var0", 1),
        (val_add, ":var7", "$g_decap_negative_health"),
        (ge, ":var2", ":var7"),
        (agent_get_position, pos4, ":var0"),
        (get_distance_between_positions, ":var8", pos4, pos5),
        (agent_get_horse, ":var9", ":var0"),
        (try_begin),
          (ge, ":var9", 0),
          (assign, ":var10", 240),
          (assign, ":var11", 260),
        (else_try),
          (assign, ":var10", 160),
          (assign, ":var11", 176),
        (try_end),
        (is_between, ":var8", ":var10", ":var11"),
        (assign, ":var5", 0),
        (try_begin),
          (store_random_in_range, ":var12", 0, 100),
          (le, ":var12", "$g_decap_chance"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap chance calc bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var13", "itm_cut_off_head_male"),
        (agent_get_troop_id, ":var14", ":var0"),
        (try_begin),
          (ge, ":var14", 0),
          (troop_get_type, ":var15", ":var14"),
          (eq, ":var15", 1),
          (assign, ":var13", "itm_cut_off_head_female"),
        (try_end),
        (store_random_in_range, ":var16", 0, 360),
        (store_random_in_range, ":var17", -60, 60),
        (store_random_in_range, ":var18", -90, 90),
        (store_random_in_range, ":var19", -90, 90),
        (position_rotate_z, pos4, ":var16"),
        (position_rotate_y, pos4, ":var17"),
        (position_move_x, 4, ":var18"),
        (position_move_y, pos4, ":var19"),
        (position_set_z_to_ground_level, pos4),
        (position_move_z, pos4, 5),
        (set_spawn_position, pos4),
        (assign, ":var20", 360),
        (agent_get_item_slot, ":var21", ":var0", 4),
        (try_begin),
          (ge, ":var21", 1),
          (agent_unequip_item, ":var0", ":var21"),
          (try_begin),
            (spawn_item, ":var21", 0, ":var20"),
          (try_end),
        (try_end),
        (agent_equip_item, ":var0", "itm_invisible_head"),
        (agent_get_position, pos4, ":var0"),
        (position_move_z, pos4, ":var10"),
        (particle_system_burst, "psys_blood_decapitation", pos4, "$g_decap_psys_blood_decapitation"),
        (particle_system_burst, "psys_game_blood", pos4, "$g_decap_psys_game_blood"),
        (particle_system_burst, "psys_game_blood_2", pos4, "$g_decap_psys_game_blood_2"),
        (play_sound_at_position, "snd_decapitation", pos4),
        (position_move_z, pos4, 20),
        (set_spawn_position, pos4),
        (assign, ":var13", "spr_head_dynamic_male"),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var13", "spr_head_dynamic_female"),
        (try_end),
        (spawn_scene_prop, ":var13"),
        (agent_get_troop_id, ":var22", ":var1"),
        (str_store_troop_name, s0, ":var22"),
        (agent_get_troop_id, ":var14", ":var0"),
        (str_store_troop_name, s1, ":var14"),
        (get_player_agent_no, ":var23"),
        (agent_get_team, ":var24", ":var23"),
        (agent_get_team, ":var25", ":var0"),
        (try_begin),
          (neq, ":var24", ":var25"),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFF33DD11),
        (else_try),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFFFF4422),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_bully_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_fat_peasant_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_thug_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_fatseveredarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_thin_looter_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (0, 0, 1, 
    [
      (key_clicked, key_right_control),
    ],
    [
      (try_begin),
        (key_is_down, key_m),
        (try_begin),
          (eq, "$g_decapitations_debugging", 0),
          (assign, "$g_decapitations_debugging", 1),
          (display_message, "@Decapitation debug mode Enabled"),
        (else_try),
          (assign, "$g_decapitations_debugging", 0),
          (display_message, "@Decapitation debug mode Disabled"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, key_k),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos17, ":var0"),
        (position_move_y, pos17, 2000),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_bully_handless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_thug_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_thin_looter_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_fat_peasant_handless"),
        (agent_set_team, reg0, 2),
      (try_end),
      (try_begin),
        (key_is_down, key_j),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos18, ":var0"),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supersledge"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supercrossbow"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_super_bolts"),
      (try_end),
    ]),

  ]),

  ("besiege_inner_battle_castle", mtf_battle_mode, -1,
  "You attack the walls of the castle...",
  [
    (0, mtef_team_1|mtef_attackers|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 4, []),
    (6, mtef_team_1|mtef_attackers|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 4, []),
    (7, mtef_team_1|mtef_attackers|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 4, []),
    (16, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 4, []),
    (17, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 4, []),
    (18, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 4, []),
    (19, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 4, []),
    (20, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 4, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 5, 20, 0),
      (assign, "$g_battle_result", -1),
      (set_mission_result, -1),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (call_script, "script_music_set_situation_with_culture", 4096),
      (assign, "$dmod_current_agent", -1),
      (assign, "$dmod_move_camera", -1),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
    ],
    []),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (5, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (try_begin),
        (eq, "$auxilary_player_active", 0),
        (call_script, "script_freelancer_keep_field_loot"),
      (try_end),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (assign, "$do_once_3", 0),
      (finish_mission, 1),
    ]),

    (5, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (val_add, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
      (set_mission_result, -1),
      (display_message, "@Battle lost..."),
      (assign, "$g_battle_won", -1),
      (assign, "$g_battle_result", -1),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (assign, "$do_once_3", 0),
      (finish_mission, 0),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", -1),
      (display_message, "@Battle lost! Press tab key to leave..."),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (gt, "$dmod_current_agent", 0),
      (eq, "$setting_use_dmod", 1),
      (eq, "$dmod_move_camera", 1),
      (agent_get_position, pos1, "$dmod_current_agent"),
      (position_move_z, pos1, 300),
      (position_move_y, pos1, -300),
      (agent_get_horse, ":var0", "$dmod_current_agent"),
      (try_begin),
        (ge, ":var0", 0),
      (try_end),
      (mission_cam_set_position, pos1),
      (mission_cam_set_mode, 1),
      (set_fixed_point_multiplier, 100),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_up),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_forwards"),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_down),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_backwards"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 4, ti_once, 
    [
      (eq, "$enable_deahtcam", 1),
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
      (assign, "$tom_sand_storm", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (this_or_next|eq, "$dmod_move_camera", 1),
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, gk_move_forward),
      (this_or_next|game_key_is_down, gk_move_backward),
      (this_or_next|game_key_is_down, gk_move_left),
      (this_or_next|game_key_is_down, gk_move_right),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_backward),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_left),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (position_rotate_x_floating, pos47, ":var7"),
        (position_rotate_y, pos47, 90),
        (position_rotate_x_floating, pos47, ":var3"),
        (position_rotate_y, pos47, -90),
        (position_rotate_x_floating, pos47, "$deathcam_total_rotx"),
        (position_rotate_x_floating, pos47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|eq, ":var0", 0),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "str_enhanced_battle_knocked_out_message_1"),
      (display_message, "str_enhanced_battle_knocked_out_message_2"),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (is_presentation_active, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (ti_on_agent_hit, 0.3, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (assign, ":var3", reg0),
      (agent_is_human, ":var0"),
      (get_player_agent_no, ":var4"),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var0", ":var4"),
        (store_random_in_range, ":var5", 0, 1000),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 4, 8),
        (troop_get_inventory_slot, ":var7", "trp_player", ":var6"),
        (gt, ":var7", 0),
        (str_store_item_name, s20, ":var7"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var6"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} is too crapy to fall apart!", 0xFF0000),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var7", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var6", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var1", ":var4"),
        (is_between, ":var3", 1, "itm_items_end"),
        (neg|is_between, ":var3", "itm_light_lance", "itm_wooden_shield"),
        (item_get_type, ":var9", ":var3"),
        (ge, ":var2", 10),
        (neq, ":var9", 10),
        (neq, ":var9", 8),
        (neq, ":var9", 9),
        (neq, ":var9", 5),
        (neq, ":var9", 6),
        (store_random_in_range, ":var5", 0, 600),
        (eq, ":var5", 1),
        (assign, ":var10", -1),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var11", "trp_player", ":var6"),
          (eq, ":var11", ":var3"),
          (assign, ":var10", ":var6"),
        (try_end),
        (gt, ":var10", 0),
        (str_store_item_name, s20, ":var3"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var10"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} falls apart!", 0xFF0000),
          (agent_unequip_item, ":var4", ":var3"),
          (troop_remove_item, "trp_player", ":var3"),
          (troop_remove_item, "trp_broken_items", ":var3"),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var3", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var10", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (agent_get_horse, ":var12", ":var1"),
      (try_begin),
        (eq, "$tom_lance_breaking", 1),
        (gt, ":var12", 0),
        (this_or_next|is_between, ":var3", "itm_light_lance", "itm_bamboo_spear"),
        (is_between, ":var3", "itm_crusader_knight_spear_a", "itm_crusader_spear_a"),
        (ge, ":var2", 50),
        (store_random_in_range, ":var13", 0, 100),
        (gt, ":var13", 20),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your lance!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (this_or_next|is_between, ":var3", "itm_bamboo_spear", "itm_staff"),
        (is_between, ":var3", "itm_crusader_spear_a", "itm_mace_6"),
        (le, ":var12", 0),
        (ge, ":var2", 8),
        (store_random_in_range, ":var13", 0, 100),
        (ge, ":var13", 90),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your spear!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$enable_deahtcam", 1),
      (assign, "$auxilary_player_active", 0),
      (eq, "$use_player_auxiliary", 1),
      (assign, "$g_move_heroes", 1),
      (party_clear, "p_temp_casualties_3"),
      (call_script, "script_party_add_party", "p_temp_casualties_3", "p_main_party"),
      (set_player_troop, "trp_player"),
      (assign, "$enable_deahtcam", 0),
    ]),

    (5, 0, 0, 
    [
      (eq, "$use_player_auxiliary", 1),
      (eq, "$enable_deahtcam", 0),
      (get_player_agent_no, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (neq, "$freelancer_state", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_division, ":var2", ":var0"),
      (assign, ":var3", 0),
      (try_for_agents, ":var4"),
        (eq, ":var3", 0),
        (agent_is_human, ":var4"),
        (agent_is_alive, ":var4"),
        (agent_get_team, ":var5", ":var4"),
        (agent_get_party_id, ":var6", ":var4"),
        (eq, ":var6", "p_main_party"),
        (agent_get_division, ":var7", ":var0"),
        (agent_get_group, ":var8", ":var0"),
        (eq, ":var1", ":var5"),
        (eq, ":var2", ":var7"),
        (agent_get_troop_id, ":var9", ":var4"),
        (neg|is_between, ":var9", "trp_npc1", "trp_enhanced_rnd_lord_end"),
        (set_player_troop, ":var9"),
        (store_agent_hit_points, ":var10", ":var4", 1),
        (agent_get_position, pos1, ":var4"),
        (position_set_z, pos1, -2000),
        (position_set_x, pos1, 0),
        (position_set_y, pos1, 0),
        (agent_get_position, pos0, ":var4"),
        (set_spawn_position, pos0),
        (agent_get_horse, ":var11", ":var4"),
        (try_begin),
          (gt, ":var11", 0),
          (agent_set_position, ":var11", pos1),
          (remove_agent, ":var11"),
        (try_end),
        (agent_set_position, ":var4", pos1),
        (agent_set_slot, ":var4", 35, 1),
        (agent_get_slot, ":var12", ":var4", 102),
        (remove_agent, ":var4"),
        (spawn_agent, ":var9"),
        (assign, ":var0", reg0),
        (agent_set_slot, ":var0", 102, ":var12"),
        (agent_set_team, ":var0", ":var1"),
        (agent_set_hit_points, ":var0", ":var10", 1),
        (agent_set_group, ":var0", ":var8"),
        (agent_set_slot, ":var0", 35, 2),
        (agent_set_slot, ":var0", 36, ":var9"),
        (try_begin),
          (agent_get_horse, ":var13", ":var0"),
          (gt, ":var13", 0),
          (lt, ":var11", 0),
          (agent_set_position, ":var13", pos1),
          (remove_agent, ":var13"),
        (try_end),
        (set_player_troop, "trp_player"),
        (assign, ":var3", 1),
        (assign, "$auxilary_player_active", 1),
      (try_end),
      (eq, ":var3", 0),
      (assign, "$enable_deahtcam", 1),
    ]),

    (5, 0, 0, 
    [
      (eq, "$use_player_auxiliary", 1),
      (eq, "$enable_deahtcam", 0),
      (get_player_agent_no, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$enable_deahtcam", 1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

    (2, 0, 0, 
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_non_player, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (store_skill_level, ":var2", "skl_horse_archery", ":var1"),
        (ge, ":var2", 4),
      (try_end),
    ],
    [
      (set_fixed_point_multiplier, 1000),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_non_player, ":var0"),
        (neg|agent_slot_eq, ":var0", 1003, 1),
        (agent_get_horse, ":var1", ":var0"),
        (assign, ":var2", -1),
        (try_begin),
          (agent_slot_eq, ":var0", 15, 0),
          (gt, ":var1", -1),
          (agent_get_team, ":var3", ":var0"),
          (agent_get_division, ":var4", ":var0"),
          (team_get_weapon_usage_order, ":var5", ":var3", ":var4"),
          (team_get_movement_order, ":var6", ":var3", ":var4"),
          (team_get_hold_fire_order, ":var7", ":var3", ":var4"),
          (assign, ":var8", 0),
          (assign, ":var9", -1),
          (try_for_range, ":var10", 0, 4),
            (agent_get_item_slot, ":var11", ":var0", ":var10"),
            (gt, ":var11", 0),
            (item_get_type, ":var12", ":var11"),
            (try_begin),
              (eq, ":var12", 10),
              (agent_get_ammo_for_slot, ":var13", ":var0", ":var10"),
              (val_add, ":var8", ":var13"),
            (else_try),
              (this_or_next|eq, ":var12", 8),
              (this_or_next|eq, ":var12", 16),
              (eq, ":var12", 17),
              (assign, ":var9", ":var11"),
            (else_try),
              (this_or_next|eq, ":var12", 2),
              (this_or_next|eq, ":var12", 3),
              (eq, ":var12", 4),
              (assign, ":var2", ":var11"),
            (try_end),
          (try_end),
          (gt, ":var9", -1),
          (neg|item_has_property, ":var9", itp_cant_reload_on_horseback),
          (neg|item_has_property, ":var9", itp_cant_use_on_horseback),
          (agent_get_ammo, ":var14", ":var0", 0),
          (val_sub, ":var14", ":var8"),
          (gt, ":var14", 0),
          (agent_set_slot, ":var0", 1003, 2),
          (neq, ":var7", 1),
          (neq, ":var5", 2),
          (eq, ":var6", 2),
          (agent_get_position, pos50, ":var0"),
          (agent_get_speed, pos31, ":var0"),
          (position_get_y, ":var15", pos31),
          (assign, ":var16", 100000),
          (assign, ":var17", -1),
          (try_for_agents, ":var18"),
            (agent_is_alive, ":var18"),
            (agent_is_human, ":var18"),
            (agent_get_position, pos36, ":var18"),
            (agent_get_team, ":var19", ":var18"),
            (teams_are_enemies, ":var3", ":var19"),
            (get_distance_between_positions, ":var20", pos50, pos36),
            (try_begin),
              (agent_slot_eq, ":var18", 15, 1),
              (val_add, ":var20", 10000),
            (try_end),
            (try_begin),
              (agent_get_horse, ":var21", ":var18"),
              (gt, ":var21", -1),
              (agent_get_speed, pos32, ":var18"),
              (position_get_y, ":var22", pos32),
              (val_sub, ":var22", ":var15"),
              (store_div, ":var23", ":var22", 5),
              (val_max, ":var23", 0),
              (val_add, ":var23", 500),
              (val_sub, ":var20", ":var23"),
            (else_try),
              (agent_get_wielded_item, ":var24", ":var18", 1),
              (le, ":var24", 1),
              (val_sub, ":var20", 500),
            (try_end),
            (lt, ":var20", ":var16"),
            (assign, ":var16", ":var20"),
            (assign, ":var17", ":var18"),
          (try_end),
          (neq, ":var17", -1),
          (agent_get_position, pos51, ":var17"),
          (get_distance_between_positions, ":var25", pos50, pos51),
          (try_begin),
            (agent_slot_eq, ":var17", 15, 0),
            (gt, ":var25", 200),
            (agent_set_wielded_item, ":var0", ":var9"),
          (else_try),
            (le, ":var25", 200),
            (gt, ":var2", -1),
            (agent_set_wielded_item, ":var0", ":var2"),
          (try_end),
          (assign, ":var26", 1000),
          (try_begin),
            (agent_get_wielded_item, ":var24", ":var0", 0),
            (gt, ":var24", 0),
            (item_get_type, ":var27", ":var24"),
            (this_or_next|eq, ":var27", 8),
            (this_or_next|eq, ":var27", 16),
            (eq, ":var27", 17),
            (agent_get_bone_position, pos53, ":var0", 8, 1),
            (agent_get_bone_position, pos54, ":var17", 9, 1),
            (position_has_line_of_sight_to_position, pos53, pos54),
            (agent_set_look_target_agent, ":var0", ":var17"),
            (try_begin),
              (assign, ":var28", 4000),
              (agent_get_attack_action, ":var29", ":var0"),
              (eq, ":var29", 1),
              (try_begin),
                (gt, ":var16", 700),
                (le, ":var16", ":var28"),
                (store_div, ":var26", ":var15", 2000),
                (val_max, ":var26", 0),
              (try_end),
              (eq, ":var27", 8),
              (try_begin),
                (le, ":var25", ":var28"),
                (agent_set_defend_action, ":var0", -2, 1),
                (agent_set_attack_action, ":var0", 3, 0),
              (else_try),
                (gt, ":var25", ":var28"),
                (agent_set_attack_action, ":var0", -2, 1),
                (agent_set_defend_action, ":var0", 3, 1),
              (try_end),
            (else_try),
              (eq, ":var27", 8),
              (le, ":var25", ":var28"),
              (agent_get_combat_state, ":var30", ":var0"),
              (neq, ":var30", 8),
              (agent_set_attack_action, ":var0", 3, 1),
            (try_end),
          (try_end),
          (agent_set_speed_limit, ":var0", ":var26"),
          (try_begin),
            (agent_slot_eq, ":var17", 15, 0),
            (lt, ":var16", 10000),
            (try_begin),
              (get_scene_boundaries, pos2, pos3),
              (position_transform_position_to_local, pos4, pos2, pos50),
              (position_get_x, ":var31", pos4),
              (position_get_y, ":var32", pos4),
              (position_transform_position_to_local, pos4, pos2, pos3),
              (position_get_x, ":var33", pos4),
              (position_get_y, ":var34", pos4),
              (store_sub, ":var35", ":var33", ":var31"),
              (store_sub, ":var36", ":var34", ":var32"),
              (position_transform_position_to_local, pos4, pos50, pos51),
              (position_get_x, ":var37", pos4),
              (position_get_y, ":var38", pos4),
              (assign, ":var39", 0),
              (try_begin),
                (le, ":var16", 1000),
                (assign, ":var39", -78000),
              (else_try),
                (gt, ":var16", 2000),
                (store_sub, ":var39", ":var16", 0),
                (val_mul, ":var39", 5),
                (val_clamp, ":var39", 35000, 90000),
              (try_end),
              (assign, ":var40", 30000),
              (val_min, ":var40", ":var31"),
              (val_min, ":var40", ":var36"),
              (val_min, ":var40", ":var35"),
              (val_min, ":var40", ":var32"),
              (try_begin),
                (lt, ":var40", 30000),
                (agent_slot_eq, ":var17", 15, 0),
                (store_div, ":var41", ":var33", 20),
                (store_div, ":var42", ":var34", 20),
                (position_copy_origin, pos4, pos2),
                (position_move_x, 4, ":var41", 1),
                (position_move_y, pos4, ":var42", 1),
                (get_distance_between_positions, ":var43", pos4, pos50),
                (position_transform_position_to_local, pos4, pos50, pos4),
                (position_get_x, ":var41", pos4),
                (position_get_y, ":var42", pos4),
                (val_mul, ":var41", 100),
                (val_mul, ":var42", 100),
                (val_mul, ":var37", 100),
                (val_mul, ":var38", 100),
                (store_div, ":var44", ":var41", ":var43"),
                (store_div, ":var45", ":var42", ":var43"),
                (store_div, ":var46", ":var37", ":var25"),
                (store_div, ":var47", ":var38", ":var25"),
                (store_acos, ":var48", ":var44"),
                (store_asin, ":var49", ":var45"),
                (store_acos, ":var50", ":var46"),
                (store_asin, ":var51", ":var47"),
                (try_begin),
                  (lt, ":var49", 0),
                  (val_mul, ":var48", -1),
                  (val_add, ":var48", 360000),
                (try_end),
                (try_begin),
                  (lt, ":var51", 0),
                  (val_mul, ":var50", -1),
                  (val_add, ":var50", 360000),
                (try_end),
                (store_sub, ":var52", ":var48", ":var50"),
                (val_sub, ":var52", 270000),
                (val_sub, ":var52", ":var39"),
                (store_add, ":var39", ":var52", ":var39"),
                (try_begin),
                  (lt, ":var48", ":var50"),
                  (val_add, ":var39", 360000),
                (try_end),
                (val_clamp, ":var39", -210000, 15000),
                (agent_set_attack_action, ":var0", -2, 1),
                (agent_set_defend_action, ":var0", 3, 1),
              (try_end),
              (store_cos, ":var53", ":var39"),
              (store_sin, ":var54", ":var39"),
              (store_mul, ":var55", ":var53", ":var38"),
              (store_mul, ":var56", ":var54", ":var37"),
              (store_mul, ":var57", ":var54", ":var38"),
              (store_mul, ":var58", ":var53", ":var37"),
              (store_add, ":var59", ":var55", ":var56"),
              (store_sub, ":var60", ":var57", ":var58"),
              (position_move_x, 50, ":var59", 0),
              (position_move_y, pos50, ":var60", 0),
            (try_end),
            (agent_set_scripted_destination, ":var0", pos50, 1),
          (else_try),
            (agent_clear_scripted_mode, ":var0"),
            (agent_force_rethink, ":var0"),
          (try_end),
        (else_try),
          (try_begin),
            (agent_slot_eq, ":var0", 1003, 0),
            (agent_set_slot, ":var0", 1003, 1),
          (else_try),
            (agent_slot_eq, ":var0", 1003, 2),
            (this_or_next|agent_slot_eq, ":var0", 15, 1),
            (this_or_next|lt, ":var1", 0),
            (this_or_next|eq, ":var14", 0),
            (this_or_next|eq, ":var7", 1),
            (this_or_next|eq, ":var5", 2),
            (neq, ":var6", 2),
            (agent_clear_scripted_mode, ":var0"),
            (agent_set_speed_limit, ":var0", 100),
            (agent_force_rethink, ":var0"),
            (agent_set_slot, ":var0", 1003, 3),
            (this_or_next|eq, ":var7", 1),
            (eq, ":var14", 0),
            (gt, ":var2", -1),
            (agent_set_wielded_item, ":var0", ":var2"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [
      (neg|is_presentation_active, "prsnt_killcount"),
      (neg|is_presentation_active, "prsnt_troop_ratio_bar"),
      (neg|is_presentation_active, "prsnt_killcount_and_troop_ratio_bar"),
    ],
    [
      (try_begin),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 1),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 2),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 3),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
      (call_script, "script_party_count_fit_for_battle", "p_main_party"),
      (assign, "$player_count_alive", reg0),
      (call_script, "script_party_count_fit_for_battle", "p_collective_friends"),
      (store_sub, "$ally_count_alive", reg0, "$player_count_alive"),
      (call_script, "script_party_count_fit_for_battle", "p_collective_enemy"),
      (assign, "$enemy_count_alive", reg0),
    ]),

    (3, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 1),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 2),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 3),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
    ]),

    (0.2, 0, ti_once, 
    [],
    [
      (assign, "$spear_in_position", 0),
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 26, 0),
        (agent_set_slot, ":var0", 27, 0),
        (agent_set_slot, ":var0", 28, 0),
        (agent_set_slot, ":var0", 29, 0),
        (agent_set_slot, ":var0", 30, 0),
      (try_end),
    ]),

    (0.5, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 27),
        (agent_get_slot, ":var2", ":var0", 28),
        (agent_get_slot, ":var3", ":var0", 29),
        (agent_get_position, pos1, ":var0"),
        (position_get_x, ":var4", pos1),
        (position_get_y, ":var5", pos1),
        (position_get_z, ":var6", pos1),
        (position_set_x, pos2, ":var1"),
        (position_set_y, pos2, ":var2"),
        (position_set_z, pos2, ":var3"),
        (position_set_x, pos1, ":var4"),
        (position_set_y, pos1, ":var5"),
        (position_set_z, pos1, ":var6"),
        (agent_get_speed, pos5, ":var0"),
        (call_script, "script_vector_length", 5),
        (assign, ":var7", reg0),
        (agent_set_slot, ":var0", 27, ":var4"),
        (agent_set_slot, ":var0", 28, ":var5"),
        (agent_set_slot, ":var0", 29, ":var6"),
        (agent_set_slot, ":var0", 30, ":var7"),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
      (this_or_next|game_key_clicked, gk_attack),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_move_forward),
      (this_or_next|game_key_clicked, gk_move_backward),
      (this_or_next|game_key_clicked, gk_move_left),
      (this_or_next|game_key_clicked, gk_move_right),
      (this_or_next|game_key_clicked, gk_equip_primary_weapon),
      (this_or_next|game_key_clicked, gk_equip_secondary_weapon),
      (this_or_next|game_key_clicked, gk_action),
      (game_key_clicked, gk_sheath_weapon),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (display_message, "@Releasing spear.", 0x6495ED),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
    ]),

    (0.2, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_get_horse, ":var1", ":var0"),
        (le, ":var1", 0),
        (agent_get_slot, ":var2", ":var0", 26),
        (lt, ":var2", 10),
        (val_add, ":var2", 2),
        (agent_set_slot, ":var0", 26, ":var2"),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_set_animation, ":var0", "anim_spearwall_hold"),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (try_for_agents, ":var2"),
        (agent_is_alive, ":var2"),
        (neq, ":var2", ":var0"),
        (agent_is_human, ":var2"),
        (agent_get_horse, ":var3", ":var2"),
        (le, ":var3", 0),
        (agent_get_slot, ":var4", ":var2", 26),
        (ge, ":var4", 10),
        (agent_get_simple_behavior, ":var5", ":var2"),
        (agent_get_team, ":var6", ":var2"),
        (agent_get_class, ":var7", ":var2"),
        (team_get_movement_order, ":var8", ":var6", ":var7"),
        (assign, ":var9", 0),
        (try_begin),
          (neq, ":var6", ":var1"),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (else_try),
          (this_or_next|eq, ":var8", 0),
          (eq, ":var8", 11),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (this_or_next|eq, ":var5", 4),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (try_end),
        (eq, ":var9", 1),
        (agent_get_troop_id, ":var10", ":var2"),
        (store_proficiency_level, ":var11", ":var10", ca_intelligence),
        (store_character_level, ":var12", ":var10"),
        (ge, ":var12", 12),
        (ge, ":var11", 120),
        (neg|troop_is_mounted, ":var10"),
        (agent_slot_eq, ":var2", 15, 0),
        (assign, ":var9", 0),
        (agent_get_wielded_item, ":var13", ":var2", 0),
        (agent_get_wielded_item, ":var14", ":var2", 1),
        (assign, ":var15", 145),
        (try_begin),
          (this_or_next|is_between, ":var13", "itm_modded_billhook_fork_1", "itm_maul"),
          (is_between, ":var14", "itm_modded_billhook_fork_1", "itm_maul"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_1"),
            (eq, ":var14", "itm_modded_billhook_fork_1"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_2"),
            (eq, ":var14", "itm_modded_billhook_fork_2"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_1"),
            (eq, ":var14", "itm_modded_fauchard_1"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_2"),
            (eq, ":var14", "itm_modded_fauchard_2"),
            (assign, "$spear_dist", 171),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_3"),
            (eq, ":var14", "itm_modded_fauchard_3"),
            (assign, "$spear_dist", 197),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_4"),
            (eq, ":var14", "itm_modded_fauchard_4"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_1"),
            (eq, ":var14", "itm_modded_glaive_1"),
            (assign, "$spear_dist", 169),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_1"),
            (eq, ":var14", "itm_modded_glaive_fork_1"),
            (assign, "$spear_dist", 230),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_2"),
            (eq, ":var14", "itm_modded_glaive_fork_2"),
            (assign, "$spear_dist", 188),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_roundel"),
            (eq, ":var14", "itm_modded_glaive_roundel"),
            (assign, "$spear_dist", 149),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_1"),
            (eq, ":var14", "itm_modded_bill_1"),
            (assign, "$spear_dist", 215),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_2"),
            (eq, ":var14", "itm_modded_bill_2"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_1"),
            (eq, ":var14", "itm_modded_billhook_1"),
            (assign, "$spear_dist", 207),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_2"),
            (eq, ":var14", "itm_modded_billhook_2"),
            (assign, "$spear_dist", 172),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_3"),
            (eq, ":var14", "itm_modded_billhook_3"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_voulge"),
            (eq, ":var14", "itm_modded_voulge"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_spiked_voulge"),
            (eq, ":var14", "itm_modded_spiked_voulge"),
            (assign, "$spear_dist", 182),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_cleaving_voulge"),
            (eq, ":var14", "itm_modded_cleaving_voulge"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_1"),
            (eq, ":var14", "itm_modded_hooked_voulge_1"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_2"),
            (eq, ":var14", "itm_modded_hooked_voulge_2"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_3"),
            (eq, ":var14", "itm_modded_hooked_voulge_3"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_1"),
            (eq, ":var14", "itm_modded_couteau_1"),
            (assign, "$spear_dist", 177),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_2"),
            (eq, ":var14", "itm_modded_couteau_2"),
            (assign, "$spear_dist", 196),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_guisarme"),
            (eq, ":var14", "itm_modded_guisarme"),
            (assign, "$spear_dist", 232),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_assegai"),
            (eq, ":var14", "itm_modded_assegai"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_pike"),
            (eq, ":var14", "itm_modded_pike"),
            (assign, "$spear_dist", 300),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_war_spear"),
            (eq, ":var14", "itm_modded_war_spear"),
            (assign, "$spear_dist", 211),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_glaive"),
          (is_between, ":var14", "itm_glaive"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_glaive"),
            (eq, ":var14", "itm_glaive"),
            (assign, "$spear_dist", 160),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_bill"),
          (is_between, ":var14", "itm_bill"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_bill"),
            (eq, ":var14", "itm_bill"),
            (assign, "$spear_dist", 128),
          (try_end),
        (try_end),
        (eq, ":var9", 1),
        (assign, ":var16", -1),
        (agent_get_position, pos1, ":var2"),
        (try_for_agents, ":var17"),
          (agent_is_alive, ":var17"),
          (neg|agent_is_human, ":var17"),
          (agent_get_rider, ":var18", ":var17"),
          (ge, ":var18", 0),
          (agent_get_team, ":var19", ":var18"),
          (teams_are_enemies, ":var6", ":var19"),
          (agent_get_position, pos2, ":var17"),
          (get_distance_between_positions, ":var20", pos1, pos2),
          (lt, ":var20", ":var15"),
          (neg|position_is_behind_position, pos2, pos1),
          (agent_get_slot, ":var21", ":var17", 30),
          (gt, ":var21", 0),
          (assign, ":var16", ":var17"),
        (try_end),
        (gt, ":var16", -1),
        (agent_play_sound, ":var16", "snd_metal_hit_high_armor_high_damage"),
        (store_agent_hit_points, ":var22", ":var16", 0),
        (store_agent_hit_points, ":var23", ":var16", 1),
        (assign, reg22, ":var21"),
        (val_mul, ":var21", 10),
        (val_sub, ":var22", ":var21"),
        (val_max, ":var22", 0),
        (agent_set_slot, ":var2", 26, 0),
        (agent_get_horse, ":var24", ":var0"),
        (agent_get_position, pos2, ":var16"),
        (agent_set_look_target_position, ":var2", pos2),
        (agent_set_attack_action, ":var2", 0, 0),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_get_troop_id, ":var10", ":var2"),
        (str_store_troop_name, s21, ":var10"),
        (agent_get_troop_id, ":var25", ":var16"),
        (str_store_troop_name, s20, ":var25"),
        (store_agent_hit_points, ":var22", ":var16", 1),
        (val_sub, ":var23", ":var22"),
        (assign, reg1, ":var23"),
        (try_begin),
          (eq, ":var16", ":var24"),
          (display_message, "@Your horse received {reg1} damage from a braced polearm!", 0xFF4040),
        (try_end),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (store_agent_hit_points, ":var1", ":var0", 1),
      (lt, ":var1", "$spear_hp"),
      (display_message, "@The injury causes your grip on the polearm to slip!", 0xFF4040),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 26),
      (ge, ":var1", 10),
      (assign, ":var2", -1),
      (agent_get_position, pos1, ":var0"),
      (try_for_agents, ":var3"),
        (agent_is_alive, ":var3"),
        (neg|agent_is_human, ":var3"),
        (agent_get_rider, ":var4", ":var3"),
        (ge, ":var4", 0),
        (neg|agent_is_ally, ":var4"),
        (agent_get_position, pos2, ":var3"),
        (get_distance_between_positions, ":var5", pos1, pos2),
        (lt, ":var5", "$spear_dist"),
        (neg|position_is_behind_position, pos2, pos1),
        (agent_get_slot, ":var6", ":var3", 30),
        (ge, ":var6", 120),
        (assign, ":var2", ":var3"),
      (try_end),
      (gt, ":var2", -1),
      (agent_play_sound, ":var2", "snd_metal_hit_high_armor_high_damage"),
      (store_agent_hit_points, ":var7", ":var2", 0),
      (store_agent_hit_points, ":var8", ":var2", 1),
      (val_div, ":var6", 2),
      (val_sub, ":var6", 15),
      (val_sub, ":var7", ":var6"),
      (val_max, ":var7", 0),
      (agent_set_hit_points, ":var2", ":var7", 0),
      (agent_deliver_damage_to_agent, ":var2", ":var2"),
      (agent_set_slot, ":var0", 26, 0),
      (store_agent_hit_points, ":var7", ":var2", 1),
      (val_sub, ":var8", ":var7"),
      (assign, reg1, ":var8"),
      (display_message, "@Polearm-wall dealt {reg1} damage!"),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 2, 
    [
      (key_clicked, key_b),
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_is_alive, ":var1"),
      (agent_get_wielded_item, ":var2", ":var1", 0),
      (agent_get_wielded_item, ":var3", ":var1", 1),
      (assign, "$spear_dist", 145),
      (try_begin),
        (this_or_next|is_between, ":var2", "itm_modded_billhook_fork_1", "itm_maul"),
        (is_between, ":var3", "itm_modded_billhook_fork_1", "itm_maul"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_1"),
          (eq, ":var3", "itm_modded_billhook_fork_1"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_2"),
          (eq, ":var3", "itm_modded_billhook_fork_2"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_1"),
          (eq, ":var3", "itm_modded_fauchard_1"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_2"),
          (eq, ":var3", "itm_modded_fauchard_2"),
          (assign, "$spear_dist", 171),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_3"),
          (eq, ":var3", "itm_modded_fauchard_3"),
          (assign, "$spear_dist", 197),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_4"),
          (eq, ":var3", "itm_modded_fauchard_4"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_1"),
          (eq, ":var3", "itm_modded_glaive_1"),
          (assign, "$spear_dist", 169),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_1"),
          (eq, ":var3", "itm_modded_glaive_fork_1"),
          (assign, "$spear_dist", 230),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_2"),
          (eq, ":var3", "itm_modded_glaive_fork_2"),
          (assign, "$spear_dist", 188),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_roundel"),
          (eq, ":var3", "itm_modded_glaive_roundel"),
          (assign, "$spear_dist", 149),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_1"),
          (eq, ":var3", "itm_modded_bill_1"),
          (assign, "$spear_dist", 215),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_2"),
          (eq, ":var3", "itm_modded_bill_2"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_1"),
          (eq, ":var3", "itm_modded_billhook_1"),
          (assign, "$spear_dist", 207),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_2"),
          (eq, ":var3", "itm_modded_billhook_2"),
          (assign, "$spear_dist", 172),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_3"),
          (eq, ":var3", "itm_modded_billhook_3"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_voulge"),
          (eq, ":var3", "itm_modded_voulge"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_spiked_voulge"),
          (eq, ":var3", "itm_modded_spiked_voulge"),
          (assign, "$spear_dist", 182),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_cleaving_voulge"),
          (eq, ":var3", "itm_modded_cleaving_voulge"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_1"),
          (eq, ":var3", "itm_modded_hooked_voulge_1"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_2"),
          (eq, ":var3", "itm_modded_hooked_voulge_2"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_3"),
          (eq, ":var3", "itm_modded_hooked_voulge_3"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_1"),
          (eq, ":var3", "itm_modded_couteau_1"),
          (assign, "$spear_dist", 177),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_2"),
          (eq, ":var3", "itm_modded_couteau_2"),
          (assign, "$spear_dist", 196),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_guisarme"),
          (eq, ":var3", "itm_modded_guisarme"),
          (assign, "$spear_dist", 232),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_assegai"),
          (eq, ":var3", "itm_modded_assegai"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_pike"),
          (eq, ":var3", "itm_modded_pike"),
          (assign, "$spear_dist", 300),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_war_spear"),
          (eq, ":var3", "itm_modded_war_spear"),
          (assign, "$spear_dist", 211),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_glaive"),
        (is_between, ":var3", "itm_glaive"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_glaive"),
          (eq, ":var3", "itm_glaive"),
          (assign, "$spear_dist", 160),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_bill"),
        (is_between, ":var3", "itm_bill"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_bill"),
          (eq, ":var3", "itm_bill"),
          (assign, "$spear_dist", 128),
        (try_end),
      (try_end),
      (eq, ":var0", 1),
      (agent_get_horse, ":var4", ":var1"),
      (le, ":var4", 0),
      (neq, "$spear_in_position", 1),
      (display_message, "@Bracing polearm for charge.", 0x6495ED),
      (agent_set_animation, ":var1", "anim_spearwall_hold"),
      (assign, "$spear_in_position", 1),
      (store_agent_hit_points, "$spear_hp", ":var1", 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 41, ":var0"),
    ]),

    (0, 0, 3, 
    [
      (key_clicked, key_h),
    ],
    [
      (agent_get_slot, ":var0", "$fplayer_agent_no", 41),
      (gt, ":var0", 0),
      (agent_is_active, ":var0"),
      (agent_get_horse, reg0, "$fplayer_agent_no"),
      (eq, reg0, -1),
      (agent_play_sound, "$fplayer_agent_no", "snd_man_breath_hard"),
      (display_message, "@You whistle for your horse."),
      (agent_is_alive, ":var0"),
      (agent_get_position, pos1, "$fplayer_agent_no"),
      (agent_set_scripted_destination, ":var0", pos1, 0),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_2, ":var0"),
      (ge, ":var0", 0),
      (item_get_type, ":var1", ":var0"),
      (this_or_next|eq, ":var1", 8),
      (eq, ":var1", 9),
      (store_trigger_param_1, ":var2"),
      (agent_is_active, ":var2"),
      (agent_is_alive, ":var2"),
      (agent_is_non_player, ":var2"),
      (agent_get_ammo, ":var3", ":var2", 0),
      (le, ":var3", 0),
      (agent_get_horse, ":var4", ":var2"),
      (eq, ":var4", -1),
      (assign, ":var5", 1),
      (try_begin),
        (this_or_next|party_slot_eq, "$g_encountered_party", 0, 3),
        (party_slot_eq, "$g_encountered_party", 0, 2),
        (agent_get_team, ":var6", ":var2"),
        (this_or_next|eq, ":var6", "$defender_team"),
        (eq, ":var6", "$defender_team_2"),
        (assign, ":var5", 0),
      (try_end),
      (eq, ":var5", 1),
      (agent_set_division, ":var2", 4),
      (agent_set_slot, ":var2", 42, 4),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_slot, ":var0", 42, -1),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_active, ":var0"),
        (agent_slot_ge, ":var0", 42, 0),
        (agent_is_alive, ":var0"),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 42, ":var1"),
        (agent_get_slot, ":var2", ":var0", 42),
        (agent_set_division, ":var0", ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_slot, ":var0", 42, -1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (neg|agent_is_human, ":var0"),
        (agent_get_rider, ":var1", ":var0"),
        (ge, ":var1", 0),
        (agent_is_active, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_is_non_player, ":var1"),
      (else_try),
        (assign, ":var1", -1),
      (try_end),
      (agent_set_slot, ":var0", 41, ":var1"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (neg|agent_is_human, ":var0"),
      (agent_get_slot, ":var1", ":var0", 41),
      (ge, ":var1", 0),
      (agent_is_active, ":var1"),
      (agent_is_alive, ":var1"),
      (try_begin),
        (assign, ":var2", 70),
        (agent_get_troop_id, ":var3", ":var1"),
        (store_skill_level, ":var4", "skl_riding", ":var3"),
        (store_mul, ":var5", ":var4", 5),
        (val_sub, ":var2", ":var5"),
        (call_script, "script_rand", 0, 100),
        (le, reg0, ":var2"),
        (call_script, "script_rand", 60, 80),
        (assign, ":var6", reg0),
        (store_mul, ":var7", ":var4", 7),
        (val_sub, ":var6", ":var7"),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var6"),
        (try_begin),
          (neg|agent_is_non_player, ":var1"),
          (display_message, "@You fall down from your horse and sustain some damage!"),
        (try_end),
      (try_end),
      (try_begin),
        (agent_is_active, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_set_division, ":var1", 0),
        (agent_set_slot, ":var1", 42, 0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_active, ":var0"),
        (agent_slot_ge, ":var0", 42, 0),
        (agent_is_alive, ":var0"),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 42, ":var1"),
        (agent_get_slot, ":var2", ":var0", 42),
        (agent_set_division, ":var0", ":var2"),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (call_script, "script_lance_use_classify_agent"),
    ]),

    (2, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 43),
        (gt, ":var1", 0),
        (agent_get_wielded_item, ":var2", ":var0", 0),
        (agent_get_horse, ":var3", ":var0"),
        (try_begin),
          (le, ":var3", 0),
          (agent_set_slot, ":var0", 43, 0),
          (eq, ":var2", ":var1"),
          (call_script, "script_lance_use_backup_weapon", ":var0"),
        (else_try),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var4", ":var0"),
          (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":var4", 1),
          (assign, ":var5", reg0),
          (try_begin),
            (lt, ":var5", 500),
            (agent_get_combat_state, ":var6", ":var0"),
            (gt, ":var6", 3),
            (eq, ":var2", ":var1"),
            (call_script, "script_lance_use_backup_weapon", ":var0"),
          (else_try),
            (neq, ":var2", ":var1"),
            (agent_set_wielded_item, ":var0", ":var1"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (eq, "$freelancer_state", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (ge, ":var0", 0),
      (agent_is_active, ":var0"),
      (store_trigger_param_1, ":var1"),
      (eq, ":var0", ":var1"),
      (agent_get_team, ":var2", ":var0"),
      (team_set_order_listener, ":var2", -1),
      (val_add, ":var2", 2),
      (agent_set_team, ":var0", ":var2"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
    ]),

  ]),

  ("besiege_inner_battle_town_center", mtf_battle_mode, -1,
  "You attack the walls of the castle...",
  [
    (0, mtef_team_1|mtef_attackers|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 16, []),
    (2, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 4, []),
    (23, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 4, []),
    (24, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 4, []),
    (25, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 4, []),
    (26, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 4, []),
    (27, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 4, []),
    (28, mtef_team_0|mtef_defenders|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 4, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 5, 20, 0),
      (assign, "$g_battle_result", -1),
      (set_mission_result, -1),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (call_script, "script_music_set_situation_with_culture", 4096),
      (assign, "$dmod_current_agent", -1),
      (assign, "$dmod_move_camera", -1),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
    ],
    []),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (5, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (try_begin),
        (eq, "$auxilary_player_active", 0),
        (call_script, "script_freelancer_keep_field_loot"),
      (try_end),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (assign, "$do_once_3", 0),
      (finish_mission, 1),
    ]),

    (5, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (val_add, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
      (set_mission_result, -1),
      (display_message, "@Battle lost..."),
      (assign, "$g_battle_won", -1),
      (assign, "$g_battle_result", -1),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (assign, "$do_once_3", 0),
      (finish_mission, 0),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", -1),
      (display_message, "@Battle lost! Press tab key to leave..."),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (gt, "$dmod_current_agent", 0),
      (eq, "$setting_use_dmod", 1),
      (eq, "$dmod_move_camera", 1),
      (agent_get_position, pos1, "$dmod_current_agent"),
      (position_move_z, pos1, 300),
      (position_move_y, pos1, -300),
      (agent_get_horse, ":var0", "$dmod_current_agent"),
      (try_begin),
        (ge, ":var0", 0),
      (try_end),
      (mission_cam_set_position, pos1),
      (mission_cam_set_mode, 1),
      (set_fixed_point_multiplier, 100),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_up),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_forwards"),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_down),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_backwards"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 4, ti_once, 
    [
      (eq, "$enable_deahtcam", 1),
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
      (assign, "$tom_sand_storm", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (this_or_next|eq, "$dmod_move_camera", 1),
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, gk_move_forward),
      (this_or_next|game_key_is_down, gk_move_backward),
      (this_or_next|game_key_is_down, gk_move_left),
      (this_or_next|game_key_is_down, gk_move_right),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_backward),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_left),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (position_rotate_x_floating, pos47, ":var7"),
        (position_rotate_y, pos47, 90),
        (position_rotate_x_floating, pos47, ":var3"),
        (position_rotate_y, pos47, -90),
        (position_rotate_x_floating, pos47, "$deathcam_total_rotx"),
        (position_rotate_x_floating, pos47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|eq, ":var0", 0),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "str_enhanced_battle_knocked_out_message_1"),
      (display_message, "str_enhanced_battle_knocked_out_message_2"),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (is_presentation_active, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (ti_on_agent_hit, 0.3, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (assign, ":var3", reg0),
      (agent_is_human, ":var0"),
      (get_player_agent_no, ":var4"),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var0", ":var4"),
        (store_random_in_range, ":var5", 0, 1000),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 4, 8),
        (troop_get_inventory_slot, ":var7", "trp_player", ":var6"),
        (gt, ":var7", 0),
        (str_store_item_name, s20, ":var7"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var6"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} is too crapy to fall apart!", 0xFF0000),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var7", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var6", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var1", ":var4"),
        (is_between, ":var3", 1, "itm_items_end"),
        (neg|is_between, ":var3", "itm_light_lance", "itm_wooden_shield"),
        (item_get_type, ":var9", ":var3"),
        (ge, ":var2", 10),
        (neq, ":var9", 10),
        (neq, ":var9", 8),
        (neq, ":var9", 9),
        (neq, ":var9", 5),
        (neq, ":var9", 6),
        (store_random_in_range, ":var5", 0, 600),
        (eq, ":var5", 1),
        (assign, ":var10", -1),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var11", "trp_player", ":var6"),
          (eq, ":var11", ":var3"),
          (assign, ":var10", ":var6"),
        (try_end),
        (gt, ":var10", 0),
        (str_store_item_name, s20, ":var3"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var10"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} falls apart!", 0xFF0000),
          (agent_unequip_item, ":var4", ":var3"),
          (troop_remove_item, "trp_player", ":var3"),
          (troop_remove_item, "trp_broken_items", ":var3"),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var3", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var10", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (agent_get_horse, ":var12", ":var1"),
      (try_begin),
        (eq, "$tom_lance_breaking", 1),
        (gt, ":var12", 0),
        (this_or_next|is_between, ":var3", "itm_light_lance", "itm_bamboo_spear"),
        (is_between, ":var3", "itm_crusader_knight_spear_a", "itm_crusader_spear_a"),
        (ge, ":var2", 50),
        (store_random_in_range, ":var13", 0, 100),
        (gt, ":var13", 20),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your lance!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (this_or_next|is_between, ":var3", "itm_bamboo_spear", "itm_staff"),
        (is_between, ":var3", "itm_crusader_spear_a", "itm_mace_6"),
        (le, ":var12", 0),
        (ge, ":var2", 8),
        (store_random_in_range, ":var13", 0, 100),
        (ge, ":var13", 90),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your spear!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$enable_deahtcam", 1),
      (assign, "$auxilary_player_active", 0),
      (eq, "$use_player_auxiliary", 1),
      (assign, "$g_move_heroes", 1),
      (party_clear, "p_temp_casualties_3"),
      (call_script, "script_party_add_party", "p_temp_casualties_3", "p_main_party"),
      (set_player_troop, "trp_player"),
      (assign, "$enable_deahtcam", 0),
    ]),

    (5, 0, 0, 
    [
      (eq, "$use_player_auxiliary", 1),
      (eq, "$enable_deahtcam", 0),
      (get_player_agent_no, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (neq, "$freelancer_state", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_division, ":var2", ":var0"),
      (assign, ":var3", 0),
      (try_for_agents, ":var4"),
        (eq, ":var3", 0),
        (agent_is_human, ":var4"),
        (agent_is_alive, ":var4"),
        (agent_get_team, ":var5", ":var4"),
        (agent_get_party_id, ":var6", ":var4"),
        (eq, ":var6", "p_main_party"),
        (agent_get_division, ":var7", ":var0"),
        (agent_get_group, ":var8", ":var0"),
        (eq, ":var1", ":var5"),
        (eq, ":var2", ":var7"),
        (agent_get_troop_id, ":var9", ":var4"),
        (neg|is_between, ":var9", "trp_npc1", "trp_enhanced_rnd_lord_end"),
        (set_player_troop, ":var9"),
        (store_agent_hit_points, ":var10", ":var4", 1),
        (agent_get_position, pos1, ":var4"),
        (position_set_z, pos1, -2000),
        (position_set_x, pos1, 0),
        (position_set_y, pos1, 0),
        (agent_get_position, pos0, ":var4"),
        (set_spawn_position, pos0),
        (agent_get_horse, ":var11", ":var4"),
        (try_begin),
          (gt, ":var11", 0),
          (agent_set_position, ":var11", pos1),
          (remove_agent, ":var11"),
        (try_end),
        (agent_set_position, ":var4", pos1),
        (agent_set_slot, ":var4", 35, 1),
        (agent_get_slot, ":var12", ":var4", 102),
        (remove_agent, ":var4"),
        (spawn_agent, ":var9"),
        (assign, ":var0", reg0),
        (agent_set_slot, ":var0", 102, ":var12"),
        (agent_set_team, ":var0", ":var1"),
        (agent_set_hit_points, ":var0", ":var10", 1),
        (agent_set_group, ":var0", ":var8"),
        (agent_set_slot, ":var0", 35, 2),
        (agent_set_slot, ":var0", 36, ":var9"),
        (try_begin),
          (agent_get_horse, ":var13", ":var0"),
          (gt, ":var13", 0),
          (lt, ":var11", 0),
          (agent_set_position, ":var13", pos1),
          (remove_agent, ":var13"),
        (try_end),
        (set_player_troop, "trp_player"),
        (assign, ":var3", 1),
        (assign, "$auxilary_player_active", 1),
      (try_end),
      (eq, ":var3", 0),
      (assign, "$enable_deahtcam", 1),
    ]),

    (5, 0, 0, 
    [
      (eq, "$use_player_auxiliary", 1),
      (eq, "$enable_deahtcam", 0),
      (get_player_agent_no, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$enable_deahtcam", 1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

    (2, 0, 0, 
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_non_player, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (store_skill_level, ":var2", "skl_horse_archery", ":var1"),
        (ge, ":var2", 4),
      (try_end),
    ],
    [
      (set_fixed_point_multiplier, 1000),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_non_player, ":var0"),
        (neg|agent_slot_eq, ":var0", 1003, 1),
        (agent_get_horse, ":var1", ":var0"),
        (assign, ":var2", -1),
        (try_begin),
          (agent_slot_eq, ":var0", 15, 0),
          (gt, ":var1", -1),
          (agent_get_team, ":var3", ":var0"),
          (agent_get_division, ":var4", ":var0"),
          (team_get_weapon_usage_order, ":var5", ":var3", ":var4"),
          (team_get_movement_order, ":var6", ":var3", ":var4"),
          (team_get_hold_fire_order, ":var7", ":var3", ":var4"),
          (assign, ":var8", 0),
          (assign, ":var9", -1),
          (try_for_range, ":var10", 0, 4),
            (agent_get_item_slot, ":var11", ":var0", ":var10"),
            (gt, ":var11", 0),
            (item_get_type, ":var12", ":var11"),
            (try_begin),
              (eq, ":var12", 10),
              (agent_get_ammo_for_slot, ":var13", ":var0", ":var10"),
              (val_add, ":var8", ":var13"),
            (else_try),
              (this_or_next|eq, ":var12", 8),
              (this_or_next|eq, ":var12", 16),
              (eq, ":var12", 17),
              (assign, ":var9", ":var11"),
            (else_try),
              (this_or_next|eq, ":var12", 2),
              (this_or_next|eq, ":var12", 3),
              (eq, ":var12", 4),
              (assign, ":var2", ":var11"),
            (try_end),
          (try_end),
          (gt, ":var9", -1),
          (neg|item_has_property, ":var9", itp_cant_reload_on_horseback),
          (neg|item_has_property, ":var9", itp_cant_use_on_horseback),
          (agent_get_ammo, ":var14", ":var0", 0),
          (val_sub, ":var14", ":var8"),
          (gt, ":var14", 0),
          (agent_set_slot, ":var0", 1003, 2),
          (neq, ":var7", 1),
          (neq, ":var5", 2),
          (eq, ":var6", 2),
          (agent_get_position, pos50, ":var0"),
          (agent_get_speed, pos31, ":var0"),
          (position_get_y, ":var15", pos31),
          (assign, ":var16", 100000),
          (assign, ":var17", -1),
          (try_for_agents, ":var18"),
            (agent_is_alive, ":var18"),
            (agent_is_human, ":var18"),
            (agent_get_position, pos36, ":var18"),
            (agent_get_team, ":var19", ":var18"),
            (teams_are_enemies, ":var3", ":var19"),
            (get_distance_between_positions, ":var20", pos50, pos36),
            (try_begin),
              (agent_slot_eq, ":var18", 15, 1),
              (val_add, ":var20", 10000),
            (try_end),
            (try_begin),
              (agent_get_horse, ":var21", ":var18"),
              (gt, ":var21", -1),
              (agent_get_speed, pos32, ":var18"),
              (position_get_y, ":var22", pos32),
              (val_sub, ":var22", ":var15"),
              (store_div, ":var23", ":var22", 5),
              (val_max, ":var23", 0),
              (val_add, ":var23", 500),
              (val_sub, ":var20", ":var23"),
            (else_try),
              (agent_get_wielded_item, ":var24", ":var18", 1),
              (le, ":var24", 1),
              (val_sub, ":var20", 500),
            (try_end),
            (lt, ":var20", ":var16"),
            (assign, ":var16", ":var20"),
            (assign, ":var17", ":var18"),
          (try_end),
          (neq, ":var17", -1),
          (agent_get_position, pos51, ":var17"),
          (get_distance_between_positions, ":var25", pos50, pos51),
          (try_begin),
            (agent_slot_eq, ":var17", 15, 0),
            (gt, ":var25", 200),
            (agent_set_wielded_item, ":var0", ":var9"),
          (else_try),
            (le, ":var25", 200),
            (gt, ":var2", -1),
            (agent_set_wielded_item, ":var0", ":var2"),
          (try_end),
          (assign, ":var26", 1000),
          (try_begin),
            (agent_get_wielded_item, ":var24", ":var0", 0),
            (gt, ":var24", 0),
            (item_get_type, ":var27", ":var24"),
            (this_or_next|eq, ":var27", 8),
            (this_or_next|eq, ":var27", 16),
            (eq, ":var27", 17),
            (agent_get_bone_position, pos53, ":var0", 8, 1),
            (agent_get_bone_position, pos54, ":var17", 9, 1),
            (position_has_line_of_sight_to_position, pos53, pos54),
            (agent_set_look_target_agent, ":var0", ":var17"),
            (try_begin),
              (assign, ":var28", 4000),
              (agent_get_attack_action, ":var29", ":var0"),
              (eq, ":var29", 1),
              (try_begin),
                (gt, ":var16", 700),
                (le, ":var16", ":var28"),
                (store_div, ":var26", ":var15", 2000),
                (val_max, ":var26", 0),
              (try_end),
              (eq, ":var27", 8),
              (try_begin),
                (le, ":var25", ":var28"),
                (agent_set_defend_action, ":var0", -2, 1),
                (agent_set_attack_action, ":var0", 3, 0),
              (else_try),
                (gt, ":var25", ":var28"),
                (agent_set_attack_action, ":var0", -2, 1),
                (agent_set_defend_action, ":var0", 3, 1),
              (try_end),
            (else_try),
              (eq, ":var27", 8),
              (le, ":var25", ":var28"),
              (agent_get_combat_state, ":var30", ":var0"),
              (neq, ":var30", 8),
              (agent_set_attack_action, ":var0", 3, 1),
            (try_end),
          (try_end),
          (agent_set_speed_limit, ":var0", ":var26"),
          (try_begin),
            (agent_slot_eq, ":var17", 15, 0),
            (lt, ":var16", 10000),
            (try_begin),
              (get_scene_boundaries, pos2, pos3),
              (position_transform_position_to_local, pos4, pos2, pos50),
              (position_get_x, ":var31", pos4),
              (position_get_y, ":var32", pos4),
              (position_transform_position_to_local, pos4, pos2, pos3),
              (position_get_x, ":var33", pos4),
              (position_get_y, ":var34", pos4),
              (store_sub, ":var35", ":var33", ":var31"),
              (store_sub, ":var36", ":var34", ":var32"),
              (position_transform_position_to_local, pos4, pos50, pos51),
              (position_get_x, ":var37", pos4),
              (position_get_y, ":var38", pos4),
              (assign, ":var39", 0),
              (try_begin),
                (le, ":var16", 1000),
                (assign, ":var39", -78000),
              (else_try),
                (gt, ":var16", 2000),
                (store_sub, ":var39", ":var16", 0),
                (val_mul, ":var39", 5),
                (val_clamp, ":var39", 35000, 90000),
              (try_end),
              (assign, ":var40", 30000),
              (val_min, ":var40", ":var31"),
              (val_min, ":var40", ":var36"),
              (val_min, ":var40", ":var35"),
              (val_min, ":var40", ":var32"),
              (try_begin),
                (lt, ":var40", 30000),
                (agent_slot_eq, ":var17", 15, 0),
                (store_div, ":var41", ":var33", 20),
                (store_div, ":var42", ":var34", 20),
                (position_copy_origin, pos4, pos2),
                (position_move_x, 4, ":var41", 1),
                (position_move_y, pos4, ":var42", 1),
                (get_distance_between_positions, ":var43", pos4, pos50),
                (position_transform_position_to_local, pos4, pos50, pos4),
                (position_get_x, ":var41", pos4),
                (position_get_y, ":var42", pos4),
                (val_mul, ":var41", 100),
                (val_mul, ":var42", 100),
                (val_mul, ":var37", 100),
                (val_mul, ":var38", 100),
                (store_div, ":var44", ":var41", ":var43"),
                (store_div, ":var45", ":var42", ":var43"),
                (store_div, ":var46", ":var37", ":var25"),
                (store_div, ":var47", ":var38", ":var25"),
                (store_acos, ":var48", ":var44"),
                (store_asin, ":var49", ":var45"),
                (store_acos, ":var50", ":var46"),
                (store_asin, ":var51", ":var47"),
                (try_begin),
                  (lt, ":var49", 0),
                  (val_mul, ":var48", -1),
                  (val_add, ":var48", 360000),
                (try_end),
                (try_begin),
                  (lt, ":var51", 0),
                  (val_mul, ":var50", -1),
                  (val_add, ":var50", 360000),
                (try_end),
                (store_sub, ":var52", ":var48", ":var50"),
                (val_sub, ":var52", 270000),
                (val_sub, ":var52", ":var39"),
                (store_add, ":var39", ":var52", ":var39"),
                (try_begin),
                  (lt, ":var48", ":var50"),
                  (val_add, ":var39", 360000),
                (try_end),
                (val_clamp, ":var39", -210000, 15000),
                (agent_set_attack_action, ":var0", -2, 1),
                (agent_set_defend_action, ":var0", 3, 1),
              (try_end),
              (store_cos, ":var53", ":var39"),
              (store_sin, ":var54", ":var39"),
              (store_mul, ":var55", ":var53", ":var38"),
              (store_mul, ":var56", ":var54", ":var37"),
              (store_mul, ":var57", ":var54", ":var38"),
              (store_mul, ":var58", ":var53", ":var37"),
              (store_add, ":var59", ":var55", ":var56"),
              (store_sub, ":var60", ":var57", ":var58"),
              (position_move_x, 50, ":var59", 0),
              (position_move_y, pos50, ":var60", 0),
            (try_end),
            (agent_set_scripted_destination, ":var0", pos50, 1),
          (else_try),
            (agent_clear_scripted_mode, ":var0"),
            (agent_force_rethink, ":var0"),
          (try_end),
        (else_try),
          (try_begin),
            (agent_slot_eq, ":var0", 1003, 0),
            (agent_set_slot, ":var0", 1003, 1),
          (else_try),
            (agent_slot_eq, ":var0", 1003, 2),
            (this_or_next|agent_slot_eq, ":var0", 15, 1),
            (this_or_next|lt, ":var1", 0),
            (this_or_next|eq, ":var14", 0),
            (this_or_next|eq, ":var7", 1),
            (this_or_next|eq, ":var5", 2),
            (neq, ":var6", 2),
            (agent_clear_scripted_mode, ":var0"),
            (agent_set_speed_limit, ":var0", 100),
            (agent_force_rethink, ":var0"),
            (agent_set_slot, ":var0", 1003, 3),
            (this_or_next|eq, ":var7", 1),
            (eq, ":var14", 0),
            (gt, ":var2", -1),
            (agent_set_wielded_item, ":var0", ":var2"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [
      (neg|is_presentation_active, "prsnt_killcount"),
      (neg|is_presentation_active, "prsnt_troop_ratio_bar"),
      (neg|is_presentation_active, "prsnt_killcount_and_troop_ratio_bar"),
    ],
    [
      (try_begin),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 1),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 2),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 3),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
      (call_script, "script_party_count_fit_for_battle", "p_main_party"),
      (assign, "$player_count_alive", reg0),
      (call_script, "script_party_count_fit_for_battle", "p_collective_friends"),
      (store_sub, "$ally_count_alive", reg0, "$player_count_alive"),
      (call_script, "script_party_count_fit_for_battle", "p_collective_enemy"),
      (assign, "$enemy_count_alive", reg0),
    ]),

    (3, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 1),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 2),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 3),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
    ]),

    (0.2, 0, ti_once, 
    [],
    [
      (assign, "$spear_in_position", 0),
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 26, 0),
        (agent_set_slot, ":var0", 27, 0),
        (agent_set_slot, ":var0", 28, 0),
        (agent_set_slot, ":var0", 29, 0),
        (agent_set_slot, ":var0", 30, 0),
      (try_end),
    ]),

    (0.5, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 27),
        (agent_get_slot, ":var2", ":var0", 28),
        (agent_get_slot, ":var3", ":var0", 29),
        (agent_get_position, pos1, ":var0"),
        (position_get_x, ":var4", pos1),
        (position_get_y, ":var5", pos1),
        (position_get_z, ":var6", pos1),
        (position_set_x, pos2, ":var1"),
        (position_set_y, pos2, ":var2"),
        (position_set_z, pos2, ":var3"),
        (position_set_x, pos1, ":var4"),
        (position_set_y, pos1, ":var5"),
        (position_set_z, pos1, ":var6"),
        (agent_get_speed, pos5, ":var0"),
        (call_script, "script_vector_length", 5),
        (assign, ":var7", reg0),
        (agent_set_slot, ":var0", 27, ":var4"),
        (agent_set_slot, ":var0", 28, ":var5"),
        (agent_set_slot, ":var0", 29, ":var6"),
        (agent_set_slot, ":var0", 30, ":var7"),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
      (this_or_next|game_key_clicked, gk_attack),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_move_forward),
      (this_or_next|game_key_clicked, gk_move_backward),
      (this_or_next|game_key_clicked, gk_move_left),
      (this_or_next|game_key_clicked, gk_move_right),
      (this_or_next|game_key_clicked, gk_equip_primary_weapon),
      (this_or_next|game_key_clicked, gk_equip_secondary_weapon),
      (this_or_next|game_key_clicked, gk_action),
      (game_key_clicked, gk_sheath_weapon),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (display_message, "@Releasing spear.", 0x6495ED),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
    ]),

    (0.2, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_get_horse, ":var1", ":var0"),
        (le, ":var1", 0),
        (agent_get_slot, ":var2", ":var0", 26),
        (lt, ":var2", 10),
        (val_add, ":var2", 2),
        (agent_set_slot, ":var0", 26, ":var2"),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_set_animation, ":var0", "anim_spearwall_hold"),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (try_for_agents, ":var2"),
        (agent_is_alive, ":var2"),
        (neq, ":var2", ":var0"),
        (agent_is_human, ":var2"),
        (agent_get_horse, ":var3", ":var2"),
        (le, ":var3", 0),
        (agent_get_slot, ":var4", ":var2", 26),
        (ge, ":var4", 10),
        (agent_get_simple_behavior, ":var5", ":var2"),
        (agent_get_team, ":var6", ":var2"),
        (agent_get_class, ":var7", ":var2"),
        (team_get_movement_order, ":var8", ":var6", ":var7"),
        (assign, ":var9", 0),
        (try_begin),
          (neq, ":var6", ":var1"),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (else_try),
          (this_or_next|eq, ":var8", 0),
          (eq, ":var8", 11),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (this_or_next|eq, ":var5", 4),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (try_end),
        (eq, ":var9", 1),
        (agent_get_troop_id, ":var10", ":var2"),
        (store_proficiency_level, ":var11", ":var10", ca_intelligence),
        (store_character_level, ":var12", ":var10"),
        (ge, ":var12", 12),
        (ge, ":var11", 120),
        (neg|troop_is_mounted, ":var10"),
        (agent_slot_eq, ":var2", 15, 0),
        (assign, ":var9", 0),
        (agent_get_wielded_item, ":var13", ":var2", 0),
        (agent_get_wielded_item, ":var14", ":var2", 1),
        (assign, ":var15", 145),
        (try_begin),
          (this_or_next|is_between, ":var13", "itm_modded_billhook_fork_1", "itm_maul"),
          (is_between, ":var14", "itm_modded_billhook_fork_1", "itm_maul"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_1"),
            (eq, ":var14", "itm_modded_billhook_fork_1"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_2"),
            (eq, ":var14", "itm_modded_billhook_fork_2"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_1"),
            (eq, ":var14", "itm_modded_fauchard_1"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_2"),
            (eq, ":var14", "itm_modded_fauchard_2"),
            (assign, "$spear_dist", 171),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_3"),
            (eq, ":var14", "itm_modded_fauchard_3"),
            (assign, "$spear_dist", 197),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_4"),
            (eq, ":var14", "itm_modded_fauchard_4"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_1"),
            (eq, ":var14", "itm_modded_glaive_1"),
            (assign, "$spear_dist", 169),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_1"),
            (eq, ":var14", "itm_modded_glaive_fork_1"),
            (assign, "$spear_dist", 230),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_2"),
            (eq, ":var14", "itm_modded_glaive_fork_2"),
            (assign, "$spear_dist", 188),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_roundel"),
            (eq, ":var14", "itm_modded_glaive_roundel"),
            (assign, "$spear_dist", 149),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_1"),
            (eq, ":var14", "itm_modded_bill_1"),
            (assign, "$spear_dist", 215),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_2"),
            (eq, ":var14", "itm_modded_bill_2"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_1"),
            (eq, ":var14", "itm_modded_billhook_1"),
            (assign, "$spear_dist", 207),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_2"),
            (eq, ":var14", "itm_modded_billhook_2"),
            (assign, "$spear_dist", 172),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_3"),
            (eq, ":var14", "itm_modded_billhook_3"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_voulge"),
            (eq, ":var14", "itm_modded_voulge"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_spiked_voulge"),
            (eq, ":var14", "itm_modded_spiked_voulge"),
            (assign, "$spear_dist", 182),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_cleaving_voulge"),
            (eq, ":var14", "itm_modded_cleaving_voulge"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_1"),
            (eq, ":var14", "itm_modded_hooked_voulge_1"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_2"),
            (eq, ":var14", "itm_modded_hooked_voulge_2"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_3"),
            (eq, ":var14", "itm_modded_hooked_voulge_3"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_1"),
            (eq, ":var14", "itm_modded_couteau_1"),
            (assign, "$spear_dist", 177),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_2"),
            (eq, ":var14", "itm_modded_couteau_2"),
            (assign, "$spear_dist", 196),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_guisarme"),
            (eq, ":var14", "itm_modded_guisarme"),
            (assign, "$spear_dist", 232),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_assegai"),
            (eq, ":var14", "itm_modded_assegai"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_pike"),
            (eq, ":var14", "itm_modded_pike"),
            (assign, "$spear_dist", 300),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_war_spear"),
            (eq, ":var14", "itm_modded_war_spear"),
            (assign, "$spear_dist", 211),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_glaive"),
          (is_between, ":var14", "itm_glaive"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_glaive"),
            (eq, ":var14", "itm_glaive"),
            (assign, "$spear_dist", 160),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_bill"),
          (is_between, ":var14", "itm_bill"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_bill"),
            (eq, ":var14", "itm_bill"),
            (assign, "$spear_dist", 128),
          (try_end),
        (try_end),
        (eq, ":var9", 1),
        (assign, ":var16", -1),
        (agent_get_position, pos1, ":var2"),
        (try_for_agents, ":var17"),
          (agent_is_alive, ":var17"),
          (neg|agent_is_human, ":var17"),
          (agent_get_rider, ":var18", ":var17"),
          (ge, ":var18", 0),
          (agent_get_team, ":var19", ":var18"),
          (teams_are_enemies, ":var6", ":var19"),
          (agent_get_position, pos2, ":var17"),
          (get_distance_between_positions, ":var20", pos1, pos2),
          (lt, ":var20", ":var15"),
          (neg|position_is_behind_position, pos2, pos1),
          (agent_get_slot, ":var21", ":var17", 30),
          (gt, ":var21", 0),
          (assign, ":var16", ":var17"),
        (try_end),
        (gt, ":var16", -1),
        (agent_play_sound, ":var16", "snd_metal_hit_high_armor_high_damage"),
        (store_agent_hit_points, ":var22", ":var16", 0),
        (store_agent_hit_points, ":var23", ":var16", 1),
        (assign, reg22, ":var21"),
        (val_mul, ":var21", 10),
        (val_sub, ":var22", ":var21"),
        (val_max, ":var22", 0),
        (agent_set_slot, ":var2", 26, 0),
        (agent_get_horse, ":var24", ":var0"),
        (agent_get_position, pos2, ":var16"),
        (agent_set_look_target_position, ":var2", pos2),
        (agent_set_attack_action, ":var2", 0, 0),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_get_troop_id, ":var10", ":var2"),
        (str_store_troop_name, s21, ":var10"),
        (agent_get_troop_id, ":var25", ":var16"),
        (str_store_troop_name, s20, ":var25"),
        (store_agent_hit_points, ":var22", ":var16", 1),
        (val_sub, ":var23", ":var22"),
        (assign, reg1, ":var23"),
        (try_begin),
          (eq, ":var16", ":var24"),
          (display_message, "@Your horse received {reg1} damage from a braced polearm!", 0xFF4040),
        (try_end),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (store_agent_hit_points, ":var1", ":var0", 1),
      (lt, ":var1", "$spear_hp"),
      (display_message, "@The injury causes your grip on the polearm to slip!", 0xFF4040),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 26),
      (ge, ":var1", 10),
      (assign, ":var2", -1),
      (agent_get_position, pos1, ":var0"),
      (try_for_agents, ":var3"),
        (agent_is_alive, ":var3"),
        (neg|agent_is_human, ":var3"),
        (agent_get_rider, ":var4", ":var3"),
        (ge, ":var4", 0),
        (neg|agent_is_ally, ":var4"),
        (agent_get_position, pos2, ":var3"),
        (get_distance_between_positions, ":var5", pos1, pos2),
        (lt, ":var5", "$spear_dist"),
        (neg|position_is_behind_position, pos2, pos1),
        (agent_get_slot, ":var6", ":var3", 30),
        (ge, ":var6", 120),
        (assign, ":var2", ":var3"),
      (try_end),
      (gt, ":var2", -1),
      (agent_play_sound, ":var2", "snd_metal_hit_high_armor_high_damage"),
      (store_agent_hit_points, ":var7", ":var2", 0),
      (store_agent_hit_points, ":var8", ":var2", 1),
      (val_div, ":var6", 2),
      (val_sub, ":var6", 15),
      (val_sub, ":var7", ":var6"),
      (val_max, ":var7", 0),
      (agent_set_hit_points, ":var2", ":var7", 0),
      (agent_deliver_damage_to_agent, ":var2", ":var2"),
      (agent_set_slot, ":var0", 26, 0),
      (store_agent_hit_points, ":var7", ":var2", 1),
      (val_sub, ":var8", ":var7"),
      (assign, reg1, ":var8"),
      (display_message, "@Polearm-wall dealt {reg1} damage!"),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 2, 
    [
      (key_clicked, key_b),
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_is_alive, ":var1"),
      (agent_get_wielded_item, ":var2", ":var1", 0),
      (agent_get_wielded_item, ":var3", ":var1", 1),
      (assign, "$spear_dist", 145),
      (try_begin),
        (this_or_next|is_between, ":var2", "itm_modded_billhook_fork_1", "itm_maul"),
        (is_between, ":var3", "itm_modded_billhook_fork_1", "itm_maul"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_1"),
          (eq, ":var3", "itm_modded_billhook_fork_1"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_2"),
          (eq, ":var3", "itm_modded_billhook_fork_2"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_1"),
          (eq, ":var3", "itm_modded_fauchard_1"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_2"),
          (eq, ":var3", "itm_modded_fauchard_2"),
          (assign, "$spear_dist", 171),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_3"),
          (eq, ":var3", "itm_modded_fauchard_3"),
          (assign, "$spear_dist", 197),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_4"),
          (eq, ":var3", "itm_modded_fauchard_4"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_1"),
          (eq, ":var3", "itm_modded_glaive_1"),
          (assign, "$spear_dist", 169),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_1"),
          (eq, ":var3", "itm_modded_glaive_fork_1"),
          (assign, "$spear_dist", 230),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_2"),
          (eq, ":var3", "itm_modded_glaive_fork_2"),
          (assign, "$spear_dist", 188),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_roundel"),
          (eq, ":var3", "itm_modded_glaive_roundel"),
          (assign, "$spear_dist", 149),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_1"),
          (eq, ":var3", "itm_modded_bill_1"),
          (assign, "$spear_dist", 215),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_2"),
          (eq, ":var3", "itm_modded_bill_2"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_1"),
          (eq, ":var3", "itm_modded_billhook_1"),
          (assign, "$spear_dist", 207),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_2"),
          (eq, ":var3", "itm_modded_billhook_2"),
          (assign, "$spear_dist", 172),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_3"),
          (eq, ":var3", "itm_modded_billhook_3"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_voulge"),
          (eq, ":var3", "itm_modded_voulge"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_spiked_voulge"),
          (eq, ":var3", "itm_modded_spiked_voulge"),
          (assign, "$spear_dist", 182),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_cleaving_voulge"),
          (eq, ":var3", "itm_modded_cleaving_voulge"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_1"),
          (eq, ":var3", "itm_modded_hooked_voulge_1"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_2"),
          (eq, ":var3", "itm_modded_hooked_voulge_2"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_3"),
          (eq, ":var3", "itm_modded_hooked_voulge_3"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_1"),
          (eq, ":var3", "itm_modded_couteau_1"),
          (assign, "$spear_dist", 177),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_2"),
          (eq, ":var3", "itm_modded_couteau_2"),
          (assign, "$spear_dist", 196),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_guisarme"),
          (eq, ":var3", "itm_modded_guisarme"),
          (assign, "$spear_dist", 232),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_assegai"),
          (eq, ":var3", "itm_modded_assegai"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_pike"),
          (eq, ":var3", "itm_modded_pike"),
          (assign, "$spear_dist", 300),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_war_spear"),
          (eq, ":var3", "itm_modded_war_spear"),
          (assign, "$spear_dist", 211),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_glaive"),
        (is_between, ":var3", "itm_glaive"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_glaive"),
          (eq, ":var3", "itm_glaive"),
          (assign, "$spear_dist", 160),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_bill"),
        (is_between, ":var3", "itm_bill"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_bill"),
          (eq, ":var3", "itm_bill"),
          (assign, "$spear_dist", 128),
        (try_end),
      (try_end),
      (eq, ":var0", 1),
      (agent_get_horse, ":var4", ":var1"),
      (le, ":var4", 0),
      (neq, "$spear_in_position", 1),
      (display_message, "@Bracing polearm for charge.", 0x6495ED),
      (agent_set_animation, ":var1", "anim_spearwall_hold"),
      (assign, "$spear_in_position", 1),
      (store_agent_hit_points, "$spear_hp", ":var1", 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 41, ":var0"),
    ]),

    (0, 0, 3, 
    [
      (key_clicked, key_h),
    ],
    [
      (agent_get_slot, ":var0", "$fplayer_agent_no", 41),
      (gt, ":var0", 0),
      (agent_is_active, ":var0"),
      (agent_get_horse, reg0, "$fplayer_agent_no"),
      (eq, reg0, -1),
      (agent_play_sound, "$fplayer_agent_no", "snd_man_breath_hard"),
      (display_message, "@You whistle for your horse."),
      (agent_is_alive, ":var0"),
      (agent_get_position, pos1, "$fplayer_agent_no"),
      (agent_set_scripted_destination, ":var0", pos1, 0),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_2, ":var0"),
      (ge, ":var0", 0),
      (item_get_type, ":var1", ":var0"),
      (this_or_next|eq, ":var1", 8),
      (eq, ":var1", 9),
      (store_trigger_param_1, ":var2"),
      (agent_is_active, ":var2"),
      (agent_is_alive, ":var2"),
      (agent_is_non_player, ":var2"),
      (agent_get_ammo, ":var3", ":var2", 0),
      (le, ":var3", 0),
      (agent_get_horse, ":var4", ":var2"),
      (eq, ":var4", -1),
      (assign, ":var5", 1),
      (try_begin),
        (this_or_next|party_slot_eq, "$g_encountered_party", 0, 3),
        (party_slot_eq, "$g_encountered_party", 0, 2),
        (agent_get_team, ":var6", ":var2"),
        (this_or_next|eq, ":var6", "$defender_team"),
        (eq, ":var6", "$defender_team_2"),
        (assign, ":var5", 0),
      (try_end),
      (eq, ":var5", 1),
      (agent_set_division, ":var2", 4),
      (agent_set_slot, ":var2", 42, 4),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_slot, ":var0", 42, -1),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_active, ":var0"),
        (agent_slot_ge, ":var0", 42, 0),
        (agent_is_alive, ":var0"),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 42, ":var1"),
        (agent_get_slot, ":var2", ":var0", 42),
        (agent_set_division, ":var0", ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_slot, ":var0", 42, -1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (neg|agent_is_human, ":var0"),
        (agent_get_rider, ":var1", ":var0"),
        (ge, ":var1", 0),
        (agent_is_active, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_is_non_player, ":var1"),
      (else_try),
        (assign, ":var1", -1),
      (try_end),
      (agent_set_slot, ":var0", 41, ":var1"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (neg|agent_is_human, ":var0"),
      (agent_get_slot, ":var1", ":var0", 41),
      (ge, ":var1", 0),
      (agent_is_active, ":var1"),
      (agent_is_alive, ":var1"),
      (try_begin),
        (assign, ":var2", 70),
        (agent_get_troop_id, ":var3", ":var1"),
        (store_skill_level, ":var4", "skl_riding", ":var3"),
        (store_mul, ":var5", ":var4", 5),
        (val_sub, ":var2", ":var5"),
        (call_script, "script_rand", 0, 100),
        (le, reg0, ":var2"),
        (call_script, "script_rand", 60, 80),
        (assign, ":var6", reg0),
        (store_mul, ":var7", ":var4", 7),
        (val_sub, ":var6", ":var7"),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var6"),
        (try_begin),
          (neg|agent_is_non_player, ":var1"),
          (display_message, "@You fall down from your horse and sustain some damage!"),
        (try_end),
      (try_end),
      (try_begin),
        (agent_is_active, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_set_division, ":var1", 0),
        (agent_set_slot, ":var1", 42, 0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_active, ":var0"),
        (agent_slot_ge, ":var0", 42, 0),
        (agent_is_alive, ":var0"),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 42, ":var1"),
        (agent_get_slot, ":var2", ":var0", 42),
        (agent_set_division, ":var0", ":var2"),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (call_script, "script_lance_use_classify_agent"),
    ]),

    (2, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 43),
        (gt, ":var1", 0),
        (agent_get_wielded_item, ":var2", ":var0", 0),
        (agent_get_horse, ":var3", ":var0"),
        (try_begin),
          (le, ":var3", 0),
          (agent_set_slot, ":var0", 43, 0),
          (eq, ":var2", ":var1"),
          (call_script, "script_lance_use_backup_weapon", ":var0"),
        (else_try),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var4", ":var0"),
          (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":var4", 1),
          (assign, ":var5", reg0),
          (try_begin),
            (lt, ":var5", 500),
            (agent_get_combat_state, ":var6", ":var0"),
            (gt, ":var6", 3),
            (eq, ":var2", ":var1"),
            (call_script, "script_lance_use_backup_weapon", ":var0"),
          (else_try),
            (neq, ":var2", ":var1"),
            (agent_set_wielded_item, ":var0", ":var1"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (eq, "$freelancer_state", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (ge, ":var0", 0),
      (agent_is_active, ":var0"),
      (store_trigger_param_1, ":var1"),
      (eq, ":var0", ":var1"),
      (agent_get_team, ":var2", ":var0"),
      (team_set_order_listener, ":var2", -1),
      (val_add, ":var2", 2),
      (agent_set_team, ":var0", ":var2"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
    ]),

  ]),

  ("castle_attack_walls_defenders_sally", mtf_battle_mode, -1,
  "You attack the walls of the castle...",
  [
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 48, []),
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 0, []),
    (3, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 48, []),
    (3, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
  ],
  [
    (0, 0.4, ti_once, 
    [],
    [
      (try_begin),
        (get_player_agent_no, "$fplayer_agent_no"),
        (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
        (assign, ":var0", 0),
        (assign, ":var1", 0),
        (assign, ":var2", 0),
        (assign, ":var3", 0),
        (assign, "$team0_size", 0),
        (assign, "$team1_size", 0),
        (assign, "$team2_size", 0),
        (assign, "$team3_size", 0),
        (try_for_agents, ":var4"),
          (agent_is_human, ":var4"),
          (agent_get_team, ":var5", ":var4"),
          (agent_get_troop_id, ":var6", ":var4"),
          (store_faction_of_troop, ":var7", ":var6"),
          (try_begin),
            (eq, ":var5", 0),
            (val_add, ":var0", ":var7"),
            (val_add, "$team0_size", 1),
          (else_try),
            (eq, ":var5", 1),
            (val_add, ":var1", ":var7"),
            (val_add, "$team1_size", 1),
          (else_try),
            (eq, ":var5", 2),
            (val_add, ":var2", ":var7"),
            (val_add, "$team2_size", 1),
          (else_try),
            (eq, ":var5", 3),
            (val_add, ":var3", ":var7"),
            (val_add, "$team3_size", 1),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team0_size", 0),
          (team_get_leader, ":var8", 0),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_faction_of_troop, "$team0_faction", ":var9"),
          (else_try),
            (store_mul, "$team0_faction", ":var0", 10),
            (val_div, "$team0_faction", "$team0_size"),
            (val_add, "$team0_faction", 5),
            (val_div, "$team0_faction", 10),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team1_size", 0),
          (team_get_leader, ":var8", 1),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_faction_of_troop, "$team1_faction", ":var9"),
          (else_try),
            (store_mul, "$team1_faction", ":var1", 10),
            (val_div, "$team1_faction", "$team1_size"),
            (val_add, "$team1_faction", 5),
            (val_div, "$team1_faction", 10),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team2_size", 0),
          (team_get_leader, ":var8", 2),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_faction_of_troop, "$team2_faction", ":var9"),
          (else_try),
            (store_mul, "$team2_faction", ":var2", 10),
            (val_div, "$team2_faction", "$team2_size"),
            (val_add, "$team2_faction", 5),
            (val_div, "$team2_faction", 10),
          (try_end),
        (try_end),
        (try_begin),
          (gt, "$team3_size", 0),
          (team_get_leader, ":var8", 3),
          (try_begin),
            (ge, ":var8", 0),
            (agent_get_troop_id, ":var9", ":var8"),
            (store_faction_of_troop, "$team3_faction", ":var9"),
          (else_try),
            (store_mul, "$team3_faction", ":var3", 10),
            (val_div, "$team3_faction", "$team3_size"),
            (val_add, "$team3_faction", 5),
            (val_div, "$team3_faction", 10),
          (try_end),
        (try_end),
      (try_end),
      (call_script, "script_battle_pos_init"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_agent_reassign_team", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_remove_siege_objects"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_on_agent_hit, 0.3, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (assign, ":var3", reg0),
      (agent_is_human, ":var0"),
      (get_player_agent_no, ":var4"),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var0", ":var4"),
        (store_random_in_range, ":var5", 0, 1000),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 4, 8),
        (troop_get_inventory_slot, ":var7", "trp_player", ":var6"),
        (gt, ":var7", 0),
        (str_store_item_name, s20, ":var7"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var6"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} is too crapy to fall apart!", 0xFF0000),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var7", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var6", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var1", ":var4"),
        (is_between, ":var3", 1, "itm_items_end"),
        (neg|is_between, ":var3", "itm_light_lance", "itm_wooden_shield"),
        (item_get_type, ":var9", ":var3"),
        (ge, ":var2", 10),
        (neq, ":var9", 10),
        (neq, ":var9", 8),
        (neq, ":var9", 9),
        (neq, ":var9", 5),
        (neq, ":var9", 6),
        (store_random_in_range, ":var5", 0, 600),
        (eq, ":var5", 1),
        (assign, ":var10", -1),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var11", "trp_player", ":var6"),
          (eq, ":var11", ":var3"),
          (assign, ":var10", ":var6"),
        (try_end),
        (gt, ":var10", 0),
        (str_store_item_name, s20, ":var3"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var10"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} falls apart!", 0xFF0000),
          (agent_unequip_item, ":var4", ":var3"),
          (troop_remove_item, "trp_player", ":var3"),
          (troop_remove_item, "trp_broken_items", ":var3"),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var3", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var10", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (agent_get_horse, ":var12", ":var1"),
      (try_begin),
        (eq, "$tom_lance_breaking", 1),
        (gt, ":var12", 0),
        (this_or_next|is_between, ":var3", "itm_light_lance", "itm_bamboo_spear"),
        (is_between, ":var3", "itm_crusader_knight_spear_a", "itm_crusader_spear_a"),
        (ge, ":var2", 50),
        (store_random_in_range, ":var13", 0, 100),
        (gt, ":var13", 20),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your lance!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (this_or_next|is_between, ":var3", "itm_bamboo_spear", "itm_staff"),
        (is_between, ":var3", "itm_crusader_spear_a", "itm_mace_6"),
        (le, ":var12", 0),
        (ge, ":var2", 8),
        (store_random_in_range, ":var13", 0, 100),
        (ge, ":var13", 90),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your spear!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var3", ":var0"),
        (party_add_members, "p_total_enemy_casualties", ":var3", 1),
        (eq, ":var2", 1),
        (party_wound_members, "p_total_enemy_casualties", ":var3", 1),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 5, 20, 0),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (call_script, "script_combat_music_set_situation_with_culture", 1024),
      (assign, "$dmod_current_agent", -1),
      (assign, "$dmod_move_camera", -1),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture", 1024),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 2),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (assign, "$g_siege_sallied_out_once", 1),
      (assign, "$g_siege_method", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (5, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (val_add, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
      (set_mission_result, -1),
      (display_message, "@Battle lost..."),
      (assign, "$g_battle_won", -1),
      (assign, "$g_battle_result", -1),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (assign, "$do_once_3", 0),
      (finish_mission, 0),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", -1),
      (display_message, "@Battle lost! Press tab key to leave..."),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (gt, "$dmod_current_agent", 0),
      (eq, "$setting_use_dmod", 1),
      (eq, "$dmod_move_camera", 1),
      (agent_get_position, pos1, "$dmod_current_agent"),
      (position_move_z, pos1, 300),
      (position_move_y, pos1, -300),
      (agent_get_horse, ":var0", "$dmod_current_agent"),
      (try_begin),
        (ge, ":var0", 0),
      (try_end),
      (mission_cam_set_position, pos1),
      (mission_cam_set_mode, 1),
      (set_fixed_point_multiplier, 100),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_up),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_forwards"),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_down),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_backwards"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 4, ti_once, 
    [
      (eq, "$enable_deahtcam", 1),
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
      (assign, "$tom_sand_storm", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (this_or_next|eq, "$dmod_move_camera", 1),
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, gk_move_forward),
      (this_or_next|game_key_is_down, gk_move_backward),
      (this_or_next|game_key_is_down, gk_move_left),
      (this_or_next|game_key_is_down, gk_move_right),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_backward),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_left),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (position_rotate_x_floating, pos47, ":var7"),
        (position_rotate_y, pos47, 90),
        (position_rotate_x_floating, pos47, ":var3"),
        (position_rotate_y, pos47, -90),
        (position_rotate_x_floating, pos47, "$deathcam_total_rotx"),
        (position_rotate_x_floating, pos47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|eq, ":var0", 0),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "str_enhanced_battle_knocked_out_message_1"),
      (display_message, "str_enhanced_battle_knocked_out_message_2"),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (is_presentation_active, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (team_give_order, ":var1", 9, 0),
      (set_show_messages, 1),
    ]),

    (0, 0, ti_once, 
    [
      (eq, 0, 1),
      (eq, "$enable_deahtcam", 1),
      (main_hero_fallen),
    ],
    [
      (assign, "$fclock", 1),
      (call_script, "script_player_order_formations", 2),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (team_give_order, ":var1", 9, 2),
    ]),

    (2, 0, 0, 
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_non_player, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (store_skill_level, ":var2", "skl_horse_archery", ":var1"),
        (ge, ":var2", 4),
      (try_end),
    ],
    [
      (set_fixed_point_multiplier, 1000),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_non_player, ":var0"),
        (neg|agent_slot_eq, ":var0", 1003, 1),
        (agent_get_horse, ":var1", ":var0"),
        (assign, ":var2", -1),
        (try_begin),
          (agent_slot_eq, ":var0", 15, 0),
          (gt, ":var1", -1),
          (agent_get_team, ":var3", ":var0"),
          (agent_get_division, ":var4", ":var0"),
          (team_get_weapon_usage_order, ":var5", ":var3", ":var4"),
          (team_get_movement_order, ":var6", ":var3", ":var4"),
          (team_get_hold_fire_order, ":var7", ":var3", ":var4"),
          (assign, ":var8", 0),
          (assign, ":var9", -1),
          (try_for_range, ":var10", 0, 4),
            (agent_get_item_slot, ":var11", ":var0", ":var10"),
            (gt, ":var11", 0),
            (item_get_type, ":var12", ":var11"),
            (try_begin),
              (eq, ":var12", 10),
              (agent_get_ammo_for_slot, ":var13", ":var0", ":var10"),
              (val_add, ":var8", ":var13"),
            (else_try),
              (this_or_next|eq, ":var12", 8),
              (this_or_next|eq, ":var12", 16),
              (eq, ":var12", 17),
              (assign, ":var9", ":var11"),
            (else_try),
              (this_or_next|eq, ":var12", 2),
              (this_or_next|eq, ":var12", 3),
              (eq, ":var12", 4),
              (assign, ":var2", ":var11"),
            (try_end),
          (try_end),
          (gt, ":var9", -1),
          (neg|item_has_property, ":var9", itp_cant_reload_on_horseback),
          (neg|item_has_property, ":var9", itp_cant_use_on_horseback),
          (agent_get_ammo, ":var14", ":var0", 0),
          (val_sub, ":var14", ":var8"),
          (gt, ":var14", 0),
          (agent_set_slot, ":var0", 1003, 2),
          (neq, ":var7", 1),
          (neq, ":var5", 2),
          (eq, ":var6", 2),
          (agent_get_position, pos50, ":var0"),
          (agent_get_speed, pos31, ":var0"),
          (position_get_y, ":var15", pos31),
          (assign, ":var16", 100000),
          (assign, ":var17", -1),
          (try_for_agents, ":var18"),
            (agent_is_alive, ":var18"),
            (agent_is_human, ":var18"),
            (agent_get_position, pos36, ":var18"),
            (agent_get_team, ":var19", ":var18"),
            (teams_are_enemies, ":var3", ":var19"),
            (get_distance_between_positions, ":var20", pos50, pos36),
            (try_begin),
              (agent_slot_eq, ":var18", 15, 1),
              (val_add, ":var20", 10000),
            (try_end),
            (try_begin),
              (agent_get_horse, ":var21", ":var18"),
              (gt, ":var21", -1),
              (agent_get_speed, pos32, ":var18"),
              (position_get_y, ":var22", pos32),
              (val_sub, ":var22", ":var15"),
              (store_div, ":var23", ":var22", 5),
              (val_max, ":var23", 0),
              (val_add, ":var23", 500),
              (val_sub, ":var20", ":var23"),
            (else_try),
              (agent_get_wielded_item, ":var24", ":var18", 1),
              (le, ":var24", 1),
              (val_sub, ":var20", 500),
            (try_end),
            (lt, ":var20", ":var16"),
            (assign, ":var16", ":var20"),
            (assign, ":var17", ":var18"),
          (try_end),
          (neq, ":var17", -1),
          (agent_get_position, pos51, ":var17"),
          (get_distance_between_positions, ":var25", pos50, pos51),
          (try_begin),
            (agent_slot_eq, ":var17", 15, 0),
            (gt, ":var25", 200),
            (agent_set_wielded_item, ":var0", ":var9"),
          (else_try),
            (le, ":var25", 200),
            (gt, ":var2", -1),
            (agent_set_wielded_item, ":var0", ":var2"),
          (try_end),
          (assign, ":var26", 1000),
          (try_begin),
            (agent_get_wielded_item, ":var24", ":var0", 0),
            (gt, ":var24", 0),
            (item_get_type, ":var27", ":var24"),
            (this_or_next|eq, ":var27", 8),
            (this_or_next|eq, ":var27", 16),
            (eq, ":var27", 17),
            (agent_get_bone_position, pos53, ":var0", 8, 1),
            (agent_get_bone_position, pos54, ":var17", 9, 1),
            (position_has_line_of_sight_to_position, pos53, pos54),
            (agent_set_look_target_agent, ":var0", ":var17"),
            (try_begin),
              (assign, ":var28", 4000),
              (agent_get_attack_action, ":var29", ":var0"),
              (eq, ":var29", 1),
              (try_begin),
                (gt, ":var16", 700),
                (le, ":var16", ":var28"),
                (store_div, ":var26", ":var15", 2000),
                (val_max, ":var26", 0),
              (try_end),
              (eq, ":var27", 8),
              (try_begin),
                (le, ":var25", ":var28"),
                (agent_set_defend_action, ":var0", -2, 1),
                (agent_set_attack_action, ":var0", 3, 0),
              (else_try),
                (gt, ":var25", ":var28"),
                (agent_set_attack_action, ":var0", -2, 1),
                (agent_set_defend_action, ":var0", 3, 1),
              (try_end),
            (else_try),
              (eq, ":var27", 8),
              (le, ":var25", ":var28"),
              (agent_get_combat_state, ":var30", ":var0"),
              (neq, ":var30", 8),
              (agent_set_attack_action, ":var0", 3, 1),
            (try_end),
          (try_end),
          (agent_set_speed_limit, ":var0", ":var26"),
          (try_begin),
            (agent_slot_eq, ":var17", 15, 0),
            (lt, ":var16", 10000),
            (try_begin),
              (get_scene_boundaries, pos2, pos3),
              (position_transform_position_to_local, pos4, pos2, pos50),
              (position_get_x, ":var31", pos4),
              (position_get_y, ":var32", pos4),
              (position_transform_position_to_local, pos4, pos2, pos3),
              (position_get_x, ":var33", pos4),
              (position_get_y, ":var34", pos4),
              (store_sub, ":var35", ":var33", ":var31"),
              (store_sub, ":var36", ":var34", ":var32"),
              (position_transform_position_to_local, pos4, pos50, pos51),
              (position_get_x, ":var37", pos4),
              (position_get_y, ":var38", pos4),
              (assign, ":var39", 0),
              (try_begin),
                (le, ":var16", 1000),
                (assign, ":var39", -78000),
              (else_try),
                (gt, ":var16", 2000),
                (store_sub, ":var39", ":var16", 0),
                (val_mul, ":var39", 5),
                (val_clamp, ":var39", 35000, 90000),
              (try_end),
              (assign, ":var40", 30000),
              (val_min, ":var40", ":var31"),
              (val_min, ":var40", ":var36"),
              (val_min, ":var40", ":var35"),
              (val_min, ":var40", ":var32"),
              (try_begin),
                (lt, ":var40", 30000),
                (agent_slot_eq, ":var17", 15, 0),
                (store_div, ":var41", ":var33", 20),
                (store_div, ":var42", ":var34", 20),
                (position_copy_origin, pos4, pos2),
                (position_move_x, 4, ":var41", 1),
                (position_move_y, pos4, ":var42", 1),
                (get_distance_between_positions, ":var43", pos4, pos50),
                (position_transform_position_to_local, pos4, pos50, pos4),
                (position_get_x, ":var41", pos4),
                (position_get_y, ":var42", pos4),
                (val_mul, ":var41", 100),
                (val_mul, ":var42", 100),
                (val_mul, ":var37", 100),
                (val_mul, ":var38", 100),
                (store_div, ":var44", ":var41", ":var43"),
                (store_div, ":var45", ":var42", ":var43"),
                (store_div, ":var46", ":var37", ":var25"),
                (store_div, ":var47", ":var38", ":var25"),
                (store_acos, ":var48", ":var44"),
                (store_asin, ":var49", ":var45"),
                (store_acos, ":var50", ":var46"),
                (store_asin, ":var51", ":var47"),
                (try_begin),
                  (lt, ":var49", 0),
                  (val_mul, ":var48", -1),
                  (val_add, ":var48", 360000),
                (try_end),
                (try_begin),
                  (lt, ":var51", 0),
                  (val_mul, ":var50", -1),
                  (val_add, ":var50", 360000),
                (try_end),
                (store_sub, ":var52", ":var48", ":var50"),
                (val_sub, ":var52", 270000),
                (val_sub, ":var52", ":var39"),
                (store_add, ":var39", ":var52", ":var39"),
                (try_begin),
                  (lt, ":var48", ":var50"),
                  (val_add, ":var39", 360000),
                (try_end),
                (val_clamp, ":var39", -210000, 15000),
                (agent_set_attack_action, ":var0", -2, 1),
                (agent_set_defend_action, ":var0", 3, 1),
              (try_end),
              (store_cos, ":var53", ":var39"),
              (store_sin, ":var54", ":var39"),
              (store_mul, ":var55", ":var53", ":var38"),
              (store_mul, ":var56", ":var54", ":var37"),
              (store_mul, ":var57", ":var54", ":var38"),
              (store_mul, ":var58", ":var53", ":var37"),
              (store_add, ":var59", ":var55", ":var56"),
              (store_sub, ":var60", ":var57", ":var58"),
              (position_move_x, 50, ":var59", 0),
              (position_move_y, pos50, ":var60", 0),
            (try_end),
            (agent_set_scripted_destination, ":var0", pos50, 1),
          (else_try),
            (agent_clear_scripted_mode, ":var0"),
            (agent_force_rethink, ":var0"),
          (try_end),
        (else_try),
          (try_begin),
            (agent_slot_eq, ":var0", 1003, 0),
            (agent_set_slot, ":var0", 1003, 1),
          (else_try),
            (agent_slot_eq, ":var0", 1003, 2),
            (this_or_next|agent_slot_eq, ":var0", 15, 1),
            (this_or_next|lt, ":var1", 0),
            (this_or_next|eq, ":var14", 0),
            (this_or_next|eq, ":var7", 1),
            (this_or_next|eq, ":var5", 2),
            (neq, ":var6", 2),
            (agent_clear_scripted_mode, ":var0"),
            (agent_set_speed_limit, ":var0", 100),
            (agent_force_rethink, ":var0"),
            (agent_set_slot, ":var0", 1003, 3),
            (this_or_next|eq, ":var7", 1),
            (eq, ":var14", 0),
            (gt, ":var2", -1),
            (agent_set_wielded_item, ":var0", ":var2"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [
      (neg|is_presentation_active, "prsnt_killcount"),
      (neg|is_presentation_active, "prsnt_troop_ratio_bar"),
      (neg|is_presentation_active, "prsnt_killcount_and_troop_ratio_bar"),
    ],
    [
      (try_begin),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 1),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 2),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 3),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
      (call_script, "script_party_count_fit_for_battle", "p_main_party"),
      (assign, "$player_count_alive", reg0),
      (call_script, "script_party_count_fit_for_battle", "p_collective_friends"),
      (store_sub, "$ally_count_alive", reg0, "$player_count_alive"),
      (call_script, "script_party_count_fit_for_battle", "p_collective_enemy"),
      (assign, "$enemy_count_alive", reg0),
    ]),

    (3, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 1),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 2),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 3),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
    ]),

    (0.2, 0, ti_once, 
    [],
    [
      (assign, "$spear_in_position", 0),
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 26, 0),
        (agent_set_slot, ":var0", 27, 0),
        (agent_set_slot, ":var0", 28, 0),
        (agent_set_slot, ":var0", 29, 0),
        (agent_set_slot, ":var0", 30, 0),
      (try_end),
    ]),

    (0.5, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 27),
        (agent_get_slot, ":var2", ":var0", 28),
        (agent_get_slot, ":var3", ":var0", 29),
        (agent_get_position, pos1, ":var0"),
        (position_get_x, ":var4", pos1),
        (position_get_y, ":var5", pos1),
        (position_get_z, ":var6", pos1),
        (position_set_x, pos2, ":var1"),
        (position_set_y, pos2, ":var2"),
        (position_set_z, pos2, ":var3"),
        (position_set_x, pos1, ":var4"),
        (position_set_y, pos1, ":var5"),
        (position_set_z, pos1, ":var6"),
        (agent_get_speed, pos5, ":var0"),
        (call_script, "script_vector_length", 5),
        (assign, ":var7", reg0),
        (agent_set_slot, ":var0", 27, ":var4"),
        (agent_set_slot, ":var0", 28, ":var5"),
        (agent_set_slot, ":var0", 29, ":var6"),
        (agent_set_slot, ":var0", 30, ":var7"),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
      (this_or_next|game_key_clicked, gk_attack),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_move_forward),
      (this_or_next|game_key_clicked, gk_move_backward),
      (this_or_next|game_key_clicked, gk_move_left),
      (this_or_next|game_key_clicked, gk_move_right),
      (this_or_next|game_key_clicked, gk_equip_primary_weapon),
      (this_or_next|game_key_clicked, gk_equip_secondary_weapon),
      (this_or_next|game_key_clicked, gk_action),
      (game_key_clicked, gk_sheath_weapon),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (display_message, "@Releasing spear.", 0x6495ED),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
    ]),

    (0.2, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_get_horse, ":var1", ":var0"),
        (le, ":var1", 0),
        (agent_get_slot, ":var2", ":var0", 26),
        (lt, ":var2", 10),
        (val_add, ":var2", 2),
        (agent_set_slot, ":var0", 26, ":var2"),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_set_animation, ":var0", "anim_spearwall_hold"),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (try_for_agents, ":var2"),
        (agent_is_alive, ":var2"),
        (neq, ":var2", ":var0"),
        (agent_is_human, ":var2"),
        (agent_get_horse, ":var3", ":var2"),
        (le, ":var3", 0),
        (agent_get_slot, ":var4", ":var2", 26),
        (ge, ":var4", 10),
        (agent_get_simple_behavior, ":var5", ":var2"),
        (agent_get_team, ":var6", ":var2"),
        (agent_get_class, ":var7", ":var2"),
        (team_get_movement_order, ":var8", ":var6", ":var7"),
        (assign, ":var9", 0),
        (try_begin),
          (neq, ":var6", ":var1"),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (else_try),
          (this_or_next|eq, ":var8", 0),
          (eq, ":var8", 11),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (this_or_next|eq, ":var5", 4),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (try_end),
        (eq, ":var9", 1),
        (agent_get_troop_id, ":var10", ":var2"),
        (store_proficiency_level, ":var11", ":var10", ca_intelligence),
        (store_character_level, ":var12", ":var10"),
        (ge, ":var12", 12),
        (ge, ":var11", 120),
        (neg|troop_is_mounted, ":var10"),
        (agent_slot_eq, ":var2", 15, 0),
        (assign, ":var9", 0),
        (agent_get_wielded_item, ":var13", ":var2", 0),
        (agent_get_wielded_item, ":var14", ":var2", 1),
        (assign, ":var15", 145),
        (try_begin),
          (this_or_next|is_between, ":var13", "itm_modded_billhook_fork_1", "itm_maul"),
          (is_between, ":var14", "itm_modded_billhook_fork_1", "itm_maul"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_1"),
            (eq, ":var14", "itm_modded_billhook_fork_1"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_2"),
            (eq, ":var14", "itm_modded_billhook_fork_2"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_1"),
            (eq, ":var14", "itm_modded_fauchard_1"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_2"),
            (eq, ":var14", "itm_modded_fauchard_2"),
            (assign, "$spear_dist", 171),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_3"),
            (eq, ":var14", "itm_modded_fauchard_3"),
            (assign, "$spear_dist", 197),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_4"),
            (eq, ":var14", "itm_modded_fauchard_4"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_1"),
            (eq, ":var14", "itm_modded_glaive_1"),
            (assign, "$spear_dist", 169),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_1"),
            (eq, ":var14", "itm_modded_glaive_fork_1"),
            (assign, "$spear_dist", 230),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_2"),
            (eq, ":var14", "itm_modded_glaive_fork_2"),
            (assign, "$spear_dist", 188),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_roundel"),
            (eq, ":var14", "itm_modded_glaive_roundel"),
            (assign, "$spear_dist", 149),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_1"),
            (eq, ":var14", "itm_modded_bill_1"),
            (assign, "$spear_dist", 215),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_2"),
            (eq, ":var14", "itm_modded_bill_2"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_1"),
            (eq, ":var14", "itm_modded_billhook_1"),
            (assign, "$spear_dist", 207),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_2"),
            (eq, ":var14", "itm_modded_billhook_2"),
            (assign, "$spear_dist", 172),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_3"),
            (eq, ":var14", "itm_modded_billhook_3"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_voulge"),
            (eq, ":var14", "itm_modded_voulge"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_spiked_voulge"),
            (eq, ":var14", "itm_modded_spiked_voulge"),
            (assign, "$spear_dist", 182),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_cleaving_voulge"),
            (eq, ":var14", "itm_modded_cleaving_voulge"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_1"),
            (eq, ":var14", "itm_modded_hooked_voulge_1"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_2"),
            (eq, ":var14", "itm_modded_hooked_voulge_2"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_3"),
            (eq, ":var14", "itm_modded_hooked_voulge_3"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_1"),
            (eq, ":var14", "itm_modded_couteau_1"),
            (assign, "$spear_dist", 177),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_2"),
            (eq, ":var14", "itm_modded_couteau_2"),
            (assign, "$spear_dist", 196),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_guisarme"),
            (eq, ":var14", "itm_modded_guisarme"),
            (assign, "$spear_dist", 232),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_assegai"),
            (eq, ":var14", "itm_modded_assegai"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_pike"),
            (eq, ":var14", "itm_modded_pike"),
            (assign, "$spear_dist", 300),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_war_spear"),
            (eq, ":var14", "itm_modded_war_spear"),
            (assign, "$spear_dist", 211),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_glaive"),
          (is_between, ":var14", "itm_glaive"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_glaive"),
            (eq, ":var14", "itm_glaive"),
            (assign, "$spear_dist", 160),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_bill"),
          (is_between, ":var14", "itm_bill"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_bill"),
            (eq, ":var14", "itm_bill"),
            (assign, "$spear_dist", 128),
          (try_end),
        (try_end),
        (eq, ":var9", 1),
        (assign, ":var16", -1),
        (agent_get_position, pos1, ":var2"),
        (try_for_agents, ":var17"),
          (agent_is_alive, ":var17"),
          (neg|agent_is_human, ":var17"),
          (agent_get_rider, ":var18", ":var17"),
          (ge, ":var18", 0),
          (agent_get_team, ":var19", ":var18"),
          (teams_are_enemies, ":var6", ":var19"),
          (agent_get_position, pos2, ":var17"),
          (get_distance_between_positions, ":var20", pos1, pos2),
          (lt, ":var20", ":var15"),
          (neg|position_is_behind_position, pos2, pos1),
          (agent_get_slot, ":var21", ":var17", 30),
          (gt, ":var21", 0),
          (assign, ":var16", ":var17"),
        (try_end),
        (gt, ":var16", -1),
        (agent_play_sound, ":var16", "snd_metal_hit_high_armor_high_damage"),
        (store_agent_hit_points, ":var22", ":var16", 0),
        (store_agent_hit_points, ":var23", ":var16", 1),
        (assign, reg22, ":var21"),
        (val_mul, ":var21", 10),
        (val_sub, ":var22", ":var21"),
        (val_max, ":var22", 0),
        (agent_set_slot, ":var2", 26, 0),
        (agent_get_horse, ":var24", ":var0"),
        (agent_get_position, pos2, ":var16"),
        (agent_set_look_target_position, ":var2", pos2),
        (agent_set_attack_action, ":var2", 0, 0),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_get_troop_id, ":var10", ":var2"),
        (str_store_troop_name, s21, ":var10"),
        (agent_get_troop_id, ":var25", ":var16"),
        (str_store_troop_name, s20, ":var25"),
        (store_agent_hit_points, ":var22", ":var16", 1),
        (val_sub, ":var23", ":var22"),
        (assign, reg1, ":var23"),
        (try_begin),
          (eq, ":var16", ":var24"),
          (display_message, "@Your horse received {reg1} damage from a braced polearm!", 0xFF4040),
        (try_end),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (store_agent_hit_points, ":var1", ":var0", 1),
      (lt, ":var1", "$spear_hp"),
      (display_message, "@The injury causes your grip on the polearm to slip!", 0xFF4040),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 26),
      (ge, ":var1", 10),
      (assign, ":var2", -1),
      (agent_get_position, pos1, ":var0"),
      (try_for_agents, ":var3"),
        (agent_is_alive, ":var3"),
        (neg|agent_is_human, ":var3"),
        (agent_get_rider, ":var4", ":var3"),
        (ge, ":var4", 0),
        (neg|agent_is_ally, ":var4"),
        (agent_get_position, pos2, ":var3"),
        (get_distance_between_positions, ":var5", pos1, pos2),
        (lt, ":var5", "$spear_dist"),
        (neg|position_is_behind_position, pos2, pos1),
        (agent_get_slot, ":var6", ":var3", 30),
        (ge, ":var6", 120),
        (assign, ":var2", ":var3"),
      (try_end),
      (gt, ":var2", -1),
      (agent_play_sound, ":var2", "snd_metal_hit_high_armor_high_damage"),
      (store_agent_hit_points, ":var7", ":var2", 0),
      (store_agent_hit_points, ":var8", ":var2", 1),
      (val_div, ":var6", 2),
      (val_sub, ":var6", 15),
      (val_sub, ":var7", ":var6"),
      (val_max, ":var7", 0),
      (agent_set_hit_points, ":var2", ":var7", 0),
      (agent_deliver_damage_to_agent, ":var2", ":var2"),
      (agent_set_slot, ":var0", 26, 0),
      (store_agent_hit_points, ":var7", ":var2", 1),
      (val_sub, ":var8", ":var7"),
      (assign, reg1, ":var8"),
      (display_message, "@Polearm-wall dealt {reg1} damage!"),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 2, 
    [
      (key_clicked, key_b),
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_is_alive, ":var1"),
      (agent_get_wielded_item, ":var2", ":var1", 0),
      (agent_get_wielded_item, ":var3", ":var1", 1),
      (assign, "$spear_dist", 145),
      (try_begin),
        (this_or_next|is_between, ":var2", "itm_modded_billhook_fork_1", "itm_maul"),
        (is_between, ":var3", "itm_modded_billhook_fork_1", "itm_maul"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_1"),
          (eq, ":var3", "itm_modded_billhook_fork_1"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_2"),
          (eq, ":var3", "itm_modded_billhook_fork_2"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_1"),
          (eq, ":var3", "itm_modded_fauchard_1"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_2"),
          (eq, ":var3", "itm_modded_fauchard_2"),
          (assign, "$spear_dist", 171),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_3"),
          (eq, ":var3", "itm_modded_fauchard_3"),
          (assign, "$spear_dist", 197),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_4"),
          (eq, ":var3", "itm_modded_fauchard_4"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_1"),
          (eq, ":var3", "itm_modded_glaive_1"),
          (assign, "$spear_dist", 169),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_1"),
          (eq, ":var3", "itm_modded_glaive_fork_1"),
          (assign, "$spear_dist", 230),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_2"),
          (eq, ":var3", "itm_modded_glaive_fork_2"),
          (assign, "$spear_dist", 188),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_roundel"),
          (eq, ":var3", "itm_modded_glaive_roundel"),
          (assign, "$spear_dist", 149),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_1"),
          (eq, ":var3", "itm_modded_bill_1"),
          (assign, "$spear_dist", 215),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_2"),
          (eq, ":var3", "itm_modded_bill_2"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_1"),
          (eq, ":var3", "itm_modded_billhook_1"),
          (assign, "$spear_dist", 207),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_2"),
          (eq, ":var3", "itm_modded_billhook_2"),
          (assign, "$spear_dist", 172),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_3"),
          (eq, ":var3", "itm_modded_billhook_3"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_voulge"),
          (eq, ":var3", "itm_modded_voulge"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_spiked_voulge"),
          (eq, ":var3", "itm_modded_spiked_voulge"),
          (assign, "$spear_dist", 182),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_cleaving_voulge"),
          (eq, ":var3", "itm_modded_cleaving_voulge"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_1"),
          (eq, ":var3", "itm_modded_hooked_voulge_1"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_2"),
          (eq, ":var3", "itm_modded_hooked_voulge_2"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_3"),
          (eq, ":var3", "itm_modded_hooked_voulge_3"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_1"),
          (eq, ":var3", "itm_modded_couteau_1"),
          (assign, "$spear_dist", 177),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_2"),
          (eq, ":var3", "itm_modded_couteau_2"),
          (assign, "$spear_dist", 196),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_guisarme"),
          (eq, ":var3", "itm_modded_guisarme"),
          (assign, "$spear_dist", 232),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_assegai"),
          (eq, ":var3", "itm_modded_assegai"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_pike"),
          (eq, ":var3", "itm_modded_pike"),
          (assign, "$spear_dist", 300),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_war_spear"),
          (eq, ":var3", "itm_modded_war_spear"),
          (assign, "$spear_dist", 211),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_glaive"),
        (is_between, ":var3", "itm_glaive"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_glaive"),
          (eq, ":var3", "itm_glaive"),
          (assign, "$spear_dist", 160),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_bill"),
        (is_between, ":var3", "itm_bill"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_bill"),
          (eq, ":var3", "itm_bill"),
          (assign, "$spear_dist", 128),
        (try_end),
      (try_end),
      (eq, ":var0", 1),
      (agent_get_horse, ":var4", ":var1"),
      (le, ":var4", 0),
      (neq, "$spear_in_position", 1),
      (display_message, "@Bracing polearm for charge.", 0x6495ED),
      (agent_set_animation, ":var1", "anim_spearwall_hold"),
      (assign, "$spear_in_position", 1),
      (store_agent_hit_points, "$spear_hp", ":var1", 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 41, ":var0"),
    ]),

    (0, 0, 3, 
    [
      (key_clicked, key_h),
    ],
    [
      (agent_get_slot, ":var0", "$fplayer_agent_no", 41),
      (gt, ":var0", 0),
      (agent_is_active, ":var0"),
      (agent_get_horse, reg0, "$fplayer_agent_no"),
      (eq, reg0, -1),
      (agent_play_sound, "$fplayer_agent_no", "snd_man_breath_hard"),
      (display_message, "@You whistle for your horse."),
      (agent_is_alive, ":var0"),
      (agent_get_position, pos1, "$fplayer_agent_no"),
      (agent_set_scripted_destination, ":var0", pos1, 0),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_2, ":var0"),
      (ge, ":var0", 0),
      (item_get_type, ":var1", ":var0"),
      (this_or_next|eq, ":var1", 8),
      (eq, ":var1", 9),
      (store_trigger_param_1, ":var2"),
      (agent_is_active, ":var2"),
      (agent_is_alive, ":var2"),
      (agent_is_non_player, ":var2"),
      (agent_get_ammo, ":var3", ":var2", 0),
      (le, ":var3", 0),
      (agent_get_horse, ":var4", ":var2"),
      (eq, ":var4", -1),
      (assign, ":var5", 1),
      (try_begin),
        (this_or_next|party_slot_eq, "$g_encountered_party", 0, 3),
        (party_slot_eq, "$g_encountered_party", 0, 2),
        (agent_get_team, ":var6", ":var2"),
        (this_or_next|eq, ":var6", "$defender_team"),
        (eq, ":var6", "$defender_team_2"),
        (assign, ":var5", 0),
      (try_end),
      (eq, ":var5", 1),
      (agent_set_division, ":var2", 4),
      (agent_set_slot, ":var2", 42, 4),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_slot, ":var0", 42, -1),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_active, ":var0"),
        (agent_slot_ge, ":var0", 42, 0),
        (agent_is_alive, ":var0"),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 42, ":var1"),
        (agent_get_slot, ":var2", ":var0", 42),
        (agent_set_division, ":var0", ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_slot, ":var0", 42, -1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (neg|agent_is_human, ":var0"),
        (agent_get_rider, ":var1", ":var0"),
        (ge, ":var1", 0),
        (agent_is_active, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_is_non_player, ":var1"),
      (else_try),
        (assign, ":var1", -1),
      (try_end),
      (agent_set_slot, ":var0", 41, ":var1"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (neg|agent_is_human, ":var0"),
      (agent_get_slot, ":var1", ":var0", 41),
      (ge, ":var1", 0),
      (agent_is_active, ":var1"),
      (agent_is_alive, ":var1"),
      (try_begin),
        (assign, ":var2", 70),
        (agent_get_troop_id, ":var3", ":var1"),
        (store_skill_level, ":var4", "skl_riding", ":var3"),
        (store_mul, ":var5", ":var4", 5),
        (val_sub, ":var2", ":var5"),
        (call_script, "script_rand", 0, 100),
        (le, reg0, ":var2"),
        (call_script, "script_rand", 60, 80),
        (assign, ":var6", reg0),
        (store_mul, ":var7", ":var4", 7),
        (val_sub, ":var6", ":var7"),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var6"),
        (try_begin),
          (neg|agent_is_non_player, ":var1"),
          (display_message, "@You fall down from your horse and sustain some damage!"),
        (try_end),
      (try_end),
      (try_begin),
        (agent_is_active, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_set_division, ":var1", 0),
        (agent_set_slot, ":var1", 42, 0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_active, ":var0"),
        (agent_slot_ge, ":var0", 42, 0),
        (agent_is_alive, ":var0"),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 42, ":var1"),
        (agent_get_slot, ":var2", ":var0", 42),
        (agent_set_division, ":var0", ":var2"),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (call_script, "script_lance_use_classify_agent"),
    ]),

    (2, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 43),
        (gt, ":var1", 0),
        (agent_get_wielded_item, ":var2", ":var0", 0),
        (agent_get_horse, ":var3", ":var0"),
        (try_begin),
          (le, ":var3", 0),
          (agent_set_slot, ":var0", 43, 0),
          (eq, ":var2", ":var1"),
          (call_script, "script_lance_use_backup_weapon", ":var0"),
        (else_try),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var4", ":var0"),
          (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":var4", 1),
          (assign, ":var5", reg0),
          (try_begin),
            (lt, ":var5", 500),
            (agent_get_combat_state, ":var6", ":var0"),
            (gt, ":var6", 3),
            (eq, ":var2", ":var1"),
            (call_script, "script_lance_use_backup_weapon", ":var0"),
          (else_try),
            (neq, ":var2", ":var1"),
            (agent_set_wielded_item, ":var0", ":var1"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$enable_deahtcam", 1),
      (assign, "$auxilary_player_active", 0),
      (eq, "$use_player_auxiliary", 1),
      (assign, "$g_move_heroes", 1),
      (party_clear, "p_temp_casualties_3"),
      (call_script, "script_party_add_party", "p_temp_casualties_3", "p_main_party"),
      (set_player_troop, "trp_player"),
      (assign, "$enable_deahtcam", 0),
    ]),

    (5, 0, 0, 
    [
      (eq, "$use_player_auxiliary", 1),
      (eq, "$enable_deahtcam", 0),
      (get_player_agent_no, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (neq, "$freelancer_state", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_division, ":var2", ":var0"),
      (assign, ":var3", 0),
      (try_for_agents, ":var4"),
        (eq, ":var3", 0),
        (agent_is_human, ":var4"),
        (agent_is_alive, ":var4"),
        (agent_get_team, ":var5", ":var4"),
        (agent_get_party_id, ":var6", ":var4"),
        (eq, ":var6", "p_main_party"),
        (agent_get_division, ":var7", ":var0"),
        (agent_get_group, ":var8", ":var0"),
        (eq, ":var1", ":var5"),
        (eq, ":var2", ":var7"),
        (agent_get_troop_id, ":var9", ":var4"),
        (neg|is_between, ":var9", "trp_npc1", "trp_enhanced_rnd_lord_end"),
        (set_player_troop, ":var9"),
        (store_agent_hit_points, ":var10", ":var4", 1),
        (agent_get_position, pos1, ":var4"),
        (position_set_z, pos1, -2000),
        (position_set_x, pos1, 0),
        (position_set_y, pos1, 0),
        (agent_get_position, pos0, ":var4"),
        (set_spawn_position, pos0),
        (agent_get_horse, ":var11", ":var4"),
        (try_begin),
          (gt, ":var11", 0),
          (agent_set_position, ":var11", pos1),
          (remove_agent, ":var11"),
        (try_end),
        (agent_set_position, ":var4", pos1),
        (agent_set_slot, ":var4", 35, 1),
        (agent_get_slot, ":var12", ":var4", 102),
        (remove_agent, ":var4"),
        (spawn_agent, ":var9"),
        (assign, ":var0", reg0),
        (agent_set_slot, ":var0", 102, ":var12"),
        (agent_set_team, ":var0", ":var1"),
        (agent_set_hit_points, ":var0", ":var10", 1),
        (agent_set_group, ":var0", ":var8"),
        (agent_set_slot, ":var0", 35, 2),
        (agent_set_slot, ":var0", 36, ":var9"),
        (try_begin),
          (agent_get_horse, ":var13", ":var0"),
          (gt, ":var13", 0),
          (lt, ":var11", 0),
          (agent_set_position, ":var13", pos1),
          (remove_agent, ":var13"),
        (try_end),
        (set_player_troop, "trp_player"),
        (assign, ":var3", 1),
        (assign, "$auxilary_player_active", 1),
      (try_end),
      (eq, ":var3", 0),
      (assign, "$enable_deahtcam", 1),
    ]),

    (5, 0, 0, 
    [
      (eq, "$use_player_auxiliary", 1),
      (eq, "$enable_deahtcam", 0),
      (get_player_agent_no, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$enable_deahtcam", 1),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$g_decap_enabled", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (agent_is_non_player, ":var0"),
      (agent_get_troop_id, ":var3", ":var0"),
      (neg|troop_is_hero, ":var3"),
      (assign, ":var4", reg0),
      (copy_position, 5, 0),
      (neq, ":var0", -1),
      (try_begin),
        (agent_is_human, ":var0"),
        (ge, ":var4", 0),
        (assign, ":var5", 0),
        (try_begin),
          (this_or_next|eq, ":var4", "itm_supercrossbow"),
          (eq, ":var4", "itm_supersledge"),
          (assign, ":var5", 1),
        (else_try),
          (neq, ":var4", "itm_mace_1"),
          (neq, ":var4", "itm_mace_2"),
          (neq, ":var4", "itm_mace_3"),
          (neq, ":var4", "itm_staff"),
          (agent_get_action_dir, ":var6", ":var1"),
          (this_or_next|eq, ":var6", 1),
          (eq, ":var6", 2),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var5", 0),
        (try_begin),
          (ge, ":var2", "$g_decap_minimum_damage"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap minimum DMG req bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (store_agent_hit_points, ":var7", ":var0", 1),
        (val_add, ":var7", "$g_decap_negative_health"),
        (ge, ":var2", ":var7"),
        (agent_get_position, pos4, ":var0"),
        (get_distance_between_positions, ":var8", pos4, pos5),
        (agent_get_horse, ":var9", ":var0"),
        (try_begin),
          (ge, ":var9", 0),
          (assign, ":var10", 240),
          (assign, ":var11", 260),
        (else_try),
          (assign, ":var10", 160),
          (assign, ":var11", 176),
        (try_end),
        (is_between, ":var8", ":var10", ":var11"),
        (assign, ":var5", 0),
        (try_begin),
          (store_random_in_range, ":var12", 0, 100),
          (le, ":var12", "$g_decap_chance"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap chance calc bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var13", "itm_cut_off_head_male"),
        (agent_get_troop_id, ":var14", ":var0"),
        (try_begin),
          (ge, ":var14", 0),
          (troop_get_type, ":var15", ":var14"),
          (eq, ":var15", 1),
          (assign, ":var13", "itm_cut_off_head_female"),
        (try_end),
        (store_random_in_range, ":var16", 0, 360),
        (store_random_in_range, ":var17", -60, 60),
        (store_random_in_range, ":var18", -90, 90),
        (store_random_in_range, ":var19", -90, 90),
        (position_rotate_z, pos4, ":var16"),
        (position_rotate_y, pos4, ":var17"),
        (position_move_x, 4, ":var18"),
        (position_move_y, pos4, ":var19"),
        (position_set_z_to_ground_level, pos4),
        (position_move_z, pos4, 5),
        (set_spawn_position, pos4),
        (assign, ":var20", 360),
        (agent_get_item_slot, ":var21", ":var0", 4),
        (try_begin),
          (ge, ":var21", 1),
          (agent_unequip_item, ":var0", ":var21"),
          (try_begin),
            (spawn_item, ":var21", 0, ":var20"),
          (try_end),
        (try_end),
        (agent_equip_item, ":var0", "itm_invisible_head"),
        (agent_get_position, pos4, ":var0"),
        (position_move_z, pos4, ":var10"),
        (particle_system_burst, "psys_blood_decapitation", pos4, "$g_decap_psys_blood_decapitation"),
        (particle_system_burst, "psys_game_blood", pos4, "$g_decap_psys_game_blood"),
        (particle_system_burst, "psys_game_blood_2", pos4, "$g_decap_psys_game_blood_2"),
        (play_sound_at_position, "snd_decapitation", pos4),
        (position_move_z, pos4, 20),
        (set_spawn_position, pos4),
        (assign, ":var13", "spr_head_dynamic_male"),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var13", "spr_head_dynamic_female"),
        (try_end),
        (spawn_scene_prop, ":var13"),
        (agent_get_troop_id, ":var22", ":var1"),
        (str_store_troop_name, s0, ":var22"),
        (agent_get_troop_id, ":var14", ":var0"),
        (str_store_troop_name, s1, ":var14"),
        (get_player_agent_no, ":var23"),
        (agent_get_team, ":var24", ":var23"),
        (agent_get_team, ":var25", ":var0"),
        (try_begin),
          (neq, ":var24", ":var25"),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFF33DD11),
        (else_try),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFFFF4422),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_bully_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_fat_peasant_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_thug_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_fatseveredarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_thin_looter_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (0, 0, 1, 
    [
      (key_clicked, key_right_control),
    ],
    [
      (try_begin),
        (key_is_down, key_m),
        (try_begin),
          (eq, "$g_decapitations_debugging", 0),
          (assign, "$g_decapitations_debugging", 1),
          (display_message, "@Decapitation debug mode Enabled"),
        (else_try),
          (assign, "$g_decapitations_debugging", 0),
          (display_message, "@Decapitation debug mode Disabled"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, key_k),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos17, ":var0"),
        (position_move_y, pos17, 2000),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_bully_handless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_thug_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_thin_looter_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_fat_peasant_handless"),
        (agent_set_team, reg0, 2),
      (try_end),
      (try_begin),
        (key_is_down, key_j),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos18, ":var0"),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supersledge"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supercrossbow"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_super_bolts"),
      (try_end),
    ]),

  ]),

  ("castle_attack_walls_belfry", mtf_battle_mode, -1,
  "You attack the walls of the castle...",
  [
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 48, []),
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 0, []),
    (10, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
    (11, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 28, []),
    (15, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
    (40, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 4, []),
    (41, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 4, []),
    (42, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 4, []),
    (43, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 4, []),
    (44, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 4, []),
    (45, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 4, []),
    (46, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 4, []),
    (47, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 4, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_begin),
        (neq, "$attacker_team", ":var2"),
        (neq, "$attacker_team_2", ":var2"),
        (str_store_string, s5, "str_siege_continues"),
        (call_script, "script_simulate_retreat", 8, 15, 0),
      (else_try),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (assign, "$g_defender_reinforcement_limit", "$g_reinforcement_waves"),
      (assign, "$g_attacker_reinforcement_limit", "$g_reinforcement_waves"),
      (assign, "$dmod_current_agent", -1),
      (assign, "$dmod_move_camera", -1),
      (call_script, "script_combat_music_set_situation_with_culture", 262144),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture", 262144),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
    ],
    []),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (entry_point_get_position, pos10, 10),
      (try_for_range, ":var0", 0, 9),
        (neq, ":var0", 1),
        (team_give_order, "$defender_team", ":var0", 0),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 0),
        (team_give_order, "$defender_team_2", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 7),
      (try_end),
      (team_give_order, "$defender_team", 1, 11),
      (team_set_order_position, "$defender_team", 9, pos10),
      (team_give_order, "$defender_team_2", 1, 11),
      (team_set_order_position, "$defender_team_2", 9, pos10),
      (team_give_order, "$attacker_team", 9, 2),
      (team_give_order, "$attacker_team_2", 9, 2),
      (set_show_messages, 1),
    ],
    []),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (team_give_order, "$attacker_team", 9, 8),
      (team_give_order, "$attacker_team", 9, 8),
      (team_give_order, "$attacker_team", 9, 8),
      (set_show_messages, 1),
    ],
    []),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (val_add, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
      (set_mission_result, -1),
      (display_message, "@Battle lost..."),
      (assign, "$g_battle_won", -1),
      (assign, "$g_battle_result", -1),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (assign, "$do_once_3", 0),
      (finish_mission, 0),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", -1),
      (display_message, "@Battle lost! Press tab key to leave..."),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (gt, "$dmod_current_agent", 0),
      (eq, "$setting_use_dmod", 1),
      (eq, "$dmod_move_camera", 1),
      (agent_get_position, pos1, "$dmod_current_agent"),
      (position_move_z, pos1, 300),
      (position_move_y, pos1, -300),
      (agent_get_horse, ":var0", "$dmod_current_agent"),
      (try_begin),
        (ge, ":var0", 0),
      (try_end),
      (mission_cam_set_position, pos1),
      (mission_cam_set_mode, 1),
      (set_fixed_point_multiplier, 100),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_up),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_forwards"),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_down),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_backwards"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 4, ti_once, 
    [
      (eq, "$enable_deahtcam", 1),
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
      (assign, "$tom_sand_storm", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (this_or_next|eq, "$dmod_move_camera", 1),
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, gk_move_forward),
      (this_or_next|game_key_is_down, gk_move_backward),
      (this_or_next|game_key_is_down, gk_move_left),
      (this_or_next|game_key_is_down, gk_move_right),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_backward),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_left),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (position_rotate_x_floating, pos47, ":var7"),
        (position_rotate_y, pos47, 90),
        (position_rotate_x_floating, pos47, ":var3"),
        (position_rotate_y, pos47, -90),
        (position_rotate_x_floating, pos47, "$deathcam_total_rotx"),
        (position_rotate_x_floating, pos47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|eq, ":var0", 0),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "str_enhanced_battle_knocked_out_message_1"),
      (display_message, "str_enhanced_battle_knocked_out_message_2"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var3", ":var0"),
        (str_store_troop_name, s6, ":var3"),
        (party_add_members, "p_total_enemy_casualties", ":var3", 1),
        (eq, ":var2", 1),
        (party_wound_members, "p_total_enemy_casualties", ":var3", 1),
      (try_end),
    ]),

    (0, 2, ti_once, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 5, 1),
      (try_end),
    ]),

    (3, 0, 0, 
    [],
    [
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
      (try_begin),
        (store_mul, ":var1", "$attacker_reinforcement_stage", 2),
        (this_or_next|lt, "$defender_reinforcement_stage", "$g_defender_reinforcement_limit"),
        (le, "$defender_reinforcement_stage", ":var1"),
        (store_normalized_team_count, ":var2", 0),
        (lt, ":var2", 40),
        (add_reinforcements_to_entry, 4, 28),
        (val_add, "$defender_reinforcement_stage", 1),
      (try_end),
    ]),

    (2, 0, 0, 
    [
      (gt, "$defender_reinforcement_stage", 0),
    ],
    [
      (call_script, "script_siege_move_archers_to_archer_positions"),
    ]),

    (3, 0, 0, 
    [
      (assign, ":var0", 1),
      (try_begin),
        (ge, "$attacker_reinforcement_stage", 10),
        (store_mul, ":var1", "$defender_reinforcement_stage", 2),
        (gt, "$attacker_reinforcement_stage", ":var1"),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (store_mission_timer_a, ":var2"),
      (ge, ":var2", 5),
      (store_normalized_team_count, ":var3", 1),
      (lt, ":var3", 30),
    ],
    [
      (add_reinforcements_to_entry, 1, 32),
      (val_add, "$attacker_reinforcement_stage", 1),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (5, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (try_begin),
        (eq, "$auxilary_player_active", 0),
        (call_script, "script_freelancer_keep_field_loot"),
      (try_end),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (assign, "$do_once_3", 0),
      (finish_mission, 1),
    ]),

    (5, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (180, 0, 0, 
    [],
    [
      (display_message, "@Refilling defender ammo..."),
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (this_or_next|eq, ":var2", "$defender_team"),
        (eq, ":var2", "$defender_team_2"),
        (agent_refill_ammo, ":var1"),
      (try_end),
      (try_begin),
        (agent_get_team, ":var2", ":var0"),
        (this_or_next|eq, ":var2", "$defender_team"),
        (eq, ":var2", "$defender_team_2"),
        (agent_refill_ammo, ":var0"),
      (try_end),
    ]),

    (1, 4, ti_once, 
    [
      (eq, "$enable_deahtcam", 1),
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@You have been knocked out by the enemy. Watch your men continue the fight without you or press Tab to retreat."),
      (display_message, "@If you choose to watch the fight you can use the mouse scroll up and down to switch between troop view or AWDS keys for free camera view."),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (is_presentation_active, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (call_script, "script_siege_init_ai_and_belfry"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (call_script, "script_cf_siege_move_belfry"),
    ],
    [
      (call_script, "script_siege_rot_belfry_platform"),
    ]),

    (4, 0, ti_once, 
    [
      (call_script, "script_cf_siege_assign_men_to_belfry"),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_active, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_clear_scripted_mode, ":var0"),
        (agent_ai_set_always_attack_in_melee, ":var0", 0),
        (agent_set_speed_limit, ":var0", 100),
      (try_end),
      (set_show_messages, 0),
      (team_give_order, "$attacker_team", 9, 2),
      (team_give_order, "$attacker_team", 9, 15),
      (set_show_messages, 1),
    ]),

    (ti_on_agent_hit, 0.3, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (assign, ":var3", reg0),
      (agent_is_human, ":var0"),
      (get_player_agent_no, ":var4"),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var0", ":var4"),
        (store_random_in_range, ":var5", 0, 1000),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 4, 8),
        (troop_get_inventory_slot, ":var7", "trp_player", ":var6"),
        (gt, ":var7", 0),
        (str_store_item_name, s20, ":var7"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var6"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} is too crapy to fall apart!", 0xFF0000),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var7", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var6", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var1", ":var4"),
        (is_between, ":var3", 1, "itm_items_end"),
        (neg|is_between, ":var3", "itm_light_lance", "itm_wooden_shield"),
        (item_get_type, ":var9", ":var3"),
        (ge, ":var2", 10),
        (neq, ":var9", 10),
        (neq, ":var9", 8),
        (neq, ":var9", 9),
        (neq, ":var9", 5),
        (neq, ":var9", 6),
        (store_random_in_range, ":var5", 0, 600),
        (eq, ":var5", 1),
        (assign, ":var10", -1),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var11", "trp_player", ":var6"),
          (eq, ":var11", ":var3"),
          (assign, ":var10", ":var6"),
        (try_end),
        (gt, ":var10", 0),
        (str_store_item_name, s20, ":var3"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var10"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} falls apart!", 0xFF0000),
          (agent_unequip_item, ":var4", ":var3"),
          (troop_remove_item, "trp_player", ":var3"),
          (troop_remove_item, "trp_broken_items", ":var3"),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var3", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var10", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (agent_get_horse, ":var12", ":var1"),
      (try_begin),
        (eq, "$tom_lance_breaking", 1),
        (gt, ":var12", 0),
        (this_or_next|is_between, ":var3", "itm_light_lance", "itm_bamboo_spear"),
        (is_between, ":var3", "itm_crusader_knight_spear_a", "itm_crusader_spear_a"),
        (ge, ":var2", 50),
        (store_random_in_range, ":var13", 0, 100),
        (gt, ":var13", 20),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your lance!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (this_or_next|is_between, ":var3", "itm_bamboo_spear", "itm_staff"),
        (is_between, ":var3", "itm_crusader_spear_a", "itm_mace_6"),
        (le, ":var12", 0),
        (ge, ":var2", 8),
        (store_random_in_range, ":var13", 0, 100),
        (ge, ":var13", 90),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your spear!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$tom_sand_storm", 0),
      (call_script, "script_change_rain_or_snow"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$tom_sand_storm", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (position_set_z_to_ground_level, pos0),
      (position_get_z, ":var1", pos0),
      (val_add, ":var1", 400),
      (position_set_z, pos0, ":var1"),
      (particle_system_burst, "psys_desert_storm", pos0, 2),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 2, ti_once, 
    [
      (eq, "$tom_use_banners", 1),
    ],
    [
      (call_script, "script_set_flag_carriers"),
    ]),

    (10, 0, 0, 
    [
      (eq, "$tom_use_banners", 1),
      (eq, "$tom_bonus_banners", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_range, ":var1"),
        (agent_slot_eq, ":var1", 40, 1),
        (agent_is_alive, ":var1"),
        (agent_is_active, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (agent_get_position, pos1, ":var1"),
        (try_for_range, ":var3"),
          (neq, ":var3", ":var1"),
          (agent_get_team, ":var4", ":var3"),
          (eq, ":var2", ":var4"),
          (agent_is_alive, ":var3"),
          (agent_is_active, ":var3"),
          (agent_is_human, ":var3"),
          (agent_get_position, pos2, ":var3"),
          (get_distance_between_positions_in_meters, ":var5", pos1, pos2),
          (le, ":var5", 10),
          (store_agent_hit_points, ":var6", ":var3"),
          (val_add, ":var6", 2),
          (val_min, ":var6", 101),
          (agent_set_hit_points, ":var3", ":var6"),
          (try_begin),
            (eq, ":var3", ":var0"),
            (display_message, "@You feel secured standing near the banner, healing some of your HP.", 0x6495ED),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var1", ":var0"),
      (agent_is_alive, ":var1"),
      (agent_get_wielded_item, ":var7", ":var1", 0),
      (is_between, ":var7", 1291, 1295),
      (agent_get_team, ":var2", ":var1"),
      (agent_get_position, pos1, ":var1"),
      (try_for_range, ":var3"),
        (neq, ":var3", ":var1"),
        (agent_get_team, ":var4", ":var3"),
        (eq, ":var2", ":var4"),
        (agent_is_alive, ":var3"),
        (agent_is_active, ":var3"),
        (agent_is_human, ":var3"),
        (agent_get_position, pos2, ":var3"),
        (get_distance_between_positions_in_meters, ":var5", pos1, pos2),
        (le, ":var5", 10),
        (store_agent_hit_points, ":var6", ":var3"),
        (try_begin),
          (eq, ":var7", 1294),
          (val_add, ":var6", 1),
        (try_end),
        (val_add, ":var6", 5),
        (val_max, ":var6", 101),
        (agent_set_hit_points, ":var3", ":var6"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$tom_sand_storm", 3),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (position_set_z_to_ground_level, pos0),
      (position_get_z, ":var1", pos0),
      (val_add, ":var1", 2100),
      (position_set_z, pos0, ":var1"),
      (particle_system_burst, "psys_rain", pos0, 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 0, 
    [
      (eq, "$tom_sand_storm", 2),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (position_set_z_to_ground_level, pos0),
      (position_get_z, ":var1", pos0),
      (val_add, ":var1", 2000),
      (position_set_z, pos0, ":var1"),
      (particle_system_burst, "psys_blizzard", pos0, 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (8, 0, 0, 
    [
      (eq, "$tom_sand_storm", 3),
    ],
    [
      (store_random_in_range, ":var0", 0, 100),
      (try_begin),
        (ge, ":var0", 90),
        (play_sound, "snd_thunder"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (eq, "$tom_sand_storm", 2),
    ],
    [
      (play_sound, "snd_wind"),
    ]),

    (0, 0, ti_once, 
    [
      (eq, "$tom_sand_storm", 1),
    ],
    [
      (play_sound, "snd_wind"),
    ]),

    (0, 1.5, 0, 
    [
      (key_clicked, key_t),
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_set_animation, ":var0", "anim_cheer", 1),
      (agent_play_sound, ":var0", "snd_man_victory"),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_position, pos1, ":var0"),
      (try_for_agents, ":var2"),
        (agent_is_alive, ":var2"),
        (agent_is_human, ":var2"),
        (agent_get_team, ":var3", ":var2"),
        (eq, ":var3", ":var1"),
        (agent_get_position, pos0, ":var2"),
        (get_distance_between_positions_in_meters, ":var4", pos0, pos1),
        (lt, ":var4", 20),
        (agent_set_animation, ":var2", "anim_cheer", 1),
        (agent_play_sound, ":var2", "snd_man_victory"),
        (agent_get_slot, ":var5", ":var2", 16),
        (val_add, ":var5", 5),
        (val_min, ":var5", 9600),
        (agent_set_slot, ":var2", 16, ":var5"),
      (try_end),
      (display_message, "@Huzzah! You encourage your nearby troops."),
    ]),

    (0, 1.7, 0, 
    [
      (eq, "$tom_yell_smelly_peasents", 1),
    ],
    [
      (call_script, "script_tom_command_cheer"),
      (assign, "$tom_yell_smelly_peasents", 0),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (neg|agent_is_ally, ":var0"),
      (agent_is_human, ":var0"),
      (eq, ":var1", "$fplayer_agent_no"),
      (val_add, "$killcount", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_clear_troop_array", "trp_lances_troop_in_combat", 0, "$lance_troop_serving"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_is_human, ":var0"),
      (get_player_agent_no, ":var1"),
      (neq, ":var0", ":var1"),
      (agent_get_party_id, ":var2", ":var0"),
      (eq, ":var2", "p_main_party"),
      (agent_get_troop_id, ":var3", ":var0"),
      (call_script, "script_search_for_troop", ":var3"),
      (agent_set_slot, ":var0", 102, reg0),
    ]),

    (1, 0, ti_once, 
    [
      (neg|is_presentation_active, "prsnt_killcount"),
      (neg|is_presentation_active, "prsnt_troop_ratio_bar"),
      (neg|is_presentation_active, "prsnt_killcount_and_troop_ratio_bar"),
    ],
    [
      (try_begin),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 1),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 2),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 3),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
      (call_script, "script_party_count_fit_for_battle", "p_main_party"),
      (assign, "$player_count_alive", reg0),
      (call_script, "script_party_count_fit_for_battle", "p_collective_friends"),
      (store_sub, "$ally_count_alive", reg0, "$player_count_alive"),
      (call_script, "script_party_count_fit_for_battle", "p_collective_enemy"),
      (assign, "$enemy_count_alive", reg0),
    ]),

    (3, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 1),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 2),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 3),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (call_script, "script_lance_use_classify_agent"),
    ]),

    (2, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 43),
        (gt, ":var1", 0),
        (agent_get_wielded_item, ":var2", ":var0", 0),
        (agent_get_horse, ":var3", ":var0"),
        (try_begin),
          (le, ":var3", 0),
          (agent_set_slot, ":var0", 43, 0),
          (eq, ":var2", ":var1"),
          (call_script, "script_lance_use_backup_weapon", ":var0"),
        (else_try),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var4", ":var0"),
          (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":var4", 1),
          (assign, ":var5", reg0),
          (try_begin),
            (lt, ":var5", 500),
            (agent_get_combat_state, ":var6", ":var0"),
            (gt, ":var6", 3),
            (eq, ":var2", ":var1"),
            (call_script, "script_lance_use_backup_weapon", ":var0"),
          (else_try),
            (neq, ":var2", ":var1"),
            (agent_set_wielded_item, ":var0", ":var1"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$enable_deahtcam", 1),
      (assign, "$auxilary_player_active", 0),
      (eq, "$use_player_auxiliary", 1),
      (assign, "$g_move_heroes", 1),
      (party_clear, "p_temp_casualties_3"),
      (call_script, "script_party_add_party", "p_temp_casualties_3", "p_main_party"),
      (set_player_troop, "trp_player"),
      (assign, "$enable_deahtcam", 0),
    ]),

    (5, 0, 0, 
    [
      (eq, "$use_player_auxiliary", 1),
      (eq, "$enable_deahtcam", 0),
      (get_player_agent_no, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (neq, "$freelancer_state", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_division, ":var2", ":var0"),
      (assign, ":var3", 0),
      (try_for_agents, ":var4"),
        (eq, ":var3", 0),
        (agent_is_human, ":var4"),
        (agent_is_alive, ":var4"),
        (agent_get_team, ":var5", ":var4"),
        (agent_get_party_id, ":var6", ":var4"),
        (eq, ":var6", "p_main_party"),
        (agent_get_division, ":var7", ":var0"),
        (agent_get_group, ":var8", ":var0"),
        (eq, ":var1", ":var5"),
        (eq, ":var2", ":var7"),
        (agent_get_troop_id, ":var9", ":var4"),
        (neg|is_between, ":var9", "trp_npc1", "trp_enhanced_rnd_lord_end"),
        (set_player_troop, ":var9"),
        (store_agent_hit_points, ":var10", ":var4", 1),
        (agent_get_position, pos1, ":var4"),
        (position_set_z, pos1, -2000),
        (position_set_x, pos1, 0),
        (position_set_y, pos1, 0),
        (agent_get_position, pos0, ":var4"),
        (set_spawn_position, pos0),
        (agent_get_horse, ":var11", ":var4"),
        (try_begin),
          (gt, ":var11", 0),
          (agent_set_position, ":var11", pos1),
          (remove_agent, ":var11"),
        (try_end),
        (agent_set_position, ":var4", pos1),
        (agent_set_slot, ":var4", 35, 1),
        (agent_get_slot, ":var12", ":var4", 102),
        (remove_agent, ":var4"),
        (spawn_agent, ":var9"),
        (assign, ":var0", reg0),
        (agent_set_slot, ":var0", 102, ":var12"),
        (agent_set_team, ":var0", ":var1"),
        (agent_set_hit_points, ":var0", ":var10", 1),
        (agent_set_group, ":var0", ":var8"),
        (agent_set_slot, ":var0", 35, 2),
        (agent_set_slot, ":var0", 36, ":var9"),
        (try_begin),
          (agent_get_horse, ":var13", ":var0"),
          (gt, ":var13", 0),
          (lt, ":var11", 0),
          (agent_set_position, ":var13", pos1),
          (remove_agent, ":var13"),
        (try_end),
        (set_player_troop, "trp_player"),
        (assign, ":var3", 1),
        (assign, "$auxilary_player_active", 1),
      (try_end),
      (eq, ":var3", 0),
      (assign, "$enable_deahtcam", 1),
    ]),

    (5, 0, 0, 
    [
      (eq, "$use_player_auxiliary", 1),
      (eq, "$enable_deahtcam", 0),
      (get_player_agent_no, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$enable_deahtcam", 1),
    ]),

    (1, 0, 0, 
    [],
    [
      (val_add, "$do_the_oil", 1),
      (val_add, "$modded2x_agentaireset", 1),
      (try_begin),
        (ge, "$modded2x_agentaireset", 30),
        (assign, "$modded2x_agentaireset", 0),
      (try_end),
      (try_begin),
        (gt, "$do_the_oil", 5),
        (assign, "$do_the_oil", 0),
      (try_end),
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (this_or_next|eq, ":var2", 1),
        (eq, ":var2", 3),
        (neq, ":var1", ":var0"),
        (try_begin),
          (try_begin),
            (ge, "$modded2x_agentaireset", 29),
            (agent_clear_scripted_mode, ":var1"),
            (agent_force_rethink, ":var1"),
          (try_end),
          (try_begin),
            (eq, "$do_once_3", 0),
            (agent_clear_scripted_mode, ":var1"),
            (agent_force_rethink, ":var1"),
            (assign, "$do_once_3", 1),
          (try_end),
        (try_end),
        (try_begin),
          (le, "$do_the_oil", 5),
          (troop_get_slot, ":var3", "trp_oil_array", 0),
          (try_for_range, ":var4", 1, ":var3"),
            (troop_get_slot, ":var5", "trp_oil_array", ":var4"),
            (scene_prop_has_agent_on_it, ":var5", ":var1"),
            (scene_prop_set_slot, ":var5", 400, 1),
            (store_agent_hit_points, ":var6", ":var1", 1),
            (val_sub, ":var6", 1),
            (try_begin),
              (gt, ":var6", 1),
              (agent_set_hit_points, ":var1", ":var6", 1),
            (else_try),
              (agent_deliver_damage_to_agent, ":var1", ":var1", 100),
            (try_end),
            (try_begin),
              (eq, ":var1", ":var0"),
              (display_message, "@You recieve damage from the hot oil spiled by the defenders on you!"),
            (try_end),
          (try_end),
        (try_end),
        (neq, ":var1", ":var0"),
        (agent_get_position, pos0, ":var1"),
        (troop_get_slot, ":var3", "trp_temp_array_c", 0),
        (try_for_range, ":var4", 1, ":var3"),
          (troop_get_slot, ":var5", "trp_temp_array_c", ":var4"),
          (scene_prop_get_hit_points, ":var6", ":var5"),
          (gt, ":var6", 0),
          (prop_instance_get_position, pos1, ":var5"),
          (get_distance_between_positions_in_meters, ":var7", pos0, pos1),
          (le, ":var7", 1),
          (store_random_in_range, ":var8", 0, 101),
          (le, ":var8", 60),
          (agent_set_look_target_position, ":var1", pos1),
          (agent_set_attack_action, ":var1", 3, 0),
          (val_div, ":var8", 10),
          (prop_instance_receive_damage, ":var5", ":var1", ":var8"),
        (try_end),
      (try_end),
      (le, "$do_the_oil", 5),
      (troop_get_slot, ":var3", "trp_oil_array", 0),
      (try_for_range, ":var4", 1, ":var3"),
        (troop_get_slot, ":var5", "trp_oil_array", ":var4"),
        (scene_prop_slot_eq, ":var5", 400, 1),
        (prop_instance_get_position, pos1, ":var5"),
        (particle_system_burst, "psys_gourd_smoke", pos1, 100),
        (position_move_z, pos1, 500, 1),
        (particle_system_burst, "psys_oil", pos1, 100),
        (scene_prop_set_slot, ":var5", 400, 0),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, ":var0", 1),
      (scene_prop_get_num_instances, ":var1", "spr_1257_earth_gate"),
      (try_for_range, ":var2", 0, ":var1"),
        (scene_prop_get_instance, ":var3", "spr_1257_earth_gate", ":var2"),
        (troop_set_slot, "trp_temp_array_c", ":var0", ":var3"),
        (val_add, ":var0", 1),
        (scene_prop_set_team, ":var3", 2),
      (try_end),
      (scene_prop_get_num_instances, ":var1", "spr_1257_portcullis"),
      (try_for_range, ":var2", 0, ":var1"),
        (scene_prop_get_instance, ":var3", "spr_1257_portcullis", ":var2"),
        (troop_set_slot, "trp_temp_array_c", ":var0", ":var3"),
        (val_add, ":var0", 1),
        (scene_prop_set_team, ":var3", 2),
      (try_end),
      (scene_prop_get_num_instances, ":var1", "spr_1257_tavern_door_a"),
      (try_for_range, ":var2", 0, ":var1"),
        (scene_prop_get_instance, ":var3", "spr_1257_tavern_door_a", ":var2"),
        (troop_set_slot, "trp_temp_array_c", ":var0", ":var3"),
        (val_add, ":var0", 1),
        (scene_prop_set_team, ":var3", 2),
      (try_end),
      (scene_prop_get_num_instances, ":var1", "spr_1257_tavern_door_b"),
      (try_for_range, ":var2", 0, ":var1"),
        (scene_prop_get_instance, ":var3", "spr_1257_tavern_door_b", ":var2"),
        (troop_set_slot, "trp_temp_array_c", ":var0", ":var3"),
        (val_add, ":var0", 1),
        (scene_prop_set_team, ":var3", 2),
      (try_end),
      (scene_prop_get_num_instances, ":var1", "spr_1257_castle_f_door_a"),
      (try_for_range, ":var2", 0, ":var1"),
        (scene_prop_get_instance, ":var3", "spr_1257_castle_f_door_a", ":var2"),
        (troop_set_slot, "trp_temp_array_c", ":var0", ":var3"),
        (val_add, ":var0", 1),
        (scene_prop_set_team, ":var3", 2),
      (try_end),
      (troop_set_slot, "trp_temp_array_c", 0, ":var0"),
      (assign, ":var0", 1),
      (scene_prop_get_num_instances, ":var1", "spr_1257_hit_spot_2m"),
      (try_for_range, ":var2", 0, ":var1"),
        (scene_prop_get_instance, ":var3", "spr_1257_hit_spot_2m", ":var2"),
        (troop_set_slot, "trp_oil_array", ":var0", ":var3"),
        (val_add, ":var0", 1),
        (scene_prop_set_team, ":var3", 2),
      (try_end),
      (scene_prop_get_num_instances, ":var1", "spr_1257_hit_spot_4m"),
      (try_for_range, ":var2", 0, ":var1"),
        (scene_prop_get_instance, ":var3", "spr_1257_hit_spot_4m", ":var2"),
        (troop_set_slot, "trp_oil_array", ":var0", ":var3"),
        (val_add, ":var0", 1),
        (scene_prop_set_team, ":var3", 2),
      (try_end),
      (troop_set_slot, "trp_oil_array", 0, ":var0"),
      (assign, "$do_the_oil", 0),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_division, ":var0", 0),
      (try_for_range, ":var1", "itm_hunting_bow", "itm_arrows"),
        (agent_has_item_equipped, ":var0", ":var1"),
        (agent_set_division, ":var0", 1),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    []),

    (0, 0, 3, 
    [
      (key_clicked, key_numpad_0),
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_is_human, ":var0"),
      (agent_is_defender, ":var0"),
      (store_faction_of_party, ":var1", "$current_town"),
      (this_or_next|party_slot_eq, "$current_town", 7, "trp_player"),
      (this_or_next|faction_slot_eq, ":var1", 8, "trp_player"),
      (faction_slot_eq, ":var1", 11, "trp_player"),
    ],
    [
      (call_script, "script_siege_move_archers_to_archer_positions"),
      (display_message, "@Archers! Move to your positions!"),
    ]),

    (5, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (this_or_next|eq, ":var1", "$attacker_team"),
        (eq, ":var1", "$attacker_team_2"),
        (agent_ai_set_always_attack_in_melee, ":var0", 1),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (eq, "$freelancer_state", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (ge, ":var0", 0),
      (agent_is_active, ":var0"),
      (store_trigger_param_1, ":var1"),
      (eq, ":var0", ":var1"),
      (agent_get_team, ":var2", ":var0"),
      (team_set_order_listener, ":var2", -1),
      (val_add, ":var2", 2),
      (agent_set_team, ":var0", ":var2"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$g_decap_enabled", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (agent_is_non_player, ":var0"),
      (agent_get_troop_id, ":var3", ":var0"),
      (neg|troop_is_hero, ":var3"),
      (assign, ":var4", reg0),
      (copy_position, 5, 0),
      (neq, ":var0", -1),
      (try_begin),
        (agent_is_human, ":var0"),
        (ge, ":var4", 0),
        (assign, ":var5", 0),
        (try_begin),
          (this_or_next|eq, ":var4", "itm_supercrossbow"),
          (eq, ":var4", "itm_supersledge"),
          (assign, ":var5", 1),
        (else_try),
          (neq, ":var4", "itm_mace_1"),
          (neq, ":var4", "itm_mace_2"),
          (neq, ":var4", "itm_mace_3"),
          (neq, ":var4", "itm_staff"),
          (agent_get_action_dir, ":var6", ":var1"),
          (this_or_next|eq, ":var6", 1),
          (eq, ":var6", 2),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var5", 0),
        (try_begin),
          (ge, ":var2", "$g_decap_minimum_damage"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap minimum DMG req bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (store_agent_hit_points, ":var7", ":var0", 1),
        (val_add, ":var7", "$g_decap_negative_health"),
        (ge, ":var2", ":var7"),
        (agent_get_position, pos4, ":var0"),
        (get_distance_between_positions, ":var8", pos4, pos5),
        (agent_get_horse, ":var9", ":var0"),
        (try_begin),
          (ge, ":var9", 0),
          (assign, ":var10", 240),
          (assign, ":var11", 260),
        (else_try),
          (assign, ":var10", 160),
          (assign, ":var11", 176),
        (try_end),
        (is_between, ":var8", ":var10", ":var11"),
        (assign, ":var5", 0),
        (try_begin),
          (store_random_in_range, ":var12", 0, 100),
          (le, ":var12", "$g_decap_chance"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap chance calc bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var13", "itm_cut_off_head_male"),
        (agent_get_troop_id, ":var14", ":var0"),
        (try_begin),
          (ge, ":var14", 0),
          (troop_get_type, ":var15", ":var14"),
          (eq, ":var15", 1),
          (assign, ":var13", "itm_cut_off_head_female"),
        (try_end),
        (store_random_in_range, ":var16", 0, 360),
        (store_random_in_range, ":var17", -60, 60),
        (store_random_in_range, ":var18", -90, 90),
        (store_random_in_range, ":var19", -90, 90),
        (position_rotate_z, pos4, ":var16"),
        (position_rotate_y, pos4, ":var17"),
        (position_move_x, 4, ":var18"),
        (position_move_y, pos4, ":var19"),
        (position_set_z_to_ground_level, pos4),
        (position_move_z, pos4, 5),
        (set_spawn_position, pos4),
        (assign, ":var20", 360),
        (agent_get_item_slot, ":var21", ":var0", 4),
        (try_begin),
          (ge, ":var21", 1),
          (agent_unequip_item, ":var0", ":var21"),
          (try_begin),
            (spawn_item, ":var21", 0, ":var20"),
          (try_end),
        (try_end),
        (agent_equip_item, ":var0", "itm_invisible_head"),
        (agent_get_position, pos4, ":var0"),
        (position_move_z, pos4, ":var10"),
        (particle_system_burst, "psys_blood_decapitation", pos4, "$g_decap_psys_blood_decapitation"),
        (particle_system_burst, "psys_game_blood", pos4, "$g_decap_psys_game_blood"),
        (particle_system_burst, "psys_game_blood_2", pos4, "$g_decap_psys_game_blood_2"),
        (play_sound_at_position, "snd_decapitation", pos4),
        (position_move_z, pos4, 20),
        (set_spawn_position, pos4),
        (assign, ":var13", "spr_head_dynamic_male"),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var13", "spr_head_dynamic_female"),
        (try_end),
        (spawn_scene_prop, ":var13"),
        (agent_get_troop_id, ":var22", ":var1"),
        (str_store_troop_name, s0, ":var22"),
        (agent_get_troop_id, ":var14", ":var0"),
        (str_store_troop_name, s1, ":var14"),
        (get_player_agent_no, ":var23"),
        (agent_get_team, ":var24", ":var23"),
        (agent_get_team, ":var25", ":var0"),
        (try_begin),
          (neq, ":var24", ":var25"),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFF33DD11),
        (else_try),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFFFF4422),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_bully_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_fat_peasant_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_thug_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_fatseveredarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_thin_looter_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (0, 0, 1, 
    [
      (key_clicked, key_right_control),
    ],
    [
      (try_begin),
        (key_is_down, key_m),
        (try_begin),
          (eq, "$g_decapitations_debugging", 0),
          (assign, "$g_decapitations_debugging", 1),
          (display_message, "@Decapitation debug mode Enabled"),
        (else_try),
          (assign, "$g_decapitations_debugging", 0),
          (display_message, "@Decapitation debug mode Disabled"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, key_k),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos17, ":var0"),
        (position_move_y, pos17, 2000),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_bully_handless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_thug_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_thin_looter_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_fat_peasant_handless"),
        (agent_set_team, reg0, 2),
      (try_end),
      (try_begin),
        (key_is_down, key_j),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos18, ":var0"),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supersledge"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supercrossbow"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_super_bolts"),
      (try_end),
    ]),

  ]),

  ("castle_attack_walls_ladder", mtf_battle_mode, -1,
  "You attack the walls of the castle...",
  [
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 48, []),
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 0, []),
    (10, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
    (11, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 28, []),
    (15, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
    (40, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 4, []),
    (41, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 4, []),
    (42, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 4, []),
    (43, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 4, []),
    (44, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 4, []),
    (45, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 4, []),
    (46, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 4, []),
  ],
  [
    (ti_on_agent_hit, 0.3, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (assign, ":var3", reg0),
      (agent_is_human, ":var0"),
      (get_player_agent_no, ":var4"),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var0", ":var4"),
        (store_random_in_range, ":var5", 0, 1000),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 4, 8),
        (troop_get_inventory_slot, ":var7", "trp_player", ":var6"),
        (gt, ":var7", 0),
        (str_store_item_name, s20, ":var7"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var6"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} is too crapy to fall apart!", 0xFF0000),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var7", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var6", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var1", ":var4"),
        (is_between, ":var3", 1, "itm_items_end"),
        (neg|is_between, ":var3", "itm_light_lance", "itm_wooden_shield"),
        (item_get_type, ":var9", ":var3"),
        (ge, ":var2", 10),
        (neq, ":var9", 10),
        (neq, ":var9", 8),
        (neq, ":var9", 9),
        (neq, ":var9", 5),
        (neq, ":var9", 6),
        (store_random_in_range, ":var5", 0, 600),
        (eq, ":var5", 1),
        (assign, ":var10", -1),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var11", "trp_player", ":var6"),
          (eq, ":var11", ":var3"),
          (assign, ":var10", ":var6"),
        (try_end),
        (gt, ":var10", 0),
        (str_store_item_name, s20, ":var3"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var10"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} falls apart!", 0xFF0000),
          (agent_unequip_item, ":var4", ":var3"),
          (troop_remove_item, "trp_player", ":var3"),
          (troop_remove_item, "trp_broken_items", ":var3"),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var3", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var10", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (agent_get_horse, ":var12", ":var1"),
      (try_begin),
        (eq, "$tom_lance_breaking", 1),
        (gt, ":var12", 0),
        (this_or_next|is_between, ":var3", "itm_light_lance", "itm_bamboo_spear"),
        (is_between, ":var3", "itm_crusader_knight_spear_a", "itm_crusader_spear_a"),
        (ge, ":var2", 50),
        (store_random_in_range, ":var13", 0, 100),
        (gt, ":var13", 20),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your lance!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (this_or_next|is_between, ":var3", "itm_bamboo_spear", "itm_staff"),
        (is_between, ":var3", "itm_crusader_spear_a", "itm_mace_6"),
        (le, ":var12", 0),
        (ge, ":var2", 8),
        (store_random_in_range, ":var13", 0, 100),
        (ge, ":var13", 90),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your spear!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_begin),
        (neq, "$attacker_team", ":var2"),
        (neq, "$attacker_team_2", ":var2"),
        (str_store_string, s5, "str_siege_continues"),
        (call_script, "script_simulate_retreat", 8, 15, 0),
      (else_try),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (assign, "$g_defender_reinforcement_limit", "$g_reinforcement_waves"),
      (assign, "$g_attacker_reinforcement_limit", "$g_reinforcement_waves"),
      (assign, "$dmod_current_agent", -1),
      (assign, "$dmod_move_camera", -1),
      (call_script, "script_combat_music_set_situation_with_culture", 262144),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture", 262144),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
    ],
    []),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (entry_point_get_position, pos10, 10),
      (try_for_range, ":var0", 0, 9),
        (neq, ":var0", 1),
        (team_give_order, "$defender_team", ":var0", 0),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 0),
        (team_give_order, "$defender_team_2", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 7),
      (try_end),
      (team_give_order, "$defender_team", 1, 11),
      (team_set_order_position, "$defender_team", 9, pos10),
      (team_give_order, "$defender_team_2", 1, 11),
      (team_set_order_position, "$defender_team_2", 9, pos10),
      (team_give_order, "$attacker_team", 9, 2),
      (team_give_order, "$attacker_team_2", 9, 2),
      (set_show_messages, 1),
    ],
    []),

    (0, 2, ti_once, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 5, 1),
      (try_end),
    ]),

    (3, 0, 0, 
    [],
    [
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
      (try_begin),
        (store_mul, ":var1", "$attacker_reinforcement_stage", 2),
        (this_or_next|lt, "$defender_reinforcement_stage", "$g_defender_reinforcement_limit"),
        (le, "$defender_reinforcement_stage", ":var1"),
        (store_normalized_team_count, ":var2", 0),
        (lt, ":var2", 40),
        (add_reinforcements_to_entry, 4, 28),
        (val_add, "$defender_reinforcement_stage", 1),
      (try_end),
    ]),

    (2, 0, 0, 
    [
      (gt, "$defender_reinforcement_stage", 0),
    ],
    [
      (call_script, "script_siege_move_archers_to_archer_positions"),
    ]),

    (3, 0, 0, 
    [
      (assign, ":var0", 1),
      (try_begin),
        (ge, "$attacker_reinforcement_stage", 10),
        (store_mul, ":var1", "$defender_reinforcement_stage", 2),
        (gt, "$attacker_reinforcement_stage", ":var1"),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (store_mission_timer_a, ":var2"),
      (ge, ":var2", 5),
      (store_normalized_team_count, ":var3", 1),
      (lt, ":var3", 30),
    ],
    [
      (add_reinforcements_to_entry, 1, 32),
      (val_add, "$attacker_reinforcement_stage", 1),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (5, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (try_begin),
        (eq, "$auxilary_player_active", 0),
        (call_script, "script_freelancer_keep_field_loot"),
      (try_end),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (assign, "$do_once_3", 0),
      (finish_mission, 1),
    ]),

    (5, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (180, 0, 0, 
    [],
    [
      (display_message, "@Refilling defender ammo..."),
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (this_or_next|eq, ":var2", "$defender_team"),
        (eq, ":var2", "$defender_team_2"),
        (agent_refill_ammo, ":var1"),
      (try_end),
      (try_begin),
        (agent_get_team, ":var2", ":var0"),
        (this_or_next|eq, ":var2", "$defender_team"),
        (eq, ":var2", "$defender_team_2"),
        (agent_refill_ammo, ":var0"),
      (try_end),
    ]),

    (1, 4, ti_once, 
    [
      (eq, "$enable_deahtcam", 1),
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@You have been knocked out by the enemy. Watch your men continue the fight without you or press Tab to retreat."),
      (display_message, "@If you choose to watch the fight you can use the mouse scroll up and down to switch between troop view or AWDS keys for free camera view."),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (is_presentation_active, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (val_add, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
      (set_mission_result, -1),
      (display_message, "@Battle lost..."),
      (assign, "$g_battle_won", -1),
      (assign, "$g_battle_result", -1),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (assign, "$do_once_3", 0),
      (finish_mission, 0),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", -1),
      (display_message, "@Battle lost! Press tab key to leave..."),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (gt, "$dmod_current_agent", 0),
      (eq, "$setting_use_dmod", 1),
      (eq, "$dmod_move_camera", 1),
      (agent_get_position, pos1, "$dmod_current_agent"),
      (position_move_z, pos1, 300),
      (position_move_y, pos1, -300),
      (agent_get_horse, ":var0", "$dmod_current_agent"),
      (try_begin),
        (ge, ":var0", 0),
      (try_end),
      (mission_cam_set_position, pos1),
      (mission_cam_set_mode, 1),
      (set_fixed_point_multiplier, 100),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_up),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_forwards"),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_down),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_backwards"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 4, ti_once, 
    [
      (eq, "$enable_deahtcam", 1),
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
      (assign, "$tom_sand_storm", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (this_or_next|eq, "$dmod_move_camera", 1),
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, gk_move_forward),
      (this_or_next|game_key_is_down, gk_move_backward),
      (this_or_next|game_key_is_down, gk_move_left),
      (this_or_next|game_key_is_down, gk_move_right),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_backward),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_left),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (position_rotate_x_floating, pos47, ":var7"),
        (position_rotate_y, pos47, 90),
        (position_rotate_x_floating, pos47, ":var3"),
        (position_rotate_y, pos47, -90),
        (position_rotate_x_floating, pos47, "$deathcam_total_rotx"),
        (position_rotate_x_floating, pos47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|eq, ":var0", 0),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "str_enhanced_battle_knocked_out_message_1"),
      (display_message, "str_enhanced_battle_knocked_out_message_2"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var3", ":var0"),
        (party_add_members, "p_total_enemy_casualties", ":var3", 1),
        (eq, ":var2", 1),
        (party_wound_members, "p_total_enemy_casualties", ":var3", 1),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$tom_sand_storm", 0),
      (call_script, "script_change_rain_or_snow"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$tom_sand_storm", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (position_set_z_to_ground_level, pos0),
      (position_get_z, ":var1", pos0),
      (val_add, ":var1", 400),
      (position_set_z, pos0, ":var1"),
      (particle_system_burst, "psys_desert_storm", pos0, 2),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 2, ti_once, 
    [
      (eq, "$tom_use_banners", 1),
    ],
    [
      (call_script, "script_set_flag_carriers"),
    ]),

    (10, 0, 0, 
    [
      (eq, "$tom_use_banners", 1),
      (eq, "$tom_bonus_banners", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_range, ":var1"),
        (agent_slot_eq, ":var1", 40, 1),
        (agent_is_alive, ":var1"),
        (agent_is_active, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (agent_get_position, pos1, ":var1"),
        (try_for_range, ":var3"),
          (neq, ":var3", ":var1"),
          (agent_get_team, ":var4", ":var3"),
          (eq, ":var2", ":var4"),
          (agent_is_alive, ":var3"),
          (agent_is_active, ":var3"),
          (agent_is_human, ":var3"),
          (agent_get_position, pos2, ":var3"),
          (get_distance_between_positions_in_meters, ":var5", pos1, pos2),
          (le, ":var5", 10),
          (store_agent_hit_points, ":var6", ":var3"),
          (val_add, ":var6", 2),
          (val_min, ":var6", 101),
          (agent_set_hit_points, ":var3", ":var6"),
          (try_begin),
            (eq, ":var3", ":var0"),
            (display_message, "@You feel secured standing near the banner, healing some of your HP.", 0x6495ED),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var1", ":var0"),
      (agent_is_alive, ":var1"),
      (agent_get_wielded_item, ":var7", ":var1", 0),
      (is_between, ":var7", 1291, 1295),
      (agent_get_team, ":var2", ":var1"),
      (agent_get_position, pos1, ":var1"),
      (try_for_range, ":var3"),
        (neq, ":var3", ":var1"),
        (agent_get_team, ":var4", ":var3"),
        (eq, ":var2", ":var4"),
        (agent_is_alive, ":var3"),
        (agent_is_active, ":var3"),
        (agent_is_human, ":var3"),
        (agent_get_position, pos2, ":var3"),
        (get_distance_between_positions_in_meters, ":var5", pos1, pos2),
        (le, ":var5", 10),
        (store_agent_hit_points, ":var6", ":var3"),
        (try_begin),
          (eq, ":var7", 1294),
          (val_add, ":var6", 1),
        (try_end),
        (val_add, ":var6", 5),
        (val_max, ":var6", 101),
        (agent_set_hit_points, ":var3", ":var6"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$tom_sand_storm", 3),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (position_set_z_to_ground_level, pos0),
      (position_get_z, ":var1", pos0),
      (val_add, ":var1", 2100),
      (position_set_z, pos0, ":var1"),
      (particle_system_burst, "psys_rain", pos0, 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 0, 
    [
      (eq, "$tom_sand_storm", 2),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (position_set_z_to_ground_level, pos0),
      (position_get_z, ":var1", pos0),
      (val_add, ":var1", 2000),
      (position_set_z, pos0, ":var1"),
      (particle_system_burst, "psys_blizzard", pos0, 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (8, 0, 0, 
    [
      (eq, "$tom_sand_storm", 3),
    ],
    [
      (store_random_in_range, ":var0", 0, 100),
      (try_begin),
        (ge, ":var0", 90),
        (play_sound, "snd_thunder"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (eq, "$tom_sand_storm", 2),
    ],
    [
      (play_sound, "snd_wind"),
    ]),

    (0, 0, ti_once, 
    [
      (eq, "$tom_sand_storm", 1),
    ],
    [
      (play_sound, "snd_wind"),
    ]),

    (0, 1.5, 0, 
    [
      (key_clicked, key_t),
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_set_animation, ":var0", "anim_cheer", 1),
      (agent_play_sound, ":var0", "snd_man_victory"),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_position, pos1, ":var0"),
      (try_for_agents, ":var2"),
        (agent_is_alive, ":var2"),
        (agent_is_human, ":var2"),
        (agent_get_team, ":var3", ":var2"),
        (eq, ":var3", ":var1"),
        (agent_get_position, pos0, ":var2"),
        (get_distance_between_positions_in_meters, ":var4", pos0, pos1),
        (lt, ":var4", 20),
        (agent_set_animation, ":var2", "anim_cheer", 1),
        (agent_play_sound, ":var2", "snd_man_victory"),
        (agent_get_slot, ":var5", ":var2", 16),
        (val_add, ":var5", 5),
        (val_min, ":var5", 9600),
        (agent_set_slot, ":var2", 16, ":var5"),
      (try_end),
      (display_message, "@Huzzah! You encourage your nearby troops."),
    ]),

    (0, 1.7, 0, 
    [
      (eq, "$tom_yell_smelly_peasents", 1),
    ],
    [
      (call_script, "script_tom_command_cheer"),
      (assign, "$tom_yell_smelly_peasents", 0),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (neg|agent_is_ally, ":var0"),
      (agent_is_human, ":var0"),
      (eq, ":var1", "$fplayer_agent_no"),
      (val_add, "$killcount", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_clear_troop_array", "trp_lances_troop_in_combat", 0, "$lance_troop_serving"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_is_human, ":var0"),
      (get_player_agent_no, ":var1"),
      (neq, ":var0", ":var1"),
      (agent_get_party_id, ":var2", ":var0"),
      (eq, ":var2", "p_main_party"),
      (agent_get_troop_id, ":var3", ":var0"),
      (call_script, "script_search_for_troop", ":var3"),
      (agent_set_slot, ":var0", 102, reg0),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$enable_deahtcam", 1),
      (assign, "$auxilary_player_active", 0),
      (eq, "$use_player_auxiliary", 1),
      (assign, "$g_move_heroes", 1),
      (party_clear, "p_temp_casualties_3"),
      (call_script, "script_party_add_party", "p_temp_casualties_3", "p_main_party"),
      (set_player_troop, "trp_player"),
      (assign, "$enable_deahtcam", 0),
    ]),

    (5, 0, 0, 
    [
      (eq, "$use_player_auxiliary", 1),
      (eq, "$enable_deahtcam", 0),
      (get_player_agent_no, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (neq, "$freelancer_state", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_division, ":var2", ":var0"),
      (assign, ":var3", 0),
      (try_for_agents, ":var4"),
        (eq, ":var3", 0),
        (agent_is_human, ":var4"),
        (agent_is_alive, ":var4"),
        (agent_get_team, ":var5", ":var4"),
        (agent_get_party_id, ":var6", ":var4"),
        (eq, ":var6", "p_main_party"),
        (agent_get_division, ":var7", ":var0"),
        (agent_get_group, ":var8", ":var0"),
        (eq, ":var1", ":var5"),
        (eq, ":var2", ":var7"),
        (agent_get_troop_id, ":var9", ":var4"),
        (neg|is_between, ":var9", "trp_npc1", "trp_enhanced_rnd_lord_end"),
        (set_player_troop, ":var9"),
        (store_agent_hit_points, ":var10", ":var4", 1),
        (agent_get_position, pos1, ":var4"),
        (position_set_z, pos1, -2000),
        (position_set_x, pos1, 0),
        (position_set_y, pos1, 0),
        (agent_get_position, pos0, ":var4"),
        (set_spawn_position, pos0),
        (agent_get_horse, ":var11", ":var4"),
        (try_begin),
          (gt, ":var11", 0),
          (agent_set_position, ":var11", pos1),
          (remove_agent, ":var11"),
        (try_end),
        (agent_set_position, ":var4", pos1),
        (agent_set_slot, ":var4", 35, 1),
        (agent_get_slot, ":var12", ":var4", 102),
        (remove_agent, ":var4"),
        (spawn_agent, ":var9"),
        (assign, ":var0", reg0),
        (agent_set_slot, ":var0", 102, ":var12"),
        (agent_set_team, ":var0", ":var1"),
        (agent_set_hit_points, ":var0", ":var10", 1),
        (agent_set_group, ":var0", ":var8"),
        (agent_set_slot, ":var0", 35, 2),
        (agent_set_slot, ":var0", 36, ":var9"),
        (try_begin),
          (agent_get_horse, ":var13", ":var0"),
          (gt, ":var13", 0),
          (lt, ":var11", 0),
          (agent_set_position, ":var13", pos1),
          (remove_agent, ":var13"),
        (try_end),
        (set_player_troop, "trp_player"),
        (assign, ":var3", 1),
        (assign, "$auxilary_player_active", 1),
      (try_end),
      (eq, ":var3", 0),
      (assign, "$enable_deahtcam", 1),
    ]),

    (5, 0, 0, 
    [
      (eq, "$use_player_auxiliary", 1),
      (eq, "$enable_deahtcam", 0),
      (get_player_agent_no, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$enable_deahtcam", 1),
    ]),

    (1, 0, 0, 
    [],
    [
      (val_add, "$do_the_oil", 1),
      (val_add, "$modded2x_agentaireset", 1),
      (try_begin),
        (ge, "$modded2x_agentaireset", 30),
        (assign, "$modded2x_agentaireset", 0),
      (try_end),
      (try_begin),
        (gt, "$do_the_oil", 5),
        (assign, "$do_the_oil", 0),
      (try_end),
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (this_or_next|eq, ":var2", 1),
        (eq, ":var2", 3),
        (neq, ":var1", ":var0"),
        (try_begin),
          (try_begin),
            (ge, "$modded2x_agentaireset", 29),
            (agent_clear_scripted_mode, ":var1"),
            (agent_force_rethink, ":var1"),
          (try_end),
          (try_begin),
            (eq, "$do_once_3", 0),
            (agent_clear_scripted_mode, ":var1"),
            (agent_force_rethink, ":var1"),
            (assign, "$do_once_3", 1),
          (try_end),
        (try_end),
        (try_begin),
          (le, "$do_the_oil", 5),
          (troop_get_slot, ":var3", "trp_oil_array", 0),
          (try_for_range, ":var4", 1, ":var3"),
            (troop_get_slot, ":var5", "trp_oil_array", ":var4"),
            (scene_prop_has_agent_on_it, ":var5", ":var1"),
            (scene_prop_set_slot, ":var5", 400, 1),
            (store_agent_hit_points, ":var6", ":var1", 1),
            (val_sub, ":var6", 1),
            (try_begin),
              (gt, ":var6", 1),
              (agent_set_hit_points, ":var1", ":var6", 1),
            (else_try),
              (agent_deliver_damage_to_agent, ":var1", ":var1", 100),
            (try_end),
            (try_begin),
              (eq, ":var1", ":var0"),
              (display_message, "@You recieve damage from the hot oil spiled by the defenders on you!"),
            (try_end),
          (try_end),
        (try_end),
        (neq, ":var1", ":var0"),
        (agent_get_position, pos0, ":var1"),
        (troop_get_slot, ":var3", "trp_temp_array_c", 0),
        (try_for_range, ":var4", 1, ":var3"),
          (troop_get_slot, ":var5", "trp_temp_array_c", ":var4"),
          (scene_prop_get_hit_points, ":var6", ":var5"),
          (gt, ":var6", 0),
          (prop_instance_get_position, pos1, ":var5"),
          (get_distance_between_positions_in_meters, ":var7", pos0, pos1),
          (le, ":var7", 1),
          (store_random_in_range, ":var8", 0, 101),
          (le, ":var8", 60),
          (agent_set_look_target_position, ":var1", pos1),
          (agent_set_attack_action, ":var1", 3, 0),
          (val_div, ":var8", 10),
          (prop_instance_receive_damage, ":var5", ":var1", ":var8"),
        (try_end),
      (try_end),
      (le, "$do_the_oil", 5),
      (troop_get_slot, ":var3", "trp_oil_array", 0),
      (try_for_range, ":var4", 1, ":var3"),
        (troop_get_slot, ":var5", "trp_oil_array", ":var4"),
        (scene_prop_slot_eq, ":var5", 400, 1),
        (prop_instance_get_position, pos1, ":var5"),
        (particle_system_burst, "psys_gourd_smoke", pos1, 100),
        (position_move_z, pos1, 500, 1),
        (particle_system_burst, "psys_oil", pos1, 100),
        (scene_prop_set_slot, ":var5", 400, 0),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, ":var0", 1),
      (scene_prop_get_num_instances, ":var1", "spr_1257_earth_gate"),
      (try_for_range, ":var2", 0, ":var1"),
        (scene_prop_get_instance, ":var3", "spr_1257_earth_gate", ":var2"),
        (troop_set_slot, "trp_temp_array_c", ":var0", ":var3"),
        (val_add, ":var0", 1),
        (scene_prop_set_team, ":var3", 2),
      (try_end),
      (scene_prop_get_num_instances, ":var1", "spr_1257_portcullis"),
      (try_for_range, ":var2", 0, ":var1"),
        (scene_prop_get_instance, ":var3", "spr_1257_portcullis", ":var2"),
        (troop_set_slot, "trp_temp_array_c", ":var0", ":var3"),
        (val_add, ":var0", 1),
        (scene_prop_set_team, ":var3", 2),
      (try_end),
      (scene_prop_get_num_instances, ":var1", "spr_1257_tavern_door_a"),
      (try_for_range, ":var2", 0, ":var1"),
        (scene_prop_get_instance, ":var3", "spr_1257_tavern_door_a", ":var2"),
        (troop_set_slot, "trp_temp_array_c", ":var0", ":var3"),
        (val_add, ":var0", 1),
        (scene_prop_set_team, ":var3", 2),
      (try_end),
      (scene_prop_get_num_instances, ":var1", "spr_1257_tavern_door_b"),
      (try_for_range, ":var2", 0, ":var1"),
        (scene_prop_get_instance, ":var3", "spr_1257_tavern_door_b", ":var2"),
        (troop_set_slot, "trp_temp_array_c", ":var0", ":var3"),
        (val_add, ":var0", 1),
        (scene_prop_set_team, ":var3", 2),
      (try_end),
      (scene_prop_get_num_instances, ":var1", "spr_1257_castle_f_door_a"),
      (try_for_range, ":var2", 0, ":var1"),
        (scene_prop_get_instance, ":var3", "spr_1257_castle_f_door_a", ":var2"),
        (troop_set_slot, "trp_temp_array_c", ":var0", ":var3"),
        (val_add, ":var0", 1),
        (scene_prop_set_team, ":var3", 2),
      (try_end),
      (troop_set_slot, "trp_temp_array_c", 0, ":var0"),
      (assign, ":var0", 1),
      (scene_prop_get_num_instances, ":var1", "spr_1257_hit_spot_2m"),
      (try_for_range, ":var2", 0, ":var1"),
        (scene_prop_get_instance, ":var3", "spr_1257_hit_spot_2m", ":var2"),
        (troop_set_slot, "trp_oil_array", ":var0", ":var3"),
        (val_add, ":var0", 1),
        (scene_prop_set_team, ":var3", 2),
      (try_end),
      (scene_prop_get_num_instances, ":var1", "spr_1257_hit_spot_4m"),
      (try_for_range, ":var2", 0, ":var1"),
        (scene_prop_get_instance, ":var3", "spr_1257_hit_spot_4m", ":var2"),
        (troop_set_slot, "trp_oil_array", ":var0", ":var3"),
        (val_add, ":var0", 1),
        (scene_prop_set_team, ":var3", 2),
      (try_end),
      (troop_set_slot, "trp_oil_array", 0, ":var0"),
      (assign, "$do_the_oil", 0),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_division, ":var0", 0),
      (try_for_range, ":var1", "itm_hunting_bow", "itm_arrows"),
        (agent_has_item_equipped, ":var0", ":var1"),
        (agent_set_division, ":var0", 1),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    []),

    (0, 0, 3, 
    [
      (key_clicked, key_numpad_0),
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_is_human, ":var0"),
      (agent_is_defender, ":var0"),
      (store_faction_of_party, ":var1", "$current_town"),
      (this_or_next|party_slot_eq, "$current_town", 7, "trp_player"),
      (this_or_next|faction_slot_eq, ":var1", 8, "trp_player"),
      (faction_slot_eq, ":var1", 11, "trp_player"),
    ],
    [
      (call_script, "script_siege_move_archers_to_archer_positions"),
      (display_message, "@Archers! Move to your positions!"),
    ]),

    (5, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (this_or_next|eq, ":var1", "$attacker_team"),
        (eq, ":var1", "$attacker_team_2"),
        (agent_ai_set_always_attack_in_melee, ":var0", 1),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [
      (neg|is_presentation_active, "prsnt_killcount"),
      (neg|is_presentation_active, "prsnt_troop_ratio_bar"),
      (neg|is_presentation_active, "prsnt_killcount_and_troop_ratio_bar"),
    ],
    [
      (try_begin),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 1),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 2),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 3),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
      (call_script, "script_party_count_fit_for_battle", "p_main_party"),
      (assign, "$player_count_alive", reg0),
      (call_script, "script_party_count_fit_for_battle", "p_collective_friends"),
      (store_sub, "$ally_count_alive", reg0, "$player_count_alive"),
      (call_script, "script_party_count_fit_for_battle", "p_collective_enemy"),
      (assign, "$enemy_count_alive", reg0),
    ]),

    (3, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 1),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 2),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 3),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (call_script, "script_lance_use_classify_agent"),
    ]),

    (2, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 43),
        (gt, ":var1", 0),
        (agent_get_wielded_item, ":var2", ":var0", 0),
        (agent_get_horse, ":var3", ":var0"),
        (try_begin),
          (le, ":var3", 0),
          (agent_set_slot, ":var0", 43, 0),
          (eq, ":var2", ":var1"),
          (call_script, "script_lance_use_backup_weapon", ":var0"),
        (else_try),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var4", ":var0"),
          (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":var4", 1),
          (assign, ":var5", reg0),
          (try_begin),
            (lt, ":var5", 500),
            (agent_get_combat_state, ":var6", ":var0"),
            (gt, ":var6", 3),
            (eq, ":var2", ":var1"),
            (call_script, "script_lance_use_backup_weapon", ":var0"),
          (else_try),
            (neq, ":var2", ":var1"),
            (agent_set_wielded_item, ":var0", ":var1"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [
      (eq, "$freelancer_state", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (ge, ":var0", 0),
      (agent_is_active, ":var0"),
      (store_trigger_param_1, ":var1"),
      (eq, ":var0", ":var1"),
      (agent_get_team, ":var2", ":var0"),
      (team_set_order_listener, ":var2", -1),
      (val_add, ":var2", 2),
      (agent_set_team, ":var0", ":var2"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$g_decap_enabled", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (agent_is_non_player, ":var0"),
      (agent_get_troop_id, ":var3", ":var0"),
      (neg|troop_is_hero, ":var3"),
      (assign, ":var4", reg0),
      (copy_position, 5, 0),
      (neq, ":var0", -1),
      (try_begin),
        (agent_is_human, ":var0"),
        (ge, ":var4", 0),
        (assign, ":var5", 0),
        (try_begin),
          (this_or_next|eq, ":var4", "itm_supercrossbow"),
          (eq, ":var4", "itm_supersledge"),
          (assign, ":var5", 1),
        (else_try),
          (neq, ":var4", "itm_mace_1"),
          (neq, ":var4", "itm_mace_2"),
          (neq, ":var4", "itm_mace_3"),
          (neq, ":var4", "itm_staff"),
          (agent_get_action_dir, ":var6", ":var1"),
          (this_or_next|eq, ":var6", 1),
          (eq, ":var6", 2),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var5", 0),
        (try_begin),
          (ge, ":var2", "$g_decap_minimum_damage"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap minimum DMG req bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (store_agent_hit_points, ":var7", ":var0", 1),
        (val_add, ":var7", "$g_decap_negative_health"),
        (ge, ":var2", ":var7"),
        (agent_get_position, pos4, ":var0"),
        (get_distance_between_positions, ":var8", pos4, pos5),
        (agent_get_horse, ":var9", ":var0"),
        (try_begin),
          (ge, ":var9", 0),
          (assign, ":var10", 240),
          (assign, ":var11", 260),
        (else_try),
          (assign, ":var10", 160),
          (assign, ":var11", 176),
        (try_end),
        (is_between, ":var8", ":var10", ":var11"),
        (assign, ":var5", 0),
        (try_begin),
          (store_random_in_range, ":var12", 0, 100),
          (le, ":var12", "$g_decap_chance"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap chance calc bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var13", "itm_cut_off_head_male"),
        (agent_get_troop_id, ":var14", ":var0"),
        (try_begin),
          (ge, ":var14", 0),
          (troop_get_type, ":var15", ":var14"),
          (eq, ":var15", 1),
          (assign, ":var13", "itm_cut_off_head_female"),
        (try_end),
        (store_random_in_range, ":var16", 0, 360),
        (store_random_in_range, ":var17", -60, 60),
        (store_random_in_range, ":var18", -90, 90),
        (store_random_in_range, ":var19", -90, 90),
        (position_rotate_z, pos4, ":var16"),
        (position_rotate_y, pos4, ":var17"),
        (position_move_x, 4, ":var18"),
        (position_move_y, pos4, ":var19"),
        (position_set_z_to_ground_level, pos4),
        (position_move_z, pos4, 5),
        (set_spawn_position, pos4),
        (assign, ":var20", 360),
        (agent_get_item_slot, ":var21", ":var0", 4),
        (try_begin),
          (ge, ":var21", 1),
          (agent_unequip_item, ":var0", ":var21"),
          (try_begin),
            (spawn_item, ":var21", 0, ":var20"),
          (try_end),
        (try_end),
        (agent_equip_item, ":var0", "itm_invisible_head"),
        (agent_get_position, pos4, ":var0"),
        (position_move_z, pos4, ":var10"),
        (particle_system_burst, "psys_blood_decapitation", pos4, "$g_decap_psys_blood_decapitation"),
        (particle_system_burst, "psys_game_blood", pos4, "$g_decap_psys_game_blood"),
        (particle_system_burst, "psys_game_blood_2", pos4, "$g_decap_psys_game_blood_2"),
        (play_sound_at_position, "snd_decapitation", pos4),
        (position_move_z, pos4, 20),
        (set_spawn_position, pos4),
        (assign, ":var13", "spr_head_dynamic_male"),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var13", "spr_head_dynamic_female"),
        (try_end),
        (spawn_scene_prop, ":var13"),
        (agent_get_troop_id, ":var22", ":var1"),
        (str_store_troop_name, s0, ":var22"),
        (agent_get_troop_id, ":var14", ":var0"),
        (str_store_troop_name, s1, ":var14"),
        (get_player_agent_no, ":var23"),
        (agent_get_team, ":var24", ":var23"),
        (agent_get_team, ":var25", ":var0"),
        (try_begin),
          (neq, ":var24", ":var25"),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFF33DD11),
        (else_try),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFFFF4422),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_bully_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_fat_peasant_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_thug_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_fatseveredarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_thin_looter_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (0, 0, 1, 
    [
      (key_clicked, key_right_control),
    ],
    [
      (try_begin),
        (key_is_down, key_m),
        (try_begin),
          (eq, "$g_decapitations_debugging", 0),
          (assign, "$g_decapitations_debugging", 1),
          (display_message, "@Decapitation debug mode Enabled"),
        (else_try),
          (assign, "$g_decapitations_debugging", 0),
          (display_message, "@Decapitation debug mode Disabled"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, key_k),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos17, ":var0"),
        (position_move_y, pos17, 2000),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_bully_handless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_thug_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_thin_looter_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_fat_peasant_handless"),
        (agent_set_team, reg0, 2),
      (try_end),
      (try_begin),
        (key_is_down, key_j),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos18, ":var0"),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supersledge"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supercrossbow"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_super_bolts"),
      (try_end),
    ]),

  ]),

  ("castle_visit", 0, -1,
  "Castle visit",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, [itm_priest_robe_1,itm_priest_cap_1,itm_shoes,itm_sword_type_xii,itm_talak_buckler,itm_throwing_daggers]),
    (1, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_priest_robe_1,itm_priest_cap_1,itm_shoes,itm_sword_type_xii,itm_talak_buckler,itm_throwing_daggers]),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_priest_robe_1,itm_priest_cap_1,itm_shoes,itm_sword_type_xii,itm_talak_buckler,itm_throwing_daggers]),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_priest_robe_1,itm_priest_cap_1,itm_shoes,itm_sword_type_xii,itm_talak_buckler,itm_throwing_daggers]),
    (4, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_priest_robe_1,itm_priest_cap_1,itm_shoes,itm_sword_type_xii,itm_talak_buckler,itm_throwing_daggers]),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, [itm_priest_robe_1,itm_priest_cap_1,itm_shoes,itm_sword_type_xii,itm_talak_buckler,itm_throwing_daggers]),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, [itm_priest_robe_1,itm_priest_cap_1,itm_shoes,itm_sword_type_xii,itm_talak_buckler,itm_throwing_daggers]),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, [itm_priest_robe_1,itm_priest_cap_1,itm_shoes,itm_sword_type_xii,itm_talak_buckler,itm_throwing_daggers]),
    (8, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (14, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (15, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (16, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (34, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (35, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (36, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (37, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (38, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (39, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (40, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (41, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (42, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (43, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (44, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (45, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (46, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$tom_sand_storm", 0),
      (call_script, "script_change_rain_or_snow"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_init_town_agent", ":var0"),
      (get_player_agent_no, ":var1"),
      (try_begin),
        (neq, ":var1", ":var0"),
        (agent_set_team, ":var0", 7),
      (try_end),
      (try_begin),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 18),
        (agent_get_troop_id, ":var2", ":var0"),
        (troop_get_slot, ":var3", ":var2", 155),
        (eq, ":var3", 1),
        (get_player_agent_no, ":var1"),
        (agent_get_team, ":var4", ":var1"),
        (agent_set_team, ":var0", ":var4"),
        (agent_ai_set_aggressiveness, ":var0", 5),
        (troop_set_slot, ":var2", 155, 0),
        (try_begin),
          (troop_slot_eq, ":var2", 149, 3),
          (agent_get_position, pos1, ":var0"),
          (agent_set_scripted_destination, ":var0", pos1),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (try_begin),
        (agent_get_entry_no, ":var4", ":var0"),
        (eq, ":var4", 24),
        (display_message, "@You got keys of dungeon."),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (this_or_next|eq, "$talk_context", 18),
      (eq, "$talk_context", 19),
    ],
    [
      (call_script, "script_neutral_behavior_in_fight"),
      (mission_disable_talk),
    ]),

    (1, 0, ti_once, 
    [
      (eq, "$talk_context", 19),
    ],
    [
      (get_player_agent_no, ":var0"),
      (assign, reg6, ":var0"),
      (call_script, "script_activate_town_guard"),
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos4, ":var0"),
      (try_for_range, ":var1", "trp_npc1", "trp_heroes_end"),
        (troop_slot_ge, ":var1", 149, 1),
        (str_store_troop_name, s4, ":var1"),
        (display_message, "str_s4_joins_prison_break"),
        (store_current_scene, ":var2"),
        (modify_visitors_at_site, ":var2"),
        (store_current_scene, ":var2"),
        (modify_visitors_at_site, ":var2"),
        (assign, ":var3", 24),
        (add_visitors_to_current_scene, ":var3", ":var1", 1, 0, 0),
        (troop_set_slot, ":var1", 155, 1),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 18),
        (display_message, "str_cannot_leave_now"),
      (else_try),
        (this_or_next|eq, "$g_mt_mode", 0),
        (eq, "$g_mt_mode", 1),
        (set_trigger_result, 1),
        (mission_enable_talk),
      (else_try),
        (display_message, "str_cannot_leave_now"),
      (try_end),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_remove_siege_objects"),
    ]),

    (3, 0, 0, 
    [
      (main_hero_fallen, 0),
    ],
    [
      (try_begin),
        (this_or_next|eq, "$talk_context", 18),
        (eq, "$talk_context", 19),
        (call_script, "script_deduct_casualties_from_garrison"),
        (jump_to_menu, "mnu_captivity_start_castle_defeat"),
        (assign, ":var0", "trp_heroes_end"),
        (try_for_range, ":var1", "trp_npc1", ":var0"),
          (troop_set_slot, ":var1", 149, 0),
        (try_end),
        (mission_enable_talk),
        (finish_mission, 0),
      (else_try),
        (mission_enable_talk),
        (finish_mission, 0),
        (set_trigger_result, 1),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (eq, "$talk_context", 19),
      (neg|main_hero_fallen, 0),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 10),
      (all_enemies_defeated),
    ],
    [
      (call_script, "script_deduct_casualties_from_garrison"),
      (try_for_agents, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (troop_slot_ge, ":var1", 149, 2),
        (try_begin),
          (agent_is_alive, ":var0"),
          (troop_set_slot, ":var1", 149, 4),
        (else_try),
          (troop_set_slot, ":var1", 149, 5),
        (try_end),
      (try_end),
      (jump_to_menu, "mnu_sneak_into_town_caught_ran_away"),
      (mission_enable_talk),
      (finish_mission, 0),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (is_presentation_active, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

    (ti_after_mission_start, 0, ti_once, 
    [
      (neq, "$g_mt_mode", 1),
    ],
    [
      (store_skill_level, ":var0", 1, "trp_player"),
      (troop_get_slot, ":var1", "trp_player", 7),
      (val_div, ":var0", 3),
      (val_div, ":var1", 400),
      (store_add, ":var2", ":var1", ":var0"),
      (val_min, ":var2", 4),
      (ge, ":var2", 1),
      (get_player_agent_no, ":var3"),
      (agent_get_team, ":var4", ":var3"),
      (agent_get_horse, ":var5", ":var3"),
      (assign, ":var6", 0),
      (assign, ":var7", 0),
      (try_begin),
        (party_slot_eq, "$current_town", 0, 4),
        (assign, ":var6", 11),
        (assign, ":var7", "mt_village_center"),
      (else_try),
        (this_or_next|eq, "$talk_context", 18),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 0),
        (assign, ":var6", 24),
        (try_begin),
          (party_slot_eq, "$current_town", 0, 2),
          (assign, ":var7", "mt_castle_visit"),
        (else_try),
          (assign, ":var7", "mt_town_center"),
        (try_end),
      (else_try),
        (eq, "$talk_context", 14),
        (assign, ":var6", 17),
      (try_end),
      (try_begin),
        (neq, "$talk_context", 14),
        (gt, ":var5", 0),
        (mission_tpl_entry_set_override_flags, ":var7", ":var6", 0),
      (try_end),
      (store_current_scene, ":var8"),
      (modify_visitors_at_site, ":var8"),
      (assign, ":var9", 0),
      (party_get_num_companion_stacks, ":var10", "p_main_party"),
      (try_for_range, ":var11", 0, ":var10"),
        (party_stack_get_troop_id, ":var12", "p_main_party", ":var11"),
        (neq, ":var12", "trp_player"),
        (troop_is_hero, ":var12"),
        (neg|troop_is_wounded, ":var12"),
        (val_add, ":var9", 1),
        (try_begin),
          (this_or_next|eq, "$talk_context", 19),
          (eq, "$talk_context", 18),
          (troop_set_slot, ":var12", 155, 1),
        (try_end),
        (add_visitors_to_current_scene, ":var6", ":var12", 1),
        (eq, ":var9", ":var2"),
        (assign, ":var10", 0),
      (try_end),
      (gt, ":var9", 0),
      (set_show_messages, 0),
      (team_give_order, ":var4", 8, 1),
      (set_show_messages, 1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (troop_is_hero, ":var1"),
      (main_party_has_troop, ":var1"),
      (get_player_agent_no, ":var2"),
      (agent_get_team, ":var3", ":var2"),
      (agent_get_position, pos1, ":var2"),
      (agent_set_team, ":var0", ":var3"),
      (agent_set_division, ":var0", 8),
      (agent_add_relation_with_agent, ":var0", ":var2", 1),
      (agent_set_is_alarmed, ":var0", 1),
      (store_random_in_range, ":var4", 1, 3),
      (val_mul, ":var4", 100),
      (position_move_y, pos1, ":var4"),
      (store_random_in_range, ":var4", 1, 3),
      (store_random_in_range, ":var5", 0, 2),
      (val_mul, ":var5", -1),
      (try_begin),
        (neq, ":var5", 0),
        (val_mul, ":var4", ":var5"),
      (try_end),
      (position_move_x, 1, ":var4"),
      (agent_set_position, ":var0", pos1),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (neq, ":var1", "trp_player"),
      (troop_is_hero, ":var1"),
      (main_party_has_troop, ":var1"),
      (party_wound_members, "p_main_party", ":var1", 1),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, ":var0", 1),
      (try_begin),
        (party_slot_eq, "$current_town", 7, "trp_player"),
        (assign, ":var0", 0),
      (try_end),
      (try_begin),
        (check_quest_active, "qst_bounty_1"),
        (quest_slot_eq, "qst_bounty_1", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_2"),
        (quest_slot_eq, "qst_bounty_2", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_3"),
        (quest_slot_eq, "qst_bounty_3", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_4"),
        (quest_slot_eq, "qst_bounty_4", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_5"),
        (quest_slot_eq, "qst_bounty_5", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_6"),
        (quest_slot_eq, "qst_bounty_6", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_hunt_down_fugitive"),
        (quest_slot_eq, "qst_hunt_down_fugitive", 1, "$current_town"),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (get_player_agent_no, ":var1"),
      (agent_set_team, ":var1", 0),
      (team_set_relation, 0, 1, 1),
      (team_set_relation, 0, 2, -1),
      (team_set_relation, 1, 2, 0),
      (try_for_agents, ":var2"),
        (neq, ":var2", ":var1"),
        (agent_set_team, ":var2", 1),
      (try_end),
      (assign, "$town_residents_enraged", 0),
      (assign, "$town_residents_condone_chance", 0),
      (assign, "$town_residents_condoned", 0),
      (assign, "$troop_restore_offset", 1),
    ]),

    (0, 0, 0, 
    [],
    [
      (assign, ":var0", 1),
      (try_begin),
        (party_slot_eq, "$current_town", 7, "trp_player"),
        (assign, ":var0", 0),
      (try_end),
      (try_begin),
        (check_quest_active, "qst_bounty_1"),
        (quest_slot_eq, "qst_bounty_1", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_2"),
        (quest_slot_eq, "qst_bounty_2", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_3"),
        (quest_slot_eq, "qst_bounty_3", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_4"),
        (quest_slot_eq, "qst_bounty_4", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_5"),
        (quest_slot_eq, "qst_bounty_5", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_6"),
        (quest_slot_eq, "qst_bounty_6", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_hunt_down_fugitive"),
        (quest_slot_eq, "qst_hunt_down_fugitive", 1, "$current_town"),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (get_player_agent_no, ":var1"),
      (agent_is_alive, ":var1"),
      (agent_get_position, pos1, ":var1"),
      (agent_get_attack_action, ":var2", ":var1"),
      (agent_get_defend_action, ":var3", ":var1"),
      (try_begin),
        (eq, ":var2", 2),
        (try_for_agents, ":var4"),
          (agent_is_human, ":var4"),
          (agent_is_alive, ":var4"),
          (neq, ":var4", ":var1"),
          (agent_get_position, pos2, ":var4"),
          (agent_get_team, ":var5", ":var4"),
          (eq, ":var5", 1),
          (try_begin),
            (position_is_behind_position, pos2, pos1),
          (else_try),
            (get_distance_between_positions, ":var6", pos1, pos2),
            (lt, ":var6", 100),
            (agent_force_rethink, ":var4"),
            (agent_ai_set_aggressiveness, ":var4", 199),
            (agent_set_team, ":var4", 2),
          (try_end),
        (try_end),
      (else_try),
        (eq, "$town_residents_enraged", 0),
        (this_or_next|eq, ":var3", 2),
        (eq, ":var3", 1),
        (try_begin),
          (ge, "$town_residents_condone_chance", 500),
          (val_sub, "$town_residents_condone_chance", 1),
          (val_add, "$town_residents_condoned", 1),
        (try_end),
        (lt, "$town_residents_condone_chance", 500),
        (try_for_agents, ":var4"),
          (agent_is_human, ":var4"),
          (agent_is_alive, ":var4"),
          (neq, ":var4", ":var1"),
          (agent_get_team, ":var5", ":var4"),
          (eq, ":var5", 2),
          (agent_add_relation_with_agent, ":var1", ":var4", 1),
          (agent_force_rethink, ":var4"),
          (agent_ai_set_aggressiveness, ":var4", 0),
          (agent_set_team, ":var4", 1),
        (try_end),
      (else_try),
        (eq, "$town_residents_enraged", 0),
        (this_or_next|gt, "$town_residents_condoned", 1500),
        (ge, "$town_residents_condone_chance", 2000),
        (try_for_agents, ":var4"),
          (agent_is_human, ":var4"),
          (agent_is_alive, ":var4"),
          (neq, ":var4", ":var1"),
          (agent_force_rethink, ":var4"),
          (agent_ai_set_aggressiveness, ":var4", 199),
          (agent_set_team, ":var4", 2),
        (try_end),
        (assign, "$town_residents_enraged", 1),
        (assign, "$town_residents_condoned", 0),
        (display_message, "str_saldiri_2"),
      (else_try),
        (eq, "$town_residents_enraged", 1),
        (agent_get_wielded_item, ":var7", ":var1", 0),
        (neq, ":var7", -1),
        (try_for_agents, ":var4"),
          (agent_is_human, ":var4"),
          (agent_is_alive, ":var4"),
          (neq, ":var4", ":var1"),
          (agent_get_troop_id, ":var8", ":var4"),
          (agent_get_wielded_item, ":var7", ":var4", 0),
          (try_begin),
            (neq, ":var7", -1),
            (agent_clear_scripted_mode, ":var4"),
          (try_end),
          (neg|is_between, ":var8", "trp_farmer", "trp_town_walker_1"),
          (agent_ai_set_aggressiveness, ":var4", 0),
          (agent_set_speed_limit, ":var4", 10),
          (party_get_slot, ":var9", "$current_town", 10),
          (party_get_slot, ":var10", "$current_town", 13),
          (store_current_scene, ":var11"),
          (try_begin),
            (eq, ":var11", ":var9"),
            (entry_point_get_position, pos3, 2),
          (else_try),
            (eq, ":var11", ":var10"),
            (entry_point_get_position, pos3, 0),
          (try_end),
          (agent_set_scripted_destination_no_attack, ":var4", pos3, 1),
          (agent_force_rethink, ":var4"),
          (agent_get_position, pos2, ":var4"),
          (get_distance_between_positions, ":var6", pos2, pos3),
          (try_begin),
            (gt, "$town_residents_condoned", 0),
            (agent_set_team, ":var4", 1),
          (try_end),
          (try_begin),
            (le, ":var6", 300),
            (agent_fade_out, ":var4"),
            (val_add, "$town_residents_condoned", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (assign, ":var0", 1),
      (try_begin),
        (party_slot_eq, "$current_town", 7, "trp_player"),
        (assign, ":var0", 0),
      (try_end),
      (try_begin),
        (check_quest_active, "qst_bounty_1"),
        (quest_slot_eq, "qst_bounty_1", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_2"),
        (quest_slot_eq, "qst_bounty_2", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_3"),
        (quest_slot_eq, "qst_bounty_3", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_4"),
        (quest_slot_eq, "qst_bounty_4", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_5"),
        (quest_slot_eq, "qst_bounty_5", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_6"),
        (quest_slot_eq, "qst_bounty_6", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_hunt_down_fugitive"),
        (quest_slot_eq, "qst_hunt_down_fugitive", 1, "$current_town"),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (store_trigger_param_2, ":var1"),
      (get_player_agent_no, ":var2"),
      (agent_is_alive, ":var2"),
      (eq, ":var1", ":var2"),
      (try_for_agents, ":var3"),
        (agent_is_human, ":var3"),
        (agent_is_alive, ":var3"),
        (neq, ":var3", ":var2"),
        (agent_force_rethink, ":var3"),
        (agent_ai_set_aggressiveness, ":var3", 199),
        (agent_set_team, ":var3", 2),
      (try_end),
      (assign, "$town_residents_enraged", 1),
      (party_get_slot, ":var4", "$current_town", 26),
      (val_sub, ":var4", 1),
      (party_set_slot, "$current_town", 26, ":var4"),
      (display_message, "str_saldiri_2"),
      (val_add, "$town_residents_condoned", 1),
      (party_get_slot, ":var5", "$current_town", 7),
      (call_script, "script_change_player_relation_with_troop", ":var5", -1),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [],
    [
      (assign, ":var0", 1),
      (try_begin),
        (party_slot_eq, "$current_town", 7, "trp_player"),
        (assign, ":var0", 0),
      (try_end),
      (try_begin),
        (check_quest_active, "qst_bounty_1"),
        (quest_slot_eq, "qst_bounty_1", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_2"),
        (quest_slot_eq, "qst_bounty_2", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_3"),
        (quest_slot_eq, "qst_bounty_3", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_4"),
        (quest_slot_eq, "qst_bounty_4", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_5"),
        (quest_slot_eq, "qst_bounty_5", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_6"),
        (quest_slot_eq, "qst_bounty_6", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_hunt_down_fugitive"),
        (quest_slot_eq, "qst_hunt_down_fugitive", 1, "$current_town"),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (store_trigger_param_1, ":var1"),
      (store_trigger_param_2, ":var2"),
      (get_player_agent_no, ":var3"),
      (agent_is_alive, ":var3"),
      (eq, ":var2", ":var3"),
      (agent_force_rethink, ":var1"),
      (agent_ai_set_aggressiveness, ":var1", 199),
      (agent_set_team, ":var1", 2),
      (val_add, "$town_residents_condone_chance", 1000),
      (eq, "$town_residents_enraged", 0),
    ]),

    (2, 0, 3, 
    [],
    [
      (assign, ":var0", 1),
      (try_begin),
        (party_slot_eq, "$current_town", 7, "trp_player"),
        (assign, ":var0", 0),
      (try_end),
      (try_begin),
        (check_quest_active, "qst_bounty_1"),
        (quest_slot_eq, "qst_bounty_1", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_2"),
        (quest_slot_eq, "qst_bounty_2", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_3"),
        (quest_slot_eq, "qst_bounty_3", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_4"),
        (quest_slot_eq, "qst_bounty_4", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_5"),
        (quest_slot_eq, "qst_bounty_5", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_bounty_6"),
        (quest_slot_eq, "qst_bounty_6", 1, "$current_town"),
        (assign, ":var0", 0),
      (else_try),
        (check_quest_active, "qst_hunt_down_fugitive"),
        (quest_slot_eq, "qst_hunt_down_fugitive", 1, "$current_town"),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (get_player_agent_no, ":var1"),
      (agent_is_alive, ":var1"),
      (party_get_slot, ":var2", "$current_town", 10),
      (party_get_slot, ":var3", "$current_town", 13),
      (store_current_scene, ":var4"),
      (try_begin),
        (eq, ":var4", ":var2"),
        (entry_point_get_position, pos3, 2),
      (else_try),
        (eq, ":var4", ":var3"),
        (entry_point_get_position, pos3, 0),
      (try_end),
      (try_begin),
        (gt, "$town_residents_condoned", 2),
        (call_script, "script_return_random_troop_from_garrison", 1),
        (assign, ":var5", reg0),
        (gt, ":var5", 0),
        (call_script, "script_remove_troops_from_garrison", ":var5", 1),
        (set_spawn_position, pos3),
        (spawn_agent, ":var5"),
        (agent_set_team, reg0, 2),
        (agent_add_relation_with_agent, ":var1", reg0, -1),
        (agent_ai_set_aggressiveness, reg0, 199),
        (agent_get_position, pos3, ":var1"),
        (agent_set_scripted_destination, reg0, pos3, 1),
        (agent_force_rethink, reg0),
        (val_sub, "$town_residents_condoned", 1),
        (display_message, "str_saldiri_3"),
      (try_end),
    ]),

  ]),

  ("training_ground_trainer_talk", 0, -1,
  "Training.",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (1, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_scene_source, af_override_weapons|af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (0, 1, 2, 
    [
      (lt, "$trainer_help_message", 2),
    ],
    [
      (try_begin),
        (eq, "$trainer_help_message", 0),
      (else_try),
      (try_end),
      (val_add, "$trainer_help_message", 1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("training_ground_trainer_training", mtf_arena_fight, -1,
  "You will fight a match in the arena.",
  [
    (16, mtef_team_0|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_shield,itm_practice_sword,itm_practice_boots]),
    (17, mtef_team_1|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff,itm_practice_boots]),
    (18, mtef_team_2|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_practice_staff,itm_practice_boots]),
    (19, mtef_team_3|mtef_visitor_source, af_override_everything, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_boots]),
    (20, mtef_visitor_source, 0, 0, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_give_up_fight"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (set_jump_mission, "mt_training_ground_trainer_talk"),
      (modify_visitors_at_site, "$g_training_ground_melee_training_scene"),
      (reset_visitors),
      (set_jump_entry, 5),
      (jump_to_scene, "$g_training_ground_melee_training_scene"),
    ]),

    (1, 3, ti_once, 
    [
      (main_hero_fallen, 0),
    ],
    [
      (set_jump_mission, "mt_training_ground_trainer_talk"),
      (modify_visitors_at_site, "$g_training_ground_melee_training_scene"),
      (reset_visitors),
      (set_jump_entry, 5),
      (jump_to_scene, "$g_training_ground_melee_training_scene"),
    ]),

    (1, 3, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 1),
      (num_active_teams_le, 1),
      (neg|main_hero_fallen),
      (assign, "$training_fight_won", 1),
    ],
    [
      (set_jump_mission, "mt_training_ground_trainer_talk"),
      (modify_visitors_at_site, "$g_training_ground_melee_training_scene"),
      (reset_visitors),
      (set_jump_entry, 5),
      (jump_to_scene, "$g_training_ground_melee_training_scene"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_arena"),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("training_ground_training", mtf_arena_fight, -1,
  "Training.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (9, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (10, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (11, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (12, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (13, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (14, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (15, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_last_destroyed_gourds", 0),
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_give_up_fight"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$g_training_ground_training_success_ratio", 0),
      (jump_to_menu, "mnu_training_ground_training_result"),
      (finish_mission),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (try_begin),
        (eq, "$g_mt_mode", 2),
        (set_fixed_point_multiplier, 100),
        (entry_point_get_position, pos1, 0),
        (init_position, pos2),
        (position_set_y, pos2, "$g_training_ground_ranged_distance"),
        (position_transform_position_to_parent, pos3, pos1, pos2),
        (copy_position, 1, 3),
        (assign, ":var0", 10),
        (assign, ":var1", 0),
        (try_for_range, ":var2", 0, ":var0"),
          (store_sub, ":var3", ":var2", ":var1"),
          (scene_prop_get_instance, ":var4", "spr_gourd", ":var3"),
          (copy_position, 2, 1),
          (init_position, pos0),
          (store_random_in_range, ":var5", 0, 360),
          (position_rotate_z, pos2, ":var5"),
          (store_random_in_range, ":var5", 50, 600),
          (position_move_x, 2, ":var5"),
          (store_random_in_range, ":var5", 0, 360),
          (position_transform_position_to_local, pos3, pos1, pos2),
          (position_rotate_z, pos0, ":var5"),
          (position_transform_position_to_parent, pos4, pos0, pos3),
          (position_transform_position_to_parent, pos2, pos1, pos4),
          (position_set_z_to_ground_level, pos2),
          (position_move_z, pos2, 150),
          (assign, ":var6", 1),
          (try_for_range, ":var7", 0, 10),
            (eq, ":var6", 1),
            (neq, ":var3", ":var7"),
            (scene_prop_get_instance, ":var8", "spr_gourd", ":var7"),
            (prop_instance_get_position, pos3, ":var8"),
            (get_distance_between_positions, ":var9", pos2, pos3),
            (lt, ":var9", 100),
            (assign, ":var6", 0),
          (try_end),
          (try_begin),
            (eq, ":var6", 0),
            (val_add, ":var0", 1),
            (val_add, ":var1", 1),
          (else_try),
            (prop_instance_set_position, ":var4", pos2),
            (prop_instance_animate_to_position, ":var4", pos2, 1),
            (scene_prop_get_instance, ":var8", "spr_gourd_spike", ":var3"),
            (position_move_z, pos2, -150),
            (prop_instance_set_position, ":var8", pos2),
            (prop_instance_animate_to_position, ":var8", pos2, 1),
          (try_end),
        (try_end),
      (else_try),
        (eq, "$g_mt_mode", 3),
        (assign, ":var10", 0),
        (try_for_range, ":var2", 0, 100),
          (scene_prop_get_instance, ":var4", "spr_gourd", ":var2"),
          (scene_prop_get_instance, ":var8", "spr_gourd_spike", ":var2"),
          (ge, ":var4", 0),
          (ge, ":var8", 0),
          (val_add, ":var10", 1),
          (prop_instance_get_position, pos0, ":var8"),
          (position_move_z, pos0, 150),
          (prop_instance_set_position, ":var4", pos0),
          (prop_instance_animate_to_position, ":var4", pos0, 1),
        (try_end),
        (store_sub, ":var0", ":var10", "$g_training_ground_training_num_gourds_to_destroy"),
        (try_for_range, ":var2", 0, ":var0"),
          (store_random_in_range, ":var11", 0, ":var10"),
          (scene_prop_get_instance, ":var4", "spr_gourd", ":var11"),
          (prop_instance_get_position, pos0, ":var4"),
          (position_get_z, ":var12", pos0),
          (try_begin),
            (lt, ":var12", -50000),
          (else_try),
            (position_set_z, pos0, -100000),
            (prop_instance_set_position, ":var4", pos0),
            (prop_instance_animate_to_position, ":var4", pos0, 1),
            (scene_prop_get_instance, ":var8", "spr_gourd_spike", ":var11"),
            (prop_instance_set_position, ":var8", pos0),
            (prop_instance_animate_to_position, ":var8", pos0, 1),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (1, 3, ti_once, 
    [
      (eq, "$g_mt_mode", 1),
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (neg|main_hero_fallen),
        (assign, "$g_training_ground_training_success_ratio", 100),
      (else_try),
        (assign, ":var0", 0),
        (try_for_agents, ":var1"),
          (agent_is_alive, ":var1"),
          (agent_is_human, ":var1"),
          (agent_get_team, ":var2", ":var1"),
          (eq, ":var2", 1),
          (val_add, ":var0", 1),
        (try_end),
        (store_sub, ":var3", "$g_training_ground_training_num_enemies", ":var0"),
        (store_mul, "$g_training_ground_training_success_ratio", ":var3", 100),
        (val_div, "$g_training_ground_training_success_ratio", "$g_training_ground_training_num_enemies"),
      (try_end),
      (jump_to_menu, "mnu_training_ground_training_result"),
      (finish_mission),
    ]),

    (1, 3, ti_once, 
    [
      (eq, "$g_mt_mode", 2),
      (get_player_agent_no, ":var0"),
      (agent_get_ammo, ":var1", ":var0"),
      (store_mission_timer_a, ":var2"),
      (this_or_next|main_hero_fallen),
      (this_or_next|eq, ":var1", 0),
      (gt, ":var2", 116),
    ],
    [
      (store_mul, "$g_training_ground_training_success_ratio", "$scene_num_total_gourds_destroyed", 10),
      (jump_to_menu, "mnu_training_ground_training_result"),
      (finish_mission),
    ]),

    (1, 3, ti_once, 
    [
      (eq, "$g_mt_mode", 3),
      (get_player_agent_no, ":var0"),
      (agent_get_horse, ":var1", ":var0"),
      (store_mission_timer_a, ":var2"),
      (this_or_next|lt, ":var1", 0),
      (this_or_next|main_hero_fallen),
      (this_or_next|ge, "$scene_num_total_gourds_destroyed", "$g_training_ground_training_num_gourds_to_destroy"),
      (gt, ":var2", 120),
    ],
    [
      (store_mul, "$g_training_ground_training_success_ratio", "$scene_num_total_gourds_destroyed", 100),
      (val_div, "$g_training_ground_training_success_ratio", "$g_training_ground_training_num_gourds_to_destroy"),
      (jump_to_menu, "mnu_training_ground_training_result"),
      (finish_mission),
    ]),

    (0, 0, 0, 
    [
      (gt, "$g_last_destroyed_gourds", 0),
      (try_begin),
        (eq, "$g_mt_mode", 2),
        (entry_point_get_position, pos1, 0),
        (position_move_y, pos1, 100, 0),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos2, ":var0"),
        (try_begin),
          (position_is_behind_position, pos2, pos1),
          (val_add, "$scene_num_total_gourds_destroyed", "$g_last_destroyed_gourds"),
        (else_try),
          (display_message, "@You must stay behind the line on the ground! Point is not counted."),
        (try_end),
      (else_try),
        (val_add, "$scene_num_total_gourds_destroyed", "$g_last_destroyed_gourds"),
      (try_end),
      (assign, "$g_last_destroyed_gourds", 0),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("sneak_caught_fight", mtf_battle_mode, -1,
  "You must fight your way out!",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_all, aif_start_alarmed, 1, [itm_priest_robe_1,itm_priest_cap_1,itm_shoes,itm_sword_type_xii,itm_talak_buckler,itm_throwing_daggers]),
    (1, mtef_team_0|mtef_scene_source, af_override_all, aif_start_alarmed, 1, [itm_priest_robe_1,itm_priest_cap_1,itm_shoes,itm_sword_type_xii,itm_talak_buckler,itm_throwing_daggers]),
    (2, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (3, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (5, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (6, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (7, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (8, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (9, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (10, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (11, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (12, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (13, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (14, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (15, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (16, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (17, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (18, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (19, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (20, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (21, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (22, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (23, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (24, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (25, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (26, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (27, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (28, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (29, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (30, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (31, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (33, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (34, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (35, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (36, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (37, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (38, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (39, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (40, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (64, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (assign, ":var0", 5),
      (try_begin),
        (party_get_slot, ":var1", "$current_town", 240),
        (store_current_hours, ":var2"),
        (store_add, ":var3", ":var1", 4),
        (is_between, ":var2", ":var3", ":var1"),
        (assign, ":var0", 2),
      (else_try),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 18),
        (assign, ":var0", 4),
      (try_end),
      (try_begin),
        (this_or_next|eq, "$talk_context", 19),
        (eq, "$talk_context", 18),
        (entry_point_get_position, pos0, 7),
      (else_try),
        (party_slot_eq, "$current_town", 0, 3),
        (entry_point_get_position, pos0, 0),
      (else_try),
        (entry_point_get_position, pos0, 1),
      (try_end),
      (assign, ":var4", -1),
      (assign, ":var5", -1),
      (try_for_range, ":var6", 0, ":var0"),
        (assign, ":var7", 100000),
        (try_for_range, ":var8", 2, 64),
          (neq, ":var5", ":var8"),
          (entry_point_get_position, pos1, ":var8"),
          (get_distance_between_positions, ":var9", pos0, pos1),
          (lt, ":var9", ":var7"),
          (gt, ":var9", ":var4"),
          (assign, ":var7", ":var9"),
          (assign, ":var10", ":var8"),
        (try_end),
        (store_faction_of_party, ":var11", "$current_town"),
        (try_begin),
          (this_or_next|eq, ":var6", 0),
          (eq, ":var6", 2),
          (faction_get_slot, ":var12", ":var11", 42),
        (else_try),
          (faction_get_slot, ":var12", ":var11", 42),
        (try_end),
        (assign, ":var5", ":var10"),
        (assign, ":var4", ":var7"),
        (add_visitors_to_current_scene, ":var10", ":var12", 1, 0),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (question_box, "str_do_you_wish_to_surrender"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (jump_to_menu, "mnu_captivity_start_castle_defeat"),
      (finish_mission, 0),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (play_sound, "snd_sneak_town_halt"),
      (call_script, "script_music_set_situation_with_culture", 1024),
    ]),

    (0, 3, 0, 
    [
      (main_hero_fallen, 0),
    ],
    [
      (jump_to_menu, "mnu_captivity_start_castle_defeat"),
      (finish_mission, 0),
    ]),

    (1, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (eq, ":var2", 1),
        (agent_get_position, pos1, ":var1"),
        (get_distance_between_positions, ":var3", pos0, pos1),
        (try_begin),
          (le, ":var3", 800),
          (agent_clear_scripted_mode, ":var1"),
        (else_try),
          (agent_set_scripted_destination, ":var1", pos0, 0),
        (try_end),
      (try_end),
    ]),

    (5, 1, ti_once, 
    [
      (num_active_teams_le, 1),
      (neg|main_hero_fallen),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (assign, "$auto_menu", -1),
      (jump_to_menu, "mnu_sneak_into_town_caught_dispersed_guards"),
      (finish_mission, 1),
    ]),

    (ti_on_leave_area, 0, ti_once, 
    [],
    [
      (assign, "$auto_menu", -1),
      (jump_to_menu, "mnu_sneak_into_town_caught_ran_away"),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_arena"),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("ai_training", 0, -1,
  "You start training.",
  [
    (0, 0, 0, aif_start_alarmed, 30, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (finish_mission, 0),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (is_presentation_active, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("camera_test", 0, -1,
  "camera Test.",
  [
  ],
  [
    (1, 0, 0, 
    [
      (mission_cam_set_mode, 1),
      (entry_point_get_position, pos3, 3),
      (mission_cam_set_position, pos3),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (finish_mission, 0),
    ]),

  ]),

  ("arena_melee_fight", mtf_arena_fight, -1,
  "You enter a melee fight in the arena.",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_horse]),
    (1, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword]),
    (2, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_horse]),
    (3, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse]),
    (4, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_dagger]),
    (5, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield]),
    (6, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_horse]),
    (7, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse]),
    (8, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_dagger]),
    (9, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse]),
    (10, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword]),
    (11, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield]),
    (12, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_horse]),
    (13, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse]),
    (14, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword]),
    (15, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield]),
    (16, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_horse]),
    (17, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword]),
    (18, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_horse]),
    (19, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse]),
    (20, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_dagger]),
    (21, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield]),
    (22, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_horse]),
    (23, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_horse]),
    (25, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword]),
    (26, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_horse]),
    (27, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse]),
    (28, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_dagger]),
    (29, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield]),
    (30, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword,itm_practice_horse]),
    (31, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield,itm_practice_horse]),
    (32, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword]),
    (33, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_staff]),
    (34, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield]),
    (35, mtef_team_4|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_staff]),
    (36, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_dagger]),
    (37, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield]),
    (38, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword]),
    (39, mtef_team_4|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_staff]),
    (24, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_saddle_horse]),
    (24, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_lance,itm_practice_shield,itm_saddle_horse]),
    (24, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword]),
    (24, mtef_team_2|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_lance,itm_practice_shield]),
    (24, mtef_team_3|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_dagger]),
    (24, mtef_team_4|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield]),
    (24, mtef_team_4|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_heavy_practice_sword]),
    (24, mtef_team_4|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_axe,itm_practice_shield]),
    (24, mtef_team_4|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_javelin,itm_practice_shield]),
    (24, mtef_team_4|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows,itm_practice_dagger]),
    (50, mtef_scene_source, af_override_weapons|af_override_horse|af_override_head, 0, 1, []),
    (51, mtef_team_4|mtef_visitor_source, af_override_horse, 0, 1, []),
    (52, mtef_visitor_source, af_override_horse, 0, 1, []),
    (53, mtef_scene_source, af_override_horse, 0, 1, []),
    (54, mtef_scene_source, af_override_horse, 0, 1, []),
    (55, mtef_scene_source, af_override_horse, 0, 1, []),
    (56, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield,itm_padded_cloth,itm_footman_helmet]),
    (57, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_practice_sword,itm_practice_shield,itm_padded_cloth,itm_footman_helmet]),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (assign, "$g_arena_training_num_agents_spawned", 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_arena"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_mt_mode", 2),
        (set_trigger_result, 1),
      (else_try),
        (question_box, "str_give_up_fight"),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (try_begin),
        (eq, "$g_mt_mode", 3),
        (call_script, "script_end_tournament_fight_new", 0),
      (else_try),
        (eq, "$g_mt_mode", 1),
        (get_player_agent_no, ":var1"),
        (agent_get_kill_count, "$g_arena_training_kills", ":var1", 1),
      (try_end),
      (finish_mission, 0),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (eq, "$g_mt_mode", 2),
      (call_script, "script_music_set_situation_with_culture", 65536),
      (store_current_scene, reg1),
      (scene_set_slot, reg1, 0, 1),
      (mission_enable_talk),
      (get_player_agent_no, ":var0"),
      (assign, ":var1", 0),
      (try_for_agents, ":var2"),
        (neq, ":var2", ":var0"),
        (agent_get_troop_id, ":var3", ":var2"),
        (is_between, ":var3", "trp_novice_fighter", "trp_tournament_master"),
        (eq, ":var1", 0),
        (agent_set_team, ":var2", 1),
        (assign, ":var1", 1),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (eq, "$g_mt_mode", 3),
      (play_sound, "snd_arena_ambiance", 2),
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (1, 4, ti_once, 
    [
      (eq, "$g_mt_mode", 3),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (get_player_agent_no, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (assign, ":var2", 0),
        (try_for_agents, ":var3"),
          (agent_is_alive, ":var3"),
          (agent_is_human, ":var3"),
          (agent_get_team, ":var4", ":var3"),
          (eq, ":var4", ":var1"),
          (assign, ":var2", 1),
        (try_end),
        (eq, ":var2", 1),
        (stop_all_sounds, 0),
        (call_script, "script_end_tournament_fight_new", 1),
        (call_script, "script_play_victorious_sound"),
        (finish_mission),
      (else_try),
        (stop_all_sounds, 0),
        (call_script, "script_end_tournament_fight_new", 0),
        (finish_mission),
      (try_end),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (eq, "$g_mt_mode", 1),
      (start_presentation, "prsnt_arena_training"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (eq, "$g_mt_mode", 1),
      (assign, "$g_arena_training_max_opponents", 50),
      (assign, "$g_arena_training_num_agents_spawned", 0),
      (assign, "$g_arena_training_kills", 0),
      (assign, "$g_arena_training_won", 0),
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (1, 4, ti_once, 
    [
      (eq, "$g_mt_mode", 1),
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 3),
      (assign, ":var1", 0),
      (try_begin),
        (ge, "$g_arena_training_num_agents_spawned", "$g_arena_training_max_opponents"),
        (num_active_teams_le, 1),
        (assign, ":var1", 1),
      (try_end),
      (this_or_next|eq, ":var1", 1),
      (main_hero_fallen),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_kill_count, "$g_arena_training_kills", ":var0", 1),
      (assign, "$g_arena_training_won", 0),
      (try_begin),
        (neg|main_hero_fallen),
        (assign, "$g_arena_training_won", 1),
      (try_end),
      (assign, "$g_mt_mode", 2),
      (set_jump_mission, "mt_arena_melee_fight"),
      (party_get_slot, ":var1", "$current_town", 16),
      (modify_visitors_at_site, ":var1"),
      (reset_visitors),
      (party_get_slot, ":var2", "$current_town", 277),
      (set_visitor, 52, ":var2"),
      (set_jump_entry, 50),
      (jump_to_scene, ":var1"),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_mt_mode", 1),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (agent_is_human, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (is_between, ":var2", 0, 7),
        (val_add, ":var0", 1),
      (try_end),
      (lt, ":var0", 20),
      (neg|main_hero_fallen),
      (store_mission_timer_a, ":var3"),
      (this_or_next|ge, ":var3", "$g_arena_training_next_spawn_time"),
      (this_or_next|lt, "$g_arena_training_num_agents_spawned", 50),
      (num_active_teams_le, 1),
      (lt, "$g_arena_training_num_agents_spawned", "$g_arena_training_max_opponents"),
    ],
    [
      (assign, ":var0", "$g_arena_training_num_agents_spawned"),
      (store_div, ":var0", "$g_arena_training_num_agents_spawned", 6),
      (assign, ":var1", "$g_arena_training_num_agents_spawned"),
      (val_mod, ":var1", 1),
      (val_add, ":var0", ":var1"),
      (val_min, ":var0", 9),
      (val_add, ":var0", "trp_arena_training_fighter_1"),
      (assign, ":var2", 10000),
      (get_player_agent_no, ":var3"),
      (agent_get_position, pos5, ":var3"),
      (try_for_range, ":var4", 0, ":var2"),
        (store_random_in_range, ":var5", 0, 39),
        (neq, ":var5", "$g_player_entry_point"),
        (entry_point_get_position, pos1, ":var5"),
        (get_distance_between_positions, ":var6", pos5, pos1),
        (gt, ":var6", 1200),
        (assign, ":var2", 0),
      (try_end),
      (add_visitors_to_current_scene, ":var5", ":var0", 1),
      (store_add, ":var7", "$g_arena_training_num_agents_spawned", 1),
      (store_mission_timer_a, ":var8"),
      (store_add, "$g_arena_training_next_spawn_time", ":var8", 2),
      (store_div, ":var9", ":var7", 4),
      (val_sub, "$g_arena_training_next_spawn_time", ":var9"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_mt_mode", 1),
    ],
    [
      (assign, ":var0", 6),
      (val_max, ":var0", 1),
      (get_player_agent_no, ":var1"),
      (try_for_agents, ":var2"),
        (agent_is_human, ":var2"),
        (agent_is_alive, ":var2"),
        (agent_slot_eq, ":var2", 7, 0),
        (agent_get_team, ":var3", ":var2"),
        (is_between, ":var3", 0, 7),
        (try_begin),
          (eq, ":var2", ":var1"),
          (agent_set_team, ":var2", 6),
        (else_try),
          (try_for_range, ":var4", 0, 6),
            (troop_set_slot, "trp_temp_array_a", ":var4", 0),
          (try_end),
          (try_for_agents, ":var5"),
            (agent_is_human, ":var5"),
            (agent_is_alive, ":var5"),
            (neq, ":var2", ":var1"),
            (agent_slot_eq, ":var5", 7, 1),
            (agent_get_team, ":var6", ":var5"),
            (troop_get_slot, ":var7", "trp_temp_array_a", ":var6"),
            (val_add, ":var7", 1),
            (troop_set_slot, "trp_temp_array_a", ":var6", ":var7"),
          (try_end),
          (troop_get_slot, ":var8", "trp_temp_array_a", 0),
          (try_for_range, ":var4", 1, 6),
            (troop_slot_ge, "trp_temp_array_a", ":var4", ":var8"),
            (troop_get_slot, ":var8", "trp_temp_array_a", ":var4"),
          (try_end),
        (try_end),
        (agent_set_slot, ":var2", 7, 1),
        (try_begin),
          (neq, ":var2", ":var1"),
          (val_add, "$g_arena_training_num_agents_spawned", 1),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_hit, 0.3, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (assign, ":var3", reg0),
      (agent_is_human, ":var0"),
      (get_player_agent_no, ":var4"),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var0", ":var4"),
        (store_random_in_range, ":var5", 0, 1000),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 4, 8),
        (troop_get_inventory_slot, ":var7", "trp_player", ":var6"),
        (gt, ":var7", 0),
        (str_store_item_name, s20, ":var7"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var6"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} is too crapy to fall apart!", 0xFF0000),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var7", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var6", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var1", ":var4"),
        (is_between, ":var3", 1, "itm_items_end"),
        (neg|is_between, ":var3", "itm_light_lance", "itm_wooden_shield"),
        (item_get_type, ":var9", ":var3"),
        (ge, ":var2", 10),
        (neq, ":var9", 10),
        (neq, ":var9", 8),
        (neq, ":var9", 9),
        (neq, ":var9", 5),
        (neq, ":var9", 6),
        (store_random_in_range, ":var5", 0, 600),
        (eq, ":var5", 1),
        (assign, ":var10", -1),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var11", "trp_player", ":var6"),
          (eq, ":var11", ":var3"),
          (assign, ":var10", ":var6"),
        (try_end),
        (gt, ":var10", 0),
        (str_store_item_name, s20, ":var3"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var10"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} falls apart!", 0xFF0000),
          (agent_unequip_item, ":var4", ":var3"),
          (troop_remove_item, "trp_player", ":var3"),
          (troop_remove_item, "trp_broken_items", ":var3"),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var3", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var10", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (agent_get_horse, ":var12", ":var1"),
      (try_begin),
        (eq, "$tom_lance_breaking", 1),
        (gt, ":var12", 0),
        (this_or_next|is_between, ":var3", "itm_light_lance", "itm_bamboo_spear"),
        (is_between, ":var3", "itm_crusader_knight_spear_a", "itm_crusader_spear_a"),
        (ge, ":var2", 50),
        (store_random_in_range, ":var13", 0, 100),
        (gt, ":var13", 20),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your lance!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (this_or_next|is_between, ":var3", "itm_bamboo_spear", "itm_staff"),
        (is_between, ":var3", "itm_crusader_spear_a", "itm_mace_6"),
        (le, ":var12", 0),
        (ge, ":var2", 8),
        (store_random_in_range, ":var13", 0, 100),
        (ge, ":var13", 90),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your spear!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
    ]),

    (0.2, 0, ti_once, 
    [],
    [
      (assign, "$spear_in_position", 0),
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 26, 0),
        (agent_set_slot, ":var0", 27, 0),
        (agent_set_slot, ":var0", 28, 0),
        (agent_set_slot, ":var0", 29, 0),
        (agent_set_slot, ":var0", 30, 0),
      (try_end),
    ]),

    (0.5, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 27),
        (agent_get_slot, ":var2", ":var0", 28),
        (agent_get_slot, ":var3", ":var0", 29),
        (agent_get_position, pos1, ":var0"),
        (position_get_x, ":var4", pos1),
        (position_get_y, ":var5", pos1),
        (position_get_z, ":var6", pos1),
        (position_set_x, pos2, ":var1"),
        (position_set_y, pos2, ":var2"),
        (position_set_z, pos2, ":var3"),
        (position_set_x, pos1, ":var4"),
        (position_set_y, pos1, ":var5"),
        (position_set_z, pos1, ":var6"),
        (agent_get_speed, pos5, ":var0"),
        (call_script, "script_vector_length", 5),
        (assign, ":var7", reg0),
        (agent_set_slot, ":var0", 27, ":var4"),
        (agent_set_slot, ":var0", 28, ":var5"),
        (agent_set_slot, ":var0", 29, ":var6"),
        (agent_set_slot, ":var0", 30, ":var7"),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
      (this_or_next|game_key_clicked, gk_attack),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_move_forward),
      (this_or_next|game_key_clicked, gk_move_backward),
      (this_or_next|game_key_clicked, gk_move_left),
      (this_or_next|game_key_clicked, gk_move_right),
      (this_or_next|game_key_clicked, gk_equip_primary_weapon),
      (this_or_next|game_key_clicked, gk_equip_secondary_weapon),
      (this_or_next|game_key_clicked, gk_action),
      (game_key_clicked, gk_sheath_weapon),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (display_message, "@Releasing spear.", 0x6495ED),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
    ]),

    (0.2, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_get_horse, ":var1", ":var0"),
        (le, ":var1", 0),
        (agent_get_slot, ":var2", ":var0", 26),
        (lt, ":var2", 10),
        (val_add, ":var2", 2),
        (agent_set_slot, ":var0", 26, ":var2"),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_set_animation, ":var0", "anim_spearwall_hold"),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (try_for_agents, ":var2"),
        (agent_is_alive, ":var2"),
        (neq, ":var2", ":var0"),
        (agent_is_human, ":var2"),
        (agent_get_horse, ":var3", ":var2"),
        (le, ":var3", 0),
        (agent_get_slot, ":var4", ":var2", 26),
        (ge, ":var4", 10),
        (agent_get_simple_behavior, ":var5", ":var2"),
        (agent_get_team, ":var6", ":var2"),
        (agent_get_class, ":var7", ":var2"),
        (team_get_movement_order, ":var8", ":var6", ":var7"),
        (assign, ":var9", 0),
        (try_begin),
          (neq, ":var6", ":var1"),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (else_try),
          (this_or_next|eq, ":var8", 0),
          (eq, ":var8", 11),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (this_or_next|eq, ":var5", 4),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (try_end),
        (eq, ":var9", 1),
        (agent_get_troop_id, ":var10", ":var2"),
        (store_proficiency_level, ":var11", ":var10", ca_intelligence),
        (store_character_level, ":var12", ":var10"),
        (ge, ":var12", 12),
        (ge, ":var11", 120),
        (neg|troop_is_mounted, ":var10"),
        (agent_slot_eq, ":var2", 15, 0),
        (assign, ":var9", 0),
        (agent_get_wielded_item, ":var13", ":var2", 0),
        (agent_get_wielded_item, ":var14", ":var2", 1),
        (assign, ":var15", 145),
        (try_begin),
          (this_or_next|is_between, ":var13", "itm_modded_billhook_fork_1", "itm_maul"),
          (is_between, ":var14", "itm_modded_billhook_fork_1", "itm_maul"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_1"),
            (eq, ":var14", "itm_modded_billhook_fork_1"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_2"),
            (eq, ":var14", "itm_modded_billhook_fork_2"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_1"),
            (eq, ":var14", "itm_modded_fauchard_1"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_2"),
            (eq, ":var14", "itm_modded_fauchard_2"),
            (assign, "$spear_dist", 171),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_3"),
            (eq, ":var14", "itm_modded_fauchard_3"),
            (assign, "$spear_dist", 197),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_4"),
            (eq, ":var14", "itm_modded_fauchard_4"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_1"),
            (eq, ":var14", "itm_modded_glaive_1"),
            (assign, "$spear_dist", 169),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_1"),
            (eq, ":var14", "itm_modded_glaive_fork_1"),
            (assign, "$spear_dist", 230),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_2"),
            (eq, ":var14", "itm_modded_glaive_fork_2"),
            (assign, "$spear_dist", 188),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_roundel"),
            (eq, ":var14", "itm_modded_glaive_roundel"),
            (assign, "$spear_dist", 149),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_1"),
            (eq, ":var14", "itm_modded_bill_1"),
            (assign, "$spear_dist", 215),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_2"),
            (eq, ":var14", "itm_modded_bill_2"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_1"),
            (eq, ":var14", "itm_modded_billhook_1"),
            (assign, "$spear_dist", 207),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_2"),
            (eq, ":var14", "itm_modded_billhook_2"),
            (assign, "$spear_dist", 172),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_3"),
            (eq, ":var14", "itm_modded_billhook_3"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_voulge"),
            (eq, ":var14", "itm_modded_voulge"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_spiked_voulge"),
            (eq, ":var14", "itm_modded_spiked_voulge"),
            (assign, "$spear_dist", 182),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_cleaving_voulge"),
            (eq, ":var14", "itm_modded_cleaving_voulge"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_1"),
            (eq, ":var14", "itm_modded_hooked_voulge_1"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_2"),
            (eq, ":var14", "itm_modded_hooked_voulge_2"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_3"),
            (eq, ":var14", "itm_modded_hooked_voulge_3"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_1"),
            (eq, ":var14", "itm_modded_couteau_1"),
            (assign, "$spear_dist", 177),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_2"),
            (eq, ":var14", "itm_modded_couteau_2"),
            (assign, "$spear_dist", 196),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_guisarme"),
            (eq, ":var14", "itm_modded_guisarme"),
            (assign, "$spear_dist", 232),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_assegai"),
            (eq, ":var14", "itm_modded_assegai"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_pike"),
            (eq, ":var14", "itm_modded_pike"),
            (assign, "$spear_dist", 300),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_war_spear"),
            (eq, ":var14", "itm_modded_war_spear"),
            (assign, "$spear_dist", 211),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_glaive"),
          (is_between, ":var14", "itm_glaive"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_glaive"),
            (eq, ":var14", "itm_glaive"),
            (assign, "$spear_dist", 160),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_bill"),
          (is_between, ":var14", "itm_bill"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_bill"),
            (eq, ":var14", "itm_bill"),
            (assign, "$spear_dist", 128),
          (try_end),
        (try_end),
        (eq, ":var9", 1),
        (assign, ":var16", -1),
        (agent_get_position, pos1, ":var2"),
        (try_for_agents, ":var17"),
          (agent_is_alive, ":var17"),
          (neg|agent_is_human, ":var17"),
          (agent_get_rider, ":var18", ":var17"),
          (ge, ":var18", 0),
          (agent_get_team, ":var19", ":var18"),
          (teams_are_enemies, ":var6", ":var19"),
          (agent_get_position, pos2, ":var17"),
          (get_distance_between_positions, ":var20", pos1, pos2),
          (lt, ":var20", ":var15"),
          (neg|position_is_behind_position, pos2, pos1),
          (agent_get_slot, ":var21", ":var17", 30),
          (gt, ":var21", 0),
          (assign, ":var16", ":var17"),
        (try_end),
        (gt, ":var16", -1),
        (agent_play_sound, ":var16", "snd_metal_hit_high_armor_high_damage"),
        (store_agent_hit_points, ":var22", ":var16", 0),
        (store_agent_hit_points, ":var23", ":var16", 1),
        (assign, reg22, ":var21"),
        (val_mul, ":var21", 10),
        (val_sub, ":var22", ":var21"),
        (val_max, ":var22", 0),
        (agent_set_slot, ":var2", 26, 0),
        (agent_get_horse, ":var24", ":var0"),
        (agent_get_position, pos2, ":var16"),
        (agent_set_look_target_position, ":var2", pos2),
        (agent_set_attack_action, ":var2", 0, 0),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_get_troop_id, ":var10", ":var2"),
        (str_store_troop_name, s21, ":var10"),
        (agent_get_troop_id, ":var25", ":var16"),
        (str_store_troop_name, s20, ":var25"),
        (store_agent_hit_points, ":var22", ":var16", 1),
        (val_sub, ":var23", ":var22"),
        (assign, reg1, ":var23"),
        (try_begin),
          (eq, ":var16", ":var24"),
          (display_message, "@Your horse received {reg1} damage from a braced polearm!", 0xFF4040),
        (try_end),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (store_agent_hit_points, ":var1", ":var0", 1),
      (lt, ":var1", "$spear_hp"),
      (display_message, "@The injury causes your grip on the polearm to slip!", 0xFF4040),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 26),
      (ge, ":var1", 10),
      (assign, ":var2", -1),
      (agent_get_position, pos1, ":var0"),
      (try_for_agents, ":var3"),
        (agent_is_alive, ":var3"),
        (neg|agent_is_human, ":var3"),
        (agent_get_rider, ":var4", ":var3"),
        (ge, ":var4", 0),
        (neg|agent_is_ally, ":var4"),
        (agent_get_position, pos2, ":var3"),
        (get_distance_between_positions, ":var5", pos1, pos2),
        (lt, ":var5", "$spear_dist"),
        (neg|position_is_behind_position, pos2, pos1),
        (agent_get_slot, ":var6", ":var3", 30),
        (ge, ":var6", 120),
        (assign, ":var2", ":var3"),
      (try_end),
      (gt, ":var2", -1),
      (agent_play_sound, ":var2", "snd_metal_hit_high_armor_high_damage"),
      (store_agent_hit_points, ":var7", ":var2", 0),
      (store_agent_hit_points, ":var8", ":var2", 1),
      (val_div, ":var6", 2),
      (val_sub, ":var6", 15),
      (val_sub, ":var7", ":var6"),
      (val_max, ":var7", 0),
      (agent_set_hit_points, ":var2", ":var7", 0),
      (agent_deliver_damage_to_agent, ":var2", ":var2"),
      (agent_set_slot, ":var0", 26, 0),
      (store_agent_hit_points, ":var7", ":var2", 1),
      (val_sub, ":var8", ":var7"),
      (assign, reg1, ":var8"),
      (display_message, "@Polearm-wall dealt {reg1} damage!"),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 2, 
    [
      (key_clicked, key_b),
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_is_alive, ":var1"),
      (agent_get_wielded_item, ":var2", ":var1", 0),
      (agent_get_wielded_item, ":var3", ":var1", 1),
      (assign, "$spear_dist", 145),
      (try_begin),
        (this_or_next|is_between, ":var2", "itm_modded_billhook_fork_1", "itm_maul"),
        (is_between, ":var3", "itm_modded_billhook_fork_1", "itm_maul"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_1"),
          (eq, ":var3", "itm_modded_billhook_fork_1"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_2"),
          (eq, ":var3", "itm_modded_billhook_fork_2"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_1"),
          (eq, ":var3", "itm_modded_fauchard_1"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_2"),
          (eq, ":var3", "itm_modded_fauchard_2"),
          (assign, "$spear_dist", 171),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_3"),
          (eq, ":var3", "itm_modded_fauchard_3"),
          (assign, "$spear_dist", 197),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_4"),
          (eq, ":var3", "itm_modded_fauchard_4"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_1"),
          (eq, ":var3", "itm_modded_glaive_1"),
          (assign, "$spear_dist", 169),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_1"),
          (eq, ":var3", "itm_modded_glaive_fork_1"),
          (assign, "$spear_dist", 230),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_2"),
          (eq, ":var3", "itm_modded_glaive_fork_2"),
          (assign, "$spear_dist", 188),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_roundel"),
          (eq, ":var3", "itm_modded_glaive_roundel"),
          (assign, "$spear_dist", 149),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_1"),
          (eq, ":var3", "itm_modded_bill_1"),
          (assign, "$spear_dist", 215),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_2"),
          (eq, ":var3", "itm_modded_bill_2"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_1"),
          (eq, ":var3", "itm_modded_billhook_1"),
          (assign, "$spear_dist", 207),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_2"),
          (eq, ":var3", "itm_modded_billhook_2"),
          (assign, "$spear_dist", 172),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_3"),
          (eq, ":var3", "itm_modded_billhook_3"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_voulge"),
          (eq, ":var3", "itm_modded_voulge"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_spiked_voulge"),
          (eq, ":var3", "itm_modded_spiked_voulge"),
          (assign, "$spear_dist", 182),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_cleaving_voulge"),
          (eq, ":var3", "itm_modded_cleaving_voulge"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_1"),
          (eq, ":var3", "itm_modded_hooked_voulge_1"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_2"),
          (eq, ":var3", "itm_modded_hooked_voulge_2"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_3"),
          (eq, ":var3", "itm_modded_hooked_voulge_3"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_1"),
          (eq, ":var3", "itm_modded_couteau_1"),
          (assign, "$spear_dist", 177),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_2"),
          (eq, ":var3", "itm_modded_couteau_2"),
          (assign, "$spear_dist", 196),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_guisarme"),
          (eq, ":var3", "itm_modded_guisarme"),
          (assign, "$spear_dist", 232),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_assegai"),
          (eq, ":var3", "itm_modded_assegai"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_pike"),
          (eq, ":var3", "itm_modded_pike"),
          (assign, "$spear_dist", 300),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_war_spear"),
          (eq, ":var3", "itm_modded_war_spear"),
          (assign, "$spear_dist", 211),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_glaive"),
        (is_between, ":var3", "itm_glaive"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_glaive"),
          (eq, ":var3", "itm_glaive"),
          (assign, "$spear_dist", 160),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_bill"),
        (is_between, ":var3", "itm_bill"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_bill"),
          (eq, ":var3", "itm_bill"),
          (assign, "$spear_dist", 128),
        (try_end),
      (try_end),
      (eq, ":var0", 1),
      (agent_get_horse, ":var4", ":var1"),
      (le, ":var4", 0),
      (neq, "$spear_in_position", 1),
      (display_message, "@Bracing polearm for charge.", 0x6495ED),
      (agent_set_animation, ":var1", "anim_spearwall_hold"),
      (assign, "$spear_in_position", 1),
      (store_agent_hit_points, "$spear_hp", ":var1", 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (call_script, "script_lance_use_classify_agent"),
    ]),

    (2, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 43),
        (gt, ":var1", 0),
        (agent_get_wielded_item, ":var2", ":var0", 0),
        (agent_get_horse, ":var3", ":var0"),
        (try_begin),
          (le, ":var3", 0),
          (agent_set_slot, ":var0", 43, 0),
          (eq, ":var2", ":var1"),
          (call_script, "script_lance_use_backup_weapon", ":var0"),
        (else_try),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var4", ":var0"),
          (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":var4", 1),
          (assign, ":var5", reg0),
          (try_begin),
            (lt, ":var5", 500),
            (agent_get_combat_state, ":var6", ":var0"),
            (gt, ":var6", 3),
            (eq, ":var2", ":var1"),
            (call_script, "script_lance_use_backup_weapon", ":var0"),
          (else_try),
            (neq, ":var2", ":var1"),
            (agent_set_wielded_item, ":var0", ":var1"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("arena_challenge_fight", mtf_arena_fight|mtf_commit_casualties, -1,
  "You enter a melee fight in the arena.",
  [
    (56, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_2|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "str_cannot_leave_now"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (check_quest_active, "qst_duel_for_lady"),
        (quest_slot_eq, "qst_duel_for_lady", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_duel_for_lady"),
      (else_try),
        (check_quest_active, "qst_duel_for_lady"),
        (quest_slot_eq, "qst_duel_for_lady", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_duel_for_lady"),
      (else_try),
        (main_hero_fallen),
        (check_quest_active, "qst_duel_courtship_rival"),
        (quest_slot_eq, "qst_duel_courtship_rival", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_duel_courtship_rival"),
      (else_try),
        (check_quest_active, "qst_duel_courtship_rival"),
        (quest_slot_eq, "qst_duel_courtship_rival", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_duel_courtship_rival"),
      (else_try),
        (main_hero_fallen),
        (check_quest_active, "qst_duel_avenge_insult"),
        (quest_slot_eq, "qst_duel_avenge_insult", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_duel_avenge_insult"),
      (else_try),
        (check_quest_active, "qst_duel_avenge_insult"),
        (quest_slot_eq, "qst_duel_avenge_insult", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_duel_avenge_insult"),
      (else_try),
        (main_hero_fallen),
        (check_quest_active, "qst_denounce_lord"),
        (quest_slot_eq, "qst_denounce_lord", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_denounce_lord"),
      (else_try),
        (check_quest_active, "qst_denounce_lord"),
        (quest_slot_eq, "qst_denounce_lord", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_denounce_lord"),
      (else_try),
        (quest_get_slot, ":var0", "qst_denounce_lord", 2),
        (str_store_troop_name, s4, ":var0"),
      (try_end),
      (finish_mission),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("duel_with_lord", mtf_arena_fight|mtf_commit_casualties, -1,
  "You enter a melee fight in the arena.",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_sword_type_xiiib]),
    (16, mtef_team_1|mtef_visitor_source, af_override_all, aif_start_alarmed, 1, [itm_sword_type_xiiib]),
  ],
  [
    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "str_cannot_leave_now"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (check_quest_active, "qst_duel_for_lady"),
        (quest_slot_eq, "qst_duel_for_lady", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_duel_for_lady"),
      (else_try),
        (check_quest_active, "qst_duel_for_lady"),
        (quest_slot_eq, "qst_duel_for_lady", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_duel_for_lady"),
      (else_try),
        (main_hero_fallen),
        (check_quest_active, "qst_duel_courtship_rival"),
        (quest_slot_eq, "qst_duel_courtship_rival", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_duel_courtship_rival"),
      (else_try),
        (check_quest_active, "qst_duel_courtship_rival"),
        (quest_slot_eq, "qst_duel_courtship_rival", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_duel_courtship_rival"),
      (else_try),
        (main_hero_fallen),
        (check_quest_active, "qst_duel_avenge_insult"),
        (quest_slot_eq, "qst_duel_avenge_insult", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_duel_avenge_insult"),
      (else_try),
        (check_quest_active, "qst_duel_avenge_insult"),
        (quest_slot_eq, "qst_duel_avenge_insult", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_duel_avenge_insult"),
      (else_try),
        (main_hero_fallen),
        (check_quest_active, "qst_denounce_lord"),
        (quest_slot_eq, "qst_denounce_lord", 2, "$g_duel_troop"),
        (call_script, "script_fail_quest", "qst_denounce_lord"),
      (else_try),
        (check_quest_active, "qst_denounce_lord"),
        (quest_slot_eq, "qst_denounce_lord", 2, "$g_duel_troop"),
        (call_script, "script_succeed_quest", "qst_denounce_lord"),
      (else_try),
        (quest_get_slot, ":var0", "qst_denounce_lord", 2),
        (str_store_troop_name, s4, ":var0"),
      (try_end),
      (finish_mission),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("wedding", 0, -1,
  "Wedding",
  [
    (0, mtef_visitor_source, af_override_everything, 0, 1, [itm_archer_a,itm_ankle_boots]),
    (1, mtef_visitor_source, af_override_everything, 0, 1, [itm_bride_dress,itm_bride_crown,itm_bride_shoes]),
    (2, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (3, mtef_visitor_source, af_override_everything, 0, 1, [itm_merchant_outfit,itm_blue_hose]),
    (4, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (5, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (6, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (7, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (8, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (9, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (10, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (11, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (12, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (13, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (14, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (15, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (16, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (17, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (18, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (19, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (20, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (21, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (22, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (23, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (24, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (25, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (26, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (27, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (28, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (29, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (30, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (31, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (show_object_details_overlay, 1),
      (finish_mission, 0),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (show_object_details_overlay, 1),
      (finish_mission, 0),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_wedding_state", 0),
      (play_track, "track_wedding", 2),
      (show_object_details_overlay, 0),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (troop_get_type, ":var2", ":var1"),
      (set_fixed_point_multiplier, 100),
      (try_begin),
        (eq, ":var1", "$g_wedding_bishop_troop"),
      (else_try),
        (eq, ":var1", "$g_wedding_bride_troop"),
        (agent_set_no_dynamics, ":var0", 1),
        (init_position, pos1),
        (position_set_z, pos1, -1000),
        (agent_set_position, ":var0", pos1),
      (else_try),
        (eq, ":var1", "$g_wedding_brides_dad_troop"),
        (agent_set_no_dynamics, ":var0", 1),
        (init_position, pos1),
        (position_set_z, pos1, -1000),
        (agent_set_position, ":var0", pos1),
      (else_try),
        (eq, ":var1", "$g_wedding_groom_troop"),
        (agent_set_no_dynamics, ":var0", 1),
        (init_position, pos1),
        (position_move_x, 1, 175),
        (position_move_z, pos1, 10),
        (position_rotate_z, pos1, 180),
        (agent_set_position, ":var0", pos1),
        (agent_set_animation, ":var0", "anim_wedding_groom_wait"),
      (else_try),
        (try_begin),
          (eq, ":var2", 0),
          (store_random_in_range, ":var3", 0, 3),
          (try_begin),
            (eq, ":var3", 0),
            (agent_set_slot, ":var0", 18, "anim_wedding_guest_notr"),
            (agent_set_animation, ":var0", "anim_wedding_guest_notr"),
          (else_try),
            (agent_set_slot, ":var0", 18, "anim_wedding_guest"),
            (agent_set_animation, ":var0", "anim_wedding_guest"),
          (try_end),
        (else_try),
          (agent_set_slot, ":var0", 18, "anim_wedding_guest_woman"),
          (agent_set_animation, ":var0", "anim_wedding_guest_woman"),
        (try_end),
        (store_random_in_range, ":var4", 0, 100),
        (agent_set_animation_progress, ":var0", ":var4"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (store_mission_timer_a, ":var0"),
      (set_fixed_point_multiplier, 100),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (try_begin),
          (eq, ":var2", "$g_wedding_groom_troop"),
        (else_try),
          (eq, ":var2", "$g_wedding_bride_troop"),
        (else_try),
          (eq, ":var2", "$g_wedding_brides_dad_troop"),
        (else_try),
          (eq, ":var2", "$g_wedding_bishop_troop"),
        (else_try),
          (agent_get_slot, ":var3", ":var1", 18),
          (agent_set_animation, ":var1", ":var3"),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$g_wedding_state", 0),
        (mission_cam_set_mode, 1, 0, 0),
        (init_position, pos1),
        (position_rotate_z, pos1, 180),
        (position_rotate_x, pos1, 5),
        (position_set_x, pos1, -500),
        (position_set_y, pos1, 1000),
        (position_set_z, pos1, 600),
        (mission_cam_set_position, pos1),
        (init_position, pos1),
        (position_rotate_z, pos1, 180),
        (position_rotate_x, pos1, -15),
        (position_set_x, pos1, -500),
        (position_set_y, pos1, 1000),
        (position_set_z, pos1, 600),
        (mission_cam_animate_to_position, pos1, 4000, 0),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 1),
        (ge, ":var0", 4),
        (init_position, pos1),
        (position_rotate_z, pos1, 90),
        (position_rotate_x, pos1, -10),
        (position_set_x, pos1, -580),
        (position_set_y, pos1, 700),
        (position_set_z, pos1, 200),
        (mission_cam_set_position, pos1),
        (init_position, pos1),
        (position_rotate_z, pos1, 150),
        (position_rotate_x, pos1, -10),
        (position_set_x, pos1, -580),
        (position_set_y, pos1, 100),
        (position_set_z, pos1, 200),
        (mission_cam_animate_to_position, pos1, 6000, 1),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 2),
        (ge, ":var0", 9),
        (mission_cam_animate_to_screen_color, 4278190080, 1000),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 3),
        (ge, ":var0", 10),
        (init_position, pos1),
        (position_move_x, 1, 175),
        (position_move_z, pos1, 10),
        (position_rotate_z, pos1, 180),
        (try_for_agents, ":var1"),
          (agent_get_troop_id, ":var4", ":var1"),
          (try_begin),
            (eq, ":var4", "$g_wedding_bride_troop"),
            (agent_set_position, ":var1", pos1),
            (agent_set_animation, ":var1", "anim_wedding_bride_stairs"),
          (else_try),
            (eq, ":var4", "$g_wedding_brides_dad_troop"),
            (agent_set_position, ":var1", pos1),
            (agent_set_animation, ":var1", "anim_wedding_dad_stairs"),
          (try_end),
        (try_end),
        (init_position, pos1),
        (position_rotate_z, pos1, -90),
        (position_set_x, pos1, 300),
        (position_set_y, pos1, 950),
        (position_set_z, pos1, 420),
        (mission_cam_set_position, pos1),
        (position_set_x, pos1, 175),
        (position_set_y, pos1, 950),
        (position_set_z, pos1, 320),
        (mission_cam_animate_to_position, pos1, 4000, 0),
        (mission_cam_animate_to_screen_color, 0, 500),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 4),
        (ge, ":var0", 14),
        (init_position, pos1),
        (position_rotate_z, pos1, -60),
        (position_rotate_x, pos1, 10),
        (position_set_x, pos1, -400),
        (position_set_y, pos1, 200),
        (position_set_z, pos1, 115),
        (mission_cam_set_position, pos1),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 5),
        (ge, ":var0", 20),
        (init_position, pos1),
        (position_move_x, 1, 175),
        (position_move_z, pos1, 10),
        (position_rotate_z, pos1, 180),
        (try_for_agents, ":var1"),
          (agent_get_troop_id, ":var4", ":var1"),
          (try_begin),
            (eq, ":var4", "$g_wedding_bride_troop"),
            (agent_set_position, ":var1", pos1),
            (agent_set_animation, ":var1", "anim_wedding_bride_walk"),
          (else_try),
            (eq, ":var4", "$g_wedding_brides_dad_troop"),
            (agent_set_position, ":var1", pos1),
            (agent_set_animation, ":var1", "anim_wedding_dad_walk"),
          (try_end),
        (try_end),
        (init_position, pos1),
        (position_rotate_z, pos1, -140),
        (position_rotate_x, pos1, -15),
        (position_set_x, pos1, -625),
        (position_set_y, pos1, -530),
        (position_set_z, pos1, 180),
        (mission_cam_set_position, pos1),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 6),
        (ge, ":var0", 22),
        (init_position, pos1),
        (position_rotate_z, pos1, 45),
        (position_rotate_x, pos1, -10),
        (position_set_x, pos1, -260),
        (position_set_y, pos1, 120),
        (position_set_z, pos1, 275),
        (mission_cam_set_position, pos1),
        (position_rotate_z, pos1, 10),
        (mission_cam_animate_to_position, pos1, 2000, 0),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 7),
        (ge, ":var0", 24),
        (init_position, pos1),
        (position_move_x, 1, 175),
        (position_move_z, pos1, 10),
        (position_rotate_z, pos1, 180),
        (try_for_agents, ":var1"),
          (agent_get_troop_id, ":var4", ":var1"),
          (try_begin),
            (eq, ":var4", "$g_wedding_bride_troop"),
            (agent_set_position, ":var1", pos1),
            (agent_set_animation, ":var1", "anim_wedding_bride_last"),
          (else_try),
            (eq, ":var4", "$g_wedding_brides_dad_troop"),
            (agent_set_position, ":var1", pos1),
            (agent_set_animation, ":var1", "anim_wedding_dad_last"),
          (else_try),
            (eq, ":var4", "$g_wedding_groom_troop"),
            (agent_set_position, ":var1", pos1),
            (agent_set_animation, ":var1", "anim_wedding_groom_last"),
          (try_end),
        (try_end),
        (init_position, pos1),
        (position_rotate_z, pos1, -45),
        (position_rotate_x, pos1, -10),
        (position_set_x, pos1, -900),
        (position_set_y, pos1, -850),
        (position_set_z, pos1, 230),
        (mission_cam_set_position, pos1),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 8),
        (ge, ":var0", 31),
        (init_position, pos1),
        (position_set_x, pos1, -550),
        (position_set_y, pos1, -625),
        (position_set_z, pos1, 1500),
        (particle_system_burst, "psys_wedding_rose", pos1, 750),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 9),
        (ge, ":var0", 33),
        (init_position, pos1),
        (position_rotate_z, pos1, 180),
        (position_set_x, pos1, -536),
        (position_set_y, pos1, -415),
        (position_set_z, pos1, 135),
        (mission_cam_set_position, pos1),
        (position_rotate_z, pos1, -8),
        (position_set_z, pos1, 350),
        (position_rotate_x, pos1, 35),
        (mission_cam_animate_to_position_and_aperture, pos1, 10, 9000, 1),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 10),
        (ge, ":var0", 41),
        (mission_cam_set_screen_color, 16777215),
        (mission_cam_animate_to_screen_color, 4294967295, 3000),
        (val_add, "$g_wedding_state", 1),
      (else_try),
        (eq, "$g_wedding_state", 11),
        (ge, ":var0", 48),
        (show_object_details_overlay, 1),
        (finish_mission, 0),
      (try_end),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("tutorial_training_ground", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_sword]),
    (33, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_sword]),
    (34, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_sword]),
    (35, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_sword]),
    (36, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows]),
    (42, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows]),
    (43, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_sword]),
    (62, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_sword]),
    (63, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows]),
    (64, mtef_team_0|mtef_visitor_source, af_override_weapons, aif_start_alarmed, 1, [itm_practice_bow,itm_practice_arrows]),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$g_tutorial_training_ground_state", 20),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (start_presentation, "prsnt_tutorial_show_mouse_movement"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_ai_set_always_attack_in_melee, ":var0", 1),
      (agent_set_no_death_knock_down_only, ":var0", 1),
      (agent_set_invulnerable_shield, ":var0", 1),
      (agent_get_position, pos1, ":var0"),
      (agent_set_slot, ":var0", 8, -1),
      (get_player_agent_no, ":var1"),
      (try_begin),
        (eq, ":var0", ":var1"),
        (agent_set_team, ":var0", 7),
      (try_end),
      (try_for_range, ":var2", 0, 64),
        (entry_point_get_position, pos2, ":var2"),
        (get_sq_distance_between_positions, ":var3", pos1, pos2),
        (lt, ":var3", 100),
        (agent_set_slot, ":var0", 8, ":var2"),
      (try_end),
      (agent_get_troop_id, ":var4", ":var0"),
      (try_begin),
        (eq, ":var4", "trp_tutorial_archer_1"),
        (agent_get_position, pos1, ":var0"),
        (agent_set_scripted_destination, ":var0", pos1),
        (scene_prop_get_num_instances, ":var5", "spr_archery_target_with_hit_a"),
        (assign, ":var6", 10000000),
        (assign, ":var7", -1),
        (try_for_range, ":var8", 0, ":var5"),
          (scene_prop_get_instance, ":var9", "spr_archery_target_with_hit_a", ":var8"),
          (prop_instance_get_position, pos2, ":var9"),
          (get_sq_distance_between_positions, ":var10", pos1, pos2),
          (lt, ":var10", ":var6"),
          (assign, ":var6", ":var10"),
          (assign, ":var7", ":var9"),
        (try_end),
        (agent_set_slot, ":var0", 9, ":var7"),
      (else_try),
        (this_or_next|eq, ":var4", "trp_tutorial_rider_1"),
        (eq, ":var4", "trp_tutorial_rider_2"),
        (agent_set_slot, ":var0", 11, 48),
        (agent_set_slot, ":var0", 9, -1),
        (entry_point_get_position, pos1, 48),
        (agent_set_scripted_destination, ":var0", pos1),
      (try_end),
    ]),

    (ti_on_agent_knocked_down, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (agent_get_troop_id, ":var2", ":var0"),
      (agent_get_troop_id, ":var3", ":var1"),
      (try_begin),
        (ge, "$g_tutorial_training_ground_melee_trainer_attack", 0),
      (else_try),
        (ge, "$g_tutorial_training_ground_melee_trainer_parry", 0),
        (try_begin),
          (eq, ":var2", "trp_player"),
          (eq, ":var3", "$g_tutorial_training_ground_melee_trainer_parry"),
          (assign, "$g_tutorial_training_ground_melee_state", 0),
          (agent_set_team, ":var0", 0),
          (agent_set_team, ":var1", 7),
          (tutorial_message, -1),
          (assign, "$g_tutorial_mouse_dir", -1),
          (assign, "$g_tutorial_mouse_click", -1),
          (assign, "$g_tutorial_training_ground_conversation_state", 2),
          (play_sound, "snd_tutorial_fail"),
          (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_parry"),
          (assign, "$g_tutorial_training_ground_melee_trainer_parry", -1),
          (try_begin),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
            (agent_set_attack_action, ":var0", 0, 0),
          (try_end),
        (else_try),
          (eq, ":var3", "trp_player"),
          (eq, ":var2", "$g_tutorial_training_ground_melee_trainer_parry"),
          (agent_set_team, ":var0", 7),
          (agent_set_team, ":var1", 0),
          (tutorial_message, -1),
          (assign, "$g_tutorial_mouse_dir", -1),
          (assign, "$g_tutorial_mouse_click", -1),
          (assign, "$g_tutorial_training_ground_conversation_state", 3),
          (play_sound, "snd_tutorial_fail"),
          (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_parry"),
          (assign, "$g_tutorial_training_ground_melee_trainer_parry", -1),
          (try_begin),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
            (agent_set_attack_action, ":var0", 0, 0),
          (try_end),
        (try_end),
      (else_try),
        (ge, "$g_tutorial_training_ground_melee_trainer_chamber", 0),
        (try_begin),
          (eq, ":var2", "trp_player"),
          (eq, ":var3", "$g_tutorial_training_ground_melee_trainer_chamber"),
          (assign, "$g_tutorial_training_ground_melee_state", 0),
          (agent_set_team, ":var0", 0),
          (agent_set_team, ":var1", 7),
          (tutorial_message, -1),
          (assign, "$g_tutorial_mouse_dir", -1),
          (assign, "$g_tutorial_mouse_click", -1),
          (assign, "$g_tutorial_training_ground_conversation_state", 7),
          (play_sound, "snd_tutorial_fail"),
          (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_chamber"),
          (assign, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
          (try_begin),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
            (agent_set_attack_action, ":var0", 0, 0),
          (try_end),
        (else_try),
          (eq, ":var3", "trp_player"),
          (eq, ":var2", "$g_tutorial_training_ground_melee_trainer_chamber"),
          (agent_set_team, ":var0", 7),
          (agent_set_team, ":var1", 0),
          (tutorial_message, -1),
          (assign, "$g_tutorial_mouse_dir", -1),
          (assign, "$g_tutorial_mouse_click", -1),
          (assign, "$g_tutorial_training_ground_conversation_state", 8),
          (play_sound, "snd_tutorial_fail"),
          (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_chamber"),
          (assign, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
          (try_begin),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
            (agent_set_attack_action, ":var0", 0, 0),
          (try_end),
        (try_end),
      (else_try),
        (ge, "$g_tutorial_training_ground_melee_trainer_combat", 0),
        (try_begin),
          (eq, ":var2", "trp_player"),
          (eq, ":var3", "$g_tutorial_training_ground_melee_trainer_combat"),
          (assign, "$g_tutorial_training_ground_melee_state", 0),
          (agent_set_team, ":var0", 0),
          (agent_set_team, ":var1", 7),
          (tutorial_message, -1),
          (assign, "$g_tutorial_training_ground_conversation_state", 4),
          (play_sound, "snd_tutorial_fail"),
          (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_combat"),
          (assign, "$g_tutorial_training_ground_melee_trainer_combat", -1),
        (else_try),
          (eq, ":var3", "trp_player"),
          (eq, ":var2", "$g_tutorial_training_ground_melee_trainer_combat"),
          (assign, "$g_tutorial_training_ground_melee_state", 0),
          (agent_set_team, ":var0", 7),
          (agent_set_team, ":var1", 0),
          (tutorial_message, -1),
          (assign, "$g_tutorial_training_ground_conversation_state", 5),
          (play_sound, "snd_tutorial_2"),
          (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_combat"),
          (assign, "$g_tutorial_training_ground_melee_trainer_combat", -1),
        (try_end),
      (else_try),
        (agent_is_human, ":var0"),
        (assign, "$g_tutorial_training_ground_melee_last_winner", ":var1"),
        (assign, "$g_tutorial_training_ground_melee_last_loser", ":var0"),
        (assign, "$g_tutorial_training_ground_melee_state", 0),
        (agent_set_team, "$g_tutorial_training_ground_melee_cur_fighter_1", 7),
        (agent_set_team, "$g_tutorial_training_ground_melee_cur_fighter_2", 7),
        (agent_force_rethink, "$g_tutorial_training_ground_melee_cur_fighter_1"),
        (agent_force_rethink, "$g_tutorial_training_ground_melee_cur_fighter_2"),
      (try_end),
      (agent_set_hit_points, ":var0", 100, 0),
      (agent_set_hit_points, ":var1", 100, 0),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (scene_set_day_time, 13),
      (team_set_relation, 0, 1, 0),
      (team_set_relation, 0, 2, 0),
      (team_set_relation, 0, 3, 0),
      (team_set_relation, 0, 7, 0),
      (team_set_relation, 7, 1, 1),
      (team_set_relation, 7, 2, 1),
      (team_set_relation, 7, 3, 1),
      (team_set_relation, 1, 2, -1),
      (team_set_relation, 1, 3, 1),
      (team_set_relation, 2, 3, 1),
      (assign, "$g_position_to_use_for_replacing_scene_items", 8),
      (call_script, "script_replace_scene_items_with_spawn_items_before_ms"),
      (assign, "$g_tutorial_training_ground_state", 0),
      (assign, "$g_tutorial_training_ground_conversation_state", 0),
      (assign, "$g_tutorial_training_ground_melee_paused", 0),
      (assign, "$g_tutorial_training_ground_melee_state", 0),
      (assign, "$g_tutorial_training_ground_melee_next_action_time", 0),
      (assign, "$g_tutorial_training_ground_melee_last_winner", -1),
      (assign, "$g_tutorial_training_ground_melee_last_loser", -1),
      (assign, "$g_tutorial_training_ground_melee_cur_fighter_1", -1),
      (assign, "$g_tutorial_training_ground_melee_cur_fighter_2", -1),
      (assign, "$g_tutorial_training_ground_melee_trainer_attack", -1),
      (assign, "$g_tutorial_training_ground_melee_trainer_parry", -1),
      (assign, "$g_tutorial_training_ground_melee_trainer_combat", -1),
      (assign, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
      (assign, "$g_tutorial_training_ground_melee_trainer_next_action_time", 0),
      (assign, "$g_tutorial_training_ground_archer_trainer_state", 0),
      (assign, "$g_tutorial_training_ground_archer_trainer_completed_chapters", 0),
      (assign, "$g_tutorial_training_ground_horseman_trainer_state", 0),
      (assign, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 0),
      (assign, "$g_tutorial_training_ground_next_score_time", 0),
      (assign, "$g_tutorial_mouse_dir", -1),
      (assign, "$g_tutorial_mouse_click", -1),
      (assign, "$g_pointer_arrow_height_adder", -1000),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (tutorial_message_set_size, 17, 17),
      (tutorial_message_set_position, pos500, pos650),
      (tutorial_message_set_center_justify, 0),
      (mission_enable_talk),
      (call_script, "script_replace_scene_items_with_spawn_items_after_ms"),
      (entry_point_get_position, pos1, 59),
      (set_spawn_position, pos1),
      (spawn_horse, "itm_practice_horse", 0),
      (assign, "$g_tutorial_training_ground_intro_message_being_displayed", 1),
      (scene_spawned_item_get_instance, ":var0", "itm_practice_bow", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
      (scene_spawned_item_get_instance, ":var0", "itm_practice_bow_2", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
      (scene_spawned_item_get_instance, ":var0", "itm_practice_arrows", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
      (scene_spawned_item_get_instance, ":var0", "itm_practice_arrows_2", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
      (scene_spawned_item_get_instance, ":var0", "itm_practice_crossbow", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
      (scene_spawned_item_get_instance, ":var0", "itm_practice_bolts", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
      (scene_spawned_item_get_instance, ":var0", "itm_practice_javelin", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
      (scene_spawned_item_get_instance, ":var0", "itm_arena_lance", 0),
      (prop_instance_get_position, pos0, ":var0"),
      (position_move_z, pos0, -1000, 1),
      (prop_instance_set_position, ":var0", pos0),
    ]),

    (0, 1, ti_once, 
    [],
    [
      (tutorial_message_set_background, 1),
      (tutorial_message, "str_tutorial_training_ground_intro_message"),
    ]),

    (0, 0, 0, 
    [
      (store_mission_timer_a, ":var0"),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (eq, ":var2", "trp_tutorial_archer_1"),
        (try_begin),
          (agent_get_wielded_item, ":var3", ":var1", 0),
          (neq, ":var3", "itm_practice_bow"),
          (agent_set_wielded_item, ":var1", "itm_practice_bow"),
        (else_try),
          (agent_get_slot, ":var4", ":var1", 9),
          (prop_instance_get_position, pos1, ":var4"),
          (position_move_z, pos1, 10),
          (agent_set_look_target_position, ":var1", pos1),
          (try_begin),
            (neg|agent_slot_ge, ":var1", 19, ":var0"),
            (agent_set_attack_action, ":var1", 0),
            (store_random_in_range, ":var5", 3, 13),
            (val_add, ":var5", ":var0"),
            (agent_set_slot, ":var1", 19, ":var5"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (set_fixed_point_multiplier, 100),
      (try_for_agents, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (this_or_next|eq, ":var1", "trp_tutorial_rider_1"),
        (eq, ":var1", "trp_tutorial_rider_2"),
        (agent_get_slot, ":var2", ":var0", 11),
        (entry_point_get_position, pos1, ":var2"),
        (agent_get_position, pos2, ":var0"),
        (get_sq_distance_between_positions, ":var3", pos1, pos2),
        (try_begin),
          (lt, ":var3", 6400),
          (val_add, ":var2", 1),
          (try_begin),
            (gt, ":var2", 57),
            (assign, ":var2", 48),
          (try_end),
          (agent_set_slot, ":var0", 11, ":var2"),
          (entry_point_get_position, pos1, ":var2"),
          (agent_set_scripted_destination, ":var0", pos1),
        (try_end),
        (try_begin),
          (eq, ":var1", "trp_tutorial_rider_2"),
          (try_begin),
            (agent_get_wielded_item, ":var4", ":var0", 0),
            (neq, ":var4", "itm_practice_bow"),
            (agent_set_wielded_item, ":var0", "itm_practice_bow"),
          (else_try),
            (scene_prop_get_num_instances, ":var5", "spr_archery_target_with_hit_a"),
            (assign, ":var6", 10000000),
            (assign, ":var7", -1),
            (try_for_range, ":var8", 0, ":var5"),
              (scene_prop_get_instance, ":var9", "spr_archery_target_with_hit_a", ":var8"),
              (neg|agent_slot_eq, ":var0", 9, ":var9"),
              (prop_instance_get_position, pos1, ":var9"),
              (position_is_behind_position, pos2, pos1),
              (get_sq_distance_between_positions, ":var3", pos1, pos2),
              (lt, ":var3", ":var6"),
              (assign, ":var6", ":var3"),
              (assign, ":var7", ":var9"),
            (try_end),
            (try_begin),
              (lt, ":var6", 40000),
              (prop_instance_get_position, pos1, ":var7"),
              (position_move_z, pos1, 10),
              (init_position, pos3),
              (position_set_x, pos3, -160),
              (position_transform_position_to_parent, pos4, pos1, pos3),
              (copy_position, 1, 4),
              (agent_set_look_target_position, ":var0", pos1),
              (lt, ":var6", 22500),
              (agent_set_slot, ":var0", 9, ":var7"),
              (agent_set_attack_action, ":var0", 0),
            (else_try),
              (agent_get_slot, ":var10", ":var0", 9),
              (ge, ":var10", 0),
              (prop_instance_get_position, pos1, ":var10"),
              (get_sq_distance_between_positions, ":var3", pos1, pos2),
              (lt, ":var3", 40000),
              (position_move_z, pos1, 10),
              (init_position, pos3),
              (position_set_x, pos3, -160),
              (position_transform_position_to_parent, pos4, pos1, pos3),
              (copy_position, 1, 4),
              (agent_set_look_target_position, ":var0", pos1),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var1", "trp_tutorial_rider_1"),
          (try_begin),
            (agent_get_wielded_item, ":var4", ":var0", 0),
            (neq, ":var4", "itm_practice_sword"),
            (agent_set_wielded_item, ":var0", "itm_practice_sword"),
          (else_try),
            (scene_prop_get_num_instances, ":var5", "spr_dummy_a_undestructable"),
            (assign, ":var6", 10000000),
            (assign, ":var7", -1),
            (try_for_range, ":var8", 0, ":var5"),
              (scene_prop_get_instance, ":var9", "spr_dummy_a_undestructable", ":var8"),
              (neg|agent_slot_eq, ":var0", 9, ":var9"),
              (prop_instance_get_position, pos1, ":var9"),
              (get_sq_distance_between_positions, ":var3", pos1, pos2),
              (lt, ":var3", ":var6"),
              (assign, ":var6", ":var3"),
              (assign, ":var7", ":var9"),
            (try_end),
            (try_begin),
              (lt, ":var6", 10000),
              (prop_instance_get_position, pos1, ":var7"),
              (position_transform_position_to_local, pos3, pos2, pos1),
              (position_get_x, ":var11", pos3),
              (position_get_y, ":var12", pos3),
              (is_between, ":var11", -200, 200),
              (gt, ":var12", -100),
              (init_position, pos3),
              (try_begin),
                (lt, ":var11", 0),
                (position_move_x, 3, -100),
                (position_move_z, pos3, 100),
              (else_try),
                (position_move_x, 3, 100),
                (position_move_z, pos3, 150),
              (try_end),
              (position_transform_position_to_parent, pos4, pos2, pos3),
              (agent_set_look_target_position, ":var0", pos4),
              (try_begin),
                (lt, ":var11", 0),
                (agent_set_attack_action, ":var0", 2, 1),
              (else_try),
                (agent_set_attack_action, ":var0", 1, 1),
              (try_end),
              (this_or_next|lt, ":var6", 900),
              (lt, ":var12", 100),
              (agent_set_attack_action, ":var0", 0, 0),
              (agent_set_slot, ":var0", 9, ":var7"),
            (else_try),
              (agent_get_slot, ":var10", ":var0", 9),
              (ge, ":var10", 0),
              (prop_instance_get_position, pos1, ":var10"),
              (get_sq_distance_between_positions, ":var3", pos1, pos2),
              (lt, ":var3", 10000),
              (position_transform_position_to_local, pos3, pos2, pos1),
              (position_get_x, ":var11", pos3),
              (position_get_y, ":var12", pos3),
              (is_between, ":var11", -200, 200),
              (gt, ":var12", -100),
              (init_position, pos3),
              (try_begin),
                (lt, ":var11", 0),
                (position_move_x, 3, -100),
                (position_move_z, pos3, 100),
              (else_try),
                (position_move_x, 3, 100),
                (position_move_z, pos3, 150),
              (try_end),
              (position_transform_position_to_parent, pos4, pos2, pos3),
              (agent_set_look_target_position, ":var0", pos4),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (store_mission_timer_a, ":var0"),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (eq, ":var2", "trp_tutorial_archer_1"),
        (try_begin),
          (agent_get_wielded_item, ":var3", ":var1", 0),
          (neq, ":var3", "itm_practice_bow"),
          (agent_set_wielded_item, ":var1", "itm_practice_bow"),
        (else_try),
          (agent_get_slot, ":var4", ":var1", 9),
          (prop_instance_get_position, pos1, ":var4"),
          (agent_set_look_target_position, ":var1", pos1),
          (try_begin),
            (neg|agent_slot_ge, ":var1", 19, ":var0"),
            (agent_set_attack_action, ":var1", 0),
            (store_random_in_range, ":var5", 3, 13),
            (val_add, ":var5", ":var0"),
            (agent_set_slot, ":var1", 19, ":var5"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (call_script, "script_iterate_pointer_arrow"),
    ],
    []),

    (5, 0, 0, 
    [
      (try_begin),
        (store_mission_timer_a, ":var0"),
        (ge, ":var0", 30),
        (eq, "$g_tutorial_training_ground_intro_message_being_displayed", 1),
        (assign, "$g_tutorial_training_ground_intro_message_being_displayed", 0),
        (tutorial_message, -1),
      (try_end),
      (get_player_agent_no, ":var1"),
      (try_for_agents, ":var2"),
        (agent_is_human, ":var2"),
        (neq, ":var2", ":var1"),
        (agent_refill_ammo, ":var2"),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (agent_get_wielded_item, ":var1", ":var0", 0),
      (assign, ":var2", 0),
      (try_begin),
        (eq, ":var1", "itm_practice_bow"),
        (agent_has_item_equipped, ":var0", "itm_practice_arrows"),
        (agent_get_ammo, ":var3", ":var0", 1),
        (eq, ":var3", 0),
        (assign, ":var2", 1),
      (else_try),
        (eq, ":var1", "itm_practice_bow_2"),
        (agent_has_item_equipped, ":var0", "itm_practice_arrows_2"),
        (agent_get_ammo, ":var3", ":var0", 1),
        (eq, ":var3", 0),
        (assign, ":var2", 1),
      (else_try),
        (eq, ":var1", "itm_practice_crossbow"),
        (agent_has_item_equipped, ":var0", "itm_practice_bolts"),
        (agent_get_ammo, ":var3", ":var0", 1),
        (eq, ":var3", 0),
        (assign, ":var2", 1),
      (else_try),
        (eq, ":var1", "itm_practice_javelin"),
        (agent_get_ammo, ":var3", ":var0", 1),
        (le, ":var3", 1),
        (assign, ":var2", 1),
      (try_end),
      (eq, ":var2", 1),
      (agent_refill_ammo, ":var0"),
      (dialog_box, "str_tutorial_training_ground_ammo_refill", "@Tutorial"),
    ],
    []),

    (0, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (neq, "$g_tutorial_training_ground_horseman_trainer_state", 0),
      (mission_disable_talk),
      (try_begin),
        (eq, "$g_tutorial_training_ground_horseman_trainer_state", 1),
        (assign, "$g_tutorial_training_ground_current_score", 0),
        (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
      (else_try),
        (eq, "$g_tutorial_training_ground_horseman_trainer_state", 2),
        (try_begin),
          (try_begin),
            (ge, "$g_tutorial_training_ground_horseman_trainer_item_1", 0),
            (scene_spawned_item_get_instance, ":var1", "$g_tutorial_training_ground_horseman_trainer_item_1", 0),
            (prop_instance_get_position, pos0, ":var1"),
            (position_move_z, pos0, 1000, 1),
            (prop_instance_set_position, ":var1", pos0),
            (scene_prop_get_instance, ":var2", "spr_pointer_arrow", 0),
            (prop_instance_set_position, ":var2", pos0),
            (assign, "$g_pointer_arrow_height_adder", 200),
            (try_begin),
              (ge, "$g_tutorial_training_ground_horseman_trainer_item_2", 0),
              (scene_spawned_item_get_instance, ":var1", "$g_tutorial_training_ground_horseman_trainer_item_2", 0),
              (prop_instance_get_position, pos0, ":var1"),
              (position_move_z, pos0, 1000, 1),
              (prop_instance_set_position, ":var1", pos0),
            (try_end),
          (try_end),
          (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_horseman_trainer_state", 3),
        (try_begin),
          (ge, "$g_tutorial_training_ground_horseman_trainer_item_1", 0),
          (try_begin),
            (str_store_item_name, s0, "$g_tutorial_training_ground_horseman_trainer_item_1"),
            (tutorial_message, "str_tutorial_training_ground_horseman_text_1"),
            (agent_has_item_equipped, ":var0", "$g_tutorial_training_ground_horseman_trainer_item_1"),
            (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
            (play_sound, "snd_tutorial_1"),
          (try_end),
        (else_try),
          (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_horseman_trainer_state", 4),
        (try_begin),
          (ge, "$g_tutorial_training_ground_horseman_trainer_item_2", 0),
          (try_begin),
            (str_store_item_name, s0, "$g_tutorial_training_ground_horseman_trainer_item_2"),
            (tutorial_message, "str_tutorial_training_ground_horseman_text_1"),
            (agent_has_item_equipped, ":var0", "$g_tutorial_training_ground_horseman_trainer_item_2"),
            (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
            (play_sound, "snd_tutorial_1"),
          (try_end),
        (else_try),
          (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_horseman_trainer_state", 5),
        (try_begin),
          (agent_get_horse, ":var3", ":var0"),
          (lt, ":var3", 0),
          (tutorial_message, "str_tutorial_training_ground_horseman_text_2"),
          (try_begin),
            (assign, ":var4", -1),
            (try_for_agents, ":var5"),
              (agent_get_item_id, ":var6", ":var5"),
              (eq, ":var6", "itm_practice_horse"),
              (assign, ":var4", ":var5"),
            (try_end),
            (agent_get_position, pos0, ":var4"),
            (scene_prop_get_instance, ":var2", "spr_pointer_arrow", 0),
            (prop_instance_get_position, pos1, ":var2"),
            (set_fixed_point_multiplier, 100),
            (position_get_x, ":var7", pos0),
            (position_get_x, ":var8", pos1),
            (position_get_y, ":var9", pos0),
            (position_get_y, ":var10", pos1),
            (this_or_next|neq, ":var7", ":var8"),
            (neq, ":var9", ":var10"),
            (prop_instance_set_position, ":var2", pos0),
            (assign, "$g_pointer_arrow_height_adder", 200),
          (try_end),
        (else_try),
          (val_add, "$g_tutorial_training_ground_horseman_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_horseman_trainer_state", 6),
        (try_begin),
          (eq, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 0),
          (tutorial_message, "str_tutorial_training_ground_horseman_text_3"),
        (else_try),
          (eq, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 1),
          (assign, ":var11", "spr_dummy_a_undestructable"),
          (tutorial_message, "str_tutorial_training_ground_horseman_text_4"),
        (else_try),
          (assign, ":var11", "spr_archery_target_with_hit_a"),
          (tutorial_message, "str_tutorial_training_ground_horseman_text_5"),
        (try_end),
        (try_begin),
          (eq, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 0),
          (store_add, ":var12", "$g_tutorial_training_ground_current_score", 48),
          (entry_point_get_position, pos0, ":var12"),
          (init_position, pos2),
          (position_move_y, pos2, -800),
          (position_transform_position_to_parent, pos3, pos0, pos2),
          (copy_position, 0, 3),
          (agent_get_position, pos2, ":var0"),
          (try_begin),
            (get_distance_between_positions, ":var13", pos0, pos2),
            (lt, ":var13", 500),
            (val_add, "$g_tutorial_training_ground_current_score", 1),
            (ge, "$g_tutorial_training_ground_current_score", 10),
            (assign, "$g_pointer_arrow_height_adder", -1000),
            (tutorial_message, "str_tutorial_training_ground_horseman_text_6", 0x000000, 10),
            (assign, "$g_tutorial_training_ground_horseman_trainer_state", 0),
            (val_add, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 1),
            (play_sound, "snd_tutorial_2"),
          (try_end),
          (try_begin),
            (scene_prop_get_instance, ":var2", "spr_pointer_arrow", 0),
            (prop_instance_get_position, pos1, ":var2"),
            (set_fixed_point_multiplier, 1),
            (position_get_x, ":var7", pos0),
            (position_get_x, ":var8", pos1),
            (position_get_y, ":var9", pos0),
            (position_get_y, ":var10", pos1),
            (this_or_next|neq, ":var7", ":var8"),
            (neq, ":var9", ":var10"),
            (prop_instance_set_position, ":var2", pos0),
            (assign, "$g_pointer_arrow_height_adder", 150),
            (play_sound, "snd_tutorial_1"),
          (try_end),
        (else_try),
          (scene_prop_get_num_instances, ":var14", ":var11"),
          (try_begin),
            (lt, "$g_tutorial_training_ground_current_score", 6),
            (assign, ":var15", -1),
            (store_add, ":var16", "$g_tutorial_training_ground_current_score", 1),
            (try_for_range, ":var17", 0, ":var14"),
              (scene_prop_get_instance, ":var18", ":var11", ":var17"),
              (prop_instance_get_variation_id_2, ":var19", ":var18"),
              (eq, ":var16", ":var19"),
              (assign, ":var15", ":var18"),
              (assign, ":var14", 0),
            (try_end),
            (try_begin),
              (prop_instance_get_position, pos0, ":var15"),
              (scene_prop_get_instance, ":var2", "spr_pointer_arrow", 0),
              (prop_instance_get_position, pos1, ":var2"),
              (set_fixed_point_multiplier, 1),
              (position_get_x, ":var7", pos0),
              (position_get_x, ":var8", pos1),
              (position_get_y, ":var9", pos0),
              (position_get_y, ":var10", pos1),
              (this_or_next|neq, ":var7", ":var8"),
              (neq, ":var9", ":var10"),
              (prop_instance_set_position, ":var2", pos0),
              (assign, "$g_pointer_arrow_height_adder", 200),
              (play_sound, "snd_tutorial_1"),
            (try_end),
          (else_try),
            (assign, "$g_pointer_arrow_height_adder", -1000),
            (try_begin),
              (ge, "$g_tutorial_training_ground_horseman_trainer_item_2", 0),
              (agent_unequip_item, ":var0", "$g_tutorial_training_ground_horseman_trainer_item_2"),
            (try_end),
            (agent_unequip_item, ":var0", "$g_tutorial_training_ground_horseman_trainer_item_1"),
            (tutorial_message, "str_tutorial_training_ground_horseman_text_6", 0x000000, 10),
            (assign, "$g_tutorial_training_ground_horseman_trainer_state", 0),
            (val_add, "$g_tutorial_training_ground_horseman_trainer_completed_chapters", 1),
            (play_sound, "snd_tutorial_2"),
          (try_end),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (neq, "$g_tutorial_training_ground_archer_trainer_state", 0),
      (mission_disable_talk),
      (try_begin),
        (eq, "$g_tutorial_training_ground_archer_trainer_state", 1),
        (try_begin),
          (assign, "$g_last_destroyed_gourds", 0),
          (assign, "$g_tutorial_training_ground_current_score", 0),
          (scene_spawned_item_get_instance, ":var1", "$g_tutorial_training_ground_archer_trainer_item_1", 0),
          (prop_instance_get_position, pos0, ":var1"),
          (position_move_z, pos0, 1000, 1),
          (prop_instance_set_position, ":var1", pos0),
          (scene_prop_get_instance, ":var2", "spr_pointer_arrow", 0),
          (prop_instance_set_position, ":var2", pos0),
          (assign, "$g_pointer_arrow_height_adder", 100),
          (try_begin),
            (ge, "$g_tutorial_training_ground_archer_trainer_item_2", 0),
            (scene_spawned_item_get_instance, ":var1", "$g_tutorial_training_ground_archer_trainer_item_2", 0),
            (prop_instance_get_position, pos0, ":var1"),
            (position_move_z, pos0, 1000, 1),
            (prop_instance_set_position, ":var1", pos0),
          (try_end),
          (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_archer_trainer_state", 2),
        (try_begin),
          (str_store_item_name, s0, "$g_tutorial_training_ground_archer_trainer_item_1"),
          (tutorial_message, "str_tutorial_training_ground_archer_text_1"),
          (agent_has_item_equipped, ":var0", "$g_tutorial_training_ground_archer_trainer_item_1"),
          (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
          (play_sound, "snd_tutorial_1"),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_archer_trainer_state", 3),
        (try_begin),
          (ge, "$g_tutorial_training_ground_archer_trainer_item_2", 0),
          (try_begin),
            (str_store_item_name, s0, "$g_tutorial_training_ground_archer_trainer_item_2"),
            (tutorial_message, "str_tutorial_training_ground_archer_text_1"),
            (agent_has_item_equipped, ":var0", "$g_tutorial_training_ground_archer_trainer_item_2"),
            (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
            (play_sound, "snd_tutorial_1"),
          (try_end),
        (else_try),
          (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_archer_trainer_state", 4),
        (try_begin),
          (try_for_range, ":var3", 0, 3),
            (scene_prop_get_instance, ":var4", "spr_gourd", ":var3"),
            (prop_instance_refill_hit_points, ":var4"),
            (entry_point_get_position, pos0, 45),
            (init_position, pos1),
            (store_sub, ":var5", ":var3", 1),
            (val_mul, ":var5", 5),
            (position_rotate_z, pos1, ":var5"),
            (try_begin),
              (ge, "$g_tutorial_training_ground_archer_trainer_item_2", 0),
              (position_move_y, pos1, 1300),
            (else_try),
              (position_move_y, pos1, 800),
              (val_mul, ":var5", 2),
            (try_end),
            (position_transform_position_to_parent, pos2, pos0, pos1),
            (position_set_z_to_ground_level, pos2),
            (scene_prop_get_instance, ":var6", "spr_gourd_spike", ":var3"),
            (prop_instance_set_position, ":var6", pos2),
            (position_move_z, pos2, 150, 1),
            (prop_instance_set_position, ":var4", pos2),
          (try_end),
          (scene_prop_get_instance, ":var2", "spr_pointer_arrow", 0),
          (scene_prop_get_instance, ":var6", "spr_gourd_spike", 1),
          (prop_instance_get_position, pos1, ":var6"),
          (prop_instance_set_position, ":var2", pos1),
          (assign, "$g_pointer_arrow_height_adder", 200),
          (tutorial_message, "str_tutorial_training_ground_archer_text_2"),
          (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_archer_trainer_state", 5),
        (try_begin),
          (try_begin),
            (neq, "$g_tutorial_training_ground_current_score", "$g_last_destroyed_gourds"),
            (assign, "$g_tutorial_training_ground_current_score", "$g_last_destroyed_gourds"),
            (try_begin),
              (lt, "$g_last_destroyed_gourds", 3),
              (play_sound, "snd_tutorial_1"),
            (else_try),
              (play_sound, "snd_tutorial_2"),
            (try_end),
          (try_end),
          (try_begin),
            (eq, "$g_tutorial_training_ground_archer_trainer_completed_chapters", 0),
            (eq, "$g_last_destroyed_gourds", 0),
            (entry_point_get_position, pos0, 45),
            (agent_get_position, pos1, ":var0"),
            (neg|position_is_behind_position, pos1, pos0),
            (tutorial_message, "str_tutorial_training_ground_archer_text_3"),
          (else_try),
            (eq, "$g_tutorial_training_ground_archer_trainer_completed_chapters", 0),
            (eq, "$g_last_destroyed_gourds", 1),
            (tutorial_message, "str_tutorial_training_ground_archer_text_4"),
          (try_end),
          (ge, "$g_last_destroyed_gourds", 3),
          (assign, "$g_pointer_arrow_height_adder", -1000),
          (val_add, "$g_tutorial_training_ground_archer_trainer_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_archer_trainer_state", 6),
        (try_begin),
          (try_begin),
            (ge, "$g_tutorial_training_ground_archer_trainer_item_2", 0),
            (agent_unequip_item, ":var0", "$g_tutorial_training_ground_archer_trainer_item_2"),
          (try_end),
          (agent_unequip_item, ":var0", "$g_tutorial_training_ground_archer_trainer_item_1"),
          (tutorial_message, "str_tutorial_training_ground_archer_text_5", 0x000000, 10),
          (assign, "$g_tutorial_training_ground_archer_trainer_state", 0),
          (val_add, "$g_tutorial_training_ground_archer_trainer_completed_chapters", 1),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (neq, "$g_tutorial_training_ground_melee_trainer_attack", -1),
      (mission_disable_talk),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (eq, ":var2", "$g_tutorial_training_ground_melee_trainer_attack"),
        (assign, ":var3", ":var1"),
      (try_end),
      (try_begin),
        (eq, "$g_tutorial_training_ground_melee_state", 0),
        (try_begin),
          (try_for_agents, ":var1"),
            (agent_get_troop_id, ":var2", ":var1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_2"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_3"),
            (eq, ":var2", "trp_tutorial_fighter_4"),
            (agent_set_team, ":var1", 7),
            (agent_get_slot, ":var4", ":var1", 8),
            (entry_point_get_position, pos1, ":var4"),
            (agent_set_scripted_destination, ":var1", pos1),
            (agent_force_rethink, ":var1"),
          (try_end),
          (agent_set_wielded_item, ":var3", "itm_practice_sword"),
          (store_random_in_range, "$g_tutorial_training_ground_melee_state", 1, 5),
          (assign, "$g_tutorial_update_mouse_presentation", 1),
          (assign, "$g_tutorial_training_ground_next_score_time", 0),
        (try_end),
      (else_try),
        (gt, "$g_tutorial_training_ground_melee_state", 0),
        (try_begin),
          (agent_set_team, ":var0", 1),
          (agent_set_team, ":var3", 2),
          (agent_get_position, pos1, ":var0"),
          (agent_set_scripted_destination_no_attack, ":var3", pos1),
          (agent_get_attack_action, ":var5", ":var0"),
          (try_begin),
            (eq, ":var5", 2),
            (agent_get_action_dir, ":var6", ":var0"),
            (try_begin),
              (eq, ":var6", 0),
              (agent_set_defend_action, ":var3", 0, 1),
            (else_try),
              (eq, ":var6", 3),
              (agent_set_defend_action, ":var3", 3, 1),
            (else_try),
              (eq, ":var6", 1),
              (agent_set_defend_action, ":var3", 2, 1),
            (else_try),
              (eq, ":var6", 2),
              (agent_set_defend_action, ":var3", 1, 1),
            (try_end),
          (try_end),
          (try_begin),
            (ge, "$g_tutorial_training_ground_current_score", 5),
            (tutorial_message, -1),
            (assign, "$g_tutorial_training_ground_melee_state", 0),
            (agent_set_team, ":var0", 0),
            (agent_set_team, ":var3", 7),
            (agent_set_hit_points, ":var0", 100, 0),
            (agent_set_hit_points, ":var3", 100, 0),
            (assign, "$g_tutorial_training_ground_conversation_state", 9),
            (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_attack"),
            (assign, "$g_tutorial_training_ground_melee_trainer_attack", -1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_get_attack_action, ":var5", ":var0"),
        (eq, ":var5", 2),
        (agent_get_action_dir, ":var6", ":var0"),
        (store_add, ":var7", ":var6", 1),
        (agent_get_wielded_item, ":var8", ":var0", 0),
        (call_script, "script_cf_is_melee_weapon_for_tutorial", ":var8"),
        (store_mission_timer_a, ":var9"),
        (gt, ":var9", "$g_tutorial_training_ground_next_score_time"),
        (try_begin),
          (eq, ":var7", "$g_tutorial_training_ground_melee_state"),
          (val_add, "$g_tutorial_training_ground_current_score", 1),
          (try_begin),
            (ge, "$g_tutorial_training_ground_current_score", 5),
            (assign, "$g_tutorial_training_ground_melee_state", 5),
            (play_sound, "snd_tutorial_2"),
          (else_try),
            (play_sound, "snd_tutorial_1"),
            (assign, ":var10", 100),
            (try_for_range, ":var11", 0, ":var10"),
              (store_random_in_range, ":var12", 1, 5),
              (neq, ":var12", "$g_tutorial_training_ground_melee_state"),
              (assign, "$g_tutorial_training_ground_melee_state", ":var12"),
              (assign, ":var10", 0),
            (try_end),
          (try_end),
          (assign, "$g_tutorial_update_mouse_presentation", 1),
        (else_try),
          (val_add, "$g_tutorial_training_ground_current_score_2", 1),
          (play_sound, "snd_tutorial_fail"),
        (try_end),
        (store_add, "$g_tutorial_training_ground_next_score_time", ":var9", 1),
      (try_end),
      (assign, reg0, "$g_tutorial_training_ground_current_score"),
      (assign, reg1, "$g_tutorial_training_ground_current_score_2"),
      (str_clear, s0),
      (assign, "$g_tutorial_mouse_dir", -1),
      (assign, "$g_tutorial_mouse_click", -1),
      (try_begin),
        (neq, "$g_tutorial_training_ground_melee_state", 5),
        (store_mission_timer_a, ":var9"),
        (this_or_next|eq, "$g_tutorial_update_mouse_presentation", 0),
        (gt, ":var9", "$g_tutorial_training_ground_next_score_time"),
        (try_begin),
          (eq, "$g_tutorial_training_ground_melee_state", 1),
          (str_store_string, s0, "str_tutorial_training_ground_attack_training_down"),
        (else_try),
          (eq, "$g_tutorial_training_ground_melee_state", 4),
          (str_store_string, s0, "str_tutorial_training_ground_attack_training_up"),
        (else_try),
          (eq, "$g_tutorial_training_ground_melee_state", 2),
          (str_store_string, s0, "str_tutorial_training_ground_attack_training_right"),
        (else_try),
          (eq, "$g_tutorial_training_ground_melee_state", 3),
          (str_store_string, s0, "str_tutorial_training_ground_attack_training_left"),
        (try_end),
        (store_sub, "$g_tutorial_mouse_dir", "$g_tutorial_training_ground_melee_state", 1),
        (assign, "$g_tutorial_mouse_click", 0),
        (try_begin),
          (eq, "$g_tutorial_update_mouse_presentation", 1),
          (assign, "$g_tutorial_update_mouse_presentation", 0),
          (start_presentation, "prsnt_tutorial_show_mouse_movement"),
        (try_end),
      (try_end),
      (try_begin),
        (agent_get_wielded_item, ":var8", ":var0", 0),
        (call_script, "script_cf_is_melee_weapon_for_tutorial", ":var8"),
        (tutorial_message, "str_tutorial_training_ground_attack_training"),
      (else_try),
        (tutorial_message, "str_tutorial_training_ground_warning_melee"),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (neq, "$g_tutorial_training_ground_melee_trainer_parry", -1),
      (mission_disable_talk),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (eq, ":var2", "$g_tutorial_training_ground_melee_trainer_parry"),
        (assign, ":var3", ":var1"),
      (try_end),
      (try_begin),
        (eq, "$g_tutorial_training_ground_melee_state", 0),
        (try_begin),
          (try_for_agents, ":var1"),
            (agent_get_troop_id, ":var2", ":var1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_2"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_3"),
            (eq, ":var2", "trp_tutorial_fighter_4"),
            (agent_set_team, ":var1", 7),
            (agent_get_slot, ":var4", ":var1", 8),
            (entry_point_get_position, pos1, ":var4"),
            (agent_set_scripted_destination, ":var1", pos1),
            (agent_force_rethink, ":var1"),
          (try_end),
          (agent_set_wielded_item, ":var3", "itm_practice_sword"),
          (val_add, "$g_tutorial_training_ground_melee_state", 1),
          (store_mission_timer_a, "$g_tutorial_training_ground_melee_next_action_time"),
          (val_add, "$g_tutorial_training_ground_melee_next_action_time", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_melee_state", 1),
        (try_begin),
          (store_mission_timer_a, ":var5"),
          (gt, ":var5", "$g_tutorial_training_ground_melee_next_action_time"),
          (agent_set_team, ":var0", 1),
          (agent_set_team, ":var3", 2),
          (agent_get_position, pos1, ":var0"),
          (agent_set_scripted_destination_no_attack, ":var3", pos1),
          (agent_get_position, pos2, ":var3"),
          (get_sq_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 400),
          (try_begin),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 0),
            (try_begin),
              (ge, "$g_tutorial_training_ground_current_score", 5),
              (assign, "$g_tutorial_mouse_dir", -1),
              (assign, "$g_tutorial_mouse_click", -1),
              (tutorial_message, -1),
              (assign, "$g_tutorial_training_ground_melee_state", 0),
              (agent_set_team, ":var0", 0),
              (agent_set_team, ":var3", 7),
              (agent_set_hit_points, ":var0", 100, 0),
              (agent_set_hit_points, ":var3", 100, 0),
              (assign, "$g_tutorial_training_ground_conversation_state", 1),
              (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_parry"),
              (assign, "$g_tutorial_training_ground_melee_trainer_parry", -1),
            (else_try),
              (store_random_in_range, ":var7", 0, 4),
              (agent_set_attack_action, ":var3", ":var7", 1),
              (val_add, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
              (assign, "$g_tutorial_mouse_dir", ":var7"),
              (try_begin),
                (is_between, ":var7", 1, 3),
                (store_sub, "$g_tutorial_mouse_dir", 3, ":var7"),
              (try_end),
              (assign, "$g_tutorial_mouse_click", 1),
              (start_presentation, "prsnt_tutorial_show_mouse_movement"),
            (try_end),
          (else_try),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
            (agent_get_defend_action, ":var8", ":var0"),
            (gt, ":var8", 0),
            (agent_get_action_dir, ":var9", ":var0"),
            (agent_get_action_dir, ":var10", ":var3"),
            (assign, ":var11", 0),
            (try_begin),
              (eq, ":var10", 0),
              (eq, ":var9", 0),
              (assign, ":var11", 1),
            (else_try),
              (eq, ":var10", 3),
              (eq, ":var9", 3),
              (assign, ":var11", 1),
            (else_try),
              (eq, ":var10", 1),
              (eq, ":var9", 2),
              (assign, ":var11", 1),
            (else_try),
              (eq, ":var10", 2),
              (eq, ":var9", 1),
              (assign, ":var11", 1),
            (try_end),
            (eq, ":var11", 1),
            (assign, "$g_tutorial_mouse_dir", -1),
            (assign, "$g_tutorial_mouse_click", -1),
            (agent_set_attack_action, ":var3", 0, 0),
            (val_add, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
            (store_mission_timer_a, "$g_tutorial_training_ground_melee_trainer_next_action_time"),
            (val_add, "$g_tutorial_training_ground_melee_trainer_next_action_time", 2),
          (else_try),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 2),
            (try_begin),
              (store_mission_timer_a, ":var5"),
              (gt, ":var5", "$g_tutorial_training_ground_melee_trainer_next_action_time"),
              (assign, "$g_tutorial_training_ground_melee_trainer_action_state", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_is_in_parried_animation, ":var3"),
        (agent_get_wielded_item, ":var12", ":var0", 1),
        (eq, ":var12", -1),
        (agent_get_wielded_item, ":var13", ":var0", 0),
        (neq, ":var13", "itm_practice_dagger"),
        (call_script, "script_cf_is_melee_weapon_for_tutorial", ":var13"),
        (store_mission_timer_a, ":var5"),
        (gt, ":var5", "$g_tutorial_training_ground_next_score_time"),
        (val_add, "$g_tutorial_training_ground_current_score", 1),
        (try_begin),
          (lt, "$g_tutorial_training_ground_current_score", 5),
          (play_sound, "snd_tutorial_1"),
        (else_try),
          (play_sound, "snd_tutorial_2"),
        (try_end),
        (store_add, "$g_tutorial_training_ground_next_score_time", ":var5", 1),
      (try_end),
      (assign, reg0, "$g_tutorial_training_ground_current_score"),
      (try_begin),
        (agent_get_wielded_item, ":var12", ":var0", 1),
        (eq, ":var12", -1),
        (agent_get_wielded_item, ":var13", ":var0", 0),
        (neq, ":var13", "itm_practice_dagger"),
        (call_script, "script_cf_is_melee_weapon_for_tutorial", ":var13"),
        (tutorial_message, "str_tutorial_training_ground_parry_training"),
      (else_try),
        (neq, ":var12", -1),
        (tutorial_message, "str_tutorial_training_ground_warning_shield"),
      (else_try),
        (tutorial_message, "str_tutorial_training_ground_warning_melee_with_parry"),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (neq, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
      (mission_disable_talk),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (eq, ":var2", "$g_tutorial_training_ground_melee_trainer_chamber"),
        (assign, ":var3", ":var1"),
      (try_end),
      (try_begin),
        (eq, "$g_tutorial_training_ground_melee_state", 0),
        (try_begin),
          (try_for_agents, ":var1"),
            (agent_get_troop_id, ":var2", ":var1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_2"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_3"),
            (eq, ":var2", "trp_tutorial_fighter_4"),
            (agent_set_team, ":var1", 7),
            (agent_get_slot, ":var4", ":var1", 8),
            (entry_point_get_position, pos1, ":var4"),
            (agent_set_scripted_destination, ":var1", pos1),
            (agent_force_rethink, ":var1"),
          (try_end),
          (agent_set_wielded_item, ":var3", "itm_practice_sword"),
          (val_add, "$g_tutorial_training_ground_melee_state", 1),
          (store_mission_timer_a, "$g_tutorial_training_ground_melee_next_action_time"),
          (val_add, "$g_tutorial_training_ground_melee_next_action_time", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_melee_state", 1),
        (try_begin),
          (store_mission_timer_a, ":var5"),
          (gt, ":var5", "$g_tutorial_training_ground_melee_next_action_time"),
          (agent_set_team, ":var0", 1),
          (agent_set_team, ":var3", 2),
          (agent_get_position, pos1, ":var0"),
          (agent_set_scripted_destination_no_attack, ":var3", pos1),
          (agent_get_position, pos2, ":var3"),
          (get_sq_distance_between_positions, ":var6", pos1, pos2),
          (lt, ":var6", 400),
          (try_begin),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 0),
            (try_begin),
              (ge, "$g_tutorial_training_ground_current_score", 5),
              (tutorial_message, -1),
              (assign, "$g_tutorial_training_ground_melee_state", 0),
              (agent_set_team, ":var0", 0),
              (agent_set_team, ":var3", 7),
              (agent_set_hit_points, ":var0", 100, 0),
              (agent_set_hit_points, ":var3", 100, 0),
              (assign, "$g_tutorial_training_ground_conversation_state", 6),
              (start_mission_conversation, "$g_tutorial_training_ground_melee_trainer_chamber"),
              (assign, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
            (else_try),
              (store_random_in_range, "$g_tutorial_training_ground_melee_trainer_attack_dir", 0, 4),
              (agent_set_attack_action, ":var3", "$g_tutorial_training_ground_melee_trainer_attack_dir", 1),
              (val_add, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
              (store_mission_timer_a, "$g_tutorial_training_ground_melee_trainer_next_action_time"),
              (val_add, "$g_tutorial_training_ground_melee_trainer_next_action_time", 1),
            (try_end),
          (else_try),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
            (try_begin),
              (store_mission_timer_a, ":var5"),
              (gt, ":var5", "$g_tutorial_training_ground_melee_trainer_next_action_time"),
              (agent_set_attack_action, ":var3", -1, 0),
              (agent_set_defend_action, ":var3", 0, 1),
              (val_add, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
              (store_mission_timer_a, "$g_tutorial_training_ground_melee_trainer_next_action_time"),
              (val_add, "$g_tutorial_training_ground_melee_trainer_next_action_time", 1),
            (try_end),
          (else_try),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 2),
            (try_begin),
              (store_mission_timer_a, ":var5"),
              (gt, ":var5", "$g_tutorial_training_ground_melee_trainer_next_action_time"),
              (agent_set_attack_action, ":var3", "$g_tutorial_training_ground_melee_trainer_attack_dir", 0),
              (val_add, "$g_tutorial_training_ground_melee_trainer_action_state", 1),
              (store_mission_timer_a, "$g_tutorial_training_ground_melee_trainer_next_action_time"),
              (val_add, "$g_tutorial_training_ground_melee_trainer_next_action_time", 2),
            (try_end),
          (else_try),
            (eq, "$g_tutorial_training_ground_melee_trainer_action_state", 3),
            (try_begin),
              (store_mission_timer_a, ":var5"),
              (gt, ":var5", "$g_tutorial_training_ground_melee_trainer_next_action_time"),
              (assign, "$g_tutorial_training_ground_melee_trainer_action_state", 0),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (agent_is_in_parried_animation, ":var3"),
        (agent_get_attack_action, ":var7", ":var0"),
        (store_mission_timer_a, ":var5"),
        (gt, ":var5", "$g_tutorial_training_ground_next_score_time"),
        (store_add, "$g_tutorial_training_ground_next_score_time", ":var5", 1),
        (eq, ":var7", 1),
        (val_add, "$g_tutorial_training_ground_current_score", 1),
        (try_begin),
          (lt, "$g_tutorial_training_ground_current_score", 5),
          (play_sound, "snd_tutorial_1"),
        (else_try),
          (play_sound, "snd_tutorial_2"),
        (try_end),
      (try_end),
      (assign, reg0, "$g_tutorial_training_ground_current_score"),
      (tutorial_message, "str_tutorial_training_ground_chamber_training"),
    ],
    []),

    (0, 0, 0, 
    [
      (get_player_agent_no, ":var0"),
      (neq, "$g_tutorial_training_ground_melee_trainer_combat", -1),
      (mission_disable_talk),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (eq, ":var2", "$g_tutorial_training_ground_melee_trainer_combat"),
        (assign, ":var3", ":var1"),
      (try_end),
      (try_begin),
        (eq, "$g_tutorial_training_ground_melee_state", 0),
        (try_begin),
          (try_for_agents, ":var1"),
            (agent_get_troop_id, ":var2", ":var1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_1"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_2"),
            (this_or_next|eq, ":var2", "trp_tutorial_fighter_3"),
            (eq, ":var2", "trp_tutorial_fighter_4"),
            (agent_set_team, ":var1", 7),
            (agent_get_slot, ":var4", ":var1", 8),
            (entry_point_get_position, pos1, ":var4"),
            (agent_set_scripted_destination, ":var1", pos1),
            (agent_force_rethink, ":var1"),
          (try_end),
          (agent_set_wielded_item, ":var3", "itm_practice_sword"),
          (val_add, "$g_tutorial_training_ground_melee_state", 1),
          (store_mission_timer_a, "$g_tutorial_training_ground_melee_next_action_time"),
          (val_add, "$g_tutorial_training_ground_melee_next_action_time", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_melee_state", 1),
        (try_begin),
          (store_mission_timer_a, ":var5"),
          (gt, ":var5", "$g_tutorial_training_ground_melee_next_action_time"),
          (agent_set_team, ":var0", 1),
          (agent_set_team, ":var3", 2),
          (agent_clear_scripted_mode, ":var3"),
          (agent_force_rethink, ":var3"),
        (try_end),
      (try_end),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$g_tutorial_training_ground_melee_trainer_attack", -1),
      (eq, "$g_tutorial_training_ground_melee_trainer_parry", -1),
      (eq, "$g_tutorial_training_ground_melee_trainer_combat", -1),
      (eq, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
      (eq, "$g_tutorial_training_ground_archer_trainer_state", 0),
      (eq, "$g_tutorial_training_ground_horseman_trainer_state", 0),
      (mission_enable_talk),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$g_tutorial_training_ground_melee_trainer_attack", -1),
      (eq, "$g_tutorial_training_ground_melee_trainer_parry", -1),
      (eq, "$g_tutorial_training_ground_melee_trainer_combat", -1),
      (eq, "$g_tutorial_training_ground_melee_trainer_chamber", -1),
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var1", 10000000),
      (try_for_agents, ":var2"),
        (agent_get_troop_id, ":var3", ":var2"),
        (this_or_next|eq, ":var3", "trp_tutorial_fighter_1"),
        (this_or_next|eq, ":var3", "trp_tutorial_fighter_2"),
        (this_or_next|eq, ":var3", "trp_tutorial_fighter_3"),
        (eq, ":var3", "trp_tutorial_fighter_4"),
        (agent_get_position, pos2, ":var2"),
        (get_sq_distance_between_positions, ":var4", pos1, pos2),
        (lt, ":var4", ":var1"),
        (assign, ":var1", ":var4"),
      (try_end),
      (try_begin),
        (le, ":var1", 1600),
        (assign, "$g_tutorial_training_ground_melee_paused", 1),
        (try_for_agents, ":var2"),
          (agent_get_troop_id, ":var3", ":var2"),
          (this_or_next|eq, ":var3", "trp_tutorial_fighter_1"),
          (this_or_next|eq, ":var3", "trp_tutorial_fighter_2"),
          (this_or_next|eq, ":var3", "trp_tutorial_fighter_3"),
          (eq, ":var3", "trp_tutorial_fighter_4"),
          (agent_set_team, ":var2", 7),
          (agent_get_position, pos2, ":var2"),
          (agent_set_scripted_destination, ":var2", pos2),
          (try_begin),
            (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
            (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_2"),
            (agent_set_wielded_item, ":var2", -1),
          (try_end),
          (agent_force_rethink, ":var2"),
          (agent_set_look_target_agent, ":var2", ":var0"),
        (try_end),
      (else_try),
        (gt, "$g_tutorial_training_ground_melee_paused", 0),
        (assign, "$g_tutorial_training_ground_melee_paused", 0),
        (assign, "$g_tutorial_training_ground_melee_state", 0),
      (try_end),
      (try_begin),
        (eq, "$g_tutorial_training_ground_melee_paused", 0),
        (eq, "$g_tutorial_training_ground_melee_state", 0),
        (try_begin),
          (assign, "$g_tutorial_training_ground_melee_cur_fighter_1", -1),
          (assign, "$g_tutorial_training_ground_melee_cur_fighter_2", -1),
          (try_for_range, ":var5", 0, 2),
            (try_begin),
              (ge, "$g_tutorial_training_ground_melee_last_winner", 0),
              (assign, "$g_tutorial_training_ground_melee_cur_fighter_1", "$g_tutorial_training_ground_melee_last_winner"),
              (assign, "$g_tutorial_training_ground_melee_last_winner", -1),
            (try_end),
            (this_or_next|eq, "$g_tutorial_training_ground_melee_cur_fighter_1", -1),
            (eq, "$g_tutorial_training_ground_melee_cur_fighter_2", -1),
            (assign, ":var6", 0),
            (try_for_agents, ":var2"),
              (agent_get_troop_id, ":var3", ":var2"),
              (this_or_next|eq, ":var3", "trp_tutorial_fighter_1"),
              (this_or_next|eq, ":var3", "trp_tutorial_fighter_2"),
              (this_or_next|eq, ":var3", "trp_tutorial_fighter_3"),
              (eq, ":var3", "trp_tutorial_fighter_4"),
              (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
              (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_2"),
              (neq, ":var2", "$g_tutorial_training_ground_melee_last_loser"),
              (val_add, ":var6", 1),
            (try_end),
            (store_random_in_range, ":var7", 0, ":var6"),
            (try_for_agents, ":var2"),
              (agent_get_troop_id, ":var3", ":var2"),
              (this_or_next|eq, ":var3", "trp_tutorial_fighter_1"),
              (this_or_next|eq, ":var3", "trp_tutorial_fighter_2"),
              (this_or_next|eq, ":var3", "trp_tutorial_fighter_3"),
              (eq, ":var3", "trp_tutorial_fighter_4"),
              (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
              (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_2"),
              (neq, ":var2", "$g_tutorial_training_ground_melee_last_loser"),
              (val_sub, ":var7", 1),
              (lt, ":var7", 0),
              (try_begin),
                (eq, "$g_tutorial_training_ground_melee_cur_fighter_1", -1),
                (assign, "$g_tutorial_training_ground_melee_cur_fighter_1", ":var2"),
              (else_try),
                (assign, "$g_tutorial_training_ground_melee_cur_fighter_2", ":var2"),
              (try_end),
            (try_end),
          (try_end),
          (try_for_agents, ":var2"),
            (agent_get_troop_id, ":var3", ":var2"),
            (this_or_next|eq, ":var3", "trp_tutorial_fighter_1"),
            (this_or_next|eq, ":var3", "trp_tutorial_fighter_2"),
            (this_or_next|eq, ":var3", "trp_tutorial_fighter_3"),
            (eq, ":var3", "trp_tutorial_fighter_4"),
            (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
            (neq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_2"),
            (agent_set_wielded_item, ":var2", -1),
          (try_end),
          (val_add, "$g_tutorial_training_ground_melee_state", 1),
          (store_mission_timer_a, "$g_tutorial_training_ground_melee_next_action_time"),
          (val_add, "$g_tutorial_training_ground_melee_next_action_time", 3),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_melee_state", 1),
        (try_begin),
          (store_mission_timer_a, ":var8"),
          (gt, ":var8", "$g_tutorial_training_ground_melee_next_action_time"),
          (try_for_agents, ":var2"),
            (agent_is_human, ":var2"),
            (agent_get_troop_id, ":var3", ":var2"),
            (this_or_next|eq, ":var3", "trp_tutorial_fighter_1"),
            (this_or_next|eq, ":var3", "trp_tutorial_fighter_2"),
            (this_or_next|eq, ":var3", "trp_tutorial_fighter_3"),
            (eq, ":var3", "trp_tutorial_fighter_4"),
            (try_begin),
              (eq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
              (entry_point_get_position, pos1, 30),
              (agent_set_scripted_destination, ":var2", pos1),
            (else_try),
              (eq, ":var2", "$g_tutorial_training_ground_melee_cur_fighter_2"),
              (entry_point_get_position, pos1, 31),
              (agent_set_scripted_destination, ":var2", pos1),
            (else_try),
              (agent_get_slot, ":var9", ":var2", 8),
              (entry_point_get_position, pos1, ":var9"),
              (agent_set_scripted_destination, ":var2", pos1),
            (try_end),
          (try_end),
          (val_add, "$g_tutorial_training_ground_melee_state", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_melee_state", 2),
        (try_begin),
          (agent_set_look_target_agent, "$g_tutorial_training_ground_melee_cur_fighter_1", "$g_tutorial_training_ground_melee_cur_fighter_2"),
          (agent_set_look_target_agent, "$g_tutorial_training_ground_melee_cur_fighter_2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
          (agent_get_position, pos1, "$g_tutorial_training_ground_melee_cur_fighter_1"),
          (entry_point_get_position, pos2, 30),
          (get_sq_distance_between_positions, ":var10", pos1, pos2),
          (lt, ":var10", 400),
          (agent_get_position, pos1, "$g_tutorial_training_ground_melee_cur_fighter_2"),
          (entry_point_get_position, pos2, 31),
          (get_sq_distance_between_positions, ":var11", pos1, pos2),
          (lt, ":var11", 400),
          (val_add, "$g_tutorial_training_ground_melee_state", 1),
          (store_mission_timer_a, "$g_tutorial_training_ground_melee_next_action_time"),
          (val_add, "$g_tutorial_training_ground_melee_next_action_time", 1),
        (try_end),
      (else_try),
        (eq, "$g_tutorial_training_ground_melee_state", 3),
        (try_begin),
          (agent_set_look_target_agent, "$g_tutorial_training_ground_melee_cur_fighter_1", "$g_tutorial_training_ground_melee_cur_fighter_2"),
          (agent_set_look_target_agent, "$g_tutorial_training_ground_melee_cur_fighter_2", "$g_tutorial_training_ground_melee_cur_fighter_1"),
          (store_mission_timer_a, ":var8"),
          (gt, ":var8", "$g_tutorial_training_ground_melee_next_action_time"),
          (agent_clear_scripted_mode, "$g_tutorial_training_ground_melee_cur_fighter_1"),
          (agent_clear_scripted_mode, "$g_tutorial_training_ground_melee_cur_fighter_2"),
          (agent_set_team, "$g_tutorial_training_ground_melee_cur_fighter_1", 1),
          (agent_set_team, "$g_tutorial_training_ground_melee_cur_fighter_2", 2),
          (agent_force_rethink, "$g_tutorial_training_ground_melee_cur_fighter_1"),
          (agent_force_rethink, "$g_tutorial_training_ground_melee_cur_fighter_2"),
          (val_add, "$g_tutorial_training_ground_melee_state", 1),
        (try_end),
      (try_end),
    ],
    []),

  ]),

  ("tutorial_1", 0, -1,
  "You enter the training ground.",
  [
    (0, mtef_no_companions|mtef_no_regulars, af_override_everything, 0, 1, [itm_tutorial_shield,itm_tutorial_sword,itm_tutorial_short_bow,itm_tutorial_arrows,itm_leather_jerkin,itm_leather_boots]),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_1_state", 5),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (tutorial_message_set_size, 17, 17),
      (tutorial_message_set_position, pos500, pos650),
      (tutorial_message_set_center_justify, 0),
      (assign, "$tutorial_1_state", 0),
      (assign, "$tutorial_1_msg_1_displayed", 0),
      (assign, "$tutorial_1_msg_2_displayed", 0),
      (assign, "$tutorial_1_msg_3_displayed", 0),
      (assign, "$tutorial_1_msg_4_displayed", 0),
      (assign, "$tutorial_1_msg_5_displayed", 0),
      (assign, "$tutorial_1_msg_6_displayed", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_1_state", 0),
        (try_begin),
          (eq, "$tutorial_1_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_1_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_1_msg_1"),
          (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
          (entry_point_get_position, pos1, 1),
          (prop_instance_animate_to_position, ":var1", pos1, 1),
        (try_end),
        (tutorial_message, "str_tutorial_1_msg_1"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos1, ":var2"),
        (entry_point_get_position, pos2, 1),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 100),
        (val_add, "$tutorial_1_state", 1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (entry_point_get_position, pos1, 2),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
      (else_try),
        (eq, "$tutorial_1_state", 1),
        (try_begin),
          (eq, "$tutorial_1_msg_2_displayed", 0),
          (assign, "$tutorial_1_msg_2_displayed", 1),
          (tutorial_message, "str_tutorial_1_msg_2"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos1, ":var2"),
        (entry_point_get_position, pos2, 2),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 100),
        (val_add, "$tutorial_1_state", 1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (entry_point_get_position, pos1, 3),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
      (else_try),
        (eq, "$tutorial_1_state", 2),
        (try_begin),
          (eq, "$tutorial_1_msg_3_displayed", 0),
          (assign, "$tutorial_1_msg_3_displayed", 1),
          (tutorial_message, "str_tutorial_1_msg_3"),
          (assign, "$tutorial_num_total_dummies_destroyed", 0),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (ge, "$tutorial_num_total_dummies_destroyed", 4),
        (val_add, "$tutorial_1_state", 1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 2),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
      (else_try),
        (eq, "$tutorial_1_state", 3),
        (try_begin),
          (eq, "$tutorial_1_msg_4_displayed", 0),
          (assign, "$tutorial_1_msg_4_displayed", 1),
          (tutorial_message, "str_tutorial_1_msg_4"),
          (store_mission_timer_a, "$tutorial_time"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (store_mission_timer_a, ":var0"),
        (val_sub, ":var0", "$tutorial_time"),
        (gt, ":var0", 10),
        (val_add, "$tutorial_1_state", 1),
      (else_try),
        (eq, "$tutorial_1_state", 4),
        (try_begin),
          (eq, "$tutorial_1_msg_5_displayed", 0),
          (assign, "$tutorial_1_msg_5_displayed", 1),
          (tutorial_message, "str_tutorial_1_msg_5"),
          (assign, "$g_last_archery_point_earned", 0),
          (assign, "$tutorial_num_arrows_hit", 0),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (try_begin),
          (get_player_agent_no, ":var2"),
          (agent_get_ammo, ":var5", ":var2"),
          (le, ":var5", 0),
          (agent_refill_ammo, ":var2"),
          (tutorial_message, "str_tutorial_ammo_refilled"),
        (try_end),
        (gt, "$g_last_archery_point_earned", 0),
        (assign, "$g_last_archery_point_earned", 0),
        (val_add, "$tutorial_num_arrows_hit", 1),
        (gt, "$tutorial_num_arrows_hit", 2),
        (val_add, "$tutorial_1_state", 1),
      (else_try),
        (eq, "$tutorial_1_state", 5),
        (eq, "$tutorial_1_msg_6_displayed", 0),
        (assign, "$tutorial_1_msg_6_displayed", 1),
        (tutorial_message, "str_tutorial_1_msg_6"),
        (play_sound, "snd_tutorial_2"),
        (assign, "$tutorial_1_finished", 1),
      (try_end),
    ],
    []),

  ]),

  ("tutorial_2", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_no_companions|mtef_no_regulars, af_override_everything, 0, 1, [itm_tutorial_shield,itm_leather_jerkin,itm_leather_boots]),
    (2, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_1|mtef_visitor_source, 0, 0, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_2_state", 9),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 2),
      (main_hero_fallen),
      (assign, "$tutorial_2_state", 100),
    ],
    []),

    (0, 0, ti_once, 
    [
      (tutorial_message_set_size, 17, 17),
      (tutorial_message_set_position, pos500, pos650),
      (tutorial_message_set_center_justify, 0),
      (assign, "$tutorial_2_state", 0),
      (assign, "$tutorial_2_msg_1_displayed", 0),
      (assign, "$tutorial_2_msg_2_displayed", 0),
      (assign, "$tutorial_2_msg_3_displayed", 0),
      (assign, "$tutorial_2_msg_4_displayed", 0),
      (assign, "$tutorial_2_msg_5_displayed", 0),
      (assign, "$tutorial_2_msg_6_displayed", 0),
      (assign, "$tutorial_2_msg_7_displayed", 0),
      (assign, "$tutorial_2_msg_8_displayed", 0),
      (assign, "$tutorial_2_msg_9_displayed", 0),
      (assign, "$tutorial_2_melee_agent_state", 0),
    ],
    []),

    (10, 0, 0, 
    [
      (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_archer"),
      (agent_refill_ammo, reg0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_2_state", 0),
        (try_begin),
          (eq, "$tutorial_2_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_2_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_2_msg_1"),
          (team_give_order, 1, 9, 11),
          (team_give_order, 1, 0, 2),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (agent_get_position, pos1, ":var1"),
          (agent_set_scripted_destination, ":var1", pos1, 0),
        (try_end),
        (get_player_agent_no, ":var2"),
        (ge, ":var2", 0),
        (agent_get_position, pos1, ":var2"),
        (entry_point_get_position, pos2, 1),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 200),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 1),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 0),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (position_is_behind_position, pos2, pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 2),
        (get_player_agent_no, ":var2"),
        (agent_set_kick_allowed, ":var2", 0),
        (try_begin),
          (eq, "$tutorial_2_melee_agent_state", 0),
          (val_add, "$tutorial_2_melee_agent_state", 1),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (entry_point_get_position, pos1, 3),
          (agent_set_scripted_destination, ":var1", pos1, 0),
        (else_try),
          (eq, "$tutorial_2_melee_agent_state", 1),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (entry_point_get_position, pos1, 3),
          (agent_get_position, pos2, ":var1"),
          (get_distance_between_positions, ":var3", pos1, pos2),
          (le, ":var3", 250),
          (agent_clear_scripted_mode, ":var1"),
          (val_add, "$tutorial_2_melee_agent_state", 1),
          (store_mission_timer_a, "$tutorial_time"),
        (else_try),
          (eq, "$tutorial_2_melee_agent_state", 2),
          (try_begin),
            (eq, "$tutorial_2_msg_2_displayed", 0),
            (assign, "$tutorial_2_msg_2_displayed", 1),
            (play_sound, "snd_tutorial_1"),
          (try_end),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (store_mission_timer_a, ":var0"),
          (val_sub, ":var0", "$tutorial_time"),
          (store_sub, reg3, 20, ":var0"),
          (tutorial_message, "str_tutorial_2_msg_2"),
          (gt, ":var0", 20),
          (entry_point_get_position, pos1, 3),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (val_add, "$tutorial_2_melee_agent_state", 1),
        (else_try),
          (eq, "$tutorial_2_melee_agent_state", 3),
          (try_begin),
            (eq, "$tutorial_2_msg_3_displayed", 0),
            (assign, "$tutorial_2_msg_3_displayed", 1),
            (tutorial_message, "str_tutorial_2_msg_3"),
            (play_sound, "snd_tutorial_1"),
          (try_end),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (entry_point_get_position, pos1, 3),
          (agent_get_position, pos2, ":var1"),
          (get_distance_between_positions, ":var3", pos1, pos2),
          (le, ":var3", 250),
          (entry_point_get_position, pos1, 2),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (val_add, "$tutorial_2_melee_agent_state", 1),
        (else_try),
          (eq, "$tutorial_2_melee_agent_state", 4),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (entry_point_get_position, pos1, 2),
          (agent_get_position, pos2, ":var1"),
          (get_distance_between_positions, ":var3", pos1, pos2),
          (le, ":var3", 250),
          (entry_point_get_position, pos1, 30),
          (agent_set_position, ":var1", pos1),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 1),
          (prop_instance_get_position, pos1, ":var4"),
          (position_rotate_z, pos1, 90),
          (prop_instance_animate_to_position, ":var4", pos1, 150),
          (val_add, "$tutorial_2_melee_agent_state", 1),
          (val_add, "$tutorial_2_state", 1),
        (try_end),
      (else_try),
        (eq, "$tutorial_2_state", 3),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 1),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_set_kick_allowed, ":var2", 1),
        (agent_get_position, pos2, ":var2"),
        (position_is_behind_position, pos2, pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (store_mission_timer_a, "$tutorial_time"),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 4),
        (try_begin),
          (eq, "$tutorial_2_msg_4_displayed", 0),
          (assign, "$tutorial_2_msg_4_displayed", 1),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (store_mission_timer_a, ":var0"),
        (val_sub, ":var0", "$tutorial_time"),
        (store_sub, reg3, 20, ":var0"),
        (tutorial_message, "str_tutorial_2_msg_4"),
        (gt, ":var0", 20),
        (entry_point_get_position, pos1, 5),
        (set_spawn_position, pos1),
        (spawn_item, "itm_tutorial_sword"),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 3),
        (agent_set_position, ":var1", pos1),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 2),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 5),
        (try_begin),
          (eq, "$tutorial_2_msg_5_displayed", 0),
          (assign, "$tutorial_2_msg_5_displayed", 1),
          (tutorial_message, "str_tutorial_2_msg_5"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 2),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (position_is_behind_position, pos2, pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 2),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 6),
        (try_begin),
          (eq, "$tutorial_2_msg_6_displayed", 0),
          (assign, "$tutorial_2_msg_6_displayed", 1),
          (tutorial_message, "str_tutorial_2_msg_6"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var2"),
        (agent_has_item_equipped, ":var2", "itm_tutorial_sword"),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 3),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 7),
        (try_begin),
          (eq, "$tutorial_2_msg_7_displayed", 0),
          (assign, "$tutorial_2_msg_7_displayed", 1),
          (tutorial_message, "str_tutorial_2_msg_7"),
          (play_sound, "snd_tutorial_1"),
          (get_player_agent_no, ":var2"),
          (agent_set_hit_points, ":var2", 100),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_archer"),
        (assign, ":var1", reg0),
        (neg|agent_is_alive, ":var1"),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (agent_clear_scripted_mode, ":var1"),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_a", 4),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 8),
        (try_begin),
          (eq, "$tutorial_2_msg_8_displayed", 0),
          (assign, "$tutorial_2_msg_8_displayed", 1),
          (tutorial_message, "str_tutorial_2_msg_8"),
          (play_sound, "snd_tutorial_1"),
          (get_player_agent_no, ":var2"),
          (agent_set_hit_points, ":var2", 100),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (neg|agent_is_alive, ":var1"),
        (val_add, "$tutorial_2_state", 1),
      (else_try),
        (eq, "$tutorial_2_state", 9),
        (eq, "$tutorial_2_msg_9_displayed", 0),
        (assign, "$tutorial_2_msg_9_displayed", 1),
        (tutorial_message, "str_tutorial_2_msg_9"),
        (play_sound, "snd_tutorial_2"),
        (assign, "$tutorial_2_finished", 1),
      (else_try),
        (gt, "$tutorial_2_state", 30),
        (tutorial_message, "str_tutorial_failed"),
      (try_end),
    ],
    []),

  ]),

  ("tutorial_3", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_no_companions|mtef_no_regulars, af_override_everything, 0, 1, [itm_leather_jerkin,itm_leather_boots]),
    (3, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_3_state", 12),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 2),
      (main_hero_fallen),
      (assign, "$tutorial_3_state", 100),
    ],
    []),

    (0, 0, ti_once, 
    [
      (tutorial_message_set_size, 17, 17),
      (tutorial_message_set_position, pos500, pos650),
      (tutorial_message_set_center_justify, 0),
      (assign, "$tutorial_3_state", 0),
      (assign, "$tutorial_3_msg_1_displayed", 0),
      (assign, "$tutorial_3_msg_2_displayed", 0),
      (assign, "$tutorial_3_msg_3_displayed", 0),
      (assign, "$tutorial_3_msg_4_displayed", 0),
      (assign, "$tutorial_3_msg_5_displayed", 0),
      (assign, "$tutorial_3_msg_6_displayed", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_3_state", 0),
        (try_begin),
          (eq, "$tutorial_3_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_3_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_3_msg_1"),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (agent_get_position, pos1, ":var1"),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
          (assign, ":var1", reg0),
          (agent_get_position, pos1, ":var1"),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (entry_point_get_position, pos1, 1),
          (set_spawn_position, pos1),
          (spawn_item, "itm_tutorial_staff_no_attack"),
        (try_end),
        (get_player_agent_no, ":var2"),
        (ge, ":var2", 0),
        (agent_has_item_equipped, ":var2", "itm_tutorial_staff_no_attack"),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 1),
        (try_begin),
          (eq, "$tutorial_3_msg_2_displayed", 0),
          (assign, "$tutorial_3_msg_2_displayed", 1),
          (tutorial_message, "str_tutorial_3_msg_2"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos1, ":var2"),
        (entry_point_get_position, pos2, 2),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 200),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 2),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 0),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (position_is_behind_position, pos2, pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 3),
        (get_player_agent_no, ":var2"),
        (agent_set_kick_allowed, ":var2", 0),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 4),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 4),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 4),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (agent_clear_scripted_mode, ":var1"),
        (val_add, "$tutorial_3_state", 1),
        (store_mission_timer_a, "$tutorial_time"),
      (else_try),
        (eq, "$tutorial_3_state", 5),
        (try_begin),
          (eq, "$tutorial_3_msg_3_displayed", 0),
          (assign, "$tutorial_3_msg_3_displayed", 1),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (store_mission_timer_a, ":var0"),
        (val_sub, ":var0", "$tutorial_time"),
        (store_sub, reg3, 20, ":var0"),
        (tutorial_message, "str_tutorial_3_msg_3"),
        (gt, ":var0", 20),
        (entry_point_get_position, pos1, 4),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 6),
        (try_begin),
          (eq, "$tutorial_3_msg_4_displayed", 0),
          (assign, "$tutorial_3_msg_4_displayed", 1),
          (tutorial_message, "str_tutorial_3_msg_4"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 4),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (entry_point_get_position, pos1, 3),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 7),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 3),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (entry_point_get_position, pos1, 7),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (agent_set_position, ":var1", pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 3),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 8),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 1),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (position_is_behind_position, pos2, pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 9),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 6),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 10),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 6),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (agent_clear_scripted_mode, ":var1"),
        (val_add, "$tutorial_3_state", 1),
        (store_mission_timer_a, "$tutorial_time"),
      (else_try),
        (eq, "$tutorial_3_state", 11),
        (try_begin),
          (eq, "$tutorial_3_msg_5_displayed", 0),
          (assign, "$tutorial_3_msg_5_displayed", 1),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (assign, ":var1", reg0),
        (store_mission_timer_a, ":var0"),
        (val_sub, ":var0", "$tutorial_time"),
        (store_sub, reg3, 20, ":var0"),
        (tutorial_message, "str_tutorial_3_msg_5"),
        (gt, ":var0", 20),
        (entry_point_get_position, pos1, 6),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 12),
        (try_begin),
          (eq, "$tutorial_3_msg_6_displayed", 0),
          (assign, "$tutorial_3_msg_6_displayed", 1),
          (tutorial_message, "str_tutorial_3_msg_6"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 6),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (entry_point_get_position, pos1, 5),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 13),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (assign, ":var1", reg0),
        (entry_point_get_position, pos1, 5),
        (agent_get_position, pos2, ":var1"),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 250),
        (entry_point_get_position, pos1, 7),
        (agent_set_scripted_destination, ":var1", pos1, 0),
        (agent_set_position, ":var1", pos1),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (gt, "$tutorial_3_state", 30),
        (tutorial_message, "str_tutorial_failed"),
      (try_end),
    ],
    []),

  ]),

  ("tutorial_3_2", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_no_companions|mtef_no_regulars, af_override_everything, 0, 1, [itm_tutorial_staff,itm_leather_jerkin,itm_leather_boots]),
    (4, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_3_state", 5),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 2),
      (main_hero_fallen),
      (assign, "$tutorial_3_state", 100),
    ],
    []),

    (0, 0, ti_once, 
    [
      (tutorial_message_set_size, 17, 17),
      (tutorial_message_set_position, pos500, pos650),
      (tutorial_message_set_center_justify, 0),
      (assign, "$tutorial_3_state", 0),
      (assign, "$tutorial_3_msg_1_displayed", 0),
      (assign, "$tutorial_3_msg_2_displayed", 0),
      (assign, "$tutorial_3_msg_3_displayed", 0),
      (assign, "$tutorial_3_msg_4_displayed", 0),
      (assign, "$tutorial_3_msg_5_displayed", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_3_state", 0),
        (try_begin),
          (eq, "$tutorial_3_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_3_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_3_2_msg_1"),
          (play_sound, "snd_tutorial_1"),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
          (assign, ":var1", reg0),
          (agent_get_position, pos1, ":var1"),
          (agent_set_scripted_destination, ":var1", pos1, 0),
          (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
          (assign, ":var1", reg0),
          (agent_get_position, pos1, ":var1"),
          (agent_set_scripted_destination, ":var1", pos1, 0),
        (try_end),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos1, ":var2"),
        (entry_point_get_position, pos2, 2),
        (get_distance_between_positions, ":var3", pos1, pos2),
        (le, ":var3", 200),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 1),
        (try_begin),
          (eq, "$tutorial_3_msg_2_displayed", 0),
          (assign, "$tutorial_3_msg_2_displayed", 1),
          (tutorial_message, "str_tutorial_3_2_msg_2"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 0),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (position_is_behind_position, pos2, pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 0),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (agent_clear_scripted_mode, reg0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 2),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_maceman"),
        (neg|agent_is_alive, reg0),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 3),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, -90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 3),
        (try_begin),
          (eq, "$tutorial_3_msg_3_displayed", 0),
          (assign, "$tutorial_3_msg_3_displayed", 1),
          (tutorial_message, "str_tutorial_3_2_msg_3"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (scene_prop_get_instance, ":var5", "spr_barrier_4m", 1),
        (prop_instance_get_position, pos1, ":var5"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos2, ":var2"),
        (position_is_behind_position, pos2, pos1),
        (scene_prop_get_instance, ":var4", "spr_tutorial_door_b", 1),
        (prop_instance_get_position, pos1, ":var4"),
        (position_rotate_z, pos1, 90),
        (prop_instance_animate_to_position, ":var4", pos1, 150),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (agent_clear_scripted_mode, reg0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 4),
        (try_begin),
          (eq, "$tutorial_3_msg_4_displayed", 0),
          (assign, "$tutorial_3_msg_4_displayed", 1),
          (tutorial_message, "str_tutorial_3_2_msg_4"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_get_first_agent_with_troop_id", "trp_tutorial_swordsman"),
        (neg|agent_is_alive, reg0),
        (val_add, "$tutorial_3_state", 1),
      (else_try),
        (eq, "$tutorial_3_state", 5),
        (eq, "$tutorial_3_msg_5_displayed", 0),
        (assign, "$tutorial_3_msg_5_displayed", 1),
        (tutorial_message, "str_tutorial_3_2_msg_5"),
        (play_sound, "snd_tutorial_2"),
        (assign, "$tutorial_3_finished", 1),
      (else_try),
        (gt, "$tutorial_3_state", 30),
        (tutorial_message, "str_tutorial_failed"),
      (try_end),
    ],
    []),

  ]),

  ("tutorial_4", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_no_companions|mtef_no_regulars, af_override_everything, 0, 1, [itm_tutorial_sword,itm_tutorial_short_bow,itm_tutorial_arrows,itm_leather_jerkin,itm_leather_boots]),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_4_state", 11),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (scene_set_day_time, 13),
    ]),

    (0, 0, ti_once, 
    [
      (tutorial_message_set_size, 17, 17),
      (tutorial_message_set_position, pos500, pos650),
      (tutorial_message_set_center_justify, 0),
      (assign, "$tutorial_4_state", 0),
      (assign, "$tutorial_4_msg_1_displayed", 0),
      (assign, "$tutorial_4_msg_2_displayed", 0),
      (assign, "$tutorial_4_msg_3_displayed", 0),
      (assign, "$tutorial_4_msg_4_displayed", 0),
      (assign, "$tutorial_4_msg_5_displayed", 0),
      (assign, "$tutorial_4_msg_6_displayed", 0),
      (assign, "$tutorial_4_msg_7_displayed", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_4_state", 0),
        (try_begin),
          (eq, "$tutorial_4_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_4_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_1"),
          (entry_point_get_position, pos1, 1),
          (set_spawn_position, pos1),
          (spawn_horse, "itm_tutorial_saddle_horse"),
          (assign, "$tutorial_num_total_dummies_destroyed", 0),
        (try_end),
        (get_player_agent_no, ":var1"),
        (agent_get_horse, ":var2", ":var1"),
        (ge, ":var2", 0),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 2),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 1),
        (try_begin),
          (eq, "$tutorial_4_msg_2_displayed", 0),
          (assign, "$tutorial_4_msg_2_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_2"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 2),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 3),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 2),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 3),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 4),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 3),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 4),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 5),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 4),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 5),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 6),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 5),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 6),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 1),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 6),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 1),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 7),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 7),
        (try_begin),
          (eq, "$tutorial_4_msg_3_displayed", 0),
          (assign, "$tutorial_4_msg_3_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_3"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 7),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 20),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 8),
        (try_begin),
          (eq, "$tutorial_4_msg_4_displayed", 0),
          (assign, "$tutorial_4_msg_4_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_4"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (ge, "$tutorial_num_total_dummies_destroyed", 2),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 8),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 9),
        (try_begin),
          (eq, "$tutorial_4_msg_5_displayed", 0),
          (assign, "$tutorial_4_msg_5_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_5"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var1"),
        (agent_get_position, pos1, ":var1"),
        (entry_point_get_position, pos2, 8),
        (get_distance_between_positions, ":var4", pos1, pos2),
        (le, ":var4", 200),
        (val_add, "$tutorial_4_state", 1),
        (entry_point_get_position, pos1, 20),
        (scene_prop_get_instance, ":var3", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var3", pos1, 1),
      (else_try),
        (eq, "$tutorial_4_state", 10),
        (try_begin),
          (eq, "$tutorial_4_msg_6_displayed", 0),
          (assign, "$tutorial_4_msg_6_displayed", 1),
          (tutorial_message, "str_tutorial_4_msg_6"),
          (play_sound, "snd_tutorial_1"),
          (assign, "$g_last_archery_point_earned", 0),
          (assign, "$tutorial_num_arrows_hit", 0),
        (try_end),
        (try_begin),
          (get_player_agent_no, ":var1"),
          (agent_get_ammo, ":var5", ":var1"),
          (le, ":var5", 0),
          (agent_refill_ammo, ":var1"),
          (tutorial_message, "str_tutorial_ammo_refilled"),
        (try_end),
        (gt, "$g_last_archery_point_earned", 0),
        (assign, "$g_last_archery_point_earned", 0),
        (val_add, "$tutorial_num_arrows_hit", 1),
        (gt, "$tutorial_num_arrows_hit", 2),
        (val_add, "$tutorial_4_state", 1),
      (else_try),
        (eq, "$tutorial_4_state", 11),
        (eq, "$tutorial_4_msg_7_displayed", 0),
        (assign, "$tutorial_4_msg_7_displayed", 1),
        (tutorial_message, "str_tutorial_4_msg_7"),
        (play_sound, "snd_tutorial_2"),
        (assign, "$tutorial_4_finished", 1),
      (try_end),
    ],
    []),

  ]),

  ("tutorial_5", mtf_arena_fight, -1,
  "You enter the training ground.",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_everything, 0, 1, [itm_tutorial_sword,itm_tutorial_shield,itm_tutorial_short_bow,itm_tutorial_arrows,itm_tutorial_saddle_horse,itm_leather_jerkin,itm_leather_boots]),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (14, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (15, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (16, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (lt, "$tutorial_5_state", 5),
        (question_box, "str_do_you_wish_to_leave_tutorial"),
      (else_try),
        (finish_mission, 0),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (finish_mission, 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_tutorial"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 2),
      (main_hero_fallen),
      (assign, "$tutorial_5_state", 100),
    ],
    []),

    (0, 0, ti_once, 
    [
      (tutorial_message_set_size, 17, 17),
      (tutorial_message_set_position, pos500, pos650),
      (tutorial_message_set_center_justify, 0),
      (assign, "$tutorial_5_state", 0),
      (assign, "$tutorial_5_msg_1_displayed", 0),
      (assign, "$tutorial_5_msg_2_displayed", 0),
      (assign, "$tutorial_5_msg_3_displayed", 0),
      (assign, "$tutorial_5_msg_4_displayed", 0),
      (assign, "$tutorial_5_msg_5_displayed", 0),
      (assign, "$tutorial_5_msg_6_displayed", 0),
    ],
    []),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (team_give_order, 0, 9, 11),
      (set_show_messages, 1),
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 3),
    ],
    []),

    (0, 0, 0, 
    [
      (call_script, "script_cf_turn_windmill_fans", 0),
    ],
    []),

    (0, 0, 0, 
    [
      (try_begin),
        (eq, "$tutorial_5_state", 0),
        (try_begin),
          (eq, "$tutorial_5_msg_1_displayed", 0),
          (store_mission_timer_a, ":var0"),
          (gt, ":var0", 0),
          (assign, "$tutorial_5_msg_1_displayed", 1),
          (tutorial_message, "str_tutorial_5_msg_1"),
          (entry_point_get_position, pos1, 5),
          (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
          (prop_instance_animate_to_position, ":var1", pos1, 1),
        (try_end),
        (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", 0, 0),
        (entry_point_get_position, pos2, 5),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 1000),
        (val_add, "$tutorial_5_state", 1),
        (entry_point_get_position, pos1, 6),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_red", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
      (else_try),
        (eq, "$tutorial_5_state", 1),
        (try_begin),
          (eq, "$tutorial_5_msg_2_displayed", 0),
          (assign, "$tutorial_5_msg_2_displayed", 1),
          (tutorial_message, "str_tutorial_5_msg_2"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", 0, 0),
        (entry_point_get_position, pos2, 5),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 1000),
        (get_player_agent_no, ":var3"),
        (agent_get_position, pos1, ":var3"),
        (entry_point_get_position, pos2, 6),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 500),
        (val_add, "$tutorial_5_state", 1),
        (entry_point_get_position, pos1, 7),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (entry_point_get_position, pos1, 30),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_red", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
      (else_try),
        (eq, "$tutorial_5_state", 2),
        (try_begin),
          (eq, "$tutorial_5_msg_3_displayed", 0),
          (assign, "$tutorial_5_msg_3_displayed", 1),
          (tutorial_message, "str_tutorial_5_msg_3"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (get_player_agent_no, ":var3"),
        (agent_get_position, pos1, ":var3"),
        (entry_point_get_position, pos2, 7),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 500),
        (val_add, "$tutorial_5_state", 1),
        (modify_visitors_at_site, "scn_tutorial_5"),
        (reset_visitors),
        (set_visitor, 5, "trp_euro_archer_1"),
        (set_visitor, 6, "trp_euro_archer_2"),
        (set_visitor, 7, "trp_euro_xbow_3"),
        (entry_point_get_position, pos1, 11),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (entry_point_get_position, pos1, 12),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_red", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (set_show_messages, 0),
        (team_give_order, 0, 1, 11),
        (set_show_messages, 1),
      (else_try),
        (eq, "$tutorial_5_state", 3),
        (try_begin),
          (eq, "$tutorial_5_msg_4_displayed", 0),
          (assign, "$tutorial_5_msg_4_displayed", 1),
          (tutorial_message, "str_tutorial_5_msg_4"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", 0, 1),
        (entry_point_get_position, pos2, 11),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 1000),
        (call_script, "script_cf_team_get_average_position_of_agents_with_type_to_pos1", 0, 0),
        (entry_point_get_position, pos2, 12),
        (get_distance_between_positions, ":var2", pos1, pos2),
        (le, ":var2", 1000),
        (val_add, "$tutorial_5_state", 1),
        (entry_point_get_position, pos1, 30),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_red", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (modify_visitors_at_site, "scn_tutorial_5"),
        (reset_visitors),
        (set_visitor, 8, "trp_bandit"),
        (set_visitor, 9, "trp_bandit"),
        (set_visitor, 10, "trp_bandit"),
        (set_visitor, 11, "trp_bandit"),
        (team_give_order, 1, 9, 2),
      (else_try),
        (eq, "$tutorial_5_state", 4),
        (try_begin),
          (eq, "$tutorial_5_msg_5_displayed", 0),
          (assign, "$tutorial_5_msg_5_displayed", 1),
          (tutorial_message, "str_tutorial_5_msg_5"),
          (play_sound, "snd_tutorial_1"),
        (try_end),
        (assign, ":var4", 0),
        (try_for_agents, ":var5"),
          (agent_is_human, ":var5"),
          (agent_is_alive, ":var5"),
          (agent_get_team, ":var6", ":var5"),
          (eq, ":var6", 1),
          (val_add, ":var4", 1),
        (try_end),
        (eq, ":var4", 0),
        (val_add, "$tutorial_5_state", 1),
      (else_try),
        (eq, "$tutorial_5_state", 5),
        (eq, "$tutorial_5_msg_6_displayed", 0),
        (assign, "$tutorial_5_msg_6_displayed", 1),
        (tutorial_message, "str_tutorial_5_msg_6"),
        (play_sound, "snd_tutorial_2"),
        (assign, "$tutorial_5_finished", 1),
      (else_try),
        (gt, "$tutorial_5_state", 30),
        (tutorial_message, "str_tutorial_failed"),
        (entry_point_get_position, pos1, 30),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_yellow", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
        (scene_prop_get_instance, ":var1", "spr_tutorial_flag_red", 0),
        (prop_instance_animate_to_position, ":var1", pos1, 1),
      (try_end),
    ],
    []),

  ]),

  ("quick_battle_battle", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (neq, "$g_battle_result", 0),
        (call_script, "script_custom_battle_end"),
        (finish_mission),
      (else_try),
        (question_box, "str_give_up_fight"),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$g_battle_result", -1),
      (call_script, "script_custom_battle_end"),
      (finish_mission),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (scene_set_day_time, 15),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_result", 0),
      (call_script, "script_combat_music_set_situation_with_culture", 1024),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture", 1024),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 2),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
    ],
    [
      (call_script, "script_custom_battle_end"),
      (finish_mission, 1),
    ]),

    (5, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, "$g_battle_result", -1),
    ],
    [
      (call_script, "script_custom_battle_end"),
      (finish_mission),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$g_decap_enabled", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (agent_is_non_player, ":var0"),
      (agent_get_troop_id, ":var3", ":var0"),
      (neg|troop_is_hero, ":var3"),
      (assign, ":var4", reg0),
      (copy_position, 5, 0),
      (neq, ":var0", -1),
      (try_begin),
        (agent_is_human, ":var0"),
        (ge, ":var4", 0),
        (assign, ":var5", 0),
        (try_begin),
          (this_or_next|eq, ":var4", "itm_supercrossbow"),
          (eq, ":var4", "itm_supersledge"),
          (assign, ":var5", 1),
        (else_try),
          (neq, ":var4", "itm_mace_1"),
          (neq, ":var4", "itm_mace_2"),
          (neq, ":var4", "itm_mace_3"),
          (neq, ":var4", "itm_staff"),
          (agent_get_action_dir, ":var6", ":var1"),
          (this_or_next|eq, ":var6", 1),
          (eq, ":var6", 2),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var5", 0),
        (try_begin),
          (ge, ":var2", "$g_decap_minimum_damage"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap minimum DMG req bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (store_agent_hit_points, ":var7", ":var0", 1),
        (val_add, ":var7", "$g_decap_negative_health"),
        (ge, ":var2", ":var7"),
        (agent_get_position, pos4, ":var0"),
        (get_distance_between_positions, ":var8", pos4, pos5),
        (agent_get_horse, ":var9", ":var0"),
        (try_begin),
          (ge, ":var9", 0),
          (assign, ":var10", 240),
          (assign, ":var11", 260),
        (else_try),
          (assign, ":var10", 160),
          (assign, ":var11", 176),
        (try_end),
        (is_between, ":var8", ":var10", ":var11"),
        (assign, ":var5", 0),
        (try_begin),
          (store_random_in_range, ":var12", 0, 100),
          (le, ":var12", "$g_decap_chance"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap chance calc bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var13", "itm_cut_off_head_male"),
        (agent_get_troop_id, ":var14", ":var0"),
        (try_begin),
          (ge, ":var14", 0),
          (troop_get_type, ":var15", ":var14"),
          (eq, ":var15", 1),
          (assign, ":var13", "itm_cut_off_head_female"),
        (try_end),
        (store_random_in_range, ":var16", 0, 360),
        (store_random_in_range, ":var17", -60, 60),
        (store_random_in_range, ":var18", -90, 90),
        (store_random_in_range, ":var19", -90, 90),
        (position_rotate_z, pos4, ":var16"),
        (position_rotate_y, pos4, ":var17"),
        (position_move_x, 4, ":var18"),
        (position_move_y, pos4, ":var19"),
        (position_set_z_to_ground_level, pos4),
        (position_move_z, pos4, 5),
        (set_spawn_position, pos4),
        (assign, ":var20", 360),
        (agent_get_item_slot, ":var21", ":var0", 4),
        (try_begin),
          (ge, ":var21", 1),
          (agent_unequip_item, ":var0", ":var21"),
          (try_begin),
            (spawn_item, ":var21", 0, ":var20"),
          (try_end),
        (try_end),
        (agent_equip_item, ":var0", "itm_invisible_head"),
        (agent_get_position, pos4, ":var0"),
        (position_move_z, pos4, ":var10"),
        (particle_system_burst, "psys_blood_decapitation", pos4, "$g_decap_psys_blood_decapitation"),
        (particle_system_burst, "psys_game_blood", pos4, "$g_decap_psys_game_blood"),
        (particle_system_burst, "psys_game_blood_2", pos4, "$g_decap_psys_game_blood_2"),
        (play_sound_at_position, "snd_decapitation", pos4),
        (position_move_z, pos4, 20),
        (set_spawn_position, pos4),
        (assign, ":var13", "spr_head_dynamic_male"),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var13", "spr_head_dynamic_female"),
        (try_end),
        (spawn_scene_prop, ":var13"),
        (agent_get_troop_id, ":var22", ":var1"),
        (str_store_troop_name, s0, ":var22"),
        (agent_get_troop_id, ":var14", ":var0"),
        (str_store_troop_name, s1, ":var14"),
        (get_player_agent_no, ":var23"),
        (agent_get_team, ":var24", ":var23"),
        (agent_get_team, ":var25", ":var0"),
        (try_begin),
          (neq, ":var24", ":var25"),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFF33DD11),
        (else_try),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFFFF4422),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_bully_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_fat_peasant_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_thug_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_fatseveredarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_thin_looter_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (0, 0, 1, 
    [
      (key_clicked, key_right_control),
    ],
    [
      (try_begin),
        (key_is_down, key_m),
        (try_begin),
          (eq, "$g_decapitations_debugging", 0),
          (assign, "$g_decapitations_debugging", 1),
          (display_message, "@Decapitation debug mode Enabled"),
        (else_try),
          (assign, "$g_decapitations_debugging", 0),
          (display_message, "@Decapitation debug mode Disabled"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, key_k),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos17, ":var0"),
        (position_move_y, pos17, 2000),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_bully_handless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_thug_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_thin_looter_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_fat_peasant_handless"),
        (agent_set_team, reg0, 2),
      (try_end),
      (try_begin),
        (key_is_down, key_j),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos18, ":var0"),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supersledge"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supercrossbow"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_super_bolts"),
      (try_end),
    ]),

  ]),

  ("quick_battle_siege", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (16, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (17, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (18, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (19, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (20, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (21, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (22, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (23, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (24, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (25, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (26, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (27, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (28, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (29, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (30, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (31, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (32, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (33, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (34, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (35, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (36, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (37, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (38, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (39, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (40, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (47, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (scene_set_day_time, 15),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (neq, "$g_battle_result", 0),
        (call_script, "script_custom_battle_end"),
        (finish_mission),
      (else_try),
        (question_box, "str_give_up_fight"),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$g_battle_result", -1),
      (call_script, "script_custom_battle_end"),
      (finish_mission),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_result", 0),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture", 262144),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 2),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
    ],
    [
      (call_script, "script_custom_battle_end"),
      (finish_mission, 1),
    ]),

    (5, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, "$g_battle_result", -1),
    ],
    [
      (call_script, "script_custom_battle_end"),
      (finish_mission),
    ]),

    (120, 0, 0, 
    [],
    [
      (display_message, "@Refilling defender ammo..."),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (this_or_next|eq, ":var1", "$defender_team"),
        (eq, ":var1", "$defender_team_2"),
        (agent_refill_ammo, ":var0"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (call_script, "script_siege_init_ai_and_belfry"),
    ],
    []),

    (0, 0, ti_once, 
    [
      (call_script, "script_cf_siege_move_belfry"),
    ],
    [
      (call_script, "script_siege_rot_belfry_platform"),
    ]),

    (4, 0, ti_once, 
    [
      (call_script, "script_cf_siege_assign_men_to_belfry"),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_active, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_clear_scripted_mode, ":var0"),
        (agent_ai_set_always_attack_in_melee, ":var0", 0),
        (agent_set_speed_limit, ":var0", 100),
      (try_end),
      (set_show_messages, 0),
      (team_give_order, "$attacker_team", 9, 2),
      (team_give_order, "$attacker_team", 9, 15),
      (set_show_messages, 1),
    ]),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (entry_point_get_position, pos10, 10),
      (try_for_range, ":var0", 0, 9),
        (neq, ":var0", 1),
        (team_give_order, "$defender_team", ":var0", 0),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 0),
        (team_give_order, "$defender_team_2", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 7),
      (try_end),
      (team_give_order, "$defender_team", 1, 11),
      (team_set_order_position, "$defender_team", 9, pos10),
      (team_give_order, "$defender_team_2", 1, 11),
      (team_set_order_position, "$defender_team_2", 9, pos10),
      (team_give_order, "$attacker_team", 9, 2),
      (team_give_order, "$attacker_team_2", 9, 2),
      (set_show_messages, 1),
    ],
    []),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$g_decap_enabled", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (agent_is_non_player, ":var0"),
      (agent_get_troop_id, ":var3", ":var0"),
      (neg|troop_is_hero, ":var3"),
      (assign, ":var4", reg0),
      (copy_position, 5, 0),
      (neq, ":var0", -1),
      (try_begin),
        (agent_is_human, ":var0"),
        (ge, ":var4", 0),
        (assign, ":var5", 0),
        (try_begin),
          (this_or_next|eq, ":var4", "itm_supercrossbow"),
          (eq, ":var4", "itm_supersledge"),
          (assign, ":var5", 1),
        (else_try),
          (neq, ":var4", "itm_mace_1"),
          (neq, ":var4", "itm_mace_2"),
          (neq, ":var4", "itm_mace_3"),
          (neq, ":var4", "itm_staff"),
          (agent_get_action_dir, ":var6", ":var1"),
          (this_or_next|eq, ":var6", 1),
          (eq, ":var6", 2),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var5", 0),
        (try_begin),
          (ge, ":var2", "$g_decap_minimum_damage"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap minimum DMG req bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (store_agent_hit_points, ":var7", ":var0", 1),
        (val_add, ":var7", "$g_decap_negative_health"),
        (ge, ":var2", ":var7"),
        (agent_get_position, pos4, ":var0"),
        (get_distance_between_positions, ":var8", pos4, pos5),
        (agent_get_horse, ":var9", ":var0"),
        (try_begin),
          (ge, ":var9", 0),
          (assign, ":var10", 240),
          (assign, ":var11", 260),
        (else_try),
          (assign, ":var10", 160),
          (assign, ":var11", 176),
        (try_end),
        (is_between, ":var8", ":var10", ":var11"),
        (assign, ":var5", 0),
        (try_begin),
          (store_random_in_range, ":var12", 0, 100),
          (le, ":var12", "$g_decap_chance"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap chance calc bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var13", "itm_cut_off_head_male"),
        (agent_get_troop_id, ":var14", ":var0"),
        (try_begin),
          (ge, ":var14", 0),
          (troop_get_type, ":var15", ":var14"),
          (eq, ":var15", 1),
          (assign, ":var13", "itm_cut_off_head_female"),
        (try_end),
        (store_random_in_range, ":var16", 0, 360),
        (store_random_in_range, ":var17", -60, 60),
        (store_random_in_range, ":var18", -90, 90),
        (store_random_in_range, ":var19", -90, 90),
        (position_rotate_z, pos4, ":var16"),
        (position_rotate_y, pos4, ":var17"),
        (position_move_x, 4, ":var18"),
        (position_move_y, pos4, ":var19"),
        (position_set_z_to_ground_level, pos4),
        (position_move_z, pos4, 5),
        (set_spawn_position, pos4),
        (assign, ":var20", 360),
        (agent_get_item_slot, ":var21", ":var0", 4),
        (try_begin),
          (ge, ":var21", 1),
          (agent_unequip_item, ":var0", ":var21"),
          (try_begin),
            (spawn_item, ":var21", 0, ":var20"),
          (try_end),
        (try_end),
        (agent_equip_item, ":var0", "itm_invisible_head"),
        (agent_get_position, pos4, ":var0"),
        (position_move_z, pos4, ":var10"),
        (particle_system_burst, "psys_blood_decapitation", pos4, "$g_decap_psys_blood_decapitation"),
        (particle_system_burst, "psys_game_blood", pos4, "$g_decap_psys_game_blood"),
        (particle_system_burst, "psys_game_blood_2", pos4, "$g_decap_psys_game_blood_2"),
        (play_sound_at_position, "snd_decapitation", pos4),
        (position_move_z, pos4, 20),
        (set_spawn_position, pos4),
        (assign, ":var13", "spr_head_dynamic_male"),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var13", "spr_head_dynamic_female"),
        (try_end),
        (spawn_scene_prop, ":var13"),
        (agent_get_troop_id, ":var22", ":var1"),
        (str_store_troop_name, s0, ":var22"),
        (agent_get_troop_id, ":var14", ":var0"),
        (str_store_troop_name, s1, ":var14"),
        (get_player_agent_no, ":var23"),
        (agent_get_team, ":var24", ":var23"),
        (agent_get_team, ":var25", ":var0"),
        (try_begin),
          (neq, ":var24", ":var25"),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFF33DD11),
        (else_try),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFFFF4422),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_bully_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_fat_peasant_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_thug_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_fatseveredarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_thin_looter_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (0, 0, 1, 
    [
      (key_clicked, key_right_control),
    ],
    [
      (try_begin),
        (key_is_down, key_m),
        (try_begin),
          (eq, "$g_decapitations_debugging", 0),
          (assign, "$g_decapitations_debugging", 1),
          (display_message, "@Decapitation debug mode Enabled"),
        (else_try),
          (assign, "$g_decapitations_debugging", 0),
          (display_message, "@Decapitation debug mode Disabled"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, key_k),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos17, ":var0"),
        (position_move_y, pos17, 2000),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_bully_handless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_thug_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_thin_looter_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_fat_peasant_handless"),
        (agent_set_team, reg0, 2),
      (try_end),
      (try_begin),
        (key_is_down, key_j),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos18, ":var0"),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supersledge"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supercrossbow"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_super_bolts"),
      (try_end),
    ]),

  ]),

  ("multiplayer_dm", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (34, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (1, 5, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_multiplayer_game_type", 0),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (multiplayer_make_everyone_enemy),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_destroy_mod_targets"),
      (call_script, "script_multiplayer_remove_headquarters_flags"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (set_spawn_effector_scene_prop_kind, 0, -1),
      (set_spawn_effector_scene_prop_kind, 1, -1),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (try_begin),
        (multiplayer_get_my_player, ":var0"),
        (is_between, ":var0", 0, 1000),
        (player_get_team_no, ":var1", ":var0"),
        (lt, ":var1", 2),
        (player_get_kill_count, ":var2", ":var0"),
        (player_get_death_count, ":var3", ":var0"),
        (store_mul, ":var4", ":var2", 1000),
        (val_sub, ":var4", ":var3"),
        (assign, ":var5", 1),
        (get_max_players, ":var6"),
        (assign, ":var7", ":var6"),
        (try_for_range, ":var8", 0, ":var7"),
          (player_is_active, ":var8"),
          (player_get_team_no, ":var9", ":var8"),
          (this_or_next|eq, ":var9", 0),
          (eq, ":var9", 1),
          (player_get_kill_count, ":var2", ":var8"),
          (player_get_death_count, ":var3", ":var8"),
          (store_mul, ":var10", ":var2", 1000),
          (val_sub, ":var10", ":var3"),
          (gt, ":var10", ":var4"),
          (assign, ":var5", 0),
          (assign, ":var7", 0),
        (try_end),
        (eq, ":var5", 1),
        (unlock_achievement, 68),
      (try_end),
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart_deathmatch"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (get_max_players, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (player_is_active, ":var1"),
        (neg|player_is_busy_with_menus, ":var1"),
        (player_get_team_no, ":var2", ":var1"),
        (lt, ":var2", 2),
        (player_get_troop_id, ":var3", ":var1"),
        (ge, ":var3", 0),
        (player_get_agent_id, ":var4", ":var1"),
        (assign, ":var5", 0),
        (try_begin),
          (player_get_slot, ":var6", ":var1", 24),
          (eq, ":var6", 1),
          (assign, ":var5", 1),
          (player_set_slot, ":var1", 24, 0),
        (else_try),
          (try_begin),
            (lt, ":var4", 0),
            (assign, ":var5", 1),
          (else_try),
            (neg|agent_is_alive, ":var4"),
            (agent_get_time_elapsed_since_removed, ":var7", ":var4"),
            (gt, ":var7", "$g_multiplayer_respawn_period"),
            (assign, ":var5", 1),
          (try_end),
        (try_end),
        (eq, ":var5", 1),
        (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
        (troop_get_inventory_slot, ":var8", ":var3", ek_horse),
        (try_begin),
          (ge, ":var8", 0),
          (assign, ":var9", 1),
        (else_try),
          (assign, ":var9", 0),
        (try_end),
        (call_script, "script_multiplayer_find_spawn_point", ":var2", 0, ":var9"),
        (player_spawn_new_agent, ":var1", reg0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_agents, ":var3"),
        (agent_is_non_player, ":var3"),
        (agent_is_human, ":var3"),
        (assign, ":var4", 0),
        (try_begin),
          (agent_is_alive, ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (agent_get_time_elapsed_since_removed, ":var5", ":var3"),
          (le, ":var5", "$g_multiplayer_respawn_period"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (agent_get_team, ":var6", ":var3"),
        (try_begin),
          (eq, ":var6", 0),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var6", 1),
          (val_add, ":var2", 1),
        (try_end),
      (try_end),
      (store_sub, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1", ":var1"),
      (store_sub, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2", ":var2"),
      (val_max, "$g_multiplayer_num_bots_required_team_1", 0),
      (val_max, "$g_multiplayer_num_bots_required_team_2", 0),
    ]),

    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (store_random_in_range, ":var1", 0, ":var0"),
        (val_sub, ":var1", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var2", 0),
          (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
        (else_try),
          (assign, ":var2", 1),
          (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
        (try_end),
        (team_get_faction, ":var3", ":var2"),
        (assign, ":var4", 0),
        (try_for_range, ":var5", "trp_swadian_crossbowman_multiplayer_ai", "trp_swadian_crossbowman_multiplayer"),
          (store_faction_of_troop, ":var6", ":var5"),
          (eq, ":var6", ":var3"),
          (val_add, ":var4", 1),
        (try_end),
        (store_random_in_range, ":var7", 0, ":var4"),
        (assign, ":var8", "trp_swadian_crossbowman_multiplayer"),
        (try_for_range, ":var5", "trp_swadian_crossbowman_multiplayer_ai", ":var8"),
          (store_faction_of_troop, ":var6", ":var5"),
          (eq, ":var6", ":var3"),
          (val_sub, ":var7", 1),
          (lt, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", ":var5"),
        (try_end),
        (troop_get_inventory_slot, ":var10", ":var9", ek_horse),
        (try_begin),
          (ge, ":var10", 0),
          (assign, ":var11", 1),
        (else_try),
          (assign, ":var11", 0),
        (try_end),
        (call_script, "script_multiplayer_find_spawn_point", ":var2", 0, ":var11"),
        (store_current_scene, ":var12"),
        (modify_visitors_at_site, ":var12"),
        (add_visitors_to_current_scene, reg0, ":var9", 1, ":var2", -1),
        (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (assign, ":var0", 0),
      (try_begin),
        (store_mission_timer_a, ":var1"),
        (store_mul, ":var2", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var1", ":var2"),
        (assign, ":var0", 1),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart_deathmatch"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|is_presentation_active, "prsnt_multiplayer_escape_menu"),
      (neg|is_presentation_active, "prsnt_multiplayer_stats_chart_deathmatch"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

  ]),

  ("multiplayer_tdm", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (34, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (1, 5, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_multiplayer_game_type", 1),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_destroy_mod_targets"),
      (call_script, "script_multiplayer_remove_headquarters_flags"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (set_spawn_effector_scene_prop_kind, 0, -1),
      (set_spawn_effector_scene_prop_kind, 1, -1),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (try_begin),
        (multiplayer_get_my_player, ":var0"),
        (is_between, ":var0", 0, 1000),
        (player_get_team_no, ":var1", ":var0"),
        (lt, ":var1", 2),
        (team_get_score, ":var2", 0),
        (team_get_score, ":var3", 1),
        (assign, ":var4", 0),
        (try_begin),
          (eq, ":var1", 0),
          (gt, ":var2", ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (eq, ":var1", 1),
          (gt, ":var3", ":var2"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (unlock_achievement, 67),
      (try_end),
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
      (try_begin),
        (ge, ":var1", 0),
        (agent_is_human, ":var0"),
        (agent_is_human, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (le, ":var2", 1),
        (agent_get_team, ":var3", ":var0"),
        (neq, ":var2", ":var3"),
        (team_get_score, ":var4", ":var2"),
        (val_add, ":var4", 1),
        (team_set_score, ":var2", ":var4"),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (get_max_players, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (player_is_active, ":var1"),
        (neg|player_is_busy_with_menus, ":var1"),
        (player_get_team_no, ":var2", ":var1"),
        (lt, ":var2", 2),
        (player_get_troop_id, ":var3", ":var1"),
        (ge, ":var3", 0),
        (player_get_agent_id, ":var4", ":var1"),
        (assign, ":var5", 0),
        (try_begin),
          (player_get_slot, ":var6", ":var1", 24),
          (eq, ":var6", 1),
          (assign, ":var5", 1),
          (player_set_slot, ":var1", 24, 0),
        (else_try),
          (try_begin),
            (lt, ":var4", 0),
            (assign, ":var5", 1),
          (else_try),
            (neg|agent_is_alive, ":var4"),
            (agent_get_time_elapsed_since_removed, ":var7", ":var4"),
            (gt, ":var7", "$g_multiplayer_respawn_period"),
            (assign, ":var5", 1),
          (try_end),
        (try_end),
        (eq, ":var5", 1),
        (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
        (troop_get_inventory_slot, ":var8", ":var3", ek_horse),
        (try_begin),
          (ge, ":var8", 0),
          (assign, ":var9", 1),
        (else_try),
          (assign, ":var9", 0),
        (try_end),
        (call_script, "script_multiplayer_find_spawn_point", ":var2", 1, ":var9"),
        (player_spawn_new_agent, ":var1", reg0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_agents, ":var3"),
        (agent_is_non_player, ":var3"),
        (agent_is_human, ":var3"),
        (assign, ":var4", 0),
        (try_begin),
          (agent_is_alive, ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (agent_get_time_elapsed_since_removed, ":var5", ":var3"),
          (le, ":var5", "$g_multiplayer_respawn_period"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (agent_get_team, ":var6", ":var3"),
        (try_begin),
          (eq, ":var6", 0),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var6", 1),
          (val_add, ":var2", 1),
        (try_end),
      (try_end),
      (store_sub, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1", ":var1"),
      (store_sub, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2", ":var2"),
      (val_max, "$g_multiplayer_num_bots_required_team_1", 0),
      (val_max, "$g_multiplayer_num_bots_required_team_2", 0),
    ]),

    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (this_or_next|eq, "$g_multiplayer_game_type", 3),
          (eq, "$g_multiplayer_game_type", 6),
          (team_get_score, ":var1", 0),
          (team_get_score, ":var2", 1),
          (store_add, ":var3", ":var1", ":var2"),
          (eq, ":var3", 0),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (lt, ":var4", 20),
          (assign, ":var5", 0),
        (else_try),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 0, ":var0"),
        (val_sub, ":var6", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var6", 0),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var7", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (eq, "$g_multiplayer_game_type", 3),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (try_begin),
            (le, ":var4", 20),
            (assign, ":var8", 0),
          (else_try),
            (assign, ":var8", 1),
          (try_end),
        (else_try),
          (assign, ":var8", 1),
        (try_end),
        (call_script, "script_multiplayer_find_bot_troop_and_group_for_spawn", ":var7", ":var8"),
        (assign, ":var9", reg0),
        (assign, ":var10", reg1),
        (team_get_faction, ":var11", ":var7"),
        (assign, ":var12", 0),
        (try_for_range, ":var13", "trp_swadian_crossbowman_multiplayer_ai", "trp_swadian_crossbowman_multiplayer"),
          (store_faction_of_troop, ":var14", ":var13"),
          (eq, ":var14", ":var11"),
          (val_add, ":var12", 1),
        (try_end),
        (assign, ":var15", 0),
        (get_max_players, ":var16"),
        (try_for_range, ":var17", 0, ":var16"),
          (player_is_active, ":var17"),
          (player_get_team_no, ":var18", ":var17"),
          (eq, ":var7", ":var18"),
          (assign, ":var19", 0),
          (store_add, ":var20", 35, ":var12"),
          (try_for_range, ":var21", 35, ":var20"),
            (player_slot_ge, ":var17", ":var21", 1),
            (assign, ":var19", 1),
            (assign, ":var20", 0),
          (try_end),
          (ge, ":var19", 1),
          (val_add, ":var15", 1),
        (try_end),
        (try_begin),
          (this_or_next|ge, ":var10", 0),
          (eq, ":var15", 0),
          (troop_get_inventory_slot, ":var22", ":var9", ek_horse),
          (try_begin),
            (ge, ":var22", 0),
            (assign, ":var23", 1),
          (else_try),
            (assign, ":var23", 0),
          (try_end),
          (try_begin),
            (eq, "$g_multiplayer_game_type", 6),
            (store_mission_timer_a, ":var4"),
            (val_sub, ":var4", "$g_round_start_time"),
            (try_begin),
              (lt, ":var4", 20),
              (try_begin),
                (eq, ":var7", 0),
                (call_script, "script_multiplayer_find_spawn_point", ":var7", 1, ":var23"),
              (else_try),
                (assign, reg0, 32),
              (try_end),
            (else_try),
              (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
            (try_end),
          (else_try),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (try_begin),
              (eq, ":var7", 0),
              (assign, reg0, 0),
            (else_try),
              (assign, reg0, 32),
            (try_end),
          (else_try),
            (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
          (try_end),
          (store_current_scene, ":var24"),
          (modify_visitors_at_site, ":var24"),
          (add_visitors_to_current_scene, reg0, ":var9", 1, ":var7", ":var10"),
          (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
          (try_begin),
            (eq, ":var7", 0),
            (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
          (else_try),
            (eq, ":var7", 1),
            (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (3, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (try_for_agents, ":var0"),
        (agent_is_non_player, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_group, ":var1", ":var0"),
        (try_begin),
          (neg|player_is_active, ":var1"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (else_try),
          (player_get_team_no, ":var2", ":var1"),
          (agent_get_team, ":var3", ":var0"),
          (neq, ":var2", ":var3"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (try_end),
      (try_end),
    ]),

    (20, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (call_script, "script_check_team_balance"),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (assign, ":var0", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_game_type", 2),
        (this_or_next|eq, "$g_multiplayer_game_type", 3),
        (eq, "$g_multiplayer_game_type", 6),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (store_mission_timer_a, ":var1"),
          (val_sub, ":var1", "$g_round_finish_time"),
          (store_sub, ":var2", "$g_multiplayer_respawn_period", 1),
          (ge, ":var1", ":var2"),
          (store_mission_timer_a, ":var3"),
          (try_begin),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (assign, ":var4", 90),
          (else_try),
            (assign, ":var4", 120),
          (try_end),
          (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
          (store_sub, ":var6", ":var5", ":var4"),
          (gt, ":var3", ":var6"),
          (assign, ":var0", 1),
        (try_end),
        (eq, ":var0", 1),
      (else_try),
        (neq, "$g_multiplayer_game_type", 2),
        (neq, "$g_multiplayer_game_type", 3),
        (neq, "$g_multiplayer_game_type", 6),
        (neq, "$g_multiplayer_game_type", 5),
        (store_mission_timer_a, ":var3"),
        (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var3", ":var5"),
        (assign, ":var0", 1),
      (else_try),
        (team_get_score, ":var7", 0),
        (team_get_score, ":var8", 1),
        (try_begin),
          (neq, "$g_multiplayer_game_type", 5),
          (try_begin),
            (this_or_next|ge, ":var7", "$g_multiplayer_game_max_points"),
            (ge, ":var8", "$g_multiplayer_game_max_points"),
            (assign, ":var0", 1),
          (try_end),
        (else_try),
          (assign, ":var9", 0),
          (get_max_players, ":var10"),
          (try_for_range, ":var11", 0, ":var10"),
            (player_is_active, ":var11"),
            (player_get_agent_id, ":var12", ":var11"),
            (ge, ":var12", 0),
            (neg|agent_is_non_player, ":var12"),
            (assign, ":var9", 1),
            (assign, ":var10", 0),
          (try_end),
          (eq, ":var9", 1),
          (this_or_next|le, ":var7", 0),
          (le, ":var8", 0),
          (assign, ":var0", 1),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_team_score_display"),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|is_presentation_active, "prsnt_multiplayer_escape_menu"),
      (neg|is_presentation_active, "prsnt_multiplayer_stats_chart"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

  ]),

  ("multiplayer_hq", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (34, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (1, 5, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_multiplayer_game_type", 5),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (store_mul, ":var0", "$g_multiplayer_game_max_points", 10000),
      (assign, "$g_score_team_1", ":var0"),
      (assign, "$g_score_team_2", ":var0"),
      (try_for_range, ":var1", 146, 156),
        (troop_set_slot, "trp_multiplayer_data", ":var1", -1),
      (try_end),
      (try_begin),
        (multiplayer_is_server),
        (try_for_range, ":var1", 176, 186),
          (troop_set_slot, "trp_multiplayer_data", ":var1", -1),
        (try_end),
      (try_end),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_destroy_mod_targets"),
      (try_begin),
        (multiplayer_is_server),
        (team_set_score, 0, "$g_multiplayer_game_max_points"),
        (team_set_score, 1, "$g_multiplayer_game_max_points"),
      (try_end),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_determine_team_flags", 0),
      (call_script, "script_determine_team_flags", 1),
      (set_spawn_effector_scene_prop_kind, 0, "$team_1_flag_scene_prop"),
      (set_spawn_effector_scene_prop_kind, 1, "$team_2_flag_scene_prop"),
      (try_begin),
        (multiplayer_is_server),
        (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
        (assign, "$g_number_of_flags", 0),
        (entry_point_get_position, pos1, 64),
        (entry_point_get_position, pos3, 64),
        (set_spawn_position, pos3),
        (spawn_scene_prop, "spr_headquarters_pole_code_only", 0),
        (set_spawn_position, pos3),
        (spawn_scene_prop, "$team_1_flag_scene_prop", 0),
        (set_spawn_position, pos3),
        (spawn_scene_prop, "$team_2_flag_scene_prop", 0),
        (set_spawn_position, pos3),
        (spawn_scene_prop, "spr_headquarters_flag_gray_code_only", 0),
        (store_add, ":var0", 146, "$g_number_of_flags"),
        (troop_set_slot, "trp_multiplayer_data", ":var0", 1),
        (val_add, "$g_number_of_flags", 1),
        (entry_point_get_position, pos2, 65),
        (entry_point_get_position, pos3, 65),
        (set_spawn_position, pos3),
        (spawn_scene_prop, "spr_headquarters_pole_code_only", 0),
        (set_spawn_position, pos3),
        (spawn_scene_prop, "$team_1_flag_scene_prop", 0),
        (set_spawn_position, pos3),
        (spawn_scene_prop, "$team_2_flag_scene_prop", 0),
        (set_spawn_position, pos3),
        (spawn_scene_prop, "spr_headquarters_flag_gray_code_only", 0),
        (store_add, ":var0", 146, "$g_number_of_flags"),
        (troop_set_slot, "trp_multiplayer_data", ":var0", 2),
        (val_add, "$g_number_of_flags", 1),
        (scene_prop_get_num_instances, ":var1", "spr_headquarters_flag_red"),
        (scene_prop_get_num_instances, ":var2", "spr_headquarters_flag_blue"),
        (scene_prop_get_num_instances, ":var3", "spr_headquarters_flag_gray"),
        (store_add, ":var4", "spr_headquarters_flag_gray", 1),
        (try_for_range, ":var5", "spr_headquarters_flag_red", ":var4"),
          (try_begin),
            (eq, ":var5", "spr_headquarters_flag_red"),
            (assign, ":var6", ":var1"),
          (else_try),
            (eq, ":var5", "spr_headquarters_flag_blue"),
            (assign, ":var6", ":var2"),
          (else_try),
            (eq, ":var5", "spr_headquarters_flag_gray"),
            (assign, ":var6", ":var3"),
          (try_end),
          (gt, ":var6", 0),
          (try_for_range, ":var7", 0, ":var6"),
            (scene_prop_get_instance, ":var8", ":var5", ":var7"),
            (prop_instance_get_position, pos0, ":var8"),
            (set_spawn_position, pos0),
            (spawn_scene_prop, "spr_headquarters_pole_code_only", 0),
            (try_for_range, ":var9", "spr_headquarters_flag_red", ":var4"),
              (set_spawn_position, pos0),
              (try_begin),
                (eq, ":var9", "spr_headquarters_flag_red"),
                (spawn_scene_prop, "$team_1_flag_scene_prop"),
              (else_try),
                (eq, ":var9", "spr_headquarters_flag_blue"),
                (spawn_scene_prop, "$team_2_flag_scene_prop"),
              (else_try),
                (eq, ":var9", "spr_headquarters_flag_gray"),
                (spawn_scene_prop, "spr_headquarters_flag_gray_code_only"),
              (try_end),
            (try_end),
            (store_add, ":var0", 146, "$g_number_of_flags"),
            (try_begin),
              (eq, ":var5", "spr_headquarters_flag_red"),
              (troop_set_slot, "trp_multiplayer_data", ":var0", 1),
            (else_try),
              (eq, ":var5", "spr_headquarters_flag_blue"),
              (troop_set_slot, "trp_multiplayer_data", ":var0", 2),
            (else_try),
              (eq, ":var5", "spr_headquarters_flag_gray"),
              (troop_set_slot, "trp_multiplayer_data", ":var0", 0),
            (try_end),
            (val_add, "$g_number_of_flags", 1),
          (try_end),
        (try_end),
        (assign, "$g_number_of_initial_team_1_flags", 0),
        (assign, "$g_number_of_initial_team_2_flags", 0),
        (try_for_range, ":var10", 0, "$g_number_of_flags"),
          (store_add, ":var0", 146, ":var10"),
          (troop_get_slot, ":var11", "trp_multiplayer_data", ":var0"),
          (try_begin),
            (eq, ":var10", 0),
            (entry_point_get_position, pos0, 64),
            (scene_prop_get_instance, ":var8", "$team_1_flag_scene_prop", ":var10"),
            (assign, "$g_base_flag_team_1", ":var8"),
          (else_try),
            (eq, ":var10", 1),
            (entry_point_get_position, pos0, 65),
            (scene_prop_get_instance, ":var8", "$team_2_flag_scene_prop", ":var10"),
            (assign, "$g_base_flag_team_2", ":var8"),
          (else_try),
            (assign, ":var12", 2),
            (scene_prop_get_num_instances, ":var13", "spr_headquarters_flag_red"),
            (store_add, ":var14", ":var12", ":var13"),
            (scene_prop_get_num_instances, ":var15", "spr_headquarters_flag_blue"),
            (store_add, ":var16", ":var14", ":var15"),
            (scene_prop_get_num_instances, ":var17", "spr_headquarters_flag_gray"),
            (try_begin),
              (ge, ":var10", ":var12"),
              (gt, ":var13", 0),
              (store_sub, ":var18", ":var10", ":var12"),
              (scene_prop_get_instance, ":var8", "spr_headquarters_flag_red", ":var18"),
            (else_try),
              (ge, ":var10", ":var14"),
              (gt, ":var15", 0),
              (store_sub, ":var18", ":var10", ":var14"),
              (scene_prop_get_instance, ":var8", "spr_headquarters_flag_blue", ":var18"),
            (else_try),
              (ge, ":var10", ":var16"),
              (gt, ":var17", 0),
              (store_sub, ":var18", ":var10", ":var16"),
              (scene_prop_get_instance, ":var8", "spr_headquarters_flag_gray", ":var18"),
            (try_end),
            (prop_instance_get_position, pos0, ":var8"),
          (try_end),
          (scene_prop_get_instance, ":var19", "spr_headquarters_pole_code_only", ":var10"),
          (prop_instance_set_position, ":var19", pos0),
          (position_move_z, pos0, 900),
          (try_begin),
            (eq, ":var11", 0),
            (scene_prop_get_instance, ":var8", "$team_1_flag_scene_prop", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (scene_prop_set_visibility, ":var8", 0),
            (scene_prop_get_instance, ":var8", "$team_2_flag_scene_prop", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (scene_prop_set_visibility, ":var8", 0),
            (scene_prop_get_instance, ":var8", "spr_headquarters_flag_gray_code_only", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (scene_prop_set_visibility, ":var8", 1),
          (else_try),
            (eq, ":var11", 1),
            (scene_prop_get_instance, ":var8", "$team_1_flag_scene_prop", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (scene_prop_set_visibility, ":var8", 1),
            (scene_prop_get_instance, ":var8", "$team_2_flag_scene_prop", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (scene_prop_set_visibility, ":var8", 0),
            (scene_prop_get_instance, ":var8", "spr_headquarters_flag_gray_code_only", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (scene_prop_set_visibility, ":var8", 0),
            (val_add, "$g_number_of_initial_team_1_flags", 1),
          (else_try),
            (scene_prop_get_instance, ":var8", "$team_1_flag_scene_prop", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (scene_prop_set_visibility, ":var8", 0),
            (scene_prop_get_instance, ":var8", "$team_2_flag_scene_prop", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (scene_prop_set_visibility, ":var8", 1),
            (scene_prop_get_instance, ":var8", "spr_headquarters_flag_gray_code_only", ":var10"),
            (prop_instance_set_position, ":var8", pos0),
            (scene_prop_set_visibility, ":var8", 0),
            (val_add, "$g_number_of_initial_team_2_flags", 1),
          (try_end),
        (try_end),
      (else_try),
        (scene_prop_get_num_instances, ":var1", "spr_headquarters_flag_red"),
        (scene_prop_get_num_instances, ":var2", "spr_headquarters_flag_blue"),
        (scene_prop_get_num_instances, ":var3", "spr_headquarters_flag_gray"),
        (assign, "$g_number_of_flags", 2),
        (val_add, "$g_number_of_flags", ":var1"),
        (val_add, "$g_number_of_flags", ":var2"),
        (val_add, "$g_number_of_flags", ":var3"),
      (try_end),
      (try_for_range, ":var18", 0, ":var1"),
        (scene_prop_get_instance, ":var8", "spr_headquarters_flag_red", ":var18"),
        (scene_prop_set_visibility, ":var8", 0),
      (try_end),
      (try_for_range, ":var18", 0, ":var2"),
        (scene_prop_get_instance, ":var8", "spr_headquarters_flag_blue", ":var18"),
        (scene_prop_set_visibility, ":var8", 0),
      (try_end),
      (try_for_range, ":var18", 0, ":var3"),
        (scene_prop_get_instance, ":var8", "spr_headquarters_flag_gray", ":var18"),
        (scene_prop_set_visibility, ":var8", 0),
      (try_end),
      (try_for_range, ":var18", 0, "$g_number_of_flags"),
        (store_add, ":var20", 166, ":var18"),
        (troop_set_slot, "trp_multiplayer_data", ":var20", 0),
      (try_end),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (try_begin),
        (multiplayer_get_my_player, ":var0"),
        (is_between, ":var0", 0, 1000),
        (player_get_team_no, ":var1", ":var0"),
        (lt, ":var1", 2),
        (call_script, "script_get_headquarters_scores"),
        (assign, ":var2", reg0),
        (assign, ":var3", reg1),
        (assign, ":var4", 0),
        (try_begin),
          (eq, ":var1", 0),
          (gt, ":var2", ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (eq, ":var1", 1),
          (gt, ":var3", ":var2"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (unlock_achievement, 61),
      (try_end),
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
      (try_begin),
        (multiplayer_is_server),
        (ge, ":var1", 0),
        (agent_is_human, ":var0"),
        (agent_is_human, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (le, ":var2", 1),
        (agent_get_team, ":var3", ":var0"),
        (neq, ":var2", ":var3"),
        (team_get_score, ":var4", ":var3"),
        (try_begin),
          (eq, ":var2", 0),
          (val_add, "$g_score_team_2", -10000),
        (else_try),
          (val_add, "$g_score_team_1", -10000),
        (try_end),
        (val_sub, ":var4", 1),
        (get_max_players, ":var5"),
        (call_script, "script_team_set_score", ":var3", ":var4"),
        (try_for_range, ":var6", 1, ":var5"),
          (player_is_active, ":var6"),
          (multiplayer_send_2_int_to_player, ":var6", 72, ":var3", ":var4"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (try_for_range, ":var0", 0, "$g_number_of_flags"),
        (store_add, ":var1", 166, ":var0"),
        (troop_get_slot, ":var2", "trp_multiplayer_data", ":var1"),
        (val_add, ":var2", 1),
        (troop_set_slot, "trp_multiplayer_data", ":var1", ":var2"),
        (store_add, ":var3", 176, ":var0"),
        (troop_get_slot, ":var4", "trp_multiplayer_data", ":var3"),
        (store_mod, ":var5", ":var4", 100),
        (try_begin),
          (ge, ":var4", 100),
          (lt, ":var5", 25),
          (val_add, ":var4", 1),
          (troop_set_slot, "trp_multiplayer_data", ":var3", ":var4"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (try_for_range, ":var0", 0, "$g_number_of_flags"),
        (store_add, ":var1", 156, ":var0"),
        (troop_get_slot, ":var2", "trp_multiplayer_data", ":var1"),
        (store_div, ":var3", ":var2", 100),
        (store_mod, ":var4", ":var2", 100),
        (assign, ":var5", 0),
        (assign, ":var6", 0),
        (scene_prop_get_instance, ":var7", "spr_headquarters_pole_code_only", ":var0"),
        (prop_instance_get_position, pos0, ":var7"),
        (get_max_players, ":var8"),
        (try_for_range, ":var9", 0, ":var8"),
          (player_is_active, ":var9"),
          (player_get_agent_id, ":var10", ":var9"),
          (ge, ":var10", 0),
          (agent_is_alive, ":var10"),
          (agent_get_team, ":var11", ":var10"),
          (agent_get_position, pos1, ":var10"),
          (get_sq_distance_between_positions, ":var12", pos0, pos1),
          (get_sq_distance_between_position_heights, ":var13", pos0, pos1),
          (val_add, ":var12", ":var13"),
          (lt, ":var12", 1600),
          (try_begin),
            (eq, ":var11", 0),
            (val_add, ":var5", 1),
          (else_try),
            (eq, ":var11", 1),
            (val_add, ":var6", 1),
          (try_end),
        (try_end),
        (try_begin),
          (this_or_next|neq, ":var3", ":var5"),
          (neq, ":var4", ":var6"),
          (store_add, ":var14", 146, ":var0"),
          (troop_get_slot, ":var15", "trp_multiplayer_data", ":var14"),
          (store_add, ":var16", 176, ":var0"),
          (troop_get_slot, ":var17", "trp_multiplayer_data", ":var16"),
          (store_mod, ":var18", ":var17", 100),
          (store_div, ":var19", ":var17", 100),
          (try_begin),
            (assign, ":var20", 0),
            (try_begin),
              (neq, ":var15", 1),
              (eq, ":var3", 0),
              (gt, ":var5", 0),
              (eq, ":var6", 0),
              (assign, ":var21", 1),
              (assign, ":var20", 1),
            (else_try),
              (neq, ":var15", 2),
              (eq, ":var4", 0),
              (eq, ":var5", 0),
              (gt, ":var6", 0),
              (assign, ":var21", 2),
              (assign, ":var20", 1),
            (try_end),
            (eq, ":var20", 1),
            (store_mul, ":var22", ":var21", 100),
            (troop_set_slot, "trp_multiplayer_data", ":var16", ":var22"),
            (this_or_next|neq, ":var19", ":var21"),
            (ge, ":var18", 25),
            (store_mul, ":var23", ":var21", 100),
            (val_add, ":var23", ":var0"),
            (call_script, "script_show_multiplayer_message", 10, ":var23"),
            (try_for_range, ":var9", 1, ":var8"),
              (player_is_active, ":var9"),
              (multiplayer_send_2_int_to_player, ":var9", 68, 10, ":var23"),
            (try_end),
          (try_end),
          (try_begin),
            (store_mul, ":var2", ":var5", 100),
            (val_add, ":var2", ":var6"),
            (troop_set_slot, "trp_multiplayer_data", ":var1", ":var2"),
            (call_script, "script_set_num_agents_around_flag", ":var0", ":var2"),
            (get_max_players, ":var8"),
            (try_for_range, ":var9", 1, ":var8"),
              (player_is_active, ":var9"),
              (multiplayer_send_2_int_to_player, ":var9", 73, ":var0", ":var2"),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_for_range, ":var0", 0, "$g_number_of_flags"),
        (assign, ":var24", -1),
        (scene_prop_get_instance, ":var7", "spr_headquarters_pole_code_only", ":var0"),
        (prop_instance_get_position, pos0, ":var7"),
        (store_add, ":var14", 146, ":var0"),
        (troop_get_slot, ":var15", "trp_multiplayer_data", ":var14"),
        (try_begin),
          (try_begin),
            (scene_prop_get_instance, ":var25", "$team_1_flag_scene_prop", ":var0"),
            (scene_prop_get_visibility, ":var26", ":var25"),
            (assign, ":var27", 1),
            (eq, ":var26", 0),
            (scene_prop_get_instance, ":var25", "$team_2_flag_scene_prop", ":var0"),
            (scene_prop_get_visibility, ":var26", ":var25"),
            (assign, ":var27", 2),
            (eq, ":var26", 0),
            (scene_prop_get_instance, ":var25", "spr_headquarters_flag_gray_code_only", ":var0"),
            (scene_prop_get_visibility, ":var26", ":var25"),
            (assign, ":var27", 0),
          (try_end),
          (prop_instance_get_position, pos1, ":var25"),
          (try_begin),
            (get_sq_distance_between_positions, ":var12", pos0, pos1),
            (lt, ":var12", 400),
            (store_add, ":var28", 156, ":var0"),
            (troop_get_slot, ":var29", "trp_multiplayer_data", ":var28"),
            (store_div, ":var5", ":var29", 100),
            (store_mod, ":var6", ":var29", 100),
            (try_begin),
              (gt, ":var5", 0),
              (eq, ":var6", 0),
              (assign, ":var24", 0),
              (assign, ":var30", 1),
            (else_try),
              (eq, ":var5", 0),
              (gt, ":var6", 0),
              (assign, ":var24", 0),
              (assign, ":var30", 2),
            (else_try),
              (eq, ":var5", 0),
              (eq, ":var6", 0),
              (neq, ":var27", 0),
              (assign, ":var24", 0),
              (assign, ":var30", 0),
            (try_end),
          (else_try),
            (neq, ":var15", ":var27"),
            (get_sq_distance_between_positions, ":var12", pos0, pos1),
            (ge, ":var12", 8100),
            (store_add, ":var28", 156, ":var0"),
            (troop_get_slot, ":var29", "trp_multiplayer_data", ":var28"),
            (store_div, ":var5", ":var29", 100),
            (store_mod, ":var6", ":var29", 100),
            (try_begin),
              (eq, ":var27", 1),
              (assign, ":var24", 1),
              (assign, ":var30", 1),
            (else_try),
              (eq, ":var27", 2),
              (assign, ":var24", 2),
              (assign, ":var30", 2),
            (try_end),
          (try_end),
        (try_end),
        (try_begin),
          (ge, ":var24", 0),
          (this_or_next|neq, ":var24", ":var15"),
          (neq, ":var27", ":var30"),
          (try_begin),
            (neq, ":var15", 0),
            (eq, ":var24", 0),
            (try_begin),
              (eq, ":var15", 1),
              (assign, ":var31", 2),
            (else_try),
              (eq, ":var15", 2),
              (assign, ":var31", 1),
            (try_end),
            (store_mul, ":var23", ":var31", 100),
            (val_add, ":var23", ":var0"),
            (call_script, "script_show_multiplayer_message", 8, ":var23"),
            (get_max_players, ":var8"),
            (try_for_range, ":var9", 1, ":var8"),
              (player_is_active, ":var9"),
              (multiplayer_send_2_int_to_player, ":var9", 68, 8, ":var23"),
            (try_end),
          (try_end),
          (try_begin),
            (neq, ":var15", ":var24"),
            (neq, ":var24", 0),
            (store_mul, ":var23", ":var24", 100),
            (val_add, ":var23", ":var0"),
            (call_script, "script_show_multiplayer_message", 9, ":var23"),
            (get_max_players, ":var8"),
            (try_for_range, ":var9", 1, ":var8"),
              (player_is_active, ":var9"),
              (multiplayer_send_2_int_to_player, ":var9", 68, 9, ":var23"),
            (try_end),
          (try_end),
          (call_script, "script_set_num_agents_around_flag", ":var0", ":var29"),
          (assign, ":var32", 0),
          (get_max_players, ":var8"),
          (try_for_range, ":var9", 1, ":var8"),
            (player_is_active, ":var9"),
            (multiplayer_send_2_int_to_player, ":var9", 73, ":var0", ":var29"),
            (val_add, ":var32", 1),
          (try_end),
          (store_mul, ":var33", ":var24", 100),
          (val_add, ":var33", ":var30"),
          (call_script, "script_change_flag_owner", ":var0", ":var33"),
          (try_for_range, ":var9", 1, ":var8"),
            (player_is_active, ":var9"),
            (multiplayer_send_2_int_to_player, ":var9", 75, ":var0", ":var33"),
          (try_end),
          (try_begin),
            (neq, ":var24", 0),
            (try_begin),
              (eq, ":var24", 1),
              (assign, ":var34", ":var5"),
            (else_try),
              (assign, ":var34", ":var6"),
            (try_end),
            (store_add, ":var35", 166, ":var0"),
            (troop_get_slot, ":var36", "trp_multiplayer_data", ":var35"),
            (troop_set_slot, "trp_multiplayer_data", ":var35", 0),
            (val_min, ":var36", 360),
            (scene_prop_get_instance, ":var37", "$team_1_flag_scene_prop", ":var0"),
            (scene_prop_get_instance, ":var38", "$team_2_flag_scene_prop", ":var0"),
            (try_begin),
              (this_or_next|eq, "$g_base_flag_team_1", ":var37"),
              (eq, "$g_base_flag_team_2", ":var38"),
              (assign, ":var39", 2),
            (else_try),
              (assign, ":var39", 1),
            (try_end),
            (try_begin),
              (le, ":var34", 1),
              (assign, ":var40", 3),
            (else_try),
              (eq, ":var34", 2),
              (assign, ":var40", 2),
            (else_try),
              (le, ":var34", 6),
              (assign, ":var40", 1),
            (else_try),
              (assign, ":var40", 0),
            (try_end),
            (store_mul, ":var41", ":var36", ":var32"),
            (val_mul, ":var41", ":var39"),
            (val_div, ":var41", 2),
            (try_begin),
              (gt, ":var34", 0),
              (store_div, ":var42", ":var41", ":var34"),
            (try_end),
            (get_max_players, ":var8"),
            (try_for_range, ":var9", 0, ":var8"),
              (player_is_active, ":var9"),
              (player_get_agent_id, ":var10", ":var9"),
              (ge, ":var10", 0),
              (agent_get_team, ":var11", ":var10"),
              (val_add, ":var11", 1),
              (eq, ":var11", ":var24"),
              (agent_get_position, pos1, ":var10"),
              (prop_instance_get_position, pos0, ":var7"),
              (get_sq_distance_between_positions, ":var12", pos0, pos1),
              (get_sq_distance_between_position_heights, ":var13", pos0, pos1),
              (val_add, ":var12", ":var13"),
              (lt, ":var12", 1600),
              (player_get_score, ":var43", ":var9"),
              (val_add, ":var43", ":var40"),
              (player_set_score, ":var9", ":var43"),
              (player_get_gold, ":var44", ":var9"),
              (val_add, ":var44", ":var42"),
              (player_set_gold, ":var9", ":var44", 15000),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (assign, ":var3", 0),
      (try_for_range, ":var4", 0, "$g_number_of_flags"),
        (store_add, ":var5", 146, ":var4"),
        (troop_get_slot, ":var6", "trp_multiplayer_data", ":var5"),
        (scene_prop_get_instance, ":var7", "$team_1_flag_scene_prop", ":var4"),
        (scene_prop_get_instance, ":var8", "$team_2_flag_scene_prop", ":var4"),
        (try_begin),
          (this_or_next|eq, "$g_base_flag_team_1", ":var7"),
          (eq, "$g_base_flag_team_2", ":var8"),
          (assign, ":var9", 2),
        (else_try),
          (assign, ":var9", 1),
        (try_end),
        (try_begin),
          (eq, ":var6", 1),
          (val_add, ":var0", ":var9"),
          (val_add, ":var2", ":var9"),
        (else_try),
          (eq, ":var6", 2),
          (val_add, ":var1", ":var9"),
          (val_add, ":var2", ":var9"),
        (else_try),
          (val_add, ":var3", ":var9"),
        (try_end),
      (try_end),
      (store_add, ":var10", ":var2", ":var3"),
      (store_sub, ":var11", ":var0", ":var1"),
      (store_mul, ":var12", ":var11", 2),
      (store_sub, ":var13", "$g_number_of_initial_team_1_flags", "$g_number_of_initial_team_2_flags"),
      (assign, ":var14", 0),
      (get_max_players, ":var15"),
      (try_for_range, ":var16", 0, ":var15"),
        (player_is_active, ":var16"),
        (val_add, ":var14", 1),
        (assign, ":var15", 0),
      (try_end),
      (try_begin),
        (ge, ":var12", ":var13"),
        (store_sub, ":var17", ":var12", ":var13"),
        (store_mul, ":var18", ":var17", 125),
        (val_add, ":var18", 500),
        (store_div, ":var19", 250000, ":var18"),
        (try_begin),
          (lt, ":var2", ":var10"),
          (val_mul, ":var19", ":var2"),
          (val_div, ":var19", ":var10"),
          (val_mul, ":var18", ":var2"),
          (val_div, ":var18", ":var10"),
        (try_end),
        (call_script, "script_find_number_of_agents_constant"),
        (val_mul, ":var18", reg0),
        (val_div, ":var18", 100),
        (val_mul, ":var19", reg0),
        (val_div, ":var19", 100),
        (val_mul, ":var18", "$g_multiplayer_point_gained_from_flags"),
        (val_div, ":var18", 100),
        (val_mul, ":var19", "$g_multiplayer_point_gained_from_flags"),
        (val_div, ":var19", 100),
        (try_begin),
          (ge, ":var14", 1),
          (val_sub, "$g_score_team_2", ":var18"),
          (try_begin),
            (ge, ":var1", 1),
            (val_sub, "$g_score_team_1", ":var19"),
          (else_try),
            (val_sub, "$g_score_team_2", ":var19"),
          (try_end),
        (try_end),
      (else_try),
        (store_sub, ":var17", ":var13", ":var12"),
        (store_mul, ":var18", ":var17", 125),
        (val_add, ":var18", 500),
        (store_div, ":var19", 250000, ":var18"),
        (try_begin),
          (lt, ":var2", ":var10"),
          (val_mul, ":var19", ":var2"),
          (val_div, ":var19", ":var10"),
          (val_mul, ":var18", ":var2"),
          (val_div, ":var18", ":var10"),
        (try_end),
        (call_script, "script_find_number_of_agents_constant"),
        (val_mul, ":var18", reg0),
        (val_div, ":var18", 100),
        (val_mul, ":var19", reg0),
        (val_div, ":var19", 100),
        (val_mul, ":var18", "$g_multiplayer_point_gained_from_flags"),
        (val_div, ":var18", 100),
        (val_mul, ":var19", "$g_multiplayer_point_gained_from_flags"),
        (val_div, ":var19", 100),
        (try_begin),
          (ge, ":var14", 1),
          (try_begin),
            (ge, ":var0", 1),
            (val_sub, "$g_score_team_2", ":var19"),
          (else_try),
            (val_sub, "$g_score_team_1", ":var19"),
          (try_end),
          (val_sub, "$g_score_team_1", ":var18"),
        (try_end),
      (try_end),
      (team_get_score, ":var20", 0),
      (try_begin),
        (store_div, ":var21", "$g_score_team_1", 10000),
        (neq, ":var21", ":var20"),
        (get_max_players, ":var22"),
        (call_script, "script_team_set_score", 0, ":var21"),
        (try_for_range, ":var16", 1, ":var22"),
          (player_is_active, ":var16"),
          (multiplayer_send_2_int_to_player, ":var16", 72, 0, ":var21"),
        (try_end),
      (try_end),
      (team_get_score, ":var23", 1),
      (try_begin),
        (store_div, ":var24", "$g_score_team_2", 10000),
        (neq, ":var24", ":var23"),
        (get_max_players, ":var22"),
        (call_script, "script_team_set_score", 1, ":var24"),
        (try_for_range, ":var16", 1, ":var22"),
          (player_is_active, ":var16"),
          (multiplayer_send_2_int_to_player, ":var16", 72, 1, ":var24"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (get_max_players, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (player_is_active, ":var1"),
        (neg|player_is_busy_with_menus, ":var1"),
        (player_get_team_no, ":var2", ":var1"),
        (lt, ":var2", 2),
        (player_get_troop_id, ":var3", ":var1"),
        (ge, ":var3", 0),
        (player_get_agent_id, ":var4", ":var1"),
        (assign, ":var5", 0),
        (try_begin),
          (player_get_slot, ":var6", ":var1", 24),
          (eq, ":var6", 1),
          (assign, ":var5", 1),
          (player_set_slot, ":var1", 24, 0),
        (else_try),
          (try_begin),
            (lt, ":var4", 0),
            (assign, ":var5", 1),
          (else_try),
            (neg|agent_is_alive, ":var4"),
            (agent_get_time_elapsed_since_removed, ":var7", ":var4"),
            (gt, ":var7", "$g_multiplayer_respawn_period"),
            (assign, ":var5", 1),
          (try_end),
        (try_end),
        (eq, ":var5", 1),
        (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
        (troop_get_inventory_slot, ":var8", ":var3", ek_horse),
        (try_begin),
          (ge, ":var8", 0),
          (assign, ":var9", 1),
        (else_try),
          (assign, ":var9", 0),
        (try_end),
        (call_script, "script_multiplayer_find_spawn_point", ":var2", 0, ":var9"),
        (player_spawn_new_agent, ":var1", reg0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_agents, ":var3"),
        (agent_is_non_player, ":var3"),
        (agent_is_human, ":var3"),
        (assign, ":var4", 0),
        (try_begin),
          (agent_is_alive, ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (agent_get_time_elapsed_since_removed, ":var5", ":var3"),
          (le, ":var5", "$g_multiplayer_respawn_period"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (agent_get_team, ":var6", ":var3"),
        (try_begin),
          (eq, ":var6", 0),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var6", 1),
          (val_add, ":var2", 1),
        (try_end),
      (try_end),
      (store_sub, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1", ":var1"),
      (store_sub, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2", ":var2"),
      (val_max, "$g_multiplayer_num_bots_required_team_1", 0),
      (val_max, "$g_multiplayer_num_bots_required_team_2", 0),
    ]),

    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (this_or_next|eq, "$g_multiplayer_game_type", 3),
          (eq, "$g_multiplayer_game_type", 6),
          (team_get_score, ":var1", 0),
          (team_get_score, ":var2", 1),
          (store_add, ":var3", ":var1", ":var2"),
          (eq, ":var3", 0),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (lt, ":var4", 20),
          (assign, ":var5", 0),
        (else_try),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 0, ":var0"),
        (val_sub, ":var6", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var6", 0),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var7", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (eq, "$g_multiplayer_game_type", 3),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (try_begin),
            (le, ":var4", 20),
            (assign, ":var8", 0),
          (else_try),
            (assign, ":var8", 1),
          (try_end),
        (else_try),
          (assign, ":var8", 1),
        (try_end),
        (call_script, "script_multiplayer_find_bot_troop_and_group_for_spawn", ":var7", ":var8"),
        (assign, ":var9", reg0),
        (assign, ":var10", reg1),
        (team_get_faction, ":var11", ":var7"),
        (assign, ":var12", 0),
        (try_for_range, ":var13", "trp_swadian_crossbowman_multiplayer_ai", "trp_swadian_crossbowman_multiplayer"),
          (store_faction_of_troop, ":var14", ":var13"),
          (eq, ":var14", ":var11"),
          (val_add, ":var12", 1),
        (try_end),
        (assign, ":var15", 0),
        (get_max_players, ":var16"),
        (try_for_range, ":var17", 0, ":var16"),
          (player_is_active, ":var17"),
          (player_get_team_no, ":var18", ":var17"),
          (eq, ":var7", ":var18"),
          (assign, ":var19", 0),
          (store_add, ":var20", 35, ":var12"),
          (try_for_range, ":var21", 35, ":var20"),
            (player_slot_ge, ":var17", ":var21", 1),
            (assign, ":var19", 1),
            (assign, ":var20", 0),
          (try_end),
          (ge, ":var19", 1),
          (val_add, ":var15", 1),
        (try_end),
        (try_begin),
          (this_or_next|ge, ":var10", 0),
          (eq, ":var15", 0),
          (troop_get_inventory_slot, ":var22", ":var9", ek_horse),
          (try_begin),
            (ge, ":var22", 0),
            (assign, ":var23", 1),
          (else_try),
            (assign, ":var23", 0),
          (try_end),
          (try_begin),
            (eq, "$g_multiplayer_game_type", 6),
            (store_mission_timer_a, ":var4"),
            (val_sub, ":var4", "$g_round_start_time"),
            (try_begin),
              (lt, ":var4", 20),
              (try_begin),
                (eq, ":var7", 0),
                (call_script, "script_multiplayer_find_spawn_point", ":var7", 1, ":var23"),
              (else_try),
                (assign, reg0, 32),
              (try_end),
            (else_try),
              (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
            (try_end),
          (else_try),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (try_begin),
              (eq, ":var7", 0),
              (assign, reg0, 0),
            (else_try),
              (assign, reg0, 32),
            (try_end),
          (else_try),
            (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
          (try_end),
          (store_current_scene, ":var24"),
          (modify_visitors_at_site, ":var24"),
          (add_visitors_to_current_scene, reg0, ":var9", 1, ":var7", ":var10"),
          (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
          (try_begin),
            (eq, ":var7", 0),
            (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
          (else_try),
            (eq, ":var7", 1),
            (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (3, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (try_for_agents, ":var0"),
        (agent_is_non_player, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_group, ":var1", ":var0"),
        (try_begin),
          (neg|player_is_active, ":var1"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (else_try),
          (player_get_team_no, ":var2", ":var1"),
          (agent_get_team, ":var3", ":var0"),
          (neq, ":var2", ":var3"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (try_end),
      (try_end),
    ]),

    (20, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (call_script, "script_check_team_balance"),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (assign, ":var0", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_game_type", 2),
        (this_or_next|eq, "$g_multiplayer_game_type", 3),
        (eq, "$g_multiplayer_game_type", 6),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (store_mission_timer_a, ":var1"),
          (val_sub, ":var1", "$g_round_finish_time"),
          (store_sub, ":var2", "$g_multiplayer_respawn_period", 1),
          (ge, ":var1", ":var2"),
          (store_mission_timer_a, ":var3"),
          (try_begin),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (assign, ":var4", 90),
          (else_try),
            (assign, ":var4", 120),
          (try_end),
          (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
          (store_sub, ":var6", ":var5", ":var4"),
          (gt, ":var3", ":var6"),
          (assign, ":var0", 1),
        (try_end),
        (eq, ":var0", 1),
      (else_try),
        (neq, "$g_multiplayer_game_type", 2),
        (neq, "$g_multiplayer_game_type", 3),
        (neq, "$g_multiplayer_game_type", 6),
        (neq, "$g_multiplayer_game_type", 5),
        (store_mission_timer_a, ":var3"),
        (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var3", ":var5"),
        (assign, ":var0", 1),
      (else_try),
        (team_get_score, ":var7", 0),
        (team_get_score, ":var8", 1),
        (try_begin),
          (neq, "$g_multiplayer_game_type", 5),
          (try_begin),
            (this_or_next|ge, ":var7", "$g_multiplayer_game_max_points"),
            (ge, ":var8", "$g_multiplayer_game_max_points"),
            (assign, ":var0", 1),
          (try_end),
        (else_try),
          (assign, ":var9", 0),
          (get_max_players, ":var10"),
          (try_for_range, ":var11", 0, ":var10"),
            (player_is_active, ":var11"),
            (player_get_agent_id, ":var12", ":var11"),
            (ge, ":var12", 0),
            (neg|agent_is_non_player, ":var12"),
            (assign, ":var9", 1),
            (assign, ":var10", 0),
          (try_end),
          (eq, ":var9", 1),
          (this_or_next|le, ":var7", 0),
          (le, ":var8", 0),
          (assign, ":var0", 1),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_team_score_display"),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|is_presentation_active, "prsnt_multiplayer_escape_menu"),
      (neg|is_presentation_active, "prsnt_multiplayer_stats_chart"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

  ]),

  ("multiplayer_cf", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (34, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (64, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (65, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (1, 5, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (try_begin),
        (multiplayer_is_server),
        (store_current_scene, ":var0"),
        (this_or_next|eq, ":var0", "scn_random_multi_plain_medium"),
        (this_or_next|eq, ":var0", "scn_random_multi_plain_large"),
        (this_or_next|eq, ":var0", "scn_random_multi_steppe_medium"),
        (eq, ":var0", "scn_random_multi_steppe_large"),
        (entry_point_get_position, pos0, 0),
        (entry_point_set_position, 64, pos0),
        (entry_point_get_position, pos1, 32),
        (entry_point_set_position, 65, pos1),
      (try_end),
      (assign, "$g_multiplayer_game_type", 4),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (assign, "$flag_1_at_ground_timer", 0),
      (assign, "$flag_2_at_ground_timer", 0),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_destroy_mod_targets"),
      (call_script, "script_multiplayer_remove_headquarters_flags"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_determine_team_flags", 0),
      (call_script, "script_determine_team_flags", 1),
      (set_spawn_effector_scene_prop_kind, 0, -1),
      (set_spawn_effector_scene_prop_kind, 1, -1),
      (try_begin),
        (multiplayer_is_server),
        (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
        (entry_point_get_position, pos0, 64),
        (set_spawn_position, pos0),
        (spawn_scene_prop, "$team_1_flag_scene_prop", 0),
        (entry_point_get_position, pos0, 65),
        (set_spawn_position, pos0),
        (spawn_scene_prop, "$team_2_flag_scene_prop", 0),
      (try_end),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
      (try_begin),
        (agent_is_human, ":var0"),
        (agent_get_attached_scene_prop, ":var2", ":var0"),
        (try_begin),
          (try_begin),
            (multiplayer_is_server),
            (ge, ":var2", 0),
            (multiplayer_get_my_player, ":var3"),
            (get_max_players, ":var4"),
            (call_script, "script_set_attached_scene_prop", ":var0", -1),
            (agent_set_horse_speed_factor, ":var0", 100),
            (try_for_range, ":var5", 1, ":var4"),
              (player_is_active, ":var5"),
              (neq, ":var3", ":var5"),
              (multiplayer_send_2_int_to_player, ":var5", 70, ":var0", -1),
            (try_end),
            (prop_instance_get_position, pos0, ":var2"),
            (position_set_z_to_ground_level, pos0),
            (prop_instance_set_position, ":var2", pos0),
            (agent_get_team, ":var6", ":var0"),
            (try_begin),
              (eq, ":var6", 0),
              (assign, ":var7", 1),
            (else_try),
              (assign, ":var7", 0),
            (try_end),
            (team_set_slot, ":var7", 0, 2),
            (multiplayer_get_my_player, ":var3"),
            (get_max_players, ":var4"),
            (call_script, "script_set_team_flag_situation", ":var7", 2),
            (try_for_range, ":var5", 1, ":var4"),
              (player_is_active, ":var5"),
              (neq, ":var3", ":var5"),
              (multiplayer_send_2_int_to_player, ":var5", 71, ":var7", 2),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (try_for_range, ":var0", 0, 2),
        (try_begin),
          (team_slot_eq, ":var0", 0, 2),
          (assign, ":var1", -1),
          (try_begin),
            (eq, ":var0", 0),
            (val_add, "$flag_1_at_ground_timer", 1),
            (ge, "$flag_1_at_ground_timer", 60),
            (assign, ":var1", 0),
          (else_try),
            (val_add, "$flag_2_at_ground_timer", 1),
            (ge, "$flag_2_at_ground_timer", 60),
            (assign, ":var1", 1),
          (try_end),
          (try_begin),
            (ge, ":var1", 0),
            (try_begin),
              (eq, ":var1", 0),
              (assign, "$flag_1_at_ground_timer", 0),
            (else_try),
              (eq, ":var1", 1),
              (assign, "$flag_2_at_ground_timer", 0),
            (try_end),
            (team_set_slot, ":var1", 0, 0),
            (call_script, "script_set_team_flag_situation", ":var1", 0),
            (multiplayer_get_my_player, ":var2"),
            (get_max_players, ":var3"),
            (try_for_range, ":var4", 1, ":var3"),
              (player_is_active, ":var4"),
              (neq, ":var2", ":var4"),
              (multiplayer_send_2_int_to_player, ":var4", 71, ":var1", 0),
            (try_end),
            (scene_prop_get_instance, ":var5", "$team_1_flag_scene_prop", 0),
            (scene_prop_get_instance, ":var6", "$team_2_flag_scene_prop", 0),
            (assign, ":var7", ":var5"),
            (assign, ":var8", 64),
            (assign, ":var9", ":var6"),
            (assign, ":var10", 65),
            (try_begin),
              (eq, ":var1", 0),
              (entry_point_get_position, pos5, ":var8"),
              (prop_instance_set_position, ":var7", pos5),
            (else_try),
              (entry_point_get_position, pos5, ":var10"),
              (prop_instance_set_position, ":var9", pos5),
            (try_end),
            (store_mul, ":var11", ":var1", -1),
            (val_sub, ":var11", 1),
            (call_script, "script_show_multiplayer_message", 5, ":var11"),
            (try_for_range, ":var4", 0, ":var3"),
              (player_is_active, ":var4"),
              (neq, ":var2", ":var4"),
              (multiplayer_send_2_int_to_player, ":var4", 68, 5, ":var11"),
            (try_end),
          (try_end),
        (else_try),
          (try_begin),
            (eq, ":var0", 0),
            (assign, "$flag_1_at_ground_timer", 0),
          (else_try),
            (assign, "$flag_2_at_ground_timer", 0),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (get_max_players, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (player_is_active, ":var1"),
        (neg|player_is_busy_with_menus, ":var1"),
        (player_get_team_no, ":var2", ":var1"),
        (lt, ":var2", 2),
        (player_get_troop_id, ":var3", ":var1"),
        (ge, ":var3", 0),
        (player_get_agent_id, ":var4", ":var1"),
        (assign, ":var5", 0),
        (try_begin),
          (player_get_slot, ":var6", ":var1", 24),
          (eq, ":var6", 1),
          (assign, ":var5", 1),
          (player_set_slot, ":var1", 24, 0),
        (else_try),
          (try_begin),
            (lt, ":var4", 0),
            (assign, ":var5", 1),
          (else_try),
            (neg|agent_is_alive, ":var4"),
            (agent_get_time_elapsed_since_removed, ":var7", ":var4"),
            (gt, ":var7", "$g_multiplayer_respawn_period"),
            (assign, ":var5", 1),
          (try_end),
        (try_end),
        (eq, ":var5", 1),
        (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
        (troop_get_inventory_slot, ":var8", ":var3", ek_horse),
        (try_begin),
          (ge, ":var8", 0),
          (assign, ":var9", 1),
        (else_try),
          (assign, ":var9", 0),
        (try_end),
        (call_script, "script_multiplayer_find_spawn_point", ":var2", 0, ":var9"),
        (player_spawn_new_agent, ":var1", reg0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_agents, ":var3"),
        (agent_is_non_player, ":var3"),
        (agent_is_human, ":var3"),
        (assign, ":var4", 0),
        (try_begin),
          (agent_is_alive, ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (agent_get_time_elapsed_since_removed, ":var5", ":var3"),
          (le, ":var5", "$g_multiplayer_respawn_period"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (agent_get_team, ":var6", ":var3"),
        (try_begin),
          (eq, ":var6", 0),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var6", 1),
          (val_add, ":var2", 1),
        (try_end),
      (try_end),
      (store_sub, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1", ":var1"),
      (store_sub, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2", ":var2"),
      (val_max, "$g_multiplayer_num_bots_required_team_1", 0),
      (val_max, "$g_multiplayer_num_bots_required_team_2", 0),
    ]),

    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (this_or_next|eq, "$g_multiplayer_game_type", 3),
          (eq, "$g_multiplayer_game_type", 6),
          (team_get_score, ":var1", 0),
          (team_get_score, ":var2", 1),
          (store_add, ":var3", ":var1", ":var2"),
          (eq, ":var3", 0),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (lt, ":var4", 20),
          (assign, ":var5", 0),
        (else_try),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 0, ":var0"),
        (val_sub, ":var6", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var6", 0),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var7", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (eq, "$g_multiplayer_game_type", 3),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (try_begin),
            (le, ":var4", 20),
            (assign, ":var8", 0),
          (else_try),
            (assign, ":var8", 1),
          (try_end),
        (else_try),
          (assign, ":var8", 1),
        (try_end),
        (call_script, "script_multiplayer_find_bot_troop_and_group_for_spawn", ":var7", ":var8"),
        (assign, ":var9", reg0),
        (assign, ":var10", reg1),
        (team_get_faction, ":var11", ":var7"),
        (assign, ":var12", 0),
        (try_for_range, ":var13", "trp_swadian_crossbowman_multiplayer_ai", "trp_swadian_crossbowman_multiplayer"),
          (store_faction_of_troop, ":var14", ":var13"),
          (eq, ":var14", ":var11"),
          (val_add, ":var12", 1),
        (try_end),
        (assign, ":var15", 0),
        (get_max_players, ":var16"),
        (try_for_range, ":var17", 0, ":var16"),
          (player_is_active, ":var17"),
          (player_get_team_no, ":var18", ":var17"),
          (eq, ":var7", ":var18"),
          (assign, ":var19", 0),
          (store_add, ":var20", 35, ":var12"),
          (try_for_range, ":var21", 35, ":var20"),
            (player_slot_ge, ":var17", ":var21", 1),
            (assign, ":var19", 1),
            (assign, ":var20", 0),
          (try_end),
          (ge, ":var19", 1),
          (val_add, ":var15", 1),
        (try_end),
        (try_begin),
          (this_or_next|ge, ":var10", 0),
          (eq, ":var15", 0),
          (troop_get_inventory_slot, ":var22", ":var9", ek_horse),
          (try_begin),
            (ge, ":var22", 0),
            (assign, ":var23", 1),
          (else_try),
            (assign, ":var23", 0),
          (try_end),
          (try_begin),
            (eq, "$g_multiplayer_game_type", 6),
            (store_mission_timer_a, ":var4"),
            (val_sub, ":var4", "$g_round_start_time"),
            (try_begin),
              (lt, ":var4", 20),
              (try_begin),
                (eq, ":var7", 0),
                (call_script, "script_multiplayer_find_spawn_point", ":var7", 1, ":var23"),
              (else_try),
                (assign, reg0, 32),
              (try_end),
            (else_try),
              (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
            (try_end),
          (else_try),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (try_begin),
              (eq, ":var7", 0),
              (assign, reg0, 0),
            (else_try),
              (assign, reg0, 32),
            (try_end),
          (else_try),
            (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
          (try_end),
          (store_current_scene, ":var24"),
          (modify_visitors_at_site, ":var24"),
          (add_visitors_to_current_scene, reg0, ":var9", 1, ":var7", ":var10"),
          (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
          (try_begin),
            (eq, ":var7", 0),
            (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
          (else_try),
            (eq, ":var7", 1),
            (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (3, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (try_for_agents, ":var0"),
        (agent_is_non_player, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_group, ":var1", ":var0"),
        (try_begin),
          (neg|player_is_active, ":var1"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (else_try),
          (player_get_team_no, ":var2", ":var1"),
          (agent_get_team, ":var3", ":var0"),
          (neq, ":var2", ":var3"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (scene_prop_get_instance, ":var0", "$team_1_flag_scene_prop", 0),
      (prop_instance_get_position, pos1, ":var0"),
      (scene_prop_get_instance, ":var1", "$team_2_flag_scene_prop", 0),
      (prop_instance_get_position, pos2, ":var1"),
      (multiplayer_get_my_player, ":var2"),
      (get_max_players, ":var3"),
      (try_for_agents, ":var4"),
        (agent_is_human, ":var4"),
        (agent_is_alive, ":var4"),
        (neg|agent_is_non_player, ":var4"),
        (agent_get_horse, ":var5", ":var4"),
        (eq, ":var5", -1),
        (agent_get_attached_scene_prop, ":var6", ":var4"),
        (agent_get_team, ":var7", ":var4"),
        (try_begin),
          (eq, ":var7", 0),
          (assign, ":var8", 1),
        (else_try),
          (assign, ":var8", 0),
        (try_end),
        (try_begin),
          (eq, ":var7", 0),
          (assign, ":var9", ":var0"),
          (assign, ":var10", 64),
        (else_try),
          (assign, ":var9", ":var1"),
          (assign, ":var10", 65),
        (try_end),
        (agent_get_position, pos3, ":var4"),
        (prop_instance_get_position, pos4, ":var9"),
        (get_distance_between_positions, ":var11", pos3, pos4),
        (team_get_slot, ":var12", ":var7", 0),
        (try_begin),
          (eq, ":var12", 2),
          (lt, ":var11", 100),
          (team_set_slot, ":var7", 0, 0),
          (call_script, "script_set_team_flag_situation", ":var7", 0),
          (try_for_range, ":var13", 1, ":var3"),
            (player_is_active, ":var13"),
            (neq, ":var2", ":var13"),
            (multiplayer_send_2_int_to_player, ":var13", 71, ":var7", 0),
          (try_end),
          (entry_point_get_position, pos5, ":var10"),
          (prop_instance_set_position, ":var9", pos5),
          (try_begin),
            (multiplayer_is_server),
            (neg|agent_is_non_player, ":var4"),
            (agent_get_player_id, ":var14", ":var4"),
            (player_get_score, ":var15", ":var14"),
            (val_add, ":var15", 1),
            (player_set_score, ":var14", ":var15"),
          (try_end),
          (call_script, "script_show_multiplayer_message", 5, ":var4"),
          (try_for_range, ":var13", 0, ":var3"),
            (player_is_active, ":var13"),
            (neq, ":var2", ":var13"),
            (multiplayer_send_2_int_to_player, ":var13", 68, 5, ":var4"),
          (try_end),
        (try_end),
        (try_begin),
          (neq, ":var6", -1),
          (try_begin),
            (eq, ":var7", 0),
            (assign, ":var16", ":var1"),
            (assign, ":var17", 65),
          (else_try),
            (assign, ":var16", ":var0"),
            (assign, ":var17", 64),
          (try_end),
          (eq, ":var6", ":var16"),
          (eq, ":var12", 0),
          (lt, ":var11", 100),
          (team_get_score, ":var18", ":var7"),
          (val_add, ":var18", 1),
          (team_set_score, ":var7", ":var18"),
          (try_begin),
            (multiplayer_is_server),
            (neg|agent_is_non_player, ":var4"),
            (agent_get_player_id, ":var14", ":var4"),
            (player_get_score, ":var15", ":var14"),
            (val_add, ":var15", "$g_multiplayer_point_gained_from_capturing_flag"),
            (player_set_score, ":var14", ":var15"),
          (try_end),
          (call_script, "script_team_set_score", ":var7", ":var18"),
          (try_for_range, ":var13", 1, ":var3"),
            (player_is_active, ":var13"),
            (neq, ":var2", ":var13"),
            (multiplayer_send_2_int_to_player, ":var13", 72, ":var7", ":var18"),
          (try_end),
          (agent_set_attached_scene_prop, ":var4", -1),
          (team_set_slot, ":var8", 0, 0),
          (call_script, "script_set_attached_scene_prop", ":var4", -1),
          (agent_set_horse_speed_factor, ":var4", 100),
          (try_for_range, ":var13", 1, ":var3"),
            (player_is_active, ":var13"),
            (neq, ":var2", ":var13"),
            (multiplayer_send_2_int_to_player, ":var13", 70, ":var4", -1),
          (try_end),
          (call_script, "script_set_team_flag_situation", ":var8", 0),
          (try_for_range, ":var13", 1, ":var3"),
            (player_is_active, ":var13"),
            (neq, ":var2", ":var13"),
            (multiplayer_send_2_int_to_player, ":var13", 71, ":var8", 0),
          (try_end),
          (entry_point_get_position, pos5, ":var17"),
          (prop_instance_set_position, ":var16", pos5),
          (call_script, "script_show_multiplayer_message", 4, ":var4"),
          (try_for_range, ":var13", 0, ":var3"),
            (player_is_active, ":var13"),
            (neq, ":var2", ":var13"),
            (multiplayer_send_2_int_to_player, ":var13", 68, 4, ":var4"),
          (try_end),
        (try_end),
        (eq, ":var6", -1),
        (agent_get_position, pos3, ":var4"),
        (agent_get_team, ":var7", ":var4"),
        (try_begin),
          (eq, ":var7", 0),
          (get_distance_between_positions, ":var11", pos2, pos3),
          (assign, ":var16", ":var1"),
        (else_try),
          (get_distance_between_positions, ":var11", pos1, pos3),
          (assign, ":var16", ":var0"),
        (try_end),
        (try_begin),
          (le, ":var11", 100),
          (neg|team_slot_eq, ":var8", 0, 1),
          (agent_set_attached_scene_prop, ":var4", ":var16"),
          (agent_set_attached_scene_prop_x, ":var4", 20),
          (agent_set_attached_scene_prop_z, ":var4", 50),
          (try_begin),
            (eq, ":var7", 0),
            (assign, "$flag_1_at_ground_timer", 0),
          (else_try),
            (eq, ":var7", 1),
            (assign, "$flag_2_at_ground_timer", 0),
          (try_end),
          (team_set_slot, ":var8", 0, 1),
          (call_script, "script_set_attached_scene_prop", ":var4", ":var16"),
          (agent_set_horse_speed_factor, ":var4", 75),
          (try_for_range, ":var13", 1, ":var3"),
            (player_is_active, ":var13"),
            (neq, ":var2", ":var13"),
            (multiplayer_send_2_int_to_player, ":var13", 70, ":var4", ":var16"),
          (try_end),
          (call_script, "script_set_team_flag_situation", ":var8", 1),
          (try_for_range, ":var13", 1, ":var3"),
            (player_is_active, ":var13"),
            (neq, ":var2", ":var13"),
            (multiplayer_send_2_int_to_player, ":var13", 71, ":var8", 1),
          (try_end),
          (call_script, "script_show_multiplayer_message", 6, ":var4"),
          (try_for_range, ":var13", 0, ":var3"),
            (player_is_active, ":var13"),
            (neq, ":var2", ":var13"),
            (multiplayer_send_2_int_to_player, ":var13", 68, 6, ":var4"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (20, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (call_script, "script_check_team_balance"),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (assign, ":var0", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_game_type", 2),
        (this_or_next|eq, "$g_multiplayer_game_type", 3),
        (eq, "$g_multiplayer_game_type", 6),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (store_mission_timer_a, ":var1"),
          (val_sub, ":var1", "$g_round_finish_time"),
          (store_sub, ":var2", "$g_multiplayer_respawn_period", 1),
          (ge, ":var1", ":var2"),
          (store_mission_timer_a, ":var3"),
          (try_begin),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (assign, ":var4", 90),
          (else_try),
            (assign, ":var4", 120),
          (try_end),
          (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
          (store_sub, ":var6", ":var5", ":var4"),
          (gt, ":var3", ":var6"),
          (assign, ":var0", 1),
        (try_end),
        (eq, ":var0", 1),
      (else_try),
        (neq, "$g_multiplayer_game_type", 2),
        (neq, "$g_multiplayer_game_type", 3),
        (neq, "$g_multiplayer_game_type", 6),
        (neq, "$g_multiplayer_game_type", 5),
        (store_mission_timer_a, ":var3"),
        (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var3", ":var5"),
        (assign, ":var0", 1),
      (else_try),
        (team_get_score, ":var7", 0),
        (team_get_score, ":var8", 1),
        (try_begin),
          (neq, "$g_multiplayer_game_type", 5),
          (try_begin),
            (this_or_next|ge, ":var7", "$g_multiplayer_game_max_points"),
            (ge, ":var8", "$g_multiplayer_game_max_points"),
            (assign, ":var0", 1),
          (try_end),
        (else_try),
          (assign, ":var9", 0),
          (get_max_players, ":var10"),
          (try_for_range, ":var11", 0, ":var10"),
            (player_is_active, ":var11"),
            (player_get_agent_id, ":var12", ":var11"),
            (ge, ":var12", 0),
            (neg|agent_is_non_player, ":var12"),
            (assign, ":var9", 1),
            (assign, ":var10", 0),
          (try_end),
          (eq, ":var9", 1),
          (this_or_next|le, ":var7", 0),
          (le, ":var8", 0),
          (assign, ":var0", 1),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_team_score_display"),
      (start_presentation, "prsnt_multiplayer_flag_projection_display"),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|is_presentation_active, "prsnt_multiplayer_escape_menu"),
      (neg|is_presentation_active, "prsnt_multiplayer_stats_chart"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

  ]),

  ("multiplayer_sg", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (2, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_1|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (34, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (set_fixed_point_multiplier, 100),
      (try_for_range, ":var0", 0, 2),
        (try_begin),
          (eq, ":var0", 0),
          (assign, ":var1", "spr_belfry_a"),
        (else_try),
          (assign, ":var1", "spr_belfry_b"),
        (try_end),
        (scene_prop_get_num_instances, ":var2", ":var1"),
        (try_for_range, ":var3", 0, ":var2"),
          (scene_prop_get_instance, ":var4", ":var1", ":var3"),
          (prop_instance_get_position, pos1, ":var4"),
          (prop_instance_get_starting_position, pos11, ":var4"),
          (store_add, ":var5", 11, ":var3"),
          (try_begin),
            (eq, ":var0", 1),
            (scene_prop_get_num_instances, ":var6", "spr_belfry_a"),
            (val_add, ":var5", ":var6"),
          (try_end),
          (val_mul, ":var5", 10),
          (store_add, ":var7", ":var5", 10),
          (try_for_range, ":var8", ":var5", ":var7"),
            (entry_point_is_auto_generated, ":var8"),
            (assign, ":var7", ":var8"),
          (try_end),
          (assign, ":var9", ":var7"),
          (val_sub, ":var7", 1),
          (assign, reg0, ":var7"),
          (neg|entry_point_is_auto_generated, ":var7"),
          (try_begin),
            (get_sq_distance_between_positions, ":var10", pos1, pos11),
            (ge, ":var10", 4),
            (assign, ":var11", -1),
            (assign, ":var12", -1),
            (try_for_range, ":var8", ":var5", ":var9"),
              (entry_point_get_position, pos4, ":var8"),
              (get_sq_distance_between_positions, ":var13", pos11, pos4),
              (lt, ":var13", ":var10"),
              (gt, ":var13", ":var11"),
              (assign, ":var11", ":var13"),
              (assign, ":var12", ":var8"),
            (try_end),
            (try_begin),
              (ge, ":var12", 0),
              (entry_point_get_position, pos5, ":var12"),
            (else_try),
              (copy_position, 5, 11),
            (try_end),
            (get_distance_between_positions, ":var14", pos1, pos5),
            (try_begin),
              (eq, ":var0", 0),
              (scene_prop_get_instance, ":var15", "spr_belfry_platform_a", ":var3"),
              (scene_prop_get_instance, ":var16", "spr_belfry_platform_b", ":var3"),
            (else_try),
              (scene_prop_get_instance, ":var15", "spr_belfry_b_platform_a", ":var3"),
            (try_end),
            (store_mul, ":var17", ":var3", 3),
            (try_begin),
              (eq, ":var1", "spr_belfry_b"),
              (scene_prop_get_num_instances, ":var6", "spr_belfry_a"),
              (store_mul, ":var18", ":var6", 3),
              (val_add, ":var17", ":var18"),
            (try_end),
            (scene_prop_get_instance, ":var19", "spr_belfry_wheel", ":var17"),
            (val_add, ":var17", 1),
            (scene_prop_get_instance, ":var20", "spr_belfry_wheel", ":var17"),
            (val_add, ":var17", 1),
            (scene_prop_get_instance, ":var21", "spr_belfry_wheel", ":var17"),
            (init_position, pos17),
            (position_move_y, pos17, -225),
            (position_transform_position_to_parent, pos18, pos1, pos17),
            (position_move_y, pos17, -225),
            (position_transform_position_to_parent, pos19, pos1, pos17),
            (assign, ":var22", 0),
            (get_max_players, ":var23"),
            (try_for_range, ":var24", 0, ":var23"),
              (player_is_active, ":var24"),
              (player_get_agent_id, ":var25", ":var24"),
              (ge, ":var25", 0),
              (agent_get_team, ":var26", ":var25"),
              (eq, ":var26", 1),
              (agent_get_horse, ":var27", ":var25"),
              (eq, ":var27", -1),
              (agent_get_position, pos2, ":var25"),
              (get_sq_distance_between_positions_in_meters, ":var28", pos18, pos2),
              (lt, ":var28", 36),
              (neg|scene_prop_has_agent_on_it, ":var4", ":var25"),
              (neg|scene_prop_has_agent_on_it, ":var15", ":var25"),
              (this_or_next|eq, ":var0", 1),
              (neg|scene_prop_has_agent_on_it, ":var16", ":var25"),
              (neg|scene_prop_has_agent_on_it, ":var19", ":var25"),
              (neg|scene_prop_has_agent_on_it, ":var20", ":var25"),
              (neg|scene_prop_has_agent_on_it, ":var21", ":var25"),
              (neg|position_is_behind_position, pos2, pos19),
              (position_is_behind_position, pos2, pos1),
              (val_add, ":var22", 1),
            (try_end),
            (val_min, ":var22", 16),
            (try_begin),
              (scene_prop_get_slot, ":var29", ":var4", 3),
              (scene_prop_get_slot, ":var30", ":var4", 4),
              (this_or_next|neq, ":var29", ":var22"),
              (neq, ":var30", ":var12"),
              (try_begin),
                (eq, ":var30", ":var12"),
                (prop_instance_is_animating, ":var31", ":var4"),
                (eq, ":var31", 1),
                (store_mul, ":var32", "$g_last_number_of_agents_around_belfry", 100),
                (store_sqrt, ":var32", ":var32"),
                (val_min, ":var32", 300),
                (assign, ":var33", ":var14"),
                (val_mul, ":var33", ":var32"),
                (val_div, ":var33", 100),
                (val_mul, ":var33", 4),
              (try_end),
              (try_begin),
                (ge, ":var12", 0),
                (init_position, pos9),
                (position_set_y, pos9, -500),
                (position_set_x, pos9, -300),
                (position_transform_position_to_parent, pos10, pos5, pos9),
                (position_get_distance_to_terrain, ":var34", pos10),
                (init_position, pos9),
                (position_set_y, pos9, -500),
                (position_set_x, pos9, 300),
                (position_transform_position_to_parent, pos10, pos5, pos9),
                (position_get_distance_to_terrain, ":var35", pos10),
                (store_add, ":var36", ":var34", ":var35"),
                (val_mul, ":var36", 100),
                (store_div, ":var37", ":var36", 24),
                (init_position, pos20),
                (position_rotate_x_floating, pos20, ":var37"),
                (position_transform_position_to_parent, pos23, pos5, pos20),
                (init_position, pos9),
                (position_set_x, pos9, -300),
                (position_transform_position_to_parent, pos10, pos5, pos9),
                (position_get_distance_to_terrain, ":var38", pos10),
                (init_position, pos9),
                (position_set_x, pos9, 300),
                (position_transform_position_to_parent, pos10, pos5, pos9),
                (position_get_distance_to_terrain, ":var39", pos10),
                (store_sub, ":var34", ":var38", ":var39"),
                (init_position, pos9),
                (position_set_x, pos9, -300),
                (position_set_y, pos9, -500),
                (position_transform_position_to_parent, pos10, pos5, pos9),
                (position_get_distance_to_terrain, ":var38", pos10),
                (init_position, pos9),
                (position_set_x, pos9, 300),
                (position_set_y, pos9, -500),
                (position_transform_position_to_parent, pos10, pos5, pos9),
                (position_get_distance_to_terrain, ":var39", pos10),
                (store_sub, ":var35", ":var38", ":var39"),
                (store_add, ":var36", ":var34", ":var35"),
                (val_mul, ":var36", 100),
                (store_div, ":var37", ":var36", 24),
                (val_mul, ":var37", -1),
                (init_position, pos20),
                (position_rotate_y_floating, pos20, ":var37"),
                (position_transform_position_to_parent, pos22, pos23, pos20),
              (else_try),
                (copy_position, 22, 5),
              (try_end),
              (try_begin),
                (ge, ":var22", 1),
                (store_mul, ":var32", ":var22", 100),
                (store_sqrt, ":var32", ":var32"),
                (val_min, ":var32", 300),
                (val_mul, ":var14", 100),
                (val_mul, ":var14", 3),
                (val_div, ":var14", ":var32"),
                (prop_instance_get_position, pos6, ":var15"),
                (position_transform_position_to_local, pos7, pos1, pos6),
                (position_transform_position_to_parent, pos8, pos22, pos7),
                (prop_instance_animate_to_position, ":var15", pos8, ":var14"),
                (try_begin),
                  (eq, ":var0", 0),
                  (prop_instance_get_position, pos6, ":var16"),
                  (position_transform_position_to_local, pos7, pos1, pos6),
                  (position_transform_position_to_parent, pos8, pos22, pos7),
                  (prop_instance_animate_to_position, ":var16", pos8, ":var14"),
                (try_end),
                (store_mul, ":var40", ":var14", -25),
                (assign, "$g_last_number_of_agents_around_belfry", ":var22"),
                (prop_instance_get_position, pos13, ":var19"),
                (prop_instance_get_position, pos20, ":var4"),
                (position_transform_position_to_local, pos7, pos20, pos13),
                (position_transform_position_to_parent, pos21, pos22, pos7),
                (prop_instance_rotate_to_position, ":var19", pos21, ":var14", ":var40"),
                (prop_instance_get_position, pos13, ":var20"),
                (prop_instance_get_position, pos20, ":var4"),
                (position_transform_position_to_local, pos7, pos20, pos13),
                (position_transform_position_to_parent, pos21, pos22, pos7),
                (prop_instance_rotate_to_position, ":var20", pos21, ":var14", ":var40"),
                (prop_instance_get_position, pos13, ":var21"),
                (prop_instance_get_position, pos20, ":var4"),
                (position_transform_position_to_local, pos7, pos20, pos13),
                (position_transform_position_to_parent, pos21, pos22, pos7),
                (prop_instance_rotate_to_position, ":var21", pos21, ":var14", ":var40"),
                (prop_instance_animate_to_position, ":var4", pos22, ":var14"),
              (else_try),
                (prop_instance_is_animating, ":var31", ":var4"),
                (eq, ":var31", 1),
                (prop_instance_stop_animating, ":var15"),
                (try_begin),
                  (eq, ":var0", 0),
                  (prop_instance_stop_animating, ":var16"),
                (try_end),
                (prop_instance_stop_animating, ":var19"),
                (prop_instance_stop_animating, ":var20"),
                (prop_instance_stop_animating, ":var21"),
                (prop_instance_stop_animating, ":var4"),
              (try_end),
              (scene_prop_set_slot, ":var4", 3, ":var22"),
              (scene_prop_set_slot, ":var4", 4, ":var12"),
            (try_end),
          (else_try),
            (le, ":var10", 4),
            (scene_prop_slot_eq, ":var4", 5, 0),
            (scene_prop_set_slot, ":var4", 5, 1),
            (try_begin),
              (eq, ":var0", 0),
              (scene_prop_get_instance, ":var15", "spr_belfry_platform_a", ":var3"),
            (else_try),
              (scene_prop_get_instance, ":var15", "spr_belfry_b_platform_a", ":var3"),
            (try_end),
            (prop_instance_get_starting_position, pos0, ":var15"),
            (prop_instance_animate_to_position, ":var15", pos0, 400),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (1, 5, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
      (try_begin),
        (multiplayer_is_server),
        (this_or_next|player_is_active, ":var0"),
        (eq, ":var0", 0),
        (store_mission_timer_a, ":var1"),
        (val_sub, ":var1", "$g_round_start_time"),
        (try_begin),
          (lt, ":var1", 25),
          (assign, ":var2", 0),
        (else_try),
          (lt, ":var1", 60),
          (assign, ":var2", 1),
        (else_try),
          (lt, ":var1", 105),
          (assign, ":var2", 2),
        (else_try),
          (lt, ":var1", 160),
          (assign, ":var2", 3),
        (else_try),
          (assign, ":var2", "$g_multiplayer_number_of_respawn_count"),
        (try_end),
        (player_set_slot, ":var0", 39, ":var2"),
        (multiplayer_send_int_to_player, ":var0", 89, ":var2"),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_multiplayer_game_type", 6),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (try_begin),
        (multiplayer_is_server),
        (try_for_range, ":var0", 176, 186),
          (troop_set_slot, "trp_multiplayer_data", ":var0", -1),
        (try_end),
        (assign, "$g_my_spawn_count", 0),
      (else_try),
        (assign, "$g_my_spawn_count", 0),
      (try_end),
      (assign, "$g_waiting_for_confirmation_to_terminate", 0),
      (assign, "$g_round_ended", 0),
      (try_begin),
        (multiplayer_is_server),
        (assign, "$g_round_start_time", 0),
      (try_end),
      (assign, "$my_team_at_start_of_round", -1),
      (assign, "$g_flag_is_not_ready", 0),
      (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_destroy_mod_targets"),
      (call_script, "script_multiplayer_remove_headquarters_flags"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_determine_team_flags", 0),
      (set_spawn_effector_scene_prop_kind, 0, -1),
      (set_spawn_effector_scene_prop_kind, 1, -1),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (assign, "$g_number_of_flags", 0),
      (try_begin),
        (multiplayer_is_server),
        (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
        (entry_point_get_position, pos1, 66),
        (set_spawn_position, pos1),
        (spawn_scene_prop, "spr_headquarters_pole_code_only", 0),
        (position_move_z, pos1, 900),
        (set_spawn_position, pos1),
        (spawn_scene_prop, "$team_1_flag_scene_prop", 0),
        (store_add, ":var0", 146, "$g_number_of_flags"),
        (troop_set_slot, "trp_multiplayer_data", ":var0", 1),
      (try_end),
      (val_add, "$g_number_of_flags", 1),
      (try_begin),
        (multiplayer_is_server),
        (scene_prop_get_num_instances, ":var1", "spr_belfry_a"),
        (try_for_range, ":var2", 0, ":var1"),
          (scene_prop_get_instance, ":var3", "spr_belfry_a", ":var2"),
          (scene_prop_set_slot, ":var3", 5, 1),
        (try_end),
        (scene_prop_get_num_instances, ":var1", "spr_belfry_b"),
        (try_for_range, ":var2", 0, ":var1"),
          (scene_prop_get_instance, ":var3", "spr_belfry_b", ":var2"),
          (scene_prop_set_slot, ":var3", 5, 1),
        (try_end),
        (call_script, "script_move_belfries_to_their_first_entry_point", "spr_belfry_a"),
        (call_script, "script_move_belfries_to_their_first_entry_point", "spr_belfry_b"),
        (scene_prop_get_num_instances, ":var1", "spr_belfry_a"),
        (try_for_range, ":var2", 0, ":var1"),
          (scene_prop_get_instance, ":var3", "spr_belfry_a", ":var2"),
          (scene_prop_set_slot, ":var3", 3, 0),
          (scene_prop_set_slot, ":var3", 4, 0),
        (try_end),
        (scene_prop_get_num_instances, ":var1", "spr_belfry_b"),
        (try_for_range, ":var2", 0, ":var1"),
          (scene_prop_get_instance, ":var3", "spr_belfry_b", ":var2"),
          (scene_prop_set_slot, ":var3", 3, 0),
          (scene_prop_set_slot, ":var3", 4, 0),
        (try_end),
        (scene_prop_get_num_instances, ":var1", "spr_belfry_a"),
        (try_for_range, ":var2", 0, ":var1"),
          (scene_prop_get_instance, ":var3", "spr_belfry_a", ":var2"),
          (scene_prop_set_slot, ":var3", 5, 0),
        (try_end),
        (scene_prop_get_num_instances, ":var1", "spr_belfry_b"),
        (try_for_range, ":var2", 0, ":var1"),
          (scene_prop_get_instance, ":var3", "spr_belfry_b", ":var2"),
          (scene_prop_set_slot, ":var3", 5, 0),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
      (try_begin),
        (lt, "$my_team_at_start_of_round", 0),
        (multiplayer_get_my_player, ":var1"),
        (ge, ":var1", 0),
        (player_get_agent_id, ":var2", ":var1"),
        (eq, ":var2", ":var0"),
        (ge, ":var2", 0),
        (agent_get_team, "$my_team_at_start_of_round", ":var2"),
      (try_end),
      (try_begin),
        (neg|multiplayer_is_server),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (assign, "$g_round_ended", 0),
          (assign, "$g_my_spawn_count", 0),
          (call_script, "script_initialize_all_scene_prop_slots"),
          (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
          (call_script, "script_initialize_objects_clients"),
        (try_end),
      (try_end),
      (try_begin),
        (multiplayer_get_my_player, ":var1"),
        (ge, ":var1", 0),
        (player_get_agent_id, ":var2", ":var1"),
        (eq, ":var2", ":var0"),
        (val_add, "$g_my_spawn_count", 1),
        (try_begin),
          (ge, "$g_my_spawn_count", "$g_multiplayer_number_of_respawn_count"),
          (gt, "$g_multiplayer_number_of_respawn_count", 0),
          (multiplayer_get_my_player, ":var1"),
          (player_get_team_no, ":var3", ":var1"),
          (eq, ":var3", 0),
          (assign, "$g_my_spawn_count", 999),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
      (try_begin),
        (lt, "$my_team_at_start_of_round", 0),
        (multiplayer_get_my_player, ":var2"),
        (ge, ":var2", 0),
        (player_get_agent_id, ":var3", ":var2"),
        (ge, ":var3", 0),
        (agent_get_team, "$my_team_at_start_of_round", ":var3"),
      (try_end),
      (try_begin),
        (multiplayer_is_server),
        (agent_is_human, ":var0"),
        (neg|agent_is_non_player, ":var0"),
        (agent_get_player_id, ":var4", ":var0"),
        (player_set_slot, ":var4", 0, 0),
      (try_end),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart"),
    ]),

    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 0),
      (try_for_range, ":var0", 0, "$g_number_of_flags"),
        (store_add, ":var1", 156, ":var0"),
        (troop_get_slot, ":var2", "trp_multiplayer_data", ":var1"),
        (store_div, ":var3", ":var2", 100),
        (store_mod, ":var4", ":var2", 100),
        (assign, ":var5", 0),
        (assign, ":var6", 0),
        (scene_prop_get_instance, ":var7", "spr_headquarters_pole_code_only", ":var0"),
        (prop_instance_get_position, pos0, ":var7"),
        (get_max_players, ":var8"),
        (try_for_range, ":var9", 0, ":var8"),
          (player_is_active, ":var9"),
          (player_get_agent_id, ":var10", ":var9"),
          (ge, ":var10", 0),
          (agent_is_alive, ":var10"),
          (agent_get_team, ":var11", ":var10"),
          (agent_get_position, pos1, ":var10"),
          (get_sq_distance_between_positions, ":var12", pos0, pos1),
          (get_sq_distance_between_position_heights, ":var13", pos0, pos1),
          (val_add, ":var12", ":var13"),
          (lt, ":var12", 1600),
          (try_begin),
            (eq, ":var11", 0),
            (val_add, ":var5", 1),
          (else_try),
            (eq, ":var11", 1),
            (val_add, ":var6", 1),
          (try_end),
        (try_end),
        (try_begin),
          (this_or_next|neq, ":var3", ":var5"),
          (neq, ":var4", ":var6"),
          (store_add, ":var14", 176, ":var0"),
          (troop_get_slot, ":var15", "trp_multiplayer_data", ":var14"),
          (store_mod, ":var16", ":var15", 100),
          (store_div, ":var17", ":var15", 100),
          (try_begin),
            (eq, ":var4", 0),
            (gt, ":var6", 0),
            (eq, ":var5", 0),
            (assign, ":var18", 2),
            (store_mul, ":var19", ":var18", 100),
            (troop_set_slot, "trp_multiplayer_data", ":var14", ":var19"),
            (this_or_next|neq, ":var17", ":var18"),
            (ge, ":var16", 25),
            (store_mul, ":var20", ":var18", 100),
            (val_add, ":var20", ":var0"),
          (try_end),
          (try_begin),
            (store_mul, ":var2", ":var5", 100),
            (val_add, ":var2", ":var6"),
            (troop_set_slot, "trp_multiplayer_data", ":var1", ":var2"),
            (get_max_players, ":var8"),
            (call_script, "script_set_num_agents_around_flag", ":var0", ":var2"),
            (try_for_range, ":var9", 1, ":var8"),
              (player_is_active, ":var9"),
              (multiplayer_send_2_int_to_player, ":var9", 73, ":var0", ":var2"),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_for_range, ":var0", 0, "$g_number_of_flags"),
        (eq, "$g_round_ended", 0),
        (eq, "$g_flag_is_not_ready", 0),
        (scene_prop_get_instance, ":var7", "spr_headquarters_pole_code_only", ":var0"),
        (prop_instance_get_position, pos0, ":var7"),
        (try_begin),
          (scene_prop_get_instance, ":var21", "$team_1_flag_scene_prop", ":var0"),
          (prop_instance_get_position, pos1, ":var21"),
          (try_begin),
            (get_sq_distance_between_positions, ":var12", pos0, pos1),
            (lt, ":var12", 400),
            (prop_instance_is_animating, ":var22", ":var21"),
            (eq, ":var22", 1),
            (assign, "$g_winner_team", 1),
            (prop_instance_stop_animating, ":var21"),
            (get_max_players, ":var8"),
            (call_script, "script_draw_this_round", "$g_winner_team"),
            (try_for_range, ":var9", 1, ":var8"),
              (player_is_active, ":var9"),
              (multiplayer_send_int_to_player, ":var9", 69, "$g_winner_team"),
            (try_end),
            (assign, "$g_flag_is_not_ready", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (assign, ":var0", "$g_multiplayer_num_bots_team_1"),
      (assign, ":var1", "$g_multiplayer_num_bots_team_2"),
      (get_max_players, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (player_is_active, ":var3"),
        (player_get_team_no, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var0", 0),
        (eq, ":var1", 0),
        (store_mission_timer_a, ":var5"),
        (val_sub, ":var5", "$g_round_start_time"),
        (le, ":var5", 2),
        (store_mission_timer_a, "$g_round_start_time"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 0),
      (eq, "$g_flag_is_not_ready", 0),
      (store_mission_timer_a, ":var0"),
      (store_sub, ":var1", ":var0", "$g_round_start_time"),
      (ge, ":var1", "$g_multiplayer_round_max_seconds"),
    ],
    [
      (assign, ":var0", 0),
      (store_add, ":var1", 156, ":var0"),
      (troop_get_slot, ":var2", "trp_multiplayer_data", ":var1"),
      (store_mod, ":var3", ":var2", 100),
      (try_begin),
        (eq, ":var3", 0),
        (store_mission_timer_a, "$g_round_finish_time"),
        (assign, "$g_round_ended", 1),
        (assign, "$g_flag_is_not_ready", 1),
        (assign, "$g_winner_team", 0),
        (get_max_players, ":var4"),
        (call_script, "script_draw_this_round", "$g_winner_team"),
        (try_for_range, ":var5", 1, ":var4"),
          (player_is_active, ":var5"),
          (multiplayer_send_int_to_player, ":var5", 69, "$g_winner_team"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (try_for_range, ":var0", 0, "$g_number_of_flags"),
        (store_add, ":var1", 176, ":var0"),
        (troop_get_slot, ":var2", "trp_multiplayer_data", ":var1"),
        (store_mod, ":var3", ":var2", 100),
        (try_begin),
          (ge, ":var2", 100),
          (lt, ":var3", 25),
          (val_add, ":var2", 1),
          (troop_set_slot, "trp_multiplayer_data", ":var1", ":var2"),
        (try_end),
      (try_end),
    ]),

    (10, 0, 0, 
    [
      (multiplayer_is_server),
    ],
    [
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (get_max_players, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (player_is_active, ":var3"),
        (player_get_team_no, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (store_sub, ":var5", ":var0", ":var1"),
      (assign, ":var6", 0),
      (try_begin),
        (try_begin),
          (store_mul, ":var7", "$g_multiplayer_auto_team_balance_limit", -1),
          (le, ":var5", ":var7"),
          (store_div, ":var6", ":var5", -2),
        (else_try),
          (ge, ":var5", "$g_multiplayer_auto_team_balance_limit"),
          (store_div, ":var6", ":var5", 2),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var6", 0),
        (try_begin),
          (eq, "$g_team_balance_next_round", 0),
          (assign, "$g_team_balance_next_round", 1),
          (call_script, "script_show_multiplayer_message", 3, 0),
          (get_max_players, ":var2"),
          (try_for_range, ":var8", 1, ":var2"),
            (player_is_active, ":var8"),
            (multiplayer_send_int_to_player, ":var8", 68, 3),
          (try_end),
          (call_script, "script_warn_player_about_auto_team_balance"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 3, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 1),
      (store_mission_timer_a, ":var0"),
      (val_sub, ":var0", "$g_round_finish_time"),
      (ge, ":var0", "$g_multiplayer_respawn_period"),
    ],
    [
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (get_max_players, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (player_is_active, ":var3"),
        (player_get_team_no, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (store_sub, ":var5", ":var0", ":var1"),
      (assign, ":var6", 0),
      (try_begin),
        (try_begin),
          (store_mul, ":var7", "$g_multiplayer_auto_team_balance_limit", -1),
          (le, ":var5", ":var7"),
          (store_div, ":var6", ":var5", -2),
          (assign, ":var8", 1),
          (assign, ":var9", 0),
        (else_try),
          (ge, ":var5", "$g_multiplayer_auto_team_balance_limit"),
          (store_div, ":var6", ":var5", 2),
          (assign, ":var8", 0),
          (assign, ":var9", 1),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var6", 0),
        (try_begin),
          (try_for_range, ":var10", 0, ":var6"),
            (assign, ":var11", 0),
            (assign, ":var12", -1),
            (get_max_players, ":var2"),
            (try_for_range, ":var13", 0, ":var2"),
              (player_is_active, ":var13"),
              (player_get_team_no, ":var4", ":var13"),
              (eq, ":var4", ":var8"),
              (player_get_slot, ":var14", ":var13", 21),
              (try_begin),
                (gt, ":var14", ":var11"),
                (assign, ":var11", ":var14"),
                (assign, ":var12", ":var13"),
              (try_end),
            (try_end),
            (try_begin),
              (ge, ":var12", 0),
              (try_begin),
                (player_get_agent_id, ":var15", ":var12"),
                (ge, ":var15", 0),
                (agent_is_alive, ":var15"),
                (player_get_kill_count, ":var16", ":var12"),
                (val_add, ":var16", 1),
                (player_set_kill_count, ":var12", ":var16"),
                (player_get_death_count, ":var17", ":var12"),
                (val_sub, ":var17", 1),
                (player_set_death_count, ":var12", ":var17"),
                (player_get_score, ":var18", ":var12"),
                (val_add, ":var18", 1),
                (player_set_score, ":var12", ":var18"),
                (try_for_range, ":var13", 1, ":var2"),
                  (player_is_active, ":var13"),
                  (multiplayer_send_4_int_to_player, ":var13", 86, ":var12", ":var18", ":var16", ":var17"),
                (try_end),
                (player_get_value_of_original_items, ":var19", ":var12"),
                (player_get_gold, ":var20", ":var12"),
                (val_add, ":var20", ":var19"),
                (player_set_gold, ":var12", ":var20", 15000),
              (try_end),
              (player_set_troop_id, ":var12", -1),
              (player_set_team_no, ":var12", ":var9"),
              (multiplayer_send_message_to_player, ":var12", 79),
            (try_end),
          (try_end),
          (call_script, "script_show_multiplayer_message", 2, 0),
          (multiplayer_get_my_player, ":var21"),
          (get_max_players, ":var2"),
          (try_for_range, ":var13", 0, ":var2"),
            (player_is_active, ":var13"),
            (neq, ":var21", ":var13"),
            (multiplayer_send_int_to_player, ":var13", 68, 2),
          (try_end),
          (assign, "$g_team_balance_next_round", 0),
        (try_end),
      (try_end),
      (assign, "$g_team_balance_next_round", 0),
      (get_max_players, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (player_is_active, ":var13"),
        (player_set_slot, ":var13", 0, 0),
        (player_set_slot, ":var13", 25, 0),
        (player_get_agent_id, ":var22", ":var13"),
        (ge, ":var22", 0),
        (agent_is_alive, ":var22"),
        (player_save_picked_up_items_for_next_spawn, ":var13"),
        (player_get_value_of_original_items, ":var19", ":var13"),
        (player_set_slot, ":var13", 1, ":var19"),
      (try_end),
      (assign, ":var23", 500),
      (val_mul, ":var23", "$g_multiplayer_round_earnings_multiplier"),
      (val_div, ":var23", 100),
      (get_max_players, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (player_is_active, ":var13"),
        (player_get_gold, ":var20", ":var13"),
        (player_get_team_no, ":var4", ":var13"),
        (try_begin),
          (this_or_next|eq, ":var4", 0),
          (eq, ":var4", 1),
          (val_add, ":var20", ":var23"),
        (try_end),
        (try_begin),
          (player_get_slot, ":var19", ":var13", 1),
          (store_add, ":var24", ":var20", ":var19"),
          (store_mul, ":var25", "$g_multiplayer_initial_gold_multiplier", 10),
          (lt, ":var24", ":var25"),
          (store_sub, ":var26", ":var25", ":var24"),
          (val_add, ":var20", ":var26"),
        (try_end),
        (player_set_gold, ":var13", ":var20", 15000),
      (try_end),
      (assign, "$my_team_at_start_of_round", -1),
      (multiplayer_clear_scene),
      (assign, "$g_my_spawn_count", 0),
      (get_max_players, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (player_is_active, ":var13"),
        (player_set_slot, ":var13", 39, 0),
      (try_end),
      (call_script, "script_initialize_objects"),
      (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
      (call_script, "script_multiplayer_close_gate_if_it_is_open"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (call_script, "script_move_belfries_to_their_first_entry_point", "spr_belfry_a"),
      (call_script, "script_move_belfries_to_their_first_entry_point", "spr_belfry_b"),
      (scene_prop_get_num_instances, ":var27", "spr_belfry_a"),
      (try_for_range, ":var28", 0, ":var27"),
        (scene_prop_get_instance, ":var29", "spr_belfry_a", ":var28"),
        (scene_prop_set_slot, ":var29", 3, 0),
        (scene_prop_set_slot, ":var29", 4, 0),
      (try_end),
      (scene_prop_get_num_instances, ":var27", "spr_belfry_a"),
      (try_for_range, ":var28", 0, ":var27"),
        (scene_prop_get_instance, ":var29", "spr_belfry_a", ":var28"),
        (scene_prop_set_slot, ":var29", 5, 0),
      (try_end),
      (scene_prop_get_num_instances, ":var27", "spr_belfry_b"),
      (try_for_range, ":var28", 0, ":var27"),
        (scene_prop_get_instance, ":var29", "spr_belfry_b", ":var28"),
        (scene_prop_set_slot, ":var29", 3, 0),
        (scene_prop_set_slot, ":var29", 4, 0),
      (try_end),
      (scene_prop_get_num_instances, ":var27", "spr_belfry_b"),
      (try_for_range, ":var28", 0, ":var27"),
        (scene_prop_get_instance, ":var29", "spr_belfry_b", ":var28"),
        (scene_prop_set_slot, ":var29", 5, 0),
      (try_end),
      (try_for_range, ":var30", 0, "$g_number_of_flags"),
        (scene_prop_get_instance, ":var31", "spr_headquarters_pole_code_only", ":var30"),
        (prop_instance_get_position, pos1, ":var31"),
        (position_move_z, pos1, 900),
        (scene_prop_get_instance, ":var32", "$team_1_flag_scene_prop", ":var30"),
        (prop_instance_stop_animating, ":var32"),
        (prop_instance_set_position, ":var32", pos1),
      (try_end),
      (assign, "$g_round_ended", 0),
      (store_mission_timer_a, "$g_round_start_time"),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (get_max_players, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (player_is_active, ":var13"),
        (multiplayer_send_int_to_player, ":var13", 78, -9999),
      (try_end),
      (assign, "$g_flag_is_not_ready", 0),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (get_max_players, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (player_is_active, ":var1"),
        (neg|player_is_busy_with_menus, ":var1"),
        (player_slot_eq, ":var1", 0, 0),
        (player_get_team_no, ":var2", ":var1"),
        (lt, ":var2", 2),
        (player_get_troop_id, ":var3", ":var1"),
        (ge, ":var3", 0),
        (player_get_agent_id, ":var4", ":var1"),
        (assign, ":var5", 0),
        (assign, ":var6", 0),
        (assign, ":var7", 0),
        (try_begin),
          (assign, ":var8", 0),
          (get_max_players, ":var0"),
          (try_for_range, ":var9", 0, ":var0"),
            (player_is_active, ":var9"),
            (player_get_team_no, ":var10", ":var9"),
            (try_begin),
              (eq, ":var10", 0),
              (val_add, ":var6", 1),
            (else_try),
              (eq, ":var10", 1),
              (val_add, ":var7", 1),
            (try_end),
            (val_add, ":var8", 1),
          (try_end),
          (store_mission_timer_a, ":var11"),
          (val_sub, ":var11", "$g_round_start_time"),
          (eq, "$g_round_ended", 0),
          (try_begin),
            (lt, ":var4", 0),
            (try_begin),
              (eq, ":var2", 0),
              (player_get_slot, ":var12", ":var1", 28),
              (store_mission_timer_a, ":var13"),
              (store_sub, ":var14", ":var13", ":var12"),
              (assign, ":var15", "$g_multiplayer_respawn_period"),
              (val_add, ":var15", 27),
              (lt, ":var14", ":var15"),
              (store_sub, ":var11", ":var13", "$g_round_start_time"),
              (ge, ":var11", 30),
              (gt, ":var8", 2),
              (store_mul, ":var16", ":var6", ":var7"),
              (neq, ":var16", 0),
              (assign, ":var5", 0),
            (else_try),
              (assign, ":var5", 1),
            (try_end),
          (else_try),
            (agent_get_time_elapsed_since_removed, ":var14", ":var4"),
            (assign, ":var15", "$g_multiplayer_respawn_period"),
            (try_begin),
              (eq, ":var2", 0),
              (val_add, ":var15", 27),
            (try_end),
            (this_or_next|gt, ":var14", ":var15"),
            (player_slot_eq, ":var1", 25, 0),
            (assign, ":var5", 1),
          (try_end),
        (try_end),
        (player_get_slot, ":var17", ":var1", 39),
        (try_begin),
          (gt, "$g_multiplayer_number_of_respawn_count", 0),
          (try_begin),
            (eq, ":var5", 1),
            (eq, ":var2", 0),
            (ge, ":var17", "$g_multiplayer_number_of_respawn_count"),
            (assign, ":var5", 0),
          (else_try),
            (eq, ":var5", 1),
            (eq, ":var2", 1),
            (ge, ":var17", 999),
            (assign, ":var5", 0),
          (try_end),
        (try_end),
        (eq, ":var5", 1),
        (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
        (player_get_slot, ":var17", ":var1", 39),
        (val_add, ":var17", 1),
        (player_set_slot, ":var1", 39, ":var17"),
        (try_begin),
          (ge, ":var17", "$g_multiplayer_number_of_respawn_count"),
          (gt, "$g_multiplayer_number_of_respawn_count", 0),
          (eq, ":var2", 0),
          (assign, ":var17", 999),
          (player_set_slot, ":var1", 39, ":var17"),
        (try_end),
        (assign, ":var18", 0),
        (player_get_item_id, ":var19", ":var1", ek_horse),
        (try_begin),
          (this_or_next|is_between, ":var19", "itm_sumpter_horse", "itm_arrows"),
          (this_or_next|eq, ":var19", "itm_warhorse_sarranid"),
          (eq, ":var19", "itm_warhorse_steppe"),
          (assign, ":var18", 1),
        (try_end),
        (try_begin),
          (lt, ":var11", 20),
          (try_begin),
            (eq, ":var2", 0),
            (call_script, "script_multiplayer_find_spawn_point", ":var2", 1, ":var18"),
            (assign, ":var20", reg0),
          (else_try),
            (eq, ":var2", 1),
            (assign, ":var20", 32),
          (try_end),
        (else_try),
          (call_script, "script_multiplayer_find_spawn_point", ":var2", 0, ":var18"),
          (assign, ":var20", reg0),
        (try_end),
        (player_spawn_new_agent, ":var1", ":var20"),
        (player_set_slot, ":var1", 0, 1),
        (player_set_slot, ":var1", 25, 1),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_agents, ":var3"),
        (agent_is_non_player, ":var3"),
        (agent_is_human, ":var3"),
        (assign, ":var4", 0),
        (try_begin),
          (agent_is_alive, ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (agent_get_time_elapsed_since_removed, ":var5", ":var3"),
          (le, ":var5", "$g_multiplayer_respawn_period"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (agent_get_team, ":var6", ":var3"),
        (try_begin),
          (eq, ":var6", 0),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var6", 1),
          (val_add, ":var2", 1),
        (try_end),
      (try_end),
      (store_sub, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1", ":var1"),
      (store_sub, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2", ":var2"),
      (val_max, "$g_multiplayer_num_bots_required_team_1", 0),
      (val_max, "$g_multiplayer_num_bots_required_team_2", 0),
    ]),

    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (this_or_next|eq, "$g_multiplayer_game_type", 3),
          (eq, "$g_multiplayer_game_type", 6),
          (team_get_score, ":var1", 0),
          (team_get_score, ":var2", 1),
          (store_add, ":var3", ":var1", ":var2"),
          (eq, ":var3", 0),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (lt, ":var4", 20),
          (assign, ":var5", 0),
        (else_try),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 0, ":var0"),
        (val_sub, ":var6", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var6", 0),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var7", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (eq, "$g_multiplayer_game_type", 3),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (try_begin),
            (le, ":var4", 20),
            (assign, ":var8", 0),
          (else_try),
            (assign, ":var8", 1),
          (try_end),
        (else_try),
          (assign, ":var8", 1),
        (try_end),
        (call_script, "script_multiplayer_find_bot_troop_and_group_for_spawn", ":var7", ":var8"),
        (assign, ":var9", reg0),
        (assign, ":var10", reg1),
        (team_get_faction, ":var11", ":var7"),
        (assign, ":var12", 0),
        (try_for_range, ":var13", "trp_swadian_crossbowman_multiplayer_ai", "trp_swadian_crossbowman_multiplayer"),
          (store_faction_of_troop, ":var14", ":var13"),
          (eq, ":var14", ":var11"),
          (val_add, ":var12", 1),
        (try_end),
        (assign, ":var15", 0),
        (get_max_players, ":var16"),
        (try_for_range, ":var17", 0, ":var16"),
          (player_is_active, ":var17"),
          (player_get_team_no, ":var18", ":var17"),
          (eq, ":var7", ":var18"),
          (assign, ":var19", 0),
          (store_add, ":var20", 35, ":var12"),
          (try_for_range, ":var21", 35, ":var20"),
            (player_slot_ge, ":var17", ":var21", 1),
            (assign, ":var19", 1),
            (assign, ":var20", 0),
          (try_end),
          (ge, ":var19", 1),
          (val_add, ":var15", 1),
        (try_end),
        (try_begin),
          (this_or_next|ge, ":var10", 0),
          (eq, ":var15", 0),
          (troop_get_inventory_slot, ":var22", ":var9", ek_horse),
          (try_begin),
            (ge, ":var22", 0),
            (assign, ":var23", 1),
          (else_try),
            (assign, ":var23", 0),
          (try_end),
          (try_begin),
            (eq, "$g_multiplayer_game_type", 6),
            (store_mission_timer_a, ":var4"),
            (val_sub, ":var4", "$g_round_start_time"),
            (try_begin),
              (lt, ":var4", 20),
              (try_begin),
                (eq, ":var7", 0),
                (call_script, "script_multiplayer_find_spawn_point", ":var7", 1, ":var23"),
              (else_try),
                (assign, reg0, 32),
              (try_end),
            (else_try),
              (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
            (try_end),
          (else_try),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (try_begin),
              (eq, ":var7", 0),
              (assign, reg0, 0),
            (else_try),
              (assign, reg0, 32),
            (try_end),
          (else_try),
            (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
          (try_end),
          (store_current_scene, ":var24"),
          (modify_visitors_at_site, ":var24"),
          (add_visitors_to_current_scene, reg0, ":var9", 1, ":var7", ":var10"),
          (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
          (try_begin),
            (eq, ":var7", 0),
            (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
          (else_try),
            (eq, ":var7", 1),
            (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (3, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (try_for_agents, ":var0"),
        (agent_is_non_player, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_group, ":var1", ":var0"),
        (try_begin),
          (neg|player_is_active, ":var1"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (else_try),
          (player_get_team_no, ":var2", ":var1"),
          (agent_get_team, ":var3", ":var0"),
          (neq, ":var2", ":var3"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (assign, ":var0", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_game_type", 2),
        (this_or_next|eq, "$g_multiplayer_game_type", 3),
        (eq, "$g_multiplayer_game_type", 6),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (store_mission_timer_a, ":var1"),
          (val_sub, ":var1", "$g_round_finish_time"),
          (store_sub, ":var2", "$g_multiplayer_respawn_period", 1),
          (ge, ":var1", ":var2"),
          (store_mission_timer_a, ":var3"),
          (try_begin),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (assign, ":var4", 90),
          (else_try),
            (assign, ":var4", 120),
          (try_end),
          (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
          (store_sub, ":var6", ":var5", ":var4"),
          (gt, ":var3", ":var6"),
          (assign, ":var0", 1),
        (try_end),
        (eq, ":var0", 1),
      (else_try),
        (neq, "$g_multiplayer_game_type", 2),
        (neq, "$g_multiplayer_game_type", 3),
        (neq, "$g_multiplayer_game_type", 6),
        (neq, "$g_multiplayer_game_type", 5),
        (store_mission_timer_a, ":var3"),
        (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var3", ":var5"),
        (assign, ":var0", 1),
      (else_try),
        (team_get_score, ":var7", 0),
        (team_get_score, ":var8", 1),
        (try_begin),
          (neq, "$g_multiplayer_game_type", 5),
          (try_begin),
            (this_or_next|ge, ":var7", "$g_multiplayer_game_max_points"),
            (ge, ":var8", "$g_multiplayer_game_max_points"),
            (assign, ":var0", 1),
          (try_end),
        (else_try),
          (assign, ":var9", 0),
          (get_max_players, ":var10"),
          (try_for_range, ":var11", 0, ":var10"),
            (player_is_active, ":var11"),
            (player_get_agent_id, ":var12", ":var11"),
            (ge, ":var12", 0),
            (neg|agent_is_non_player, ":var12"),
            (assign, ":var9", 1),
            (assign, ":var10", 0),
          (try_end),
          (eq, ":var9", 1),
          (this_or_next|le, ":var7", 0),
          (le, ":var8", 0),
          (assign, ":var0", 1),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_round_time_counter"),
      (start_presentation, "prsnt_multiplayer_team_score_display"),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|is_presentation_active, "prsnt_multiplayer_escape_menu"),
      (neg|is_presentation_active, "prsnt_multiplayer_stats_chart"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

  ]),

  ("multiplayer_bt", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (34, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (1, 5, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_multiplayer_game_type", 2),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (assign, "$g_waiting_for_confirmation_to_terminate", 0),
      (assign, "$g_round_ended", 0),
      (assign, "$g_battle_death_mode_started", 0),
      (assign, "$g_reduced_waiting_seconds", 0),
      (try_begin),
        (multiplayer_is_server),
        (assign, "$server_mission_timer_while_player_joined", 0),
        (assign, "$g_round_start_time", 0),
      (try_end),
      (assign, "$my_team_at_start_of_round", -1),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_destroy_mod_targets"),
      (call_script, "script_multiplayer_remove_headquarters_flags"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_determine_team_flags", 0),
      (call_script, "script_determine_team_flags", 1),
      (set_spawn_effector_scene_prop_kind, 0, -1),
      (set_spawn_effector_scene_prop_kind, 1, -1),
      (try_begin),
        (multiplayer_is_server),
        (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
        (entry_point_get_position, pos0, 67),
        (position_set_z_to_ground_level, pos0),
        (position_move_z, pos0, -2000),
        (position_move_x, 0, 100),
        (set_spawn_position, pos0),
        (spawn_scene_prop, "spr_headquarters_pole_code_only", 0),
        (position_move_x, 0, -200),
        (set_spawn_position, pos0),
        (spawn_scene_prop, "spr_headquarters_pole_code_only", 0),
        (scene_prop_get_instance, ":var0", "spr_headquarters_pole_code_only", 0),
        (prop_instance_get_position, pos0, ":var0"),
        (spawn_scene_prop, "$team_1_flag_scene_prop", 0),
        (position_move_z, pos0, 100),
        (prop_instance_set_position, reg0, pos0),
        (scene_prop_get_instance, ":var1", "spr_headquarters_pole_code_only", 1),
        (prop_instance_get_position, pos0, ":var1"),
        (spawn_scene_prop, "$team_2_flag_scene_prop", 0),
        (position_move_z, pos0, 100),
        (prop_instance_set_position, reg0, pos0),
        (assign, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1"),
        (assign, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2"),
      (try_end),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
      (try_begin),
        (lt, "$my_team_at_start_of_round", 0),
        (multiplayer_get_my_player, ":var1"),
        (ge, ":var1", 0),
        (player_get_agent_id, ":var2", ":var1"),
        (eq, ":var2", ":var0"),
        (ge, ":var2", 0),
        (agent_get_team, "$my_team_at_start_of_round", ":var2"),
      (try_end),
      (call_script, "script_calculate_new_death_waiting_time_at_death_mod"),
      (try_begin),
        (neg|multiplayer_is_server),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (assign, "$g_round_ended", 0),
          (call_script, "script_initialize_all_scene_prop_slots"),
          (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
          (call_script, "script_initialize_objects_clients"),
          (try_begin),
            (eq, "$g_team_balance_next_round", 1),
            (assign, "$g_team_balance_next_round", 0),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
      (try_begin),
        (lt, "$my_team_at_start_of_round", 0),
        (multiplayer_get_my_player, ":var2"),
        (ge, ":var2", 0),
        (player_get_agent_id, ":var3", ":var2"),
        (ge, ":var3", 0),
        (agent_get_team, "$my_team_at_start_of_round", ":var3"),
      (try_end),
      (try_begin),
        (agent_is_human, ":var0"),
        (assign, ":var4", 0),
        (assign, ":var5", 0),
        (try_for_agents, ":var6"),
          (agent_is_human, ":var6"),
          (try_begin),
            (agent_is_alive, ":var6"),
            (agent_get_team, ":var7", ":var6"),
            (try_begin),
              (eq, ":var7", 0),
              (val_add, ":var4", 1),
            (else_try),
              (eq, ":var7", 1),
              (val_add, ":var5", 1),
            (try_end),
          (try_end),
        (try_end),
        (try_begin),
          (eq, "$g_round_ended", 0),
          (try_begin),
            (this_or_next|eq, ":var4", 0),
            (eq, ":var5", 0),
            (assign, "$g_winner_team", -1),
            (assign, reg0, "$g_multiplayer_respawn_period"),
            (try_begin),
              (eq, ":var4", 0),
              (try_begin),
                (neq, ":var5", 0),
                (team_get_score, ":var8", 1),
                (val_add, ":var8", 1),
                (team_set_score, 1, ":var8"),
                (assign, "$g_winner_team", 1),
              (try_end),
              (call_script, "script_show_multiplayer_message", 12, "$g_winner_team"),
              (call_script, "script_check_achievement_last_man_standing", "$g_winner_team"),
            (else_try),
              (try_begin),
                (neq, ":var4", 0),
                (team_get_score, ":var9", 0),
                (val_add, ":var9", 1),
                (team_set_score, 0, ":var9"),
                (assign, "$g_winner_team", 0),
              (try_end),
              (call_script, "script_show_multiplayer_message", 12, "$g_winner_team"),
              (call_script, "script_check_achievement_last_man_standing", "$g_winner_team"),
            (try_end),
            (store_mission_timer_a, "$g_round_finish_time"),
            (assign, "$g_round_ended", 1),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (multiplayer_is_server),
        (agent_is_human, ":var0"),
        (neg|agent_is_non_player, ":var0"),
        (ge, ":var0", 0),
        (agent_get_player_id, ":var10", ":var0"),
        (ge, ":var10", 0),
        (set_fixed_point_multiplier, 100),
        (agent_get_player_id, ":var10", ":var0"),
        (agent_get_position, pos0, ":var0"),
        (position_get_x, ":var11", pos0),
        (position_get_y, ":var12", pos0),
        (position_get_z, ":var13", pos0),
        (player_set_slot, ":var10", 29, ":var11"),
        (player_set_slot, ":var10", 30, ":var12"),
        (player_set_slot, ":var10", 31, ":var13"),
      (try_end),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart"),
    ]),

    (1, 0, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_sub, ":var1", ":var0", "$g_round_start_time"),
      (ge, ":var1", "$g_multiplayer_round_max_seconds"),
      (assign, ":var2", 0),
      (try_begin),
        (eq, "$g_battle_death_mode_started", 2),
        (scene_prop_get_instance, ":var3", "spr_headquarters_pole_code_only", 0),
        (scene_prop_get_instance, ":var4", "spr_headquarters_pole_code_only", 1),
        (scene_prop_get_instance, ":var5", "$team_1_flag_scene_prop", 0),
        (scene_prop_get_instance, ":var6", "$team_2_flag_scene_prop", 0),
        (prop_instance_get_position, pos1, ":var3"),
        (prop_instance_get_position, pos2, ":var4"),
        (prop_instance_get_position, pos3, ":var5"),
        (prop_instance_get_position, pos4, ":var6"),
        (get_distance_between_positions, ":var7", pos1, pos3),
        (get_distance_between_positions, ":var8", pos2, pos4),
        (store_add, ":var9", ":var7", 50),
        (store_add, ":var10", ":var8", 50),
        (try_begin),
          (le, ":var7", ":var10"),
          (prop_instance_is_animating, ":var11", ":var5"),
          (eq, ":var11", 1),
          (prop_instance_get_animation_target_position, 5, ":var5"),
          (position_get_z, ":var12", pos5),
          (position_get_z, ":var13", pos3),
          (ge, ":var12", ":var13"),
          (assign, ":var2", 1),
        (try_end),
        (try_begin),
          (le, ":var8", ":var9"),
          (prop_instance_is_animating, ":var11", ":var6"),
          (eq, ":var11", 1),
          (prop_instance_get_animation_target_position, 5, ":var6"),
          (position_get_z, ":var12", pos5),
          (position_get_z, ":var14", pos4),
          (ge, ":var12", ":var14"),
          (assign, ":var2", 1),
        (try_end),
      (try_end),
      (eq, ":var2", 0),
    ],
    [
      (store_mission_timer_a, "$g_round_finish_time"),
      (assign, "$g_round_ended", 1),
      (assign, "$g_winner_team", -1),
      (try_begin),
        (eq, "$g_battle_death_mode_started", 2),
        (scene_prop_get_instance, ":var0", "spr_headquarters_pole_code_only", 0),
        (scene_prop_get_instance, ":var1", "spr_headquarters_pole_code_only", 1),
        (scene_prop_get_instance, ":var2", "$team_1_flag_scene_prop", 0),
        (scene_prop_get_instance, ":var3", "$team_2_flag_scene_prop", 0),
        (prop_instance_get_position, pos1, ":var0"),
        (prop_instance_get_position, pos2, ":var1"),
        (prop_instance_get_position, pos3, ":var2"),
        (prop_instance_get_position, pos4, ":var3"),
        (get_distance_between_positions, ":var4", pos1, pos3),
        (get_distance_between_positions, ":var5", pos2, pos4),
        (try_begin),
          (ge, ":var4", ":var5"),
          (store_sub, ":var6", ":var4", ":var5"),
          (ge, ":var6", 50),
          (assign, "$g_winner_team", 0),
        (else_try),
          (store_sub, ":var6", ":var5", ":var4"),
          (ge, ":var6", 50),
          (assign, "$g_winner_team", 1),
        (try_end),
      (try_end),
      (multiplayer_get_my_player, ":var7"),
      (call_script, "script_draw_this_round", "$g_winner_team"),
      (get_max_players, ":var8"),
      (try_for_range, ":var9", 1, ":var8"),
        (player_is_active, ":var9"),
        (neq, ":var9", ":var7"),
        (multiplayer_send_int_to_player, ":var9", 69, "$g_winner_team"),
      (try_end),
    ]),

    (10, 0, 0, 
    [
      (multiplayer_is_server),
    ],
    [
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (get_max_players, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (player_is_active, ":var3"),
        (player_get_team_no, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (store_sub, ":var5", ":var0", ":var1"),
      (assign, ":var6", 0),
      (try_begin),
        (try_begin),
          (store_mul, ":var7", "$g_multiplayer_auto_team_balance_limit", -1),
          (le, ":var5", ":var7"),
          (store_div, ":var6", ":var5", -2),
        (else_try),
          (ge, ":var5", "$g_multiplayer_auto_team_balance_limit"),
          (store_div, ":var6", ":var5", 2),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var6", 0),
        (try_begin),
          (eq, "$g_team_balance_next_round", 0),
          (assign, "$g_team_balance_next_round", 1),
          (call_script, "script_show_multiplayer_message", 3, 0),
          (get_max_players, ":var2"),
          (try_for_range, ":var8", 1, ":var2"),
            (player_is_active, ":var8"),
            (multiplayer_send_int_to_player, ":var8", 68, 3),
          (try_end),
          (call_script, "script_warn_player_about_auto_team_balance"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 0),
      (eq, "$g_battle_death_mode_started", 0),
      (store_mission_timer_a, ":var0"),
      (val_sub, ":var0", "$g_round_start_time"),
      (store_div, "$g_multiplayer_round_max_seconds_div_2", "$g_multiplayer_round_max_seconds", 2),
      (ge, ":var0", "$g_multiplayer_round_max_seconds_div_2"),
    ],
    [
      (call_script, "script_calculate_new_death_waiting_time_at_death_mod"),
      (assign, "$g_battle_death_mode_started", 1),
    ]),

    (1, 0, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 0),
      (eq, "$g_battle_death_mode_started", 1),
      (store_mission_timer_a, ":var0"),
      (val_sub, ":var0", "$g_death_mode_part_1_start_time"),
      (store_add, ":var1", "$g_battle_waiting_seconds", "$g_reduced_waiting_seconds"),
      (ge, ":var0", ":var1"),
      (store_mission_timer_a, ":var2"),
      (store_sub, ":var3", ":var2", "$g_round_start_time"),
      (store_sub, ":var4", "$g_multiplayer_round_max_seconds", 15),
      (lt, ":var3", ":var4"),
    ],
    [
      (assign, "$g_battle_death_mode_started", 2),
      (call_script, "script_start_death_mode"),
      (get_max_players, ":var0"),
      (try_for_range, ":var1", 1, ":var0"),
        (player_is_active, ":var1"),
        (multiplayer_send_int_to_player, ":var1", 80),
      (try_end),
      (scene_prop_get_instance, ":var2", "spr_headquarters_pole_code_only", 0),
      (scene_prop_get_instance, ":var3", "spr_headquarters_pole_code_only", 1),
      (scene_prop_get_instance, ":var4", "$team_1_flag_scene_prop", 0),
      (scene_prop_get_instance, ":var5", "$team_2_flag_scene_prop", 0),
      (store_random_in_range, "$g_random_entry_point", 0, 3),
      (val_add, "$g_random_entry_point", 67),
      (entry_point_get_position, pos0, "$g_random_entry_point"),
      (position_set_z_to_ground_level, pos0),
      (position_move_x, 0, 100),
      (prop_instance_set_position, ":var2", pos0),
      (position_move_x, 0, -200),
      (prop_instance_set_position, ":var3", pos0),
      (prop_instance_get_position, pos0, ":var2"),
      (position_move_z, pos0, 100),
      (prop_instance_set_position, ":var4", pos0),
      (prop_instance_get_position, pos0, ":var3"),
      (position_move_z, pos0, 100),
      (prop_instance_set_position, ":var5", pos0),
      (start_presentation, "prsnt_multiplayer_flag_projection_display_bt"),
    ]),

    (3, 0, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 0),
      (eq, "$g_battle_death_mode_started", 1),
      (store_mission_timer_a, ":var0"),
      (val_sub, ":var0", "$g_death_mode_part_1_start_time"),
      (store_add, ":var1", "$g_battle_waiting_seconds", "$g_reduced_waiting_seconds"),
      (val_sub, ":var1", 20),
      (ge, ":var0", ":var1"),
    ],
    [
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (eq, ":var0", 0),
        (agent_is_human, ":var1"),
        (try_for_agents, ":var2"),
          (agent_is_human, ":var2"),
          (neq, ":var1", ":var2"),
          (agent_get_team, ":var3", ":var1"),
          (agent_get_team, ":var4", ":var2"),
          (neq, ":var3", ":var4"),
          (agent_get_position, pos1, ":var1"),
          (agent_get_position, pos2, ":var2"),
          (get_sq_distance_between_positions_in_meters, ":var5", pos1, pos2),
          (le, ":var5", 49),
          (assign, ":var0", 1),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (val_add, "$g_reduced_waiting_seconds", 3),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 0),
      (eq, "$g_battle_death_mode_started", 1),
      (store_mission_timer_a, ":var0"),
      (store_sub, ":var1", ":var0", "$g_round_start_time"),
      (store_sub, ":var2", "$g_multiplayer_round_max_seconds", 66),
      (ge, ":var1", ":var2"),
      (store_mission_timer_a, ":var0"),
      (store_sub, ":var1", ":var0", "$g_round_start_time"),
      (store_sub, ":var3", "$g_multiplayer_round_max_seconds", 24),
      (le, ":var1", ":var3"),
    ],
    [
      (val_add, "$g_reduced_waiting_seconds", 1),
    ]),

    (0, 0, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 0),
      (eq, "$g_battle_death_mode_started", 2),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (scene_prop_get_instance, ":var0", "spr_headquarters_pole_code_only", 0),
      (scene_prop_get_instance, ":var1", "spr_headquarters_pole_code_only", 1),
      (scene_prop_get_instance, ":var2", "$team_1_flag_scene_prop", 0),
      (scene_prop_get_instance, ":var3", "$team_2_flag_scene_prop", 0),
      (prop_instance_get_position, pos1, ":var0"),
      (prop_instance_get_position, pos2, ":var1"),
      (prop_instance_get_position, pos3, ":var2"),
      (prop_instance_get_position, pos4, ":var3"),
      (copy_position, 7, 1),
      (position_move_z, pos7, 100),
      (copy_position, 8, 2),
      (position_move_z, pos8, 100),
      (get_distance_between_positions, ":var4", pos1, pos3),
      (get_distance_between_positions, ":var5", pos2, pos4),
      (assign, ":var6", 0),
      (assign, ":var7", 0),
      (get_max_players, ":var8"),
      (try_for_range, ":var9", 0, ":var8"),
        (player_is_active, ":var9"),
        (player_get_agent_id, ":var10", ":var9"),
        (ge, ":var10", 0),
        (agent_is_human, ":var10"),
        (agent_is_alive, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos0, ":var10"),
        (agent_get_horse, ":var12", ":var10"),
        (eq, ":var12", -1),
        (try_begin),
          (eq, ":var11", 0),
          (try_begin),
            (get_sq_distance_between_positions, ":var13", pos0, pos1),
            (lt, ":var13", 1600),
            (try_begin),
              (this_or_next|eq, ":var6", 0),
              (eq, ":var6", 1),
              (assign, ":var6", 1),
            (else_try),
              (assign, ":var6", -2),
            (try_end),
          (try_end),
          (try_begin),
            (get_sq_distance_between_positions, ":var13", pos0, pos2),
            (lt, ":var13", 1600),
            (try_begin),
              (eq, ":var7", 0),
              (assign, ":var7", -1),
            (else_try),
              (eq, ":var7", 1),
              (assign, ":var7", -2),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var11", 1),
          (try_begin),
            (get_sq_distance_between_positions, ":var13", pos0, pos2),
            (lt, ":var13", 1600),
            (try_begin),
              (this_or_next|eq, ":var7", 0),
              (eq, ":var7", 1),
              (assign, ":var7", 1),
            (else_try),
              (assign, ":var7", -2),
            (try_end),
          (try_end),
          (try_begin),
            (get_sq_distance_between_positions, ":var13", pos0, pos1),
            (lt, ":var13", 1600),
            (try_begin),
              (eq, ":var6", 0),
              (assign, ":var6", -1),
            (else_try),
              (eq, ":var6", 1),
              (assign, ":var6", -2),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var4", 800),
        (assign, "$g_winner_team", 0),
        (get_max_players, ":var8"),
        (call_script, "script_draw_this_round", "$g_winner_team"),
        (try_for_range, ":var9", 1, ":var8"),
          (player_is_active, ":var9"),
          (multiplayer_send_int_to_player, ":var9", 69, "$g_winner_team"),
        (try_end),
        (team_get_score, ":var14", 0),
        (call_script, "script_team_set_score", 0, ":var14"),
        (try_for_range, ":var9", 1, ":var8"),
          (player_is_active, ":var9"),
          (multiplayer_send_2_int_to_player, ":var9", 72, 0, ":var14"),
        (try_end),
        (store_mission_timer_a, "$g_round_finish_time"),
        (assign, "$g_round_ended", 1),
      (else_try),
        (ge, ":var5", 800),
        (assign, "$g_winner_team", 1),
        (get_max_players, ":var8"),
        (call_script, "script_draw_this_round", "$g_winner_team"),
        (try_for_range, ":var9", 1, ":var8"),
          (player_is_active, ":var9"),
          (multiplayer_send_int_to_player, ":var9", 69, "$g_winner_team"),
        (try_end),
        (team_get_score, ":var15", 1),
        (call_script, "script_team_set_score", 1, ":var15"),
        (try_for_range, ":var9", 1, ":var8"),
          (player_is_active, ":var9"),
          (multiplayer_send_2_int_to_player, ":var9", 72, 1, ":var15"),
        (try_end),
        (call_script, "script_show_multiplayer_message", 12, 0),
        (call_script, "script_check_achievement_last_man_standing", "$g_winner_team"),
        (store_mission_timer_a, "$g_round_finish_time"),
        (assign, "$g_round_ended", 1),
      (try_end),
      (try_begin),
        (eq, "$g_round_ended", 0),
        (position_get_z, ":var16", pos3),
        (prop_instance_is_animating, ":var17", ":var2"),
        (try_begin),
          (eq, ":var6", -2),
          (eq, ":var17", 1),
          (prop_instance_stop_animating, ":var2"),
        (else_try),
          (this_or_next|eq, ":var6", 0),
          (eq, ":var6", -1),
          (prop_instance_get_animation_target_position, 9, ":var2"),
          (position_get_z, ":var18", pos9),
          (this_or_next|eq, ":var17", 0),
          (gt, ":var18", ":var16"),
          (get_distance_between_positions, ":var19", pos3, pos7),
          (gt, ":var19", 0),
          (val_mul, ":var19", 16),
          (prop_instance_animate_to_position, ":var2", pos7, ":var19"),
        (else_try),
          (eq, ":var6", 1),
          (prop_instance_get_animation_target_position, 9, ":var2"),
          (position_get_z, ":var18", pos9),
          (this_or_next|eq, ":var17", 0),
          (lt, ":var18", ":var16"),
          (copy_position, 5, 1),
          (position_move_z, pos5, 800),
          (get_distance_between_positions, ":var19", pos3, pos5),
          (gt, ":var19", 0),
          (val_mul, ":var19", 8),
          (prop_instance_animate_to_position, ":var2", pos5, ":var19"),
        (try_end),
        (position_get_z, ":var20", pos4),
        (prop_instance_is_animating, ":var17", ":var3"),
        (try_begin),
          (eq, ":var7", -2),
          (eq, ":var17", 1),
          (prop_instance_stop_animating, ":var3"),
        (else_try),
          (this_or_next|eq, ":var7", 0),
          (eq, ":var7", -1),
          (prop_instance_get_animation_target_position, 9, ":var3"),
          (position_get_z, ":var21", pos9),
          (this_or_next|eq, ":var17", 0),
          (gt, ":var21", ":var20"),
          (get_distance_between_positions, ":var22", pos4, pos8),
          (gt, ":var22", 0),
          (val_mul, ":var22", 16),
          (prop_instance_animate_to_position, ":var3", pos8, ":var22"),
        (else_try),
          (eq, ":var7", 1),
          (prop_instance_get_animation_target_position, 9, ":var3"),
          (position_get_z, ":var21", pos9),
          (this_or_next|eq, ":var17", 0),
          (lt, ":var21", ":var20"),
          (copy_position, 6, 2),
          (position_move_z, pos6, 800),
          (get_distance_between_positions, ":var22", pos4, pos6),
          (gt, ":var22", 0),
          (val_mul, ":var22", 8),
          (prop_instance_animate_to_position, ":var3", pos6, ":var22"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 3, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 1),
      (store_mission_timer_a, ":var0"),
      (val_sub, ":var0", "$g_round_finish_time"),
      (ge, ":var0", "$g_multiplayer_respawn_period"),
    ],
    [
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (get_max_players, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (player_is_active, ":var3"),
        (player_get_team_no, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (store_sub, ":var5", ":var0", ":var1"),
      (assign, ":var6", 0),
      (try_begin),
        (try_begin),
          (store_mul, ":var7", "$g_multiplayer_auto_team_balance_limit", -1),
          (le, ":var5", ":var7"),
          (store_div, ":var6", ":var5", -2),
          (assign, ":var8", 1),
          (assign, ":var9", 0),
        (else_try),
          (ge, ":var5", "$g_multiplayer_auto_team_balance_limit"),
          (store_div, ":var6", ":var5", 2),
          (assign, ":var8", 0),
          (assign, ":var9", 1),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var6", 0),
        (try_begin),
          (try_for_range, ":var10", 0, ":var6"),
            (assign, ":var11", 0),
            (assign, ":var12", -1),
            (get_max_players, ":var2"),
            (try_for_range, ":var13", 0, ":var2"),
              (player_is_active, ":var13"),
              (player_get_team_no, ":var4", ":var13"),
              (eq, ":var4", ":var8"),
              (player_get_slot, ":var14", ":var13", 21),
              (try_begin),
                (gt, ":var14", ":var11"),
                (assign, ":var11", ":var14"),
                (assign, ":var12", ":var13"),
              (try_end),
            (try_end),
            (try_begin),
              (ge, ":var12", 0),
              (try_begin),
                (player_get_agent_id, ":var15", ":var12"),
                (ge, ":var15", 0),
                (agent_is_alive, ":var15"),
                (player_get_kill_count, ":var16", ":var12"),
                (val_add, ":var16", 1),
                (player_set_kill_count, ":var12", ":var16"),
                (player_get_death_count, ":var17", ":var12"),
                (val_sub, ":var17", 1),
                (player_set_death_count, ":var12", ":var17"),
                (player_get_score, ":var18", ":var12"),
                (val_add, ":var18", 1),
                (player_set_score, ":var12", ":var18"),
                (try_for_range, ":var13", 1, ":var2"),
                  (player_is_active, ":var13"),
                  (multiplayer_send_4_int_to_player, ":var13", 86, ":var12", ":var18", ":var16", ":var17"),
                (try_end),
                (player_get_value_of_original_items, ":var19", ":var12"),
                (player_get_gold, ":var20", ":var12"),
                (val_add, ":var20", ":var19"),
                (player_set_gold, ":var12", ":var20", 15000),
              (try_end),
              (player_set_troop_id, ":var12", -1),
              (player_set_team_no, ":var12", ":var9"),
              (multiplayer_send_message_to_player, ":var12", 79),
            (try_end),
          (try_end),
          (call_script, "script_show_multiplayer_message", 2, 0),
          (multiplayer_get_my_player, ":var21"),
          (get_max_players, ":var2"),
          (try_for_range, ":var13", 0, ":var2"),
            (player_is_active, ":var13"),
            (neq, ":var21", ":var13"),
            (multiplayer_send_int_to_player, ":var13", 68, 2),
          (try_end),
          (assign, "$g_team_balance_next_round", 0),
        (try_end),
      (try_end),
      (assign, "$g_team_balance_next_round", 0),
      (get_max_players, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (player_is_active, ":var13"),
        (player_set_slot, ":var13", 0, 0),
        (player_get_agent_id, ":var22", ":var13"),
        (ge, ":var22", 0),
        (agent_is_alive, ":var22"),
        (player_save_picked_up_items_for_next_spawn, ":var13"),
        (player_get_value_of_original_items, ":var19", ":var13"),
        (player_set_slot, ":var13", 1, ":var19"),
      (try_end),
      (assign, ":var23", 500),
      (val_mul, ":var23", "$g_multiplayer_round_earnings_multiplier"),
      (val_div, ":var23", 100),
      (get_max_players, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (player_is_active, ":var13"),
        (player_get_gold, ":var20", ":var13"),
        (player_get_team_no, ":var4", ":var13"),
        (try_begin),
          (this_or_next|eq, ":var4", 0),
          (eq, ":var4", 1),
          (val_add, ":var20", ":var23"),
        (try_end),
        (try_begin),
          (player_get_slot, ":var19", ":var13", 1),
          (store_add, ":var24", ":var20", ":var19"),
          (store_mul, ":var25", "$g_multiplayer_initial_gold_multiplier", 10),
          (lt, ":var24", ":var25"),
          (store_sub, ":var26", ":var25", ":var24"),
          (val_add, ":var20", ":var26"),
        (try_end),
        (player_set_gold, ":var13", ":var20", 15000),
      (try_end),
      (assign, "$my_team_at_start_of_round", -1),
      (multiplayer_clear_scene),
      (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
      (try_begin),
        (eq, "$g_battle_death_mode_started", 2),
        (call_script, "script_move_death_mode_flags_down"),
      (try_end),
      (assign, "$g_battle_death_mode_started", 0),
      (assign, "$g_reduced_waiting_seconds", 0),
      (call_script, "script_multiplayer_close_gate_if_it_is_open"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (assign, "$g_round_ended", 0),
      (assign, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1"),
      (assign, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2"),
      (store_mission_timer_a, "$g_round_start_time"),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (get_max_players, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (player_is_active, ":var13"),
        (multiplayer_send_int_to_player, ":var13", 78, -9999),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (assign, ":var0", "$g_multiplayer_num_bots_team_1"),
      (assign, ":var1", "$g_multiplayer_num_bots_team_2"),
      (get_max_players, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (player_is_active, ":var3"),
        (player_get_team_no, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var0", 0),
        (eq, ":var1", 0),
        (store_mission_timer_a, ":var5"),
        (val_sub, ":var5", "$g_round_start_time"),
        (le, ":var5", 2),
        (store_mission_timer_a, "$g_round_start_time"),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (get_max_players, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (player_is_active, ":var1"),
        (neg|player_is_busy_with_menus, ":var1"),
        (try_begin),
          (player_slot_eq, ":var1", 0, 0),
          (player_get_team_no, ":var2", ":var1"),
          (lt, ":var2", 2),
          (player_get_troop_id, ":var3", ":var1"),
          (ge, ":var3", 0),
          (assign, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (try_begin),
            (assign, ":var7", 0),
            (get_max_players, ":var0"),
            (try_for_range, ":var8", 0, ":var0"),
              (player_is_active, ":var8"),
              (val_add, ":var7", 1),
              (player_get_team_no, ":var9", ":var8"),
              (try_begin),
                (eq, ":var9", 0),
                (val_add, ":var5", 1),
              (else_try),
                (eq, ":var9", 1),
                (val_add, ":var6", 1),
              (try_end),
            (try_end),
            (store_mul, ":var10", ":var5", ":var6"),
            (store_mission_timer_a, ":var11"),
            (val_sub, ":var11", "$g_round_start_time"),
            (this_or_next|lt, ":var11", 30),
            (this_or_next|le, ":var7", 2),
            (eq, ":var10", 0),
            (eq, "$g_round_ended", 0),
            (assign, ":var4", 1),
          (try_end),
          (eq, ":var4", 1),
          (try_begin),
            (eq, ":var2", 0),
            (assign, ":var12", 0),
          (else_try),
            (eq, ":var2", 1),
            (assign, ":var12", 32),
          (try_end),
          (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
          (player_spawn_new_agent, ":var1", ":var12"),
          (player_set_slot, ":var1", 0, 1),
        (else_try),
          (eq, "$g_multiplayer_player_respawn_as_bot", 1),
          (player_get_agent_id, ":var13", ":var1"),
          (ge, ":var13", 0),
          (neg|agent_is_alive, ":var13"),
          (agent_get_time_elapsed_since_removed, ":var14", ":var13"),
          (gt, ":var14", "$g_multiplayer_respawn_period"),
          (player_get_team_no, ":var2", ":var1"),
          (assign, ":var15", 0),
          (try_for_agents, ":var16"),
            (eq, ":var15", 0),
            (agent_is_alive, ":var16"),
            (agent_is_human, ":var16"),
            (agent_is_non_player, ":var16"),
            (agent_get_team, ":var17", ":var16"),
            (eq, ":var17", ":var2"),
            (assign, ":var15", 1),
          (try_end),
          (try_begin),
            (eq, ":var15", 1),
            (call_script, "script_find_most_suitable_bot_to_control", ":var1"),
            (player_control_agent, ":var1", reg0),
            (player_get_slot, ":var18", ":var1", 0),
            (val_add, ":var18", 1),
            (player_set_slot, ":var1", 0, ":var18"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (this_or_next|eq, "$g_multiplayer_game_type", 3),
          (eq, "$g_multiplayer_game_type", 6),
          (team_get_score, ":var1", 0),
          (team_get_score, ":var2", 1),
          (store_add, ":var3", ":var1", ":var2"),
          (eq, ":var3", 0),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (lt, ":var4", 20),
          (assign, ":var5", 0),
        (else_try),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 0, ":var0"),
        (val_sub, ":var6", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var6", 0),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var7", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (eq, "$g_multiplayer_game_type", 3),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (try_begin),
            (le, ":var4", 20),
            (assign, ":var8", 0),
          (else_try),
            (assign, ":var8", 1),
          (try_end),
        (else_try),
          (assign, ":var8", 1),
        (try_end),
        (call_script, "script_multiplayer_find_bot_troop_and_group_for_spawn", ":var7", ":var8"),
        (assign, ":var9", reg0),
        (assign, ":var10", reg1),
        (team_get_faction, ":var11", ":var7"),
        (assign, ":var12", 0),
        (try_for_range, ":var13", "trp_swadian_crossbowman_multiplayer_ai", "trp_swadian_crossbowman_multiplayer"),
          (store_faction_of_troop, ":var14", ":var13"),
          (eq, ":var14", ":var11"),
          (val_add, ":var12", 1),
        (try_end),
        (assign, ":var15", 0),
        (get_max_players, ":var16"),
        (try_for_range, ":var17", 0, ":var16"),
          (player_is_active, ":var17"),
          (player_get_team_no, ":var18", ":var17"),
          (eq, ":var7", ":var18"),
          (assign, ":var19", 0),
          (store_add, ":var20", 35, ":var12"),
          (try_for_range, ":var21", 35, ":var20"),
            (player_slot_ge, ":var17", ":var21", 1),
            (assign, ":var19", 1),
            (assign, ":var20", 0),
          (try_end),
          (ge, ":var19", 1),
          (val_add, ":var15", 1),
        (try_end),
        (try_begin),
          (this_or_next|ge, ":var10", 0),
          (eq, ":var15", 0),
          (troop_get_inventory_slot, ":var22", ":var9", ek_horse),
          (try_begin),
            (ge, ":var22", 0),
            (assign, ":var23", 1),
          (else_try),
            (assign, ":var23", 0),
          (try_end),
          (try_begin),
            (eq, "$g_multiplayer_game_type", 6),
            (store_mission_timer_a, ":var4"),
            (val_sub, ":var4", "$g_round_start_time"),
            (try_begin),
              (lt, ":var4", 20),
              (try_begin),
                (eq, ":var7", 0),
                (call_script, "script_multiplayer_find_spawn_point", ":var7", 1, ":var23"),
              (else_try),
                (assign, reg0, 32),
              (try_end),
            (else_try),
              (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
            (try_end),
          (else_try),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (try_begin),
              (eq, ":var7", 0),
              (assign, reg0, 0),
            (else_try),
              (assign, reg0, 32),
            (try_end),
          (else_try),
            (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
          (try_end),
          (store_current_scene, ":var24"),
          (modify_visitors_at_site, ":var24"),
          (add_visitors_to_current_scene, reg0, ":var9", 1, ":var7", ":var10"),
          (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
          (try_begin),
            (eq, ":var7", 0),
            (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
          (else_try),
            (eq, ":var7", 1),
            (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (3, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (try_for_agents, ":var0"),
        (agent_is_non_player, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_group, ":var1", ":var0"),
        (try_begin),
          (neg|player_is_active, ":var1"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (else_try),
          (player_get_team_no, ":var2", ":var1"),
          (agent_get_team, ":var3", ":var0"),
          (neq, ":var2", ":var3"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (assign, ":var0", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_game_type", 2),
        (this_or_next|eq, "$g_multiplayer_game_type", 3),
        (eq, "$g_multiplayer_game_type", 6),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (store_mission_timer_a, ":var1"),
          (val_sub, ":var1", "$g_round_finish_time"),
          (store_sub, ":var2", "$g_multiplayer_respawn_period", 1),
          (ge, ":var1", ":var2"),
          (store_mission_timer_a, ":var3"),
          (try_begin),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (assign, ":var4", 90),
          (else_try),
            (assign, ":var4", 120),
          (try_end),
          (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
          (store_sub, ":var6", ":var5", ":var4"),
          (gt, ":var3", ":var6"),
          (assign, ":var0", 1),
        (try_end),
        (eq, ":var0", 1),
      (else_try),
        (neq, "$g_multiplayer_game_type", 2),
        (neq, "$g_multiplayer_game_type", 3),
        (neq, "$g_multiplayer_game_type", 6),
        (neq, "$g_multiplayer_game_type", 5),
        (store_mission_timer_a, ":var3"),
        (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var3", ":var5"),
        (assign, ":var0", 1),
      (else_try),
        (team_get_score, ":var7", 0),
        (team_get_score, ":var8", 1),
        (try_begin),
          (neq, "$g_multiplayer_game_type", 5),
          (try_begin),
            (this_or_next|ge, ":var7", "$g_multiplayer_game_max_points"),
            (ge, ":var8", "$g_multiplayer_game_max_points"),
            (assign, ":var0", 1),
          (try_end),
        (else_try),
          (assign, ":var9", 0),
          (get_max_players, ":var10"),
          (try_for_range, ":var11", 0, ":var10"),
            (player_is_active, ":var11"),
            (player_get_agent_id, ":var12", ":var11"),
            (ge, ":var12", 0),
            (neg|agent_is_non_player, ":var12"),
            (assign, ":var9", 1),
            (assign, ":var10", 0),
          (try_end),
          (eq, ":var9", 1),
          (this_or_next|le, ":var7", 0),
          (le, ":var8", 0),
          (assign, ":var0", 1),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_round_time_counter"),
      (start_presentation, "prsnt_multiplayer_team_score_display"),
      (try_begin),
        (eq, "$g_battle_death_mode_started", 2),
        (start_presentation, "prsnt_multiplayer_flag_projection_display_bt"),
      (try_end),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|is_presentation_active, "prsnt_multiplayer_escape_menu"),
      (neg|is_presentation_active, "prsnt_multiplayer_stats_chart"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

  ]),

  ("multiplayer_fd", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_0|mtef_visitor_source|mtef_no_auto_reset, 0, aif_start_alarmed, 1, []),
    (34, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (1, 5, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_multiplayer_game_type", 3),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (assign, "$g_waiting_for_confirmation_to_terminate", 0),
      (assign, "$g_round_ended", 0),
      (assign, "$g_reduced_waiting_seconds", 0),
      (try_begin),
        (multiplayer_is_server),
        (assign, "$g_round_start_time", 0),
      (try_end),
      (assign, "$my_team_at_start_of_round", -1),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_headquarters_flags"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_determine_team_flags", 0),
      (call_script, "script_determine_team_flags", 1),
      (set_spawn_effector_scene_prop_kind, 0, -1),
      (set_spawn_effector_scene_prop_kind, 1, -1),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (assign, "$g_destructible_target_1", "spr_catapult_destructible"),
      (assign, "$g_destructible_target_2", "spr_trebuchet_destructible"),
      (scene_prop_get_num_instances, ":var0", "$g_destructible_target_1"),
      (try_for_range, ":var1", 0, ":var0"),
        (scene_prop_get_instance, ":var2", "$g_destructible_target_1", ":var1"),
        (ge, ":var2", 0),
        (scene_prop_set_team, ":var2", 0),
      (try_end),
      (scene_prop_get_num_instances, ":var3", "$g_destructible_target_2"),
      (try_for_range, ":var4", 0, ":var3"),
        (scene_prop_get_instance, ":var5", "$g_destructible_target_2", ":var4"),
        (ge, ":var5", 0),
        (scene_prop_set_team, ":var5", 0),
      (try_end),
      (try_begin),
        (scene_prop_get_num_instances, ":var6", "spr_catapult_destructible"),
        (ge, ":var6", 1),
        (scene_prop_get_instance, ":var7", "spr_catapult_destructible", 0),
        (scene_prop_get_team, "$g_defender_team", ":var7"),
      (else_try),
        (scene_prop_get_num_instances, ":var8", "spr_trebuchet_destructible"),
        (ge, ":var8", 1),
        (scene_prop_get_instance, ":var9", "spr_trebuchet_destructible", 0),
        (scene_prop_get_team, "$g_defender_team", ":var9"),
      (try_end),
      (assign, "$g_number_of_targets_destroyed", 0),
      (try_begin),
        (assign, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1"),
        (assign, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2"),
      (try_end),
      (start_presentation, "prsnt_multiplayer_destructible_targets_display"),
      (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
      (try_begin),
        (lt, "$my_team_at_start_of_round", 0),
        (multiplayer_get_my_player, ":var1"),
        (ge, ":var1", 0),
        (player_get_agent_id, ":var2", ":var1"),
        (eq, ":var2", ":var0"),
        (ge, ":var2", 0),
        (agent_get_team, "$my_team_at_start_of_round", ":var2"),
      (try_end),
      (try_begin),
        (neg|multiplayer_is_server),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (assign, "$g_round_ended", 0),
          (call_script, "script_initialize_all_scene_prop_slots"),
          (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
          (call_script, "script_initialize_objects_clients"),
          (start_presentation, "prsnt_multiplayer_destructible_targets_display"),
          (try_begin),
            (eq, "$g_team_balance_next_round", 1),
            (assign, "$g_team_balance_next_round", 0),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
      (try_begin),
        (lt, "$my_team_at_start_of_round", 0),
        (multiplayer_get_my_player, ":var2"),
        (ge, ":var2", 0),
        (player_get_agent_id, ":var3", ":var2"),
        (ge, ":var3", 0),
        (agent_get_team, "$my_team_at_start_of_round", ":var3"),
      (try_end),
      (try_begin),
        (agent_is_human, ":var0"),
        (assign, ":var4", 0),
        (assign, ":var5", 0),
        (try_for_agents, ":var6"),
          (agent_is_human, ":var6"),
          (try_begin),
            (agent_is_alive, ":var6"),
            (agent_get_team, ":var7", ":var6"),
            (try_begin),
              (eq, ":var7", 0),
              (val_add, ":var4", 1),
            (else_try),
              (eq, ":var7", 1),
              (val_add, ":var5", 1),
            (try_end),
          (try_end),
        (try_end),
        (try_begin),
          (eq, "$g_round_ended", 0),
          (try_begin),
            (this_or_next|eq, ":var4", 0),
            (eq, ":var5", 0),
            (assign, "$g_winner_team", -1),
            (assign, reg0, "$g_multiplayer_respawn_period"),
            (try_begin),
              (eq, ":var4", 0),
              (try_begin),
                (neq, ":var5", 0),
                (assign, "$g_winner_team", 1),
              (try_end),
              (try_begin),
                (eq, "$g_winner_team", -1),
              (else_try),
                (eq, "$g_defender_team", 1),
                (try_begin),
                  (neg|multiplayer_is_server),
                  (call_script, "script_calculate_number_of_targets_destroyed"),
                (try_end),
                (store_sub, ":var8", 2, "$g_number_of_targets_destroyed"),
                (call_script, "script_show_multiplayer_message", 16, ":var8"),
              (else_try),
                (call_script, "script_show_multiplayer_message", 17, 0),
              (try_end),
            (else_try),
              (try_begin),
                (neq, ":var4", 0),
                (assign, "$g_winner_team", 0),
              (try_end),
              (try_begin),
                (eq, "$g_winner_team", -1),
              (else_try),
                (eq, "$g_defender_team", 0),
                (try_begin),
                  (neg|multiplayer_is_server),
                  (call_script, "script_calculate_number_of_targets_destroyed"),
                (try_end),
                (store_sub, ":var8", 2, "$g_number_of_targets_destroyed"),
                (call_script, "script_show_multiplayer_message", 16, ":var8"),
              (else_try),
                (call_script, "script_show_multiplayer_message", 17, 0),
              (try_end),
            (try_end),
            (store_mission_timer_a, "$g_round_finish_time"),
            (assign, "$g_round_ended", 1),
            (try_begin),
              (multiplayer_is_server),
              (ge, "$g_winner_team", 0),
              (lt, "$g_winner_team", 2),
              (neq, "$g_winner_team", -1),
              (team_get_score, ":var9", "$g_winner_team"),
              (store_sub, ":var10", 2, "$g_number_of_targets_destroyed"),
              (val_add, ":var9", ":var10"),
              (call_script, "script_team_set_score", "$g_winner_team", ":var9"),
              (get_max_players, ":var11"),
              (try_for_range, ":var12", 1, ":var11"),
                (player_is_active, ":var12"),
                (multiplayer_send_2_int_to_player, ":var12", 72, "$g_winner_team", ":var9"),
              (try_end),
            (try_end),
            (try_begin),
              (neq, "$g_defender_team", "$g_winner_team"),
              (neq, "$g_winner_team", -1),
              (assign, "$g_number_of_targets_destroyed", 2),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (multiplayer_is_server),
        (agent_is_human, ":var0"),
        (neg|agent_is_non_player, ":var0"),
        (ge, ":var0", 0),
        (agent_get_player_id, ":var13", ":var0"),
        (ge, ":var13", 0),
        (set_fixed_point_multiplier, 100),
        (agent_get_player_id, ":var13", ":var0"),
        (agent_get_position, pos0, ":var0"),
        (position_get_x, ":var14", pos0),
        (position_get_y, ":var15", pos0),
        (position_get_z, ":var16", pos0),
        (player_set_slot, ":var13", 29, ":var14"),
        (player_set_slot, ":var13", 30, ":var15"),
        (player_set_slot, ":var13", 31, ":var16"),
      (try_end),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart"),
    ]),

    (1, 0, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 0),
      (eq, "$g_number_of_targets_destroyed", 2),
    ],
    [
      (store_mission_timer_a, "$g_round_finish_time"),
      (assign, "$g_round_ended", 1),
      (multiplayer_get_my_player, ":var0"),
      (call_script, "script_draw_this_round", -9),
      (get_max_players, ":var1"),
      (try_for_range, ":var2", 1, ":var1"),
        (player_is_active, ":var2"),
        (neq, ":var2", ":var0"),
        (multiplayer_send_int_to_player, ":var2", 69, -9),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_sub, ":var1", ":var0", "$g_round_start_time"),
      (ge, ":var1", "$g_multiplayer_round_max_seconds"),
    ],
    [
      (store_mission_timer_a, "$g_round_finish_time"),
      (assign, "$g_round_ended", 1),
      (assign, "$g_winner_team", -9),
      (multiplayer_get_my_player, ":var0"),
      (store_sub, ":var1", 2, "$g_number_of_targets_destroyed"),
      (call_script, "script_show_multiplayer_message", 16, ":var1"),
      (get_max_players, ":var2"),
      (try_for_range, ":var3", 1, ":var2"),
        (player_is_active, ":var3"),
        (multiplayer_send_2_int_to_player, ":var3", 68, 16, ":var1"),
      (try_end),
      (call_script, "script_draw_this_round", "$g_winner_team"),
      (get_max_players, ":var2"),
      (try_for_range, ":var3", 1, ":var2"),
        (player_is_active, ":var3"),
        (neq, ":var3", ":var0"),
        (multiplayer_send_int_to_player, ":var3", 69, "$g_winner_team"),
      (try_end),
      (try_begin),
        (multiplayer_is_server),
        (assign, "$g_winner_team", "$g_defender_team"),
        (team_get_score, ":var4", "$g_winner_team"),
        (store_sub, ":var5", 2, "$g_number_of_targets_destroyed"),
        (val_add, ":var4", ":var5"),
        (call_script, "script_team_set_score", "$g_winner_team", ":var4"),
        (try_for_range, ":var3", 1, ":var2"),
          (player_is_active, ":var3"),
          (multiplayer_send_2_int_to_player, ":var3", 72, "$g_winner_team", ":var4"),
        (try_end),
      (try_end),
    ]),

    (10, 0, 0, 
    [
      (multiplayer_is_server),
    ],
    [
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (get_max_players, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (player_is_active, ":var3"),
        (player_get_team_no, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (store_sub, ":var5", ":var0", ":var1"),
      (assign, ":var6", 0),
      (try_begin),
        (try_begin),
          (store_mul, ":var7", "$g_multiplayer_auto_team_balance_limit", -1),
          (le, ":var5", ":var7"),
          (store_div, ":var6", ":var5", -2),
        (else_try),
          (ge, ":var5", "$g_multiplayer_auto_team_balance_limit"),
          (store_div, ":var6", ":var5", 2),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var6", 0),
        (try_begin),
          (eq, "$g_team_balance_next_round", 0),
          (assign, "$g_team_balance_next_round", 1),
          (call_script, "script_show_multiplayer_message", 3, 0),
          (get_max_players, ":var2"),
          (try_for_range, ":var8", 1, ":var2"),
            (player_is_active, ":var8"),
            (multiplayer_send_int_to_player, ":var8", 68, 3),
          (try_end),
          (call_script, "script_warn_player_about_auto_team_balance"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 0),
      (eq, "$g_battle_death_mode_started", 2),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (scene_prop_get_instance, ":var0", "spr_headquarters_pole_code_only", 0),
      (scene_prop_get_instance, ":var1", "spr_headquarters_pole_code_only", 1),
      (scene_prop_get_instance, ":var2", "$team_1_flag_scene_prop", 0),
      (scene_prop_get_instance, ":var3", "$team_2_flag_scene_prop", 0),
      (prop_instance_get_position, pos1, ":var0"),
      (prop_instance_get_position, pos2, ":var1"),
      (prop_instance_get_position, pos3, ":var2"),
      (prop_instance_get_position, pos4, ":var3"),
      (copy_position, 7, 1),
      (position_move_z, pos7, 100),
      (copy_position, 8, 2),
      (position_move_z, pos8, 100),
      (get_distance_between_positions, ":var4", pos1, pos3),
      (get_distance_between_positions, ":var5", pos2, pos4),
      (assign, ":var6", 0),
      (assign, ":var7", 0),
      (get_max_players, ":var8"),
      (try_for_range, ":var9", 0, ":var8"),
        (player_is_active, ":var9"),
        (player_get_agent_id, ":var10", ":var9"),
        (ge, ":var10", 0),
        (agent_is_human, ":var10"),
        (agent_is_alive, ":var10"),
        (agent_get_team, ":var11", ":var10"),
        (agent_get_position, pos0, ":var10"),
        (agent_get_horse, ":var12", ":var10"),
        (eq, ":var12", -1),
        (try_begin),
          (eq, ":var11", 0),
          (try_begin),
            (get_sq_distance_between_positions, ":var13", pos0, pos1),
            (lt, ":var13", 1600),
            (try_begin),
              (eq, ":var6", 0),
              (assign, ":var6", 1),
            (else_try),
              (eq, ":var6", -1),
              (assign, ":var6", -2),
            (try_end),
          (try_end),
          (try_begin),
            (get_sq_distance_between_positions, ":var13", pos0, pos2),
            (lt, ":var13", 1600),
            (try_begin),
              (eq, ":var7", 0),
              (assign, ":var7", -1),
            (else_try),
              (eq, ":var7", 1),
              (assign, ":var7", -2),
            (try_end),
          (try_end),
        (else_try),
          (eq, ":var11", 1),
          (try_begin),
            (get_sq_distance_between_positions, ":var13", pos0, pos2),
            (lt, ":var13", 1600),
            (try_begin),
              (eq, ":var7", 0),
              (assign, ":var7", 1),
            (else_try),
              (assign, ":var7", -2),
            (try_end),
          (try_end),
          (try_begin),
            (get_sq_distance_between_positions, ":var13", pos0, pos1),
            (lt, ":var13", 1600),
            (try_begin),
              (eq, ":var6", 0),
              (assign, ":var6", -1),
            (else_try),
              (eq, ":var6", 1),
              (assign, ":var6", -2),
            (try_end),
          (try_end),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var4", 800),
        (assign, "$g_winner_team", 0),
        (get_max_players, ":var8"),
        (call_script, "script_draw_this_round", "$g_winner_team"),
        (try_for_range, ":var9", 1, ":var8"),
          (player_is_active, ":var9"),
          (multiplayer_send_int_to_player, ":var9", 69, "$g_winner_team"),
        (try_end),
        (team_get_score, ":var14", 0),
        (call_script, "script_team_set_score", 0, ":var14"),
        (try_for_range, ":var9", 1, ":var8"),
          (player_is_active, ":var9"),
          (multiplayer_send_2_int_to_player, ":var9", 72, 0, ":var14"),
        (try_end),
        (store_mission_timer_a, "$g_round_finish_time"),
        (assign, "$g_round_ended", 1),
      (else_try),
        (ge, ":var5", 800),
        (assign, "$g_winner_team", 1),
        (get_max_players, ":var8"),
        (call_script, "script_draw_this_round", "$g_winner_team"),
        (try_for_range, ":var9", 1, ":var8"),
          (player_is_active, ":var9"),
          (multiplayer_send_int_to_player, ":var9", 69, "$g_winner_team"),
        (try_end),
        (team_get_score, ":var15", 1),
        (call_script, "script_team_set_score", 1, ":var15"),
        (try_for_range, ":var9", 1, ":var8"),
          (player_is_active, ":var9"),
          (multiplayer_send_2_int_to_player, ":var9", 72, 1, ":var15"),
        (try_end),
        (call_script, "script_show_multiplayer_message", 12, 0),
        (call_script, "script_check_achievement_last_man_standing", "$g_winner_team"),
        (store_mission_timer_a, "$g_round_finish_time"),
        (assign, "$g_round_ended", 1),
      (try_end),
      (try_begin),
        (eq, "$g_round_ended", 0),
        (position_get_z, ":var16", pos3),
        (prop_instance_is_animating, ":var17", ":var2"),
        (try_begin),
          (eq, ":var6", -2),
          (eq, ":var17", 1),
          (prop_instance_stop_animating, ":var2"),
        (else_try),
          (this_or_next|eq, ":var6", 0),
          (eq, ":var6", -1),
          (prop_instance_get_animation_target_position, 9, ":var2"),
          (position_get_z, ":var18", pos9),
          (this_or_next|eq, ":var17", 0),
          (gt, ":var18", ":var16"),
          (get_distance_between_positions, ":var19", pos3, pos7),
          (gt, ":var19", 0),
          (val_mul, ":var19", 16),
          (prop_instance_animate_to_position, ":var2", pos7, ":var19"),
        (else_try),
          (eq, ":var6", 1),
          (prop_instance_get_animation_target_position, 9, ":var2"),
          (position_get_z, ":var18", pos9),
          (this_or_next|eq, ":var17", 0),
          (lt, ":var18", ":var16"),
          (copy_position, 5, 1),
          (position_move_z, pos5, 800),
          (get_distance_between_positions, ":var19", pos3, pos5),
          (gt, ":var19", 0),
          (val_mul, ":var19", 8),
          (prop_instance_animate_to_position, ":var2", pos5, ":var19"),
        (try_end),
        (position_get_z, ":var20", pos4),
        (prop_instance_is_animating, ":var17", ":var3"),
        (try_begin),
          (eq, ":var7", -2),
          (eq, ":var17", 1),
          (prop_instance_stop_animating, ":var3"),
        (else_try),
          (this_or_next|eq, ":var7", 0),
          (eq, ":var7", -1),
          (prop_instance_get_animation_target_position, 9, ":var3"),
          (position_get_z, ":var21", pos9),
          (this_or_next|eq, ":var17", 0),
          (gt, ":var21", ":var20"),
          (get_distance_between_positions, ":var22", pos4, pos8),
          (gt, ":var22", 0),
          (val_mul, ":var22", 16),
          (prop_instance_animate_to_position, ":var3", pos8, ":var22"),
        (else_try),
          (eq, ":var7", 1),
          (prop_instance_get_animation_target_position, 9, ":var3"),
          (position_get_z, ":var21", pos9),
          (this_or_next|eq, ":var17", 0),
          (lt, ":var21", ":var20"),
          (copy_position, 6, 2),
          (position_move_z, pos6, 800),
          (get_distance_between_positions, ":var22", pos4, pos6),
          (gt, ":var22", 0),
          (val_mul, ":var22", 8),
          (prop_instance_animate_to_position, ":var3", pos6, ":var22"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 3, 
    [
      (multiplayer_is_server),
      (eq, "$g_round_ended", 1),
      (store_mission_timer_a, ":var0"),
      (val_sub, ":var0", "$g_round_finish_time"),
      (ge, ":var0", "$g_multiplayer_respawn_period"),
    ],
    [
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (get_max_players, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (player_is_active, ":var3"),
        (player_get_team_no, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (store_sub, ":var5", ":var0", ":var1"),
      (assign, ":var6", 0),
      (try_begin),
        (try_begin),
          (store_mul, ":var7", "$g_multiplayer_auto_team_balance_limit", -1),
          (le, ":var5", ":var7"),
          (store_div, ":var6", ":var5", -2),
          (assign, ":var8", 1),
          (assign, ":var9", 0),
        (else_try),
          (ge, ":var5", "$g_multiplayer_auto_team_balance_limit"),
          (store_div, ":var6", ":var5", 2),
          (assign, ":var8", 0),
          (assign, ":var9", 1),
        (try_end),
      (try_end),
      (try_begin),
        (gt, ":var6", 0),
        (try_begin),
          (try_for_range, ":var10", 0, ":var6"),
            (assign, ":var11", 0),
            (assign, ":var12", -1),
            (get_max_players, ":var2"),
            (try_for_range, ":var13", 0, ":var2"),
              (player_is_active, ":var13"),
              (player_get_team_no, ":var4", ":var13"),
              (eq, ":var4", ":var8"),
              (player_get_slot, ":var14", ":var13", 21),
              (try_begin),
                (gt, ":var14", ":var11"),
                (assign, ":var11", ":var14"),
                (assign, ":var12", ":var13"),
              (try_end),
            (try_end),
            (try_begin),
              (ge, ":var12", 0),
              (try_begin),
                (player_get_agent_id, ":var15", ":var12"),
                (ge, ":var15", 0),
                (agent_is_alive, ":var15"),
                (player_get_kill_count, ":var16", ":var12"),
                (val_add, ":var16", 1),
                (player_set_kill_count, ":var12", ":var16"),
                (player_get_death_count, ":var17", ":var12"),
                (val_sub, ":var17", 1),
                (player_set_death_count, ":var12", ":var17"),
                (player_get_score, ":var18", ":var12"),
                (val_add, ":var18", 1),
                (player_set_score, ":var12", ":var18"),
                (try_for_range, ":var13", 1, ":var2"),
                  (player_is_active, ":var13"),
                  (multiplayer_send_4_int_to_player, ":var13", 86, ":var12", ":var18", ":var16", ":var17"),
                (try_end),
                (player_get_value_of_original_items, ":var19", ":var12"),
                (player_get_gold, ":var20", ":var12"),
                (val_add, ":var20", ":var19"),
                (player_set_gold, ":var12", ":var20", 15000),
              (try_end),
              (player_set_troop_id, ":var12", -1),
              (player_set_team_no, ":var12", ":var9"),
              (multiplayer_send_message_to_player, ":var12", 79),
            (try_end),
          (try_end),
          (call_script, "script_show_multiplayer_message", 2, 0),
          (multiplayer_get_my_player, ":var21"),
          (get_max_players, ":var2"),
          (try_for_range, ":var13", 0, ":var2"),
            (player_is_active, ":var13"),
            (neq, ":var21", ":var13"),
            (multiplayer_send_int_to_player, ":var13", 68, 2),
          (try_end),
          (assign, "$g_team_balance_next_round", 0),
        (try_end),
      (try_end),
      (assign, "$g_team_balance_next_round", 0),
      (get_max_players, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (player_is_active, ":var13"),
        (player_set_slot, ":var13", 0, 0),
        (player_get_agent_id, ":var22", ":var13"),
        (ge, ":var22", 0),
        (agent_is_alive, ":var22"),
        (player_save_picked_up_items_for_next_spawn, ":var13"),
        (player_get_value_of_original_items, ":var19", ":var13"),
        (player_set_slot, ":var13", 1, ":var19"),
      (try_end),
      (assign, ":var23", 500),
      (val_mul, ":var23", "$g_multiplayer_round_earnings_multiplier"),
      (val_div, ":var23", 100),
      (store_sub, ":var24", 2, "$g_number_of_targets_destroyed"),
      (store_mul, ":var25", ":var24", 100),
      (store_mul, ":var26", "$g_number_of_targets_destroyed", 100),
      (val_add, ":var25", 100),
      (val_sub, ":var26", 100),
      (get_max_players, ":var2"),
      (val_mul, ":var25", "$g_multiplayer_round_earnings_multiplier"),
      (val_div, ":var25", 100),
      (val_mul, ":var26", "$g_multiplayer_round_earnings_multiplier"),
      (val_div, ":var26", 100),
      (try_for_range, ":var13", 0, ":var2"),
        (player_is_active, ":var13"),
        (player_get_gold, ":var20", ":var13"),
        (player_get_team_no, ":var4", ":var13"),
        (val_add, ":var20", ":var23"),
        (try_begin),
          (eq, ":var4", "$g_defender_team"),
          (val_add, ":var20", ":var25"),
        (else_try),
          (val_add, ":var20", ":var26"),
        (try_end),
        (try_begin),
          (player_get_slot, ":var19", ":var13", 1),
          (store_add, ":var27", ":var20", ":var19"),
          (store_mul, ":var28", "$g_multiplayer_initial_gold_multiplier", 10),
          (lt, ":var27", ":var28"),
          (store_sub, ":var29", ":var28", ":var27"),
          (val_add, ":var20", ":var29"),
        (try_end),
        (player_set_gold, ":var13", ":var20", 15000),
      (try_end),
      (assign, "$my_team_at_start_of_round", -1),
      (multiplayer_clear_scene),
      (get_max_players, ":var2"),
      (try_for_range, ":var13", 1, ":var2"),
        (player_is_active, ":var13"),
        (player_set_slot, ":var13", 32, 0),
        (player_set_slot, ":var13", 33, 0),
      (try_end),
      (call_script, "script_multiplayer_initialize_belfry_wheel_rotations"),
      (call_script, "script_multiplayer_close_gate_if_it_is_open"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (assign, "$g_round_ended", 0),
      (assign, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1"),
      (assign, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2"),
      (start_presentation, "prsnt_multiplayer_destructible_targets_display"),
      (call_script, "script_initialize_objects"),
      (store_mission_timer_a, "$g_round_start_time"),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (get_max_players, ":var2"),
      (try_for_range, ":var13", 0, ":var2"),
        (player_is_active, ":var13"),
        (multiplayer_send_int_to_player, ":var13", 78, -9999),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (assign, ":var0", "$g_multiplayer_num_bots_team_1"),
      (assign, ":var1", "$g_multiplayer_num_bots_team_2"),
      (get_max_players, ":var2"),
      (try_for_range, ":var3", 0, ":var2"),
        (player_is_active, ":var3"),
        (player_get_team_no, ":var4", ":var3"),
        (try_begin),
          (eq, ":var4", 0),
          (val_add, ":var0", 1),
        (else_try),
          (eq, ":var4", 1),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (try_begin),
        (this_or_next|eq, ":var0", 0),
        (eq, ":var1", 0),
        (store_mission_timer_a, ":var5"),
        (val_sub, ":var5", "$g_round_start_time"),
        (le, ":var5", 2),
        (store_mission_timer_a, "$g_round_start_time"),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (get_max_players, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (player_is_active, ":var1"),
        (neg|player_is_busy_with_menus, ":var1"),
        (try_begin),
          (player_slot_eq, ":var1", 0, 0),
          (player_get_team_no, ":var2", ":var1"),
          (lt, ":var2", 2),
          (player_get_troop_id, ":var3", ":var1"),
          (ge, ":var3", 0),
          (assign, ":var4", 0),
          (assign, ":var5", 0),
          (assign, ":var6", 0),
          (try_begin),
            (assign, ":var7", 0),
            (get_max_players, ":var0"),
            (try_for_range, ":var8", 0, ":var0"),
              (player_is_active, ":var8"),
              (val_add, ":var7", 1),
              (player_get_team_no, ":var9", ":var8"),
              (try_begin),
                (eq, ":var9", 0),
                (val_add, ":var5", 1),
              (else_try),
                (eq, ":var9", 1),
                (val_add, ":var6", 1),
              (try_end),
            (try_end),
            (store_mul, ":var10", ":var5", ":var6"),
            (store_mission_timer_a, ":var11"),
            (val_sub, ":var11", "$g_round_start_time"),
            (this_or_next|lt, ":var11", 30),
            (this_or_next|le, ":var7", 2),
            (eq, ":var10", 0),
            (eq, "$g_round_ended", 0),
            (assign, ":var4", 1),
          (try_end),
          (eq, ":var4", 1),
          (try_begin),
            (eq, ":var2", 0),
            (assign, ":var12", 0),
          (else_try),
            (eq, ":var2", 1),
            (assign, ":var12", 32),
          (try_end),
          (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
          (player_spawn_new_agent, ":var1", ":var12"),
          (player_set_slot, ":var1", 0, 1),
        (else_try),
          (eq, "$g_multiplayer_player_respawn_as_bot", 1),
          (player_get_agent_id, ":var13", ":var1"),
          (ge, ":var13", 0),
          (neg|agent_is_alive, ":var13"),
          (agent_get_time_elapsed_since_removed, ":var14", ":var13"),
          (gt, ":var14", "$g_multiplayer_respawn_period"),
          (player_get_team_no, ":var2", ":var1"),
          (assign, ":var15", 0),
          (try_for_agents, ":var16"),
            (eq, ":var15", 0),
            (agent_is_alive, ":var16"),
            (agent_is_human, ":var16"),
            (agent_is_non_player, ":var16"),
            (agent_get_team, ":var17", ":var16"),
            (eq, ":var17", ":var2"),
            (assign, ":var15", 1),
          (try_end),
          (try_begin),
            (eq, ":var15", 1),
            (call_script, "script_find_most_suitable_bot_to_control", ":var1"),
            (player_control_agent, ":var1", reg0),
            (player_get_slot, ":var18", ":var1", 0),
            (val_add, ":var18", 1),
            (player_set_slot, ":var1", 0, ":var18"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (this_or_next|eq, "$g_multiplayer_game_type", 3),
          (eq, "$g_multiplayer_game_type", 6),
          (team_get_score, ":var1", 0),
          (team_get_score, ":var2", 1),
          (store_add, ":var3", ":var1", ":var2"),
          (eq, ":var3", 0),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (lt, ":var4", 20),
          (assign, ":var5", 0),
        (else_try),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 0, ":var0"),
        (val_sub, ":var6", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var6", 0),
          (assign, ":var7", 0),
        (else_try),
          (assign, ":var7", 1),
        (try_end),
        (try_begin),
          (this_or_next|eq, "$g_multiplayer_game_type", 2),
          (eq, "$g_multiplayer_game_type", 3),
          (store_mission_timer_a, ":var4"),
          (val_sub, ":var4", "$g_round_start_time"),
          (try_begin),
            (le, ":var4", 20),
            (assign, ":var8", 0),
          (else_try),
            (assign, ":var8", 1),
          (try_end),
        (else_try),
          (assign, ":var8", 1),
        (try_end),
        (call_script, "script_multiplayer_find_bot_troop_and_group_for_spawn", ":var7", ":var8"),
        (assign, ":var9", reg0),
        (assign, ":var10", reg1),
        (team_get_faction, ":var11", ":var7"),
        (assign, ":var12", 0),
        (try_for_range, ":var13", "trp_swadian_crossbowman_multiplayer_ai", "trp_swadian_crossbowman_multiplayer"),
          (store_faction_of_troop, ":var14", ":var13"),
          (eq, ":var14", ":var11"),
          (val_add, ":var12", 1),
        (try_end),
        (assign, ":var15", 0),
        (get_max_players, ":var16"),
        (try_for_range, ":var17", 0, ":var16"),
          (player_is_active, ":var17"),
          (player_get_team_no, ":var18", ":var17"),
          (eq, ":var7", ":var18"),
          (assign, ":var19", 0),
          (store_add, ":var20", 35, ":var12"),
          (try_for_range, ":var21", 35, ":var20"),
            (player_slot_ge, ":var17", ":var21", 1),
            (assign, ":var19", 1),
            (assign, ":var20", 0),
          (try_end),
          (ge, ":var19", 1),
          (val_add, ":var15", 1),
        (try_end),
        (try_begin),
          (this_or_next|ge, ":var10", 0),
          (eq, ":var15", 0),
          (troop_get_inventory_slot, ":var22", ":var9", ek_horse),
          (try_begin),
            (ge, ":var22", 0),
            (assign, ":var23", 1),
          (else_try),
            (assign, ":var23", 0),
          (try_end),
          (try_begin),
            (eq, "$g_multiplayer_game_type", 6),
            (store_mission_timer_a, ":var4"),
            (val_sub, ":var4", "$g_round_start_time"),
            (try_begin),
              (lt, ":var4", 20),
              (try_begin),
                (eq, ":var7", 0),
                (call_script, "script_multiplayer_find_spawn_point", ":var7", 1, ":var23"),
              (else_try),
                (assign, reg0, 32),
              (try_end),
            (else_try),
              (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
            (try_end),
          (else_try),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (try_begin),
              (eq, ":var7", 0),
              (assign, reg0, 0),
            (else_try),
              (assign, reg0, 32),
            (try_end),
          (else_try),
            (call_script, "script_multiplayer_find_spawn_point", ":var7", 0, ":var23"),
          (try_end),
          (store_current_scene, ":var24"),
          (modify_visitors_at_site, ":var24"),
          (add_visitors_to_current_scene, reg0, ":var9", 1, ":var7", ":var10"),
          (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
          (try_begin),
            (eq, ":var7", 0),
            (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
          (else_try),
            (eq, ":var7", 1),
            (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (3, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (try_for_agents, ":var0"),
        (agent_is_non_player, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_group, ":var1", ":var0"),
        (try_begin),
          (neg|player_is_active, ":var1"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (else_try),
          (player_get_team_no, ":var2", ":var1"),
          (agent_get_team, ":var3", ":var0"),
          (neq, ":var2", ":var3"),
          (call_script, "script_multiplayer_change_leader_of_bot", ":var0"),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (assign, ":var0", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_game_type", 2),
        (this_or_next|eq, "$g_multiplayer_game_type", 3),
        (eq, "$g_multiplayer_game_type", 6),
        (try_begin),
          (eq, "$g_round_ended", 1),
          (store_mission_timer_a, ":var1"),
          (val_sub, ":var1", "$g_round_finish_time"),
          (store_sub, ":var2", "$g_multiplayer_respawn_period", 1),
          (ge, ":var1", ":var2"),
          (store_mission_timer_a, ":var3"),
          (try_begin),
            (this_or_next|eq, "$g_multiplayer_game_type", 2),
            (eq, "$g_multiplayer_game_type", 3),
            (assign, ":var4", 90),
          (else_try),
            (assign, ":var4", 120),
          (try_end),
          (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
          (store_sub, ":var6", ":var5", ":var4"),
          (gt, ":var3", ":var6"),
          (assign, ":var0", 1),
        (try_end),
        (eq, ":var0", 1),
      (else_try),
        (neq, "$g_multiplayer_game_type", 2),
        (neq, "$g_multiplayer_game_type", 3),
        (neq, "$g_multiplayer_game_type", 6),
        (neq, "$g_multiplayer_game_type", 5),
        (store_mission_timer_a, ":var3"),
        (store_mul, ":var5", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var3", ":var5"),
        (assign, ":var0", 1),
      (else_try),
        (team_get_score, ":var7", 0),
        (team_get_score, ":var8", 1),
        (try_begin),
          (neq, "$g_multiplayer_game_type", 5),
          (try_begin),
            (this_or_next|ge, ":var7", "$g_multiplayer_game_max_points"),
            (ge, ":var8", "$g_multiplayer_game_max_points"),
            (assign, ":var0", 1),
          (try_end),
        (else_try),
          (assign, ":var9", 0),
          (get_max_players, ":var10"),
          (try_for_range, ":var11", 0, ":var10"),
            (player_is_active, ":var11"),
            (player_get_agent_id, ":var12", ":var11"),
            (ge, ":var12", 0),
            (neg|agent_is_non_player, ":var12"),
            (assign, ":var9", 1),
            (assign, ":var10", 0),
          (try_end),
          (eq, ":var9", 1),
          (this_or_next|le, ":var7", 0),
          (le, ":var8", 0),
          (assign, ":var0", 1),
        (try_end),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_round_time_counter"),
      (start_presentation, "prsnt_multiplayer_team_score_display"),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|is_presentation_active, "prsnt_multiplayer_escape_menu"),
      (neg|is_presentation_active, "prsnt_multiplayer_stats_chart"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

  ]),

  ("bandit_lair", mtf_battle_mode, charge,
  "Ambushing a bandit lair",
  [
    (0, mtef_team_0|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 7, []),
    (1, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (2, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (3, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (4, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (5, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (6, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (7, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (8, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (9, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (10, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (assign, "$relative_of_merchant_is_found", 0),
      (try_begin),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (eq, ":var1", 1),
        (agent_get_position, pos4, ":var0"),
        (agent_set_scripted_destination, ":var0", pos4, 1),
      (try_end),
      (try_begin),
        (agent_get_troop_id, ":var2", ":var0"),
        (is_between, ":var2", "trp_relative_of_merchant", "trp_relative_of_merchants_end"),
        (agent_set_team, ":var0", 7),
        (team_set_relation, 0, 7, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (party_get_template_id, ":var0", "$g_encountered_party"),
      (eq, ":var0", "pt_looter_lair"),
      (check_quest_active, "qst_save_relative_of_merchant"),
      (eq, "$relative_of_merchant_is_found", 0),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (is_between, ":var2", "trp_relative_of_merchant", "trp_relative_of_merchants_end"),
        (agent_set_scripted_destination, ":var1", pos0),
        (agent_get_position, pos1, ":var1"),
        (get_distance_between_positions, ":var3", pos0, pos1),
        (le, ":var3", 200),
        (start_mission_conversation, "trp_relative_of_merchant"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "str_cannot_leave_now"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$bandits_spawned_extra", 0),
      (assign, "$g_battle_won", 0),
      (assign, "$g_battle_result", 0),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (eq, ":var1", 1),
        (agent_is_in_special_mode, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_position, pos0, ":var0"),
        (try_for_agents, ":var2"),
          (agent_is_alive, ":var2"),
          (agent_get_team, ":var3", ":var2"),
          (eq, ":var3", 0),
          (agent_is_human, ":var2"),
          (store_agent_hit_points, ":var4", ":var0"),
          (assign, ":var5", 0),
          (try_begin),
            (lt, ":var4", 100),
            (try_for_agents, ":var6"),
              (agent_is_alive, ":var6"),
              (agent_get_team, ":var7", ":var6"),
              (eq, ":var7", 1),
              (neq, ":var0", ":var6"),
              (agent_is_in_special_mode, ":var6"),
              (agent_is_human, ":var6"),
              (agent_get_position, pos1, ":var0"),
              (agent_get_position, pos2, ":var6"),
              (get_distance_between_positions, ":var8", pos1, pos2),
              (le, ":var8", 1000),
              (agent_clear_scripted_mode, ":var6"),
            (try_end),
            (assign, ":var5", 1),
          (else_try),
            (agent_get_position, pos1, ":var0"),
            (agent_get_position, pos2, ":var2"),
            (get_distance_between_positions, ":var8", pos1, pos2),
            (le, ":var8", 4000),
            (try_for_agents, ":var6"),
              (agent_is_alive, ":var6"),
              (agent_get_team, ":var7", ":var6"),
              (eq, ":var7", 1),
              (neq, ":var0", ":var6"),
              (agent_is_in_special_mode, ":var6"),
              (agent_is_human, ":var6"),
              (agent_get_position, pos1, ":var0"),
              (agent_get_position, pos2, ":var6"),
              (get_distance_between_positions, ":var8", pos1, pos2),
              (le, ":var8", 1000),
              (agent_clear_scripted_mode, ":var6"),
            (try_end),
            (assign, ":var5", 1),
          (try_end),
          (eq, ":var5", 1),
          (agent_clear_scripted_mode, ":var0"),
        (try_end),
      (try_end),
    ]),

    (30, 0, 0, 
    [
      (le, "$defender_reinforcement_stage", 1),
    ],
    [
      (store_character_level, ":var0", "trp_player"),
      (store_add, ":var1", 5, ":var0"),
      (val_div, ":var1", 3),
      (lt, "$bandits_spawned_extra", ":var1"),
      (val_add, "$bandits_spawned_extra", 1),
      (party_get_template_id, ":var2", "$g_encountered_party"),
      (store_random_in_range, ":var3", 0, 2),
      (try_begin),
        (eq, ":var2", "pt_sea_raider_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_sea_raider"),
      (else_try),
        (eq, ":var2", "pt_forest_bandit_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_forest_bandit"),
      (else_try),
        (eq, ":var2", "pt_desert_bandit_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_desert_bandit"),
      (else_try),
        (eq, ":var2", "pt_mountain_bandit_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_mountain_bandit"),
      (else_try),
        (eq, ":var2", "pt_taiga_bandit_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_taiga_bandit"),
      (else_try),
        (eq, ":var2", "pt_steppe_bandit_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_steppe_bandit"),
      (else_try),
        (eq, ":var2", "pt_robber_knight_lair"),
        (eq, ":var3", 0),
        (assign, ":var4", "trp_raider"),
      (else_try),
        (this_or_next|eq, ":var2", "pt_looter_lair"),
        (neq, ":var3", 0),
        (assign, ":var4", "trp_looter"),
      (try_end),
      (store_current_scene, ":var5"),
      (modify_visitors_at_site, ":var5"),
      (store_random_in_range, ":var6", 2, 11),
      (add_visitors_to_current_scene, ":var6", ":var4", 1),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_3, ":var1"),
      (try_begin),
        (ge, ":var0", 0),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var2", ":var0"),
        (str_store_troop_name, s6, ":var2"),
        (try_begin),
          (neg|agent_is_ally, ":var0"),
          (party_add_members, "p_total_enemy_casualties", ":var2", 1),
          (try_begin),
            (eq, ":var1", 1),
            (party_wound_members, "p_total_enemy_casualties", ":var2", 1),
          (try_end),
        (try_end),
        (party_add_members, "p_temp_casualties_player", ":var2", 1),
        (eq, ":var1", 1),
        (party_wound_members, "p_temp_casualties_player", ":var2", 1),
      (try_end),
      (assign, ":var3", 0),
      (try_for_agents, ":var4"),
        (agent_is_non_player, ":var4"),
        (agent_is_human, ":var4"),
        (agent_is_alive, ":var4"),
        (neg|agent_is_ally, ":var4"),
        (val_add, ":var3", 1),
      (try_end),
      (try_begin),
        (le, ":var3", 2),
        (le, "$defender_reinforcement_stage", 1),
        (val_add, "$defender_reinforcement_stage", 1),
        (store_character_level, ":var5", "trp_player"),
        (store_add, ":var6", 5, ":var5"),
        (val_div, ":var6", 3),
        (try_begin),
          (ge, "$defender_reinforcement_stage", 2),
          (val_sub, ":var6", "$bandits_spawned_extra"),
        (try_end),
        (party_get_template_id, ":var7", "$g_encountered_party"),
        (store_random_in_range, ":var8", 0, 2),
        (try_begin),
          (eq, ":var7", "pt_sea_raider_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_sea_raider"),
        (else_try),
          (eq, ":var7", "pt_forest_bandit_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_forest_bandit"),
        (else_try),
          (eq, ":var7", "pt_desert_bandit_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_desert_bandit"),
        (else_try),
          (eq, ":var7", "pt_mountain_bandit_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_mountain_bandit"),
        (else_try),
          (eq, ":var7", "pt_taiga_bandit_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_taiga_bandit"),
        (else_try),
          (eq, ":var7", "pt_steppe_bandit_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_steppe_bandit"),
        (else_try),
          (eq, ":var7", "pt_robber_knight_lair"),
          (eq, ":var8", 0),
          (assign, ":var9", "trp_raider"),
        (else_try),
          (this_or_next|eq, ":var7", "pt_looter_lair"),
          (neq, ":var8", 0),
          (assign, ":var9", "trp_looter"),
        (try_end),
        (store_current_scene, ":var10"),
        (modify_visitors_at_site, ":var10"),
        (try_for_range, ":var11", 0, ":var6"),
          (store_random_in_range, ":var12", 2, 11),
          (add_visitors_to_current_scene, ":var12", ":var9", 1),
        (try_end),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 4096),
      (set_party_battle_mode),
    ]),

    (2, 0, ti_once, 
    [
      (neg|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (party_get_template_id, ":var0", "$g_encountered_party"),
      (try_begin),
        (eq, ":var0", "pt_looter_lair"),
        (check_quest_active, "qst_save_relative_of_merchant"),
        (assign, ":var1", "trp_relative_of_merchant"),
        (get_player_agent_no, ":var2"),
        (agent_get_position, pos0, ":var2"),
        (assign, ":var3", 100000),
        (try_for_range, ":var4", 1, 10),
          (entry_point_get_position, pos1, ":var4"),
          (get_distance_between_positions, ":var5", pos0, pos1),
          (le, ":var5", ":var3"),
          (ge, ":var5", 1000),
          (assign, ":var6", ":var4"),
          (assign, ":var3", ":var5"),
        (try_end),
        (add_visitors_to_current_scene, ":var6", ":var1", 1, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (is_presentation_active, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (1, 4, ti_once, 
    [
      (assign, ":var0", 0),
      (party_get_template_id, ":var1", "$g_encountered_party"),
      (try_begin),
        (eq, ":var1", "pt_looter_lair"),
        (check_quest_active, "qst_save_relative_of_merchant"),
        (this_or_next|main_hero_fallen),
        (eq, "$relative_of_merchant_is_found", 1),
        (assign, ":var0", 1),
      (else_try),
        (this_or_next|neq, ":var1", "pt_looter_lair"),
        (neg|check_quest_active, "qst_save_relative_of_merchant"),
        (store_mission_timer_a, ":var2"),
        (ge, ":var2", 5),
        (this_or_next|main_hero_fallen),
        (num_active_teams_le, 1),
        (assign, ":var0", 1),
      (try_end),
      (eq, ":var0", 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
      (else_try),
        (party_set_slot, "$g_encountered_party", 8, 2),
      (try_end),
      (finish_mission),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$enable_deahtcam", 1),
      (assign, "$auxilary_player_active", 0),
      (eq, "$use_player_auxiliary", 1),
      (assign, "$g_move_heroes", 1),
      (party_clear, "p_temp_casualties_3"),
      (call_script, "script_party_add_party", "p_temp_casualties_3", "p_main_party"),
      (set_player_troop, "trp_player"),
      (assign, "$enable_deahtcam", 0),
    ]),

    (5, 0, 0, 
    [
      (eq, "$use_player_auxiliary", 1),
      (eq, "$enable_deahtcam", 0),
      (get_player_agent_no, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (neq, "$freelancer_state", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_division, ":var2", ":var0"),
      (assign, ":var3", 0),
      (try_for_agents, ":var4"),
        (eq, ":var3", 0),
        (agent_is_human, ":var4"),
        (agent_is_alive, ":var4"),
        (agent_get_team, ":var5", ":var4"),
        (agent_get_party_id, ":var6", ":var4"),
        (eq, ":var6", "p_main_party"),
        (agent_get_division, ":var7", ":var0"),
        (agent_get_group, ":var8", ":var0"),
        (eq, ":var1", ":var5"),
        (eq, ":var2", ":var7"),
        (agent_get_troop_id, ":var9", ":var4"),
        (neg|is_between, ":var9", "trp_npc1", "trp_enhanced_rnd_lord_end"),
        (set_player_troop, ":var9"),
        (store_agent_hit_points, ":var10", ":var4", 1),
        (agent_get_position, pos1, ":var4"),
        (position_set_z, pos1, -2000),
        (position_set_x, pos1, 0),
        (position_set_y, pos1, 0),
        (agent_get_position, pos0, ":var4"),
        (set_spawn_position, pos0),
        (agent_get_horse, ":var11", ":var4"),
        (try_begin),
          (gt, ":var11", 0),
          (agent_set_position, ":var11", pos1),
          (remove_agent, ":var11"),
        (try_end),
        (agent_set_position, ":var4", pos1),
        (agent_set_slot, ":var4", 35, 1),
        (agent_get_slot, ":var12", ":var4", 102),
        (remove_agent, ":var4"),
        (spawn_agent, ":var9"),
        (assign, ":var0", reg0),
        (agent_set_slot, ":var0", 102, ":var12"),
        (agent_set_team, ":var0", ":var1"),
        (agent_set_hit_points, ":var0", ":var10", 1),
        (agent_set_group, ":var0", ":var8"),
        (agent_set_slot, ":var0", 35, 2),
        (agent_set_slot, ":var0", 36, ":var9"),
        (try_begin),
          (agent_get_horse, ":var13", ":var0"),
          (gt, ":var13", 0),
          (lt, ":var11", 0),
          (agent_set_position, ":var13", pos1),
          (remove_agent, ":var13"),
        (try_end),
        (set_player_troop, "trp_player"),
        (assign, ":var3", 1),
        (assign, "$auxilary_player_active", 1),
      (try_end),
      (eq, ":var3", 0),
      (assign, "$enable_deahtcam", 1),
    ]),

    (5, 0, 0, 
    [
      (eq, "$use_player_auxiliary", 1),
      (eq, "$enable_deahtcam", 0),
      (get_player_agent_no, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$enable_deahtcam", 1),
    ]),

    (ti_on_agent_hit, 0, 0, 
    [
      (eq, "$g_decap_enabled", 1),
    ],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (agent_is_non_player, ":var0"),
      (agent_get_troop_id, ":var3", ":var0"),
      (neg|troop_is_hero, ":var3"),
      (assign, ":var4", reg0),
      (copy_position, 5, 0),
      (neq, ":var0", -1),
      (try_begin),
        (agent_is_human, ":var0"),
        (ge, ":var4", 0),
        (assign, ":var5", 0),
        (try_begin),
          (this_or_next|eq, ":var4", "itm_supercrossbow"),
          (eq, ":var4", "itm_supersledge"),
          (assign, ":var5", 1),
        (else_try),
          (neq, ":var4", "itm_mace_1"),
          (neq, ":var4", "itm_mace_2"),
          (neq, ":var4", "itm_mace_3"),
          (neq, ":var4", "itm_staff"),
          (agent_get_action_dir, ":var6", ":var1"),
          (this_or_next|eq, ":var6", 1),
          (eq, ":var6", 2),
          (assign, ":var5", 1),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var5", 0),
        (try_begin),
          (ge, ":var2", "$g_decap_minimum_damage"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap minimum DMG req bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (store_agent_hit_points, ":var7", ":var0", 1),
        (val_add, ":var7", "$g_decap_negative_health"),
        (ge, ":var2", ":var7"),
        (agent_get_position, pos4, ":var0"),
        (get_distance_between_positions, ":var8", pos4, pos5),
        (agent_get_horse, ":var9", ":var0"),
        (try_begin),
          (ge, ":var9", 0),
          (assign, ":var10", 240),
          (assign, ":var11", 260),
        (else_try),
          (assign, ":var10", 160),
          (assign, ":var11", 176),
        (try_end),
        (is_between, ":var8", ":var10", ":var11"),
        (assign, ":var5", 0),
        (try_begin),
          (store_random_in_range, ":var12", 0, 100),
          (le, ":var12", "$g_decap_chance"),
          (assign, ":var5", 1),
        (else_try),
          (eq, "$g_decapitations_debugging", 1),
          (assign, ":var5", 1),
          (display_message, "@Decap chance calc bypassed"),
        (try_end),
        (eq, ":var5", 1),
        (assign, ":var13", "itm_cut_off_head_male"),
        (agent_get_troop_id, ":var14", ":var0"),
        (try_begin),
          (ge, ":var14", 0),
          (troop_get_type, ":var15", ":var14"),
          (eq, ":var15", 1),
          (assign, ":var13", "itm_cut_off_head_female"),
        (try_end),
        (store_random_in_range, ":var16", 0, 360),
        (store_random_in_range, ":var17", -60, 60),
        (store_random_in_range, ":var18", -90, 90),
        (store_random_in_range, ":var19", -90, 90),
        (position_rotate_z, pos4, ":var16"),
        (position_rotate_y, pos4, ":var17"),
        (position_move_x, 4, ":var18"),
        (position_move_y, pos4, ":var19"),
        (position_set_z_to_ground_level, pos4),
        (position_move_z, pos4, 5),
        (set_spawn_position, pos4),
        (assign, ":var20", 360),
        (agent_get_item_slot, ":var21", ":var0", 4),
        (try_begin),
          (ge, ":var21", 1),
          (agent_unequip_item, ":var0", ":var21"),
          (try_begin),
            (spawn_item, ":var21", 0, ":var20"),
          (try_end),
        (try_end),
        (agent_equip_item, ":var0", "itm_invisible_head"),
        (agent_get_position, pos4, ":var0"),
        (position_move_z, pos4, ":var10"),
        (particle_system_burst, "psys_blood_decapitation", pos4, "$g_decap_psys_blood_decapitation"),
        (particle_system_burst, "psys_game_blood", pos4, "$g_decap_psys_game_blood"),
        (particle_system_burst, "psys_game_blood_2", pos4, "$g_decap_psys_game_blood_2"),
        (play_sound_at_position, "snd_decapitation", pos4),
        (position_move_z, pos4, 20),
        (set_spawn_position, pos4),
        (assign, ":var13", "spr_head_dynamic_male"),
        (try_begin),
          (eq, ":var15", 1),
          (assign, ":var13", "spr_head_dynamic_female"),
        (try_end),
        (spawn_scene_prop, ":var13"),
        (agent_get_troop_id, ":var22", ":var1"),
        (str_store_troop_name, s0, ":var22"),
        (agent_get_troop_id, ":var14", ":var0"),
        (str_store_troop_name, s1, ":var14"),
        (get_player_agent_no, ":var23"),
        (agent_get_team, ":var24", ":var23"),
        (agent_get_team, ":var25", ":var0"),
        (try_begin),
          (neq, ":var24", ":var25"),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFF33DD11),
        (else_try),
          (display_message, "@>>> {s0} decapitated {s1}!", 0xFFFF4422),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_bully_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_fat_peasant_handless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedhand"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 8),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 85),
        (position_move_x, 1, -32),
        (position_move_y, pos1, 16),
        (position_rotate_x, pos1, -70),
        (particle_system_burst, "psys_game_blood_2", pos1, 80),
        (agent_set_animation, ":var0", "anim_handchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_looter_thug_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_fatseveredarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_dismemberment_enabled", 1),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (eq, ":var1", "trp_thin_looter_armless"),
        (agent_get_wielded_item, ":var2", ":var0", 1),
        (neq, ":var2", "itm_severedarm"),
        (store_agent_hit_points, ":var3", ":var0", 0),
        (val_mul, ":var3", 6),
        (val_div, ":var3", 7),
        (agent_set_hit_points, ":var0", ":var3", 0),
        (get_player_agent_no, ":var4"),
        (agent_deliver_damage_to_agent, ":var4", ":var0", 1),
        (agent_get_position, pos1, ":var0"),
        (position_move_z, pos1, 103),
        (position_move_x, 1, -35),
        (position_move_y, pos1, -10),
        (position_rotate_x, pos1, -90),
        (particle_system_burst, "psys_game_blood_2", pos1, 100),
        (agent_set_animation, ":var0", "anim_armchop"),
      (try_end),
    ]),

    (0, 0, 1, 
    [
      (key_clicked, key_right_control),
    ],
    [
      (try_begin),
        (key_is_down, key_m),
        (try_begin),
          (eq, "$g_decapitations_debugging", 0),
          (assign, "$g_decapitations_debugging", 1),
          (display_message, "@Decapitation debug mode Enabled"),
        (else_try),
          (assign, "$g_decapitations_debugging", 0),
          (display_message, "@Decapitation debug mode Disabled"),
        (try_end),
      (try_end),
      (try_begin),
        (key_is_down, key_k),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos17, ":var0"),
        (position_move_y, pos17, 2000),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_bully_handless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_looter_thug_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_thin_looter_armless"),
        (agent_set_team, reg0, 2),
        (position_move_y, pos17, 100),
        (position_set_z_to_ground_level, pos17),
        (set_spawn_position, pos17),
        (spawn_agent, "trp_fat_peasant_handless"),
        (agent_set_team, reg0, 2),
      (try_end),
      (try_begin),
        (key_is_down, key_j),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos18, ":var0"),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supersledge"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_supercrossbow"),
        (position_move_x, 18, 50),
        (position_set_z_to_ground_level, pos18),
        (set_spawn_position, pos18),
        (spawn_item, "itm_super_bolts"),
      (try_end),
    ]),

  ]),

  ("alley_fight", mtf_battle_mode, charge,
  "Alley fight",
  [
    (0, mtef_team_0|mtef_use_exact_number, af_override_horse, aif_start_alarmed, 7, []),
    (1, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (2, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
    (3, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 20, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (get_player_agent_no, ":var1"),
      (neq, ":var0", ":var1"),
      (assign, "$g_main_attacker_agent", ":var0"),
      (agent_ai_set_aggressiveness, ":var0", 199),
      (try_begin),
        (agent_get_troop_id, ":var2", ":var0"),
        (agent_set_team, ":var0", 7),
        (team_set_relation, 0, 7, 0),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$talked_with_merchant", 0),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (try_for_agents, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (agent_set_scripted_destination, ":var1", pos0),
        (agent_get_position, pos1, ":var1"),
        (get_distance_between_positions, ":var3", pos0, pos1),
        (le, ":var3", 200),
        (assign, "$talk_context", 11),
        (start_mission_conversation, ":var2"),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (ge, "$g_main_attacker_agent", 0),
      (ge, ":var0", 0),
      (agent_is_active, "$g_main_attacker_agent"),
      (agent_is_active, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (agent_get_position, pos1, "$g_main_attacker_agent"),
      (get_distance_between_positions, ":var1", pos0, pos1),
      (ge, ":var1", 5),
      (agent_set_scripted_destination, "$g_main_attacker_agent", pos0),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (display_message, "str_cannot_leave_now"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (call_script, "script_music_set_situation_with_culture", 4096),
      (set_party_battle_mode),
    ]),

    (0, 0, ti_once, 
    [
      (neg|main_hero_fallen),
      (num_active_teams_le, 1),
    ],
    [
      (store_faction_of_party, ":var0", "$g_starting_town"),
    ]),

    (1, 0, ti_once, 
    [
      (eq, "$talked_with_merchant", 1),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (assign, "$g_killed_first_bandit", 0),
      (else_try),
        (assign, "$g_killed_first_bandit", 1),
      (try_end),
      (finish_mission),
      (assign, "$g_main_attacker_agent", 0),
      (assign, "$talked_with_merchant", 1),
      (assign, "$current_startup_quest_phase", 1),
      (change_screen_return),
      (set_trigger_result, 1),
      (get_player_agent_no, ":var0"),
      (store_agent_hit_points, ":var1", ":var0"),
      (try_begin),
        (lt, ":var1", 90),
        (agent_set_hit_points, ":var0", 90),
      (try_end),
    ]),

    (1, 3, ti_once, 
    [
      (main_hero_fallen),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (assign, "$g_killed_first_bandit", 0),
      (else_try),
        (assign, "$g_killed_first_bandit", 1),
      (try_end),
      (finish_mission),
      (assign, "$g_main_attacker_agent", 0),
      (assign, "$talked_with_merchant", 1),
      (assign, "$current_startup_quest_phase", 1),
      (change_screen_return),
      (set_trigger_result, 1),
      (get_player_agent_no, ":var0"),
      (store_agent_hit_points, ":var1", ":var0"),
      (try_begin),
        (lt, ":var1", 90),
        (agent_set_hit_points, ":var0", 90),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("meeting_merchant", 0, -1,
  "Meeting with the merchant",
  [
    (0, mtef_team_0, af_override_horse, 0, 1, []),
    (1, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (agent_get_troop_id, ":var1", ":var0"),
        (agent_set_team, ":var0", 7),
        (team_set_relation, 0, 7, 0),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (assign, "$dialog_with_merchant_ended", 0),
      (store_current_scene, ":var0"),
      (scene_set_slot, ":var0", 0, 1),
      (try_begin),
        (eq, "$sneaked_into_town", 1),
        (call_script, "script_music_set_situation_with_culture", 16384),
      (else_try),
        (eq, "$talk_context", 14),
        (call_script, "script_music_set_situation_with_culture", 512),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", 8192),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (assign, ":var0", 0),
      (try_begin),
        (ge, "$dialog_with_merchant_ended", 6),
        (assign, ":var0", 1),
      (else_try),
        (ge, "$dialog_with_merchant_ended", 1),
        (neg|conversation_screen_is_active),
        (try_begin),
          (eq, "$dialog_with_merchant_ended", 1),
          (check_quest_active, "qst_collect_men"),
          (dialog_box, "str_start_up_first_quest", "@Tutorial"),
        (try_end),
        (val_add, "$dialog_with_merchant_ended", 1),
        (assign, ":var0", 0),
      (try_end),
      (try_begin),
        (conversation_screen_is_active),
        (tutorial_message, -1),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
    ],
    [
      (tutorial_message_set_size, 17, 17),
      (tutorial_message_set_position, pos500, pos650),
      (tutorial_message_set_center_justify, 0),
      (tutorial_message_set_background, 1),
      (tutorial_message, "str_press_tab_to_exit_from_town"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    []),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (gt, "$dialog_with_merchant_ended", 0),
        (assign, ":var0", 0),
        (party_get_position, pos1, "$current_town"),
        (try_for_range, ":var1", 0, 10),
          (map_get_random_position_around_position, pos0, pos1, 2),
          (get_distance_between_positions, ":var2", pos0, pos1),
          (ge, ":var2", ":var0"),
          (assign, ":var0", ":var2"),
          (copy_position, 2, 0),
        (try_end),
        (party_set_position, "p_main_party", pos2),
        (finish_mission),
        (assign, "$current_startup_quest_phase", 2),
        (tutorial_message, -1),
        (tutorial_message_set_background, 0),
        (change_screen_map),
        (try_begin),
          (check_quest_finished, "qst_save_town_from_bandits"),
          (assign, "$g_do_one_more_meeting_with_merchant", 1),
        (else_try),
          (set_spawn_radius, 50),
          (try_for_range, ":var1", 0, 20),
            (spawn_around_party, "p_main_party", "pt_looters"),
          (try_end),
        (try_end),
        (set_trigger_result, 1),
      (else_try),
        (display_message, "str_cannot_leave_now"),
      (try_end),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("town_fight", 0, -1,
  "Town Fight",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (1, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (2, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (3, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (8, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (14, mtef_visitor_source, af_override_horse, 0, 1, []),
    (15, mtef_visitor_source, af_override_horse, 0, 1, []),
    (16, mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_team_1|mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (34, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (35, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (36, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (37, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (38, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (39, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (40, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_team, ":var0", 0),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (mission_disable_talk),
      (assign, "$g_main_attacker_agent", 0),
      (set_party_battle_mode),
      (assign, "$number_of_bandits_killed_by_player", 0),
      (assign, "$number_of_civilian_loses", 0),
      (set_fixed_point_multiplier, 100),
    ]),

    (1, 0, ti_once, 
    [
      (call_script, "script_init_town_walker_agents"),
    ],
    []),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (try_begin),
        (agent_get_team, ":var2", ":var0"),
        (eq, ":var2", 1),
        (get_player_agent_no, ":var3"),
        (eq, ":var3", ":var1"),
        (val_add, "$number_of_bandits_killed_by_player", 1),
      (else_try),
        (eq, ":var2", 0),
        (val_add, "$number_of_civilian_loses", 1),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (lt, "$merchant_sign_count", 8),
      (val_add, "$merchant_sign_count", 1),
      (try_begin),
        (eq, "$merchant_sign_count", 2),
        (get_player_agent_no, ":var0"),
        (try_for_agents, ":var1"),
          (agent_get_troop_id, ":var2", ":var1"),
          (assign, "$g_city_merchant_troop_id", ":var2"),
          (assign, "$g_city_merchant_agent_id", ":var1"),
          (agent_get_position, pos0, ":var0"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var3", -1000),
          (try_for_range, ":var4", 0, 64),
            (entry_point_get_position, pos6, ":var4"),
            (get_distance_between_positions, ":var5", pos0, pos6),
            (get_distance_between_positions, ":var6", pos1, pos6),
            (store_sub, ":var7", ":var6", ":var5"),
            (ge, ":var6", 15),
            (ge, ":var7", ":var3"),
            (copy_position, 2, 6),
            (assign, ":var3", ":var7"),
          (try_end),
          (agent_set_scripted_destination, ":var1", pos2, 0),
          (agent_set_speed_limit, ":var1", 10),
        (try_end),
      (else_try),
        (eq, "$merchant_sign_count", 5),
        (get_player_agent_no, ":var0"),
        (agent_get_position, pos0, ":var0"),
        (agent_set_scripted_destination, "$g_city_merchant_agent_id", pos0, 0),
        (agent_set_speed_limit, "$g_city_merchant_agent_id", 10),
      (else_try),
        (eq, "$merchant_sign_count", 7),
        (agent_clear_scripted_mode, "$g_city_merchant_agent_id"),
        (assign, "$talk_context", 0),
        (start_mission_conversation, "$g_city_merchant_troop_id"),
      (try_end),
    ],
    []),

    (1, 0, 0, 
    [],
    [
      (ge, "$merchant_sign_count", 8),
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (eq, ":var2", 0),
        (agent_get_position, pos0, ":var1"),
        (assign, ":var3", 10000),
        (try_for_agents, ":var4"),
          (agent_is_alive, ":var4"),
          (agent_get_team, ":var5", ":var4"),
          (eq, ":var5", 1),
          (agent_get_position, pos1, ":var4"),
          (get_distance_between_positions, ":var6", pos0, pos1),
          (le, ":var6", ":var3"),
          (assign, ":var3", ":var6"),
          (copy_position, 2, 1),
        (try_end),
        (assign, reg1, ":var6"),
        (try_begin),
          (le, ":var3", 500),
          (agent_clear_scripted_mode, ":var1"),
        (else_try),
          (lt, ":var3", 10000),
          (agent_set_scripted_destination, ":var1", pos2, 0),
        (try_end),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (lt, "$merchant_sign_count", 8),
      (call_script, "script_tick_town_walkers"),
    ],
    []),

    (2, 0, 0, 
    [
      (call_script, "script_center_ambiance_sounds"),
    ],
    []),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
    ]),

    (1, 4, ti_once, 
    [
      (this_or_next|main_hero_fallen),
      (num_active_teams_le, 1),
      (ge, "$merchant_sign_count", 8),
    ],
    [
      (try_begin),
        (main_hero_fallen),
        (assign, "$g_killed_first_bandit", 0),
      (else_try),
        (assign, "$g_killed_first_bandit", 1),
      (try_end),
      (assign, "$current_startup_quest_phase", 4),
      (mission_enable_talk),
      (finish_mission),
      (unlock_achievement, 6),
      (change_screen_return),
      (set_trigger_result, 1),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (try_begin),
        (eq, "$g_mt_mode", 0),
        (set_trigger_result, 1),
      (else_try),
        (eq, "$g_mt_mode", 1),
        (display_message, "str_cant_use_inventory_disguised"),
      (else_try),
        (display_message, "str_cant_use_inventory_now"),
      (try_end),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (display_message, "str_cannot_leave_now"),
    ],
    []),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("multiplayer_duel", mtf_battle_mode, -1,
  "You lead your men to battle.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (32, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (33, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (34, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (35, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (36, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (37, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (38, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (39, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (40, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (41, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (42, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (43, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (44, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (45, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (46, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (47, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (48, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (49, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (50, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (51, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (52, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (53, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (54, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (55, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (56, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (57, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (58, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (59, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (60, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (61, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (62, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (63, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (1, 5, 0, 
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_poll_running", 1),
      (eq, "$g_multiplayer_poll_ended", 0),
      (store_mission_timer_a, ":var0"),
      (store_add, ":var1", "$g_multiplayer_poll_no_count", "$g_multiplayer_poll_yes_count"),
      (this_or_next|eq, ":var1", "$g_multiplayer_poll_num_sent"),
      (gt, ":var0", "$g_multiplayer_poll_end_time"),
      (call_script, "script_cf_multiplayer_evaluate_poll"),
    ],
    [
      (assign, "$g_multiplayer_poll_running", 0),
      (try_begin),
        (this_or_next|eq, "$g_multiplayer_poll_to_show", 0),
        (eq, "$g_multiplayer_poll_to_show", 3),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_poll_value_to_show", 1),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_on_agent_spawn_common", ":var0"),
    ]),

    (ti_server_player_joined, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_multiplayer_server_player_joined_common", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$g_multiplayer_game_type", 7),
      (call_script, "script_multiplayer_server_before_mission_start_common"),
      (team_set_relation, 0, 0, 1),
      (team_set_relation, 0, 1, 1),
      (team_set_relation, 1, 1, 1),
      (mission_set_duel_mode, 1),
      (call_script, "script_multiplayer_init_mission_variables"),
      (call_script, "script_multiplayer_remove_destroy_mod_targets"),
      (call_script, "script_multiplayer_remove_headquarters_flags"),
    ]),

    (ti_after_mission_start, 0, 0, 
    [],
    [
      (set_spawn_effector_scene_prop_kind, 0, -1),
      (set_spawn_effector_scene_prop_kind, 1, -1),
      (call_script, "script_initialize_all_scene_prop_slots"),
      (call_script, "script_multiplayer_move_moveable_objects_initial_positions"),
      (assign, "$g_multiplayer_ready_for_spawning_agent", 1),
    ]),

    (ti_on_multiplayer_mission_end, 0, 0, 
    [],
    [
      (call_script, "script_multiplayer_event_mission_end"),
      (assign, "$g_multiplayer_stats_chart_opened_manually", 0),
      (start_presentation, "prsnt_multiplayer_stats_chart_deathmatch"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (call_script, "script_multiplayer_server_on_agent_killed_or_wounded_common", ":var0", ":var1"),
      (try_begin),
        (get_player_agent_no, ":var2"),
        (agent_is_active, ":var2"),
        (agent_slot_ge, ":var2", 21, 0),
        (try_begin),
          (eq, ":var0", ":var2"),
          (display_message, "str_you_have_lost_a_duel"),
        (else_try),
          (agent_slot_eq, ":var2", 21, ":var0"),
          (display_message, "str_you_have_won_a_duel"),
        (try_end),
      (try_end),
      (try_begin),
        (agent_slot_ge, ":var0", 21, 0),
        (agent_get_slot, ":var3", ":var0", 21),
        (agent_set_slot, ":var0", 21, -1),
        (try_begin),
          (agent_is_active, ":var3"),
          (agent_set_slot, ":var3", 21, -1),
          (agent_clear_relations_with_agents, ":var3"),
          (try_begin),
            (agent_get_player_id, ":var4", ":var3"),
            (neg|player_is_active, ":var4"),
            (agent_force_rethink, ":var3"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (get_max_players, ":var0"),
      (try_for_range, ":var1", 0, ":var0"),
        (player_is_active, ":var1"),
        (neg|player_is_busy_with_menus, ":var1"),
        (player_get_team_no, ":var2", ":var1"),
        (lt, ":var2", 2),
        (player_get_troop_id, ":var3", ":var1"),
        (ge, ":var3", 0),
        (player_get_agent_id, ":var4", ":var1"),
        (assign, ":var5", 0),
        (try_begin),
          (player_get_slot, ":var6", ":var1", 24),
          (eq, ":var6", 1),
          (assign, ":var5", 1),
          (player_set_slot, ":var1", 24, 0),
        (else_try),
          (try_begin),
            (lt, ":var4", 0),
            (assign, ":var5", 1),
          (else_try),
            (neg|agent_is_alive, ":var4"),
            (agent_get_time_elapsed_since_removed, ":var7", ":var4"),
            (gt, ":var7", "$g_multiplayer_respawn_period"),
            (assign, ":var5", 1),
          (try_end),
        (try_end),
        (eq, ":var5", 1),
        (call_script, "script_multiplayer_buy_agent_equipment", ":var1"),
        (troop_get_inventory_slot, ":var8", ":var3", ek_horse),
        (try_begin),
          (ge, ":var8", 0),
          (assign, ":var9", 1),
        (else_try),
          (assign, ":var9", 0),
        (try_end),
        (call_script, "script_multiplayer_find_spawn_point", ":var2", 0, ":var9"),
        (player_spawn_new_agent, ":var1", reg0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 2),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_for_agents, ":var3"),
        (agent_is_non_player, ":var3"),
        (agent_is_human, ":var3"),
        (assign, ":var4", 0),
        (try_begin),
          (agent_is_alive, ":var3"),
          (assign, ":var4", 1),
        (else_try),
          (agent_get_time_elapsed_since_removed, ":var5", ":var3"),
          (le, ":var5", "$g_multiplayer_respawn_period"),
          (assign, ":var4", 1),
        (try_end),
        (eq, ":var4", 1),
        (agent_get_team, ":var6", ":var3"),
        (try_begin),
          (eq, ":var6", 0),
          (val_add, ":var1", 1),
        (else_try),
          (eq, ":var6", 1),
          (val_add, ":var2", 1),
        (try_end),
      (try_end),
      (store_sub, "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_team_1", ":var1"),
      (store_sub, "$g_multiplayer_num_bots_required_team_2", "$g_multiplayer_num_bots_team_2", ":var2"),
      (val_max, "$g_multiplayer_num_bots_required_team_1", 0),
      (val_max, "$g_multiplayer_num_bots_required_team_2", 0),
    ]),

    (0, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (eq, "$g_multiplayer_ready_for_spawning_agent", 1),
      (store_add, ":var0", "$g_multiplayer_num_bots_required_team_1", "$g_multiplayer_num_bots_required_team_2"),
      (try_begin),
        (gt, ":var0", 0),
        (store_random_in_range, ":var1", 0, ":var0"),
        (val_sub, ":var1", "$g_multiplayer_num_bots_required_team_1"),
        (try_begin),
          (lt, ":var1", 0),
          (assign, ":var2", 0),
          (val_sub, "$g_multiplayer_num_bots_required_team_1", 1),
        (else_try),
          (assign, ":var2", 1),
          (val_sub, "$g_multiplayer_num_bots_required_team_2", 1),
        (try_end),
        (team_get_faction, ":var3", ":var2"),
        (assign, ":var4", 0),
        (try_for_range, ":var5", "trp_swadian_crossbowman_multiplayer_ai", "trp_swadian_crossbowman_multiplayer"),
          (store_faction_of_troop, ":var6", ":var5"),
          (eq, ":var6", ":var3"),
          (val_add, ":var4", 1),
        (try_end),
        (store_random_in_range, ":var7", 0, ":var4"),
        (assign, ":var8", "trp_swadian_crossbowman_multiplayer"),
        (try_for_range, ":var5", "trp_swadian_crossbowman_multiplayer_ai", ":var8"),
          (store_faction_of_troop, ":var6", ":var5"),
          (eq, ":var6", ":var3"),
          (val_sub, ":var7", 1),
          (lt, ":var7", 0),
          (assign, ":var8", 0),
          (assign, ":var9", ":var5"),
        (try_end),
        (troop_get_inventory_slot, ":var10", ":var9", ek_horse),
        (try_begin),
          (ge, ":var10", 0),
          (assign, ":var11", 1),
        (else_try),
          (assign, ":var11", 0),
        (try_end),
        (call_script, "script_multiplayer_find_spawn_point", ":var2", 0, ":var11"),
        (store_current_scene, ":var12"),
        (modify_visitors_at_site, ":var12"),
        (add_visitors_to_current_scene, reg0, ":var9", 1, ":var2", -1),
        (assign, "$g_multiplayer_ready_for_spawning_agent", 0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (multiplayer_is_server),
      (assign, ":var0", 0),
      (try_begin),
        (store_mission_timer_a, ":var1"),
        (store_mul, ":var2", "$g_multiplayer_game_max_minutes", 60),
        (gt, ":var1", ":var2"),
        (assign, ":var0", 1),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (call_script, "script_game_multiplayer_get_game_type_mission_template", "$g_multiplayer_game_type"),
        (start_multiplayer_mission, reg0, "$g_multiplayer_selected_map", 0),
        (call_script, "script_game_set_multiplayer_mission_end"),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_multiplayer_mission_end_screen", 0),
        (assign, "$g_multiplayer_stats_chart_opened_manually", 1),
        (start_presentation, "prsnt_multiplayer_stats_chart_deathmatch"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (start_presentation, "prsnt_multiplayer_welcome_message"),
    ]),

    (ti_escape_pressed, 0, 0, 
    [],
    [
      (neg|is_presentation_active, "prsnt_multiplayer_escape_menu"),
      (neg|is_presentation_active, "prsnt_multiplayer_stats_chart_deathmatch"),
      (eq, "$g_waiting_for_confirmation_to_terminate", 0),
      (start_presentation, "prsnt_multiplayer_escape_menu"),
    ]),

  ]),

  ("arena_tournament_fight", mtf_arena_fight, -1,
  "You enter a melee fight in the arena.",
  [
    (0, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (8, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (9, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (10, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (11, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (12, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (13, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (14, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (15, mtef_team_1|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (16, mtef_team_2|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (17, mtef_team_2|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (18, mtef_team_2|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (19, mtef_team_2|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (20, mtef_team_2|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (21, mtef_team_2|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (22, mtef_team_2|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (23, mtef_team_2|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (24, mtef_team_3|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (25, mtef_team_3|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (26, mtef_team_3|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (27, mtef_team_3|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (28, mtef_team_3|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (29, mtef_team_3|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (30, mtef_team_3|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
    (31, mtef_team_3|mtef_visitor_source, 0, aif_start_alarmed, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (assign, "$g_arena_training_num_agents_spawned", 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_arena"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_mt_mode", 2),
        (set_trigger_result, 1),
      (else_try),
        (question_box, "str_give_up_fight"),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (try_begin),
        (eq, "$g_mt_mode", 3),
        (call_script, "script_end_tournament_fight_new", 0),
      (else_try),
        (eq, "$g_mt_mode", 1),
        (get_player_agent_no, ":var1"),
        (agent_get_kill_count, "$g_arena_training_kills", ":var1", 1),
      (try_end),
      (finish_mission, 0),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (eq, "$g_mt_mode", 2),
      (call_script, "script_music_set_situation_with_culture", 65536),
      (store_current_scene, reg1),
      (scene_set_slot, reg1, 0, 1),
      (mission_enable_talk),
      (get_player_agent_no, ":var0"),
      (assign, ":var1", 0),
      (try_for_agents, ":var2"),
        (neq, ":var2", ":var0"),
        (agent_get_troop_id, ":var3", ":var2"),
        (is_between, ":var3", "trp_novice_fighter", "trp_tournament_master"),
        (eq, ":var1", 0),
        (agent_set_team, ":var2", 1),
        (assign, ":var1", 1),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (eq, "$g_mt_mode", 3),
      (play_sound, "snd_arena_ambiance", 2),
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (1, 4, ti_once, 
    [
      (eq, "$g_mt_mode", 3),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (get_player_agent_no, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (assign, ":var2", 0),
        (try_for_agents, ":var3"),
          (agent_is_alive, ":var3"),
          (agent_is_human, ":var3"),
          (agent_get_team, ":var4", ":var3"),
          (eq, ":var4", ":var1"),
          (assign, ":var2", 1),
        (try_end),
        (eq, ":var2", 1),
        (stop_all_sounds, 0),
        (call_script, "script_end_tournament_fight_new", 1),
        (call_script, "script_play_victorious_sound"),
        (finish_mission),
      (else_try),
        (stop_all_sounds, 0),
        (call_script, "script_end_tournament_fight_new", 0),
        (finish_mission),
      (try_end),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (eq, "$g_mt_mode", 1),
      (start_presentation, "prsnt_arena_training"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (eq, "$g_mt_mode", 1),
      (assign, "$g_arena_training_max_opponents", 50),
      (assign, "$g_arena_training_num_agents_spawned", 0),
      (assign, "$g_arena_training_kills", 0),
      (assign, "$g_arena_training_won", 0),
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (1, 4, ti_once, 
    [
      (eq, "$g_mt_mode", 1),
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 3),
      (assign, ":var1", 0),
      (try_begin),
        (ge, "$g_arena_training_num_agents_spawned", "$g_arena_training_max_opponents"),
        (num_active_teams_le, 1),
        (assign, ":var1", 1),
      (try_end),
      (this_or_next|eq, ":var1", 1),
      (main_hero_fallen),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_kill_count, "$g_arena_training_kills", ":var0", 1),
      (assign, "$g_arena_training_won", 0),
      (try_begin),
        (neg|main_hero_fallen),
        (assign, "$g_arena_training_won", 1),
      (try_end),
      (assign, "$g_mt_mode", 2),
      (set_jump_mission, "mt_arena_melee_fight"),
      (party_get_slot, ":var1", "$current_town", 16),
      (modify_visitors_at_site, ":var1"),
      (reset_visitors),
      (party_get_slot, ":var2", "$current_town", 277),
      (set_visitor, 52, ":var2"),
      (set_jump_entry, 50),
      (jump_to_scene, ":var1"),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_mt_mode", 1),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (agent_is_human, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (is_between, ":var2", 0, 7),
        (val_add, ":var0", 1),
      (try_end),
      (lt, ":var0", 20),
      (neg|main_hero_fallen),
      (store_mission_timer_a, ":var3"),
      (this_or_next|ge, ":var3", "$g_arena_training_next_spawn_time"),
      (this_or_next|lt, "$g_arena_training_num_agents_spawned", 50),
      (num_active_teams_le, 1),
      (lt, "$g_arena_training_num_agents_spawned", "$g_arena_training_max_opponents"),
    ],
    [
      (assign, ":var0", "$g_arena_training_num_agents_spawned"),
      (store_div, ":var0", "$g_arena_training_num_agents_spawned", 6),
      (assign, ":var1", "$g_arena_training_num_agents_spawned"),
      (val_mod, ":var1", 1),
      (val_add, ":var0", ":var1"),
      (val_min, ":var0", 9),
      (val_add, ":var0", "trp_arena_training_fighter_1"),
      (assign, ":var2", 10000),
      (get_player_agent_no, ":var3"),
      (agent_get_position, pos5, ":var3"),
      (try_for_range, ":var4", 0, ":var2"),
        (store_random_in_range, ":var5", 0, 39),
        (neq, ":var5", "$g_player_entry_point"),
        (entry_point_get_position, pos1, ":var5"),
        (get_distance_between_positions, ":var6", pos5, pos1),
        (gt, ":var6", 1200),
        (assign, ":var2", 0),
      (try_end),
      (add_visitors_to_current_scene, ":var5", ":var0", 1),
      (store_add, ":var7", "$g_arena_training_num_agents_spawned", 1),
      (store_mission_timer_a, ":var8"),
      (store_add, "$g_arena_training_next_spawn_time", ":var8", 2),
      (store_div, ":var9", ":var7", 4),
      (val_sub, "$g_arena_training_next_spawn_time", ":var9"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_mt_mode", 1),
    ],
    [
      (assign, ":var0", 6),
      (val_max, ":var0", 1),
      (get_player_agent_no, ":var1"),
      (try_for_agents, ":var2"),
        (agent_is_human, ":var2"),
        (agent_is_alive, ":var2"),
        (agent_slot_eq, ":var2", 7, 0),
        (agent_get_team, ":var3", ":var2"),
        (is_between, ":var3", 0, 7),
        (try_begin),
          (eq, ":var2", ":var1"),
          (agent_set_team, ":var2", 6),
        (else_try),
          (try_for_range, ":var4", 0, 6),
            (troop_set_slot, "trp_temp_array_a", ":var4", 0),
          (try_end),
          (try_for_agents, ":var5"),
            (agent_is_human, ":var5"),
            (agent_is_alive, ":var5"),
            (neq, ":var2", ":var1"),
            (agent_slot_eq, ":var5", 7, 1),
            (agent_get_team, ":var6", ":var5"),
            (troop_get_slot, ":var7", "trp_temp_array_a", ":var6"),
            (val_add, ":var7", 1),
            (troop_set_slot, "trp_temp_array_a", ":var6", ":var7"),
          (try_end),
          (troop_get_slot, ":var8", "trp_temp_array_a", 0),
          (try_for_range, ":var4", 1, 6),
            (troop_slot_ge, "trp_temp_array_a", ":var4", ":var8"),
            (troop_get_slot, ":var8", "trp_temp_array_a", ":var4"),
          (try_end),
        (try_end),
        (agent_set_slot, ":var2", 7, 1),
        (try_begin),
          (neq, ":var2", ":var1"),
          (val_add, "$g_arena_training_num_agents_spawned", 1),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_hit, 0.3, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (assign, ":var3", reg0),
      (agent_is_human, ":var0"),
      (get_player_agent_no, ":var4"),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var0", ":var4"),
        (store_random_in_range, ":var5", 0, 1000),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 4, 8),
        (troop_get_inventory_slot, ":var7", "trp_player", ":var6"),
        (gt, ":var7", 0),
        (str_store_item_name, s20, ":var7"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var6"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} is too crapy to fall apart!", 0xFF0000),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var7", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var6", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var1", ":var4"),
        (is_between, ":var3", 1, "itm_items_end"),
        (neg|is_between, ":var3", "itm_light_lance", "itm_wooden_shield"),
        (item_get_type, ":var9", ":var3"),
        (ge, ":var2", 10),
        (neq, ":var9", 10),
        (neq, ":var9", 8),
        (neq, ":var9", 9),
        (neq, ":var9", 5),
        (neq, ":var9", 6),
        (store_random_in_range, ":var5", 0, 600),
        (eq, ":var5", 1),
        (assign, ":var10", -1),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var11", "trp_player", ":var6"),
          (eq, ":var11", ":var3"),
          (assign, ":var10", ":var6"),
        (try_end),
        (gt, ":var10", 0),
        (str_store_item_name, s20, ":var3"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var10"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} falls apart!", 0xFF0000),
          (agent_unequip_item, ":var4", ":var3"),
          (troop_remove_item, "trp_player", ":var3"),
          (troop_remove_item, "trp_broken_items", ":var3"),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var3", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var10", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (agent_get_horse, ":var12", ":var1"),
      (try_begin),
        (eq, "$tom_lance_breaking", 1),
        (gt, ":var12", 0),
        (this_or_next|is_between, ":var3", "itm_light_lance", "itm_bamboo_spear"),
        (is_between, ":var3", "itm_crusader_knight_spear_a", "itm_crusader_spear_a"),
        (ge, ":var2", 50),
        (store_random_in_range, ":var13", 0, 100),
        (gt, ":var13", 20),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your lance!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (this_or_next|is_between, ":var3", "itm_bamboo_spear", "itm_staff"),
        (is_between, ":var3", "itm_crusader_spear_a", "itm_mace_6"),
        (le, ":var12", 0),
        (ge, ":var2", 8),
        (store_random_in_range, ":var13", 0, 100),
        (ge, ":var13", 90),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your spear!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
    ]),

    (0.2, 0, ti_once, 
    [],
    [
      (assign, "$spear_in_position", 0),
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 26, 0),
        (agent_set_slot, ":var0", 27, 0),
        (agent_set_slot, ":var0", 28, 0),
        (agent_set_slot, ":var0", 29, 0),
        (agent_set_slot, ":var0", 30, 0),
      (try_end),
    ]),

    (0.5, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 27),
        (agent_get_slot, ":var2", ":var0", 28),
        (agent_get_slot, ":var3", ":var0", 29),
        (agent_get_position, pos1, ":var0"),
        (position_get_x, ":var4", pos1),
        (position_get_y, ":var5", pos1),
        (position_get_z, ":var6", pos1),
        (position_set_x, pos2, ":var1"),
        (position_set_y, pos2, ":var2"),
        (position_set_z, pos2, ":var3"),
        (position_set_x, pos1, ":var4"),
        (position_set_y, pos1, ":var5"),
        (position_set_z, pos1, ":var6"),
        (agent_get_speed, pos5, ":var0"),
        (call_script, "script_vector_length", 5),
        (assign, ":var7", reg0),
        (agent_set_slot, ":var0", 27, ":var4"),
        (agent_set_slot, ":var0", 28, ":var5"),
        (agent_set_slot, ":var0", 29, ":var6"),
        (agent_set_slot, ":var0", 30, ":var7"),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
      (this_or_next|game_key_clicked, gk_attack),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_move_forward),
      (this_or_next|game_key_clicked, gk_move_backward),
      (this_or_next|game_key_clicked, gk_move_left),
      (this_or_next|game_key_clicked, gk_move_right),
      (this_or_next|game_key_clicked, gk_equip_primary_weapon),
      (this_or_next|game_key_clicked, gk_equip_secondary_weapon),
      (this_or_next|game_key_clicked, gk_action),
      (game_key_clicked, gk_sheath_weapon),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (display_message, "@Releasing spear.", 0x6495ED),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
    ]),

    (0.2, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_get_horse, ":var1", ":var0"),
        (le, ":var1", 0),
        (agent_get_slot, ":var2", ":var0", 26),
        (lt, ":var2", 10),
        (val_add, ":var2", 2),
        (agent_set_slot, ":var0", 26, ":var2"),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_set_animation, ":var0", "anim_spearwall_hold"),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (try_for_agents, ":var2"),
        (agent_is_alive, ":var2"),
        (neq, ":var2", ":var0"),
        (agent_is_human, ":var2"),
        (agent_get_horse, ":var3", ":var2"),
        (le, ":var3", 0),
        (agent_get_slot, ":var4", ":var2", 26),
        (ge, ":var4", 10),
        (agent_get_simple_behavior, ":var5", ":var2"),
        (agent_get_team, ":var6", ":var2"),
        (agent_get_class, ":var7", ":var2"),
        (team_get_movement_order, ":var8", ":var6", ":var7"),
        (assign, ":var9", 0),
        (try_begin),
          (neq, ":var6", ":var1"),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (else_try),
          (this_or_next|eq, ":var8", 0),
          (eq, ":var8", 11),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (this_or_next|eq, ":var5", 4),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (try_end),
        (eq, ":var9", 1),
        (agent_get_troop_id, ":var10", ":var2"),
        (store_proficiency_level, ":var11", ":var10", ca_intelligence),
        (store_character_level, ":var12", ":var10"),
        (ge, ":var12", 12),
        (ge, ":var11", 120),
        (neg|troop_is_mounted, ":var10"),
        (agent_slot_eq, ":var2", 15, 0),
        (assign, ":var9", 0),
        (agent_get_wielded_item, ":var13", ":var2", 0),
        (agent_get_wielded_item, ":var14", ":var2", 1),
        (assign, ":var15", 145),
        (try_begin),
          (this_or_next|is_between, ":var13", "itm_modded_billhook_fork_1", "itm_maul"),
          (is_between, ":var14", "itm_modded_billhook_fork_1", "itm_maul"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_1"),
            (eq, ":var14", "itm_modded_billhook_fork_1"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_2"),
            (eq, ":var14", "itm_modded_billhook_fork_2"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_1"),
            (eq, ":var14", "itm_modded_fauchard_1"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_2"),
            (eq, ":var14", "itm_modded_fauchard_2"),
            (assign, "$spear_dist", 171),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_3"),
            (eq, ":var14", "itm_modded_fauchard_3"),
            (assign, "$spear_dist", 197),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_4"),
            (eq, ":var14", "itm_modded_fauchard_4"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_1"),
            (eq, ":var14", "itm_modded_glaive_1"),
            (assign, "$spear_dist", 169),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_1"),
            (eq, ":var14", "itm_modded_glaive_fork_1"),
            (assign, "$spear_dist", 230),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_2"),
            (eq, ":var14", "itm_modded_glaive_fork_2"),
            (assign, "$spear_dist", 188),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_roundel"),
            (eq, ":var14", "itm_modded_glaive_roundel"),
            (assign, "$spear_dist", 149),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_1"),
            (eq, ":var14", "itm_modded_bill_1"),
            (assign, "$spear_dist", 215),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_2"),
            (eq, ":var14", "itm_modded_bill_2"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_1"),
            (eq, ":var14", "itm_modded_billhook_1"),
            (assign, "$spear_dist", 207),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_2"),
            (eq, ":var14", "itm_modded_billhook_2"),
            (assign, "$spear_dist", 172),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_3"),
            (eq, ":var14", "itm_modded_billhook_3"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_voulge"),
            (eq, ":var14", "itm_modded_voulge"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_spiked_voulge"),
            (eq, ":var14", "itm_modded_spiked_voulge"),
            (assign, "$spear_dist", 182),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_cleaving_voulge"),
            (eq, ":var14", "itm_modded_cleaving_voulge"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_1"),
            (eq, ":var14", "itm_modded_hooked_voulge_1"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_2"),
            (eq, ":var14", "itm_modded_hooked_voulge_2"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_3"),
            (eq, ":var14", "itm_modded_hooked_voulge_3"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_1"),
            (eq, ":var14", "itm_modded_couteau_1"),
            (assign, "$spear_dist", 177),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_2"),
            (eq, ":var14", "itm_modded_couteau_2"),
            (assign, "$spear_dist", 196),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_guisarme"),
            (eq, ":var14", "itm_modded_guisarme"),
            (assign, "$spear_dist", 232),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_assegai"),
            (eq, ":var14", "itm_modded_assegai"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_pike"),
            (eq, ":var14", "itm_modded_pike"),
            (assign, "$spear_dist", 300),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_war_spear"),
            (eq, ":var14", "itm_modded_war_spear"),
            (assign, "$spear_dist", 211),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_glaive"),
          (is_between, ":var14", "itm_glaive"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_glaive"),
            (eq, ":var14", "itm_glaive"),
            (assign, "$spear_dist", 160),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_bill"),
          (is_between, ":var14", "itm_bill"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_bill"),
            (eq, ":var14", "itm_bill"),
            (assign, "$spear_dist", 128),
          (try_end),
        (try_end),
        (eq, ":var9", 1),
        (assign, ":var16", -1),
        (agent_get_position, pos1, ":var2"),
        (try_for_agents, ":var17"),
          (agent_is_alive, ":var17"),
          (neg|agent_is_human, ":var17"),
          (agent_get_rider, ":var18", ":var17"),
          (ge, ":var18", 0),
          (agent_get_team, ":var19", ":var18"),
          (teams_are_enemies, ":var6", ":var19"),
          (agent_get_position, pos2, ":var17"),
          (get_distance_between_positions, ":var20", pos1, pos2),
          (lt, ":var20", ":var15"),
          (neg|position_is_behind_position, pos2, pos1),
          (agent_get_slot, ":var21", ":var17", 30),
          (gt, ":var21", 0),
          (assign, ":var16", ":var17"),
        (try_end),
        (gt, ":var16", -1),
        (agent_play_sound, ":var16", "snd_metal_hit_high_armor_high_damage"),
        (store_agent_hit_points, ":var22", ":var16", 0),
        (store_agent_hit_points, ":var23", ":var16", 1),
        (assign, reg22, ":var21"),
        (val_mul, ":var21", 10),
        (val_sub, ":var22", ":var21"),
        (val_max, ":var22", 0),
        (agent_set_slot, ":var2", 26, 0),
        (agent_get_horse, ":var24", ":var0"),
        (agent_get_position, pos2, ":var16"),
        (agent_set_look_target_position, ":var2", pos2),
        (agent_set_attack_action, ":var2", 0, 0),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_get_troop_id, ":var10", ":var2"),
        (str_store_troop_name, s21, ":var10"),
        (agent_get_troop_id, ":var25", ":var16"),
        (str_store_troop_name, s20, ":var25"),
        (store_agent_hit_points, ":var22", ":var16", 1),
        (val_sub, ":var23", ":var22"),
        (assign, reg1, ":var23"),
        (try_begin),
          (eq, ":var16", ":var24"),
          (display_message, "@Your horse received {reg1} damage from a braced polearm!", 0xFF4040),
        (try_end),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (store_agent_hit_points, ":var1", ":var0", 1),
      (lt, ":var1", "$spear_hp"),
      (display_message, "@The injury causes your grip on the polearm to slip!", 0xFF4040),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 26),
      (ge, ":var1", 10),
      (assign, ":var2", -1),
      (agent_get_position, pos1, ":var0"),
      (try_for_agents, ":var3"),
        (agent_is_alive, ":var3"),
        (neg|agent_is_human, ":var3"),
        (agent_get_rider, ":var4", ":var3"),
        (ge, ":var4", 0),
        (neg|agent_is_ally, ":var4"),
        (agent_get_position, pos2, ":var3"),
        (get_distance_between_positions, ":var5", pos1, pos2),
        (lt, ":var5", "$spear_dist"),
        (neg|position_is_behind_position, pos2, pos1),
        (agent_get_slot, ":var6", ":var3", 30),
        (ge, ":var6", 120),
        (assign, ":var2", ":var3"),
      (try_end),
      (gt, ":var2", -1),
      (agent_play_sound, ":var2", "snd_metal_hit_high_armor_high_damage"),
      (store_agent_hit_points, ":var7", ":var2", 0),
      (store_agent_hit_points, ":var8", ":var2", 1),
      (val_div, ":var6", 2),
      (val_sub, ":var6", 15),
      (val_sub, ":var7", ":var6"),
      (val_max, ":var7", 0),
      (agent_set_hit_points, ":var2", ":var7", 0),
      (agent_deliver_damage_to_agent, ":var2", ":var2"),
      (agent_set_slot, ":var0", 26, 0),
      (store_agent_hit_points, ":var7", ":var2", 1),
      (val_sub, ":var8", ":var7"),
      (assign, reg1, ":var8"),
      (display_message, "@Polearm-wall dealt {reg1} damage!"),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 2, 
    [
      (key_clicked, key_b),
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_is_alive, ":var1"),
      (agent_get_wielded_item, ":var2", ":var1", 0),
      (agent_get_wielded_item, ":var3", ":var1", 1),
      (assign, "$spear_dist", 145),
      (try_begin),
        (this_or_next|is_between, ":var2", "itm_modded_billhook_fork_1", "itm_maul"),
        (is_between, ":var3", "itm_modded_billhook_fork_1", "itm_maul"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_1"),
          (eq, ":var3", "itm_modded_billhook_fork_1"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_2"),
          (eq, ":var3", "itm_modded_billhook_fork_2"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_1"),
          (eq, ":var3", "itm_modded_fauchard_1"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_2"),
          (eq, ":var3", "itm_modded_fauchard_2"),
          (assign, "$spear_dist", 171),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_3"),
          (eq, ":var3", "itm_modded_fauchard_3"),
          (assign, "$spear_dist", 197),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_4"),
          (eq, ":var3", "itm_modded_fauchard_4"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_1"),
          (eq, ":var3", "itm_modded_glaive_1"),
          (assign, "$spear_dist", 169),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_1"),
          (eq, ":var3", "itm_modded_glaive_fork_1"),
          (assign, "$spear_dist", 230),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_2"),
          (eq, ":var3", "itm_modded_glaive_fork_2"),
          (assign, "$spear_dist", 188),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_roundel"),
          (eq, ":var3", "itm_modded_glaive_roundel"),
          (assign, "$spear_dist", 149),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_1"),
          (eq, ":var3", "itm_modded_bill_1"),
          (assign, "$spear_dist", 215),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_2"),
          (eq, ":var3", "itm_modded_bill_2"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_1"),
          (eq, ":var3", "itm_modded_billhook_1"),
          (assign, "$spear_dist", 207),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_2"),
          (eq, ":var3", "itm_modded_billhook_2"),
          (assign, "$spear_dist", 172),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_3"),
          (eq, ":var3", "itm_modded_billhook_3"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_voulge"),
          (eq, ":var3", "itm_modded_voulge"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_spiked_voulge"),
          (eq, ":var3", "itm_modded_spiked_voulge"),
          (assign, "$spear_dist", 182),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_cleaving_voulge"),
          (eq, ":var3", "itm_modded_cleaving_voulge"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_1"),
          (eq, ":var3", "itm_modded_hooked_voulge_1"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_2"),
          (eq, ":var3", "itm_modded_hooked_voulge_2"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_3"),
          (eq, ":var3", "itm_modded_hooked_voulge_3"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_1"),
          (eq, ":var3", "itm_modded_couteau_1"),
          (assign, "$spear_dist", 177),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_2"),
          (eq, ":var3", "itm_modded_couteau_2"),
          (assign, "$spear_dist", 196),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_guisarme"),
          (eq, ":var3", "itm_modded_guisarme"),
          (assign, "$spear_dist", 232),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_assegai"),
          (eq, ":var3", "itm_modded_assegai"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_pike"),
          (eq, ":var3", "itm_modded_pike"),
          (assign, "$spear_dist", 300),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_war_spear"),
          (eq, ":var3", "itm_modded_war_spear"),
          (assign, "$spear_dist", 211),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_glaive"),
        (is_between, ":var3", "itm_glaive"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_glaive"),
          (eq, ":var3", "itm_glaive"),
          (assign, "$spear_dist", 160),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_bill"),
        (is_between, ":var3", "itm_bill"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_bill"),
          (eq, ":var3", "itm_bill"),
          (assign, "$spear_dist", 128),
        (try_end),
      (try_end),
      (eq, ":var0", 1),
      (agent_get_horse, ":var4", ":var1"),
      (le, ":var4", 0),
      (neq, "$spear_in_position", 1),
      (display_message, "@Bracing polearm for charge.", 0x6495ED),
      (agent_set_animation, ":var1", "anim_spearwall_hold"),
      (assign, "$spear_in_position", 1),
      (store_agent_hit_points, "$spear_hp", ":var1", 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (call_script, "script_lance_use_classify_agent"),
    ]),

    (2, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 43),
        (gt, ":var1", 0),
        (agent_get_wielded_item, ":var2", ":var0", 0),
        (agent_get_horse, ":var3", ":var0"),
        (try_begin),
          (le, ":var3", 0),
          (agent_set_slot, ":var0", 43, 0),
          (eq, ":var2", ":var1"),
          (call_script, "script_lance_use_backup_weapon", ":var0"),
        (else_try),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var4", ":var0"),
          (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":var4", 1),
          (assign, ":var5", reg0),
          (try_begin),
            (lt, ":var5", 500),
            (agent_get_combat_state, ":var6", ":var0"),
            (gt, ":var6", 3),
            (eq, ":var2", ":var1"),
            (call_script, "script_lance_use_backup_weapon", ":var0"),
          (else_try),
            (neq, ":var2", ":var1"),
            (agent_set_wielded_item, ":var0", ":var1"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("arena_tournament_fight_foot", mtf_arena_fight, -1,
  "You enter a melee fight in the arena.",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (1, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (8, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (9, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (10, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (11, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (12, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (13, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (14, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (15, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (16, mtef_team_2|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (17, mtef_team_2|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (18, mtef_team_2|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (19, mtef_team_2|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (20, mtef_team_2|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (21, mtef_team_2|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (22, mtef_team_2|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (23, mtef_team_2|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (24, mtef_team_3|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (25, mtef_team_3|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (26, mtef_team_3|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (27, mtef_team_3|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (28, mtef_team_3|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (29, mtef_team_3|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (30, mtef_team_3|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (31, mtef_team_3|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (assign, "$g_arena_training_num_agents_spawned", 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_arena"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_mt_mode", 2),
        (set_trigger_result, 1),
      (else_try),
        (question_box, "str_give_up_fight"),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (try_begin),
        (eq, "$g_mt_mode", 3),
        (call_script, "script_end_tournament_fight_new", 0),
      (else_try),
        (eq, "$g_mt_mode", 1),
        (get_player_agent_no, ":var1"),
        (agent_get_kill_count, "$g_arena_training_kills", ":var1", 1),
      (try_end),
      (finish_mission, 0),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (eq, "$g_mt_mode", 2),
      (call_script, "script_music_set_situation_with_culture", 65536),
      (store_current_scene, reg1),
      (scene_set_slot, reg1, 0, 1),
      (mission_enable_talk),
      (get_player_agent_no, ":var0"),
      (assign, ":var1", 0),
      (try_for_agents, ":var2"),
        (neq, ":var2", ":var0"),
        (agent_get_troop_id, ":var3", ":var2"),
        (is_between, ":var3", "trp_novice_fighter", "trp_tournament_master"),
        (eq, ":var1", 0),
        (agent_set_team, ":var2", 1),
        (assign, ":var1", 1),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (eq, "$g_mt_mode", 3),
      (play_sound, "snd_arena_ambiance", 2),
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (1, 4, ti_once, 
    [
      (eq, "$g_mt_mode", 3),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (get_player_agent_no, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (assign, ":var2", 0),
        (try_for_agents, ":var3"),
          (agent_is_alive, ":var3"),
          (agent_is_human, ":var3"),
          (agent_get_team, ":var4", ":var3"),
          (eq, ":var4", ":var1"),
          (assign, ":var2", 1),
        (try_end),
        (eq, ":var2", 1),
        (stop_all_sounds, 0),
        (call_script, "script_end_tournament_fight_new", 1),
        (call_script, "script_play_victorious_sound"),
        (finish_mission),
      (else_try),
        (stop_all_sounds, 0),
        (call_script, "script_end_tournament_fight_new", 0),
        (finish_mission),
      (try_end),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (eq, "$g_mt_mode", 1),
      (start_presentation, "prsnt_arena_training"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (eq, "$g_mt_mode", 1),
      (assign, "$g_arena_training_max_opponents", 50),
      (assign, "$g_arena_training_num_agents_spawned", 0),
      (assign, "$g_arena_training_kills", 0),
      (assign, "$g_arena_training_won", 0),
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (1, 4, ti_once, 
    [
      (eq, "$g_mt_mode", 1),
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 3),
      (assign, ":var1", 0),
      (try_begin),
        (ge, "$g_arena_training_num_agents_spawned", "$g_arena_training_max_opponents"),
        (num_active_teams_le, 1),
        (assign, ":var1", 1),
      (try_end),
      (this_or_next|eq, ":var1", 1),
      (main_hero_fallen),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_kill_count, "$g_arena_training_kills", ":var0", 1),
      (assign, "$g_arena_training_won", 0),
      (try_begin),
        (neg|main_hero_fallen),
        (assign, "$g_arena_training_won", 1),
      (try_end),
      (assign, "$g_mt_mode", 2),
      (set_jump_mission, "mt_arena_melee_fight"),
      (party_get_slot, ":var1", "$current_town", 16),
      (modify_visitors_at_site, ":var1"),
      (reset_visitors),
      (party_get_slot, ":var2", "$current_town", 277),
      (set_visitor, 52, ":var2"),
      (set_jump_entry, 50),
      (jump_to_scene, ":var1"),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_mt_mode", 1),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (agent_is_human, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (is_between, ":var2", 0, 7),
        (val_add, ":var0", 1),
      (try_end),
      (lt, ":var0", 20),
      (neg|main_hero_fallen),
      (store_mission_timer_a, ":var3"),
      (this_or_next|ge, ":var3", "$g_arena_training_next_spawn_time"),
      (this_or_next|lt, "$g_arena_training_num_agents_spawned", 50),
      (num_active_teams_le, 1),
      (lt, "$g_arena_training_num_agents_spawned", "$g_arena_training_max_opponents"),
    ],
    [
      (assign, ":var0", "$g_arena_training_num_agents_spawned"),
      (store_div, ":var0", "$g_arena_training_num_agents_spawned", 6),
      (assign, ":var1", "$g_arena_training_num_agents_spawned"),
      (val_mod, ":var1", 1),
      (val_add, ":var0", ":var1"),
      (val_min, ":var0", 9),
      (val_add, ":var0", "trp_arena_training_fighter_1"),
      (assign, ":var2", 10000),
      (get_player_agent_no, ":var3"),
      (agent_get_position, pos5, ":var3"),
      (try_for_range, ":var4", 0, ":var2"),
        (store_random_in_range, ":var5", 0, 39),
        (neq, ":var5", "$g_player_entry_point"),
        (entry_point_get_position, pos1, ":var5"),
        (get_distance_between_positions, ":var6", pos5, pos1),
        (gt, ":var6", 1200),
        (assign, ":var2", 0),
      (try_end),
      (add_visitors_to_current_scene, ":var5", ":var0", 1),
      (store_add, ":var7", "$g_arena_training_num_agents_spawned", 1),
      (store_mission_timer_a, ":var8"),
      (store_add, "$g_arena_training_next_spawn_time", ":var8", 2),
      (store_div, ":var9", ":var7", 4),
      (val_sub, "$g_arena_training_next_spawn_time", ":var9"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_mt_mode", 1),
    ],
    [
      (assign, ":var0", 6),
      (val_max, ":var0", 1),
      (get_player_agent_no, ":var1"),
      (try_for_agents, ":var2"),
        (agent_is_human, ":var2"),
        (agent_is_alive, ":var2"),
        (agent_slot_eq, ":var2", 7, 0),
        (agent_get_team, ":var3", ":var2"),
        (is_between, ":var3", 0, 7),
        (try_begin),
          (eq, ":var2", ":var1"),
          (agent_set_team, ":var2", 6),
        (else_try),
          (try_for_range, ":var4", 0, 6),
            (troop_set_slot, "trp_temp_array_a", ":var4", 0),
          (try_end),
          (try_for_agents, ":var5"),
            (agent_is_human, ":var5"),
            (agent_is_alive, ":var5"),
            (neq, ":var2", ":var1"),
            (agent_slot_eq, ":var5", 7, 1),
            (agent_get_team, ":var6", ":var5"),
            (troop_get_slot, ":var7", "trp_temp_array_a", ":var6"),
            (val_add, ":var7", 1),
            (troop_set_slot, "trp_temp_array_a", ":var6", ":var7"),
          (try_end),
          (troop_get_slot, ":var8", "trp_temp_array_a", 0),
          (try_for_range, ":var4", 1, 6),
            (troop_slot_ge, "trp_temp_array_a", ":var4", ":var8"),
            (troop_get_slot, ":var8", "trp_temp_array_a", ":var4"),
          (try_end),
        (try_end),
        (agent_set_slot, ":var2", 7, 1),
        (try_begin),
          (neq, ":var2", ":var1"),
          (val_add, "$g_arena_training_num_agents_spawned", 1),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_hit, 0.3, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (assign, ":var3", reg0),
      (agent_is_human, ":var0"),
      (get_player_agent_no, ":var4"),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var0", ":var4"),
        (store_random_in_range, ":var5", 0, 1000),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 4, 8),
        (troop_get_inventory_slot, ":var7", "trp_player", ":var6"),
        (gt, ":var7", 0),
        (str_store_item_name, s20, ":var7"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var6"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} is too crapy to fall apart!", 0xFF0000),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var7", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var6", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var1", ":var4"),
        (is_between, ":var3", 1, "itm_items_end"),
        (neg|is_between, ":var3", "itm_light_lance", "itm_wooden_shield"),
        (item_get_type, ":var9", ":var3"),
        (ge, ":var2", 10),
        (neq, ":var9", 10),
        (neq, ":var9", 8),
        (neq, ":var9", 9),
        (neq, ":var9", 5),
        (neq, ":var9", 6),
        (store_random_in_range, ":var5", 0, 600),
        (eq, ":var5", 1),
        (assign, ":var10", -1),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var11", "trp_player", ":var6"),
          (eq, ":var11", ":var3"),
          (assign, ":var10", ":var6"),
        (try_end),
        (gt, ":var10", 0),
        (str_store_item_name, s20, ":var3"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var10"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} falls apart!", 0xFF0000),
          (agent_unequip_item, ":var4", ":var3"),
          (troop_remove_item, "trp_player", ":var3"),
          (troop_remove_item, "trp_broken_items", ":var3"),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var3", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var10", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (agent_get_horse, ":var12", ":var1"),
      (try_begin),
        (eq, "$tom_lance_breaking", 1),
        (gt, ":var12", 0),
        (this_or_next|is_between, ":var3", "itm_light_lance", "itm_bamboo_spear"),
        (is_between, ":var3", "itm_crusader_knight_spear_a", "itm_crusader_spear_a"),
        (ge, ":var2", 50),
        (store_random_in_range, ":var13", 0, 100),
        (gt, ":var13", 20),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your lance!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (this_or_next|is_between, ":var3", "itm_bamboo_spear", "itm_staff"),
        (is_between, ":var3", "itm_crusader_spear_a", "itm_mace_6"),
        (le, ":var12", 0),
        (ge, ":var2", 8),
        (store_random_in_range, ":var13", 0, 100),
        (ge, ":var13", 90),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your spear!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
    ]),

    (0.2, 0, ti_once, 
    [],
    [
      (assign, "$spear_in_position", 0),
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 26, 0),
        (agent_set_slot, ":var0", 27, 0),
        (agent_set_slot, ":var0", 28, 0),
        (agent_set_slot, ":var0", 29, 0),
        (agent_set_slot, ":var0", 30, 0),
      (try_end),
    ]),

    (0.5, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 27),
        (agent_get_slot, ":var2", ":var0", 28),
        (agent_get_slot, ":var3", ":var0", 29),
        (agent_get_position, pos1, ":var0"),
        (position_get_x, ":var4", pos1),
        (position_get_y, ":var5", pos1),
        (position_get_z, ":var6", pos1),
        (position_set_x, pos2, ":var1"),
        (position_set_y, pos2, ":var2"),
        (position_set_z, pos2, ":var3"),
        (position_set_x, pos1, ":var4"),
        (position_set_y, pos1, ":var5"),
        (position_set_z, pos1, ":var6"),
        (agent_get_speed, pos5, ":var0"),
        (call_script, "script_vector_length", 5),
        (assign, ":var7", reg0),
        (agent_set_slot, ":var0", 27, ":var4"),
        (agent_set_slot, ":var0", 28, ":var5"),
        (agent_set_slot, ":var0", 29, ":var6"),
        (agent_set_slot, ":var0", 30, ":var7"),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
      (this_or_next|game_key_clicked, gk_attack),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_move_forward),
      (this_or_next|game_key_clicked, gk_move_backward),
      (this_or_next|game_key_clicked, gk_move_left),
      (this_or_next|game_key_clicked, gk_move_right),
      (this_or_next|game_key_clicked, gk_equip_primary_weapon),
      (this_or_next|game_key_clicked, gk_equip_secondary_weapon),
      (this_or_next|game_key_clicked, gk_action),
      (game_key_clicked, gk_sheath_weapon),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (display_message, "@Releasing spear.", 0x6495ED),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
    ]),

    (0.2, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_get_horse, ":var1", ":var0"),
        (le, ":var1", 0),
        (agent_get_slot, ":var2", ":var0", 26),
        (lt, ":var2", 10),
        (val_add, ":var2", 2),
        (agent_set_slot, ":var0", 26, ":var2"),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_set_animation, ":var0", "anim_spearwall_hold"),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (try_for_agents, ":var2"),
        (agent_is_alive, ":var2"),
        (neq, ":var2", ":var0"),
        (agent_is_human, ":var2"),
        (agent_get_horse, ":var3", ":var2"),
        (le, ":var3", 0),
        (agent_get_slot, ":var4", ":var2", 26),
        (ge, ":var4", 10),
        (agent_get_simple_behavior, ":var5", ":var2"),
        (agent_get_team, ":var6", ":var2"),
        (agent_get_class, ":var7", ":var2"),
        (team_get_movement_order, ":var8", ":var6", ":var7"),
        (assign, ":var9", 0),
        (try_begin),
          (neq, ":var6", ":var1"),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (else_try),
          (this_or_next|eq, ":var8", 0),
          (eq, ":var8", 11),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (this_or_next|eq, ":var5", 4),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (try_end),
        (eq, ":var9", 1),
        (agent_get_troop_id, ":var10", ":var2"),
        (store_proficiency_level, ":var11", ":var10", ca_intelligence),
        (store_character_level, ":var12", ":var10"),
        (ge, ":var12", 12),
        (ge, ":var11", 120),
        (neg|troop_is_mounted, ":var10"),
        (agent_slot_eq, ":var2", 15, 0),
        (assign, ":var9", 0),
        (agent_get_wielded_item, ":var13", ":var2", 0),
        (agent_get_wielded_item, ":var14", ":var2", 1),
        (assign, ":var15", 145),
        (try_begin),
          (this_or_next|is_between, ":var13", "itm_modded_billhook_fork_1", "itm_maul"),
          (is_between, ":var14", "itm_modded_billhook_fork_1", "itm_maul"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_1"),
            (eq, ":var14", "itm_modded_billhook_fork_1"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_2"),
            (eq, ":var14", "itm_modded_billhook_fork_2"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_1"),
            (eq, ":var14", "itm_modded_fauchard_1"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_2"),
            (eq, ":var14", "itm_modded_fauchard_2"),
            (assign, "$spear_dist", 171),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_3"),
            (eq, ":var14", "itm_modded_fauchard_3"),
            (assign, "$spear_dist", 197),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_4"),
            (eq, ":var14", "itm_modded_fauchard_4"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_1"),
            (eq, ":var14", "itm_modded_glaive_1"),
            (assign, "$spear_dist", 169),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_1"),
            (eq, ":var14", "itm_modded_glaive_fork_1"),
            (assign, "$spear_dist", 230),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_2"),
            (eq, ":var14", "itm_modded_glaive_fork_2"),
            (assign, "$spear_dist", 188),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_roundel"),
            (eq, ":var14", "itm_modded_glaive_roundel"),
            (assign, "$spear_dist", 149),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_1"),
            (eq, ":var14", "itm_modded_bill_1"),
            (assign, "$spear_dist", 215),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_2"),
            (eq, ":var14", "itm_modded_bill_2"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_1"),
            (eq, ":var14", "itm_modded_billhook_1"),
            (assign, "$spear_dist", 207),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_2"),
            (eq, ":var14", "itm_modded_billhook_2"),
            (assign, "$spear_dist", 172),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_3"),
            (eq, ":var14", "itm_modded_billhook_3"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_voulge"),
            (eq, ":var14", "itm_modded_voulge"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_spiked_voulge"),
            (eq, ":var14", "itm_modded_spiked_voulge"),
            (assign, "$spear_dist", 182),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_cleaving_voulge"),
            (eq, ":var14", "itm_modded_cleaving_voulge"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_1"),
            (eq, ":var14", "itm_modded_hooked_voulge_1"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_2"),
            (eq, ":var14", "itm_modded_hooked_voulge_2"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_3"),
            (eq, ":var14", "itm_modded_hooked_voulge_3"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_1"),
            (eq, ":var14", "itm_modded_couteau_1"),
            (assign, "$spear_dist", 177),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_2"),
            (eq, ":var14", "itm_modded_couteau_2"),
            (assign, "$spear_dist", 196),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_guisarme"),
            (eq, ":var14", "itm_modded_guisarme"),
            (assign, "$spear_dist", 232),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_assegai"),
            (eq, ":var14", "itm_modded_assegai"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_pike"),
            (eq, ":var14", "itm_modded_pike"),
            (assign, "$spear_dist", 300),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_war_spear"),
            (eq, ":var14", "itm_modded_war_spear"),
            (assign, "$spear_dist", 211),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_glaive"),
          (is_between, ":var14", "itm_glaive"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_glaive"),
            (eq, ":var14", "itm_glaive"),
            (assign, "$spear_dist", 160),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_bill"),
          (is_between, ":var14", "itm_bill"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_bill"),
            (eq, ":var14", "itm_bill"),
            (assign, "$spear_dist", 128),
          (try_end),
        (try_end),
        (eq, ":var9", 1),
        (assign, ":var16", -1),
        (agent_get_position, pos1, ":var2"),
        (try_for_agents, ":var17"),
          (agent_is_alive, ":var17"),
          (neg|agent_is_human, ":var17"),
          (agent_get_rider, ":var18", ":var17"),
          (ge, ":var18", 0),
          (agent_get_team, ":var19", ":var18"),
          (teams_are_enemies, ":var6", ":var19"),
          (agent_get_position, pos2, ":var17"),
          (get_distance_between_positions, ":var20", pos1, pos2),
          (lt, ":var20", ":var15"),
          (neg|position_is_behind_position, pos2, pos1),
          (agent_get_slot, ":var21", ":var17", 30),
          (gt, ":var21", 0),
          (assign, ":var16", ":var17"),
        (try_end),
        (gt, ":var16", -1),
        (agent_play_sound, ":var16", "snd_metal_hit_high_armor_high_damage"),
        (store_agent_hit_points, ":var22", ":var16", 0),
        (store_agent_hit_points, ":var23", ":var16", 1),
        (assign, reg22, ":var21"),
        (val_mul, ":var21", 10),
        (val_sub, ":var22", ":var21"),
        (val_max, ":var22", 0),
        (agent_set_slot, ":var2", 26, 0),
        (agent_get_horse, ":var24", ":var0"),
        (agent_get_position, pos2, ":var16"),
        (agent_set_look_target_position, ":var2", pos2),
        (agent_set_attack_action, ":var2", 0, 0),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_get_troop_id, ":var10", ":var2"),
        (str_store_troop_name, s21, ":var10"),
        (agent_get_troop_id, ":var25", ":var16"),
        (str_store_troop_name, s20, ":var25"),
        (store_agent_hit_points, ":var22", ":var16", 1),
        (val_sub, ":var23", ":var22"),
        (assign, reg1, ":var23"),
        (try_begin),
          (eq, ":var16", ":var24"),
          (display_message, "@Your horse received {reg1} damage from a braced polearm!", 0xFF4040),
        (try_end),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (store_agent_hit_points, ":var1", ":var0", 1),
      (lt, ":var1", "$spear_hp"),
      (display_message, "@The injury causes your grip on the polearm to slip!", 0xFF4040),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 26),
      (ge, ":var1", 10),
      (assign, ":var2", -1),
      (agent_get_position, pos1, ":var0"),
      (try_for_agents, ":var3"),
        (agent_is_alive, ":var3"),
        (neg|agent_is_human, ":var3"),
        (agent_get_rider, ":var4", ":var3"),
        (ge, ":var4", 0),
        (neg|agent_is_ally, ":var4"),
        (agent_get_position, pos2, ":var3"),
        (get_distance_between_positions, ":var5", pos1, pos2),
        (lt, ":var5", "$spear_dist"),
        (neg|position_is_behind_position, pos2, pos1),
        (agent_get_slot, ":var6", ":var3", 30),
        (ge, ":var6", 120),
        (assign, ":var2", ":var3"),
      (try_end),
      (gt, ":var2", -1),
      (agent_play_sound, ":var2", "snd_metal_hit_high_armor_high_damage"),
      (store_agent_hit_points, ":var7", ":var2", 0),
      (store_agent_hit_points, ":var8", ":var2", 1),
      (val_div, ":var6", 2),
      (val_sub, ":var6", 15),
      (val_sub, ":var7", ":var6"),
      (val_max, ":var7", 0),
      (agent_set_hit_points, ":var2", ":var7", 0),
      (agent_deliver_damage_to_agent, ":var2", ":var2"),
      (agent_set_slot, ":var0", 26, 0),
      (store_agent_hit_points, ":var7", ":var2", 1),
      (val_sub, ":var8", ":var7"),
      (assign, reg1, ":var8"),
      (display_message, "@Polearm-wall dealt {reg1} damage!"),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 2, 
    [
      (key_clicked, key_b),
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_is_alive, ":var1"),
      (agent_get_wielded_item, ":var2", ":var1", 0),
      (agent_get_wielded_item, ":var3", ":var1", 1),
      (assign, "$spear_dist", 145),
      (try_begin),
        (this_or_next|is_between, ":var2", "itm_modded_billhook_fork_1", "itm_maul"),
        (is_between, ":var3", "itm_modded_billhook_fork_1", "itm_maul"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_1"),
          (eq, ":var3", "itm_modded_billhook_fork_1"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_2"),
          (eq, ":var3", "itm_modded_billhook_fork_2"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_1"),
          (eq, ":var3", "itm_modded_fauchard_1"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_2"),
          (eq, ":var3", "itm_modded_fauchard_2"),
          (assign, "$spear_dist", 171),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_3"),
          (eq, ":var3", "itm_modded_fauchard_3"),
          (assign, "$spear_dist", 197),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_4"),
          (eq, ":var3", "itm_modded_fauchard_4"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_1"),
          (eq, ":var3", "itm_modded_glaive_1"),
          (assign, "$spear_dist", 169),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_1"),
          (eq, ":var3", "itm_modded_glaive_fork_1"),
          (assign, "$spear_dist", 230),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_2"),
          (eq, ":var3", "itm_modded_glaive_fork_2"),
          (assign, "$spear_dist", 188),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_roundel"),
          (eq, ":var3", "itm_modded_glaive_roundel"),
          (assign, "$spear_dist", 149),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_1"),
          (eq, ":var3", "itm_modded_bill_1"),
          (assign, "$spear_dist", 215),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_2"),
          (eq, ":var3", "itm_modded_bill_2"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_1"),
          (eq, ":var3", "itm_modded_billhook_1"),
          (assign, "$spear_dist", 207),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_2"),
          (eq, ":var3", "itm_modded_billhook_2"),
          (assign, "$spear_dist", 172),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_3"),
          (eq, ":var3", "itm_modded_billhook_3"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_voulge"),
          (eq, ":var3", "itm_modded_voulge"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_spiked_voulge"),
          (eq, ":var3", "itm_modded_spiked_voulge"),
          (assign, "$spear_dist", 182),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_cleaving_voulge"),
          (eq, ":var3", "itm_modded_cleaving_voulge"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_1"),
          (eq, ":var3", "itm_modded_hooked_voulge_1"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_2"),
          (eq, ":var3", "itm_modded_hooked_voulge_2"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_3"),
          (eq, ":var3", "itm_modded_hooked_voulge_3"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_1"),
          (eq, ":var3", "itm_modded_couteau_1"),
          (assign, "$spear_dist", 177),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_2"),
          (eq, ":var3", "itm_modded_couteau_2"),
          (assign, "$spear_dist", 196),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_guisarme"),
          (eq, ":var3", "itm_modded_guisarme"),
          (assign, "$spear_dist", 232),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_assegai"),
          (eq, ":var3", "itm_modded_assegai"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_pike"),
          (eq, ":var3", "itm_modded_pike"),
          (assign, "$spear_dist", 300),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_war_spear"),
          (eq, ":var3", "itm_modded_war_spear"),
          (assign, "$spear_dist", 211),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_glaive"),
        (is_between, ":var3", "itm_glaive"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_glaive"),
          (eq, ":var3", "itm_glaive"),
          (assign, "$spear_dist", 160),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_bill"),
        (is_between, ":var3", "itm_bill"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_bill"),
          (eq, ":var3", "itm_bill"),
          (assign, "$spear_dist", 128),
        (try_end),
      (try_end),
      (eq, ":var0", 1),
      (agent_get_horse, ":var4", ":var1"),
      (le, ":var4", 0),
      (neq, "$spear_in_position", 1),
      (display_message, "@Bracing polearm for charge.", 0x6495ED),
      (agent_set_animation, ":var1", "anim_spearwall_hold"),
      (assign, "$spear_in_position", 1),
      (store_agent_hit_points, "$spear_hp", ":var1", 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (call_script, "script_lance_use_classify_agent"),
    ]),

    (2, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 43),
        (gt, ":var1", 0),
        (agent_get_wielded_item, ":var2", ":var0", 0),
        (agent_get_horse, ":var3", ":var0"),
        (try_begin),
          (le, ":var3", 0),
          (agent_set_slot, ":var0", 43, 0),
          (eq, ":var2", ":var1"),
          (call_script, "script_lance_use_backup_weapon", ":var0"),
        (else_try),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var4", ":var0"),
          (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":var4", 1),
          (assign, ":var5", reg0),
          (try_begin),
            (lt, ":var5", 500),
            (agent_get_combat_state, ":var6", ":var0"),
            (gt, ":var6", 3),
            (eq, ":var2", ":var1"),
            (call_script, "script_lance_use_backup_weapon", ":var0"),
          (else_try),
            (neq, ":var2", ":var1"),
            (agent_set_wielded_item, ":var0", ":var1"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("ship_battle", mtf_battle_mode, charge,
  "You close in and board the enemy ships",
  [
    (0, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
    (1, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 6, []),
    (2, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 6, []),
    (10, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 6, []),
    (11, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 3, []),
    (12, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 3, []),
  ],
  [
    (0, 0, ti_once, 
    [],
    [
      (play_sound, "snd_sea_ambiance", 2),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_agent_reassign_team", ":var0"),
      (assign, ":var1", 5000),
      (agent_get_troop_id, ":var2", ":var0"),
      (store_character_level, ":var3", ":var2"),
      (val_mul, ":var3", 35),
      (val_add, ":var1", ":var3"),
      (store_random_in_range, ":var4", 0, 3000),
      (val_add, ":var1", ":var4"),
      (agent_get_party_id, ":var5", ":var0"),
      (party_get_morale, ":var6", ":var5"),
      (store_sub, ":var7", ":var6", 70),
      (val_mul, ":var7", 30),
      (val_add, ":var1", ":var7"),
      (agent_set_slot, ":var0", 16, ":var1"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var3", ":var0"),
        (party_add_members, "p_total_enemy_casualties", ":var3", 1),
        (eq, ":var2", 1),
        (party_wound_members, "p_total_enemy_casualties", ":var3", 1),
      (try_end),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (try_begin),
        (store_mission_timer_a, ":var1"),
        (gt, ":var1", 20),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 10, 20, 1),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_place_player_banner_near_inventory_bms"),
      (party_clear, "p_routed_enemies"),
      (assign, "$g_latest_order_1", 1),
      (assign, "$g_latest_order_2", 1),
      (assign, "$g_latest_order_3", 1),
      (assign, "$g_latest_order_4", 1),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (call_script, "script_place_player_banner_near_inventory"),
      (call_script, "script_combat_music_set_situation_with_culture", 1024),
      (assign, "$g_defender_reinforcement_limit", 2),
      (assign, "$dmod_current_agent", -1),
      (assign, "$dmod_move_camera", -1),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture", 1024),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 0, 5, 
    [
      (call_script, "script_party_count_members_with_full_health", "p_collective_enemy"),
      (assign, ":var0", reg0),
      (assign, ":var1", 0),
      (try_for_agents, ":var2"),
        (agent_is_human, ":var2"),
        (agent_get_party_id, ":var3", ":var2"),
        (try_begin),
          (neq, ":var3", "p_main_party"),
          (neg|agent_is_ally, ":var2"),
          (val_add, ":var1", 1),
        (try_end),
      (try_end),
      (store_sub, ":var4", ":var0", ":var1"),
      (try_begin),
        (lt, ":var4", 15),
        (ge, "$defender_reinforcement_stage", 2),
        (eq, "$defender_reinforcement_limit_increased", 0),
        (val_add, "$g_defender_reinforcement_limit", 1),
        (assign, "$defender_reinforcement_limit_increased", 1),
      (try_end),
      (lt, "$defender_reinforcement_stage", "$g_defender_reinforcement_limit"),
      (store_mission_timer_a, ":var5"),
      (ge, ":var5", 5),
      (store_normalized_team_count, ":var6", 0),
      (lt, ":var6", 24),
    ],
    [
      (add_reinforcements_to_entry, 2, 28),
      (assign, "$defender_reinforcement_limit_increased", 0),
      (val_add, "$defender_reinforcement_stage", 1),
    ]),

    (1, 0, 5, 
    [
      (lt, "$attacker_reinforcement_stage", "$g_defender_reinforcement_limit"),
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
      (store_normalized_team_count, ":var1", 1),
      (lt, ":var1", 24),
    ],
    [
      (add_reinforcements_to_entry, 4, 28),
      (val_add, "$attacker_reinforcement_stage", 1),
    ]),

    (5, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (try_begin),
        (eq, "$auxilary_player_active", 0),
        (call_script, "script_freelancer_keep_field_loot"),
      (try_end),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (assign, "$do_once_3", 0),
      (finish_mission, 1),
    ]),

    (5, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (val_add, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
      (set_mission_result, -1),
      (display_message, "@Battle lost..."),
      (assign, "$g_battle_won", -1),
      (assign, "$g_battle_result", -1),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (assign, "$do_once_3", 0),
      (finish_mission, 0),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", -1),
      (display_message, "@Battle lost! Press tab key to leave..."),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (gt, "$dmod_current_agent", 0),
      (eq, "$setting_use_dmod", 1),
      (eq, "$dmod_move_camera", 1),
      (agent_get_position, pos1, "$dmod_current_agent"),
      (position_move_z, pos1, 300),
      (position_move_y, pos1, -300),
      (agent_get_horse, ":var0", "$dmod_current_agent"),
      (try_begin),
        (ge, ":var0", 0),
      (try_end),
      (mission_cam_set_position, pos1),
      (mission_cam_set_mode, 1),
      (set_fixed_point_multiplier, 100),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_up),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_forwards"),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_down),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_backwards"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 4, ti_once, 
    [
      (eq, "$enable_deahtcam", 1),
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
      (assign, "$tom_sand_storm", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (this_or_next|eq, "$dmod_move_camera", 1),
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, gk_move_forward),
      (this_or_next|game_key_is_down, gk_move_backward),
      (this_or_next|game_key_is_down, gk_move_left),
      (this_or_next|game_key_is_down, gk_move_right),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_backward),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_left),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (position_rotate_x_floating, pos47, ":var7"),
        (position_rotate_y, pos47, 90),
        (position_rotate_x_floating, pos47, ":var3"),
        (position_rotate_y, pos47, -90),
        (position_rotate_x_floating, pos47, "$deathcam_total_rotx"),
        (position_rotate_x_floating, pos47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|eq, ":var0", 0),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "str_enhanced_battle_knocked_out_message_1"),
      (display_message, "str_enhanced_battle_knocked_out_message_2"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (is_presentation_active, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$enable_deahtcam", 1),
      (assign, "$auxilary_player_active", 0),
      (eq, "$use_player_auxiliary", 1),
      (assign, "$g_move_heroes", 1),
      (party_clear, "p_temp_casualties_3"),
      (call_script, "script_party_add_party", "p_temp_casualties_3", "p_main_party"),
      (set_player_troop, "trp_player"),
      (assign, "$enable_deahtcam", 0),
    ]),

    (5, 0, 0, 
    [
      (eq, "$use_player_auxiliary", 1),
      (eq, "$enable_deahtcam", 0),
      (get_player_agent_no, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (neq, "$freelancer_state", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_division, ":var2", ":var0"),
      (assign, ":var3", 0),
      (try_for_agents, ":var4"),
        (eq, ":var3", 0),
        (agent_is_human, ":var4"),
        (agent_is_alive, ":var4"),
        (agent_get_team, ":var5", ":var4"),
        (agent_get_party_id, ":var6", ":var4"),
        (eq, ":var6", "p_main_party"),
        (agent_get_division, ":var7", ":var0"),
        (agent_get_group, ":var8", ":var0"),
        (eq, ":var1", ":var5"),
        (eq, ":var2", ":var7"),
        (agent_get_troop_id, ":var9", ":var4"),
        (neg|is_between, ":var9", "trp_npc1", "trp_enhanced_rnd_lord_end"),
        (set_player_troop, ":var9"),
        (store_agent_hit_points, ":var10", ":var4", 1),
        (agent_get_position, pos1, ":var4"),
        (position_set_z, pos1, -2000),
        (position_set_x, pos1, 0),
        (position_set_y, pos1, 0),
        (agent_get_position, pos0, ":var4"),
        (set_spawn_position, pos0),
        (agent_get_horse, ":var11", ":var4"),
        (try_begin),
          (gt, ":var11", 0),
          (agent_set_position, ":var11", pos1),
          (remove_agent, ":var11"),
        (try_end),
        (agent_set_position, ":var4", pos1),
        (agent_set_slot, ":var4", 35, 1),
        (agent_get_slot, ":var12", ":var4", 102),
        (remove_agent, ":var4"),
        (spawn_agent, ":var9"),
        (assign, ":var0", reg0),
        (agent_set_slot, ":var0", 102, ":var12"),
        (agent_set_team, ":var0", ":var1"),
        (agent_set_hit_points, ":var0", ":var10", 1),
        (agent_set_group, ":var0", ":var8"),
        (agent_set_slot, ":var0", 35, 2),
        (agent_set_slot, ":var0", 36, ":var9"),
        (try_begin),
          (agent_get_horse, ":var13", ":var0"),
          (gt, ":var13", 0),
          (lt, ":var11", 0),
          (agent_set_position, ":var13", pos1),
          (remove_agent, ":var13"),
        (try_end),
        (set_player_troop, "trp_player"),
        (assign, ":var3", 1),
        (assign, "$auxilary_player_active", 1),
      (try_end),
      (eq, ":var3", 0),
      (assign, "$enable_deahtcam", 1),
    ]),

    (5, 0, 0, 
    [
      (eq, "$use_player_auxiliary", 1),
      (eq, "$enable_deahtcam", 0),
      (get_player_agent_no, ":var0"),
      (neg|agent_is_alive, ":var0"),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$enable_deahtcam", 1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

    (2, 0, 0, 
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_non_player, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (store_skill_level, ":var2", "skl_horse_archery", ":var1"),
        (ge, ":var2", 4),
      (try_end),
    ],
    [
      (set_fixed_point_multiplier, 1000),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_non_player, ":var0"),
        (neg|agent_slot_eq, ":var0", 1003, 1),
        (agent_get_horse, ":var1", ":var0"),
        (assign, ":var2", -1),
        (try_begin),
          (agent_slot_eq, ":var0", 15, 0),
          (gt, ":var1", -1),
          (agent_get_team, ":var3", ":var0"),
          (agent_get_division, ":var4", ":var0"),
          (team_get_weapon_usage_order, ":var5", ":var3", ":var4"),
          (team_get_movement_order, ":var6", ":var3", ":var4"),
          (team_get_hold_fire_order, ":var7", ":var3", ":var4"),
          (assign, ":var8", 0),
          (assign, ":var9", -1),
          (try_for_range, ":var10", 0, 4),
            (agent_get_item_slot, ":var11", ":var0", ":var10"),
            (gt, ":var11", 0),
            (item_get_type, ":var12", ":var11"),
            (try_begin),
              (eq, ":var12", 10),
              (agent_get_ammo_for_slot, ":var13", ":var0", ":var10"),
              (val_add, ":var8", ":var13"),
            (else_try),
              (this_or_next|eq, ":var12", 8),
              (this_or_next|eq, ":var12", 16),
              (eq, ":var12", 17),
              (assign, ":var9", ":var11"),
            (else_try),
              (this_or_next|eq, ":var12", 2),
              (this_or_next|eq, ":var12", 3),
              (eq, ":var12", 4),
              (assign, ":var2", ":var11"),
            (try_end),
          (try_end),
          (gt, ":var9", -1),
          (neg|item_has_property, ":var9", itp_cant_reload_on_horseback),
          (neg|item_has_property, ":var9", itp_cant_use_on_horseback),
          (agent_get_ammo, ":var14", ":var0", 0),
          (val_sub, ":var14", ":var8"),
          (gt, ":var14", 0),
          (agent_set_slot, ":var0", 1003, 2),
          (neq, ":var7", 1),
          (neq, ":var5", 2),
          (eq, ":var6", 2),
          (agent_get_position, pos50, ":var0"),
          (agent_get_speed, pos31, ":var0"),
          (position_get_y, ":var15", pos31),
          (assign, ":var16", 100000),
          (assign, ":var17", -1),
          (try_for_agents, ":var18"),
            (agent_is_alive, ":var18"),
            (agent_is_human, ":var18"),
            (agent_get_position, pos36, ":var18"),
            (agent_get_team, ":var19", ":var18"),
            (teams_are_enemies, ":var3", ":var19"),
            (get_distance_between_positions, ":var20", pos50, pos36),
            (try_begin),
              (agent_slot_eq, ":var18", 15, 1),
              (val_add, ":var20", 10000),
            (try_end),
            (try_begin),
              (agent_get_horse, ":var21", ":var18"),
              (gt, ":var21", -1),
              (agent_get_speed, pos32, ":var18"),
              (position_get_y, ":var22", pos32),
              (val_sub, ":var22", ":var15"),
              (store_div, ":var23", ":var22", 5),
              (val_max, ":var23", 0),
              (val_add, ":var23", 500),
              (val_sub, ":var20", ":var23"),
            (else_try),
              (agent_get_wielded_item, ":var24", ":var18", 1),
              (le, ":var24", 1),
              (val_sub, ":var20", 500),
            (try_end),
            (lt, ":var20", ":var16"),
            (assign, ":var16", ":var20"),
            (assign, ":var17", ":var18"),
          (try_end),
          (neq, ":var17", -1),
          (agent_get_position, pos51, ":var17"),
          (get_distance_between_positions, ":var25", pos50, pos51),
          (try_begin),
            (agent_slot_eq, ":var17", 15, 0),
            (gt, ":var25", 200),
            (agent_set_wielded_item, ":var0", ":var9"),
          (else_try),
            (le, ":var25", 200),
            (gt, ":var2", -1),
            (agent_set_wielded_item, ":var0", ":var2"),
          (try_end),
          (assign, ":var26", 1000),
          (try_begin),
            (agent_get_wielded_item, ":var24", ":var0", 0),
            (gt, ":var24", 0),
            (item_get_type, ":var27", ":var24"),
            (this_or_next|eq, ":var27", 8),
            (this_or_next|eq, ":var27", 16),
            (eq, ":var27", 17),
            (agent_get_bone_position, pos53, ":var0", 8, 1),
            (agent_get_bone_position, pos54, ":var17", 9, 1),
            (position_has_line_of_sight_to_position, pos53, pos54),
            (agent_set_look_target_agent, ":var0", ":var17"),
            (try_begin),
              (assign, ":var28", 4000),
              (agent_get_attack_action, ":var29", ":var0"),
              (eq, ":var29", 1),
              (try_begin),
                (gt, ":var16", 700),
                (le, ":var16", ":var28"),
                (store_div, ":var26", ":var15", 2000),
                (val_max, ":var26", 0),
              (try_end),
              (eq, ":var27", 8),
              (try_begin),
                (le, ":var25", ":var28"),
                (agent_set_defend_action, ":var0", -2, 1),
                (agent_set_attack_action, ":var0", 3, 0),
              (else_try),
                (gt, ":var25", ":var28"),
                (agent_set_attack_action, ":var0", -2, 1),
                (agent_set_defend_action, ":var0", 3, 1),
              (try_end),
            (else_try),
              (eq, ":var27", 8),
              (le, ":var25", ":var28"),
              (agent_get_combat_state, ":var30", ":var0"),
              (neq, ":var30", 8),
              (agent_set_attack_action, ":var0", 3, 1),
            (try_end),
          (try_end),
          (agent_set_speed_limit, ":var0", ":var26"),
          (try_begin),
            (agent_slot_eq, ":var17", 15, 0),
            (lt, ":var16", 10000),
            (try_begin),
              (get_scene_boundaries, pos2, pos3),
              (position_transform_position_to_local, pos4, pos2, pos50),
              (position_get_x, ":var31", pos4),
              (position_get_y, ":var32", pos4),
              (position_transform_position_to_local, pos4, pos2, pos3),
              (position_get_x, ":var33", pos4),
              (position_get_y, ":var34", pos4),
              (store_sub, ":var35", ":var33", ":var31"),
              (store_sub, ":var36", ":var34", ":var32"),
              (position_transform_position_to_local, pos4, pos50, pos51),
              (position_get_x, ":var37", pos4),
              (position_get_y, ":var38", pos4),
              (assign, ":var39", 0),
              (try_begin),
                (le, ":var16", 1000),
                (assign, ":var39", -78000),
              (else_try),
                (gt, ":var16", 2000),
                (store_sub, ":var39", ":var16", 0),
                (val_mul, ":var39", 5),
                (val_clamp, ":var39", 35000, 90000),
              (try_end),
              (assign, ":var40", 30000),
              (val_min, ":var40", ":var31"),
              (val_min, ":var40", ":var36"),
              (val_min, ":var40", ":var35"),
              (val_min, ":var40", ":var32"),
              (try_begin),
                (lt, ":var40", 30000),
                (agent_slot_eq, ":var17", 15, 0),
                (store_div, ":var41", ":var33", 20),
                (store_div, ":var42", ":var34", 20),
                (position_copy_origin, pos4, pos2),
                (position_move_x, 4, ":var41", 1),
                (position_move_y, pos4, ":var42", 1),
                (get_distance_between_positions, ":var43", pos4, pos50),
                (position_transform_position_to_local, pos4, pos50, pos4),
                (position_get_x, ":var41", pos4),
                (position_get_y, ":var42", pos4),
                (val_mul, ":var41", 100),
                (val_mul, ":var42", 100),
                (val_mul, ":var37", 100),
                (val_mul, ":var38", 100),
                (store_div, ":var44", ":var41", ":var43"),
                (store_div, ":var45", ":var42", ":var43"),
                (store_div, ":var46", ":var37", ":var25"),
                (store_div, ":var47", ":var38", ":var25"),
                (store_acos, ":var48", ":var44"),
                (store_asin, ":var49", ":var45"),
                (store_acos, ":var50", ":var46"),
                (store_asin, ":var51", ":var47"),
                (try_begin),
                  (lt, ":var49", 0),
                  (val_mul, ":var48", -1),
                  (val_add, ":var48", 360000),
                (try_end),
                (try_begin),
                  (lt, ":var51", 0),
                  (val_mul, ":var50", -1),
                  (val_add, ":var50", 360000),
                (try_end),
                (store_sub, ":var52", ":var48", ":var50"),
                (val_sub, ":var52", 270000),
                (val_sub, ":var52", ":var39"),
                (store_add, ":var39", ":var52", ":var39"),
                (try_begin),
                  (lt, ":var48", ":var50"),
                  (val_add, ":var39", 360000),
                (try_end),
                (val_clamp, ":var39", -210000, 15000),
                (agent_set_attack_action, ":var0", -2, 1),
                (agent_set_defend_action, ":var0", 3, 1),
              (try_end),
              (store_cos, ":var53", ":var39"),
              (store_sin, ":var54", ":var39"),
              (store_mul, ":var55", ":var53", ":var38"),
              (store_mul, ":var56", ":var54", ":var37"),
              (store_mul, ":var57", ":var54", ":var38"),
              (store_mul, ":var58", ":var53", ":var37"),
              (store_add, ":var59", ":var55", ":var56"),
              (store_sub, ":var60", ":var57", ":var58"),
              (position_move_x, 50, ":var59", 0),
              (position_move_y, pos50, ":var60", 0),
            (try_end),
            (agent_set_scripted_destination, ":var0", pos50, 1),
          (else_try),
            (agent_clear_scripted_mode, ":var0"),
            (agent_force_rethink, ":var0"),
          (try_end),
        (else_try),
          (try_begin),
            (agent_slot_eq, ":var0", 1003, 0),
            (agent_set_slot, ":var0", 1003, 1),
          (else_try),
            (agent_slot_eq, ":var0", 1003, 2),
            (this_or_next|agent_slot_eq, ":var0", 15, 1),
            (this_or_next|lt, ":var1", 0),
            (this_or_next|eq, ":var14", 0),
            (this_or_next|eq, ":var7", 1),
            (this_or_next|eq, ":var5", 2),
            (neq, ":var6", 2),
            (agent_clear_scripted_mode, ":var0"),
            (agent_set_speed_limit, ":var0", 100),
            (agent_force_rethink, ":var0"),
            (agent_set_slot, ":var0", 1003, 3),
            (this_or_next|eq, ":var7", 1),
            (eq, ":var14", 0),
            (gt, ":var2", -1),
            (agent_set_wielded_item, ":var0", ":var2"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [
      (neg|is_presentation_active, "prsnt_killcount"),
      (neg|is_presentation_active, "prsnt_troop_ratio_bar"),
      (neg|is_presentation_active, "prsnt_killcount_and_troop_ratio_bar"),
    ],
    [
      (try_begin),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 1),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 2),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 3),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
      (call_script, "script_party_count_fit_for_battle", "p_main_party"),
      (assign, "$player_count_alive", reg0),
      (call_script, "script_party_count_fit_for_battle", "p_collective_friends"),
      (store_sub, "$ally_count_alive", reg0, "$player_count_alive"),
      (call_script, "script_party_count_fit_for_battle", "p_collective_enemy"),
      (assign, "$enemy_count_alive", reg0),
    ]),

    (3, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 1),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 2),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 3),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
    ]),

    (0.2, 0, ti_once, 
    [],
    [
      (assign, "$spear_in_position", 0),
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 26, 0),
        (agent_set_slot, ":var0", 27, 0),
        (agent_set_slot, ":var0", 28, 0),
        (agent_set_slot, ":var0", 29, 0),
        (agent_set_slot, ":var0", 30, 0),
      (try_end),
    ]),

    (0.5, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 27),
        (agent_get_slot, ":var2", ":var0", 28),
        (agent_get_slot, ":var3", ":var0", 29),
        (agent_get_position, pos1, ":var0"),
        (position_get_x, ":var4", pos1),
        (position_get_y, ":var5", pos1),
        (position_get_z, ":var6", pos1),
        (position_set_x, pos2, ":var1"),
        (position_set_y, pos2, ":var2"),
        (position_set_z, pos2, ":var3"),
        (position_set_x, pos1, ":var4"),
        (position_set_y, pos1, ":var5"),
        (position_set_z, pos1, ":var6"),
        (agent_get_speed, pos5, ":var0"),
        (call_script, "script_vector_length", 5),
        (assign, ":var7", reg0),
        (agent_set_slot, ":var0", 27, ":var4"),
        (agent_set_slot, ":var0", 28, ":var5"),
        (agent_set_slot, ":var0", 29, ":var6"),
        (agent_set_slot, ":var0", 30, ":var7"),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
      (this_or_next|game_key_clicked, gk_attack),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_move_forward),
      (this_or_next|game_key_clicked, gk_move_backward),
      (this_or_next|game_key_clicked, gk_move_left),
      (this_or_next|game_key_clicked, gk_move_right),
      (this_or_next|game_key_clicked, gk_equip_primary_weapon),
      (this_or_next|game_key_clicked, gk_equip_secondary_weapon),
      (this_or_next|game_key_clicked, gk_action),
      (game_key_clicked, gk_sheath_weapon),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (display_message, "@Releasing spear.", 0x6495ED),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
    ]),

    (0.2, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_get_horse, ":var1", ":var0"),
        (le, ":var1", 0),
        (agent_get_slot, ":var2", ":var0", 26),
        (lt, ":var2", 10),
        (val_add, ":var2", 2),
        (agent_set_slot, ":var0", 26, ":var2"),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_set_animation, ":var0", "anim_spearwall_hold"),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (try_for_agents, ":var2"),
        (agent_is_alive, ":var2"),
        (neq, ":var2", ":var0"),
        (agent_is_human, ":var2"),
        (agent_get_horse, ":var3", ":var2"),
        (le, ":var3", 0),
        (agent_get_slot, ":var4", ":var2", 26),
        (ge, ":var4", 10),
        (agent_get_simple_behavior, ":var5", ":var2"),
        (agent_get_team, ":var6", ":var2"),
        (agent_get_class, ":var7", ":var2"),
        (team_get_movement_order, ":var8", ":var6", ":var7"),
        (assign, ":var9", 0),
        (try_begin),
          (neq, ":var6", ":var1"),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (else_try),
          (this_or_next|eq, ":var8", 0),
          (eq, ":var8", 11),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (this_or_next|eq, ":var5", 4),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (try_end),
        (eq, ":var9", 1),
        (agent_get_troop_id, ":var10", ":var2"),
        (store_proficiency_level, ":var11", ":var10", ca_intelligence),
        (store_character_level, ":var12", ":var10"),
        (ge, ":var12", 12),
        (ge, ":var11", 120),
        (neg|troop_is_mounted, ":var10"),
        (agent_slot_eq, ":var2", 15, 0),
        (assign, ":var9", 0),
        (agent_get_wielded_item, ":var13", ":var2", 0),
        (agent_get_wielded_item, ":var14", ":var2", 1),
        (assign, ":var15", 145),
        (try_begin),
          (this_or_next|is_between, ":var13", "itm_modded_billhook_fork_1", "itm_maul"),
          (is_between, ":var14", "itm_modded_billhook_fork_1", "itm_maul"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_1"),
            (eq, ":var14", "itm_modded_billhook_fork_1"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_2"),
            (eq, ":var14", "itm_modded_billhook_fork_2"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_1"),
            (eq, ":var14", "itm_modded_fauchard_1"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_2"),
            (eq, ":var14", "itm_modded_fauchard_2"),
            (assign, "$spear_dist", 171),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_3"),
            (eq, ":var14", "itm_modded_fauchard_3"),
            (assign, "$spear_dist", 197),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_4"),
            (eq, ":var14", "itm_modded_fauchard_4"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_1"),
            (eq, ":var14", "itm_modded_glaive_1"),
            (assign, "$spear_dist", 169),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_1"),
            (eq, ":var14", "itm_modded_glaive_fork_1"),
            (assign, "$spear_dist", 230),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_2"),
            (eq, ":var14", "itm_modded_glaive_fork_2"),
            (assign, "$spear_dist", 188),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_roundel"),
            (eq, ":var14", "itm_modded_glaive_roundel"),
            (assign, "$spear_dist", 149),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_1"),
            (eq, ":var14", "itm_modded_bill_1"),
            (assign, "$spear_dist", 215),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_2"),
            (eq, ":var14", "itm_modded_bill_2"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_1"),
            (eq, ":var14", "itm_modded_billhook_1"),
            (assign, "$spear_dist", 207),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_2"),
            (eq, ":var14", "itm_modded_billhook_2"),
            (assign, "$spear_dist", 172),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_3"),
            (eq, ":var14", "itm_modded_billhook_3"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_voulge"),
            (eq, ":var14", "itm_modded_voulge"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_spiked_voulge"),
            (eq, ":var14", "itm_modded_spiked_voulge"),
            (assign, "$spear_dist", 182),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_cleaving_voulge"),
            (eq, ":var14", "itm_modded_cleaving_voulge"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_1"),
            (eq, ":var14", "itm_modded_hooked_voulge_1"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_2"),
            (eq, ":var14", "itm_modded_hooked_voulge_2"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_3"),
            (eq, ":var14", "itm_modded_hooked_voulge_3"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_1"),
            (eq, ":var14", "itm_modded_couteau_1"),
            (assign, "$spear_dist", 177),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_2"),
            (eq, ":var14", "itm_modded_couteau_2"),
            (assign, "$spear_dist", 196),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_guisarme"),
            (eq, ":var14", "itm_modded_guisarme"),
            (assign, "$spear_dist", 232),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_assegai"),
            (eq, ":var14", "itm_modded_assegai"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_pike"),
            (eq, ":var14", "itm_modded_pike"),
            (assign, "$spear_dist", 300),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_war_spear"),
            (eq, ":var14", "itm_modded_war_spear"),
            (assign, "$spear_dist", 211),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_glaive"),
          (is_between, ":var14", "itm_glaive"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_glaive"),
            (eq, ":var14", "itm_glaive"),
            (assign, "$spear_dist", 160),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_bill"),
          (is_between, ":var14", "itm_bill"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_bill"),
            (eq, ":var14", "itm_bill"),
            (assign, "$spear_dist", 128),
          (try_end),
        (try_end),
        (eq, ":var9", 1),
        (assign, ":var16", -1),
        (agent_get_position, pos1, ":var2"),
        (try_for_agents, ":var17"),
          (agent_is_alive, ":var17"),
          (neg|agent_is_human, ":var17"),
          (agent_get_rider, ":var18", ":var17"),
          (ge, ":var18", 0),
          (agent_get_team, ":var19", ":var18"),
          (teams_are_enemies, ":var6", ":var19"),
          (agent_get_position, pos2, ":var17"),
          (get_distance_between_positions, ":var20", pos1, pos2),
          (lt, ":var20", ":var15"),
          (neg|position_is_behind_position, pos2, pos1),
          (agent_get_slot, ":var21", ":var17", 30),
          (gt, ":var21", 0),
          (assign, ":var16", ":var17"),
        (try_end),
        (gt, ":var16", -1),
        (agent_play_sound, ":var16", "snd_metal_hit_high_armor_high_damage"),
        (store_agent_hit_points, ":var22", ":var16", 0),
        (store_agent_hit_points, ":var23", ":var16", 1),
        (assign, reg22, ":var21"),
        (val_mul, ":var21", 10),
        (val_sub, ":var22", ":var21"),
        (val_max, ":var22", 0),
        (agent_set_slot, ":var2", 26, 0),
        (agent_get_horse, ":var24", ":var0"),
        (agent_get_position, pos2, ":var16"),
        (agent_set_look_target_position, ":var2", pos2),
        (agent_set_attack_action, ":var2", 0, 0),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_get_troop_id, ":var10", ":var2"),
        (str_store_troop_name, s21, ":var10"),
        (agent_get_troop_id, ":var25", ":var16"),
        (str_store_troop_name, s20, ":var25"),
        (store_agent_hit_points, ":var22", ":var16", 1),
        (val_sub, ":var23", ":var22"),
        (assign, reg1, ":var23"),
        (try_begin),
          (eq, ":var16", ":var24"),
          (display_message, "@Your horse received {reg1} damage from a braced polearm!", 0xFF4040),
        (try_end),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (store_agent_hit_points, ":var1", ":var0", 1),
      (lt, ":var1", "$spear_hp"),
      (display_message, "@The injury causes your grip on the polearm to slip!", 0xFF4040),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 26),
      (ge, ":var1", 10),
      (assign, ":var2", -1),
      (agent_get_position, pos1, ":var0"),
      (try_for_agents, ":var3"),
        (agent_is_alive, ":var3"),
        (neg|agent_is_human, ":var3"),
        (agent_get_rider, ":var4", ":var3"),
        (ge, ":var4", 0),
        (neg|agent_is_ally, ":var4"),
        (agent_get_position, pos2, ":var3"),
        (get_distance_between_positions, ":var5", pos1, pos2),
        (lt, ":var5", "$spear_dist"),
        (neg|position_is_behind_position, pos2, pos1),
        (agent_get_slot, ":var6", ":var3", 30),
        (ge, ":var6", 120),
        (assign, ":var2", ":var3"),
      (try_end),
      (gt, ":var2", -1),
      (agent_play_sound, ":var2", "snd_metal_hit_high_armor_high_damage"),
      (store_agent_hit_points, ":var7", ":var2", 0),
      (store_agent_hit_points, ":var8", ":var2", 1),
      (val_div, ":var6", 2),
      (val_sub, ":var6", 15),
      (val_sub, ":var7", ":var6"),
      (val_max, ":var7", 0),
      (agent_set_hit_points, ":var2", ":var7", 0),
      (agent_deliver_damage_to_agent, ":var2", ":var2"),
      (agent_set_slot, ":var0", 26, 0),
      (store_agent_hit_points, ":var7", ":var2", 1),
      (val_sub, ":var8", ":var7"),
      (assign, reg1, ":var8"),
      (display_message, "@Polearm-wall dealt {reg1} damage!"),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 2, 
    [
      (key_clicked, key_b),
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_is_alive, ":var1"),
      (agent_get_wielded_item, ":var2", ":var1", 0),
      (agent_get_wielded_item, ":var3", ":var1", 1),
      (assign, "$spear_dist", 145),
      (try_begin),
        (this_or_next|is_between, ":var2", "itm_modded_billhook_fork_1", "itm_maul"),
        (is_between, ":var3", "itm_modded_billhook_fork_1", "itm_maul"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_1"),
          (eq, ":var3", "itm_modded_billhook_fork_1"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_2"),
          (eq, ":var3", "itm_modded_billhook_fork_2"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_1"),
          (eq, ":var3", "itm_modded_fauchard_1"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_2"),
          (eq, ":var3", "itm_modded_fauchard_2"),
          (assign, "$spear_dist", 171),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_3"),
          (eq, ":var3", "itm_modded_fauchard_3"),
          (assign, "$spear_dist", 197),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_4"),
          (eq, ":var3", "itm_modded_fauchard_4"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_1"),
          (eq, ":var3", "itm_modded_glaive_1"),
          (assign, "$spear_dist", 169),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_1"),
          (eq, ":var3", "itm_modded_glaive_fork_1"),
          (assign, "$spear_dist", 230),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_2"),
          (eq, ":var3", "itm_modded_glaive_fork_2"),
          (assign, "$spear_dist", 188),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_roundel"),
          (eq, ":var3", "itm_modded_glaive_roundel"),
          (assign, "$spear_dist", 149),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_1"),
          (eq, ":var3", "itm_modded_bill_1"),
          (assign, "$spear_dist", 215),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_2"),
          (eq, ":var3", "itm_modded_bill_2"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_1"),
          (eq, ":var3", "itm_modded_billhook_1"),
          (assign, "$spear_dist", 207),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_2"),
          (eq, ":var3", "itm_modded_billhook_2"),
          (assign, "$spear_dist", 172),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_3"),
          (eq, ":var3", "itm_modded_billhook_3"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_voulge"),
          (eq, ":var3", "itm_modded_voulge"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_spiked_voulge"),
          (eq, ":var3", "itm_modded_spiked_voulge"),
          (assign, "$spear_dist", 182),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_cleaving_voulge"),
          (eq, ":var3", "itm_modded_cleaving_voulge"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_1"),
          (eq, ":var3", "itm_modded_hooked_voulge_1"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_2"),
          (eq, ":var3", "itm_modded_hooked_voulge_2"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_3"),
          (eq, ":var3", "itm_modded_hooked_voulge_3"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_1"),
          (eq, ":var3", "itm_modded_couteau_1"),
          (assign, "$spear_dist", 177),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_2"),
          (eq, ":var3", "itm_modded_couteau_2"),
          (assign, "$spear_dist", 196),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_guisarme"),
          (eq, ":var3", "itm_modded_guisarme"),
          (assign, "$spear_dist", 232),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_assegai"),
          (eq, ":var3", "itm_modded_assegai"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_pike"),
          (eq, ":var3", "itm_modded_pike"),
          (assign, "$spear_dist", 300),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_war_spear"),
          (eq, ":var3", "itm_modded_war_spear"),
          (assign, "$spear_dist", 211),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_glaive"),
        (is_between, ":var3", "itm_glaive"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_glaive"),
          (eq, ":var3", "itm_glaive"),
          (assign, "$spear_dist", 160),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_bill"),
        (is_between, ":var3", "itm_bill"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_bill"),
          (eq, ":var3", "itm_bill"),
          (assign, "$spear_dist", 128),
        (try_end),
      (try_end),
      (eq, ":var0", 1),
      (agent_get_horse, ":var4", ":var1"),
      (le, ":var4", 0),
      (neq, "$spear_in_position", 1),
      (display_message, "@Bracing polearm for charge.", 0x6495ED),
      (agent_set_animation, ":var1", "anim_spearwall_hold"),
      (assign, "$spear_in_position", 1),
      (store_agent_hit_points, "$spear_hp", ":var1", 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 41, ":var0"),
    ]),

    (0, 0, 3, 
    [
      (key_clicked, key_h),
    ],
    [
      (agent_get_slot, ":var0", "$fplayer_agent_no", 41),
      (gt, ":var0", 0),
      (agent_is_active, ":var0"),
      (agent_get_horse, reg0, "$fplayer_agent_no"),
      (eq, reg0, -1),
      (agent_play_sound, "$fplayer_agent_no", "snd_man_breath_hard"),
      (display_message, "@You whistle for your horse."),
      (agent_is_alive, ":var0"),
      (agent_get_position, pos1, "$fplayer_agent_no"),
      (agent_set_scripted_destination, ":var0", pos1, 0),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_2, ":var0"),
      (ge, ":var0", 0),
      (item_get_type, ":var1", ":var0"),
      (this_or_next|eq, ":var1", 8),
      (eq, ":var1", 9),
      (store_trigger_param_1, ":var2"),
      (agent_is_active, ":var2"),
      (agent_is_alive, ":var2"),
      (agent_is_non_player, ":var2"),
      (agent_get_ammo, ":var3", ":var2", 0),
      (le, ":var3", 0),
      (agent_get_horse, ":var4", ":var2"),
      (eq, ":var4", -1),
      (assign, ":var5", 1),
      (try_begin),
        (this_or_next|party_slot_eq, "$g_encountered_party", 0, 3),
        (party_slot_eq, "$g_encountered_party", 0, 2),
        (agent_get_team, ":var6", ":var2"),
        (this_or_next|eq, ":var6", "$defender_team"),
        (eq, ":var6", "$defender_team_2"),
        (assign, ":var5", 0),
      (try_end),
      (eq, ":var5", 1),
      (agent_set_division, ":var2", 4),
      (agent_set_slot, ":var2", 42, 4),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_slot, ":var0", 42, -1),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_active, ":var0"),
        (agent_slot_ge, ":var0", 42, 0),
        (agent_is_alive, ":var0"),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 42, ":var1"),
        (agent_get_slot, ":var2", ":var0", 42),
        (agent_set_division, ":var0", ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_slot, ":var0", 42, -1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (neg|agent_is_human, ":var0"),
        (agent_get_rider, ":var1", ":var0"),
        (ge, ":var1", 0),
        (agent_is_active, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_is_non_player, ":var1"),
      (else_try),
        (assign, ":var1", -1),
      (try_end),
      (agent_set_slot, ":var0", 41, ":var1"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (neg|agent_is_human, ":var0"),
      (agent_get_slot, ":var1", ":var0", 41),
      (ge, ":var1", 0),
      (agent_is_active, ":var1"),
      (agent_is_alive, ":var1"),
      (try_begin),
        (assign, ":var2", 70),
        (agent_get_troop_id, ":var3", ":var1"),
        (store_skill_level, ":var4", "skl_riding", ":var3"),
        (store_mul, ":var5", ":var4", 5),
        (val_sub, ":var2", ":var5"),
        (call_script, "script_rand", 0, 100),
        (le, reg0, ":var2"),
        (call_script, "script_rand", 60, 80),
        (assign, ":var6", reg0),
        (store_mul, ":var7", ":var4", 7),
        (val_sub, ":var6", ":var7"),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var6"),
        (try_begin),
          (neg|agent_is_non_player, ":var1"),
          (display_message, "@You fall down from your horse and sustain some damage!"),
        (try_end),
      (try_end),
      (try_begin),
        (agent_is_active, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_set_division, ":var1", 0),
        (agent_set_slot, ":var1", 42, 0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_active, ":var0"),
        (agent_slot_ge, ":var0", 42, 0),
        (agent_is_alive, ":var0"),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 42, ":var1"),
        (agent_get_slot, ":var2", ":var0", 42),
        (agent_set_division, ":var0", ":var2"),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (call_script, "script_lance_use_classify_agent"),
    ]),

    (2, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 43),
        (gt, ":var1", 0),
        (agent_get_wielded_item, ":var2", ":var0", 0),
        (agent_get_horse, ":var3", ":var0"),
        (try_begin),
          (le, ":var3", 0),
          (agent_set_slot, ":var0", 43, 0),
          (eq, ":var2", ":var1"),
          (call_script, "script_lance_use_backup_weapon", ":var0"),
        (else_try),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var4", ":var0"),
          (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":var4", 1),
          (assign, ":var5", reg0),
          (try_begin),
            (lt, ":var5", 500),
            (agent_get_combat_state, ":var6", ":var0"),
            (gt, ":var6", 3),
            (eq, ":var2", ":var1"),
            (call_script, "script_lance_use_backup_weapon", ":var0"),
          (else_try),
            (neq, ":var2", ":var1"),
            (agent_set_wielded_item, ":var0", ":var1"),
          (try_end),
        (try_end),
      (try_end),
    ]),

  ]),

  ("pagan_stronghold_attack", mtf_battle_mode, -1,
  "You attack the stronghold...",
  [
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 12, []),
    (0, mtef_team_1|mtef_attackers, af_override_horse, aif_start_alarmed, 0, []),
    (10, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
    (11, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 7, []),
    (15, mtef_team_0|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
    (40, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (43, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_0|mtef_defenders|mtef_archers_first, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (get_player_agent_no, ":var1"),
      (agent_get_team, ":var2", ":var1"),
      (try_begin),
        (neq, "$attacker_team", ":var2"),
        (neq, "$attacker_team_2", ":var2"),
        (str_store_string, s5, "str_siege_continues"),
        (call_script, "script_simulate_retreat", 8, 15, 0),
      (else_try),
        (str_store_string, s5, "str_retreat"),
        (call_script, "script_simulate_retreat", 5, 20, 0),
      (try_end),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (assign, "$defender_reinforcement_stage", 0),
      (assign, "$attacker_reinforcement_stage", 0),
      (assign, "$g_defender_reinforcement_limit", "$g_reinforcement_waves"),
      (assign, "$g_attacker_reinforcement_limit", "$g_reinforcement_waves"),
      (assign, "$dmod_current_agent", -1),
      (assign, "$dmod_move_camera", -1),
      (call_script, "script_combat_music_set_situation_with_culture", 262144),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture", 262144),
    ]),

    (0, 0, ti_once, 
    [
      (assign, "$defender_team", 0),
      (assign, "$attacker_team", 1),
      (assign, "$defender_team_2", 2),
      (assign, "$attacker_team_2", 3),
    ],
    []),

    (0, 0, ti_once, 
    [
      (set_show_messages, 0),
      (entry_point_get_position, pos10, 10),
      (try_for_range, ":var0", 0, 9),
        (neq, ":var0", 1),
        (team_give_order, "$defender_team", ":var0", 0),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 0),
        (team_give_order, "$defender_team_2", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 7),
        (team_give_order, "$defender_team_2", ":var0", 7),
      (try_end),
      (team_give_order, "$defender_team", 1, 11),
      (team_set_order_position, "$defender_team", 9, pos10),
      (team_give_order, "$defender_team_2", 1, 11),
      (team_set_order_position, "$defender_team_2", 9, pos10),
      (team_give_order, "$attacker_team", 9, 2),
      (team_give_order, "$attacker_team_2", 9, 2),
      (set_show_messages, 1),
    ],
    []),

    (0, 2, ti_once, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 5, 1),
      (try_end),
    ]),

    (3, 0, 0, 
    [],
    [
      (store_mission_timer_a, ":var0"),
      (ge, ":var0", 5),
      (try_begin),
        (store_mul, ":var1", "$attacker_reinforcement_stage", 2),
        (this_or_next|lt, "$defender_reinforcement_stage", "$g_defender_reinforcement_limit"),
        (le, "$defender_reinforcement_stage", ":var1"),
        (store_normalized_team_count, ":var2", 0),
        (lt, ":var2", 40),
        (add_reinforcements_to_entry, 4, 28),
        (val_add, "$defender_reinforcement_stage", 1),
      (try_end),
    ]),

    (2, 0, 0, 
    [
      (gt, "$defender_reinforcement_stage", 0),
    ],
    [
      (call_script, "script_siege_move_archers_to_archer_positions"),
    ]),

    (3, 0, 0, 
    [
      (assign, ":var0", 1),
      (try_begin),
        (ge, "$attacker_reinforcement_stage", 10),
        (store_mul, ":var1", "$defender_reinforcement_stage", 2),
        (gt, "$attacker_reinforcement_stage", ":var1"),
        (assign, ":var0", 0),
      (try_end),
      (eq, ":var0", 1),
      (store_mission_timer_a, ":var2"),
      (ge, ":var2", 5),
      (store_normalized_team_count, ":var3", 1),
      (lt, ":var3", 30),
    ],
    [
      (add_reinforcements_to_entry, 1, 32),
      (val_add, "$attacker_reinforcement_stage", 1),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (5, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 5),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (try_begin),
        (eq, "$auxilary_player_active", 0),
        (call_script, "script_freelancer_keep_field_loot"),
      (try_end),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (assign, "$do_once_3", 0),
      (finish_mission, 1),
    ]),

    (5, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (120, 0, 0, 
    [],
    [
      (display_message, "@Refilling defender ammo..."),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (this_or_next|eq, ":var1", "$defender_team"),
        (eq, ":var1", "$defender_team_2"),
        (agent_refill_ammo, ":var0"),
      (try_end),
    ]),

    (1, 4, ti_once, 
    [
      (eq, "$enable_deahtcam", 1),
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "@You have been knocked out by the enemy. Watch your men continue the fight without you or press Tab to retreat."),
      (display_message, "@If you choose to watch the fight you can use the mouse scroll up and down to switch between troop view or AWDS keys for free camera view."),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (is_presentation_active, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_now"),
    ],
    []),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (val_add, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
      (set_mission_result, -1),
      (display_message, "@Battle lost..."),
      (assign, "$g_battle_won", -1),
      (assign, "$g_battle_result", -1),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (assign, "$do_once_3", 0),
      (finish_mission, 0),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", -1),
      (display_message, "@Battle lost! Press tab key to leave..."),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (gt, "$dmod_current_agent", 0),
      (eq, "$setting_use_dmod", 1),
      (eq, "$dmod_move_camera", 1),
      (agent_get_position, pos1, "$dmod_current_agent"),
      (position_move_z, pos1, 300),
      (position_move_y, pos1, -300),
      (agent_get_horse, ":var0", "$dmod_current_agent"),
      (try_begin),
        (ge, ":var0", 0),
      (try_end),
      (mission_cam_set_position, pos1),
      (mission_cam_set_mode, 1),
      (set_fixed_point_multiplier, 100),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_up),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_forwards"),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_down),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_backwards"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 4, ti_once, 
    [
      (eq, "$enable_deahtcam", 1),
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
      (assign, "$tom_sand_storm", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (this_or_next|eq, "$dmod_move_camera", 1),
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, gk_move_forward),
      (this_or_next|game_key_is_down, gk_move_backward),
      (this_or_next|game_key_is_down, gk_move_left),
      (this_or_next|game_key_is_down, gk_move_right),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_backward),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_left),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (position_rotate_x_floating, pos47, ":var7"),
        (position_rotate_y, pos47, 90),
        (position_rotate_x_floating, pos47, ":var3"),
        (position_rotate_y, pos47, -90),
        (position_rotate_x_floating, pos47, "$deathcam_total_rotx"),
        (position_rotate_x_floating, pos47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|eq, ":var0", 0),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "str_enhanced_battle_knocked_out_message_1"),
      (display_message, "str_enhanced_battle_knocked_out_message_2"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var3", ":var0"),
        (str_store_troop_name, s6, ":var3"),
        (assign, reg0, ":var0"),
        (assign, reg1, ":var1"),
        (assign, reg2, ":var2"),
        (agent_get_team, reg3, ":var0"),
        (party_add_members, "p_total_enemy_casualties", ":var3", 1),
        (eq, ":var2", 1),
        (party_wound_members, "p_total_enemy_casualties", ":var3", 1),
      (try_end),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (assign, "$tom_sand_storm", 0),
      (call_script, "script_change_rain_or_snow"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$tom_sand_storm", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (position_set_z_to_ground_level, pos0),
      (position_get_z, ":var1", pos0),
      (val_add, ":var1", 400),
      (position_set_z, pos0, ":var1"),
      (particle_system_burst, "psys_desert_storm", pos0, 2),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 2, ti_once, 
    [
      (eq, "$tom_use_banners", 1),
    ],
    [
      (call_script, "script_set_flag_carriers"),
    ]),

    (10, 0, 0, 
    [
      (eq, "$tom_use_banners", 1),
      (eq, "$tom_bonus_banners", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_range, ":var1"),
        (agent_slot_eq, ":var1", 40, 1),
        (agent_is_alive, ":var1"),
        (agent_is_active, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (agent_get_position, pos1, ":var1"),
        (try_for_range, ":var3"),
          (neq, ":var3", ":var1"),
          (agent_get_team, ":var4", ":var3"),
          (eq, ":var2", ":var4"),
          (agent_is_alive, ":var3"),
          (agent_is_active, ":var3"),
          (agent_is_human, ":var3"),
          (agent_get_position, pos2, ":var3"),
          (get_distance_between_positions_in_meters, ":var5", pos1, pos2),
          (le, ":var5", 10),
          (store_agent_hit_points, ":var6", ":var3"),
          (val_add, ":var6", 2),
          (val_min, ":var6", 101),
          (agent_set_hit_points, ":var3", ":var6"),
          (try_begin),
            (eq, ":var3", ":var0"),
            (display_message, "@You feel secured standing near the banner, healing some of your HP.", 0x6495ED),
          (try_end),
        (try_end),
      (try_end),
      (assign, ":var1", ":var0"),
      (agent_is_alive, ":var1"),
      (agent_get_wielded_item, ":var7", ":var1", 0),
      (is_between, ":var7", 1291, 1295),
      (agent_get_team, ":var2", ":var1"),
      (agent_get_position, pos1, ":var1"),
      (try_for_range, ":var3"),
        (neq, ":var3", ":var1"),
        (agent_get_team, ":var4", ":var3"),
        (eq, ":var2", ":var4"),
        (agent_is_alive, ":var3"),
        (agent_is_active, ":var3"),
        (agent_is_human, ":var3"),
        (agent_get_position, pos2, ":var3"),
        (get_distance_between_positions_in_meters, ":var5", pos1, pos2),
        (le, ":var5", 10),
        (store_agent_hit_points, ":var6", ":var3"),
        (try_begin),
          (eq, ":var7", 1294),
          (val_add, ":var6", 1),
        (try_end),
        (val_add, ":var6", 5),
        (val_max, ":var6", 101),
        (agent_set_hit_points, ":var3", ":var6"),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$tom_sand_storm", 3),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (position_set_z_to_ground_level, pos0),
      (position_get_z, ":var1", pos0),
      (val_add, ":var1", 2100),
      (position_set_z, pos0, ":var1"),
      (particle_system_burst, "psys_rain", pos0, 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 0, 
    [
      (eq, "$tom_sand_storm", 2),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_position, pos0, ":var0"),
      (position_set_z_to_ground_level, pos0),
      (position_get_z, ":var1", pos0),
      (val_add, ":var1", 2000),
      (position_set_z, pos0, ":var1"),
      (particle_system_burst, "psys_blizzard", pos0, 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (8, 0, 0, 
    [
      (eq, "$tom_sand_storm", 3),
    ],
    [
      (store_random_in_range, ":var0", 0, 100),
      (try_begin),
        (ge, ":var0", 90),
        (play_sound, "snd_thunder"),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [
      (eq, "$tom_sand_storm", 2),
    ],
    [
      (play_sound, "snd_wind"),
    ]),

    (0, 0, ti_once, 
    [
      (eq, "$tom_sand_storm", 1),
    ],
    [
      (play_sound, "snd_wind"),
    ]),

    (0, 1.5, 0, 
    [
      (key_clicked, key_t),
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_set_animation, ":var0", "anim_cheer", 1),
      (agent_play_sound, ":var0", "snd_man_victory"),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (agent_get_position, pos1, ":var0"),
      (try_for_agents, ":var2"),
        (agent_is_alive, ":var2"),
        (agent_is_human, ":var2"),
        (agent_get_team, ":var3", ":var2"),
        (eq, ":var3", ":var1"),
        (agent_get_position, pos0, ":var2"),
        (get_distance_between_positions_in_meters, ":var4", pos0, pos1),
        (lt, ":var4", 20),
        (agent_set_animation, ":var2", "anim_cheer", 1),
        (agent_play_sound, ":var2", "snd_man_victory"),
        (agent_get_slot, ":var5", ":var2", 16),
        (val_add, ":var5", 5),
        (val_min, ":var5", 9600),
        (agent_set_slot, ":var2", 16, ":var5"),
      (try_end),
      (display_message, "@Huzzah! You encourage your nearby troops."),
    ]),

    (0, 1.7, 0, 
    [
      (eq, "$tom_yell_smelly_peasents", 1),
    ],
    [
      (call_script, "script_tom_command_cheer"),
      (assign, "$tom_yell_smelly_peasents", 0),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (neg|agent_is_ally, ":var0"),
      (agent_is_human, ":var0"),
      (eq, ":var1", "$fplayer_agent_no"),
      (val_add, "$killcount", 1),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_clear_troop_array", "trp_lances_troop_in_combat", 0, "$lance_troop_serving"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_is_human, ":var0"),
      (get_player_agent_no, ":var1"),
      (neq, ":var0", ":var1"),
      (agent_get_party_id, ":var2", ":var0"),
      (eq, ":var2", "p_main_party"),
      (agent_get_troop_id, ":var3", ":var0"),
      (call_script, "script_search_for_troop", ":var3"),
      (agent_set_slot, ":var0", 102, reg0),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("castle_attack_walls_defenders_sally_player", mtf_battle_mode, -1,
  "Your soldiers sally out and attempt to delay the besiegers...",
  [
    (3, mtef_team_0|mtef_attackers, af_override_horse, aif_start_alarmed, 48, []),
    (3, mtef_team_0|mtef_attackers, af_override_horse, aif_start_alarmed, 0, []),
    (0, mtef_team_1|mtef_defenders, af_override_horse, aif_start_alarmed, 48, []),
    (0, mtef_team_1|mtef_defenders, af_override_horse, aif_start_alarmed, 0, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_agent_reassign_team", ":var0"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (team_set_relation, 0, 2, 1),
      (team_set_relation, 1, 3, 1),
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_remove_siege_objects"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_battle_won", 1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$pin_player_fallen", 1),
        (call_script, "script_simulate_retreat", 0, 0, 0),
        (assign, "$g_battle_result", -1),
        (set_mission_result, -1),
        (call_script, "script_count_mission_casualties_from_agents"),
        (finish_mission, 0),
      (else_try),
        (eq, "$deathcam_on", 1),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (call_script, "script_cf_check_enemies_nearby"),
        (question_box, "str_do_you_want_to_retreat"),
      (else_try),
        (display_message, "str_can_not_retreat"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var3", ":var0"),
        (party_add_members, "p_total_enemy_casualties", ":var3", 1),
        (eq, ":var2", 1),
        (party_wound_members, "p_total_enemy_casualties", ":var3", 1),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (assign, "$pin_player_fallen", 0),
      (str_store_string, s5, "str_retreat"),
      (call_script, "script_simulate_retreat", 5, 20, 0),
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 0),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$g_battle_won", 0),
      (call_script, "script_combat_music_set_situation_with_culture", 1024),
      (assign, "$dmod_current_agent", -1),
      (assign, "$dmod_move_camera", -1),
    ]),

    (30, 0, 0, 
    [],
    [
      (call_script, "script_combat_music_set_situation_with_culture", 1024),
    ]),

    (2, 0, 0, 
    [],
    [
      (call_script, "script_check_friendly_kills"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (all_enemies_defeated, 2),
      (set_mission_result, 1),
      (display_message, "str_msg_battle_won"),
      (assign, "$g_battle_won", 1),
      (assign, "$g_battle_result", 1),
      (assign, "$g_siege_sallied_out_once", 1),
      (assign, "$g_siege_method", 1),
      (call_script, "script_play_victorious_sound"),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (finish_mission, 1),
    ]),

    (5, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", 1),
      (display_message, "str_msg_battle_won"),
    ]),

    (1, 60, ti_once, 
    [
      (store_mission_timer_a, reg1),
      (ge, reg1, 10),
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (val_add, ":var0", 1),
      (try_end),
      (eq, ":var0", 0),
      (set_mission_result, -1),
      (display_message, "@Battle lost..."),
      (assign, "$g_battle_won", -1),
      (assign, "$g_battle_result", -1),
    ],
    [
      (call_script, "script_count_mission_casualties_from_agents"),
      (assign, "$do_once_3", 0),
      (finish_mission, 0),
    ]),

    (10, 0, 0, 
    [],
    [
      (eq, "$g_battle_won", -1),
      (display_message, "@Battle lost! Press tab key to leave..."),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (gt, "$dmod_current_agent", 0),
      (eq, "$setting_use_dmod", 1),
      (eq, "$dmod_move_camera", 1),
      (agent_get_position, pos1, "$dmod_current_agent"),
      (position_move_z, pos1, 300),
      (position_move_y, pos1, -300),
      (agent_get_horse, ":var0", "$dmod_current_agent"),
      (try_begin),
        (ge, ":var0", 0),
      (try_end),
      (mission_cam_set_position, pos1),
      (mission_cam_set_mode, 1),
      (set_fixed_point_multiplier, 100),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_up),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_forwards"),
    ],
    []),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$setting_use_dmod", 1),
      (key_clicked, key_mouse_scroll_down),
      (main_hero_fallen),
      (call_script, "script_dmod_cycle_backwards"),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (assign, "$deathcam_on", 0),
      (assign, "$deathcam_death_pos_x", 0),
      (assign, "$deathcam_death_pos_y", 0),
      (assign, "$deathcam_death_pos_z", 0),
      (assign, "$deathcam_mouse_last_x", 5000),
      (assign, "$deathcam_mouse_last_y", 3750),
      (assign, "$deathcam_mouse_last_notmoved_x", 5000),
      (assign, "$deathcam_mouse_last_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_x", 5000),
      (assign, "$deathcam_mouse_notmoved_y", 3750),
      (assign, "$deathcam_mouse_notmoved_counter", 0),
      (assign, "$deathcam_total_rotx", 0),
      (assign, "$deathcam_sensitivity_x", 400),
      (assign, "$deathcam_sensitivity_y", 300),
      (assign, "$deathcam_prsnt_was_active", 0),
      (assign, "$deathcam_keyboard_rotation_x", 0),
      (assign, "$deathcam_keyboard_rotation_y", 0),
      (assign, "$deathcam_flip_y_multiplier", 1),
      (get_player_agent_no, ":var0"),
      (agent_get_team, "$deathcam_player_team", ":var0"),
    ]),

    (0, 4, ti_once, 
    [
      (eq, "$enable_deahtcam", 1),
      (main_hero_fallen),
      (eq, "$deathcam_on", 0),
      (assign, "$tom_sand_storm", 0),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (assign, "$deathcam_on", 1),
      (display_message, "@You were defeated.", 0xFF0000),
      (display_message, "@Rotate with the mouse. Move with standard keys."),
      (display_message, "@Shift/Control for Up/Down. Space Bar to increase speed."),
      (display_message, "@Numpad Plus/Minus to change sensitivity. Numpad to rotate."),
      (display_message, "@Home to reset position. End to flip Y rotation"),
      (mission_cam_get_position, pos1),
      (position_get_x, reg3, pos1),
      (position_get_y, reg4, pos1),
      (position_get_z, reg5, pos1),
      (assign, "$deathcam_death_pos_x", reg3),
      (assign, "$deathcam_death_pos_y", reg4),
      (assign, "$deathcam_death_pos_z", reg5),
      (position_get_rotation_around_z, ":var0", pos1),
      (init_position, pos47),
      (position_copy_origin, pos47, pos1),
      (position_rotate_z, pos47, ":var0"),
      (mission_cam_set_mode, 1, 0, 0),
      (mission_cam_set_position, pos47),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (this_or_next|eq, "$dmod_move_camera", 1),
      (eq, "$deathcam_on", 1),
      (this_or_next|game_key_is_down, gk_move_forward),
      (this_or_next|game_key_is_down, gk_move_backward),
      (this_or_next|game_key_is_down, gk_move_left),
      (this_or_next|game_key_is_down, gk_move_right),
      (this_or_next|key_is_down, key_left_shift),
      (this_or_next|key_is_down, key_left_control),
      (this_or_next|key_is_down, key_numpad_minus),
      (this_or_next|key_is_down, key_numpad_plus),
      (this_or_next|key_clicked, key_home),
      (key_clicked, key_end),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (mission_cam_get_position, pos47),
      (try_begin),
        (key_clicked, key_home),
        (position_set_x, pos47, "$deathcam_death_pos_x"),
        (position_set_y, pos47, "$deathcam_death_pos_y"),
        (position_set_z, pos47, "$deathcam_death_pos_z"),
      (try_end),
      (assign, ":var0", 0),
      (assign, ":var1", 0),
      (assign, ":var2", 0),
      (try_begin),
        (game_key_is_down, gk_move_forward),
        (val_add, ":var1", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_backward),
        (val_add, ":var1", -10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_right),
        (val_add, ":var0", 10),
      (try_end),
      (try_begin),
        (game_key_is_down, gk_move_left),
        (val_add, ":var0", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_shift),
        (val_add, ":var2", 10),
      (try_end),
      (try_begin),
        (key_is_down, key_left_control),
        (val_add, ":var2", -10),
      (try_end),
      (try_begin),
        (key_is_down, key_space),
        (val_mul, ":var0", 4),
        (val_mul, ":var1", 4),
        (val_mul, ":var2", 2),
      (try_end),
      (try_begin),
        (key_is_down, key_end),
        (try_begin),
          (eq, "$deathcam_flip_y_multiplier", 1),
          (assign, "$deathcam_flip_y_multiplier", -1),
          (display_message, "@Y-Rotation Inverted"),
        (else_try),
          (assign, "$deathcam_flip_y_multiplier", 1),
          (display_message, "@Y-Rotation Normal"),
        (try_end),
      (try_end),
      (position_move_x, 47, ":var0"),
      (position_move_y, pos47, ":var1"),
      (position_move_z, pos47, ":var2"),
      (mission_cam_set_position, pos47),
      (try_begin),
        (key_is_down, key_numpad_minus),
        (ge, "$deathcam_sensitivity_x", 4),
        (ge, "$deathcam_sensitivity_y", 3),
        (val_sub, "$deathcam_sensitivity_x", 4),
        (val_sub, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity - 25% ({reg8}, {reg9})"),
        (try_end),
      (else_try),
        (key_is_down, key_numpad_plus),
        (val_add, "$deathcam_sensitivity_x", 4),
        (val_add, "$deathcam_sensitivity_y", 3),
        (store_mod, reg6, "$deathcam_sensitivity_x", 100),
        (store_mod, reg7, "$deathcam_sensitivity_y", 75),
        (try_begin),
          (eq, reg6, 0),
          (eq, reg7, 0),
          (assign, reg8, "$deathcam_sensitivity_x"),
          (assign, reg9, "$deathcam_sensitivity_y"),
          (display_message, "@Sensitivity + 25% ({reg8}, {reg9})"),
        (try_end),
      (try_end),
    ]),

    (0, 0, 0, 
    [
      (eq, "$enable_deahtcam", 1),
      (eq, "$deathcam_on", 1),
    ],
    [
      (set_fixed_point_multiplier, 10000),
      (try_begin),
        (this_or_next|is_presentation_active, "prsnt_battle"),
        (this_or_next|key_clicked, key_escape),
        (this_or_next|key_clicked, key_q),
        (key_clicked, key_tab),
        (eq, "$deathcam_prsnt_was_active", 0),
        (assign, "$deathcam_prsnt_was_active", 1),
        (assign, "$deathcam_mouse_last_notmoved_x", "$deathcam_mouse_notmoved_x"),
        (assign, "$deathcam_mouse_last_notmoved_y", "$deathcam_mouse_notmoved_y"),
      (try_end),
      (assign, ":var0", 0),
      (try_begin),
        (neg|is_presentation_active, "prsnt_battle"),
        (mouse_get_position, pos1),
        (position_get_x, reg1, pos1),
        (position_get_y, reg2, pos1),
        (mission_cam_get_position, pos47),
        (try_begin),
          (neq, "$deathcam_prsnt_was_active", 1),
          (try_begin),
            (eq, reg1, "$deathcam_mouse_last_x"),
            (eq, reg2, "$deathcam_mouse_last_y"),
            (this_or_next|neq, reg1, "$deathcam_mouse_notmoved_x"),
            (neq, reg2, "$deathcam_mouse_notmoved_y"),
            (val_add, "$deathcam_mouse_notmoved_counter", 1),
            (try_begin),
              (ge, "$deathcam_mouse_notmoved_counter", 15),
              (assign, "$deathcam_mouse_notmoved_counter", 0),
              (assign, "$deathcam_mouse_notmoved_x", reg1),
              (assign, "$deathcam_mouse_notmoved_y", reg2),
            (try_end),
          (else_try),
            (assign, ":var0", 1),
            (assign, "$deathcam_mouse_notmoved_counter", 0),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (else_try),
          (try_begin),
            (neq, reg1, "$deathcam_mouse_last_x"),
            (neq, reg2, "$deathcam_mouse_last_y"),
            (store_sub, ":var1", reg1, "$deathcam_mouse_last_notmoved_x"),
            (store_sub, ":var2", reg2, "$deathcam_mouse_last_notmoved_y"),
            (is_between, ":var1", -10, 11),
            (is_between, ":var2", -10, 11),
            (assign, "$deathcam_prsnt_was_active", 0),
            (assign, "$deathcam_mouse_notmoved_x", "$deathcam_mouse_last_notmoved_x"),
            (assign, "$deathcam_mouse_notmoved_y", "$deathcam_mouse_last_notmoved_y"),
          (else_try),
            (assign, "$deathcam_mouse_notmoved_x", reg1),
            (assign, "$deathcam_mouse_notmoved_y", reg2),
          (try_end),
          (assign, "$deathcam_mouse_last_x", reg1),
          (assign, "$deathcam_mouse_last_y", reg2),
        (try_end),
      (try_end),
      (assign, ":var3", 0),
      (assign, ":var4", 0),
      (assign, ":var5", 0),
      (assign, ":var6", 0),
      (try_begin),
        (key_is_down, key_numpad_4),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", -20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", -1),
        (assign, ":var0", 2),
        (assign, ":var5", -1),
      (else_try),
        (key_is_down, key_numpad_6),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_x", 0),
          (assign, "$deathcam_keyboard_rotation_x", 20),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_x", 1),
        (assign, ":var0", 2),
        (assign, ":var5", 1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_x", 0),
        (assign, ":var5", 0),
      (try_end),
      (try_begin),
        (key_is_down, key_numpad_8),
        (try_begin),
          (le, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", 15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", 1),
        (assign, ":var0", 2),
        (assign, ":var6", 1),
      (else_try),
        (this_or_next|key_is_down, key_numpad_2),
        (key_is_down, key_numpad_5),
        (try_begin),
          (ge, "$deathcam_keyboard_rotation_y", 0),
          (assign, "$deathcam_keyboard_rotation_y", -15),
        (try_end),
        (val_add, "$deathcam_keyboard_rotation_y", -1),
        (assign, ":var0", 2),
        (assign, ":var6", -1),
      (else_try),
        (assign, "$deathcam_keyboard_rotation_y", 0),
        (assign, ":var6", 0),
      (try_end),
      (try_begin),
        (eq, ":var0", 1),
        (store_sub, ":var3", reg1, "$deathcam_mouse_notmoved_x"),
        (store_sub, ":var4", reg2, "$deathcam_mouse_notmoved_y"),
      (else_try),
        (eq, ":var0", 2),
        (try_begin),
          (neq, ":var5", 0),
          (val_clamp, "$deathcam_keyboard_rotation_x", -80, 80),
          (assign, ":var3", "$deathcam_keyboard_rotation_x"),
        (try_end),
        (try_begin),
          (neq, ":var6", 0),
          (val_clamp, "$deathcam_keyboard_rotation_y", -45, 45),
          (assign, ":var4", "$deathcam_keyboard_rotation_y"),
        (try_end),
      (try_end),
      (try_begin),
        (ge, ":var0", 1),
        (val_mul, ":var3", "$deathcam_sensitivity_x"),
        (val_mul, ":var4", "$deathcam_sensitivity_y"),
        (val_mul, ":var4", "$deathcam_flip_y_multiplier"),
        (val_clamp, ":var3", -80000, 80001),
        (val_clamp, ":var4", -60000, 60001),
        (store_mul, ":var7", "$deathcam_total_rotx", -1),
        (position_rotate_x_floating, pos47, ":var7"),
        (position_rotate_y, pos47, 90),
        (position_rotate_x_floating, pos47, ":var3"),
        (position_rotate_y, pos47, -90),
        (position_rotate_x_floating, pos47, "$deathcam_total_rotx"),
        (position_rotate_x_floating, pos47, ":var4"),
        (val_add, "$deathcam_total_rotx", ":var4"),
        (mission_cam_set_position, pos47),
      (try_end),
    ]),

    (1, 4, ti_once, 
    [
      (main_hero_fallen),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (neq, ":var0", 1),
        (agent_is_ally, ":var1"),
        (agent_is_alive, ":var1"),
        (assign, ":var0", 1),
      (try_end),
      (this_or_next|eq, ":var0", 0),
      (eq, "$freelancer_state", 1),
    ],
    [
      (assign, "$pin_player_fallen", 1),
      (display_message, "str_enhanced_battle_knocked_out_message_1"),
      (display_message, "str_enhanced_battle_knocked_out_message_2"),
    ]),

    (0, 0, 0, 
    [],
    [
      (game_key_clicked, gk_view_orders),
      (neg|is_presentation_active, "prsnt_battle"),
      (start_presentation, "prsnt_battle"),
    ]),

    (0.1, 0, 0, 
    [],
    [
      (is_presentation_active, "prsnt_battle"),
      (call_script, "script_update_order_panel_statistics_and_map"),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [],
    [
      (display_message, "str_use_baggage_for_inventory"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (set_show_messages, 0),
      (team_give_order, ":var1", 9, 0),
      (set_show_messages, 1),
    ]),

    (0, 0, ti_once, 
    [
      (eq, 0, 1),
      (eq, "$enable_deahtcam", 1),
      (main_hero_fallen),
    ],
    [
      (assign, "$fclock", 1),
      (call_script, "script_player_order_formations", 2),
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (team_give_order, ":var1", 9, 2),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

    (2, 0, 0, 
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_non_player, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (store_skill_level, ":var2", "skl_horse_archery", ":var1"),
        (ge, ":var2", 4),
      (try_end),
    ],
    [
      (set_fixed_point_multiplier, 1000),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_non_player, ":var0"),
        (neg|agent_slot_eq, ":var0", 1003, 1),
        (agent_get_horse, ":var1", ":var0"),
        (assign, ":var2", -1),
        (try_begin),
          (agent_slot_eq, ":var0", 15, 0),
          (gt, ":var1", -1),
          (agent_get_team, ":var3", ":var0"),
          (agent_get_division, ":var4", ":var0"),
          (team_get_weapon_usage_order, ":var5", ":var3", ":var4"),
          (team_get_movement_order, ":var6", ":var3", ":var4"),
          (team_get_hold_fire_order, ":var7", ":var3", ":var4"),
          (assign, ":var8", 0),
          (assign, ":var9", -1),
          (try_for_range, ":var10", 0, 4),
            (agent_get_item_slot, ":var11", ":var0", ":var10"),
            (gt, ":var11", 0),
            (item_get_type, ":var12", ":var11"),
            (try_begin),
              (eq, ":var12", 10),
              (agent_get_ammo_for_slot, ":var13", ":var0", ":var10"),
              (val_add, ":var8", ":var13"),
            (else_try),
              (this_or_next|eq, ":var12", 8),
              (this_or_next|eq, ":var12", 16),
              (eq, ":var12", 17),
              (assign, ":var9", ":var11"),
            (else_try),
              (this_or_next|eq, ":var12", 2),
              (this_or_next|eq, ":var12", 3),
              (eq, ":var12", 4),
              (assign, ":var2", ":var11"),
            (try_end),
          (try_end),
          (gt, ":var9", -1),
          (neg|item_has_property, ":var9", itp_cant_reload_on_horseback),
          (neg|item_has_property, ":var9", itp_cant_use_on_horseback),
          (agent_get_ammo, ":var14", ":var0", 0),
          (val_sub, ":var14", ":var8"),
          (gt, ":var14", 0),
          (agent_set_slot, ":var0", 1003, 2),
          (neq, ":var7", 1),
          (neq, ":var5", 2),
          (eq, ":var6", 2),
          (agent_get_position, pos50, ":var0"),
          (agent_get_speed, pos31, ":var0"),
          (position_get_y, ":var15", pos31),
          (assign, ":var16", 100000),
          (assign, ":var17", -1),
          (try_for_agents, ":var18"),
            (agent_is_alive, ":var18"),
            (agent_is_human, ":var18"),
            (agent_get_position, pos36, ":var18"),
            (agent_get_team, ":var19", ":var18"),
            (teams_are_enemies, ":var3", ":var19"),
            (get_distance_between_positions, ":var20", pos50, pos36),
            (try_begin),
              (agent_slot_eq, ":var18", 15, 1),
              (val_add, ":var20", 10000),
            (try_end),
            (try_begin),
              (agent_get_horse, ":var21", ":var18"),
              (gt, ":var21", -1),
              (agent_get_speed, pos32, ":var18"),
              (position_get_y, ":var22", pos32),
              (val_sub, ":var22", ":var15"),
              (store_div, ":var23", ":var22", 5),
              (val_max, ":var23", 0),
              (val_add, ":var23", 500),
              (val_sub, ":var20", ":var23"),
            (else_try),
              (agent_get_wielded_item, ":var24", ":var18", 1),
              (le, ":var24", 1),
              (val_sub, ":var20", 500),
            (try_end),
            (lt, ":var20", ":var16"),
            (assign, ":var16", ":var20"),
            (assign, ":var17", ":var18"),
          (try_end),
          (neq, ":var17", -1),
          (agent_get_position, pos51, ":var17"),
          (get_distance_between_positions, ":var25", pos50, pos51),
          (try_begin),
            (agent_slot_eq, ":var17", 15, 0),
            (gt, ":var25", 200),
            (agent_set_wielded_item, ":var0", ":var9"),
          (else_try),
            (le, ":var25", 200),
            (gt, ":var2", -1),
            (agent_set_wielded_item, ":var0", ":var2"),
          (try_end),
          (assign, ":var26", 1000),
          (try_begin),
            (agent_get_wielded_item, ":var24", ":var0", 0),
            (gt, ":var24", 0),
            (item_get_type, ":var27", ":var24"),
            (this_or_next|eq, ":var27", 8),
            (this_or_next|eq, ":var27", 16),
            (eq, ":var27", 17),
            (agent_get_bone_position, pos53, ":var0", 8, 1),
            (agent_get_bone_position, pos54, ":var17", 9, 1),
            (position_has_line_of_sight_to_position, pos53, pos54),
            (agent_set_look_target_agent, ":var0", ":var17"),
            (try_begin),
              (assign, ":var28", 4000),
              (agent_get_attack_action, ":var29", ":var0"),
              (eq, ":var29", 1),
              (try_begin),
                (gt, ":var16", 700),
                (le, ":var16", ":var28"),
                (store_div, ":var26", ":var15", 2000),
                (val_max, ":var26", 0),
              (try_end),
              (eq, ":var27", 8),
              (try_begin),
                (le, ":var25", ":var28"),
                (agent_set_defend_action, ":var0", -2, 1),
                (agent_set_attack_action, ":var0", 3, 0),
              (else_try),
                (gt, ":var25", ":var28"),
                (agent_set_attack_action, ":var0", -2, 1),
                (agent_set_defend_action, ":var0", 3, 1),
              (try_end),
            (else_try),
              (eq, ":var27", 8),
              (le, ":var25", ":var28"),
              (agent_get_combat_state, ":var30", ":var0"),
              (neq, ":var30", 8),
              (agent_set_attack_action, ":var0", 3, 1),
            (try_end),
          (try_end),
          (agent_set_speed_limit, ":var0", ":var26"),
          (try_begin),
            (agent_slot_eq, ":var17", 15, 0),
            (lt, ":var16", 10000),
            (try_begin),
              (get_scene_boundaries, pos2, pos3),
              (position_transform_position_to_local, pos4, pos2, pos50),
              (position_get_x, ":var31", pos4),
              (position_get_y, ":var32", pos4),
              (position_transform_position_to_local, pos4, pos2, pos3),
              (position_get_x, ":var33", pos4),
              (position_get_y, ":var34", pos4),
              (store_sub, ":var35", ":var33", ":var31"),
              (store_sub, ":var36", ":var34", ":var32"),
              (position_transform_position_to_local, pos4, pos50, pos51),
              (position_get_x, ":var37", pos4),
              (position_get_y, ":var38", pos4),
              (assign, ":var39", 0),
              (try_begin),
                (le, ":var16", 1000),
                (assign, ":var39", -78000),
              (else_try),
                (gt, ":var16", 2000),
                (store_sub, ":var39", ":var16", 0),
                (val_mul, ":var39", 5),
                (val_clamp, ":var39", 35000, 90000),
              (try_end),
              (assign, ":var40", 30000),
              (val_min, ":var40", ":var31"),
              (val_min, ":var40", ":var36"),
              (val_min, ":var40", ":var35"),
              (val_min, ":var40", ":var32"),
              (try_begin),
                (lt, ":var40", 30000),
                (agent_slot_eq, ":var17", 15, 0),
                (store_div, ":var41", ":var33", 20),
                (store_div, ":var42", ":var34", 20),
                (position_copy_origin, pos4, pos2),
                (position_move_x, 4, ":var41", 1),
                (position_move_y, pos4, ":var42", 1),
                (get_distance_between_positions, ":var43", pos4, pos50),
                (position_transform_position_to_local, pos4, pos50, pos4),
                (position_get_x, ":var41", pos4),
                (position_get_y, ":var42", pos4),
                (val_mul, ":var41", 100),
                (val_mul, ":var42", 100),
                (val_mul, ":var37", 100),
                (val_mul, ":var38", 100),
                (store_div, ":var44", ":var41", ":var43"),
                (store_div, ":var45", ":var42", ":var43"),
                (store_div, ":var46", ":var37", ":var25"),
                (store_div, ":var47", ":var38", ":var25"),
                (store_acos, ":var48", ":var44"),
                (store_asin, ":var49", ":var45"),
                (store_acos, ":var50", ":var46"),
                (store_asin, ":var51", ":var47"),
                (try_begin),
                  (lt, ":var49", 0),
                  (val_mul, ":var48", -1),
                  (val_add, ":var48", 360000),
                (try_end),
                (try_begin),
                  (lt, ":var51", 0),
                  (val_mul, ":var50", -1),
                  (val_add, ":var50", 360000),
                (try_end),
                (store_sub, ":var52", ":var48", ":var50"),
                (val_sub, ":var52", 270000),
                (val_sub, ":var52", ":var39"),
                (store_add, ":var39", ":var52", ":var39"),
                (try_begin),
                  (lt, ":var48", ":var50"),
                  (val_add, ":var39", 360000),
                (try_end),
                (val_clamp, ":var39", -210000, 15000),
                (agent_set_attack_action, ":var0", -2, 1),
                (agent_set_defend_action, ":var0", 3, 1),
              (try_end),
              (store_cos, ":var53", ":var39"),
              (store_sin, ":var54", ":var39"),
              (store_mul, ":var55", ":var53", ":var38"),
              (store_mul, ":var56", ":var54", ":var37"),
              (store_mul, ":var57", ":var54", ":var38"),
              (store_mul, ":var58", ":var53", ":var37"),
              (store_add, ":var59", ":var55", ":var56"),
              (store_sub, ":var60", ":var57", ":var58"),
              (position_move_x, 50, ":var59", 0),
              (position_move_y, pos50, ":var60", 0),
            (try_end),
            (agent_set_scripted_destination, ":var0", pos50, 1),
          (else_try),
            (agent_clear_scripted_mode, ":var0"),
            (agent_force_rethink, ":var0"),
          (try_end),
        (else_try),
          (try_begin),
            (agent_slot_eq, ":var0", 1003, 0),
            (agent_set_slot, ":var0", 1003, 1),
          (else_try),
            (agent_slot_eq, ":var0", 1003, 2),
            (this_or_next|agent_slot_eq, ":var0", 15, 1),
            (this_or_next|lt, ":var1", 0),
            (this_or_next|eq, ":var14", 0),
            (this_or_next|eq, ":var7", 1),
            (this_or_next|eq, ":var5", 2),
            (neq, ":var6", 2),
            (agent_clear_scripted_mode, ":var0"),
            (agent_set_speed_limit, ":var0", 100),
            (agent_force_rethink, ":var0"),
            (agent_set_slot, ":var0", 1003, 3),
            (this_or_next|eq, ":var7", 1),
            (eq, ":var14", 0),
            (gt, ":var2", -1),
            (agent_set_wielded_item, ":var0", ":var2"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [
      (neg|is_presentation_active, "prsnt_killcount"),
      (neg|is_presentation_active, "prsnt_troop_ratio_bar"),
      (neg|is_presentation_active, "prsnt_killcount_and_troop_ratio_bar"),
    ],
    [
      (try_begin),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 1),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 2),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 3),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
      (call_script, "script_party_count_fit_for_battle", "p_main_party"),
      (assign, "$player_count_alive", reg0),
      (call_script, "script_party_count_fit_for_battle", "p_collective_friends"),
      (store_sub, "$ally_count_alive", reg0, "$player_count_alive"),
      (call_script, "script_party_count_fit_for_battle", "p_collective_enemy"),
      (assign, "$enemy_count_alive", reg0),
    ]),

    (3, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 1),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_killcount"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 2),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_troop_ratio_bar"),
      (else_try),
        (eq, "$g_misc_troop_ratio_bar_and_kill_count", 3),
        (neg|is_presentation_active, "prsnt_battle"),
        (neg|is_presentation_active, "prsnt_order_display"),
        (start_presentation, "prsnt_killcount_and_troop_ratio_bar"),
      (try_end),
    ]),

    (0.2, 0, ti_once, 
    [],
    [
      (assign, "$spear_in_position", 0),
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 26, 0),
        (agent_set_slot, ":var0", 27, 0),
        (agent_set_slot, ":var0", 28, 0),
        (agent_set_slot, ":var0", 29, 0),
        (agent_set_slot, ":var0", 30, 0),
      (try_end),
    ]),

    (0.5, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 27),
        (agent_get_slot, ":var2", ":var0", 28),
        (agent_get_slot, ":var3", ":var0", 29),
        (agent_get_position, pos1, ":var0"),
        (position_get_x, ":var4", pos1),
        (position_get_y, ":var5", pos1),
        (position_get_z, ":var6", pos1),
        (position_set_x, pos2, ":var1"),
        (position_set_y, pos2, ":var2"),
        (position_set_z, pos2, ":var3"),
        (position_set_x, pos1, ":var4"),
        (position_set_y, pos1, ":var5"),
        (position_set_z, pos1, ":var6"),
        (agent_get_speed, pos5, ":var0"),
        (call_script, "script_vector_length", 5),
        (assign, ":var7", reg0),
        (agent_set_slot, ":var0", 27, ":var4"),
        (agent_set_slot, ":var0", 28, ":var5"),
        (agent_set_slot, ":var0", 29, ":var6"),
        (agent_set_slot, ":var0", 30, ":var7"),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
      (this_or_next|game_key_clicked, gk_attack),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_move_forward),
      (this_or_next|game_key_clicked, gk_move_backward),
      (this_or_next|game_key_clicked, gk_move_left),
      (this_or_next|game_key_clicked, gk_move_right),
      (this_or_next|game_key_clicked, gk_equip_primary_weapon),
      (this_or_next|game_key_clicked, gk_equip_secondary_weapon),
      (this_or_next|game_key_clicked, gk_action),
      (game_key_clicked, gk_sheath_weapon),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (display_message, "@Releasing spear.", 0x6495ED),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
    ]),

    (0.2, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_get_horse, ":var1", ":var0"),
        (le, ":var1", 0),
        (agent_get_slot, ":var2", ":var0", 26),
        (lt, ":var2", 10),
        (val_add, ":var2", 2),
        (agent_set_slot, ":var0", 26, ":var2"),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_set_animation, ":var0", "anim_spearwall_hold"),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (try_for_agents, ":var2"),
        (agent_is_alive, ":var2"),
        (neq, ":var2", ":var0"),
        (agent_is_human, ":var2"),
        (agent_get_horse, ":var3", ":var2"),
        (le, ":var3", 0),
        (agent_get_slot, ":var4", ":var2", 26),
        (ge, ":var4", 10),
        (agent_get_simple_behavior, ":var5", ":var2"),
        (agent_get_team, ":var6", ":var2"),
        (agent_get_class, ":var7", ":var2"),
        (team_get_movement_order, ":var8", ":var6", ":var7"),
        (assign, ":var9", 0),
        (try_begin),
          (neq, ":var6", ":var1"),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (else_try),
          (this_or_next|eq, ":var8", 0),
          (eq, ":var8", 11),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (this_or_next|eq, ":var5", 4),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (try_end),
        (eq, ":var9", 1),
        (agent_get_troop_id, ":var10", ":var2"),
        (store_proficiency_level, ":var11", ":var10", ca_intelligence),
        (store_character_level, ":var12", ":var10"),
        (ge, ":var12", 12),
        (ge, ":var11", 120),
        (neg|troop_is_mounted, ":var10"),
        (agent_slot_eq, ":var2", 15, 0),
        (assign, ":var9", 0),
        (agent_get_wielded_item, ":var13", ":var2", 0),
        (agent_get_wielded_item, ":var14", ":var2", 1),
        (assign, ":var15", 145),
        (try_begin),
          (this_or_next|is_between, ":var13", "itm_modded_billhook_fork_1", "itm_maul"),
          (is_between, ":var14", "itm_modded_billhook_fork_1", "itm_maul"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_1"),
            (eq, ":var14", "itm_modded_billhook_fork_1"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_2"),
            (eq, ":var14", "itm_modded_billhook_fork_2"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_1"),
            (eq, ":var14", "itm_modded_fauchard_1"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_2"),
            (eq, ":var14", "itm_modded_fauchard_2"),
            (assign, "$spear_dist", 171),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_3"),
            (eq, ":var14", "itm_modded_fauchard_3"),
            (assign, "$spear_dist", 197),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_4"),
            (eq, ":var14", "itm_modded_fauchard_4"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_1"),
            (eq, ":var14", "itm_modded_glaive_1"),
            (assign, "$spear_dist", 169),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_1"),
            (eq, ":var14", "itm_modded_glaive_fork_1"),
            (assign, "$spear_dist", 230),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_2"),
            (eq, ":var14", "itm_modded_glaive_fork_2"),
            (assign, "$spear_dist", 188),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_roundel"),
            (eq, ":var14", "itm_modded_glaive_roundel"),
            (assign, "$spear_dist", 149),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_1"),
            (eq, ":var14", "itm_modded_bill_1"),
            (assign, "$spear_dist", 215),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_2"),
            (eq, ":var14", "itm_modded_bill_2"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_1"),
            (eq, ":var14", "itm_modded_billhook_1"),
            (assign, "$spear_dist", 207),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_2"),
            (eq, ":var14", "itm_modded_billhook_2"),
            (assign, "$spear_dist", 172),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_3"),
            (eq, ":var14", "itm_modded_billhook_3"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_voulge"),
            (eq, ":var14", "itm_modded_voulge"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_spiked_voulge"),
            (eq, ":var14", "itm_modded_spiked_voulge"),
            (assign, "$spear_dist", 182),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_cleaving_voulge"),
            (eq, ":var14", "itm_modded_cleaving_voulge"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_1"),
            (eq, ":var14", "itm_modded_hooked_voulge_1"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_2"),
            (eq, ":var14", "itm_modded_hooked_voulge_2"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_3"),
            (eq, ":var14", "itm_modded_hooked_voulge_3"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_1"),
            (eq, ":var14", "itm_modded_couteau_1"),
            (assign, "$spear_dist", 177),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_2"),
            (eq, ":var14", "itm_modded_couteau_2"),
            (assign, "$spear_dist", 196),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_guisarme"),
            (eq, ":var14", "itm_modded_guisarme"),
            (assign, "$spear_dist", 232),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_assegai"),
            (eq, ":var14", "itm_modded_assegai"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_pike"),
            (eq, ":var14", "itm_modded_pike"),
            (assign, "$spear_dist", 300),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_war_spear"),
            (eq, ":var14", "itm_modded_war_spear"),
            (assign, "$spear_dist", 211),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_glaive"),
          (is_between, ":var14", "itm_glaive"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_glaive"),
            (eq, ":var14", "itm_glaive"),
            (assign, "$spear_dist", 160),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_bill"),
          (is_between, ":var14", "itm_bill"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_bill"),
            (eq, ":var14", "itm_bill"),
            (assign, "$spear_dist", 128),
          (try_end),
        (try_end),
        (eq, ":var9", 1),
        (assign, ":var16", -1),
        (agent_get_position, pos1, ":var2"),
        (try_for_agents, ":var17"),
          (agent_is_alive, ":var17"),
          (neg|agent_is_human, ":var17"),
          (agent_get_rider, ":var18", ":var17"),
          (ge, ":var18", 0),
          (agent_get_team, ":var19", ":var18"),
          (teams_are_enemies, ":var6", ":var19"),
          (agent_get_position, pos2, ":var17"),
          (get_distance_between_positions, ":var20", pos1, pos2),
          (lt, ":var20", ":var15"),
          (neg|position_is_behind_position, pos2, pos1),
          (agent_get_slot, ":var21", ":var17", 30),
          (gt, ":var21", 0),
          (assign, ":var16", ":var17"),
        (try_end),
        (gt, ":var16", -1),
        (agent_play_sound, ":var16", "snd_metal_hit_high_armor_high_damage"),
        (store_agent_hit_points, ":var22", ":var16", 0),
        (store_agent_hit_points, ":var23", ":var16", 1),
        (assign, reg22, ":var21"),
        (val_mul, ":var21", 10),
        (val_sub, ":var22", ":var21"),
        (val_max, ":var22", 0),
        (agent_set_slot, ":var2", 26, 0),
        (agent_get_horse, ":var24", ":var0"),
        (agent_get_position, pos2, ":var16"),
        (agent_set_look_target_position, ":var2", pos2),
        (agent_set_attack_action, ":var2", 0, 0),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_get_troop_id, ":var10", ":var2"),
        (str_store_troop_name, s21, ":var10"),
        (agent_get_troop_id, ":var25", ":var16"),
        (str_store_troop_name, s20, ":var25"),
        (store_agent_hit_points, ":var22", ":var16", 1),
        (val_sub, ":var23", ":var22"),
        (assign, reg1, ":var23"),
        (try_begin),
          (eq, ":var16", ":var24"),
          (display_message, "@Your horse received {reg1} damage from a braced polearm!", 0xFF4040),
        (try_end),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (store_agent_hit_points, ":var1", ":var0", 1),
      (lt, ":var1", "$spear_hp"),
      (display_message, "@The injury causes your grip on the polearm to slip!", 0xFF4040),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 26),
      (ge, ":var1", 10),
      (assign, ":var2", -1),
      (agent_get_position, pos1, ":var0"),
      (try_for_agents, ":var3"),
        (agent_is_alive, ":var3"),
        (neg|agent_is_human, ":var3"),
        (agent_get_rider, ":var4", ":var3"),
        (ge, ":var4", 0),
        (neg|agent_is_ally, ":var4"),
        (agent_get_position, pos2, ":var3"),
        (get_distance_between_positions, ":var5", pos1, pos2),
        (lt, ":var5", "$spear_dist"),
        (neg|position_is_behind_position, pos2, pos1),
        (agent_get_slot, ":var6", ":var3", 30),
        (ge, ":var6", 120),
        (assign, ":var2", ":var3"),
      (try_end),
      (gt, ":var2", -1),
      (agent_play_sound, ":var2", "snd_metal_hit_high_armor_high_damage"),
      (store_agent_hit_points, ":var7", ":var2", 0),
      (store_agent_hit_points, ":var8", ":var2", 1),
      (val_div, ":var6", 2),
      (val_sub, ":var6", 15),
      (val_sub, ":var7", ":var6"),
      (val_max, ":var7", 0),
      (agent_set_hit_points, ":var2", ":var7", 0),
      (agent_deliver_damage_to_agent, ":var2", ":var2"),
      (agent_set_slot, ":var0", 26, 0),
      (store_agent_hit_points, ":var7", ":var2", 1),
      (val_sub, ":var8", ":var7"),
      (assign, reg1, ":var8"),
      (display_message, "@Polearm-wall dealt {reg1} damage!"),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 2, 
    [
      (key_clicked, key_b),
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_is_alive, ":var1"),
      (agent_get_wielded_item, ":var2", ":var1", 0),
      (agent_get_wielded_item, ":var3", ":var1", 1),
      (assign, "$spear_dist", 145),
      (try_begin),
        (this_or_next|is_between, ":var2", "itm_modded_billhook_fork_1", "itm_maul"),
        (is_between, ":var3", "itm_modded_billhook_fork_1", "itm_maul"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_1"),
          (eq, ":var3", "itm_modded_billhook_fork_1"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_2"),
          (eq, ":var3", "itm_modded_billhook_fork_2"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_1"),
          (eq, ":var3", "itm_modded_fauchard_1"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_2"),
          (eq, ":var3", "itm_modded_fauchard_2"),
          (assign, "$spear_dist", 171),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_3"),
          (eq, ":var3", "itm_modded_fauchard_3"),
          (assign, "$spear_dist", 197),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_4"),
          (eq, ":var3", "itm_modded_fauchard_4"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_1"),
          (eq, ":var3", "itm_modded_glaive_1"),
          (assign, "$spear_dist", 169),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_1"),
          (eq, ":var3", "itm_modded_glaive_fork_1"),
          (assign, "$spear_dist", 230),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_2"),
          (eq, ":var3", "itm_modded_glaive_fork_2"),
          (assign, "$spear_dist", 188),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_roundel"),
          (eq, ":var3", "itm_modded_glaive_roundel"),
          (assign, "$spear_dist", 149),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_1"),
          (eq, ":var3", "itm_modded_bill_1"),
          (assign, "$spear_dist", 215),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_2"),
          (eq, ":var3", "itm_modded_bill_2"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_1"),
          (eq, ":var3", "itm_modded_billhook_1"),
          (assign, "$spear_dist", 207),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_2"),
          (eq, ":var3", "itm_modded_billhook_2"),
          (assign, "$spear_dist", 172),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_3"),
          (eq, ":var3", "itm_modded_billhook_3"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_voulge"),
          (eq, ":var3", "itm_modded_voulge"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_spiked_voulge"),
          (eq, ":var3", "itm_modded_spiked_voulge"),
          (assign, "$spear_dist", 182),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_cleaving_voulge"),
          (eq, ":var3", "itm_modded_cleaving_voulge"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_1"),
          (eq, ":var3", "itm_modded_hooked_voulge_1"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_2"),
          (eq, ":var3", "itm_modded_hooked_voulge_2"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_3"),
          (eq, ":var3", "itm_modded_hooked_voulge_3"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_1"),
          (eq, ":var3", "itm_modded_couteau_1"),
          (assign, "$spear_dist", 177),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_2"),
          (eq, ":var3", "itm_modded_couteau_2"),
          (assign, "$spear_dist", 196),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_guisarme"),
          (eq, ":var3", "itm_modded_guisarme"),
          (assign, "$spear_dist", 232),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_assegai"),
          (eq, ":var3", "itm_modded_assegai"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_pike"),
          (eq, ":var3", "itm_modded_pike"),
          (assign, "$spear_dist", 300),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_war_spear"),
          (eq, ":var3", "itm_modded_war_spear"),
          (assign, "$spear_dist", 211),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_glaive"),
        (is_between, ":var3", "itm_glaive"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_glaive"),
          (eq, ":var3", "itm_glaive"),
          (assign, "$spear_dist", 160),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_bill"),
        (is_between, ":var3", "itm_bill"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_bill"),
          (eq, ":var3", "itm_bill"),
          (assign, "$spear_dist", 128),
        (try_end),
      (try_end),
      (eq, ":var0", 1),
      (agent_get_horse, ":var4", ":var1"),
      (le, ":var4", 0),
      (neq, "$spear_in_position", 1),
      (display_message, "@Bracing polearm for charge.", 0x6495ED),
      (agent_set_animation, ":var1", "anim_spearwall_hold"),
      (assign, "$spear_in_position", 1),
      (store_agent_hit_points, "$spear_hp", ":var1", 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, ti_once, 
    [
      (get_player_agent_no, "$fplayer_agent_no"),
      (ge, "$fplayer_agent_no", 0),
    ],
    [
      (agent_get_team, "$fplayer_team_no", "$fplayer_agent_no"),
      (agent_get_horse, ":var0", "$fplayer_agent_no"),
      (agent_set_slot, "$fplayer_agent_no", 41, ":var0"),
    ]),

    (0, 0, 3, 
    [
      (key_clicked, key_h),
    ],
    [
      (agent_get_slot, ":var0", "$fplayer_agent_no", 41),
      (gt, ":var0", 0),
      (agent_is_active, ":var0"),
      (agent_get_horse, reg0, "$fplayer_agent_no"),
      (eq, reg0, -1),
      (agent_play_sound, "$fplayer_agent_no", "snd_man_breath_hard"),
      (display_message, "@You whistle for your horse."),
      (agent_is_alive, ":var0"),
      (agent_get_position, pos1, "$fplayer_agent_no"),
      (agent_set_scripted_destination, ":var0", pos1, 0),
    ]),

    (ti_on_item_unwielded, 0, 0, 
    [],
    [
      (store_trigger_param_2, ":var0"),
      (ge, ":var0", 0),
      (item_get_type, ":var1", ":var0"),
      (this_or_next|eq, ":var1", 8),
      (eq, ":var1", 9),
      (store_trigger_param_1, ":var2"),
      (agent_is_active, ":var2"),
      (agent_is_alive, ":var2"),
      (agent_is_non_player, ":var2"),
      (agent_get_ammo, ":var3", ":var2", 0),
      (le, ":var3", 0),
      (agent_get_horse, ":var4", ":var2"),
      (eq, ":var4", -1),
      (assign, ":var5", 1),
      (try_begin),
        (this_or_next|party_slot_eq, "$g_encountered_party", 0, 3),
        (party_slot_eq, "$g_encountered_party", 0, 2),
        (agent_get_team, ":var6", ":var2"),
        (this_or_next|eq, ":var6", "$defender_team"),
        (eq, ":var6", "$defender_team_2"),
        (assign, ":var5", 0),
      (try_end),
      (eq, ":var5", 1),
      (agent_set_division, ":var2", 4),
      (agent_set_slot, ":var2", 42, 4),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_slot, ":var0", 42, -1),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_active, ":var0"),
        (agent_slot_ge, ":var0", 42, 0),
        (agent_is_alive, ":var0"),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 42, ":var1"),
        (agent_get_slot, ":var2", ":var0", 42),
        (agent_set_division, ":var0", ":var2"),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_set_slot, ":var0", 42, -1),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (try_begin),
        (neg|agent_is_human, ":var0"),
        (agent_get_rider, ":var1", ":var0"),
        (ge, ":var1", 0),
        (agent_is_active, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_is_non_player, ":var1"),
      (else_try),
        (assign, ":var1", -1),
      (try_end),
      (agent_set_slot, ":var0", 41, ":var1"),
    ]),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (neg|agent_is_human, ":var0"),
      (agent_get_slot, ":var1", ":var0", 41),
      (ge, ":var1", 0),
      (agent_is_active, ":var1"),
      (agent_is_alive, ":var1"),
      (try_begin),
        (assign, ":var2", 70),
        (agent_get_troop_id, ":var3", ":var1"),
        (store_skill_level, ":var4", "skl_riding", ":var3"),
        (store_mul, ":var5", ":var4", 5),
        (val_sub, ":var2", ":var5"),
        (call_script, "script_rand", 0, 100),
        (le, reg0, ":var2"),
        (call_script, "script_rand", 60, 80),
        (assign, ":var6", reg0),
        (store_mul, ":var7", ":var4", 7),
        (val_sub, ":var6", ":var7"),
        (agent_deliver_damage_to_agent, ":var0", ":var1", ":var6"),
        (try_begin),
          (neg|agent_is_non_player, ":var1"),
          (display_message, "@You fall down from your horse and sustain some damage!"),
        (try_end),
      (try_end),
      (try_begin),
        (agent_is_active, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_set_division, ":var1", 0),
        (agent_set_slot, ":var1", 42, 0),
      (try_end),
    ]),

    (1, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_active, ":var0"),
        (agent_slot_ge, ":var0", 42, 0),
        (agent_is_alive, ":var0"),
        (agent_get_division, ":var1", ":var0"),
        (neg|agent_slot_eq, ":var0", 42, ":var1"),
        (agent_get_slot, ":var2", ":var0", 42),
        (agent_set_division, ":var0", ":var2"),
      (try_end),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (call_script, "script_lance_use_classify_agent"),
    ]),

    (2, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 43),
        (gt, ":var1", 0),
        (agent_get_wielded_item, ":var2", ":var0", 0),
        (agent_get_horse, ":var3", ":var0"),
        (try_begin),
          (le, ":var3", 0),
          (agent_set_slot, ":var0", 43, 0),
          (eq, ":var2", ":var1"),
          (call_script, "script_lance_use_backup_weapon", ":var0"),
        (else_try),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var4", ":var0"),
          (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":var4", 1),
          (assign, ":var5", reg0),
          (try_begin),
            (lt, ":var5", 500),
            (agent_get_combat_state, ":var6", ":var0"),
            (gt, ":var6", 3),
            (eq, ":var2", ":var1"),
            (call_script, "script_lance_use_backup_weapon", ":var0"),
          (else_try),
            (neq, ":var2", ":var1"),
            (agent_set_wielded_item, ":var0", ":var1"),
          (try_end),
        (try_end),
      (try_end),
    ]),

  ]),

  ("camp", 0, -1,
  "You visit the camp.",
  [
    (0, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, []),
    (1, mtef_visitor_source, af_override_weapons|af_override_horse|af_override_gloves|af_override_head, 0, 1, []),
    (2, mtef_visitor_source, af_override_horse|af_override_head, 0, 1, []),
    (3, mtef_visitor_source, af_override_horse|af_override_head, 0, 1, []),
    (4, mtef_visitor_source, af_override_horse|af_override_head, 0, 1, []),
    (5, mtef_visitor_source, af_override_horse|af_override_head, 0, 1, []),
    (6, mtef_visitor_source, af_override_horse|af_override_head, 0, 1, []),
    (7, mtef_visitor_source, af_override_horse|af_override_head, 0, 1, []),
    (8, mtef_visitor_source, af_override_horse|af_override_head, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse|af_override_head, 0, 1, []),
    (10, mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_visitor_source, af_override_horse, 0, 1, []),
    (14, mtef_visitor_source, af_override_horse, 0, 1, []),
    (15, mtef_visitor_source, af_override_horse, 0, 1, []),
    (16, mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_visitor_source, af_override_horse, 0, 1, []),
    (21, mtef_visitor_source, af_override_horse, 0, 1, []),
    (22, mtef_visitor_source, af_override_horse, 0, 1, []),
    (23, mtef_visitor_source, af_override_horse, 0, 1, []),
    (24, mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_visitor_source, 0, 0, 1, []),
    (34, mtef_visitor_source, 0, 0, 1, []),
    (35, mtef_visitor_source, 0, 0, 1, []),
    (36, mtef_visitor_source, 0, 0, 1, []),
    (37, mtef_visitor_source, 0, 0, 1, []),
    (38, mtef_visitor_source, 0, 0, 1, []),
    (39, mtef_visitor_source, 0, 0, 1, []),
    (40, mtef_visitor_source, af_override_everything, 0, 1, []),
    (41, mtef_visitor_source, af_override_everything, 0, 1, []),
    (42, mtef_visitor_source, af_override_everything, 0, 1, []),
    (43, mtef_visitor_source, af_override_everything, 0, 1, []),
    (44, mtef_visitor_source, af_override_everything, 0, 1, []),
    (45, mtef_visitor_source, af_override_everything, 0, 1, []),
    (46, mtef_visitor_source, af_override_everything, 0, 1, []),
    (47, mtef_visitor_source, af_override_everything, 0, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (play_track, 0, 2),
      (call_script, "script_change_banners_and_chest"),
      (assign, "$g_position_to_use_for_replacing_scene_items", 8),
      (call_script, "script_replace_scene_items_with_spawn_items_before_ms"),
    ]),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (finish_mission, 0),
    ]),

    (1, 0, ti_once, 
    [
      (call_script, "script_replace_scene_items_with_spawn_items_after_ms"),
      (try_for_agents, ":var0"),
        (agent_is_human, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_entry_no, ":var1", ":var0"),
        (assign, reg4, ":var1"),
        (try_begin),
          (is_between, ":var1", 23, 33),
          (agent_set_stand_animation, ":var0", "anim_stand_townguard"),
          (agent_set_animation, ":var0", "anim_stand_townguard"),
          (store_random_in_range, ":var2", 0, 100),
          (agent_set_animation_progress, ":var0", ":var2"),
        (try_end),
      (try_end),
    ],
    []),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (set_trigger_result, 1),
    ],
    []),

    (ti_on_agent_killed_or_wounded, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_3, ":var1"),
      (try_begin),
        (ge, ":var0", 0),
        (neg|agent_is_ally, ":var0"),
        (agent_is_human, ":var0"),
        (agent_get_troop_id, ":var2", ":var0"),
        (agent_get_entry_no, ":var3", ":var0"),
        (try_begin),
          (eq, ":var1", 1),
          (try_begin),
            (neg|is_between, ":var3", 40, 48),
            (party_wound_members, "p_main_party", ":var2", 1),
          (try_end),
        (else_try),
          (try_begin),
            (neg|is_between, ":var3", 40, 48),
            (set_trigger_result, 2),
            (party_wound_members, "p_main_party", ":var2", 1),
          (else_try),
            (party_remove_prisoners, "p_main_party", ":var2", 1),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (0.2, 0, ti_once, 
    [],
    [
      (assign, "$spear_in_position", 0),
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 26, 0),
        (agent_set_slot, ":var0", 27, 0),
        (agent_set_slot, ":var0", 28, 0),
        (agent_set_slot, ":var0", 29, 0),
        (agent_set_slot, ":var0", 30, 0),
      (try_end),
    ]),

    (0.5, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 27),
        (agent_get_slot, ":var2", ":var0", 28),
        (agent_get_slot, ":var3", ":var0", 29),
        (agent_get_position, pos1, ":var0"),
        (position_get_x, ":var4", pos1),
        (position_get_y, ":var5", pos1),
        (position_get_z, ":var6", pos1),
        (position_set_x, pos2, ":var1"),
        (position_set_y, pos2, ":var2"),
        (position_set_z, pos2, ":var3"),
        (position_set_x, pos1, ":var4"),
        (position_set_y, pos1, ":var5"),
        (position_set_z, pos1, ":var6"),
        (agent_get_speed, pos5, ":var0"),
        (call_script, "script_vector_length", 5),
        (assign, ":var7", reg0),
        (agent_set_slot, ":var0", 27, ":var4"),
        (agent_set_slot, ":var0", 28, ":var5"),
        (agent_set_slot, ":var0", 29, ":var6"),
        (agent_set_slot, ":var0", 30, ":var7"),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
      (this_or_next|game_key_clicked, gk_attack),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_move_forward),
      (this_or_next|game_key_clicked, gk_move_backward),
      (this_or_next|game_key_clicked, gk_move_left),
      (this_or_next|game_key_clicked, gk_move_right),
      (this_or_next|game_key_clicked, gk_equip_primary_weapon),
      (this_or_next|game_key_clicked, gk_equip_secondary_weapon),
      (this_or_next|game_key_clicked, gk_action),
      (game_key_clicked, gk_sheath_weapon),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (display_message, "@Releasing spear.", 0x6495ED),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
    ]),

    (0.2, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_get_horse, ":var1", ":var0"),
        (le, ":var1", 0),
        (agent_get_slot, ":var2", ":var0", 26),
        (lt, ":var2", 10),
        (val_add, ":var2", 2),
        (agent_set_slot, ":var0", 26, ":var2"),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_set_animation, ":var0", "anim_spearwall_hold"),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (try_for_agents, ":var2"),
        (agent_is_alive, ":var2"),
        (neq, ":var2", ":var0"),
        (agent_is_human, ":var2"),
        (agent_get_horse, ":var3", ":var2"),
        (le, ":var3", 0),
        (agent_get_slot, ":var4", ":var2", 26),
        (ge, ":var4", 10),
        (agent_get_simple_behavior, ":var5", ":var2"),
        (agent_get_team, ":var6", ":var2"),
        (agent_get_class, ":var7", ":var2"),
        (team_get_movement_order, ":var8", ":var6", ":var7"),
        (assign, ":var9", 0),
        (try_begin),
          (neq, ":var6", ":var1"),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (else_try),
          (this_or_next|eq, ":var8", 0),
          (eq, ":var8", 11),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (this_or_next|eq, ":var5", 4),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (try_end),
        (eq, ":var9", 1),
        (agent_get_troop_id, ":var10", ":var2"),
        (store_proficiency_level, ":var11", ":var10", ca_intelligence),
        (store_character_level, ":var12", ":var10"),
        (ge, ":var12", 12),
        (ge, ":var11", 120),
        (neg|troop_is_mounted, ":var10"),
        (agent_slot_eq, ":var2", 15, 0),
        (assign, ":var9", 0),
        (agent_get_wielded_item, ":var13", ":var2", 0),
        (agent_get_wielded_item, ":var14", ":var2", 1),
        (assign, ":var15", 145),
        (try_begin),
          (this_or_next|is_between, ":var13", "itm_modded_billhook_fork_1", "itm_maul"),
          (is_between, ":var14", "itm_modded_billhook_fork_1", "itm_maul"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_1"),
            (eq, ":var14", "itm_modded_billhook_fork_1"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_2"),
            (eq, ":var14", "itm_modded_billhook_fork_2"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_1"),
            (eq, ":var14", "itm_modded_fauchard_1"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_2"),
            (eq, ":var14", "itm_modded_fauchard_2"),
            (assign, "$spear_dist", 171),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_3"),
            (eq, ":var14", "itm_modded_fauchard_3"),
            (assign, "$spear_dist", 197),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_4"),
            (eq, ":var14", "itm_modded_fauchard_4"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_1"),
            (eq, ":var14", "itm_modded_glaive_1"),
            (assign, "$spear_dist", 169),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_1"),
            (eq, ":var14", "itm_modded_glaive_fork_1"),
            (assign, "$spear_dist", 230),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_2"),
            (eq, ":var14", "itm_modded_glaive_fork_2"),
            (assign, "$spear_dist", 188),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_roundel"),
            (eq, ":var14", "itm_modded_glaive_roundel"),
            (assign, "$spear_dist", 149),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_1"),
            (eq, ":var14", "itm_modded_bill_1"),
            (assign, "$spear_dist", 215),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_2"),
            (eq, ":var14", "itm_modded_bill_2"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_1"),
            (eq, ":var14", "itm_modded_billhook_1"),
            (assign, "$spear_dist", 207),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_2"),
            (eq, ":var14", "itm_modded_billhook_2"),
            (assign, "$spear_dist", 172),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_3"),
            (eq, ":var14", "itm_modded_billhook_3"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_voulge"),
            (eq, ":var14", "itm_modded_voulge"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_spiked_voulge"),
            (eq, ":var14", "itm_modded_spiked_voulge"),
            (assign, "$spear_dist", 182),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_cleaving_voulge"),
            (eq, ":var14", "itm_modded_cleaving_voulge"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_1"),
            (eq, ":var14", "itm_modded_hooked_voulge_1"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_2"),
            (eq, ":var14", "itm_modded_hooked_voulge_2"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_3"),
            (eq, ":var14", "itm_modded_hooked_voulge_3"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_1"),
            (eq, ":var14", "itm_modded_couteau_1"),
            (assign, "$spear_dist", 177),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_2"),
            (eq, ":var14", "itm_modded_couteau_2"),
            (assign, "$spear_dist", 196),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_guisarme"),
            (eq, ":var14", "itm_modded_guisarme"),
            (assign, "$spear_dist", 232),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_assegai"),
            (eq, ":var14", "itm_modded_assegai"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_pike"),
            (eq, ":var14", "itm_modded_pike"),
            (assign, "$spear_dist", 300),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_war_spear"),
            (eq, ":var14", "itm_modded_war_spear"),
            (assign, "$spear_dist", 211),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_glaive"),
          (is_between, ":var14", "itm_glaive"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_glaive"),
            (eq, ":var14", "itm_glaive"),
            (assign, "$spear_dist", 160),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_bill"),
          (is_between, ":var14", "itm_bill"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_bill"),
            (eq, ":var14", "itm_bill"),
            (assign, "$spear_dist", 128),
          (try_end),
        (try_end),
        (eq, ":var9", 1),
        (assign, ":var16", -1),
        (agent_get_position, pos1, ":var2"),
        (try_for_agents, ":var17"),
          (agent_is_alive, ":var17"),
          (neg|agent_is_human, ":var17"),
          (agent_get_rider, ":var18", ":var17"),
          (ge, ":var18", 0),
          (agent_get_team, ":var19", ":var18"),
          (teams_are_enemies, ":var6", ":var19"),
          (agent_get_position, pos2, ":var17"),
          (get_distance_between_positions, ":var20", pos1, pos2),
          (lt, ":var20", ":var15"),
          (neg|position_is_behind_position, pos2, pos1),
          (agent_get_slot, ":var21", ":var17", 30),
          (gt, ":var21", 0),
          (assign, ":var16", ":var17"),
        (try_end),
        (gt, ":var16", -1),
        (agent_play_sound, ":var16", "snd_metal_hit_high_armor_high_damage"),
        (store_agent_hit_points, ":var22", ":var16", 0),
        (store_agent_hit_points, ":var23", ":var16", 1),
        (assign, reg22, ":var21"),
        (val_mul, ":var21", 10),
        (val_sub, ":var22", ":var21"),
        (val_max, ":var22", 0),
        (agent_set_slot, ":var2", 26, 0),
        (agent_get_horse, ":var24", ":var0"),
        (agent_get_position, pos2, ":var16"),
        (agent_set_look_target_position, ":var2", pos2),
        (agent_set_attack_action, ":var2", 0, 0),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_get_troop_id, ":var10", ":var2"),
        (str_store_troop_name, s21, ":var10"),
        (agent_get_troop_id, ":var25", ":var16"),
        (str_store_troop_name, s20, ":var25"),
        (store_agent_hit_points, ":var22", ":var16", 1),
        (val_sub, ":var23", ":var22"),
        (assign, reg1, ":var23"),
        (try_begin),
          (eq, ":var16", ":var24"),
          (display_message, "@Your horse received {reg1} damage from a braced polearm!", 0xFF4040),
        (try_end),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (store_agent_hit_points, ":var1", ":var0", 1),
      (lt, ":var1", "$spear_hp"),
      (display_message, "@The injury causes your grip on the polearm to slip!", 0xFF4040),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 26),
      (ge, ":var1", 10),
      (assign, ":var2", -1),
      (agent_get_position, pos1, ":var0"),
      (try_for_agents, ":var3"),
        (agent_is_alive, ":var3"),
        (neg|agent_is_human, ":var3"),
        (agent_get_rider, ":var4", ":var3"),
        (ge, ":var4", 0),
        (neg|agent_is_ally, ":var4"),
        (agent_get_position, pos2, ":var3"),
        (get_distance_between_positions, ":var5", pos1, pos2),
        (lt, ":var5", "$spear_dist"),
        (neg|position_is_behind_position, pos2, pos1),
        (agent_get_slot, ":var6", ":var3", 30),
        (ge, ":var6", 120),
        (assign, ":var2", ":var3"),
      (try_end),
      (gt, ":var2", -1),
      (agent_play_sound, ":var2", "snd_metal_hit_high_armor_high_damage"),
      (store_agent_hit_points, ":var7", ":var2", 0),
      (store_agent_hit_points, ":var8", ":var2", 1),
      (val_div, ":var6", 2),
      (val_sub, ":var6", 15),
      (val_sub, ":var7", ":var6"),
      (val_max, ":var7", 0),
      (agent_set_hit_points, ":var2", ":var7", 0),
      (agent_deliver_damage_to_agent, ":var2", ":var2"),
      (agent_set_slot, ":var0", 26, 0),
      (store_agent_hit_points, ":var7", ":var2", 1),
      (val_sub, ":var8", ":var7"),
      (assign, reg1, ":var8"),
      (display_message, "@Polearm-wall dealt {reg1} damage!"),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 2, 
    [
      (key_clicked, key_b),
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_is_alive, ":var1"),
      (agent_get_wielded_item, ":var2", ":var1", 0),
      (agent_get_wielded_item, ":var3", ":var1", 1),
      (assign, "$spear_dist", 145),
      (try_begin),
        (this_or_next|is_between, ":var2", "itm_modded_billhook_fork_1", "itm_maul"),
        (is_between, ":var3", "itm_modded_billhook_fork_1", "itm_maul"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_1"),
          (eq, ":var3", "itm_modded_billhook_fork_1"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_2"),
          (eq, ":var3", "itm_modded_billhook_fork_2"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_1"),
          (eq, ":var3", "itm_modded_fauchard_1"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_2"),
          (eq, ":var3", "itm_modded_fauchard_2"),
          (assign, "$spear_dist", 171),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_3"),
          (eq, ":var3", "itm_modded_fauchard_3"),
          (assign, "$spear_dist", 197),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_4"),
          (eq, ":var3", "itm_modded_fauchard_4"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_1"),
          (eq, ":var3", "itm_modded_glaive_1"),
          (assign, "$spear_dist", 169),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_1"),
          (eq, ":var3", "itm_modded_glaive_fork_1"),
          (assign, "$spear_dist", 230),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_2"),
          (eq, ":var3", "itm_modded_glaive_fork_2"),
          (assign, "$spear_dist", 188),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_roundel"),
          (eq, ":var3", "itm_modded_glaive_roundel"),
          (assign, "$spear_dist", 149),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_1"),
          (eq, ":var3", "itm_modded_bill_1"),
          (assign, "$spear_dist", 215),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_2"),
          (eq, ":var3", "itm_modded_bill_2"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_1"),
          (eq, ":var3", "itm_modded_billhook_1"),
          (assign, "$spear_dist", 207),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_2"),
          (eq, ":var3", "itm_modded_billhook_2"),
          (assign, "$spear_dist", 172),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_3"),
          (eq, ":var3", "itm_modded_billhook_3"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_voulge"),
          (eq, ":var3", "itm_modded_voulge"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_spiked_voulge"),
          (eq, ":var3", "itm_modded_spiked_voulge"),
          (assign, "$spear_dist", 182),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_cleaving_voulge"),
          (eq, ":var3", "itm_modded_cleaving_voulge"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_1"),
          (eq, ":var3", "itm_modded_hooked_voulge_1"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_2"),
          (eq, ":var3", "itm_modded_hooked_voulge_2"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_3"),
          (eq, ":var3", "itm_modded_hooked_voulge_3"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_1"),
          (eq, ":var3", "itm_modded_couteau_1"),
          (assign, "$spear_dist", 177),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_2"),
          (eq, ":var3", "itm_modded_couteau_2"),
          (assign, "$spear_dist", 196),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_guisarme"),
          (eq, ":var3", "itm_modded_guisarme"),
          (assign, "$spear_dist", 232),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_assegai"),
          (eq, ":var3", "itm_modded_assegai"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_pike"),
          (eq, ":var3", "itm_modded_pike"),
          (assign, "$spear_dist", 300),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_war_spear"),
          (eq, ":var3", "itm_modded_war_spear"),
          (assign, "$spear_dist", 211),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_glaive"),
        (is_between, ":var3", "itm_glaive"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_glaive"),
          (eq, ":var3", "itm_glaive"),
          (assign, "$spear_dist", 160),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_bill"),
        (is_between, ":var3", "itm_bill"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_bill"),
          (eq, ":var3", "itm_bill"),
          (assign, "$spear_dist", 128),
        (try_end),
      (try_end),
      (eq, ":var0", 1),
      (agent_get_horse, ":var4", ":var1"),
      (le, ":var4", 0),
      (neq, "$spear_in_position", 1),
      (display_message, "@Bracing polearm for charge.", 0x6495ED),
      (agent_set_animation, ":var1", "anim_spearwall_hold"),
      (assign, "$spear_in_position", 1),
      (store_agent_hit_points, "$spear_hp", ":var1", 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("arena_tournament_fight_1vs1", mtf_arena_fight, -1,
  "You enter a melee fight in the arena.",
  [
    (0, mtef_team_0|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_sword_type_xiiia]),
    (1, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (2, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (3, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (4, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (5, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (6, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (7, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (8, mtef_team_1|mtef_visitor_source, af_override_weapons|af_override_horse, aif_start_alarmed, 1, [itm_sword_type_xiiia]),
    (9, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (10, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (11, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (12, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (13, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (14, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (15, mtef_team_1|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (16, mtef_team_2|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (17, mtef_team_2|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (18, mtef_team_2|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (19, mtef_team_2|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (20, mtef_team_2|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (21, mtef_team_2|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (22, mtef_team_2|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (23, mtef_team_2|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (24, mtef_team_3|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (25, mtef_team_3|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (26, mtef_team_3|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (27, mtef_team_3|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (28, mtef_team_3|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (29, mtef_team_3|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (30, mtef_team_3|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (31, mtef_team_3|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (agent_get_troop_id, ":var1", ":var0"),
      (call_script, "script_troop_agent_set_banner", "tableau_game_troop_label_banner", ":var0", ":var1"),
    ]),

    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (assign, "$g_arena_training_num_agents_spawned", 0),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (display_message, "str_cant_use_inventory_arena"),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [],
    [
      (try_begin),
        (eq, "$g_mt_mode", 2),
        (set_trigger_result, 1),
      (else_try),
        (question_box, "str_give_up_fight"),
      (try_end),
    ]),

    (ti_question_answered, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (eq, ":var0", 0),
      (try_begin),
        (eq, "$g_mt_mode", 3),
        (call_script, "script_end_tournament_fight_new", 0),
      (else_try),
        (eq, "$g_mt_mode", 1),
        (get_player_agent_no, ":var1"),
        (agent_get_kill_count, "$g_arena_training_kills", ":var1", 1),
      (try_end),
      (finish_mission, 0),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (eq, "$g_mt_mode", 2),
      (call_script, "script_music_set_situation_with_culture", 65536),
      (store_current_scene, reg1),
      (scene_set_slot, reg1, 0, 1),
      (mission_enable_talk),
      (get_player_agent_no, ":var0"),
      (assign, ":var1", 0),
      (try_for_agents, ":var2"),
        (neq, ":var2", ":var0"),
        (agent_get_troop_id, ":var3", ":var2"),
        (is_between, ":var3", "trp_novice_fighter", "trp_tournament_master"),
        (eq, ":var1", 0),
        (agent_set_team, ":var2", 1),
        (assign, ":var1", 1),
      (try_end),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (eq, "$g_mt_mode", 3),
      (play_sound, "snd_arena_ambiance", 2),
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (1, 4, ti_once, 
    [
      (eq, "$g_mt_mode", 3),
      (num_active_teams_le, 1),
    ],
    [
      (try_begin),
        (get_player_agent_no, ":var0"),
        (agent_get_team, ":var1", ":var0"),
        (assign, ":var2", 0),
        (try_for_agents, ":var3"),
          (agent_is_alive, ":var3"),
          (agent_is_human, ":var3"),
          (agent_get_team, ":var4", ":var3"),
          (eq, ":var4", ":var1"),
          (assign, ":var2", 1),
        (try_end),
        (eq, ":var2", 1),
        (stop_all_sounds, 0),
        (call_script, "script_end_tournament_fight_new", 1),
        (call_script, "script_play_victorious_sound"),
        (finish_mission),
      (else_try),
        (stop_all_sounds, 0),
        (call_script, "script_end_tournament_fight_new", 0),
        (finish_mission),
      (try_end),
    ]),

    (ti_battle_window_opened, 0, 0, 
    [],
    [
      (eq, "$g_mt_mode", 1),
      (start_presentation, "prsnt_arena_training"),
    ]),

    (0, 0, ti_once, 
    [],
    [
      (eq, "$g_mt_mode", 1),
      (assign, "$g_arena_training_max_opponents", 50),
      (assign, "$g_arena_training_num_agents_spawned", 0),
      (assign, "$g_arena_training_kills", 0),
      (assign, "$g_arena_training_won", 0),
      (call_script, "script_music_set_situation_with_culture", 131072),
    ]),

    (1, 4, ti_once, 
    [
      (eq, "$g_mt_mode", 1),
      (store_mission_timer_a, ":var0"),
      (gt, ":var0", 3),
      (assign, ":var1", 0),
      (try_begin),
        (ge, "$g_arena_training_num_agents_spawned", "$g_arena_training_max_opponents"),
        (num_active_teams_le, 1),
        (assign, ":var1", 1),
      (try_end),
      (this_or_next|eq, ":var1", 1),
      (main_hero_fallen),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_kill_count, "$g_arena_training_kills", ":var0", 1),
      (assign, "$g_arena_training_won", 0),
      (try_begin),
        (neg|main_hero_fallen),
        (assign, "$g_arena_training_won", 1),
      (try_end),
      (assign, "$g_mt_mode", 2),
      (set_jump_mission, "mt_arena_melee_fight"),
      (party_get_slot, ":var1", "$current_town", 16),
      (modify_visitors_at_site, ":var1"),
      (reset_visitors),
      (party_get_slot, ":var2", "$current_town", 277),
      (set_visitor, 52, ":var2"),
      (set_jump_entry, 50),
      (jump_to_scene, ":var1"),
    ]),

    (1, 0, 0, 
    [
      (eq, "$g_mt_mode", 1),
      (assign, ":var0", 0),
      (try_for_agents, ":var1"),
        (agent_is_human, ":var1"),
        (agent_is_alive, ":var1"),
        (agent_get_team, ":var2", ":var1"),
        (is_between, ":var2", 0, 7),
        (val_add, ":var0", 1),
      (try_end),
      (lt, ":var0", 20),
      (neg|main_hero_fallen),
      (store_mission_timer_a, ":var3"),
      (this_or_next|ge, ":var3", "$g_arena_training_next_spawn_time"),
      (this_or_next|lt, "$g_arena_training_num_agents_spawned", 50),
      (num_active_teams_le, 1),
      (lt, "$g_arena_training_num_agents_spawned", "$g_arena_training_max_opponents"),
    ],
    [
      (assign, ":var0", "$g_arena_training_num_agents_spawned"),
      (store_div, ":var0", "$g_arena_training_num_agents_spawned", 6),
      (assign, ":var1", "$g_arena_training_num_agents_spawned"),
      (val_mod, ":var1", 1),
      (val_add, ":var0", ":var1"),
      (val_min, ":var0", 9),
      (val_add, ":var0", "trp_arena_training_fighter_1"),
      (assign, ":var2", 10000),
      (get_player_agent_no, ":var3"),
      (agent_get_position, pos5, ":var3"),
      (try_for_range, ":var4", 0, ":var2"),
        (store_random_in_range, ":var5", 0, 39),
        (neq, ":var5", "$g_player_entry_point"),
        (entry_point_get_position, pos1, ":var5"),
        (get_distance_between_positions, ":var6", pos5, pos1),
        (gt, ":var6", 1200),
        (assign, ":var2", 0),
      (try_end),
      (add_visitors_to_current_scene, ":var5", ":var0", 1),
      (store_add, ":var7", "$g_arena_training_num_agents_spawned", 1),
      (store_mission_timer_a, ":var8"),
      (store_add, "$g_arena_training_next_spawn_time", ":var8", 2),
      (store_div, ":var9", ":var7", 4),
      (val_sub, "$g_arena_training_next_spawn_time", ":var9"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$g_mt_mode", 1),
    ],
    [
      (assign, ":var0", 6),
      (val_max, ":var0", 1),
      (get_player_agent_no, ":var1"),
      (try_for_agents, ":var2"),
        (agent_is_human, ":var2"),
        (agent_is_alive, ":var2"),
        (agent_slot_eq, ":var2", 7, 0),
        (agent_get_team, ":var3", ":var2"),
        (is_between, ":var3", 0, 7),
        (try_begin),
          (eq, ":var2", ":var1"),
          (agent_set_team, ":var2", 6),
        (else_try),
          (try_for_range, ":var4", 0, 6),
            (troop_set_slot, "trp_temp_array_a", ":var4", 0),
          (try_end),
          (try_for_agents, ":var5"),
            (agent_is_human, ":var5"),
            (agent_is_alive, ":var5"),
            (neq, ":var2", ":var1"),
            (agent_slot_eq, ":var5", 7, 1),
            (agent_get_team, ":var6", ":var5"),
            (troop_get_slot, ":var7", "trp_temp_array_a", ":var6"),
            (val_add, ":var7", 1),
            (troop_set_slot, "trp_temp_array_a", ":var6", ":var7"),
          (try_end),
          (troop_get_slot, ":var8", "trp_temp_array_a", 0),
          (try_for_range, ":var4", 1, 6),
            (troop_slot_ge, "trp_temp_array_a", ":var4", ":var8"),
            (troop_get_slot, ":var8", "trp_temp_array_a", ":var4"),
          (try_end),
        (try_end),
        (agent_set_slot, ":var2", 7, 1),
        (try_begin),
          (neq, ":var2", ":var1"),
          (val_add, "$g_arena_training_num_agents_spawned", 1),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_hit, 0.3, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (store_trigger_param_2, ":var1"),
      (store_trigger_param_3, ":var2"),
      (assign, ":var3", reg0),
      (agent_is_human, ":var0"),
      (get_player_agent_no, ":var4"),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var0", ":var4"),
        (store_random_in_range, ":var5", 0, 1000),
        (eq, ":var5", 1),
        (store_random_in_range, ":var6", 4, 8),
        (troop_get_inventory_slot, ":var7", "trp_player", ":var6"),
        (gt, ":var7", 0),
        (str_store_item_name, s20, ":var7"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var6"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} is too crapy to fall apart!", 0xFF0000),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var7", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var6", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (eq, ":var1", ":var4"),
        (is_between, ":var3", 1, "itm_items_end"),
        (neg|is_between, ":var3", "itm_light_lance", "itm_wooden_shield"),
        (item_get_type, ":var9", ":var3"),
        (ge, ":var2", 10),
        (neq, ":var9", 10),
        (neq, ":var9", 8),
        (neq, ":var9", 9),
        (neq, ":var9", 5),
        (neq, ":var9", 6),
        (store_random_in_range, ":var5", 0, 600),
        (eq, ":var5", 1),
        (assign, ":var10", -1),
        (try_for_range, ":var6", 0, 4),
          (troop_get_inventory_slot, ":var11", "trp_player", ":var6"),
          (eq, ":var11", ":var3"),
          (assign, ":var10", ":var6"),
        (try_end),
        (gt, ":var10", 0),
        (str_store_item_name, s20, ":var3"),
        (troop_get_inventory_slot_modifier, ":var8", "trp_player", ":var10"),
        (try_begin),
          (eq, ":var8", 6),
          (display_message, "@Your {s20} falls apart!", 0xFF0000),
          (agent_unequip_item, ":var4", ":var3"),
          (troop_remove_item, "trp_player", ":var3"),
          (troop_remove_item, "trp_broken_items", ":var3"),
        (else_try),
          (troop_add_item, "trp_broken_items", ":var3", ":var8"),
          (troop_set_inventory_slot_modifier, "trp_player", ":var10", 6),
          (display_message, "@Your {s20} cracks!", 0xFF0000),
        (try_end),
      (try_end),
      (agent_get_horse, ":var12", ":var1"),
      (try_begin),
        (eq, "$tom_lance_breaking", 1),
        (gt, ":var12", 0),
        (this_or_next|is_between, ":var3", "itm_light_lance", "itm_bamboo_spear"),
        (is_between, ":var3", "itm_crusader_knight_spear_a", "itm_crusader_spear_a"),
        (ge, ":var2", 50),
        (store_random_in_range, ":var13", 0, 100),
        (gt, ":var13", 20),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your lance!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
      (try_begin),
        (eq, "$tom_weapon_break", 1),
        (this_or_next|is_between, ":var3", "itm_bamboo_spear", "itm_staff"),
        (is_between, ":var3", "itm_crusader_spear_a", "itm_mace_6"),
        (le, ":var12", 0),
        (ge, ":var2", 8),
        (store_random_in_range, ":var13", 0, 100),
        (ge, ":var13", 90),
        (try_begin),
          (eq, ":var1", ":var4"),
          (display_message, "@You broke your spear!", 0xFF0000),
        (try_end),
        (agent_play_sound, ":var0", "snd_shield_broken"),
        (agent_unequip_item, ":var1", ":var3"),
      (try_end),
    ]),

    (0.2, 0, ti_once, 
    [],
    [
      (assign, "$spear_in_position", 0),
      (try_for_agents, ":var0"),
        (agent_set_slot, ":var0", 26, 0),
        (agent_set_slot, ":var0", 27, 0),
        (agent_set_slot, ":var0", 28, 0),
        (agent_set_slot, ":var0", 29, 0),
        (agent_set_slot, ":var0", 30, 0),
      (try_end),
    ]),

    (0.5, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (set_fixed_point_multiplier, 100),
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 27),
        (agent_get_slot, ":var2", ":var0", 28),
        (agent_get_slot, ":var3", ":var0", 29),
        (agent_get_position, pos1, ":var0"),
        (position_get_x, ":var4", pos1),
        (position_get_y, ":var5", pos1),
        (position_get_z, ":var6", pos1),
        (position_set_x, pos2, ":var1"),
        (position_set_y, pos2, ":var2"),
        (position_set_z, pos2, ":var3"),
        (position_set_x, pos1, ":var4"),
        (position_set_y, pos1, ":var5"),
        (position_set_z, pos1, ":var6"),
        (agent_get_speed, pos5, ":var0"),
        (call_script, "script_vector_length", 5),
        (assign, ":var7", reg0),
        (agent_set_slot, ":var0", 27, ":var4"),
        (agent_set_slot, ":var0", 28, ":var5"),
        (agent_set_slot, ":var0", 29, ":var6"),
        (agent_set_slot, ":var0", 30, ":var7"),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
      (this_or_next|game_key_clicked, gk_attack),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_defend),
      (this_or_next|game_key_clicked, gk_move_forward),
      (this_or_next|game_key_clicked, gk_move_backward),
      (this_or_next|game_key_clicked, gk_move_left),
      (this_or_next|game_key_clicked, gk_move_right),
      (this_or_next|game_key_clicked, gk_equip_primary_weapon),
      (this_or_next|game_key_clicked, gk_equip_secondary_weapon),
      (this_or_next|game_key_clicked, gk_action),
      (game_key_clicked, gk_sheath_weapon),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (display_message, "@Releasing spear.", 0x6495ED),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
    ]),

    (0.2, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (try_for_agents, ":var0"),
        (agent_get_horse, ":var1", ":var0"),
        (le, ":var1", 0),
        (agent_get_slot, ":var2", ":var0", 26),
        (lt, ":var2", 10),
        (val_add, ":var2", 2),
        (agent_set_slot, ":var0", 26, ":var2"),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_set_animation, ":var0", "anim_spearwall_hold"),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_get_team, ":var1", ":var0"),
      (try_for_agents, ":var2"),
        (agent_is_alive, ":var2"),
        (neq, ":var2", ":var0"),
        (agent_is_human, ":var2"),
        (agent_get_horse, ":var3", ":var2"),
        (le, ":var3", 0),
        (agent_get_slot, ":var4", ":var2", 26),
        (ge, ":var4", 10),
        (agent_get_simple_behavior, ":var5", ":var2"),
        (agent_get_team, ":var6", ":var2"),
        (agent_get_class, ":var7", ":var2"),
        (team_get_movement_order, ":var8", ":var6", ":var7"),
        (assign, ":var9", 0),
        (try_begin),
          (neq, ":var6", ":var1"),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (else_try),
          (this_or_next|eq, ":var8", 0),
          (eq, ":var8", 11),
          (this_or_next|eq, ":var5", 0),
          (this_or_next|eq, ":var5", 9),
          (this_or_next|eq, ":var5", 4),
          (eq, ":var5", 1),
          (assign, ":var9", 1),
        (try_end),
        (eq, ":var9", 1),
        (agent_get_troop_id, ":var10", ":var2"),
        (store_proficiency_level, ":var11", ":var10", ca_intelligence),
        (store_character_level, ":var12", ":var10"),
        (ge, ":var12", 12),
        (ge, ":var11", 120),
        (neg|troop_is_mounted, ":var10"),
        (agent_slot_eq, ":var2", 15, 0),
        (assign, ":var9", 0),
        (agent_get_wielded_item, ":var13", ":var2", 0),
        (agent_get_wielded_item, ":var14", ":var2", 1),
        (assign, ":var15", 145),
        (try_begin),
          (this_or_next|is_between, ":var13", "itm_modded_billhook_fork_1", "itm_maul"),
          (is_between, ":var14", "itm_modded_billhook_fork_1", "itm_maul"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_1"),
            (eq, ":var14", "itm_modded_billhook_fork_1"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_fork_2"),
            (eq, ":var14", "itm_modded_billhook_fork_2"),
            (assign, "$spear_dist", 198),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_1"),
            (eq, ":var14", "itm_modded_fauchard_1"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_2"),
            (eq, ":var14", "itm_modded_fauchard_2"),
            (assign, "$spear_dist", 171),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_3"),
            (eq, ":var14", "itm_modded_fauchard_3"),
            (assign, "$spear_dist", 197),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_fauchard_4"),
            (eq, ":var14", "itm_modded_fauchard_4"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_1"),
            (eq, ":var14", "itm_modded_glaive_1"),
            (assign, "$spear_dist", 169),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_1"),
            (eq, ":var14", "itm_modded_glaive_fork_1"),
            (assign, "$spear_dist", 230),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_fork_2"),
            (eq, ":var14", "itm_modded_glaive_fork_2"),
            (assign, "$spear_dist", 188),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_glaive_roundel"),
            (eq, ":var14", "itm_modded_glaive_roundel"),
            (assign, "$spear_dist", 149),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_1"),
            (eq, ":var14", "itm_modded_bill_1"),
            (assign, "$spear_dist", 215),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_bill_2"),
            (eq, ":var14", "itm_modded_bill_2"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_1"),
            (eq, ":var14", "itm_modded_billhook_1"),
            (assign, "$spear_dist", 207),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_2"),
            (eq, ":var14", "itm_modded_billhook_2"),
            (assign, "$spear_dist", 172),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_billhook_3"),
            (eq, ":var14", "itm_modded_billhook_3"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_voulge"),
            (eq, ":var14", "itm_modded_voulge"),
            (assign, "$spear_dist", 200),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_spiked_voulge"),
            (eq, ":var14", "itm_modded_spiked_voulge"),
            (assign, "$spear_dist", 182),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_cleaving_voulge"),
            (eq, ":var14", "itm_modded_cleaving_voulge"),
            (assign, "$spear_dist", 152),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_1"),
            (eq, ":var14", "itm_modded_hooked_voulge_1"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_2"),
            (eq, ":var14", "itm_modded_hooked_voulge_2"),
            (assign, "$spear_dist", 186),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_hooked_voulge_3"),
            (eq, ":var14", "itm_modded_hooked_voulge_3"),
            (assign, "$spear_dist", 192),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_1"),
            (eq, ":var14", "itm_modded_couteau_1"),
            (assign, "$spear_dist", 177),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_couteau_2"),
            (eq, ":var14", "itm_modded_couteau_2"),
            (assign, "$spear_dist", 196),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_guisarme"),
            (eq, ":var14", "itm_modded_guisarme"),
            (assign, "$spear_dist", 232),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_assegai"),
            (eq, ":var14", "itm_modded_assegai"),
            (assign, "$spear_dist", 231),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_pike"),
            (eq, ":var14", "itm_modded_pike"),
            (assign, "$spear_dist", 300),
          (else_try),
            (this_or_next|eq, ":var13", "itm_modded_war_spear"),
            (eq, ":var14", "itm_modded_war_spear"),
            (assign, "$spear_dist", 211),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_glaive"),
          (is_between, ":var14", "itm_glaive"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_glaive"),
            (eq, ":var14", "itm_glaive"),
            (assign, "$spear_dist", 160),
          (try_end),
        (else_try),
          (this_or_next|eq, ":var13", "itm_bill"),
          (is_between, ":var14", "itm_bill"),
          (assign, ":var9", 1),
          (try_begin),
            (this_or_next|eq, ":var13", "itm_bill"),
            (eq, ":var14", "itm_bill"),
            (assign, "$spear_dist", 128),
          (try_end),
        (try_end),
        (eq, ":var9", 1),
        (assign, ":var16", -1),
        (agent_get_position, pos1, ":var2"),
        (try_for_agents, ":var17"),
          (agent_is_alive, ":var17"),
          (neg|agent_is_human, ":var17"),
          (agent_get_rider, ":var18", ":var17"),
          (ge, ":var18", 0),
          (agent_get_team, ":var19", ":var18"),
          (teams_are_enemies, ":var6", ":var19"),
          (agent_get_position, pos2, ":var17"),
          (get_distance_between_positions, ":var20", pos1, pos2),
          (lt, ":var20", ":var15"),
          (neg|position_is_behind_position, pos2, pos1),
          (agent_get_slot, ":var21", ":var17", 30),
          (gt, ":var21", 0),
          (assign, ":var16", ":var17"),
        (try_end),
        (gt, ":var16", -1),
        (agent_play_sound, ":var16", "snd_metal_hit_high_armor_high_damage"),
        (store_agent_hit_points, ":var22", ":var16", 0),
        (store_agent_hit_points, ":var23", ":var16", 1),
        (assign, reg22, ":var21"),
        (val_mul, ":var21", 10),
        (val_sub, ":var22", ":var21"),
        (val_max, ":var22", 0),
        (agent_set_slot, ":var2", 26, 0),
        (agent_get_horse, ":var24", ":var0"),
        (agent_get_position, pos2, ":var16"),
        (agent_set_look_target_position, ":var2", pos2),
        (agent_set_attack_action, ":var2", 0, 0),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_deliver_damage_to_agent, ":var2", ":var16"),
        (agent_get_troop_id, ":var10", ":var2"),
        (str_store_troop_name, s21, ":var10"),
        (agent_get_troop_id, ":var25", ":var16"),
        (str_store_troop_name, s20, ":var25"),
        (store_agent_hit_points, ":var22", ":var16", 1),
        (val_sub, ":var23", ":var22"),
        (assign, reg1, ":var23"),
        (try_begin),
          (eq, ":var16", ":var24"),
          (display_message, "@Your horse received {reg1} damage from a braced polearm!", 0xFF4040),
        (try_end),
      (try_end),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (store_agent_hit_points, ":var1", ":var0", 1),
      (lt, ":var1", "$spear_hp"),
      (display_message, "@The injury causes your grip on the polearm to slip!", 0xFF4040),
      (agent_set_animation, ":var0", "anim_release_thrust_staff"),
      (assign, "$spear_in_position", 0),
      (set_fixed_point_multiplier, 100),
    ]),

    (0.1, 0, 0, 
    [
      (eq, "$spear_in_position", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 26),
      (ge, ":var1", 10),
      (assign, ":var2", -1),
      (agent_get_position, pos1, ":var0"),
      (try_for_agents, ":var3"),
        (agent_is_alive, ":var3"),
        (neg|agent_is_human, ":var3"),
        (agent_get_rider, ":var4", ":var3"),
        (ge, ":var4", 0),
        (neg|agent_is_ally, ":var4"),
        (agent_get_position, pos2, ":var3"),
        (get_distance_between_positions, ":var5", pos1, pos2),
        (lt, ":var5", "$spear_dist"),
        (neg|position_is_behind_position, pos2, pos1),
        (agent_get_slot, ":var6", ":var3", 30),
        (ge, ":var6", 120),
        (assign, ":var2", ":var3"),
      (try_end),
      (gt, ":var2", -1),
      (agent_play_sound, ":var2", "snd_metal_hit_high_armor_high_damage"),
      (store_agent_hit_points, ":var7", ":var2", 0),
      (store_agent_hit_points, ":var8", ":var2", 1),
      (val_div, ":var6", 2),
      (val_sub, ":var6", 15),
      (val_sub, ":var7", ":var6"),
      (val_max, ":var7", 0),
      (agent_set_hit_points, ":var2", ":var7", 0),
      (agent_deliver_damage_to_agent, ":var2", ":var2"),
      (agent_set_slot, ":var0", 26, 0),
      (store_agent_hit_points, ":var7", ":var2", 1),
      (val_sub, ":var8", ":var7"),
      (assign, reg1, ":var8"),
      (display_message, "@Polearm-wall dealt {reg1} damage!"),
      (set_fixed_point_multiplier, 100),
    ]),

    (0, 0, 2, 
    [
      (key_clicked, key_b),
      (eq, "$setting_use_spearwall", 1),
    ],
    [
      (assign, ":var0", 0),
      (get_player_agent_no, ":var1"),
      (agent_is_alive, ":var1"),
      (agent_get_wielded_item, ":var2", ":var1", 0),
      (agent_get_wielded_item, ":var3", ":var1", 1),
      (assign, "$spear_dist", 145),
      (try_begin),
        (this_or_next|is_between, ":var2", "itm_modded_billhook_fork_1", "itm_maul"),
        (is_between, ":var3", "itm_modded_billhook_fork_1", "itm_maul"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_1"),
          (eq, ":var3", "itm_modded_billhook_fork_1"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_fork_2"),
          (eq, ":var3", "itm_modded_billhook_fork_2"),
          (assign, "$spear_dist", 198),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_1"),
          (eq, ":var3", "itm_modded_fauchard_1"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_2"),
          (eq, ":var3", "itm_modded_fauchard_2"),
          (assign, "$spear_dist", 171),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_3"),
          (eq, ":var3", "itm_modded_fauchard_3"),
          (assign, "$spear_dist", 197),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_fauchard_4"),
          (eq, ":var3", "itm_modded_fauchard_4"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_1"),
          (eq, ":var3", "itm_modded_glaive_1"),
          (assign, "$spear_dist", 169),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_1"),
          (eq, ":var3", "itm_modded_glaive_fork_1"),
          (assign, "$spear_dist", 230),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_fork_2"),
          (eq, ":var3", "itm_modded_glaive_fork_2"),
          (assign, "$spear_dist", 188),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_glaive_roundel"),
          (eq, ":var3", "itm_modded_glaive_roundel"),
          (assign, "$spear_dist", 149),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_1"),
          (eq, ":var3", "itm_modded_bill_1"),
          (assign, "$spear_dist", 215),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_bill_2"),
          (eq, ":var3", "itm_modded_bill_2"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_1"),
          (eq, ":var3", "itm_modded_billhook_1"),
          (assign, "$spear_dist", 207),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_2"),
          (eq, ":var3", "itm_modded_billhook_2"),
          (assign, "$spear_dist", 172),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_billhook_3"),
          (eq, ":var3", "itm_modded_billhook_3"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_voulge"),
          (eq, ":var3", "itm_modded_voulge"),
          (assign, "$spear_dist", 200),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_spiked_voulge"),
          (eq, ":var3", "itm_modded_spiked_voulge"),
          (assign, "$spear_dist", 182),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_cleaving_voulge"),
          (eq, ":var3", "itm_modded_cleaving_voulge"),
          (assign, "$spear_dist", 152),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_1"),
          (eq, ":var3", "itm_modded_hooked_voulge_1"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_2"),
          (eq, ":var3", "itm_modded_hooked_voulge_2"),
          (assign, "$spear_dist", 186),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_hooked_voulge_3"),
          (eq, ":var3", "itm_modded_hooked_voulge_3"),
          (assign, "$spear_dist", 192),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_1"),
          (eq, ":var3", "itm_modded_couteau_1"),
          (assign, "$spear_dist", 177),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_couteau_2"),
          (eq, ":var3", "itm_modded_couteau_2"),
          (assign, "$spear_dist", 196),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_guisarme"),
          (eq, ":var3", "itm_modded_guisarme"),
          (assign, "$spear_dist", 232),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_assegai"),
          (eq, ":var3", "itm_modded_assegai"),
          (assign, "$spear_dist", 231),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_pike"),
          (eq, ":var3", "itm_modded_pike"),
          (assign, "$spear_dist", 300),
        (else_try),
          (this_or_next|eq, ":var2", "itm_modded_war_spear"),
          (eq, ":var3", "itm_modded_war_spear"),
          (assign, "$spear_dist", 211),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_glaive"),
        (is_between, ":var3", "itm_glaive"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_glaive"),
          (eq, ":var3", "itm_glaive"),
          (assign, "$spear_dist", 160),
        (try_end),
      (else_try),
        (this_or_next|eq, ":var2", "itm_bill"),
        (is_between, ":var3", "itm_bill"),
        (assign, ":var0", 1),
        (try_begin),
          (this_or_next|eq, ":var2", "itm_bill"),
          (eq, ":var3", "itm_bill"),
          (assign, "$spear_dist", 128),
        (try_end),
      (try_end),
      (eq, ":var0", 1),
      (agent_get_horse, ":var4", ":var1"),
      (le, ":var4", 0),
      (neq, "$spear_in_position", 1),
      (display_message, "@Bracing polearm for charge.", 0x6495ED),
      (agent_set_animation, ":var1", "anim_spearwall_hold"),
      (assign, "$spear_in_position", 1),
      (store_agent_hit_points, "$spear_hp", ":var1", 1),
      (set_fixed_point_multiplier, 100),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (call_script, "script_lance_use_classify_agent"),
    ]),

    (2, 0, 0, 
    [],
    [
      (try_for_agents, ":var0"),
        (agent_is_alive, ":var0"),
        (agent_get_slot, ":var1", ":var0", 43),
        (gt, ":var1", 0),
        (agent_get_wielded_item, ":var2", ":var0", 0),
        (agent_get_horse, ":var3", ":var0"),
        (try_begin),
          (le, ":var3", 0),
          (agent_set_slot, ":var0", 43, 0),
          (eq, ":var2", ":var1"),
          (call_script, "script_lance_use_backup_weapon", ":var0"),
        (else_try),
          (agent_get_position, pos1, ":var0"),
          (agent_get_team, ":var4", ":var0"),
          (call_script, "script_get_closest3_distance_of_enemies_at_pos1", ":var4", 1),
          (assign, ":var5", reg0),
          (try_begin),
            (lt, ":var5", 500),
            (agent_get_combat_state, ":var6", ":var0"),
            (gt, ":var6", 3),
            (eq, ":var2", ":var1"),
            (call_script, "script_lance_use_backup_weapon", ":var0"),
          (else_try),
            (neq, ":var2", ":var1"),
            (agent_set_wielded_item, ":var0", ":var1"),
          (try_end),
        (try_end),
      (try_end),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_set_matching_sexy_boots", ":var0"),
    ]),

    (0, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
      (game_key_is_down, gk_defend),
      (game_key_clicked, gk_attack),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (neg|agent_slot_ge, ":var0", 50, 1),
      (agent_get_wielded_item, ":var1", ":var0", 1),
      (is_between, ":var1", 1, "itm_items_end"),
      (item_get_type, ":var2", ":var1"),
      (eq, ":var2", 7),
      (agent_get_defend_action, ":var3", ":var0"),
      (eq, ":var3", 2),
      (agent_get_horse, ":var4", ":var0"),
      (eq, ":var4", -1),
      (agent_set_slot, ":var0", 50, 3),
      (agent_set_animation, ":var0", "anim_shield_bash"),
      (agent_get_troop_id, ":var5", ":var0"),
      (troop_get_type, ":var2", ":var5"),
      (try_begin),
        (eq, ":var2", 0),
        (agent_play_sound, ":var0", "snd_man_yell"),
      (else_try),
        (eq, ":var2", 1),
        (agent_play_sound, ":var0", "snd_woman_yell"),
      (try_end),
      (agent_get_position, pos1, ":var0"),
      (assign, ":var6", -1),
      (assign, ":var7", 150),
      (try_for_agents, ":var8"),
        (agent_is_alive, ":var8"),
        (agent_is_human, ":var8"),
        (neg|agent_is_ally, ":var8"),
        (agent_get_position, pos2, ":var8"),
        (neg|position_is_behind_position, pos2, pos1),
        (get_distance_between_positions, ":var9", pos1, pos2),
        (le, ":var9", ":var7"),
        (assign, ":var7", ":var9"),
        (assign, ":var6", ":var8"),
      (try_end),
      (ge, ":var6", 0),
      (agent_play_sound, ":var6", "snd_wooden_hit_low_armor_high_damage"),
      (agent_get_defend_action, ":var3", ":var6"),
      (try_begin),
        (eq, ":var3", 2),
        (neg|position_is_behind_position, pos1, pos2),
        (agent_get_wielded_item, ":var1", ":var6", 1),
        (is_between, ":var1", 1, "itm_items_end"),
        (item_get_type, ":var2", ":var1"),
        (eq, ":var2", 7),
        (agent_set_animation, ":var6", "anim_shield_bash"),
      (else_try),
        (agent_set_animation, ":var6", "anim_shield_strike"),
      (try_end),
    ]),

    (1, 0, 0, 
    [
      (eq, "$sp_shield_bash", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (agent_is_active, ":var0"),
      (agent_is_alive, ":var0"),
      (agent_get_slot, ":var1", ":var0", 50),
      (val_sub, ":var1", 1),
      (val_max, ":var1", 0),
      (agent_set_slot, ":var0", 50, ":var1"),
    ]),

    (0.4, 0, 0, 
    [
      (eq, "$sp_shield_bash_ai", 1),
    ],
    [
      (get_player_agent_no, ":var0"),
      (try_for_agents, ":var1"),
        (neq, ":var1", ":var0"),
        (agent_is_alive, ":var1"),
        (agent_is_human, ":var1"),
        (agent_get_troop_id, ":var2", ":var1"),
        (store_skill_level, ":var3", "skl_shield", ":var2"),
        (store_proficiency_level, ":var4", ":var2", ca_strength),
        (ge, ":var3", 4),
        (ge, ":var4", 200),
        (agent_get_horse, ":var5", ":var1"),
        (le, ":var5", 0),
        (try_begin),
          (neg|agent_slot_ge, ":var1", 50, 1),
          (agent_slot_eq, ":var1", 15, 0),
          (agent_get_wielded_item, ":var6", ":var1", 1),
          (is_between, ":var6", 1, "itm_items_end"),
          (item_get_type, ":var7", ":var6"),
          (eq, ":var7", 7),
          (agent_get_attack_action, ":var8", ":var1"),
          (eq, ":var8", 0),
          (agent_get_team, ":var9", ":var1"),
          (agent_get_position, pos1, ":var1"),
          (assign, ":var10", -1),
          (assign, ":var11", 125),
          (try_for_agents, ":var12"),
            (agent_is_alive, ":var12"),
            (agent_is_human, ":var12"),
            (agent_get_position, pos2, ":var12"),
            (neg|position_is_behind_position, pos2, pos1),
            (agent_get_team, ":var13", ":var12"),
            (neq, ":var13", ":var9"),
            (try_begin),
              (eq, ":var9", 0),
              (assign, ":var14", 2),
            (else_try),
              (eq, ":var9", 2),
              (assign, ":var14", 0),
            (else_try),
              (eq, ":var9", 1),
              (assign, ":var14", 3),
            (else_try),
              (eq, ":var9", 3),
              (assign, ":var14", 1),
            (try_end),
            (neq, ":var13", ":var14"),
            (get_distance_between_positions, ":var15", pos1, pos2),
            (le, ":var15", ":var11"),
            (assign, ":var11", ":var15"),
            (assign, ":var10", ":var12"),
          (try_end),
          (ge, ":var10", 0),
          (agent_get_horse, ":var5", ":var10"),
          (eq, ":var5", -1),
          (store_random_in_range, ":var16", 25, 32),
          (agent_set_slot, ":var1", 50, ":var16"),
          (agent_set_animation, ":var1", "anim_shield_bash"),
          (agent_get_troop_id, ":var2", ":var1"),
          (troop_get_type, ":var7", ":var2"),
          (try_begin),
            (eq, ":var7", 0),
            (agent_play_sound, ":var1", "snd_man_yell"),
          (else_try),
            (eq, ":var7", 1),
            (agent_play_sound, ":var1", "snd_woman_yell"),
          (try_end),
          (agent_play_sound, ":var10", "snd_wooden_hit_low_armor_high_damage"),
          (agent_get_defend_action, ":var8", ":var10"),
          (try_begin),
            (eq, ":var8", 2),
            (neg|position_is_behind_position, pos1, pos2),
            (agent_get_wielded_item, ":var6", ":var10", 1),
            (is_between, ":var6", 1, "itm_items_end"),
            (item_get_type, ":var7", ":var6"),
            (eq, ":var7", 7),
            (agent_set_animation, ":var10", "anim_shield_bash"),
          (else_try),
            (agent_set_animation, ":var10", "anim_shield_strike"),
          (try_end),
        (try_end),
        (agent_get_slot, ":var17", ":var1", 50),
        (val_sub, ":var17", 1),
        (val_max, ":var17", 0),
        (agent_set_slot, ":var1", 50, ":var17"),
      (try_end),
    ]),

  ]),

  ("fort_visit", 0, -1,
  "Fort visit",
  [
    (0, mtef_team_0|mtef_scene_source, 0, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_practice_staff,itm_throwing_daggers]),
    (1, mtef_team_0|mtef_scene_source, 0, 0, 1, []),
    (2, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_practice_staff,itm_throwing_daggers]),
    (3, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_practice_staff,itm_throwing_daggers]),
    (4, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_practice_staff,itm_throwing_daggers]),
    (5, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_practice_staff,itm_throwing_daggers]),
    (6, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_practice_staff,itm_throwing_daggers]),
    (7, mtef_team_0|mtef_scene_source, af_override_horse, 0, 1, [itm_pilgrim_hood,itm_pilgrim_disguise,itm_practice_staff,itm_throwing_daggers]),
    (8, mtef_visitor_source, af_override_horse, 0, 1, []),
    (9, mtef_visitor_source, af_override_horse, 0, 1, []),
    (10, mtef_visitor_source, af_override_horse, 0, 1, []),
    (11, mtef_visitor_source, af_override_horse, 0, 1, []),
    (12, mtef_visitor_source, af_override_horse, 0, 1, []),
    (13, mtef_visitor_source, 0, 0, 1, []),
    (14, mtef_scene_source, 0, 0, 1, []),
    (15, mtef_visitor_source, af_override_horse, 0, 1, []),
    (16, mtef_visitor_source, af_override_horse, 0, 1, []),
    (17, mtef_visitor_source, af_override_horse, 0, 1, []),
    (18, mtef_visitor_source, af_override_horse, 0, 1, []),
    (19, mtef_visitor_source, af_override_horse, 0, 1, []),
    (20, mtef_team_0|mtef_visitor_source, 0, 0, 1, []),
    (21, mtef_visitor_source, 0, 0, 1, []),
    (22, mtef_visitor_source, 0, 0, 1, []),
    (23, mtef_visitor_source, 0, 0, 1, []),
    (24, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (25, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (26, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (27, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (28, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (29, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (30, mtef_team_0|mtef_visitor_source, af_override_horse, 0, 1, []),
    (31, mtef_visitor_source, af_override_horse, 0, 1, []),
    (32, mtef_visitor_source, af_override_horse, 0, 1, []),
    (33, mtef_visitor_source, af_override_horse, 0, 1, []),
    (34, mtef_visitor_source, af_override_horse, 0, 1, []),
    (35, mtef_visitor_source, af_override_horse, 0, 1, []),
    (36, mtef_visitor_source, af_override_horse, 0, 1, []),
    (37, mtef_visitor_source, af_override_horse, 0, 1, []),
    (38, mtef_visitor_source, af_override_horse, 0, 1, []),
    (39, mtef_visitor_source, af_override_horse, 0, 1, []),
    (40, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (41, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (42, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (4139, mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (44, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (45, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (46, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (4143, mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (48, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
    (49, mtef_team_0|mtef_visitor_source, af_override_horse, aif_start_alarmed, 1, []),
  ],
  [
    (ti_before_mission_start, 0, 0, 
    [],
    [
      (call_script, "script_change_banners_and_chest"),
      (call_script, "script_remove_siege_objects"),
    ]),

    (ti_on_agent_spawn, 0, 0, 
    [],
    [
      (store_trigger_param_1, ":var0"),
      (call_script, "script_init_town_agent", ":var0"),
    ]),

    (1, 0, ti_once, 
    [],
    [
      (try_begin),
        (eq, "$g_mt_mode", 0),
        (store_current_scene, ":var0"),
        (scene_set_slot, ":var0", 0, 1),
      (try_end),
      (call_script, "script_init_town_walker_agents"),
      (call_script, "script_init_fort_patrols"),
      (entry_point_get_position, pos1, 14),
      (scene_prop_get_num_instances, ":var1", "spr_inventory"),
      (try_for_range, ":var2", 0, ":var1"),
        (scene_prop_get_instance, ":var3", "spr_inventory", ":var2"),
        (prop_instance_set_position, ":var3", pos1),
      (try_end),
      (try_begin),
        (eq, "$sneaked_into_town", 1),
        (call_script, "script_music_set_situation_with_culture", 16384),
      (else_try),
        (call_script, "script_music_set_situation_with_culture", 65536),
      (try_end),
    ]),

    (ti_inventory_key_pressed, 0, 0, 
    [
      (try_begin),
        (eq, "$g_mt_mode", 0),
        (set_trigger_result, 1),
      (else_try),
        (eq, "$g_mt_mode", 1),
        (display_message, "str_cant_use_inventory_disguised"),
      (else_try),
        (display_message, "str_cant_use_inventory_now"),
      (try_end),
    ],
    []),

    (ti_tab_pressed, 0, 0, 
    [
      (try_begin),
        (this_or_next|eq, "$g_mt_mode", 0),
        (eq, "$g_mt_mode", 1),
        (set_trigger_result, 1),
      (else_try),
        (display_message, "@Cannot leave now."),
      (try_end),
    ],
    []),

    (ti_on_leave_area, 0, 0, 
    [
      (try_begin),
        (eq, "$g_defending_against_siege", 0),
        (assign, "$g_leave_town", 1),
      (try_end),
    ],
    []),

    (0, 0, ti_once, 
    [],
    [
      (party_slot_eq, "$current_town", 0, 3),
      (call_script, "script_town_init_doors", 0),
      (try_begin),
        (eq, "$town_nighttime", 0),
        (play_sound, "snd_town_ambiance", 2),
      (try_end),
    ]),

    (3, 0, 0, 
    [
      (call_script, "script_tick_town_walkers"),
      (try_for_agents, ":var0"),
        (agent_get_troop_id, ":var1", ":var0"),
        (try_begin),
          (eq, ":var1", "trp_ee_watchman"),
          (call_script, "script_cf_tick_fort_patrol", ":var0", 1),
        (else_try),
          (agent_get_entry_no, ":var2", ":var0"),
          (this_or_next|eq, ":var1", "trp_fort_rider"),
          (eq, ":var2", 20),
          (agent_is_human, ":var0"),
          (call_script, "script_cf_tick_fort_patrol", ":var0", 3),
        (try_end),
      (try_end),
    ],
    []),

    (2, 0, 0, 
    [
      (call_script, "script_center_ambiance_sounds"),
    ],
    []),

  ]),

]